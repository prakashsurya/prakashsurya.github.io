<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - zfs-0.7.0 Code Coverage - /export/home/delphix/zfs/lib/libzfs/libzfs_sendrecv.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../../index.html">top level</a> - <a href="index.html">export/home/delphix/zfs/lib/libzfs</a> - libzfs_sendrecv.c<span style="font-size: 80%;"> (source / <a href="libzfs_sendrecv.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">zfs-0.7.0 Code Coverage</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1441</td>
            <td class="headerCovTableEntry">1879</td>
            <td class="headerCovTableEntryMed">76.7 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-09-28 14:23:58</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">46</td>
            <td class="headerCovTableEntry">48</td>
            <td class="headerCovTableEntryHi">95.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
            | Branches:
            <span class="coverLegendCov">+</span> taken
            <span class="coverLegendNoCov">-</span> not taken
            <span class="coverLegendNoCov">#</span> not executed
</td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">950</td>
            <td class="headerCovTableEntry">1460</td>
            <td class="headerCovTableEntryLo">65.1 %</td>
          </tr>
          <tr><td><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : /*</a>
<span class="lineNum">       2 </span>                :            :  * CDDL HEADER START
<span class="lineNum">       3 </span>                :            :  *
<span class="lineNum">       4 </span>                :            :  * The contents of this file are subject to the terms of the
<span class="lineNum">       5 </span>                :            :  * Common Development and Distribution License (the &quot;License&quot;).
<span class="lineNum">       6 </span>                :            :  * You may not use this file except in compliance with the License.
<span class="lineNum">       7 </span>                :            :  *
<span class="lineNum">       8 </span>                :            :  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
<span class="lineNum">       9 </span>                :            :  * or http://www.opensolaris.org/os/licensing.
<span class="lineNum">      10 </span>                :            :  * See the License for the specific language governing permissions
<span class="lineNum">      11 </span>                :            :  * and limitations under the License.
<span class="lineNum">      12 </span>                :            :  *
<span class="lineNum">      13 </span>                :            :  * When distributing Covered Code, include this CDDL HEADER in each
<span class="lineNum">      14 </span>                :            :  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.
<span class="lineNum">      15 </span>                :            :  * If applicable, add the following below this CDDL HEADER, with the
<span class="lineNum">      16 </span>                :            :  * fields enclosed by brackets &quot;[]&quot; replaced with your own identifying
<span class="lineNum">      17 </span>                :            :  * information: Portions Copyright [yyyy] [name of copyright owner]
<span class="lineNum">      18 </span>                :            :  *
<span class="lineNum">      19 </span>                :            :  * CDDL HEADER END
<span class="lineNum">      20 </span>                :            :  */
<span class="lineNum">      21 </span>                :            : 
<span class="lineNum">      22 </span>                :            : /*
<span class="lineNum">      23 </span>                :            :  * Copyright (c) 2005, 2010, Oracle and/or its affiliates. All rights reserved.
<span class="lineNum">      24 </span>                :            :  * Copyright (c) 2011, 2015 by Delphix. All rights reserved.
<span class="lineNum">      25 </span>                :            :  * Copyright (c) 2012, Joyent, Inc. All rights reserved.
<span class="lineNum">      26 </span>                :            :  * Copyright (c) 2012 Pawel Jakub Dawidek &lt;pawel@dawidek.net&gt;.
<span class="lineNum">      27 </span>                :            :  * All rights reserved
<span class="lineNum">      28 </span>                :            :  * Copyright (c) 2013 Steven Hartland. All rights reserved.
<span class="lineNum">      29 </span>                :            :  * Copyright 2015, OmniTI Computer Consulting, Inc. All rights reserved.
<span class="lineNum">      30 </span>                :            :  * Copyright 2016 Igor Kozhukhov &lt;ikozhukhov@gmail.com&gt;
<span class="lineNum">      31 </span>                :            :  * Copyright (c) 2017, loli10K &lt;ezomori.nozomu@gmail.com&gt;. All rights reserved.
<span class="lineNum">      32 </span>                :            :  */
<span class="lineNum">      33 </span>                :            : 
<span class="lineNum">      34 </span>                :            : #include &lt;assert.h&gt;
<span class="lineNum">      35 </span>                :            : #include &lt;ctype.h&gt;
<span class="lineNum">      36 </span>                :            : #include &lt;errno.h&gt;
<span class="lineNum">      37 </span>                :            : #include &lt;libintl.h&gt;
<span class="lineNum">      38 </span>                :            : #include &lt;stdio.h&gt;
<span class="lineNum">      39 </span>                :            : #include &lt;stdlib.h&gt;
<span class="lineNum">      40 </span>                :            : #include &lt;strings.h&gt;
<span class="lineNum">      41 </span>                :            : #include &lt;unistd.h&gt;
<span class="lineNum">      42 </span>                :            : #include &lt;stddef.h&gt;
<span class="lineNum">      43 </span>                :            : #include &lt;fcntl.h&gt;
<span class="lineNum">      44 </span>                :            : #include &lt;sys/mount.h&gt;
<span class="lineNum">      45 </span>                :            : #include &lt;sys/mntent.h&gt;
<span class="lineNum">      46 </span>                :            : #include &lt;sys/mnttab.h&gt;
<span class="lineNum">      47 </span>                :            : #include &lt;sys/avl.h&gt;
<span class="lineNum">      48 </span>                :            : #include &lt;sys/debug.h&gt;
<span class="lineNum">      49 </span>                :            : #include &lt;sys/stat.h&gt;
<span class="lineNum">      50 </span>                :            : #include &lt;stddef.h&gt;
<span class="lineNum">      51 </span>                :            : #include &lt;pthread.h&gt;
<span class="lineNum">      52 </span>                :            : #include &lt;umem.h&gt;
<span class="lineNum">      53 </span>                :            : #include &lt;time.h&gt;
<span class="lineNum">      54 </span>                :            : 
<span class="lineNum">      55 </span>                :            : #include &lt;libzfs.h&gt;
<span class="lineNum">      56 </span>                :            : #include &lt;libzfs_core.h&gt;
<span class="lineNum">      57 </span>                :            : 
<span class="lineNum">      58 </span>                :            : #include &quot;zfs_namecheck.h&quot;
<span class="lineNum">      59 </span>                :            : #include &quot;zfs_prop.h&quot;
<span class="lineNum">      60 </span>                :            : #include &quot;zfs_fletcher.h&quot;
<span class="lineNum">      61 </span>                :            : #include &quot;libzfs_impl.h&quot;
<span class="lineNum">      62 </span>                :            : #include &lt;zlib.h&gt;
<span class="lineNum">      63 </span>                :            : #include &lt;sys/zio_checksum.h&gt;
<span class="lineNum">      64 </span>                :            : #include &lt;sys/dsl_crypt.h&gt;
<span class="lineNum">      65 </span>                :            : #include &lt;sys/ddt.h&gt;
<span class="lineNum">      66 </span>                :            : #include &lt;sys/socket.h&gt;
<span class="lineNum">      67 </span>                :            : #include &lt;sys/sha2.h&gt;
<span class="lineNum">      68 </span>                :            : 
<span class="lineNum">      69 </span>                :            : /* in libzfs_dataset.c */
<span class="lineNum">      70 </span>                :            : extern void zfs_setprop_error(libzfs_handle_t *, zfs_prop_t, int, char *);
<span class="lineNum">      71 </span>                :            : 
<span class="lineNum">      72 </span>                :            : static int zfs_receive_impl(libzfs_handle_t *, const char *, const char *,
<span class="lineNum">      73 </span>                :            :     recvflags_t *, int, const char *, nvlist_t *, avl_tree_t *, char **, int,
<span class="lineNum">      74 </span>                :            :     uint64_t *, const char *, nvlist_t *);
<span class="lineNum">      75 </span>                :            : static int guid_to_name(libzfs_handle_t *, const char *,
<span class="lineNum">      76 </span>                :            :     uint64_t, boolean_t, char *);
<span class="lineNum">      77 </span>                :            : 
<span class="lineNum">      78 </span>                :            : static const zio_cksum_t zero_cksum = { { 0 } };
<span class="lineNum">      79 </span>                :            : 
<span class="lineNum">      80 </span>                :            : typedef struct dedup_arg {
<span class="lineNum">      81 </span>                :            :         int     inputfd;
<span class="lineNum">      82 </span>                :            :         int     outputfd;
<span class="lineNum">      83 </span>                :            :         libzfs_handle_t  *dedup_hdl;
<span class="lineNum">      84 </span>                :            : } dedup_arg_t;
<span class="lineNum">      85 </span>                :            : 
<span class="lineNum">      86 </span>                :            : typedef struct progress_arg {
<span class="lineNum">      87 </span>                :            :         zfs_handle_t *pa_zhp;
<span class="lineNum">      88 </span>                :            :         int pa_fd;
<span class="lineNum">      89 </span>                :            :         boolean_t pa_parsable;
<span class="lineNum">      90 </span>                :            : } progress_arg_t;
<span class="lineNum">      91 </span>                :            : 
<span class="lineNum">      92 </span>                :            : typedef struct dataref {
<span class="lineNum">      93 </span>                :            :         uint64_t ref_guid;
<span class="lineNum">      94 </span>                :            :         uint64_t ref_object;
<span class="lineNum">      95 </span>                :            :         uint64_t ref_offset;
<span class="lineNum">      96 </span>                :            : } dataref_t;
<span class="lineNum">      97 </span>                :            : 
<span class="lineNum">      98 </span>                :            : typedef struct dedup_entry {
<span class="lineNum">      99 </span>                :            :         struct dedup_entry      *dde_next;
<span class="lineNum">     100 </span>                :            :         zio_cksum_t dde_chksum;
<span class="lineNum">     101 </span>                :            :         uint64_t dde_prop;
<span class="lineNum">     102 </span>                :            :         dataref_t dde_ref;
<span class="lineNum">     103 </span>                :            : } dedup_entry_t;
<span class="lineNum">     104 </span>                :            : 
<span class="lineNum">     105 </span>                :            : #define MAX_DDT_PHYSMEM_PERCENT         20
<span class="lineNum">     106 </span>                :            : #define SMALLEST_POSSIBLE_MAX_DDT_MB            128
<span class="lineNum">     107 </span>                :            : 
<span class="lineNum">     108 </span>                :            : typedef struct dedup_table {
<span class="lineNum">     109 </span>                :            :         dedup_entry_t   **dedup_hash_array;
<span class="lineNum">     110 </span>                :            :         umem_cache_t    *ddecache;
<span class="lineNum">     111 </span>                :            :         uint64_t        max_ddt_size;  /* max dedup table size in bytes */
<span class="lineNum">     112 </span>                :            :         uint64_t        cur_ddt_size;  /* current dedup table size in bytes */
<span class="lineNum">     113 </span>                :            :         uint64_t        ddt_count;
<span class="lineNum">     114 </span>                :            :         int             numhashbits;
<span class="lineNum">     115 </span>                :            :         boolean_t       ddt_full;
<span class="lineNum">     116 </span>                :            : } dedup_table_t;
<a name="117"><span class="lineNum">     117 </span>                :            : </a>
<span class="lineNum">     118 </span>                :            : static int
<span class="lineNum">     119 </span>                :<span class="lineCov">          8 : high_order_bit(uint64_t n)</span>
<span class="lineNum">     120 </span>                :            : {
<span class="lineNum">     121 </span>                :            :         int count;
<span class="lineNum">     122 </span>                :            : 
<span class="lineNum">     123 </span>        [<span class="branchCov" title="Branch 0 was taken 212 times"> + </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">        220 :         for (count = 0; n != 0; count++)</span>
<span class="lineNum">     124 </span>                :<span class="lineCov">        212 :                 n &gt;&gt;= 1;</span>
<span class="lineNum">     125 </span>                :<span class="lineCov">          8 :         return (count);</span>
<span class="lineNum">     126 </span>                :            : }
<a name="127"><span class="lineNum">     127 </span>                :            : </a>
<span class="lineNum">     128 </span>                :            : static size_t
<span class="lineNum">     129 </span>                :<span class="lineCov">        934 : ssread(void *buf, size_t len, FILE *stream)</span>
<span class="lineNum">     130 </span>                :            : {
<span class="lineNum">     131 </span>                :            :         size_t outlen;
<span class="lineNum">     132 </span>                :            : 
<span class="lineNum">     133 </span>        [<span class="branchCov" title="Branch 0 was taken 930 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">        934 :         if ((outlen = fread(buf, len, 1, stream)) == 0)</span>
<span class="lineNum">     134 </span>                :            :                 return (0);
<span class="lineNum">     135 </span>                :            : 
<span class="lineNum">     136 </span>                :<span class="lineCov">        930 :         return (outlen);</span>
<span class="lineNum">     137 </span>                :            : }
<a name="138"><span class="lineNum">     138 </span>                :            : </a>
<span class="lineNum">     139 </span>                :            : static void
<span class="lineNum">     140 </span>                :<span class="lineCov">        122 : ddt_hash_append(libzfs_handle_t *hdl, dedup_table_t *ddt, dedup_entry_t **ddepp,</span>
<span class="lineNum">     141 </span>                :            :     zio_cksum_t *cs, uint64_t prop, dataref_t *dr)
<span class="lineNum">     142 </span>                :            : {
<span class="lineNum">     143 </span>                :            :         dedup_entry_t   *dde;
<span class="lineNum">     144 </span>                :            : 
<span class="lineNum">     145 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 122 times"> + </span>]:<span class="lineCov">        122 :         if (ddt-&gt;cur_ddt_size &gt;= ddt-&gt;max_ddt_size) {</span>
<span class="lineNum">     146 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (ddt-&gt;ddt_full == B_FALSE) {</span>
<span class="lineNum">     147 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">     148 </span>                :            :                             &quot;Dedup table full.  Deduplication will continue &quot;
<span class="lineNum">     149 </span>                :            :                             &quot;with existing table entries&quot;));
<span class="lineNum">     150 </span>                :<span class="lineNoCov">          0 :                         ddt-&gt;ddt_full = B_TRUE;</span>
<span class="lineNum">     151 </span>                :            :                 }
<span class="lineNum">     152 </span>                :            :                 return;
<span class="lineNum">     153 </span>                :            :         }
<span class="lineNum">     154 </span>                :            : 
<span class="lineNum">     155 </span>        [<span class="branchCov" title="Branch 1 was taken 122 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        122 :         if ((dde = umem_cache_alloc(ddt-&gt;ddecache, UMEM_DEFAULT))</span>
<span class="lineNum">     156 </span>                :            :             != NULL) {
<span class="lineNum">     157 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 122 times"> + </span>]:<span class="lineCov">        122 :                 assert(*ddepp == NULL);</span>
<span class="lineNum">     158 </span>                :<span class="lineCov">        122 :                 dde-&gt;dde_next = NULL;</span>
<span class="lineNum">     159 </span>                :<span class="lineCov">        122 :                 dde-&gt;dde_chksum = *cs;</span>
<span class="lineNum">     160 </span>                :<span class="lineCov">        122 :                 dde-&gt;dde_prop = prop;</span>
<span class="lineNum">     161 </span>                :<span class="lineCov">        122 :                 dde-&gt;dde_ref = *dr;</span>
<span class="lineNum">     162 </span>                :<span class="lineCov">        122 :                 *ddepp = dde;</span>
<span class="lineNum">     163 </span>                :<span class="lineCov">        122 :                 ddt-&gt;cur_ddt_size += sizeof (dedup_entry_t);</span>
<span class="lineNum">     164 </span>                :<span class="lineCov">        122 :                 ddt-&gt;ddt_count++;</span>
<span class="lineNum">     165 </span>                :            :         }
<span class="lineNum">     166 </span>                :            : }
<span class="lineNum">     167 </span>                :            : 
<span class="lineNum">     168 </span>                :            : /*
<span class="lineNum">     169 </span>                :            :  * Using the specified dedup table, do a lookup for an entry with
<span class="lineNum">     170 </span>                :            :  * the checksum cs.  If found, return the block's reference info
<span class="lineNum">     171 </span>                :            :  * in *dr. Otherwise, insert a new entry in the dedup table, using
<span class="lineNum">     172 </span>                :            :  * the reference information specified by *dr.
<span class="lineNum">     173 </span>                :            :  *
<span class="lineNum">     174 </span>                :            :  * return value:  true - entry was found
<span class="lineNum">     175 </span>                :            :  *                false - entry was not found
<a name="176"><span class="lineNum">     176 </span>                :            :  */</a>
<span class="lineNum">     177 </span>                :            : static boolean_t
<span class="lineNum">     178 </span>                :<span class="lineCov">        349 : ddt_update(libzfs_handle_t *hdl, dedup_table_t *ddt, zio_cksum_t *cs,</span>
<span class="lineNum">     179 </span>                :            :     uint64_t prop, dataref_t *dr)
<span class="lineNum">     180 </span>                :            : {
<span class="lineNum">     181 </span>                :            :         uint32_t hashcode;
<span class="lineNum">     182 </span>                :            :         dedup_entry_t **ddepp;
<span class="lineNum">     183 </span>                :            : 
<span class="lineNum">     184 </span>                :<span class="lineCov">        349 :         hashcode = BF64_GET(cs-&gt;zc_word[0], 0, ddt-&gt;numhashbits);</span>
<span class="lineNum">     185 </span>                :            : 
<span class="lineNum">     186 </span>        [<span class="branchCov" title="Branch 0 was taken 227 times"> + </span><span class="branchCov" title="Branch 1 was taken 122 times"> + </span>]:<span class="lineCov">        349 :         for (ddepp = &amp;(ddt-&gt;dedup_hash_array[hashcode]); *ddepp != NULL;</span>
<span class="lineNum">     187 </span>                :<span class="lineNoCov">          0 :             ddepp = &amp;((*ddepp)-&gt;dde_next)) {</span>
<span class="lineNum">     188 </span>[<span class="branchCov" title="Branch 0 was taken 227 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 227 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">        227 :                 if (ZIO_CHECKSUM_EQUAL(((*ddepp)-&gt;dde_chksum), *cs) &amp;&amp;</span>
<span class="lineNum">     189 </span>                :<span class="lineCov">        227 :                     (*ddepp)-&gt;dde_prop == prop) {</span>
<span class="lineNum">     190 </span>                :<span class="lineCov">        227 :                         *dr = (*ddepp)-&gt;dde_ref;</span>
<span class="lineNum">     191 </span>                :<span class="lineCov">        227 :                         return (B_TRUE);</span>
<span class="lineNum">     192 </span>                :            :                 }
<span class="lineNum">     193 </span>                :            :         }
<span class="lineNum">     194 </span>                :<span class="lineCov">        122 :         ddt_hash_append(hdl, ddt, ddepp, cs, prop, dr);</span>
<span class="lineNum">     195 </span>                :<span class="lineCov">        122 :         return (B_FALSE);</span>
<span class="lineNum">     196 </span>                :            : }
<a name="197"><span class="lineNum">     197 </span>                :            : </a>
<span class="lineNum">     198 </span>                :            : static int
<span class="lineNum">     199 </span>                :<span class="lineCov">        640 : dump_record(dmu_replay_record_t *drr, void *payload, int payload_len,</span>
<span class="lineNum">     200 </span>                :            :     zio_cksum_t *zc, int outfd)
<span class="lineNum">     201 </span>                :            : {
<span class="lineNum">     202 </span>                :<span class="lineCov">        640 :         ASSERT3U(offsetof(dmu_replay_record_t, drr_u.drr_checksum.drr_checksum),</span>
<span class="lineNum">     203 </span>                :            :             ==, sizeof (dmu_replay_record_t) - sizeof (zio_cksum_t));
<span class="lineNum">     204 </span>                :<span class="lineCov">        640 :         fletcher_4_incremental_native(drr,</span>
<span class="lineNum">     205 </span>                :            :             offsetof(dmu_replay_record_t, drr_u.drr_checksum.drr_checksum), zc);
<span class="lineNum">     206 </span>        [<span class="branchCov" title="Branch 0 was taken 549 times"> + </span><span class="branchCov" title="Branch 1 was taken 91 times"> + </span>]:<span class="lineCov">        640 :         if (drr-&gt;drr_type != DRR_BEGIN) {</span>
<span class="lineNum">     207 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 549 times"> + </span>]:<span class="lineCov">        549 :                 ASSERT(ZIO_CHECKSUM_IS_ZERO(&amp;drr-&gt;drr_u.</span>
<span class="lineNum">     208 </span>                :            :                     drr_checksum.drr_checksum));
<span class="lineNum">     209 </span>                :<span class="lineCov">        549 :                 drr-&gt;drr_u.drr_checksum.drr_checksum = *zc;</span>
<span class="lineNum">     210 </span>                :            :         }
<span class="lineNum">     211 </span>                :<span class="lineCov">        640 :         fletcher_4_incremental_native(&amp;drr-&gt;drr_u.drr_checksum.drr_checksum,</span>
<span class="lineNum">     212 </span>                :            :             sizeof (zio_cksum_t), zc);
<span class="lineNum">     213 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 640 times"> + </span>]:<span class="lineCov">        640 :         if (write(outfd, drr, sizeof (*drr)) == -1)</span>
<span class="lineNum">     214 </span>                :<span class="lineNoCov">          0 :                 return (errno);</span>
<span class="lineNum">     215 </span>        [<span class="branchCov" title="Branch 0 was taken 227 times"> + </span><span class="branchCov" title="Branch 1 was taken 413 times"> + </span>]:<span class="lineCov">        640 :         if (payload_len != 0) {</span>
<span class="lineNum">     216 </span>                :<span class="lineCov">        227 :                 fletcher_4_incremental_native(payload, payload_len, zc);</span>
<span class="lineNum">     217 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 227 times"> + </span>]:<span class="lineCov">        227 :                 if (write(outfd, payload, payload_len) == -1)</span>
<span class="lineNum">     218 </span>                :<span class="lineNoCov">          0 :                         return (errno);</span>
<span class="lineNum">     219 </span>                :            :         }
<span class="lineNum">     220 </span>                :            :         return (0);
<span class="lineNum">     221 </span>                :            : }
<span class="lineNum">     222 </span>                :            : 
<span class="lineNum">     223 </span>                :            : /*
<span class="lineNum">     224 </span>                :            :  * This function is started in a separate thread when the dedup option
<span class="lineNum">     225 </span>                :            :  * has been requested.  The main send thread determines the list of
<span class="lineNum">     226 </span>                :            :  * snapshots to be included in the send stream and makes the ioctl calls
<span class="lineNum">     227 </span>                :            :  * for each one.  But instead of having the ioctl send the output to the
<span class="lineNum">     228 </span>                :            :  * the output fd specified by the caller of zfs_send()), the
<span class="lineNum">     229 </span>                :            :  * ioctl is told to direct the output to a pipe, which is read by the
<span class="lineNum">     230 </span>                :            :  * alternate thread running THIS function.  This function does the
<span class="lineNum">     231 </span>                :            :  * dedup'ing by:
<span class="lineNum">     232 </span>                :            :  *  1. building a dedup table (the DDT)
<span class="lineNum">     233 </span>                :            :  *  2. doing checksums on each data block and inserting a record in the DDT
<span class="lineNum">     234 </span>                :            :  *  3. looking for matching checksums, and
<span class="lineNum">     235 </span>                :            :  *  4.  sending a DRR_WRITE_BYREF record instead of a write record whenever
<span class="lineNum">     236 </span>                :            :  *      a duplicate block is found.
<span class="lineNum">     237 </span>                :            :  * The output of this function then goes to the output fd requested
<span class="lineNum">     238 </span>                :            :  * by the caller of zfs_send().
<a name="239"><span class="lineNum">     239 </span>                :            :  */</a>
<span class="lineNum">     240 </span>                :            : static void *
<span class="lineNum">     241 </span>                :<span class="lineCov">          4 : cksummer(void *arg)</span>
<span class="lineNum">     242 </span>                :            : {
<span class="lineNum">     243 </span>                :<span class="lineCov">          4 :         dedup_arg_t *dda = arg;</span>
<span class="lineNum">     244 </span>                :<span class="lineCov">          4 :         char *buf = zfs_alloc(dda-&gt;dedup_hdl, SPA_MAXBLOCKSIZE);</span>
<span class="lineNum">     245 </span>                :<span class="lineCov">          4 :         dmu_replay_record_t thedrr = { 0 };</span>
<span class="lineNum">     246 </span>                :<span class="lineCov">          4 :         dmu_replay_record_t *drr = &amp;thedrr;</span>
<span class="lineNum">     247 </span>                :            :         FILE *ofp;
<span class="lineNum">     248 </span>                :            :         int outfd;
<span class="lineNum">     249 </span>                :            :         dedup_table_t ddt;
<span class="lineNum">     250 </span>                :            :         zio_cksum_t stream_cksum;
<span class="lineNum">     251 </span>                :            :         uint64_t numbuckets;
<span class="lineNum">     252 </span>                :            : 
<span class="lineNum">     253 </span>                :            : #ifdef _ILP32
<span class="lineNum">     254 </span>                :            :         ddt.max_ddt_size = SMALLEST_POSSIBLE_MAX_DDT_MB &lt;&lt; 20;
<span class="lineNum">     255 </span>                :            : #else
<span class="lineNum">     256 </span>                :<span class="lineCov">          4 :         uint64_t physmem = sysconf(_SC_PHYS_PAGES) * sysconf(_SC_PAGESIZE);</span>
<span class="lineNum">     257 </span>                :<span class="lineCov">          4 :         ddt.max_ddt_size =</span>
<span class="lineNum">     258 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          4 :             MAX((physmem * MAX_DDT_PHYSMEM_PERCENT) / 100,</span>
<span class="lineNum">     259 </span>                :            :             SMALLEST_POSSIBLE_MAX_DDT_MB &lt;&lt; 20);
<span class="lineNum">     260 </span>                :            : #endif
<span class="lineNum">     261 </span>                :            : 
<span class="lineNum">     262 </span>                :<span class="lineCov">          4 :         numbuckets = ddt.max_ddt_size / (sizeof (dedup_entry_t));</span>
<span class="lineNum">     263 </span>                :            : 
<span class="lineNum">     264 </span>                :            :         /*
<span class="lineNum">     265 </span>                :            :          * numbuckets must be a power of 2.  Increase number to
<span class="lineNum">     266 </span>                :            :          * a power of 2 if necessary.
<span class="lineNum">     267 </span>                :            :          */
<span class="lineNum">     268 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          4 :         if (!ISP2(numbuckets))</span>
<span class="lineNum">     269 </span>                :<span class="lineCov">          4 :                 numbuckets = 1ULL &lt;&lt; high_order_bit(numbuckets);</span>
<span class="lineNum">     270 </span>                :            : 
<span class="lineNum">     271 </span>                :<span class="lineCov">          4 :         ddt.dedup_hash_array = calloc(numbuckets, sizeof (dedup_entry_t *));</span>
<span class="lineNum">     272 </span>                :<span class="lineCov">          4 :         ddt.ddecache = umem_cache_create(&quot;dde&quot;, sizeof (dedup_entry_t), 0,</span>
<span class="lineNum">     273 </span>                :            :             NULL, NULL, NULL, NULL, NULL, 0);
<span class="lineNum">     274 </span>                :<span class="lineCov">          4 :         ddt.cur_ddt_size = numbuckets * sizeof (dedup_entry_t *);</span>
<span class="lineNum">     275 </span>                :<span class="lineCov">          4 :         ddt.numhashbits = high_order_bit(numbuckets) - 1;</span>
<span class="lineNum">     276 </span>                :<span class="lineCov">          4 :         ddt.ddt_full = B_FALSE;</span>
<span class="lineNum">     277 </span>                :            : 
<span class="lineNum">     278 </span>                :<span class="lineCov">          4 :         outfd = dda-&gt;outputfd;</span>
<span class="lineNum">     279 </span>                :<span class="lineCov">          4 :         ofp = fdopen(dda-&gt;inputfd, &quot;r&quot;);</span>
<span class="lineNum">     280 </span>        [<span class="branchCov" title="Branch 1 was taken 555 times"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">        559 :         while (ssread(drr, sizeof (*drr), ofp) != 0) {</span>
<span class="lineNum">     281 </span>                :            : 
<span class="lineNum">     282 </span>                :            :                 /*
<span class="lineNum">     283 </span>                :            :                  * kernel filled in checksum, we are going to write same
<span class="lineNum">     284 </span>                :            :                  * record, but need to regenerate checksum.
<span class="lineNum">     285 </span>                :            :                  */
<span class="lineNum">     286 </span>        [<span class="branchCov" title="Branch 0 was taken 549 times"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">        555 :                 if (drr-&gt;drr_type != DRR_BEGIN) {</span>
<span class="lineNum">     287 </span>                :<span class="lineCov">        549 :                         bzero(&amp;drr-&gt;drr_u.drr_checksum.drr_checksum,</span>
<span class="lineNum">     288 </span>                :            :                             sizeof (drr-&gt;drr_u.drr_checksum.drr_checksum));
<span class="lineNum">     289 </span>                :            :                 }
<span class="lineNum">     290 </span>                :            : 
<span class="lineNum">     291 </span>  [<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span><span class="branchCov" title="Branch 2 was taken 56 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">        555 :                 switch (drr-&gt;drr_type) {</span>
<span class="lineNum">         </span><span class="branchCov" title="Branch 4 was taken 42 times"> + </span><span class="branchCov" title="Branch 5 was taken 349 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchCov" title="Branch 7 was taken 96 times"> + </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">         </span>            <span class="branchNoCov" title="Branch 9 was not taken"> - </span>]
<span class="lineNum">     292 </span>                :            :                 case DRR_BEGIN:
<span class="lineNum">     293 </span>                :            :                 {
<span class="lineNum">     294 </span>                :<span class="lineCov">          6 :                         struct drr_begin *drrb = &amp;drr-&gt;drr_u.drr_begin;</span>
<span class="lineNum">     295 </span>                :            :                         int fflags;
<span class="lineNum">     296 </span>                :<span class="lineCov">          6 :                         int sz = 0;</span>
<span class="lineNum">     297 </span>                :<span class="lineCov">          6 :                         ZIO_SET_CHECKSUM(&amp;stream_cksum, 0, 0, 0, 0);</span>
<span class="lineNum">     298 </span>                :            : 
<span class="lineNum">     299 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">          6 :                         ASSERT3U(drrb-&gt;drr_magic, ==, DMU_BACKUP_MAGIC);</span>
<span class="lineNum">     300 </span>                :            : 
<span class="lineNum">     301 </span>                :            :                         /* set the DEDUP feature flag for this stream */
<span class="lineNum">     302 </span>                :<span class="lineCov">          6 :                         fflags = DMU_GET_FEATUREFLAGS(drrb-&gt;drr_versioninfo);</span>
<span class="lineNum">     303 </span>                :<span class="lineCov">          6 :                         fflags |= (DMU_BACKUP_FEATURE_DEDUP |</span>
<span class="lineNum">     304 </span>                :            :                             DMU_BACKUP_FEATURE_DEDUPPROPS);
<span class="lineNum">     305 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">          6 :                         DMU_SET_FEATUREFLAGS(drrb-&gt;drr_versioninfo, fflags);</span>
<span class="lineNum">     306 </span>                :            : 
<span class="lineNum">     307 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">          6 :                         if (drr-&gt;drr_payloadlen != 0) {</span>
<span class="lineNum">     308 </span>                :<span class="lineNoCov">          0 :                                 sz = drr-&gt;drr_payloadlen;</span>
<span class="lineNum">     309 </span>                :            : 
<span class="lineNum">     310 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (sz &gt; SPA_MAXBLOCKSIZE) {</span>
<span class="lineNum">     311 </span>                :<span class="lineNoCov">          0 :                                         buf = zfs_realloc(dda-&gt;dedup_hdl, buf,</span>
<span class="lineNum">     312 </span>                :            :                                             SPA_MAXBLOCKSIZE, sz);
<span class="lineNum">     313 </span>                :            :                                 }
<span class="lineNum">     314 </span>                :<span class="lineNoCov">          0 :                                 (void) ssread(buf, sz, ofp);</span>
<span class="lineNum">     315 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (ferror(stdin))</span>
<span class="lineNum">     316 </span>                :<span class="lineNoCov">          0 :                                         perror(&quot;fread&quot;);</span>
<span class="lineNum">     317 </span>                :            :                         }
<span class="lineNum">     318 </span>        [<span class="branchCov" title="Branch 1 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          6 :                         if (dump_record(drr, buf, sz, &amp;stream_cksum,</span>
<span class="lineNum">     319 </span>                :            :                             outfd) != 0)
<span class="lineNum">     320 </span>                :            :                                 goto out;
<span class="lineNum">     321 </span>                :            :                         break;
<span class="lineNum">     322 </span>                :            :                 }
<span class="lineNum">     323 </span>                :            : 
<span class="lineNum">     324 </span>                :            :                 case DRR_END:
<span class="lineNum">     325 </span>                :            :                 {
<span class="lineNum">     326 </span>                :<span class="lineCov">          6 :                         struct drr_end *drre = &amp;drr-&gt;drr_u.drr_end;</span>
<span class="lineNum">     327 </span>                :            :                         /* use the recalculated checksum */
<span class="lineNum">     328 </span>                :<span class="lineCov">          6 :                         drre-&gt;drr_checksum = stream_cksum;</span>
<span class="lineNum">     329 </span>        [<span class="branchCov" title="Branch 1 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          6 :                         if (dump_record(drr, NULL, 0, &amp;stream_cksum,</span>
<span class="lineNum">     330 </span>                :            :                             outfd) != 0)
<span class="lineNum">     331 </span>                :            :                                 goto out;
<span class="lineNum">     332 </span>                :            :                         break;
<span class="lineNum">     333 </span>                :            :                 }
<span class="lineNum">     334 </span>                :            : 
<span class="lineNum">     335 </span>                :            :                 case DRR_OBJECT:
<span class="lineNum">     336 </span>                :            :                 {
<span class="lineNum">     337 </span>                :<span class="lineCov">         56 :                         struct drr_object *drro = &amp;drr-&gt;drr_u.drr_object;</span>
<span class="lineNum">     338 </span>        [<span class="branchCov" title="Branch 0 was taken 26 times"> + </span><span class="branchCov" title="Branch 1 was taken 30 times"> + </span>]:<span class="lineCov">         56 :                         if (drro-&gt;drr_bonuslen &gt; 0) {</span>
<span class="lineNum">     339 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 26 times"> + </span>]:<span class="lineCov">         26 :                                 (void) ssread(buf,</span>
<span class="lineNum">     340 </span>                :<span class="lineCov">         52 :                                     DRR_OBJECT_PAYLOAD_SIZE(drro), ofp);</span>
<span class="lineNum">     341 </span>                :            :                         }
<span class="lineNum">     342 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 56 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 56 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         56 :                         if (dump_record(drr, buf, DRR_OBJECT_PAYLOAD_SIZE(drro),</span>
<span class="lineNum">     343 </span>                :            :                             &amp;stream_cksum, outfd) != 0)
<span class="lineNum">     344 </span>                :            :                                 goto out;
<span class="lineNum">     345 </span>                :            :                         break;
<span class="lineNum">     346 </span>                :            :                 }
<span class="lineNum">     347 </span>                :            : 
<span class="lineNum">     348 </span>                :            :                 case DRR_SPILL:
<span class="lineNum">     349 </span>                :            :                 {
<span class="lineNum">     350 </span>                :<span class="lineNoCov">          0 :                         struct drr_spill *drrs = &amp;drr-&gt;drr_u.drr_spill;</span>
<span class="lineNum">     351 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         (void) ssread(buf, DRR_SPILL_PAYLOAD_SIZE(drrs), ofp);</span>
<span class="lineNum">     352 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (dump_record(drr, buf, DRR_SPILL_PAYLOAD_SIZE(drrs),</span>
<span class="lineNum">     353 </span>                :            :                             &amp;stream_cksum, outfd) != 0)
<span class="lineNum">     354 </span>                :            :                                 goto out;
<span class="lineNum">     355 </span>                :            :                         break;
<span class="lineNum">     356 </span>                :            :                 }
<span class="lineNum">     357 </span>                :            : 
<span class="lineNum">     358 </span>                :            :                 case DRR_FREEOBJECTS:
<span class="lineNum">     359 </span>                :            :                 {
<span class="lineNum">     360 </span>        [<span class="branchCov" title="Branch 1 was taken 42 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         42 :                         if (dump_record(drr, NULL, 0, &amp;stream_cksum,</span>
<span class="lineNum">     361 </span>                :            :                             outfd) != 0)
<span class="lineNum">     362 </span>                :            :                                 goto out;
<span class="lineNum">     363 </span>                :            :                         break;
<span class="lineNum">     364 </span>                :            :                 }
<span class="lineNum">     365 </span>                :            : 
<span class="lineNum">     366 </span>                :            :                 case DRR_WRITE:
<span class="lineNum">     367 </span>                :            :                 {
<span class="lineNum">     368 </span>                :<span class="lineCov">        349 :                         struct drr_write *drrw = &amp;drr-&gt;drr_u.drr_write;</span>
<span class="lineNum">     369 </span>                :            :                         dataref_t       dataref;
<span class="lineNum">     370 </span>                :            :                         uint64_t        payload_size;
<span class="lineNum">     371 </span>                :            : 
<span class="lineNum">     372 </span>        [<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchCov" title="Branch 1 was taken 339 times"> + </span>]:<span class="lineCov">        349 :                         payload_size = DRR_WRITE_PAYLOAD_SIZE(drrw);</span>
<span class="lineNum">     373 </span>                :<span class="lineCov">        349 :                         (void) ssread(buf, payload_size, ofp);</span>
<span class="lineNum">     374 </span>                :            : 
<span class="lineNum">     375 </span>                :            :                         /*
<span class="lineNum">     376 </span>                :            :                          * Use the existing checksum if it's dedup-capable,
<span class="lineNum">     377 </span>                :            :                          * else calculate a SHA256 checksum for it.
<span class="lineNum">     378 </span>                :            :                          */
<span class="lineNum">     379 </span>                :            : 
<span class="lineNum">     380 </span>        [<span class="branchCov" title="Branch 0 was taken 337 times"> + </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>]:<span class="lineCov">        349 :                         if (ZIO_CHECKSUM_EQUAL(drrw-&gt;drr_key.ddk_cksum,</span>
<span class="lineNum">     381 </span>        [<span class="branchCov" title="Branch 0 was taken 337 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        337 :                             zero_cksum) ||</span>
<span class="lineNum">     382 </span>                :<span class="lineCov">        337 :                             !DRR_IS_DEDUP_CAPABLE(drrw-&gt;drr_flags)) {</span>
<span class="lineNum">     383 </span>                :            :                                 SHA2_CTX ctx;
<span class="lineNum">     384 </span>                :            :                                 zio_cksum_t tmpsha256;
<span class="lineNum">     385 </span>                :            : 
<span class="lineNum">     386 </span>                :<span class="lineCov">        349 :                                 SHA2Init(SHA256, &amp;ctx);</span>
<span class="lineNum">     387 </span>                :<span class="lineCov">        349 :                                 SHA2Update(&amp;ctx, buf, payload_size);</span>
<span class="lineNum">     388 </span>                :<span class="lineCov">        349 :                                 SHA2Final(&amp;tmpsha256, &amp;ctx);</span>
<span class="lineNum">     389 </span>                :            : 
<span class="lineNum">     390 </span>                :<span class="lineCov">        349 :                                 drrw-&gt;drr_key.ddk_cksum.zc_word[0] =</span>
<span class="lineNum">     391 </span>                :<span class="lineCov">        349 :                                     BE_64(tmpsha256.zc_word[0]);</span>
<span class="lineNum">     392 </span>                :<span class="lineCov">        349 :                                 drrw-&gt;drr_key.ddk_cksum.zc_word[1] =</span>
<span class="lineNum">     393 </span>                :<span class="lineCov">        349 :                                     BE_64(tmpsha256.zc_word[1]);</span>
<span class="lineNum">     394 </span>                :<span class="lineCov">        349 :                                 drrw-&gt;drr_key.ddk_cksum.zc_word[2] =</span>
<span class="lineNum">     395 </span>                :<span class="lineCov">        349 :                                     BE_64(tmpsha256.zc_word[2]);</span>
<span class="lineNum">     396 </span>                :<span class="lineCov">        349 :                                 drrw-&gt;drr_key.ddk_cksum.zc_word[3] =</span>
<span class="lineNum">     397 </span>                :<span class="lineCov">        349 :                                     BE_64(tmpsha256.zc_word[3]);</span>
<span class="lineNum">     398 </span>                :<span class="lineCov">        349 :                                 drrw-&gt;drr_checksumtype = ZIO_CHECKSUM_SHA256;</span>
<span class="lineNum">     399 </span>                :<span class="lineCov">        349 :                                 drrw-&gt;drr_flags |= DRR_CHECKSUM_DEDUP;</span>
<span class="lineNum">     400 </span>                :            :                         }
<span class="lineNum">     401 </span>                :            : 
<span class="lineNum">     402 </span>                :<span class="lineCov">        349 :                         dataref.ref_guid = drrw-&gt;drr_toguid;</span>
<span class="lineNum">     403 </span>                :<span class="lineCov">        349 :                         dataref.ref_object = drrw-&gt;drr_object;</span>
<span class="lineNum">     404 </span>                :<span class="lineCov">        349 :                         dataref.ref_offset = drrw-&gt;drr_offset;</span>
<span class="lineNum">     405 </span>                :            : 
<span class="lineNum">     406 </span>        [<span class="branchCov" title="Branch 1 was taken 227 times"> + </span><span class="branchCov" title="Branch 2 was taken 122 times"> + </span>]:<span class="lineCov">        349 :                         if (ddt_update(dda-&gt;dedup_hdl, &amp;ddt,</span>
<span class="lineNum">     407 </span>                :            :                             &amp;drrw-&gt;drr_key.ddk_cksum, drrw-&gt;drr_key.ddk_prop,
<span class="lineNum">     408 </span>                :            :                             &amp;dataref)) {
<span class="lineNum">     409 </span>                :<span class="lineCov">        227 :                                 dmu_replay_record_t wbr_drr = {0};</span>
<span class="lineNum">     410 </span>                :<span class="lineCov">        227 :                                 struct drr_write_byref *wbr_drrr =</span>
<span class="lineNum">     411 </span>                :            :                                     &amp;wbr_drr.drr_u.drr_write_byref;
<span class="lineNum">     412 </span>                :            : 
<span class="lineNum">     413 </span>                :            :                                 /* block already present in stream */
<span class="lineNum">     414 </span>                :<span class="lineCov">        227 :                                 wbr_drr.drr_type = DRR_WRITE_BYREF;</span>
<span class="lineNum">     415 </span>                :            : 
<span class="lineNum">     416 </span>                :<span class="lineCov">        227 :                                 wbr_drrr-&gt;drr_object = drrw-&gt;drr_object;</span>
<span class="lineNum">     417 </span>                :<span class="lineCov">        227 :                                 wbr_drrr-&gt;drr_offset = drrw-&gt;drr_offset;</span>
<span class="lineNum">     418 </span>                :<span class="lineCov">        227 :                                 wbr_drrr-&gt;drr_length = drrw-&gt;drr_logical_size;</span>
<span class="lineNum">     419 </span>                :<span class="lineCov">        227 :                                 wbr_drrr-&gt;drr_toguid = drrw-&gt;drr_toguid;</span>
<span class="lineNum">     420 </span>                :<span class="lineCov">        227 :                                 wbr_drrr-&gt;drr_refguid = dataref.ref_guid;</span>
<span class="lineNum">     421 </span>                :<span class="lineCov">        227 :                                 wbr_drrr-&gt;drr_refobject =</span>
<span class="lineNum">     422 </span>                :<span class="lineCov">        227 :                                     dataref.ref_object;</span>
<span class="lineNum">     423 </span>                :<span class="lineCov">        227 :                                 wbr_drrr-&gt;drr_refoffset =</span>
<span class="lineNum">     424 </span>                :<span class="lineCov">        227 :                                     dataref.ref_offset;</span>
<span class="lineNum">     425 </span>                :            : 
<span class="lineNum">     426 </span>                :<span class="lineCov">        227 :                                 wbr_drrr-&gt;drr_checksumtype =</span>
<span class="lineNum">     427 </span>                :<span class="lineCov">        227 :                                     drrw-&gt;drr_checksumtype;</span>
<span class="lineNum">     428 </span>                :<span class="lineCov">        227 :                                 wbr_drrr-&gt;drr_flags = drrw-&gt;drr_flags;</span>
<span class="lineNum">     429 </span>                :<span class="lineCov">        227 :                                 wbr_drrr-&gt;drr_key.ddk_cksum =</span>
<span class="lineNum">     430 </span>                :            :                                     drrw-&gt;drr_key.ddk_cksum;
<span class="lineNum">     431 </span>                :<span class="lineCov">        227 :                                 wbr_drrr-&gt;drr_key.ddk_prop =</span>
<span class="lineNum">     432 </span>                :<span class="lineCov">        227 :                                     drrw-&gt;drr_key.ddk_prop;</span>
<span class="lineNum">     433 </span>                :            : 
<span class="lineNum">     434 </span>        [<span class="branchCov" title="Branch 1 was taken 227 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        227 :                                 if (dump_record(&amp;wbr_drr, NULL, 0,</span>
<span class="lineNum">     435 </span>                :            :                                     &amp;stream_cksum, outfd) != 0)
<span class="lineNum">     436 </span>                :            :                                         goto out;
<span class="lineNum">     437 </span>                :            :                         } else {
<span class="lineNum">     438 </span>                :            :                                 /* block not previously seen */
<span class="lineNum">     439 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 122 times"> + </span>]:<span class="lineCov">        122 :                                 if (dump_record(drr, buf, payload_size,</span>
<span class="lineNum">     440 </span>                :            :                                     &amp;stream_cksum, outfd) != 0)
<span class="lineNum">     441 </span>                :            :                                         goto out;
<span class="lineNum">     442 </span>                :            :                         }
<span class="lineNum">     443 </span>                :<span class="lineCov">        349 :                         break;</span>
<span class="lineNum">     444 </span>                :            :                 }
<span class="lineNum">     445 </span>                :            : 
<span class="lineNum">     446 </span>                :            :                 case DRR_WRITE_EMBEDDED:
<span class="lineNum">     447 </span>                :            :                 {
<span class="lineNum">     448 </span>                :<span class="lineNoCov">          0 :                         struct drr_write_embedded *drrwe =</span>
<span class="lineNum">     449 </span>                :            :                             &amp;drr-&gt;drr_u.drr_write_embedded;
<span class="lineNum">     450 </span>                :<span class="lineNoCov">          0 :                         (void) ssread(buf,</span>
<span class="lineNum">     451 </span>                :<span class="lineNoCov">          0 :                             P2ROUNDUP((uint64_t)drrwe-&gt;drr_psize, 8), ofp);</span>
<span class="lineNum">     452 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (dump_record(drr, buf,</span>
<span class="lineNum">     453 </span>                :<span class="lineNoCov">          0 :                             P2ROUNDUP((uint64_t)drrwe-&gt;drr_psize, 8),</span>
<span class="lineNum">     454 </span>                :            :                             &amp;stream_cksum, outfd) != 0)
<span class="lineNum">     455 </span>                :            :                                 goto out;
<span class="lineNum">     456 </span>                :            :                         break;
<span class="lineNum">     457 </span>                :            :                 }
<span class="lineNum">     458 </span>                :            : 
<span class="lineNum">     459 </span>                :            :                 case DRR_FREE:
<span class="lineNum">     460 </span>                :            :                 {
<span class="lineNum">     461 </span>        [<span class="branchCov" title="Branch 1 was taken 96 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         96 :                         if (dump_record(drr, NULL, 0, &amp;stream_cksum,</span>
<span class="lineNum">     462 </span>                :            :                             outfd) != 0)
<span class="lineNum">     463 </span>                :            :                                 goto out;
<span class="lineNum">     464 </span>                :            :                         break;
<span class="lineNum">     465 </span>                :            :                 }
<span class="lineNum">     466 </span>                :            : 
<span class="lineNum">     467 </span>                :            :                 case DRR_OBJECT_RANGE:
<span class="lineNum">     468 </span>                :            :                 {
<span class="lineNum">     469 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (dump_record(drr, NULL, 0, &amp;stream_cksum,</span>
<span class="lineNum">     470 </span>                :            :                             outfd) != 0)
<span class="lineNum">     471 </span>                :            :                                 goto out;
<span class="lineNum">     472 </span>                :            :                         break;
<span class="lineNum">     473 </span>                :            :                 }
<span class="lineNum">     474 </span>                :            : 
<span class="lineNum">     475 </span>                :            :                 default:
<span class="lineNum">     476 </span>                :<span class="lineNoCov">          0 :                         (void) fprintf(stderr, &quot;INVALID record type 0x%x\n&quot;,</span>
<span class="lineNum">     477 </span>                :            :                             drr-&gt;drr_type);
<span class="lineNum">     478 </span>                :            :                         /* should never happen, so assert */
<span class="lineNum">     479 </span>                :<span class="lineCov">        555 :                         assert(B_FALSE);</span>
<span class="lineNum">     480 </span>                :            :                 }
<span class="lineNum">     481 </span>                :            :         }
<span class="lineNum">     482 </span>                :            : out:
<span class="lineNum">     483 </span>                :<span class="lineCov">          4 :         umem_cache_destroy(ddt.ddecache);</span>
<span class="lineNum">     484 </span>                :<span class="lineCov">          4 :         free(ddt.dedup_hash_array);</span>
<span class="lineNum">     485 </span>                :<span class="lineCov">          4 :         free(buf);</span>
<span class="lineNum">     486 </span>                :<span class="lineCov">          4 :         (void) fclose(ofp);</span>
<span class="lineNum">     487 </span>                :            : 
<span class="lineNum">     488 </span>                :<span class="lineCov">          4 :         return (NULL);</span>
<span class="lineNum">     489 </span>                :            : }
<span class="lineNum">     490 </span>                :            : 
<span class="lineNum">     491 </span>                :            : /*
<span class="lineNum">     492 </span>                :            :  * Routines for dealing with the AVL tree of fs-nvlists
<span class="lineNum">     493 </span>                :            :  */
<span class="lineNum">     494 </span>                :            : typedef struct fsavl_node {
<span class="lineNum">     495 </span>                :            :         avl_node_t fn_node;
<span class="lineNum">     496 </span>                :            :         nvlist_t *fn_nvfs;
<span class="lineNum">     497 </span>                :            :         char *fn_snapname;
<span class="lineNum">     498 </span>                :            :         uint64_t fn_guid;
<span class="lineNum">     499 </span>                :            : } fsavl_node_t;
<a name="500"><span class="lineNum">     500 </span>                :            : </a>
<span class="lineNum">     501 </span>                :            : static int
<span class="lineNum">     502 </span>                :<span class="lineCov">      22876 : fsavl_compare(const void *arg1, const void *arg2)</span>
<span class="lineNum">     503 </span>                :            : {
<span class="lineNum">     504 </span>                :<span class="lineCov">      22876 :         const fsavl_node_t *fn1 = (const fsavl_node_t *)arg1;</span>
<span class="lineNum">     505 </span>                :<span class="lineCov">      22876 :         const fsavl_node_t *fn2 = (const fsavl_node_t *)arg2;</span>
<span class="lineNum">     506 </span>                :            : 
<span class="lineNum">     507 </span>                :<span class="lineCov">      22876 :         return (AVL_CMP(fn1-&gt;fn_guid, fn2-&gt;fn_guid));</span>
<span class="lineNum">     508 </span>                :            : }
<span class="lineNum">     509 </span>                :            : 
<span class="lineNum">     510 </span>                :            : /*
<span class="lineNum">     511 </span>                :            :  * Given the GUID of a snapshot, find its containing filesystem and
<span class="lineNum">     512 </span>                :            :  * (optionally) name.
<a name="513"><span class="lineNum">     513 </span>                :            :  */</a>
<span class="lineNum">     514 </span>                :            : static nvlist_t *
<span class="lineNum">     515 </span>                :<span class="lineCov">       2198 : fsavl_find(avl_tree_t *avl, uint64_t snapguid, char **snapname)</span>
<span class="lineNum">     516 </span>                :            : {
<span class="lineNum">     517 </span>                :            :         fsavl_node_t fn_find;
<span class="lineNum">     518 </span>                :            :         fsavl_node_t *fn;
<span class="lineNum">     519 </span>                :            : 
<span class="lineNum">     520 </span>                :<span class="lineCov">       2198 :         fn_find.fn_guid = snapguid;</span>
<span class="lineNum">     521 </span>                :            : 
<span class="lineNum">     522 </span>                :<span class="lineCov">       2198 :         fn = avl_find(avl, &amp;fn_find, NULL);</span>
<span class="lineNum">     523 </span>        [<span class="branchCov" title="Branch 0 was taken 2140 times"> + </span><span class="branchCov" title="Branch 1 was taken 58 times"> + </span>]:<span class="lineCov">       2198 :         if (fn) {</span>
<span class="lineNum">     524 </span>        [<span class="branchCov" title="Branch 0 was taken 1302 times"> + </span><span class="branchCov" title="Branch 1 was taken 838 times"> + </span>]:<span class="lineCov">       2140 :                 if (snapname)</span>
<span class="lineNum">     525 </span>                :<span class="lineCov">       1302 :                         *snapname = fn-&gt;fn_snapname;</span>
<span class="lineNum">     526 </span>                :<span class="lineCov">       2140 :                 return (fn-&gt;fn_nvfs);</span>
<span class="lineNum">     527 </span>                :            :         }
<span class="lineNum">     528 </span>                :            :         return (NULL);
<span class="lineNum">     529 </span>                :            : }
<a name="530"><span class="lineNum">     530 </span>                :            : </a>
<span class="lineNum">     531 </span>                :            : static void
<span class="lineNum">     532 </span>                :<span class="lineCov">        368 : fsavl_destroy(avl_tree_t *avl)</span>
<span class="lineNum">     533 </span>                :            : {
<span class="lineNum">     534 </span>                :            :         fsavl_node_t *fn;
<span class="lineNum">     535 </span>                :            :         void *cookie;
<span class="lineNum">     536 </span>                :            : 
<span class="lineNum">     537 </span>        [<span class="branchCov" title="Branch 0 was taken 191 times"> + </span><span class="branchCov" title="Branch 1 was taken 177 times"> + </span>]:<span class="lineCov">        368 :         if (avl == NULL)</span>
<span class="lineNum">     538 </span>                :<span class="lineCov">        177 :                 return;</span>
<span class="lineNum">     539 </span>                :            : 
<span class="lineNum">     540 </span>                :<span class="lineCov">        191 :         cookie = NULL;</span>
<span class="lineNum">     541 </span>        [<span class="branchCov" title="Branch 1 was taken 2185 times"> + </span><span class="branchCov" title="Branch 2 was taken 191 times"> + </span>]:<span class="lineCov">       2376 :         while ((fn = avl_destroy_nodes(avl, &amp;cookie)) != NULL)</span>
<span class="lineNum">     542 </span>                :<span class="lineCov">       2185 :                 free(fn);</span>
<span class="lineNum">     543 </span>                :<span class="lineCov">        191 :         avl_destroy(avl);</span>
<span class="lineNum">     544 </span>                :<span class="lineCov">        191 :         free(avl);</span>
<span class="lineNum">     545 </span>                :            : }
<span class="lineNum">     546 </span>                :            : 
<span class="lineNum">     547 </span>                :            : /*
<span class="lineNum">     548 </span>                :            :  * Given an nvlist, produce an avl tree of snapshots, ordered by guid
<a name="549"><span class="lineNum">     549 </span>                :            :  */</a>
<span class="lineNum">     550 </span>                :            : static avl_tree_t *
<span class="lineNum">     551 </span>                :<span class="lineCov">        191 : fsavl_create(nvlist_t *fss)</span>
<span class="lineNum">     552 </span>                :            : {
<span class="lineNum">     553 </span>                :            :         avl_tree_t *fsavl;
<span class="lineNum">     554 </span>                :<span class="lineCov">        191 :         nvpair_t *fselem = NULL;</span>
<span class="lineNum">     555 </span>                :            : 
<span class="lineNum">     556 </span>        [<span class="branchCov" title="Branch 0 was taken 191 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        191 :         if ((fsavl = malloc(sizeof (avl_tree_t))) == NULL)</span>
<span class="lineNum">     557 </span>                :            :                 return (NULL);
<span class="lineNum">     558 </span>                :            : 
<span class="lineNum">     559 </span>                :<span class="lineCov">        191 :         avl_create(fsavl, fsavl_compare, sizeof (fsavl_node_t),</span>
<span class="lineNum">     560 </span>                :            :             offsetof(fsavl_node_t, fn_node));
<span class="lineNum">     561 </span>                :            : 
<span class="lineNum">     562 </span>        [<span class="branchCov" title="Branch 1 was taken 733 times"> + </span><span class="branchCov" title="Branch 2 was taken 191 times"> + </span>]:<span class="lineCov">        924 :         while ((fselem = nvlist_next_nvpair(fss, fselem)) != NULL) {</span>
<span class="lineNum">     563 </span>                :            :                 nvlist_t *nvfs, *snaps;
<span class="lineNum">     564 </span>                :<span class="lineCov">        733 :                 nvpair_t *snapelem = NULL;</span>
<span class="lineNum">     565 </span>                :            : 
<span class="lineNum">     566 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 733 times"> + </span>]:<span class="lineCov">        733 :                 VERIFY(0 == nvpair_value_nvlist(fselem, &amp;nvfs));</span>
<span class="lineNum">     567 </span>        [<span class="branchCov" title="Branch 1 was taken 733 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        733 :                 VERIFY(0 == nvlist_lookup_nvlist(nvfs, &quot;snaps&quot;, &amp;snaps));</span>
<span class="lineNum">     568 </span>                :            : 
<span class="lineNum">     569 </span>        [<span class="branchCov" title="Branch 1 was taken 2187 times"> + </span><span class="branchCov" title="Branch 2 was taken 733 times"> + </span>]:<span class="lineCov">       2920 :                 while ((snapelem =</span>
<span class="lineNum">     570 </span>                :<span class="lineCov">       2920 :                     nvlist_next_nvpair(snaps, snapelem)) != NULL) {</span>
<span class="lineNum">     571 </span>                :            :                         fsavl_node_t *fn;
<span class="lineNum">     572 </span>                :            :                         uint64_t guid;
<span class="lineNum">     573 </span>                :            : 
<span class="lineNum">     574 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2187 times"> + </span>]:<span class="lineCov">       2187 :                         VERIFY(0 == nvpair_value_uint64(snapelem, &amp;guid));</span>
<span class="lineNum">     575 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2187 times"> + </span>]:<span class="lineCov">       2187 :                         if ((fn = malloc(sizeof (fsavl_node_t))) == NULL) {</span>
<span class="lineNum">     576 </span>                :<span class="lineNoCov">          0 :                                 fsavl_destroy(fsavl);</span>
<span class="lineNum">     577 </span>                :<span class="lineNoCov">          0 :                                 return (NULL);</span>
<span class="lineNum">     578 </span>                :            :                         }
<span class="lineNum">     579 </span>                :<span class="lineCov">       2187 :                         fn-&gt;fn_nvfs = nvfs;</span>
<span class="lineNum">     580 </span>                :<span class="lineCov">       2187 :                         fn-&gt;fn_snapname = nvpair_name(snapelem);</span>
<span class="lineNum">     581 </span>                :<span class="lineCov">       2187 :                         fn-&gt;fn_guid = guid;</span>
<span class="lineNum">     582 </span>                :            : 
<span class="lineNum">     583 </span>                :            :                         /*
<span class="lineNum">     584 </span>                :            :                          * Note: if there are multiple snaps with the
<span class="lineNum">     585 </span>                :            :                          * same GUID, we ignore all but one.
<span class="lineNum">     586 </span>                :            :                          */
<span class="lineNum">     587 </span>        [<span class="branchCov" title="Branch 1 was taken 2185 times"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span>]:<span class="lineCov">       2187 :                         if (avl_find(fsavl, fn, NULL) == NULL)</span>
<span class="lineNum">     588 </span>                :<span class="lineCov">       2185 :                                 avl_add(fsavl, fn);</span>
<span class="lineNum">     589 </span>                :            :                         else
<span class="lineNum">     590 </span>                :<span class="lineCov">       2187 :                                 free(fn);</span>
<span class="lineNum">     591 </span>                :            :                 }
<span class="lineNum">     592 </span>                :            :         }
<span class="lineNum">     593 </span>                :            : 
<span class="lineNum">     594 </span>                :            :         return (fsavl);
<span class="lineNum">     595 </span>                :            : }
<span class="lineNum">     596 </span>                :            : 
<span class="lineNum">     597 </span>                :            : /*
<span class="lineNum">     598 </span>                :            :  * Routines for dealing with the giant nvlist of fs-nvlists, etc.
<span class="lineNum">     599 </span>                :            :  */
<span class="lineNum">     600 </span>                :            : typedef struct send_data {
<span class="lineNum">     601 </span>                :            :         /*
<span class="lineNum">     602 </span>                :            :          * assigned inside every recursive call,
<span class="lineNum">     603 </span>                :            :          * restored from *_save on return:
<span class="lineNum">     604 </span>                :            :          *
<span class="lineNum">     605 </span>                :            :          * guid of fromsnap snapshot in parent dataset
<span class="lineNum">     606 </span>                :            :          * txg of fromsnap snapshot in current dataset
<span class="lineNum">     607 </span>                :            :          * txg of tosnap snapshot in current dataset
<span class="lineNum">     608 </span>                :            :          */
<span class="lineNum">     609 </span>                :            : 
<span class="lineNum">     610 </span>                :            :         uint64_t parent_fromsnap_guid;
<span class="lineNum">     611 </span>                :            :         uint64_t fromsnap_txg;
<span class="lineNum">     612 </span>                :            :         uint64_t tosnap_txg;
<span class="lineNum">     613 </span>                :            : 
<span class="lineNum">     614 </span>                :            :         /* the nvlists get accumulated during depth-first traversal */
<span class="lineNum">     615 </span>                :            :         nvlist_t *parent_snaps;
<span class="lineNum">     616 </span>                :            :         nvlist_t *fss;
<span class="lineNum">     617 </span>                :            :         nvlist_t *snapprops;
<span class="lineNum">     618 </span>                :            : 
<span class="lineNum">     619 </span>                :            :         /* send-receive configuration, does not change during traversal */
<span class="lineNum">     620 </span>                :            :         const char *fsname;
<span class="lineNum">     621 </span>                :            :         const char *fromsnap;
<span class="lineNum">     622 </span>                :            :         const char *tosnap;
<span class="lineNum">     623 </span>                :            :         boolean_t raw;
<span class="lineNum">     624 </span>                :            :         boolean_t recursive;
<span class="lineNum">     625 </span>                :            :         boolean_t verbose;
<span class="lineNum">     626 </span>                :            :         boolean_t seenfrom;
<span class="lineNum">     627 </span>                :            :         boolean_t seento;
<span class="lineNum">     628 </span>                :            : 
<span class="lineNum">     629 </span>                :            :         /*
<span class="lineNum">     630 </span>                :            :          * The header nvlist is of the following format:
<span class="lineNum">     631 </span>                :            :          * {
<span class="lineNum">     632 </span>                :            :          *   &quot;tosnap&quot; -&gt; string
<span class="lineNum">     633 </span>                :            :          *   &quot;fromsnap&quot; -&gt; string (if incremental)
<span class="lineNum">     634 </span>                :            :          *   &quot;fss&quot; -&gt; {
<span class="lineNum">     635 </span>                :            :          *      id -&gt; {
<span class="lineNum">     636 </span>                :            :          *
<span class="lineNum">     637 </span>                :            :          *       &quot;name&quot; -&gt; string (full name; for debugging)
<span class="lineNum">     638 </span>                :            :          *       &quot;parentfromsnap&quot; -&gt; number (guid of fromsnap in parent)
<span class="lineNum">     639 </span>                :            :          *
<span class="lineNum">     640 </span>                :            :          *       &quot;props&quot; -&gt; { name -&gt; value (only if set here) }
<span class="lineNum">     641 </span>                :            :          *       &quot;snaps&quot; -&gt; { name (lastname) -&gt; number (guid) }
<span class="lineNum">     642 </span>                :            :          *       &quot;snapprops&quot; -&gt; { name (lastname) -&gt; { name -&gt; value } }
<span class="lineNum">     643 </span>                :            :          *
<span class="lineNum">     644 </span>                :            :          *       &quot;origin&quot; -&gt; number (guid) (if clone)
<span class="lineNum">     645 </span>                :            :          *       &quot;is_encroot&quot; -&gt; boolean
<span class="lineNum">     646 </span>                :            :          *       &quot;sent&quot; -&gt; boolean (not on-disk)
<span class="lineNum">     647 </span>                :            :          *      }
<span class="lineNum">     648 </span>                :            :          *   }
<span class="lineNum">     649 </span>                :            :          * }
<span class="lineNum">     650 </span>                :            :          *
<span class="lineNum">     651 </span>                :            :          */
<span class="lineNum">     652 </span>                :            : } send_data_t;
<span class="lineNum">     653 </span>                :            : 
<span class="lineNum">     654 </span>                :            : static void send_iterate_prop(zfs_handle_t *zhp, nvlist_t *nv);
<a name="655"><span class="lineNum">     655 </span>                :            : </a>
<span class="lineNum">     656 </span>                :            : static int
<span class="lineNum">     657 </span>                :<span class="lineCov">       1275 : send_iterate_snap(zfs_handle_t *zhp, void *arg)</span>
<span class="lineNum">     658 </span>                :            : {
<span class="lineNum">     659 </span>                :<span class="lineCov">       1275 :         send_data_t *sd = arg;</span>
<span class="lineNum">     660 </span>                :<span class="lineCov">       1275 :         uint64_t guid = zhp-&gt;zfs_dmustats.dds_guid;</span>
<span class="lineNum">     661 </span>                :<span class="lineCov">       1275 :         uint64_t txg = zhp-&gt;zfs_dmustats.dds_creation_txg;</span>
<span class="lineNum">     662 </span>                :            :         char *snapname;
<span class="lineNum">     663 </span>                :            :         nvlist_t *nv;
<span class="lineNum">     664 </span>                :            :         boolean_t isfromsnap, istosnap, istosnapwithnofrom;
<span class="lineNum">     665 </span>                :            : 
<span class="lineNum">     666 </span>                :<span class="lineCov">       1275 :         snapname = strrchr(zhp-&gt;zfs_name, '@')+1;</span>
<span class="lineNum">     667 </span>[<span class="branchCov" title="Branch 0 was taken 594 times"> + </span><span class="branchCov" title="Branch 1 was taken 681 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 364 times"> + </span><span class="branchCov" title="Branch 3 was taken 230 times"> + </span>]:<span class="lineCov">       1275 :         isfromsnap = (sd-&gt;fromsnap != NULL &amp;&amp;</span>
<span class="lineNum">     668 </span>                :<span class="lineCov">        594 :             strcmp(sd-&gt;fromsnap, snapname) == 0);</span>
<span class="lineNum">     669 </span>[<span class="branchCov" title="Branch 0 was taken 931 times"> + </span><span class="branchCov" title="Branch 1 was taken 344 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 637 times"> + </span><span class="branchCov" title="Branch 3 was taken 294 times"> + </span>]:<span class="lineCov">       1275 :         istosnap = (sd-&gt;tosnap != NULL &amp;&amp; (strcmp(sd-&gt;tosnap, snapname) == 0));</span>
<span class="lineNum">     670 </span>[<span class="branchCov" title="Branch 0 was taken 294 times"> + </span><span class="branchCov" title="Branch 1 was taken 981 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 74 times"> + </span><span class="branchCov" title="Branch 3 was taken 220 times"> + </span>]:<span class="lineCov">       1275 :         istosnapwithnofrom = (istosnap &amp;&amp; sd-&gt;fromsnap == NULL);</span>
<span class="lineNum">     671 </span>                :            : 
<span class="lineNum">     672 </span>[<span class="branchCov" title="Branch 0 was taken 931 times"> + </span><span class="branchCov" title="Branch 1 was taken 344 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchCov" title="Branch 3 was taken 929 times"> + </span>]:<span class="lineCov">       1275 :         if (sd-&gt;tosnap_txg != 0 &amp;&amp; txg &gt; sd-&gt;tosnap_txg) {</span>
<span class="lineNum">     673 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :                 if (sd-&gt;verbose) {</span>
<span class="lineNum">     674 </span>                :<span class="lineNoCov">          0 :                         (void) fprintf(stderr, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">     675 </span>                :            :                             &quot;skipping snapshot %s because it was created &quot;
<span class="lineNum">     676 </span>                :            :                             &quot;after the destination snapshot (%s)\n&quot;),
<span class="lineNum">     677 </span>                :            :                             zhp-&gt;zfs_name, sd-&gt;tosnap);
<span class="lineNum">     678 </span>                :            :                 }
<span class="lineNum">     679 </span>                :<span class="lineCov">          2 :                 zfs_close(zhp);</span>
<span class="lineNum">     680 </span>                :<span class="lineCov">          2 :                 return (0);</span>
<span class="lineNum">     681 </span>                :            :         }
<span class="lineNum">     682 </span>                :            : 
<span class="lineNum">     683 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1273 times"> + </span>]:<span class="lineCov">       1273 :         VERIFY(0 == nvlist_add_uint64(sd-&gt;parent_snaps, snapname, guid));</span>
<span class="lineNum">     684 </span>                :            :         /*
<span class="lineNum">     685 </span>                :            :          * NB: if there is no fromsnap here (it's a newly created fs in
<span class="lineNum">     686 </span>                :            :          * an incremental replication), we will substitute the tosnap.
<span class="lineNum">     687 </span>                :            :          */
<span class="lineNum">     688 </span>[<span class="branchCov" title="Branch 0 was taken 1043 times"> + </span><span class="branchCov" title="Branch 1 was taken 230 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 787 times"> + </span><span class="branchCov" title="Branch 3 was taken 256 times"> + </span>]:<span class="lineCov">       1273 :         if (isfromsnap || (sd-&gt;parent_fromsnap_guid == 0 &amp;&amp; istosnap)) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 220 times"> + </span><span class="branchCov" title="Branch 5 was taken 567 times"> + </span>]
<span class="lineNum">     689 </span>                :<span class="lineCov">        450 :                 sd-&gt;parent_fromsnap_guid = guid;</span>
<span class="lineNum">     690 </span>                :            :         }
<span class="lineNum">     691 </span>                :            : 
<span class="lineNum">     692 </span>        [<span class="branchCov" title="Branch 0 was taken 34 times"> + </span><span class="branchCov" title="Branch 1 was taken 1239 times"> + </span>]:<span class="lineCov">       1273 :         if (!sd-&gt;recursive) {</span>
<span class="lineNum">     693 </span>[<span class="branchCov" title="Branch 0 was taken 29 times"> + </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 3 times"> + </span><span class="branchCov" title="Branch 3 was taken 26 times"> + </span>]:<span class="lineCov">         34 :                 if (!sd-&gt;seenfrom &amp;&amp; isfromsnap) {</span>
<span class="lineNum">     694 </span>                :<span class="lineCov">          3 :                         sd-&gt;seenfrom = B_TRUE;</span>
<span class="lineNum">     695 </span>                :<span class="lineCov">          3 :                         zfs_close(zhp);</span>
<span class="lineNum">     696 </span>                :<span class="lineCov">          3 :                         return (0);</span>
<span class="lineNum">     697 </span>                :            :                 }
<span class="lineNum">     698 </span>                :            : 
<span class="lineNum">     699 </span>[<span class="branchCov" title="Branch 0 was taken 31 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 26 times"> + </span><span class="branchCov" title="Branch 3 was taken 5 times"> + </span>]:<span class="lineCov">         31 :                 if ((sd-&gt;seento || !sd-&gt;seenfrom) &amp;&amp; !istosnapwithnofrom) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 4 times"> + </span><span class="branchCov" title="Branch 5 was taken 22 times"> + </span>]
<span class="lineNum">     700 </span>                :<span class="lineCov">          4 :                         zfs_close(zhp);</span>
<span class="lineNum">     701 </span>                :<span class="lineCov">          4 :                         return (0);</span>
<span class="lineNum">     702 </span>                :            :                 }
<span class="lineNum">     703 </span>                :            : 
<span class="lineNum">     704 </span>        [<span class="branchCov" title="Branch 0 was taken 25 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">         27 :                 if (istosnap)</span>
<span class="lineNum">     705 </span>                :<span class="lineCov">         25 :                         sd-&gt;seento = B_TRUE;</span>
<span class="lineNum">     706 </span>                :            :         }
<span class="lineNum">     707 </span>                :            : 
<span class="lineNum">     708 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1266 times"> + </span>]:<span class="lineCov">       1266 :         VERIFY(0 == nvlist_alloc(&amp;nv, NV_UNIQUE_NAME, 0));</span>
<span class="lineNum">     709 </span>                :<span class="lineCov">       1266 :         send_iterate_prop(zhp, nv);</span>
<span class="lineNum">     710 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1266 times"> + </span>]:<span class="lineCov">       1266 :         VERIFY(0 == nvlist_add_nvlist(sd-&gt;snapprops, snapname, nv));</span>
<span class="lineNum">     711 </span>                :<span class="lineCov">       1266 :         nvlist_free(nv);</span>
<span class="lineNum">     712 </span>                :            : 
<span class="lineNum">     713 </span>                :<span class="lineCov">       1266 :         zfs_close(zhp);</span>
<span class="lineNum">     714 </span>                :<span class="lineCov">       1266 :         return (0);</span>
<span class="lineNum">     715 </span>                :            : }
<a name="716"><span class="lineNum">     716 </span>                :            : </a>
<span class="lineNum">     717 </span>                :            : static void
<span class="lineNum">     718 </span>                :<span class="lineCov">       1722 : send_iterate_prop(zfs_handle_t *zhp, nvlist_t *nv)</span>
<span class="lineNum">     719 </span>                :            : {
<span class="lineNum">     720 </span>                :<span class="lineCov">       1722 :         nvpair_t *elem = NULL;</span>
<span class="lineNum">     721 </span>                :            : 
<span class="lineNum">     722 </span>        [<span class="branchCov" title="Branch 1 was taken 41782 times"> + </span><span class="branchCov" title="Branch 2 was taken 1722 times"> + </span>]:<span class="lineCov">      43504 :         while ((elem = nvlist_next_nvpair(zhp-&gt;zfs_props, elem)) != NULL) {</span>
<span class="lineNum">     723 </span>                :<span class="lineCov">      41782 :                 char *propname = nvpair_name(elem);</span>
<span class="lineNum">     724 </span>                :<span class="lineCov">      41782 :                 zfs_prop_t prop = zfs_name_to_prop(propname);</span>
<span class="lineNum">     725 </span>                :            :                 nvlist_t *propnv;
<span class="lineNum">     726 </span>                :            : 
<span class="lineNum">     727 </span>        [<span class="branchCov" title="Branch 1 was taken 41415 times"> + </span><span class="branchCov" title="Branch 2 was taken 367 times"> + </span>]:<span class="lineCov">      41782 :                 if (!zfs_prop_user(propname)) {</span>
<span class="lineNum">     728 </span>                :            :                         /*
<span class="lineNum">     729 </span>                :            :                          * Realistically, this should never happen.  However,
<span class="lineNum">     730 </span>                :            :                          * we want the ability to add DSL properties without
<span class="lineNum">     731 </span>                :            :                          * needing to make incompatible version changes.  We
<span class="lineNum">     732 </span>                :            :                          * need to ignore unknown properties to allow older
<span class="lineNum">     733 </span>                :            :                          * software to still send datasets containing these
<span class="lineNum">     734 </span>                :            :                          * properties, with the unknown properties elided.
<span class="lineNum">     735 </span>                :            :                          */
<span class="lineNum">     736 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 41415 times"> + </span>]:<span class="lineCov">      41415 :                         if (prop == ZPROP_INVAL)</span>
<span class="lineNum">     737 </span>                :<span class="lineCov">      41782 :                                 continue;</span>
<span class="lineNum">     738 </span>                :            : 
<span class="lineNum">     739 </span>        [<span class="branchCov" title="Branch 1 was taken 32503 times"> + </span><span class="branchCov" title="Branch 2 was taken 8912 times"> + </span>]:<span class="lineCov">      41415 :                         if (zfs_prop_readonly(prop))</span>
<span class="lineNum">     740 </span>                :<span class="lineCov">      32503 :                                 continue;</span>
<span class="lineNum">     741 </span>                :            :                 }
<span class="lineNum">     742 </span>                :            : 
<span class="lineNum">     743 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 9279 times"> + </span>]:<span class="lineCov">       9279 :                 verify(nvpair_value_nvlist(elem, &amp;propnv) == 0);</span>
<span class="lineNum">     744 </span>        [<span class="branchCov" title="Branch 0 was taken 6645 times"> + </span><span class="branchCov" title="Branch 1 was taken 2634 times"> + </span>]:<span class="lineCov">       9279 :                 if (prop == ZFS_PROP_QUOTA || prop == ZFS_PROP_RESERVATION ||</span>
<span class="lineNum">     745 </span>        [<span class="branchCov" title="Branch 0 was taken 1722 times"> + </span><span class="branchCov" title="Branch 1 was taken 4923 times"> + </span>]:<span class="lineCov">       6645 :                     prop == ZFS_PROP_REFQUOTA ||</span>
<span class="lineNum">     746 </span>                :<span class="lineCov">        134 :                     prop == ZFS_PROP_REFRESERVATION) {</span>
<span class="lineNum">     747 </span>                :            :                         char *source;
<span class="lineNum">     748 </span>                :            :                         uint64_t value;
<span class="lineNum">     749 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 4356 times"> + </span>]:<span class="lineCov">       4356 :                         verify(nvlist_lookup_uint64(propnv,</span>
<span class="lineNum">     750 </span>                :            :                             ZPROP_VALUE, &amp;value) == 0);
<span class="lineNum">     751 </span>        [<span class="branchCov" title="Branch 0 was taken 2532 times"> + </span><span class="branchCov" title="Branch 1 was taken 1824 times"> + </span>]:<span class="lineCov">       4356 :                         if (zhp-&gt;zfs_type == ZFS_TYPE_SNAPSHOT)</span>
<span class="lineNum">     752 </span>                :<span class="lineCov">       4222 :                                 continue;</span>
<span class="lineNum">     753 </span>                :            :                         /*
<span class="lineNum">     754 </span>                :            :                          * May have no source before SPA_VERSION_RECVD_PROPS,
<span class="lineNum">     755 </span>                :            :                          * but is still modifiable.
<span class="lineNum">     756 </span>                :            :                          */
<span class="lineNum">     757 </span>        [<span class="branchCov" title="Branch 1 was taken 1824 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1824 :                         if (nvlist_lookup_string(propnv,</span>
<span class="lineNum">     758 </span>                :            :                             ZPROP_SOURCE, &amp;source) == 0) {
<span class="lineNum">     759 </span>[<span class="branchCov" title="Branch 0 was taken 1737 times"> + </span><span class="branchCov" title="Branch 1 was taken 87 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1690 times"> + </span><span class="branchCov" title="Branch 3 was taken 47 times"> + </span>]:<span class="lineCov">       1824 :                                 if ((strcmp(source, zhp-&gt;zfs_name) != 0) &amp;&amp;</span>
<span class="lineNum">     760 </span>                :<span class="lineCov">       1737 :                                     (strcmp(source,</span>
<span class="lineNum">     761 </span>                :            :                                     ZPROP_SOURCE_VAL_RECVD) != 0))
<span class="lineNum">     762 </span>                :<span class="lineCov">       1690 :                                         continue;</span>
<span class="lineNum">     763 </span>                :            :                         }
<span class="lineNum">     764 </span>                :            :                 } else {
<span class="lineNum">     765 </span>                :            :                         char *source;
<span class="lineNum">     766 </span>        [<span class="branchCov" title="Branch 1 was taken 508 times"> + </span><span class="branchCov" title="Branch 2 was taken 4415 times"> + </span>]:<span class="lineCov">       4923 :                         if (nvlist_lookup_string(propnv,</span>
<span class="lineNum">     767 </span>                :            :                             ZPROP_SOURCE, &amp;source) != 0)
<span class="lineNum">     768 </span>                :<span class="lineCov">       4281 :                                 continue;</span>
<span class="lineNum">     769 </span>[<span class="branchCov" title="Branch 0 was taken 3783 times"> + </span><span class="branchCov" title="Branch 1 was taken 632 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 3773 times"> + </span><span class="branchCov" title="Branch 3 was taken 10 times"> + </span>]:<span class="lineCov">       4415 :                         if ((strcmp(source, zhp-&gt;zfs_name) != 0) &amp;&amp;</span>
<span class="lineNum">     770 </span>                :<span class="lineCov">       3783 :                             (strcmp(source, ZPROP_SOURCE_VAL_RECVD) != 0))</span>
<span class="lineNum">     771 </span>                :<span class="lineCov">       4415 :                                 continue;</span>
<span class="lineNum">     772 </span>                :            :                 }
<span class="lineNum">     773 </span>                :            : 
<span class="lineNum">     774 </span>  [<span class="branchCov" title="Branch 1 was taken 734 times"> + </span><span class="branchCov" title="Branch 2 was taken 42 times"> + </span><span class="branchCov" title="Branch 3 was taken 87 times"> + </span><span class="branchCov" title="Branch 4 was taken 647 times"> + </span>]:<span class="lineCov">       1510 :                 if (zfs_prop_user(propname) ||</span>
<span class="lineNum">     775 </span>                :<span class="lineCov">        863 :                     zfs_prop_get_type(prop) == PROP_TYPE_STRING) {</span>
<span class="lineNum">     776 </span>                :            :                         char *value;
<span class="lineNum">     777 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 129 times"> + </span>]:<span class="lineCov">        129 :                         verify(nvlist_lookup_string(propnv,</span>
<span class="lineNum">     778 </span>                :            :                             ZPROP_VALUE, &amp;value) == 0);
<span class="lineNum">     779 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 129 times"> + </span>]:<span class="lineCov">        129 :                         VERIFY(0 == nvlist_add_string(nv, propname, value));</span>
<span class="lineNum">     780 </span>                :            :                 } else {
<span class="lineNum">     781 </span>                :            :                         uint64_t value;
<span class="lineNum">     782 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 647 times"> + </span>]:<span class="lineCov">        647 :                         verify(nvlist_lookup_uint64(propnv,</span>
<span class="lineNum">     783 </span>                :            :                             ZPROP_VALUE, &amp;value) == 0);
<span class="lineNum">     784 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 647 times"> + </span>]:<span class="lineCov">        776 :                         VERIFY(0 == nvlist_add_uint64(nv, propname, value));</span>
<span class="lineNum">     785 </span>                :            :                 }
<span class="lineNum">     786 </span>                :            :         }
<span class="lineNum">     787 </span>                :<span class="lineCov">       1722 : }</span>
<span class="lineNum">     788 </span>                :            : 
<span class="lineNum">     789 </span>                :            : /*
<span class="lineNum">     790 </span>                :            :  * returns snapshot creation txg
<span class="lineNum">     791 </span>                :            :  * and returns 0 if the snapshot does not exist
<a name="792"><span class="lineNum">     792 </span>                :            :  */</a>
<span class="lineNum">     793 </span>                :            : static uint64_t
<span class="lineNum">     794 </span>                :<span class="lineCov">        912 : get_snap_txg(libzfs_handle_t *hdl, const char *fs, const char *snap)</span>
<span class="lineNum">     795 </span>                :            : {
<span class="lineNum">     796 </span>                :            :         char name[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">     797 </span>                :<span class="lineCov">        912 :         uint64_t txg = 0;</span>
<span class="lineNum">     798 </span>                :            : 
<span class="lineNum">     799 </span>[<span class="branchCov" title="Branch 0 was taken 912 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 912 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">        912 :         if (fs == NULL || fs[0] == '\0' || snap == NULL || snap[0] == '\0')</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 530 times"> + </span><span class="branchCov" title="Branch 5 was taken 382 times"> + </span>][<span class="branchCov" title="Branch 6 was taken 530 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">     800 </span>                :            :                 return (txg);
<span class="lineNum">     801 </span>                :            : 
<span class="lineNum">     802 </span>                :<span class="lineCov">        530 :         (void) snprintf(name, sizeof (name), &quot;%s@%s&quot;, fs, snap);</span>
<span class="lineNum">     803 </span>        [<span class="branchCov" title="Branch 1 was taken 526 times"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">        530 :         if (zfs_dataset_exists(hdl, name, ZFS_TYPE_SNAPSHOT)) {</span>
<span class="lineNum">     804 </span>                :<span class="lineCov">        526 :                 zfs_handle_t *zhp = zfs_open(hdl, name, ZFS_TYPE_SNAPSHOT);</span>
<span class="lineNum">     805 </span>        [<span class="branchCov" title="Branch 0 was taken 526 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        526 :                 if (zhp != NULL) {</span>
<span class="lineNum">     806 </span>                :<span class="lineCov">        526 :                         txg = zfs_prop_get_int(zhp, ZFS_PROP_CREATETXG);</span>
<span class="lineNum">     807 </span>                :<span class="lineCov">        526 :                         zfs_close(zhp);</span>
<span class="lineNum">     808 </span>                :            :                 }
<span class="lineNum">     809 </span>                :            :         }
<span class="lineNum">     810 </span>                :            : 
<span class="lineNum">     811 </span>                :            :         return (txg);
<span class="lineNum">     812 </span>                :            : }
<span class="lineNum">     813 </span>                :            : 
<span class="lineNum">     814 </span>                :            : /*
<span class="lineNum">     815 </span>                :            :  * recursively generate nvlists describing datasets.  See comment
<span class="lineNum">     816 </span>                :            :  * for the data structure send_data_t above for description of contents
<span class="lineNum">     817 </span>                :            :  * of the nvlist.
<a name="818"><span class="lineNum">     818 </span>                :            :  */</a>
<span class="lineNum">     819 </span>                :            : static int
<span class="lineNum">     820 </span>                :<span class="lineCov">        456 : send_iterate_fs(zfs_handle_t *zhp, void *arg)</span>
<span class="lineNum">     821 </span>                :            : {
<span class="lineNum">     822 </span>                :<span class="lineCov">        456 :         send_data_t *sd = arg;</span>
<span class="lineNum">     823 </span>                :<span class="lineCov">        456 :         nvlist_t *nvfs = NULL, *nv = NULL;</span>
<span class="lineNum">     824 </span>                :<span class="lineCov">        456 :         int rv = 0;</span>
<span class="lineNum">     825 </span>                :<span class="lineCov">        456 :         uint64_t parent_fromsnap_guid_save = sd-&gt;parent_fromsnap_guid;</span>
<span class="lineNum">     826 </span>                :<span class="lineCov">        456 :         uint64_t fromsnap_txg_save = sd-&gt;fromsnap_txg;</span>
<span class="lineNum">     827 </span>                :<span class="lineCov">        456 :         uint64_t tosnap_txg_save = sd-&gt;tosnap_txg;</span>
<span class="lineNum">     828 </span>                :<span class="lineCov">        456 :         uint64_t txg = zhp-&gt;zfs_dmustats.dds_creation_txg;</span>
<span class="lineNum">     829 </span>                :<span class="lineCov">        456 :         uint64_t guid = zhp-&gt;zfs_dmustats.dds_guid;</span>
<span class="lineNum">     830 </span>                :            :         uint64_t fromsnap_txg, tosnap_txg;
<span class="lineNum">     831 </span>                :            :         char guidstring[64];
<span class="lineNum">     832 </span>                :            : 
<span class="lineNum">     833 </span>                :<span class="lineCov">        456 :         fromsnap_txg = get_snap_txg(zhp-&gt;zfs_hdl, zhp-&gt;zfs_name, sd-&gt;fromsnap);</span>
<span class="lineNum">     834 </span>        [<span class="branchCov" title="Branch 0 was taken 230 times"> + </span><span class="branchCov" title="Branch 1 was taken 226 times"> + </span>]:<span class="lineCov">        456 :         if (fromsnap_txg != 0)</span>
<span class="lineNum">     835 </span>                :<span class="lineCov">        230 :                 sd-&gt;fromsnap_txg = fromsnap_txg;</span>
<span class="lineNum">     836 </span>                :            : 
<span class="lineNum">     837 </span>                :<span class="lineCov">        456 :         tosnap_txg = get_snap_txg(zhp-&gt;zfs_hdl, zhp-&gt;zfs_name, sd-&gt;tosnap);</span>
<span class="lineNum">     838 </span>        [<span class="branchCov" title="Branch 0 was taken 296 times"> + </span><span class="branchCov" title="Branch 1 was taken 160 times"> + </span>]:<span class="lineCov">        456 :         if (tosnap_txg != 0)</span>
<span class="lineNum">     839 </span>                :<span class="lineCov">        296 :                 sd-&gt;tosnap_txg = tosnap_txg;</span>
<span class="lineNum">     840 </span>                :            : 
<span class="lineNum">     841 </span>                :            :         /*
<span class="lineNum">     842 </span>                :            :          * on the send side, if the current dataset does not have tosnap,
<span class="lineNum">     843 </span>                :            :          * perform two additional checks:
<span class="lineNum">     844 </span>                :            :          *
<span class="lineNum">     845 </span>                :            :          * - skip sending the current dataset if it was created later than
<span class="lineNum">     846 </span>                :            :          *   the parent tosnap
<span class="lineNum">     847 </span>                :            :          * - return error if the current dataset was created earlier than
<span class="lineNum">     848 </span>                :            :          *   the parent tosnap
<span class="lineNum">     849 </span>                :            :          */
<span class="lineNum">     850 </span>[<span class="branchCov" title="Branch 0 was taken 296 times"> + </span><span class="branchCov" title="Branch 1 was taken 160 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 296 times"> + </span>]:<span class="lineCov">        456 :         if (sd-&gt;tosnap != NULL &amp;&amp; tosnap_txg == 0) {</span>
<span class="lineNum">     851 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (sd-&gt;tosnap_txg != 0 &amp;&amp; txg &gt; sd-&gt;tosnap_txg) {</span>
<span class="lineNum">     852 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (sd-&gt;verbose) {</span>
<span class="lineNum">     853 </span>                :<span class="lineNoCov">          0 :                                 (void) fprintf(stderr, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">     854 </span>                :            :                                     &quot;skipping dataset %s: snapshot %s does &quot;
<span class="lineNum">     855 </span>                :            :                                     &quot;not exist\n&quot;), zhp-&gt;zfs_name, sd-&gt;tosnap);
<span class="lineNum">     856 </span>                :            :                         }
<span class="lineNum">     857 </span>                :            :                 } else {
<span class="lineNum">     858 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         (void) fprintf(stderr, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">     859 </span>                :            :                             &quot;cannot send %s@%s%s: snapshot %s@%s does not &quot;
<span class="lineNum">     860 </span>                :<span class="lineNoCov">          0 :                             &quot;exist\n&quot;), sd-&gt;fsname, sd-&gt;tosnap, sd-&gt;recursive ?</span>
<span class="lineNum">     861 </span>                :            :                             dgettext(TEXT_DOMAIN, &quot; recursively&quot;) : &quot;&quot;,
<span class="lineNum">     862 </span>                :            :                             zhp-&gt;zfs_name, sd-&gt;tosnap);
<span class="lineNum">     863 </span>                :<span class="lineNoCov">          0 :                         rv = -1;</span>
<span class="lineNum">     864 </span>                :            :                 }
<span class="lineNum">     865 </span>                :            :                 goto out;
<span class="lineNum">     866 </span>                :            :         }
<span class="lineNum">     867 </span>                :            : 
<span class="lineNum">     868 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 456 times"> + </span>]:<span class="lineCov">        456 :         VERIFY(0 == nvlist_alloc(&amp;nvfs, NV_UNIQUE_NAME, 0));</span>
<span class="lineNum">     869 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 456 times"> + </span>]:<span class="lineCov">        456 :         VERIFY(0 == nvlist_add_string(nvfs, &quot;name&quot;, zhp-&gt;zfs_name));</span>
<span class="lineNum">     870 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 456 times"> + </span>]:<span class="lineCov">        456 :         VERIFY(0 == nvlist_add_uint64(nvfs, &quot;parentfromsnap&quot;,</span>
<span class="lineNum">     871 </span>                :            :             sd-&gt;parent_fromsnap_guid));
<span class="lineNum">     872 </span>                :            : 
<span class="lineNum">     873 </span>        [<span class="branchCov" title="Branch 0 was taken 116 times"> + </span><span class="branchCov" title="Branch 1 was taken 340 times"> + </span>]:<span class="lineCov">        456 :         if (zhp-&gt;zfs_dmustats.dds_origin[0]) {</span>
<span class="lineNum">     874 </span>                :<span class="lineCov">        116 :                 zfs_handle_t *origin = zfs_open(zhp-&gt;zfs_hdl,</span>
<span class="lineNum">     875 </span>                :<span class="lineCov">        116 :                     zhp-&gt;zfs_dmustats.dds_origin, ZFS_TYPE_SNAPSHOT);</span>
<span class="lineNum">     876 </span>        [<span class="branchCov" title="Branch 0 was taken 116 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        116 :                 if (origin == NULL) {</span>
<span class="lineNum">     877 </span>                :            :                         rv = -1;
<span class="lineNum">     878 </span>                :            :                         goto out;
<span class="lineNum">     879 </span>                :            :                 }
<span class="lineNum">     880 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 116 times"> + </span>]:<span class="lineCov">        116 :                 VERIFY(0 == nvlist_add_uint64(nvfs, &quot;origin&quot;,</span>
<span class="lineNum">     881 </span>                :            :                     origin-&gt;zfs_dmustats.dds_guid));
<span class="lineNum">     882 </span>                :            : 
<span class="lineNum">     883 </span>                :<span class="lineCov">        116 :                 zfs_close(origin);</span>
<span class="lineNum">     884 </span>                :            :         }
<span class="lineNum">     885 </span>                :            : 
<span class="lineNum">     886 </span>                :            :         /* iterate over props */
<span class="lineNum">     887 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 456 times"> + </span>]:<span class="lineCov">        456 :         VERIFY(0 == nvlist_alloc(&amp;nv, NV_UNIQUE_NAME, 0));</span>
<span class="lineNum">     888 </span>                :<span class="lineCov">        456 :         send_iterate_prop(zhp, nv);</span>
<span class="lineNum">     889 </span>                :            : 
<span class="lineNum">     890 </span>        [<span class="branchCov" title="Branch 1 was taken 19 times"> + </span><span class="branchCov" title="Branch 2 was taken 437 times"> + </span>]:<span class="lineCov">        456 :         if (zfs_prop_get_int(zhp, ZFS_PROP_ENCRYPTION) != ZIO_CRYPT_OFF) {</span>
<span class="lineNum">     891 </span>                :            :                 boolean_t encroot;
<span class="lineNum">     892 </span>                :            : 
<span class="lineNum">     893 </span>                :            :                 /* determine if this dataset is an encryption root */
<span class="lineNum">     894 </span>        [<span class="branchCov" title="Branch 1 was taken 19 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         19 :                 if (zfs_crypto_get_encryption_root(zhp, &amp;encroot, NULL) != 0) {</span>
<span class="lineNum">     895 </span>                :            :                         rv = -1;
<span class="lineNum">     896 </span>                :<span class="lineCov">          2 :                         goto out;</span>
<span class="lineNum">     897 </span>                :            :                 }
<span class="lineNum">     898 </span>                :            : 
<span class="lineNum">     899 </span>        [<span class="branchCov" title="Branch 0 was taken 10 times"> + </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>]:<span class="lineCov">         19 :                 if (encroot)</span>
<span class="lineNum">     900 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 10 times"> + </span>]:<span class="lineCov">         10 :                         VERIFY(0 == nvlist_add_boolean(nvfs, &quot;is_encroot&quot;));</span>
<span class="lineNum">     901 </span>                :            : 
<span class="lineNum">     902 </span>                :            :                 /*
<span class="lineNum">     903 </span>                :            :                  * Encrypted datasets can only be sent with properties if
<span class="lineNum">     904 </span>                :            :                  * the raw flag is specified because the receive side doesn't
<span class="lineNum">     905 </span>                :            :                  * currently have a mechanism for recursively asking the user
<span class="lineNum">     906 </span>                :            :                  * for new encryption parameters.
<span class="lineNum">     907 </span>                :            :                  */
<span class="lineNum">     908 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 17 times"> + </span>]:<span class="lineCov">         19 :                 if (!sd-&gt;raw) {</span>
<span class="lineNum">     909 </span>                :<span class="lineCov">          4 :                         (void) fprintf(stderr, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">     910 </span>                :            :                             &quot;cannot send %s@%s: encrypted dataset %s may not &quot;
<span class="lineNum">     911 </span>                :            :                             &quot;be sent with properties without the raw flag\n&quot;),
<span class="lineNum">     912 </span>                :            :                             sd-&gt;fsname, sd-&gt;tosnap, zhp-&gt;zfs_name);
<span class="lineNum">     913 </span>                :<span class="lineCov">         19 :                         rv = -1;</span>
<span class="lineNum">     914 </span>                :<span class="lineCov">          2 :                         goto out;</span>
<span class="lineNum">     915 </span>                :            :                 }
<span class="lineNum">     916 </span>                :            : 
<span class="lineNum">     917 </span>                :            :         }
<span class="lineNum">     918 </span>                :            : 
<span class="lineNum">     919 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 454 times"> + </span>]:<span class="lineCov">        454 :         VERIFY(0 == nvlist_add_nvlist(nvfs, &quot;props&quot;, nv));</span>
<span class="lineNum">     920 </span>                :            : 
<span class="lineNum">     921 </span>                :            :         /* iterate over snaps, and set sd-&gt;parent_fromsnap_guid */
<span class="lineNum">     922 </span>                :<span class="lineCov">        454 :         sd-&gt;parent_fromsnap_guid = 0;</span>
<span class="lineNum">     923 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 454 times"> + </span>]:<span class="lineCov">        454 :         VERIFY(0 == nvlist_alloc(&amp;sd-&gt;parent_snaps, NV_UNIQUE_NAME, 0));</span>
<span class="lineNum">     924 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 454 times"> + </span>]:<span class="lineCov">        454 :         VERIFY(0 == nvlist_alloc(&amp;sd-&gt;snapprops, NV_UNIQUE_NAME, 0));</span>
<span class="lineNum">     925 </span>                :<span class="lineCov">        454 :         (void) zfs_iter_snapshots_sorted(zhp, send_iterate_snap, sd);</span>
<span class="lineNum">     926 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 454 times"> + </span>]:<span class="lineCov">        454 :         VERIFY(0 == nvlist_add_nvlist(nvfs, &quot;snaps&quot;, sd-&gt;parent_snaps));</span>
<span class="lineNum">     927 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 454 times"> + </span>]:<span class="lineCov">        454 :         VERIFY(0 == nvlist_add_nvlist(nvfs, &quot;snapprops&quot;, sd-&gt;snapprops));</span>
<span class="lineNum">     928 </span>                :<span class="lineCov">        454 :         nvlist_free(sd-&gt;parent_snaps);</span>
<span class="lineNum">     929 </span>                :<span class="lineCov">        454 :         nvlist_free(sd-&gt;snapprops);</span>
<span class="lineNum">     930 </span>                :            : 
<span class="lineNum">     931 </span>                :            :         /* add this fs to nvlist */
<span class="lineNum">     932 </span>                :<span class="lineCov">        908 :         (void) snprintf(guidstring, sizeof (guidstring),</span>
<span class="lineNum">     933 </span>                :            :             &quot;0x%llx&quot;, (longlong_t)guid);
<span class="lineNum">     934 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 454 times"> + </span>]:<span class="lineCov">        454 :         VERIFY(0 == nvlist_add_nvlist(sd-&gt;fss, guidstring, nvfs));</span>
<span class="lineNum">     935 </span>                :            : 
<span class="lineNum">     936 </span>                :            :         /* iterate over children */
<span class="lineNum">     937 </span>        [<span class="branchCov" title="Branch 0 was taken 429 times"> + </span><span class="branchCov" title="Branch 1 was taken 25 times"> + </span>]:<span class="lineCov">        454 :         if (sd-&gt;recursive)</span>
<span class="lineNum">     938 </span>                :<span class="lineCov">        429 :                 rv = zfs_iter_filesystems(zhp, send_iterate_fs, sd);</span>
<span class="lineNum">     939 </span>                :            : 
<span class="lineNum">     940 </span>                :            : out:
<span class="lineNum">     941 </span>                :<span class="lineCov">        456 :         sd-&gt;parent_fromsnap_guid = parent_fromsnap_guid_save;</span>
<span class="lineNum">     942 </span>                :<span class="lineCov">        456 :         sd-&gt;fromsnap_txg = fromsnap_txg_save;</span>
<span class="lineNum">     943 </span>                :<span class="lineCov">        456 :         sd-&gt;tosnap_txg = tosnap_txg_save;</span>
<span class="lineNum">     944 </span>                :<span class="lineCov">        456 :         nvlist_free(nv);</span>
<span class="lineNum">     945 </span>                :<span class="lineCov">        456 :         nvlist_free(nvfs);</span>
<span class="lineNum">     946 </span>                :            : 
<span class="lineNum">     947 </span>                :<span class="lineCov">        456 :         zfs_close(zhp);</span>
<span class="lineNum">     948 </span>                :<span class="lineCov">        456 :         return (rv);</span>
<span class="lineNum">     949 </span>                :            : }
<a name="950"><span class="lineNum">     950 </span>                :            : </a>
<span class="lineNum">     951 </span>                :            : static int
<span class="lineNum">     952 </span>                :<span class="lineCov">        120 : gather_nvlist(libzfs_handle_t *hdl, const char *fsname, const char *fromsnap,</span>
<span class="lineNum">     953 </span>                :            :     const char *tosnap, boolean_t recursive, boolean_t raw, boolean_t verbose,
<span class="lineNum">     954 </span>                :            :     nvlist_t **nvlp, avl_tree_t **avlp)
<span class="lineNum">     955 </span>                :            : {
<span class="lineNum">     956 </span>                :            :         zfs_handle_t *zhp;
<span class="lineNum">     957 </span>                :<span class="lineCov">        120 :         send_data_t sd = { 0 };</span>
<span class="lineNum">     958 </span>                :            :         int error;
<span class="lineNum">     959 </span>                :            : 
<span class="lineNum">     960 </span>                :<span class="lineCov">        120 :         zhp = zfs_open(hdl, fsname, ZFS_TYPE_FILESYSTEM | ZFS_TYPE_VOLUME);</span>
<span class="lineNum">     961 </span>        [<span class="branchCov" title="Branch 0 was taken 120 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        120 :         if (zhp == NULL)</span>
<span class="lineNum">     962 </span>                :            :                 return (EZFS_BADTYPE);
<span class="lineNum">     963 </span>                :            : 
<span class="lineNum">     964 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 120 times"> + </span>]:<span class="lineCov">        120 :         VERIFY(0 == nvlist_alloc(&amp;sd.fss, NV_UNIQUE_NAME, 0));</span>
<span class="lineNum">     965 </span>                :<span class="lineCov">        120 :         sd.fsname = fsname;</span>
<span class="lineNum">     966 </span>                :<span class="lineCov">        120 :         sd.fromsnap = fromsnap;</span>
<span class="lineNum">     967 </span>                :<span class="lineCov">        120 :         sd.tosnap = tosnap;</span>
<span class="lineNum">     968 </span>                :<span class="lineCov">        120 :         sd.recursive = recursive;</span>
<span class="lineNum">     969 </span>                :<span class="lineCov">        120 :         sd.raw = raw;</span>
<span class="lineNum">     970 </span>                :<span class="lineCov">        120 :         sd.verbose = verbose;</span>
<span class="lineNum">     971 </span>                :            : 
<span class="lineNum">     972 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 118 times"> + </span>]:<span class="lineCov">        120 :         if ((error = send_iterate_fs(zhp, &amp;sd)) != 0) {</span>
<span class="lineNum">     973 </span>                :<span class="lineCov">          2 :                 nvlist_free(sd.fss);</span>
<span class="lineNum">     974 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :                 if (avlp != NULL)</span>
<span class="lineNum">     975 </span>                :<span class="lineCov">          2 :                         *avlp = NULL;</span>
<span class="lineNum">     976 </span>                :<span class="lineCov">          2 :                 *nvlp = NULL;</span>
<span class="lineNum">     977 </span>                :<span class="lineCov">          2 :                 return (error);</span>
<span class="lineNum">     978 </span>                :            :         }
<span class="lineNum">     979 </span>                :            : 
<span class="lineNum">     980 </span>[<span class="branchCov" title="Branch 0 was taken 118 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 118 times"> + </span>]:<span class="lineCov">        118 :         if (avlp != NULL &amp;&amp; (*avlp = fsavl_create(sd.fss)) == NULL) {</span>
<span class="lineNum">     981 </span>                :<span class="lineNoCov">          0 :                 nvlist_free(sd.fss);</span>
<span class="lineNum">     982 </span>                :<span class="lineNoCov">          0 :                 *nvlp = NULL;</span>
<span class="lineNum">     983 </span>                :<span class="lineNoCov">          0 :                 return (EZFS_NOMEM);</span>
<span class="lineNum">     984 </span>                :            :         }
<span class="lineNum">     985 </span>                :            : 
<span class="lineNum">     986 </span>                :<span class="lineCov">        118 :         *nvlp = sd.fss;</span>
<span class="lineNum">     987 </span>                :<span class="lineCov">        118 :         return (0);</span>
<span class="lineNum">     988 </span>                :            : }
<span class="lineNum">     989 </span>                :            : 
<span class="lineNum">     990 </span>                :            : /*
<span class="lineNum">     991 </span>                :            :  * Routines specific to &quot;zfs send&quot;
<span class="lineNum">     992 </span>                :            :  */
<span class="lineNum">     993 </span>                :            : typedef struct send_dump_data {
<span class="lineNum">     994 </span>                :            :         /* these are all just the short snapname (the part after the @) */
<span class="lineNum">     995 </span>                :            :         const char *fromsnap;
<span class="lineNum">     996 </span>                :            :         const char *tosnap;
<span class="lineNum">     997 </span>                :            :         char prevsnap[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">     998 </span>                :            :         uint64_t prevsnap_obj;
<span class="lineNum">     999 </span>                :            :         boolean_t seenfrom, seento, replicate, doall, fromorigin;
<span class="lineNum">    1000 </span>                :            :         boolean_t verbose, dryrun, parsable, progress, embed_data, std_out;
<span class="lineNum">    1001 </span>                :            :         boolean_t large_block, compress, raw;
<span class="lineNum">    1002 </span>                :            :         int outfd;
<span class="lineNum">    1003 </span>                :            :         boolean_t err;
<span class="lineNum">    1004 </span>                :            :         nvlist_t *fss;
<span class="lineNum">    1005 </span>                :            :         nvlist_t *snapholds;
<span class="lineNum">    1006 </span>                :            :         avl_tree_t *fsavl;
<span class="lineNum">    1007 </span>                :            :         snapfilter_cb_t *filter_cb;
<span class="lineNum">    1008 </span>                :            :         void *filter_cb_arg;
<span class="lineNum">    1009 </span>                :            :         nvlist_t *debugnv;
<span class="lineNum">    1010 </span>                :            :         char holdtag[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    1011 </span>                :            :         int cleanup_fd;
<span class="lineNum">    1012 </span>                :            :         uint64_t size;
<span class="lineNum">    1013 </span>                :            : } send_dump_data_t;
<a name="1014"><span class="lineNum">    1014 </span>                :            : </a>
<span class="lineNum">    1015 </span>                :            : static int
<span class="lineNum">    1016 </span>                :<span class="lineCov">         26 : zfs_send_space(zfs_handle_t *zhp, const char *snapname, const char *from,</span>
<span class="lineNum">    1017 </span>                :            :     enum lzc_send_flags flags, uint64_t *spacep)
<span class="lineNum">    1018 </span>                :            : {
<span class="lineNum">    1019 </span>                :<span class="lineCov">         26 :         libzfs_handle_t *hdl = zhp-&gt;zfs_hdl;</span>
<span class="lineNum">    1020 </span>                :            :         int error;
<span class="lineNum">    1021 </span>                :            : 
<span class="lineNum">    1022 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 26 times"> + </span>]:<span class="lineCov">         26 :         assert(snapname != NULL);</span>
<span class="lineNum">    1023 </span>                :<span class="lineCov">         26 :         error = lzc_send_space(snapname, from, flags, spacep);</span>
<span class="lineNum">    1024 </span>                :            : 
<span class="lineNum">    1025 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 26 times"> + </span>]:<span class="lineCov">         26 :         if (error != 0) {</span>
<span class="lineNum">    1026 </span>                :            :                 char errbuf[1024];
<span class="lineNum">    1027 </span>                :<span class="lineNoCov">          0 :                 (void) snprintf(errbuf, sizeof (errbuf), dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1028 </span>                :            :                     &quot;warning: cannot estimate space for '%s'&quot;), snapname);
<span class="lineNum">    1029 </span>                :            : 
<span class="lineNum">    1030 </span>  [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 switch (error) {</span>
<span class="lineNum">    1031 </span>                :            :                 case EXDEV:
<span class="lineNum">    1032 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1033 </span>                :            :                             &quot;not an earlier snapshot from the same fs&quot;));
<span class="lineNum">    1034 </span>                :<span class="lineNoCov">          0 :                         return (zfs_error(hdl, EZFS_CROSSTARGET, errbuf));</span>
<span class="lineNum">    1035 </span>                :            : 
<span class="lineNum">    1036 </span>                :            :                 case ENOENT:
<span class="lineNum">    1037 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (zfs_dataset_exists(hdl, snapname,</span>
<span class="lineNum">    1038 </span>                :            :                             ZFS_TYPE_SNAPSHOT)) {
<span class="lineNum">    1039 </span>                :<span class="lineNoCov">          0 :                                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1040 </span>                :            :                                     &quot;incremental source (%s) does not exist&quot;),
<span class="lineNum">    1041 </span>                :            :                                     snapname);
<span class="lineNum">    1042 </span>                :            :                         }
<span class="lineNum">    1043 </span>                :<span class="lineNoCov">          0 :                         return (zfs_error(hdl, EZFS_NOENT, errbuf));</span>
<span class="lineNum">    1044 </span>                :            : 
<span class="lineNum">    1045 </span>                :            :                 case EDQUOT:
<span class="lineNum">    1046 </span>                :            :                 case EFBIG:
<span class="lineNum">    1047 </span>                :            :                 case EIO:
<span class="lineNum">    1048 </span>                :            :                 case ENOLINK:
<span class="lineNum">    1049 </span>                :            :                 case ENOSPC:
<span class="lineNum">    1050 </span>                :            :                 case ENOSTR:
<span class="lineNum">    1051 </span>                :            :                 case ENXIO:
<span class="lineNum">    1052 </span>                :            :                 case EPIPE:
<span class="lineNum">    1053 </span>                :            :                 case ERANGE:
<span class="lineNum">    1054 </span>                :            :                 case EFAULT:
<span class="lineNum">    1055 </span>                :            :                 case EROFS:
<span class="lineNum">    1056 </span>                :            :                 case EINVAL:
<span class="lineNum">    1057 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, strerror(error));</span>
<span class="lineNum">    1058 </span>                :<span class="lineNoCov">          0 :                         return (zfs_error(hdl, EZFS_BADBACKUP, errbuf));</span>
<span class="lineNum">    1059 </span>                :            : 
<span class="lineNum">    1060 </span>                :            :                 default:
<span class="lineNum">    1061 </span>                :<span class="lineNoCov">          0 :                         return (zfs_standard_error(hdl, error, errbuf));</span>
<span class="lineNum">    1062 </span>                :            :                 }
<span class="lineNum">    1063 </span>                :            :         }
<span class="lineNum">    1064 </span>                :            : 
<span class="lineNum">    1065 </span>                :            :         return (0);
<span class="lineNum">    1066 </span>                :            : }
<span class="lineNum">    1067 </span>                :            : 
<span class="lineNum">    1068 </span>                :            : /*
<span class="lineNum">    1069 </span>                :            :  * Dumps a backup of the given snapshot (incremental from fromsnap if it's not
<span class="lineNum">    1070 </span>                :            :  * NULL) to the file descriptor specified by outfd.
<a name="1071"><span class="lineNum">    1071 </span>                :            :  */</a>
<span class="lineNum">    1072 </span>                :            : static int
<span class="lineNum">    1073 </span>                :<span class="lineCov">        950 : dump_ioctl(zfs_handle_t *zhp, const char *fromsnap, uint64_t fromsnap_obj,</span>
<span class="lineNum">    1074 </span>                :            :     boolean_t fromorigin, int outfd, enum lzc_send_flags flags,
<span class="lineNum">    1075 </span>                :            :     nvlist_t *debugnv)
<span class="lineNum">    1076 </span>                :            : {
<span class="lineNum">    1077 </span>                :<span class="lineCov">        950 :         zfs_cmd_t zc = {&quot;\0&quot;};</span>
<span class="lineNum">    1078 </span>                :<span class="lineCov">        950 :         libzfs_handle_t *hdl = zhp-&gt;zfs_hdl;</span>
<span class="lineNum">    1079 </span>                :            :         nvlist_t *thisdbg;
<span class="lineNum">    1080 </span>                :            : 
<span class="lineNum">    1081 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 950 times"> + </span>]:<span class="lineCov">        950 :         assert(zhp-&gt;zfs_type == ZFS_TYPE_SNAPSHOT);</span>
<span class="lineNum">    1082 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 950 times"> + </span>]:<span class="lineCov">        950 :         assert(fromsnap_obj == 0 || !fromorigin);</span>
<span class="lineNum">    1083 </span>                :            : 
<span class="lineNum">    1084 </span>                :<span class="lineCov">        950 :         (void) strlcpy(zc.zc_name, zhp-&gt;zfs_name, sizeof (zc.zc_name));</span>
<span class="lineNum">    1085 </span>                :<span class="lineCov">        950 :         zc.zc_cookie = outfd;</span>
<span class="lineNum">    1086 </span>                :<span class="lineCov">        950 :         zc.zc_obj = fromorigin;</span>
<span class="lineNum">    1087 </span>                :<span class="lineCov">        950 :         zc.zc_sendobj = zfs_prop_get_int(zhp, ZFS_PROP_OBJSETID);</span>
<span class="lineNum">    1088 </span>                :<span class="lineCov">        950 :         zc.zc_fromobj = fromsnap_obj;</span>
<span class="lineNum">    1089 </span>                :<span class="lineCov">        950 :         zc.zc_flags = flags;</span>
<span class="lineNum">    1090 </span>                :            : 
<span class="lineNum">    1091 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 950 times"> + </span>]:<span class="lineCov">        950 :         VERIFY(0 == nvlist_alloc(&amp;thisdbg, NV_UNIQUE_NAME, 0));</span>
<span class="lineNum">    1092 </span>[<span class="branchCov" title="Branch 0 was taken 950 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 610 times"> + </span><span class="branchCov" title="Branch 3 was taken 340 times"> + </span>]:<span class="lineCov">        950 :         if (fromsnap &amp;&amp; fromsnap[0] != '\0') {</span>
<span class="lineNum">    1093 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 610 times"> + </span>]:<span class="lineCov">        610 :                 VERIFY(0 == nvlist_add_string(thisdbg,</span>
<span class="lineNum">    1094 </span>                :            :                     &quot;fromsnap&quot;, fromsnap));
<span class="lineNum">    1095 </span>                :            :         }
<span class="lineNum">    1096 </span>                :            : 
<span class="lineNum">    1097 </span>        [<span class="branchCov" title="Branch 1 was taken 4 times"> + </span><span class="branchCov" title="Branch 2 was taken 946 times"> + </span>]:<span class="lineCov">        950 :         if (zfs_ioctl(zhp-&gt;zfs_hdl, ZFS_IOC_SEND, &amp;zc) != 0) {</span>
<span class="lineNum">    1098 </span>                :            :                 char errbuf[1024];
<span class="lineNum">    1099 </span>                :<span class="lineCov">          8 :                 (void) snprintf(errbuf, sizeof (errbuf), dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1100 </span>                :            :                     &quot;warning: cannot send '%s'&quot;), zhp-&gt;zfs_name);
<span class="lineNum">    1101 </span>                :            : 
<span class="lineNum">    1102 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 4 times"> + </span>]:<span class="lineCov">          4 :                 VERIFY(0 == nvlist_add_uint64(thisdbg, &quot;error&quot;, errno));</span>
<span class="lineNum">    1103 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">          4 :                 if (debugnv) {</span>
<span class="lineNum">    1104 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         VERIFY(0 == nvlist_add_nvlist(debugnv,</span>
<span class="lineNum">    1105 </span>                :            :                             zhp-&gt;zfs_name, thisdbg));
<span class="lineNum">    1106 </span>                :            :                 }
<span class="lineNum">    1107 </span>                :<span class="lineCov">          4 :                 nvlist_free(thisdbg);</span>
<span class="lineNum">    1108 </span>                :            : 
<span class="lineNum">    1109 </span>  [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">          4 :                 switch (errno) {</span>
<span class="lineNum">         </span>            <span class="branchCov" title="Branch 4 was taken 3 times"> + </span>]
<span class="lineNum">    1110 </span>                :            :                 case EXDEV:
<span class="lineNum">    1111 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1112 </span>                :            :                             &quot;not an earlier snapshot from the same fs&quot;));
<span class="lineNum">    1113 </span>                :<span class="lineNoCov">          0 :                         return (zfs_error(hdl, EZFS_CROSSTARGET, errbuf));</span>
<span class="lineNum">    1114 </span>                :            : 
<span class="lineNum">    1115 </span>                :            :                 case EACCES:
<span class="lineNum">    1116 </span>                :<span class="lineCov">          1 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1117 </span>                :            :                             &quot;source key must be loaded&quot;));
<span class="lineNum">    1118 </span>                :<span class="lineCov">          1 :                         return (zfs_error(hdl, EZFS_CRYPTOFAILED, errbuf));</span>
<span class="lineNum">    1119 </span>                :            : 
<span class="lineNum">    1120 </span>                :            :                 case ENOENT:
<span class="lineNum">    1121 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (zfs_dataset_exists(hdl, zc.zc_name,</span>
<span class="lineNum">    1122 </span>                :            :                             ZFS_TYPE_SNAPSHOT)) {
<span class="lineNum">    1123 </span>                :<span class="lineNoCov">          0 :                                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1124 </span>                :            :                                     &quot;incremental source (@%s) does not exist&quot;),
<span class="lineNum">    1125 </span>                :            :                                     zc.zc_value);
<span class="lineNum">    1126 </span>                :            :                         }
<span class="lineNum">    1127 </span>                :<span class="lineNoCov">          0 :                         return (zfs_error(hdl, EZFS_NOENT, errbuf));</span>
<span class="lineNum">    1128 </span>                :            : 
<span class="lineNum">    1129 </span>                :            :                 case EDQUOT:
<span class="lineNum">    1130 </span>                :            :                 case EFBIG:
<span class="lineNum">    1131 </span>                :            :                 case EIO:
<span class="lineNum">    1132 </span>                :            :                 case ENOLINK:
<span class="lineNum">    1133 </span>                :            :                 case ENOSPC:
<span class="lineNum">    1134 </span>                :            :                 case ENOSTR:
<span class="lineNum">    1135 </span>                :            :                 case ENXIO:
<span class="lineNum">    1136 </span>                :            :                 case EPIPE:
<span class="lineNum">    1137 </span>                :            :                 case ERANGE:
<span class="lineNum">    1138 </span>                :            :                 case EFAULT:
<span class="lineNum">    1139 </span>                :            :                 case EROFS:
<span class="lineNum">    1140 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, strerror(errno));</span>
<span class="lineNum">    1141 </span>                :<span class="lineNoCov">          0 :                         return (zfs_error(hdl, EZFS_BADBACKUP, errbuf));</span>
<span class="lineNum">    1142 </span>                :            : 
<span class="lineNum">    1143 </span>                :            :                 default:
<span class="lineNum">    1144 </span>                :<span class="lineCov">          4 :                         return (zfs_standard_error(hdl, errno, errbuf));</span>
<span class="lineNum">    1145 </span>                :            :                 }
<span class="lineNum">    1146 </span>                :            :         }
<span class="lineNum">    1147 </span>                :            : 
<span class="lineNum">    1148 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 946 times"> + </span>]:<span class="lineCov">        946 :         if (debugnv)</span>
<span class="lineNum">    1149 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 VERIFY(0 == nvlist_add_nvlist(debugnv, zhp-&gt;zfs_name, thisdbg));</span>
<span class="lineNum">    1150 </span>                :<span class="lineCov">        946 :         nvlist_free(thisdbg);</span>
<span class="lineNum">    1151 </span>                :            : 
<span class="lineNum">    1152 </span>                :<span class="lineCov">        946 :         return (0);</span>
<span class="lineNum">    1153 </span>                :            : }
<a name="1154"><span class="lineNum">    1154 </span>                :            : </a>
<span class="lineNum">    1155 </span>                :            : static void
<span class="lineNum">    1156 </span>                :<span class="lineCov">       1882 : gather_holds(zfs_handle_t *zhp, send_dump_data_t *sdd)</span>
<span class="lineNum">    1157 </span>                :            : {
<span class="lineNum">    1158 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1882 times"> + </span>]:<span class="lineCov">       1882 :         assert(zhp-&gt;zfs_type == ZFS_TYPE_SNAPSHOT);</span>
<span class="lineNum">    1159 </span>                :            : 
<span class="lineNum">    1160 </span>                :            :         /*
<span class="lineNum">    1161 </span>                :            :          * zfs_send() only sets snapholds for sends that need them,
<span class="lineNum">    1162 </span>                :            :          * e.g. replication and doall.
<span class="lineNum">    1163 </span>                :            :          */
<span class="lineNum">    1164 </span>        [<span class="branchCov" title="Branch 0 was taken 792 times"> + </span><span class="branchCov" title="Branch 1 was taken 1090 times"> + </span>]:<span class="lineCov">       1882 :         if (sdd-&gt;snapholds == NULL)</span>
<span class="lineNum">    1165 </span>                :            :                 return;
<span class="lineNum">    1166 </span>                :            : 
<span class="lineNum">    1167 </span>                :<span class="lineCov">        792 :         fnvlist_add_string(sdd-&gt;snapholds, zhp-&gt;zfs_name, sdd-&gt;holdtag);</span>
<span class="lineNum">    1168 </span>                :            : }
<a name="1169"><span class="lineNum">    1169 </span>                :            : </a>
<span class="lineNum">    1170 </span>                :            : static void *
<span class="lineNum">    1171 </span>                :<span class="lineCov">         28 : send_progress_thread(void *arg)</span>
<span class="lineNum">    1172 </span>                :            : {
<span class="lineNum">    1173 </span>                :<span class="lineCov">         28 :         progress_arg_t *pa = arg;</span>
<span class="lineNum">    1174 </span>                :<span class="lineCov">         28 :         zfs_cmd_t zc = {&quot;\0&quot;};</span>
<span class="lineNum">    1175 </span>                :<span class="lineCov">         28 :         zfs_handle_t *zhp = pa-&gt;pa_zhp;</span>
<span class="lineNum">    1176 </span>                :<span class="lineCov">         28 :         libzfs_handle_t *hdl = zhp-&gt;zfs_hdl;</span>
<span class="lineNum">    1177 </span>                :            :         unsigned long long bytes;
<span class="lineNum">    1178 </span>                :            :         char buf[16];
<span class="lineNum">    1179 </span>                :            :         time_t t;
<span class="lineNum">    1180 </span>                :            :         struct tm *tm;
<span class="lineNum">    1181 </span>                :            : 
<span class="lineNum">    1182 </span>                :<span class="lineCov">         28 :         (void) strlcpy(zc.zc_name, zhp-&gt;zfs_name, sizeof (zc.zc_name));</span>
<span class="lineNum">    1183 </span>                :            : 
<span class="lineNum">    1184 </span>        [<span class="branchCov" title="Branch 0 was taken 28 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         28 :         if (!pa-&gt;pa_parsable)</span>
<span class="lineNum">    1185 </span>                :<span class="lineCov">         28 :                 (void) fprintf(stderr, &quot;TIME        SENT   SNAPSHOT\n&quot;);</span>
<span class="lineNum">    1186 </span>                :            : 
<span class="lineNum">    1187 </span>                :            :         /*
<span class="lineNum">    1188 </span>                :            :          * Print the progress from ZFS_IOC_SEND_PROGRESS every second.
<span class="lineNum">    1189 </span>                :            :          */
<span class="lineNum">    1190 </span>                :            :         for (;;) {
<span class="lineNum">    1191 </span>                :<span class="lineCov">        158 :                 (void) sleep(1);</span>
<span class="lineNum">    1192 </span>                :            : 
<span class="lineNum">    1193 </span>                :<span class="lineCov">        130 :                 zc.zc_cookie = pa-&gt;pa_fd;</span>
<span class="lineNum">    1194 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 130 times"> + </span>]:<span class="lineCov">        130 :                 if (zfs_ioctl(hdl, ZFS_IOC_SEND_PROGRESS, &amp;zc) != 0)</span>
<span class="lineNum">    1195 </span>                :<span class="lineNoCov">          0 :                         return ((void *)-1);</span>
<span class="lineNum">    1196 </span>                :            : 
<span class="lineNum">    1197 </span>                :<span class="lineCov">        130 :                 (void) time(&amp;t);</span>
<span class="lineNum">    1198 </span>                :<span class="lineCov">        130 :                 tm = localtime(&amp;t);</span>
<span class="lineNum">    1199 </span>                :<span class="lineCov">        130 :                 bytes = zc.zc_cookie;</span>
<span class="lineNum">    1200 </span>                :            : 
<span class="lineNum">    1201 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 130 times"> + </span>]:<span class="lineCov">        130 :                 if (pa-&gt;pa_parsable) {</span>
<span class="lineNum">    1202 </span>                :<span class="lineNoCov">          0 :                         (void) fprintf(stderr, &quot;%02d:%02d:%02d\t%llu\t%s\n&quot;,</span>
<span class="lineNum">    1203 </span>                :            :                             tm-&gt;tm_hour, tm-&gt;tm_min, tm-&gt;tm_sec,
<span class="lineNum">    1204 </span>                :            :                             bytes, zhp-&gt;zfs_name);
<span class="lineNum">    1205 </span>                :            :                 } else {
<span class="lineNum">    1206 </span>                :<span class="lineCov">        130 :                         zfs_nicebytes(bytes, buf, sizeof (buf));</span>
<span class="lineNum">    1207 </span>                :<span class="lineCov">        130 :                         (void) fprintf(stderr, &quot;%02d:%02d:%02d   %5s   %s\n&quot;,</span>
<span class="lineNum">    1208 </span>                :            :                             tm-&gt;tm_hour, tm-&gt;tm_min, tm-&gt;tm_sec,
<span class="lineNum">    1209 </span>                :            :                             buf, zhp-&gt;zfs_name);
<span class="lineNum">    1210 </span>                :            :                 }
<span class="lineNum">    1211 </span>                :            :         }
<span class="lineNum">    1212 </span>                :            : }
<a name="1213"><span class="lineNum">    1213 </span>                :            : </a>
<span class="lineNum">    1214 </span>                :            : static void
<span class="lineNum">    1215 </span>                :<span class="lineCov">         42 : send_print_verbose(FILE *fout, const char *tosnap, const char *fromsnap,</span>
<span class="lineNum">    1216 </span>                :            :     uint64_t size, boolean_t parsable)
<span class="lineNum">    1217 </span>                :            : {
<span class="lineNum">    1218 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchCov" title="Branch 1 was taken 35 times"> + </span>]:<span class="lineCov">         42 :         if (parsable) {</span>
<span class="lineNum">    1219 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">          7 :                 if (fromsnap != NULL) {</span>
<span class="lineNum">    1220 </span>                :            :                         (void) fprintf(fout, &quot;incremental\t%s\t%s&quot;,
<span class="lineNum">    1221 </span>                :            :                             fromsnap, tosnap);
<span class="lineNum">    1222 </span>                :            :                 } else {
<span class="lineNum">    1223 </span>                :            :                         (void) fprintf(fout, &quot;full\t%s&quot;,
<span class="lineNum">    1224 </span>                :            :                             tosnap);
<span class="lineNum">    1225 </span>                :            :                 }
<span class="lineNum">    1226 </span>                :            :         } else {
<span class="lineNum">    1227 </span>        [<span class="branchCov" title="Branch 0 was taken 17 times"> + </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">         35 :                 if (fromsnap != NULL) {</span>
<span class="lineNum">    1228 </span>[<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 8 times"> + </span><span class="branchCov" title="Branch 3 was taken 3 times"> + </span>]:<span class="lineCov">         17 :                         if (strchr(fromsnap, '@') == NULL &amp;&amp;</span>
<span class="lineNum">    1229 </span>                :<span class="lineCov">         11 :                             strchr(fromsnap, '#') == NULL) {</span>
<span class="lineNum">    1230 </span>                :<span class="lineCov">          8 :                                 (void) fprintf(fout, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1231 </span>                :            :                                     &quot;send from @%s to %s&quot;),
<span class="lineNum">    1232 </span>                :            :                                     fromsnap, tosnap);
<span class="lineNum">    1233 </span>                :            :                         } else {
<span class="lineNum">    1234 </span>                :<span class="lineCov">          9 :                                 (void) fprintf(fout, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1235 </span>                :            :                                     &quot;send from %s to %s&quot;),
<span class="lineNum">    1236 </span>                :            :                                     fromsnap, tosnap);
<span class="lineNum">    1237 </span>                :            :                         }
<span class="lineNum">    1238 </span>                :            :                 } else {
<span class="lineNum">    1239 </span>                :<span class="lineCov">         18 :                         (void) fprintf(fout, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1240 </span>                :            :                             &quot;full send of %s&quot;),
<span class="lineNum">    1241 </span>                :            :                             tosnap);
<span class="lineNum">    1242 </span>                :            :                 }
<span class="lineNum">    1243 </span>                :            :         }
<span class="lineNum">    1244 </span>                :            : 
<span class="lineNum">    1245 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchCov" title="Branch 1 was taken 35 times"> + </span>]:<span class="lineCov">         42 :         if (parsable) {</span>
<span class="lineNum">    1246 </span>                :<span class="lineCov">          7 :                 (void) fprintf(fout, &quot;\t%llu&quot;,</span>
<span class="lineNum">    1247 </span>                :            :                     (longlong_t)size);
<span class="lineNum">    1248 </span>        [<span class="branchCov" title="Branch 0 was taken 35 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         35 :         } else if (size != 0) {</span>
<span class="lineNum">    1249 </span>                :            :                 char buf[16];
<span class="lineNum">    1250 </span>                :<span class="lineCov">         35 :                 zfs_nicebytes(size, buf, sizeof (buf));</span>
<span class="lineNum">    1251 </span>                :<span class="lineCov">         35 :                 (void) fprintf(fout, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1252 </span>                :            :                     &quot; estimated size is %s&quot;), buf);
<span class="lineNum">    1253 </span>                :            :         }
<span class="lineNum">    1254 </span>                :<span class="lineCov">         42 :         (void) fprintf(fout, &quot;\n&quot;);</span>
<span class="lineNum">    1255 </span>                :<span class="lineCov">         42 : }</span>
<a name="1256"><span class="lineNum">    1256 </span>                :            : </a>
<span class="lineNum">    1257 </span>                :            : static int
<span class="lineNum">    1258 </span>                :<span class="lineCov">       2055 : dump_snapshot(zfs_handle_t *zhp, void *arg)</span>
<span class="lineNum">    1259 </span>                :            : {
<span class="lineNum">    1260 </span>                :<span class="lineCov">       2055 :         send_dump_data_t *sdd = arg;</span>
<span class="lineNum">    1261 </span>                :<span class="lineCov">       2055 :         progress_arg_t pa = { 0 };</span>
<span class="lineNum">    1262 </span>                :            :         pthread_t tid;
<span class="lineNum">    1263 </span>                :            :         char *thissnap;
<span class="lineNum">    1264 </span>                :<span class="lineCov">       2055 :         enum lzc_send_flags flags = 0;</span>
<span class="lineNum">    1265 </span>                :            :         int err;
<span class="lineNum">    1266 </span>                :            :         boolean_t isfromsnap, istosnap, fromorigin;
<span class="lineNum">    1267 </span>                :<span class="lineCov">       2055 :         boolean_t exclude = B_FALSE;</span>
<span class="lineNum">    1268 </span>        [<span class="branchCov" title="Branch 0 was taken 24 times"> + </span><span class="branchCov" title="Branch 1 was taken 2031 times"> + </span>]:<span class="lineCov">       2055 :         FILE *fout = sdd-&gt;std_out ? stdout : stderr;</span>
<span class="lineNum">    1269 </span>                :            : 
<span class="lineNum">    1270 </span>                :<span class="lineCov">       2055 :         err = 0;</span>
<span class="lineNum">    1271 </span>                :<span class="lineCov">       2055 :         thissnap = strchr(zhp-&gt;zfs_name, '@') + 1;</span>
<span class="lineNum">    1272 </span>[<span class="branchCov" title="Branch 0 was taken 601 times"> + </span><span class="branchCov" title="Branch 1 was taken 1454 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 412 times"> + </span><span class="branchCov" title="Branch 3 was taken 189 times"> + </span>]:<span class="lineCov">       2055 :         isfromsnap = (sdd-&gt;fromsnap != NULL &amp;&amp;</span>
<span class="lineNum">    1273 </span>                :<span class="lineCov">        601 :             strcmp(sdd-&gt;fromsnap, thissnap) == 0);</span>
<span class="lineNum">    1274 </span>                :            : 
<span class="lineNum">    1275 </span>[<span class="branchCov" title="Branch 0 was taken 244 times"> + </span><span class="branchCov" title="Branch 1 was taken 1811 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 189 times"> + </span><span class="branchCov" title="Branch 3 was taken 55 times"> + </span>]:<span class="lineCov">       2055 :         if (!sdd-&gt;seenfrom &amp;&amp; isfromsnap) {</span>
<span class="lineNum">    1276 </span>                :<span class="lineCov">        189 :                 gather_holds(zhp, sdd);</span>
<span class="lineNum">    1277 </span>                :<span class="lineCov">        189 :                 sdd-&gt;seenfrom = B_TRUE;</span>
<span class="lineNum">    1278 </span>                :<span class="lineCov">        189 :                 (void) strlcpy(sdd-&gt;prevsnap, thissnap,</span>
<span class="lineNum">    1279 </span>                :            :                     sizeof (sdd-&gt;prevsnap));
<span class="lineNum">    1280 </span>                :<span class="lineCov">        189 :                 sdd-&gt;prevsnap_obj = zfs_prop_get_int(zhp, ZFS_PROP_OBJSETID);</span>
<span class="lineNum">    1281 </span>                :<span class="lineCov">        189 :                 zfs_close(zhp);</span>
<span class="lineNum">    1282 </span>                :<span class="lineCov">        189 :                 return (0);</span>
<span class="lineNum">    1283 </span>                :            :         }
<span class="lineNum">    1284 </span>                :            : 
<span class="lineNum">    1285 </span>[<span class="branchCov" title="Branch 0 was taken 1839 times"> + </span><span class="branchCov" title="Branch 1 was taken 27 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 55 times"> + </span><span class="branchCov" title="Branch 3 was taken 1784 times"> + </span>]:<span class="lineCov">       1866 :         if (sdd-&gt;seento || !sdd-&gt;seenfrom) {</span>
<span class="lineNum">    1286 </span>                :<span class="lineCov">         82 :                 zfs_close(zhp);</span>
<span class="lineNum">    1287 </span>                :<span class="lineCov">         82 :                 return (0);</span>
<span class="lineNum">    1288 </span>                :            :         }
<span class="lineNum">    1289 </span>                :            : 
<span class="lineNum">    1290 </span>                :<span class="lineCov">       1784 :         istosnap = (strcmp(sdd-&gt;tosnap, thissnap) == 0);</span>
<span class="lineNum">    1291 </span>        [<span class="branchCov" title="Branch 0 was taken 723 times"> + </span><span class="branchCov" title="Branch 1 was taken 1061 times"> + </span>]:<span class="lineCov">       1784 :         if (istosnap)</span>
<span class="lineNum">    1292 </span>                :<span class="lineCov">        723 :                 sdd-&gt;seento = B_TRUE;</span>
<span class="lineNum">    1293 </span>                :            : 
<span class="lineNum">    1294 </span>        [<span class="branchCov" title="Branch 0 was taken 47 times"> + </span><span class="branchCov" title="Branch 1 was taken 1737 times"> + </span>]:<span class="lineCov">       1784 :         if (sdd-&gt;large_block)</span>
<span class="lineNum">    1295 </span>                :<span class="lineCov">         47 :                 flags |= LZC_SEND_FLAG_LARGE_BLOCK;</span>
<span class="lineNum">    1296 </span>        [<span class="branchCov" title="Branch 0 was taken 32 times"> + </span><span class="branchCov" title="Branch 1 was taken 1752 times"> + </span>]:<span class="lineCov">       1784 :         if (sdd-&gt;embed_data)</span>
<span class="lineNum">    1297 </span>                :<span class="lineCov">         32 :                 flags |= LZC_SEND_FLAG_EMBED_DATA;</span>
<span class="lineNum">    1298 </span>        [<span class="branchCov" title="Branch 0 was taken 345 times"> + </span><span class="branchCov" title="Branch 1 was taken 1439 times"> + </span>]:<span class="lineCov">       1784 :         if (sdd-&gt;compress)</span>
<span class="lineNum">    1299 </span>                :<span class="lineCov">        345 :                 flags |= LZC_SEND_FLAG_COMPRESS;</span>
<span class="lineNum">    1300 </span>        [<span class="branchCov" title="Branch 0 was taken 31 times"> + </span><span class="branchCov" title="Branch 1 was taken 1753 times"> + </span>]:<span class="lineCov">       1784 :         if (sdd-&gt;raw)</span>
<span class="lineNum">    1301 </span>                :<span class="lineCov">         31 :                 flags |= LZC_SEND_FLAG_RAW;</span>
<span class="lineNum">    1302 </span>                :            : 
<span class="lineNum">    1303 </span>        [<span class="branchCov" title="Branch 0 was taken 91 times"> + </span><span class="branchCov" title="Branch 1 was taken 1693 times"> + </span>]:<span class="lineCov">       1784 :         if (!sdd-&gt;doall &amp;&amp; !isfromsnap &amp;&amp; !istosnap) {</span>
<span class="lineNum">    1304 </span>        [<span class="branchCov" title="Branch 0 was taken 74 times"> + </span><span class="branchCov" title="Branch 1 was taken 17 times"> + </span>]:<span class="lineCov">         91 :                 if (sdd-&gt;replicate) {</span>
<span class="lineNum">    1305 </span>                :            :                         char *snapname;
<span class="lineNum">    1306 </span>                :            :                         nvlist_t *snapprops;
<span class="lineNum">    1307 </span>                :            :                         /*
<span class="lineNum">    1308 </span>                :            :                          * Filter out all intermediate snapshots except origin
<span class="lineNum">    1309 </span>                :            :                          * snapshots needed to replicate clones.
<span class="lineNum">    1310 </span>                :            :                          */
<span class="lineNum">    1311 </span>                :<span class="lineCov">         74 :                         nvlist_t *nvfs = fsavl_find(sdd-&gt;fsavl,</span>
<span class="lineNum">    1312 </span>                :            :                             zhp-&gt;zfs_dmustats.dds_guid, &amp;snapname);
<span class="lineNum">    1313 </span>                :            : 
<span class="lineNum">    1314 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 74 times"> + </span>]:<span class="lineCov">         74 :                         VERIFY(0 == nvlist_lookup_nvlist(nvfs,</span>
<span class="lineNum">    1315 </span>                :            :                             &quot;snapprops&quot;, &amp;snapprops));
<span class="lineNum">    1316 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 74 times"> + </span>]:<span class="lineCov">         74 :                         VERIFY(0 == nvlist_lookup_nvlist(snapprops,</span>
<span class="lineNum">    1317 </span>                :            :                             thissnap, &amp;snapprops));
<span class="lineNum">    1318 </span>                :<span class="lineCov">         74 :                         exclude = !nvlist_exists(snapprops, &quot;is_clone_origin&quot;);</span>
<span class="lineNum">    1319 </span>                :            :                 } else {
<span class="lineNum">    1320 </span>                :            :                         exclude = B_TRUE;
<span class="lineNum">    1321 </span>                :            :                 }
<span class="lineNum">    1322 </span>                :            :         }
<span class="lineNum">    1323 </span>                :            : 
<span class="lineNum">    1324 </span>                :            :         /*
<span class="lineNum">    1325 </span>                :            :          * If a filter function exists, call it to determine whether
<span class="lineNum">    1326 </span>                :            :          * this snapshot will be sent.
<span class="lineNum">    1327 </span>                :            :          */
<span class="lineNum">    1328 </span>        [<span class="branchCov" title="Branch 0 was taken 1693 times"> + </span><span class="branchCov" title="Branch 1 was taken 91 times"> + </span>]:<span class="lineCov">       1784 :         if (exclude || (sdd-&gt;filter_cb != NULL &amp;&amp;</span>
<span class="lineNum">         </span>  [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1693 times"> + </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    1329 </span>                :<span class="lineNoCov">          0 :             sdd-&gt;filter_cb(zhp, sdd-&gt;filter_cb_arg) == B_FALSE)) {</span>
<span class="lineNum">    1330 </span>                :            :                 /*
<span class="lineNum">    1331 </span>                :            :                  * This snapshot is filtered out.  Don't send it, and don't
<span class="lineNum">    1332 </span>                :            :                  * set prevsnap_obj, so it will be as if this snapshot didn't
<span class="lineNum">    1333 </span>                :            :                  * exist, and the next accepted snapshot will be sent as
<span class="lineNum">    1334 </span>                :            :                  * an incremental from the last accepted one, or as the
<span class="lineNum">    1335 </span>                :            :                  * first (and full) snapshot in the case of a replication,
<span class="lineNum">    1336 </span>                :            :                  * non-incremental send.
<span class="lineNum">    1337 </span>                :            :                  */
<span class="lineNum">    1338 </span>                :<span class="lineCov">         91 :                 zfs_close(zhp);</span>
<span class="lineNum">    1339 </span>                :<span class="lineCov">         91 :                 return (0);</span>
<span class="lineNum">    1340 </span>                :            :         }
<span class="lineNum">    1341 </span>                :            : 
<span class="lineNum">    1342 </span>                :<span class="lineCov">       1693 :         gather_holds(zhp, sdd);</span>
<span class="lineNum">    1343 </span>[<span class="branchCov" title="Branch 0 was taken 535 times"> + </span><span class="branchCov" title="Branch 1 was taken 1158 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 529 times"> + </span><span class="branchCov" title="Branch 3 was taken 6 times"> + </span>]:<span class="lineCov">       1693 :         fromorigin = sdd-&gt;prevsnap[0] == '\0' &amp;&amp;</span>
<span class="lineNum">    1344 </span>        [<span class="branchCov" title="Branch 0 was taken 156 times"> + </span><span class="branchCov" title="Branch 1 was taken 373 times"> + </span>]:<span class="lineCov">       1687 :             (sdd-&gt;fromorigin || sdd-&gt;replicate);</span>
<span class="lineNum">    1345 </span>                :            : 
<span class="lineNum">    1346 </span>        [<span class="branchCov" title="Branch 0 was taken 26 times"> + </span><span class="branchCov" title="Branch 1 was taken 1667 times"> + </span>]:<span class="lineCov">       1693 :         if (sdd-&gt;verbose) {</span>
<span class="lineNum">    1347 </span>                :<span class="lineCov">         26 :                 uint64_t size = 0;</span>
<span class="lineNum">    1348 </span>                :            :                 char fromds[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    1349 </span>                :            : 
<span class="lineNum">    1350 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 17 times"> + </span>]:<span class="lineCov">         26 :                 if (sdd-&gt;prevsnap[0] != '\0') {</span>
<span class="lineNum">    1351 </span>                :<span class="lineCov">          9 :                         (void) strlcpy(fromds, zhp-&gt;zfs_name, sizeof (fromds));</span>
<span class="lineNum">    1352 </span>                :<span class="lineCov">          9 :                         *(strchr(fromds, '@') + 1) = '\0';</span>
<span class="lineNum">    1353 </span>                :<span class="lineCov">          9 :                         (void) strlcat(fromds, sdd-&gt;prevsnap, sizeof (fromds));</span>
<span class="lineNum">    1354 </span>                :            :                 }
<span class="lineNum">    1355 </span>[<span class="branchCov" title="Branch 0 was taken 17 times"> + </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 26 times"> + </span>]:<span class="lineCov">         26 :                 if (zfs_send_space(zhp, zhp-&gt;zfs_name,</span>
<span class="lineNum">    1356 </span>                :<span class="lineCov">         26 :                     sdd-&gt;prevsnap[0] ? fromds : NULL, flags, &amp;size) != 0) {</span>
<span class="lineNum">    1357 </span>                :<span class="lineNoCov">          0 :                         size = 0; /* cannot estimate send space */</span>
<span class="lineNum">    1358 </span>                :            :                 } else {
<span class="lineNum">    1359 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 17 times"> + </span>]:<span class="lineCov">         26 :                         send_print_verbose(fout, zhp-&gt;zfs_name,</span>
<span class="lineNum">    1360 </span>                :<span class="lineCov">         26 :                             sdd-&gt;prevsnap[0] ? sdd-&gt;prevsnap : NULL,</span>
<span class="lineNum">    1361 </span>                :            :                             size, sdd-&gt;parsable);
<span class="lineNum">    1362 </span>                :            :                 }
<span class="lineNum">    1363 </span>                :<span class="lineCov">         26 :                 sdd-&gt;size += size;</span>
<span class="lineNum">    1364 </span>                :            :         }
<span class="lineNum">    1365 </span>                :            : 
<span class="lineNum">    1366 </span>        [<span class="branchCov" title="Branch 0 was taken 950 times"> + </span><span class="branchCov" title="Branch 1 was taken 743 times"> + </span>]:<span class="lineCov">       1693 :         if (!sdd-&gt;dryrun) {</span>
<span class="lineNum">    1367 </span>                :            :                 /*
<span class="lineNum">    1368 </span>                :            :                  * If progress reporting is requested, spawn a new thread to
<span class="lineNum">    1369 </span>                :            :                  * poll ZFS_IOC_SEND_PROGRESS at a regular interval.
<span class="lineNum">    1370 </span>                :            :                  */
<span class="lineNum">    1371 </span>        [<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchCov" title="Branch 1 was taken 936 times"> + </span>]:<span class="lineCov">        950 :                 if (sdd-&gt;progress) {</span>
<span class="lineNum">    1372 </span>                :<span class="lineCov">         14 :                         pa.pa_zhp = zhp;</span>
<span class="lineNum">    1373 </span>                :<span class="lineCov">         14 :                         pa.pa_fd = sdd-&gt;outfd;</span>
<span class="lineNum">    1374 </span>                :<span class="lineCov">         14 :                         pa.pa_parsable = sdd-&gt;parsable;</span>
<span class="lineNum">    1375 </span>                :            : 
<span class="lineNum">    1376 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 14 times"> + </span>]:<span class="lineCov">         14 :                         if ((err = pthread_create(&amp;tid, NULL,</span>
<span class="lineNum">    1377 </span>                :            :                             send_progress_thread, &amp;pa)) != 0) {
<span class="lineNum">    1378 </span>                :<span class="lineNoCov">          0 :                                 zfs_close(zhp);</span>
<span class="lineNum">    1379 </span>                :<span class="lineNoCov">          0 :                                 return (err);</span>
<span class="lineNum">    1380 </span>                :            :                         }
<span class="lineNum">    1381 </span>                :            :                 }
<span class="lineNum">    1382 </span>                :            : 
<span class="lineNum">    1383 </span>                :<span class="lineCov">        950 :                 err = dump_ioctl(zhp, sdd-&gt;prevsnap, sdd-&gt;prevsnap_obj,</span>
<span class="lineNum">    1384 </span>                :            :                     fromorigin, sdd-&gt;outfd, flags, sdd-&gt;debugnv);
<span class="lineNum">    1385 </span>                :            : 
<span class="lineNum">    1386 </span>        [<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchCov" title="Branch 1 was taken 936 times"> + </span>]:<span class="lineCov">        950 :                 if (sdd-&gt;progress) {</span>
<span class="lineNum">    1387 </span>                :<span class="lineCov">         14 :                         (void) pthread_cancel(tid);</span>
<span class="lineNum">    1388 </span>                :<span class="lineCov">         14 :                         (void) pthread_join(tid, NULL);</span>
<span class="lineNum">    1389 </span>                :            :                 }
<span class="lineNum">    1390 </span>                :            :         }
<span class="lineNum">    1391 </span>                :            : 
<span class="lineNum">    1392 </span>                :<span class="lineCov">       3386 :         (void) strcpy(sdd-&gt;prevsnap, thissnap);</span>
<span class="lineNum">    1393 </span>                :<span class="lineCov">       1693 :         sdd-&gt;prevsnap_obj = zfs_prop_get_int(zhp, ZFS_PROP_OBJSETID);</span>
<span class="lineNum">    1394 </span>                :<span class="lineCov">       1693 :         zfs_close(zhp);</span>
<span class="lineNum">    1395 </span>                :<span class="lineCov">       1693 :         return (err);</span>
<span class="lineNum">    1396 </span>                :            : }
<a name="1397"><span class="lineNum">    1397 </span>                :            : </a>
<span class="lineNum">    1398 </span>                :            : static int
<span class="lineNum">    1399 </span>                :<span class="lineCov">        730 : dump_filesystem(zfs_handle_t *zhp, void *arg)</span>
<span class="lineNum">    1400 </span>                :            : {
<span class="lineNum">    1401 </span>                :<span class="lineCov">        730 :         int rv = 0;</span>
<span class="lineNum">    1402 </span>                :<span class="lineCov">        730 :         send_dump_data_t *sdd = arg;</span>
<span class="lineNum">    1403 </span>                :<span class="lineCov">        730 :         boolean_t missingfrom = B_FALSE;</span>
<span class="lineNum">    1404 </span>                :<span class="lineCov">        730 :         zfs_cmd_t zc = {&quot;\0&quot;};</span>
<span class="lineNum">    1405 </span>                :            : 
<span class="lineNum">    1406 </span>                :<span class="lineCov">       1460 :         (void) snprintf(zc.zc_name, sizeof (zc.zc_name), &quot;%s@%s&quot;,</span>
<span class="lineNum">    1407 </span>                :<span class="lineCov">        730 :             zhp-&gt;zfs_name, sdd-&gt;tosnap);</span>
<span class="lineNum">    1408 </span>        [<span class="branchCov" title="Branch 1 was taken 6 times"> + </span><span class="branchCov" title="Branch 2 was taken 724 times"> + </span>]:<span class="lineCov">        730 :         if (ioctl(zhp-&gt;zfs_hdl-&gt;libzfs_fd, ZFS_IOC_OBJSET_STATS, &amp;zc) != 0) {</span>
<span class="lineNum">    1409 </span>                :<span class="lineCov">         12 :                 (void) fprintf(stderr, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1410 </span>                :            :                     &quot;WARNING: could not send %s@%s: does not exist\n&quot;),
<span class="lineNum">    1411 </span>                :            :                     zhp-&gt;zfs_name, sdd-&gt;tosnap);
<span class="lineNum">    1412 </span>                :<span class="lineCov">          6 :                 sdd-&gt;err = B_TRUE;</span>
<span class="lineNum">    1413 </span>                :<span class="lineCov">          6 :                 return (0);</span>
<span class="lineNum">    1414 </span>                :            :         }
<span class="lineNum">    1415 </span>                :            : 
<span class="lineNum">    1416 </span>[<span class="branchCov" title="Branch 0 was taken 515 times"> + </span><span class="branchCov" title="Branch 1 was taken 209 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 142 times"> + </span><span class="branchCov" title="Branch 3 was taken 373 times"> + </span>]:<span class="lineCov">        724 :         if (sdd-&gt;replicate &amp;&amp; sdd-&gt;fromsnap) {</span>
<span class="lineNum">    1417 </span>                :            :                 /*
<span class="lineNum">    1418 </span>                :            :                  * If this fs does not have fromsnap, and we're doing
<span class="lineNum">    1419 </span>                :            :                  * recursive, we need to send a full stream from the
<span class="lineNum">    1420 </span>                :            :                  * beginning (or an incremental from the origin if this
<span class="lineNum">    1421 </span>                :            :                  * is a clone).  If we're doing non-recursive, then let
<span class="lineNum">    1422 </span>                :            :                  * them get the error.
<span class="lineNum">    1423 </span>                :            :                  */
<span class="lineNum">    1424 </span>                :<span class="lineCov">        142 :                 (void) snprintf(zc.zc_name, sizeof (zc.zc_name), &quot;%s@%s&quot;,</span>
<span class="lineNum">    1425 </span>                :<span class="lineCov">        142 :                     zhp-&gt;zfs_name, sdd-&gt;fromsnap);</span>
<span class="lineNum">    1426 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 142 times"> + </span>]:<span class="lineCov">        142 :                 if (ioctl(zhp-&gt;zfs_hdl-&gt;libzfs_fd,</span>
<span class="lineNum">    1427 </span>                :            :                     ZFS_IOC_OBJSET_STATS, &amp;zc) != 0) {
<span class="lineNum">    1428 </span>                :<span class="lineNoCov">          0 :                         missingfrom = B_TRUE;</span>
<span class="lineNum">    1429 </span>                :            :                 }
<span class="lineNum">    1430 </span>                :            :         }
<span class="lineNum">    1431 </span>                :            : 
<span class="lineNum">    1432 </span>                :<span class="lineCov">        724 :         sdd-&gt;seenfrom = sdd-&gt;seento = sdd-&gt;prevsnap[0] = 0;</span>
<span class="lineNum">    1433 </span>                :<span class="lineCov">        724 :         sdd-&gt;prevsnap_obj = 0;</span>
<span class="lineNum">    1434 </span>[<span class="branchCov" title="Branch 0 was taken 189 times"> + </span><span class="branchCov" title="Branch 1 was taken 535 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 189 times"> + </span>]:<span class="lineCov">        724 :         if (sdd-&gt;fromsnap == NULL || missingfrom)</span>
<span class="lineNum">    1435 </span>                :<span class="lineCov">        535 :                 sdd-&gt;seenfrom = B_TRUE;</span>
<span class="lineNum">    1436 </span>                :            : 
<span class="lineNum">    1437 </span>                :<span class="lineCov">        724 :         rv = zfs_iter_snapshots_sorted(zhp, dump_snapshot, arg);</span>
<span class="lineNum">    1438 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 724 times"> + </span>]:<span class="lineCov">        724 :         if (!sdd-&gt;seenfrom) {</span>
<span class="lineNum">    1439 </span>                :<span class="lineNoCov">          0 :                 (void) fprintf(stderr, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1440 </span>                :            :                     &quot;WARNING: could not send %s@%s:\n&quot;
<span class="lineNum">    1441 </span>                :            :                     &quot;incremental source (%s@%s) does not exist\n&quot;),
<span class="lineNum">    1442 </span>                :            :                     zhp-&gt;zfs_name, sdd-&gt;tosnap,
<span class="lineNum">    1443 </span>                :            :                     zhp-&gt;zfs_name, sdd-&gt;fromsnap);
<span class="lineNum">    1444 </span>                :<span class="lineNoCov">          0 :                 sdd-&gt;err = B_TRUE;</span>
<span class="lineNum">    1445 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 723 times"> + </span>]:<span class="lineCov">        724 :         } else if (!sdd-&gt;seento) {</span>
<span class="lineNum">    1446 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :                 if (sdd-&gt;fromsnap) {</span>
<span class="lineNum">    1447 </span>                :<span class="lineCov">          1 :                         (void) fprintf(stderr, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1448 </span>                :            :                             &quot;WARNING: could not send %s@%s:\n&quot;
<span class="lineNum">    1449 </span>                :            :                             &quot;incremental source (%s@%s) &quot;
<span class="lineNum">    1450 </span>                :            :                             &quot;is not earlier than it\n&quot;),
<span class="lineNum">    1451 </span>                :            :                             zhp-&gt;zfs_name, sdd-&gt;tosnap,
<span class="lineNum">    1452 </span>                :            :                             zhp-&gt;zfs_name, sdd-&gt;fromsnap);
<span class="lineNum">    1453 </span>                :            :                 } else {
<span class="lineNum">    1454 </span>                :<span class="lineNoCov">          0 :                         (void) fprintf(stderr, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1455 </span>                :            :                             &quot;WARNING: &quot;
<span class="lineNum">    1456 </span>                :            :                             &quot;could not send %s@%s: does not exist\n&quot;),
<span class="lineNum">    1457 </span>                :            :                             zhp-&gt;zfs_name, sdd-&gt;tosnap);
<span class="lineNum">    1458 </span>                :            :                 }
<span class="lineNum">    1459 </span>                :<span class="lineCov">          1 :                 sdd-&gt;err = B_TRUE;</span>
<span class="lineNum">    1460 </span>                :            :         }
<span class="lineNum">    1461 </span>                :            : 
<span class="lineNum">    1462 </span>                :            :         return (rv);
<span class="lineNum">    1463 </span>                :            : }
<a name="1464"><span class="lineNum">    1464 </span>                :            : </a>
<span class="lineNum">    1465 </span>                :            : static int
<span class="lineNum">    1466 </span>                :<span class="lineCov">        322 : dump_filesystems(zfs_handle_t *rzhp, void *arg)</span>
<span class="lineNum">    1467 </span>                :            : {
<span class="lineNum">    1468 </span>                :<span class="lineCov">        322 :         send_dump_data_t *sdd = arg;</span>
<span class="lineNum">    1469 </span>                :            :         nvpair_t *fspair;
<span class="lineNum">    1470 </span>                :            :         boolean_t needagain, progress;
<span class="lineNum">    1471 </span>                :            : 
<span class="lineNum">    1472 </span>        [<span class="branchCov" title="Branch 0 was taken 215 times"> + </span><span class="branchCov" title="Branch 1 was taken 107 times"> + </span>]:<span class="lineCov">        322 :         if (!sdd-&gt;replicate)</span>
<span class="lineNum">    1473 </span>                :<span class="lineCov">        215 :                 return (dump_filesystem(rzhp, sdd));</span>
<span class="lineNum">    1474 </span>                :            : 
<span class="lineNum">    1475 </span>                :            :         /* Mark the clone origin snapshots. */
<span class="lineNum">    1476 </span>        [<span class="branchCov" title="Branch 1 was taken 515 times"> + </span><span class="branchCov" title="Branch 2 was taken 107 times"> + </span>]:<span class="lineCov">        622 :         for (fspair = nvlist_next_nvpair(sdd-&gt;fss, NULL); fspair;</span>
<span class="lineNum">    1477 </span>                :<span class="lineCov">        515 :             fspair = nvlist_next_nvpair(sdd-&gt;fss, fspair)) {</span>
<span class="lineNum">    1478 </span>                :            :                 nvlist_t *nvfs;
<span class="lineNum">    1479 </span>                :<span class="lineCov">        515 :                 uint64_t origin_guid = 0;</span>
<span class="lineNum">    1480 </span>                :            : 
<span class="lineNum">    1481 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 515 times"> + </span>]:<span class="lineCov">        515 :                 VERIFY(0 == nvpair_value_nvlist(fspair, &amp;nvfs));</span>
<span class="lineNum">    1482 </span>                :<span class="lineCov">        515 :                 (void) nvlist_lookup_uint64(nvfs, &quot;origin&quot;, &amp;origin_guid);</span>
<span class="lineNum">    1483 </span>        [<span class="branchCov" title="Branch 0 was taken 143 times"> + </span><span class="branchCov" title="Branch 1 was taken 372 times"> + </span>]:<span class="lineCov">        515 :                 if (origin_guid != 0) {</span>
<span class="lineNum">    1484 </span>                :            :                         char *snapname;
<span class="lineNum">    1485 </span>                :<span class="lineCov">        143 :                         nvlist_t *origin_nv = fsavl_find(sdd-&gt;fsavl,</span>
<span class="lineNum">    1486 </span>                :            :                             origin_guid, &amp;snapname);
<span class="lineNum">    1487 </span>        [<span class="branchCov" title="Branch 0 was taken 143 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        143 :                         if (origin_nv != NULL) {</span>
<span class="lineNum">    1488 </span>                :            :                                 nvlist_t *snapprops;
<span class="lineNum">    1489 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 143 times"> + </span>]:<span class="lineCov">        143 :                                 VERIFY(0 == nvlist_lookup_nvlist(origin_nv,</span>
<span class="lineNum">    1490 </span>                :            :                                     &quot;snapprops&quot;, &amp;snapprops));
<span class="lineNum">    1491 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 143 times"> + </span>]:<span class="lineCov">        143 :                                 VERIFY(0 == nvlist_lookup_nvlist(snapprops,</span>
<span class="lineNum">    1492 </span>                :            :                                     snapname, &amp;snapprops));
<span class="lineNum">    1493 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 143 times"> + </span>]:<span class="lineCov">        143 :                                 VERIFY(0 == nvlist_add_boolean(</span>
<span class="lineNum">    1494 </span>                :            :                                     snapprops, &quot;is_clone_origin&quot;));
<span class="lineNum">    1495 </span>                :            :                         }
<span class="lineNum">    1496 </span>                :            :                 }
<span class="lineNum">    1497 </span>                :            :         }
<span class="lineNum">    1498 </span>                :            : again:
<span class="lineNum">    1499 </span>                :<span class="lineCov">        153 :         needagain = progress = B_FALSE;</span>
<span class="lineNum">    1500 </span>        [<span class="branchCov" title="Branch 1 was taken 895 times"> + </span><span class="branchCov" title="Branch 2 was taken 152 times"> + </span>]:<span class="lineCov">       1047 :         for (fspair = nvlist_next_nvpair(sdd-&gt;fss, NULL); fspair;</span>
<span class="lineNum">    1501 </span>                :<span class="lineCov">        894 :             fspair = nvlist_next_nvpair(sdd-&gt;fss, fspair)) {</span>
<span class="lineNum">    1502 </span>                :            :                 nvlist_t *fslist, *parent_nv;
<span class="lineNum">    1503 </span>                :            :                 char *fsname;
<span class="lineNum">    1504 </span>                :            :                 zfs_handle_t *zhp;
<span class="lineNum">    1505 </span>                :            :                 int err;
<span class="lineNum">    1506 </span>                :<span class="lineCov">        895 :                 uint64_t origin_guid = 0;</span>
<span class="lineNum">    1507 </span>                :<span class="lineCov">        895 :                 uint64_t parent_guid = 0;</span>
<span class="lineNum">    1508 </span>                :            : 
<span class="lineNum">    1509 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 895 times"> + </span>]:<span class="lineCov">        895 :                 VERIFY(nvpair_value_nvlist(fspair, &amp;fslist) == 0);</span>
<span class="lineNum">    1510 </span>        [<span class="branchCov" title="Branch 1 was taken 310 times"> + </span><span class="branchCov" title="Branch 2 was taken 585 times"> + </span>]:<span class="lineCov">        895 :                 if (nvlist_lookup_boolean(fslist, &quot;sent&quot;) == 0)</span>
<span class="lineNum">    1511 </span>                :<span class="lineCov">        380 :                         continue;</span>
<span class="lineNum">    1512 </span>                :            : 
<span class="lineNum">    1513 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 585 times"> + </span>]:<span class="lineCov">        585 :                 VERIFY(nvlist_lookup_string(fslist, &quot;name&quot;, &amp;fsname) == 0);</span>
<span class="lineNum">    1514 </span>                :<span class="lineCov">        585 :                 (void) nvlist_lookup_uint64(fslist, &quot;origin&quot;, &amp;origin_guid);</span>
<span class="lineNum">    1515 </span>                :<span class="lineCov">        585 :                 (void) nvlist_lookup_uint64(fslist, &quot;parentfromsnap&quot;,</span>
<span class="lineNum">    1516 </span>                :            :                     &amp;parent_guid);
<span class="lineNum">    1517 </span>                :            : 
<span class="lineNum">    1518 </span>        [<span class="branchCov" title="Branch 0 was taken 478 times"> + </span><span class="branchCov" title="Branch 1 was taken 107 times"> + </span>]:<span class="lineCov">        585 :                 if (parent_guid != 0) {</span>
<span class="lineNum">    1519 </span>                :<span class="lineCov">        478 :                         parent_nv = fsavl_find(sdd-&gt;fsavl, parent_guid, NULL);</span>
<span class="lineNum">    1520 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 476 times"> + </span>]:<span class="lineCov">        478 :                         if (!nvlist_exists(parent_nv, &quot;sent&quot;)) {</span>
<span class="lineNum">    1521 </span>                :            :                                 /* parent has not been sent; skip this one */
<span class="lineNum">    1522 </span>                :<span class="lineCov">          2 :                                 needagain = B_TRUE;</span>
<span class="lineNum">    1523 </span>                :<span class="lineCov">          2 :                                 continue;</span>
<span class="lineNum">    1524 </span>                :            :                         }
<span class="lineNum">    1525 </span>                :            :                 }
<span class="lineNum">    1526 </span>                :            : 
<span class="lineNum">    1527 </span>        [<span class="branchCov" title="Branch 0 was taken 211 times"> + </span><span class="branchCov" title="Branch 1 was taken 372 times"> + </span>]:<span class="lineCov">        583 :                 if (origin_guid != 0) {</span>
<span class="lineNum">    1528 </span>                :<span class="lineCov">        211 :                         nvlist_t *origin_nv = fsavl_find(sdd-&gt;fsavl,</span>
<span class="lineNum">    1529 </span>                :            :                             origin_guid, NULL);
<span class="lineNum">    1530 </span>  [<span class="branchCov" title="Branch 0 was taken 211 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 68 times"> + </span><span class="branchCov" title="Branch 3 was taken 143 times"> + </span>]:<span class="lineCov">        422 :                         if (origin_nv != NULL &amp;&amp;</span>
<span class="lineNum">    1531 </span>                :<span class="lineCov">        211 :                             !nvlist_exists(origin_nv, &quot;sent&quot;)) {</span>
<span class="lineNum">    1532 </span>                :            :                                 /*
<span class="lineNum">    1533 </span>                :            :                                  * origin has not been sent yet;
<span class="lineNum">    1534 </span>                :            :                                  * skip this clone.
<span class="lineNum">    1535 </span>                :            :                                  */
<span class="lineNum">    1536 </span>                :<span class="lineCov">         68 :                                 needagain = B_TRUE;</span>
<span class="lineNum">    1537 </span>                :<span class="lineCov">         68 :                                 continue;</span>
<span class="lineNum">    1538 </span>                :            :                         }
<span class="lineNum">    1539 </span>                :            :                 }
<span class="lineNum">    1540 </span>                :            : 
<span class="lineNum">    1541 </span>                :<span class="lineCov">        515 :                 zhp = zfs_open(rzhp-&gt;zfs_hdl, fsname, ZFS_TYPE_DATASET);</span>
<span class="lineNum">    1542 </span>        [<span class="branchCov" title="Branch 0 was taken 515 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        515 :                 if (zhp == NULL)</span>
<span class="lineNum">    1543 </span>                :<span class="lineCov">          1 :                         return (-1);</span>
<span class="lineNum">    1544 </span>                :<span class="lineCov">        515 :                 err = dump_filesystem(zhp, sdd);</span>
<span class="lineNum">    1545 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 515 times"> + </span>]:<span class="lineCov">        515 :                 VERIFY(nvlist_add_boolean(fslist, &quot;sent&quot;) == 0);</span>
<span class="lineNum">    1546 </span>                :<span class="lineCov">        515 :                 progress = B_TRUE;</span>
<span class="lineNum">    1547 </span>                :<span class="lineCov">        515 :                 zfs_close(zhp);</span>
<span class="lineNum">    1548 </span>        [<span class="branchCov" title="Branch 0 was taken 514 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">        515 :                 if (err)</span>
<span class="lineNum">    1549 </span>                :            :                         return (err);
<span class="lineNum">    1550 </span>                :            :         }
<span class="lineNum">    1551 </span>        [<span class="branchCov" title="Branch 0 was taken 46 times"> + </span><span class="branchCov" title="Branch 1 was taken 106 times"> + </span>]:<span class="lineCov">        152 :         if (needagain) {</span>
<span class="lineNum">    1552 </span>        [<span class="branchCov" title="Branch 0 was taken 46 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         46 :                 assert(progress);</span>
<span class="lineNum">    1553 </span>                :            :                 goto again;
<span class="lineNum">    1554 </span>                :            :         }
<span class="lineNum">    1555 </span>                :            : 
<span class="lineNum">    1556 </span>                :            :         /* clean out the sent flags in case we reuse this fss */
<span class="lineNum">    1557 </span>        [<span class="branchCov" title="Branch 1 was taken 514 times"> + </span><span class="branchCov" title="Branch 2 was taken 106 times"> + </span>]:<span class="lineCov">        620 :         for (fspair = nvlist_next_nvpair(sdd-&gt;fss, NULL); fspair;</span>
<span class="lineNum">    1558 </span>                :<span class="lineCov">        514 :             fspair = nvlist_next_nvpair(sdd-&gt;fss, fspair)) {</span>
<span class="lineNum">    1559 </span>                :            :                 nvlist_t *fslist;
<span class="lineNum">    1560 </span>                :            : 
<span class="lineNum">    1561 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 514 times"> + </span>]:<span class="lineCov">        514 :                 VERIFY(nvpair_value_nvlist(fspair, &amp;fslist) == 0);</span>
<span class="lineNum">    1562 </span>                :<span class="lineCov">        514 :                 (void) nvlist_remove_all(fslist, &quot;sent&quot;);</span>
<span class="lineNum">    1563 </span>                :            :         }
<span class="lineNum">    1564 </span>                :            : 
<span class="lineNum">    1565 </span>                :            :         return (0);
<span class="lineNum">    1566 </span>                :            : }
<a name="1567"><span class="lineNum">    1567 </span>                :            : </a>
<span class="lineNum">    1568 </span>                :            : nvlist_t *
<span class="lineNum">    1569 </span>                :<span class="lineCov">         14 : zfs_send_resume_token_to_nvlist(libzfs_handle_t *hdl, const char *token)</span>
<span class="lineNum">    1570 </span>                :            : {
<span class="lineNum">    1571 </span>                :            :         unsigned int version;
<span class="lineNum">    1572 </span>                :            :         int nread, i;
<span class="lineNum">    1573 </span>                :            :         unsigned long long checksum, packed_len;
<span class="lineNum">    1574 </span>                :            : 
<span class="lineNum">    1575 </span>                :            :         /*
<span class="lineNum">    1576 </span>                :            :          * Decode token header, which is:
<span class="lineNum">    1577 </span>                :            :          *   &lt;token version&gt;-&lt;checksum of payload&gt;-&lt;uncompressed payload length&gt;
<span class="lineNum">    1578 </span>                :            :          * Note that the only supported token version is 1.
<span class="lineNum">    1579 </span>                :            :          */
<span class="lineNum">    1580 </span>                :<span class="lineCov">         14 :         nread = sscanf(token, &quot;%u-%llx-%llx-&quot;,</span>
<span class="lineNum">    1581 </span>                :            :             &amp;version, &amp;checksum, &amp;packed_len);
<span class="lineNum">    1582 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>]:<span class="lineCov">         14 :         if (nread != 3) {</span>
<span class="lineNum">    1583 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1584 </span>                :            :                     &quot;resume token is corrupt (invalid format)&quot;));
<span class="lineNum">    1585 </span>                :<span class="lineNoCov">          0 :                 return (NULL);</span>
<span class="lineNum">    1586 </span>                :            :         }
<span class="lineNum">    1587 </span>                :            : 
<span class="lineNum">    1588 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>]:<span class="lineCov">         14 :         if (version != ZFS_SEND_RESUME_TOKEN_VERSION) {</span>
<span class="lineNum">    1589 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1590 </span>                :            :                     &quot;resume token is corrupt (invalid version %u)&quot;),
<span class="lineNum">    1591 </span>                :            :                     version);
<span class="lineNum">    1592 </span>                :<span class="lineNoCov">          0 :                 return (NULL);</span>
<span class="lineNum">    1593 </span>                :            :         }
<span class="lineNum">    1594 </span>                :            : 
<span class="lineNum">    1595 </span>                :            :         /* convert hexadecimal representation to binary */
<span class="lineNum">    1596 </span>                :<span class="lineCov">         14 :         token = strrchr(token, '-') + 1;</span>
<span class="lineNum">    1597 </span>                :<span class="lineCov">         14 :         int len = strlen(token) / 2;</span>
<span class="lineNum">    1598 </span>                :<span class="lineCov">         14 :         unsigned char *compressed = zfs_alloc(hdl, len);</span>
<span class="lineNum">    1599 </span>        [<span class="branchCov" title="Branch 1 was taken 1713 times"> + </span><span class="branchCov" title="Branch 2 was taken 14 times"> + </span>]:<span class="lineCov">       1727 :         for (i = 0; i &lt; len; i++) {</span>
<span class="lineNum">    1600 </span>                :<span class="lineCov">       1713 :                 nread = sscanf(token + i * 2, &quot;%2hhx&quot;, compressed + i);</span>
<span class="lineNum">    1601 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1713 times"> + </span>]:<span class="lineCov">       1713 :                 if (nread != 1) {</span>
<span class="lineNum">    1602 </span>                :<span class="lineNoCov">          0 :                         free(compressed);</span>
<span class="lineNum">    1603 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1604 </span>                :            :                             &quot;resume token is corrupt &quot;
<span class="lineNum">    1605 </span>                :            :                             &quot;(payload is not hex-encoded)&quot;));
<span class="lineNum">    1606 </span>                :<span class="lineNoCov">          0 :                         return (NULL);</span>
<span class="lineNum">    1607 </span>                :            :                 }
<span class="lineNum">    1608 </span>                :            :         }
<span class="lineNum">    1609 </span>                :            : 
<span class="lineNum">    1610 </span>                :            :         /* verify checksum */
<span class="lineNum">    1611 </span>                :            :         zio_cksum_t cksum;
<span class="lineNum">    1612 </span>                :<span class="lineCov">         14 :         fletcher_4_native_varsize(compressed, len, &amp;cksum);</span>
<span class="lineNum">    1613 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>]:<span class="lineCov">         14 :         if (cksum.zc_word[0] != checksum) {</span>
<span class="lineNum">    1614 </span>                :<span class="lineNoCov">          0 :                 free(compressed);</span>
<span class="lineNum">    1615 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1616 </span>                :            :                     &quot;resume token is corrupt (incorrect checksum)&quot;));
<span class="lineNum">    1617 </span>                :<span class="lineNoCov">          0 :                 return (NULL);</span>
<span class="lineNum">    1618 </span>                :            :         }
<span class="lineNum">    1619 </span>                :            : 
<span class="lineNum">    1620 </span>                :            :         /* uncompress */
<span class="lineNum">    1621 </span>                :<span class="lineCov">         14 :         void *packed = zfs_alloc(hdl, packed_len);</span>
<span class="lineNum">    1622 </span>                :<span class="lineCov">         14 :         uLongf packed_len_long = packed_len;</span>
<span class="lineNum">    1623 </span>[<span class="branchCov" title="Branch 1 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 14 times"> + </span>]:<span class="lineCov">         14 :         if (uncompress(packed, &amp;packed_len_long, compressed, len) != Z_OK ||</span>
<span class="lineNum">    1624 </span>                :<span class="lineCov">         14 :             packed_len_long != packed_len) {</span>
<span class="lineNum">    1625 </span>                :<span class="lineNoCov">          0 :                 free(packed);</span>
<span class="lineNum">    1626 </span>                :<span class="lineNoCov">          0 :                 free(compressed);</span>
<span class="lineNum">    1627 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1628 </span>                :            :                     &quot;resume token is corrupt (decompression failed)&quot;));
<span class="lineNum">    1629 </span>                :<span class="lineNoCov">          0 :                 return (NULL);</span>
<span class="lineNum">    1630 </span>                :            :         }
<span class="lineNum">    1631 </span>                :            : 
<span class="lineNum">    1632 </span>                :            :         /* unpack nvlist */
<span class="lineNum">    1633 </span>                :            :         nvlist_t *nv;
<span class="lineNum">    1634 </span>                :<span class="lineCov">         14 :         int error = nvlist_unpack(packed, packed_len, &amp;nv, KM_SLEEP);</span>
<span class="lineNum">    1635 </span>                :<span class="lineCov">         14 :         free(packed);</span>
<span class="lineNum">    1636 </span>                :<span class="lineCov">         14 :         free(compressed);</span>
<span class="lineNum">    1637 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>]:<span class="lineCov">         14 :         if (error != 0) {</span>
<span class="lineNum">    1638 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1639 </span>                :            :                     &quot;resume token is corrupt (nvlist_unpack failed)&quot;));
<span class="lineNum">    1640 </span>                :<span class="lineNoCov">          0 :                 return (NULL);</span>
<span class="lineNum">    1641 </span>                :            :         }
<span class="lineNum">    1642 </span>                :<span class="lineCov">         14 :         return (nv);</span>
<span class="lineNum">    1643 </span>                :            : }
<a name="1644"><span class="lineNum">    1644 </span>                :            : </a>
<span class="lineNum">    1645 </span>                :            : int
<span class="lineNum">    1646 </span>                :<span class="lineCov">         14 : zfs_send_resume(libzfs_handle_t *hdl, sendflags_t *flags, int outfd,</span>
<span class="lineNum">    1647 </span>                :            :     const char *resume_token)
<span class="lineNum">    1648 </span>                :            : {
<span class="lineNum">    1649 </span>                :            :         char errbuf[1024];
<span class="lineNum">    1650 </span>                :            :         char *toname;
<span class="lineNum">    1651 </span>                :<span class="lineCov">         14 :         char *fromname = NULL;</span>
<span class="lineNum">    1652 </span>                :            :         uint64_t resumeobj, resumeoff, toguid, fromguid, bytes;
<span class="lineNum">    1653 </span>                :            :         zfs_handle_t *zhp;
<span class="lineNum">    1654 </span>                :<span class="lineCov">         14 :         int error = 0;</span>
<span class="lineNum">    1655 </span>                :            :         char name[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    1656 </span>                :<span class="lineCov">         14 :         enum lzc_send_flags lzc_flags = 0;</span>
<span class="lineNum">    1657 </span>                :            : 
<span class="lineNum">    1658 </span>                :<span class="lineCov">         28 :         (void) snprintf(errbuf, sizeof (errbuf), dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1659 </span>                :            :             &quot;cannot resume send&quot;));
<span class="lineNum">    1660 </span>                :            : 
<span class="lineNum">    1661 </span>                :<span class="lineCov">         14 :         nvlist_t *resume_nvl =</span>
<span class="lineNum">    1662 </span>                :            :             zfs_send_resume_token_to_nvlist(hdl, resume_token);
<span class="lineNum">    1663 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>]:<span class="lineCov">         14 :         if (resume_nvl == NULL) {</span>
<span class="lineNum">    1664 </span>                :            :                 /*
<span class="lineNum">    1665 </span>                :            :                  * zfs_error_aux has already been set by
<span class="lineNum">    1666 </span>                :            :                  * zfs_send_resume_token_to_nvlist
<span class="lineNum">    1667 </span>                :            :                  */
<span class="lineNum">    1668 </span>                :<span class="lineNoCov">          0 :                 return (zfs_error(hdl, EZFS_FAULT, errbuf));</span>
<span class="lineNum">    1669 </span>                :            :         }
<span class="lineNum">    1670 </span>        [<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         14 :         if (flags-&gt;verbose) {</span>
<span class="lineNum">    1671 </span>                :<span class="lineCov">         28 :                 (void) fprintf(stderr, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1672 </span>                :            :                     &quot;resume token contents:\n&quot;));
<span class="lineNum">    1673 </span>                :<span class="lineCov">         14 :                 nvlist_print(stderr, resume_nvl);</span>
<span class="lineNum">    1674 </span>                :            :         }
<span class="lineNum">    1675 </span>                :            : 
<span class="lineNum">    1676 </span>  [<span class="branchCov" title="Branch 1 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         28 :         if (nvlist_lookup_string(resume_nvl, &quot;toname&quot;, &amp;toname) != 0 ||</span>
<span class="lineNum">    1677 </span>        [<span class="branchCov" title="Branch 1 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         28 :             nvlist_lookup_uint64(resume_nvl, &quot;object&quot;, &amp;resumeobj) != 0 ||</span>
<span class="lineNum">    1678 </span>        [<span class="branchCov" title="Branch 1 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         28 :             nvlist_lookup_uint64(resume_nvl, &quot;offset&quot;, &amp;resumeoff) != 0 ||</span>
<span class="lineNum">    1679 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 14 times"> + </span>]:<span class="lineCov">         28 :             nvlist_lookup_uint64(resume_nvl, &quot;bytes&quot;, &amp;bytes) != 0 ||</span>
<span class="lineNum">    1680 </span>                :<span class="lineCov">         14 :             nvlist_lookup_uint64(resume_nvl, &quot;toguid&quot;, &amp;toguid) != 0) {</span>
<span class="lineNum">    1681 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1682 </span>                :            :                     &quot;resume token is corrupt&quot;));
<span class="lineNum">    1683 </span>                :<span class="lineNoCov">          0 :                 return (zfs_error(hdl, EZFS_FAULT, errbuf));</span>
<span class="lineNum">    1684 </span>                :            :         }
<span class="lineNum">    1685 </span>                :<span class="lineCov">         14 :         fromguid = 0;</span>
<span class="lineNum">    1686 </span>                :<span class="lineCov">         14 :         (void) nvlist_lookup_uint64(resume_nvl, &quot;fromguid&quot;, &amp;fromguid);</span>
<span class="lineNum">    1687 </span>                :            : 
<span class="lineNum">    1688 </span>[<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 14 times"> + </span>]:<span class="lineCov">         14 :         if (flags-&gt;largeblock || nvlist_exists(resume_nvl, &quot;largeblockok&quot;))</span>
<span class="lineNum">    1689 </span>                :            :                 lzc_flags |= LZC_SEND_FLAG_LARGE_BLOCK;
<span class="lineNum">    1690 </span>[<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 14 times"> + </span>]:<span class="lineCov">         14 :         if (flags-&gt;embed_data || nvlist_exists(resume_nvl, &quot;embedok&quot;))</span>
<span class="lineNum">    1691 </span>                :<span class="lineNoCov">          0 :                 lzc_flags |= LZC_SEND_FLAG_EMBED_DATA;</span>
<span class="lineNum">    1692 </span>[<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 3 was taken 4 times"> + </span><span class="branchCov" title="Branch 4 was taken 10 times"> + </span>]:<span class="lineCov">         14 :         if (flags-&gt;compress || nvlist_exists(resume_nvl, &quot;compressok&quot;))</span>
<span class="lineNum">    1693 </span>                :<span class="lineCov">          4 :                 lzc_flags |= LZC_SEND_FLAG_COMPRESS;</span>
<span class="lineNum">    1694 </span>[<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 14 times"> + </span>]:<span class="lineCov">         14 :         if (flags-&gt;raw || nvlist_exists(resume_nvl, &quot;rawok&quot;))</span>
<span class="lineNum">    1695 </span>                :<span class="lineNoCov">          0 :                 lzc_flags |= LZC_SEND_FLAG_RAW;</span>
<span class="lineNum">    1696 </span>                :            : 
<span class="lineNum">    1697 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 14 times"> + </span>]:<span class="lineCov">         14 :         if (guid_to_name(hdl, toname, toguid, B_FALSE, name) != 0) {</span>
<span class="lineNum">    1698 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (zfs_dataset_exists(hdl, toname, ZFS_TYPE_DATASET)) {</span>
<span class="lineNum">    1699 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1700 </span>                :            :                             &quot;'%s' is no longer the same snapshot used in &quot;
<span class="lineNum">    1701 </span>                :            :                             &quot;the initial send&quot;), toname);
<span class="lineNum">    1702 </span>                :            :                 } else {
<span class="lineNum">    1703 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1704 </span>                :            :                             &quot;'%s' used in the initial send no longer exists&quot;),
<span class="lineNum">    1705 </span>                :            :                             toname);
<span class="lineNum">    1706 </span>                :            :                 }
<span class="lineNum">    1707 </span>                :<span class="lineNoCov">          0 :                 return (zfs_error(hdl, EZFS_BADPATH, errbuf));</span>
<span class="lineNum">    1708 </span>                :            :         }
<span class="lineNum">    1709 </span>                :<span class="lineCov">         14 :         zhp = zfs_open(hdl, name, ZFS_TYPE_DATASET);</span>
<span class="lineNum">    1710 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>]:<span class="lineCov">         14 :         if (zhp == NULL) {</span>
<span class="lineNum">    1711 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1712 </span>                :            :                     &quot;unable to access '%s'&quot;), name);
<span class="lineNum">    1713 </span>                :<span class="lineNoCov">          0 :                 return (zfs_error(hdl, EZFS_BADPATH, errbuf));</span>
<span class="lineNum">    1714 </span>                :            :         }
<span class="lineNum">    1715 </span>                :            : 
<span class="lineNum">    1716 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">         14 :         if (fromguid != 0) {</span>
<span class="lineNum">    1717 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 8 times"> + </span>]:<span class="lineCov">          8 :                 if (guid_to_name(hdl, toname, fromguid, B_TRUE, name) != 0) {</span>
<span class="lineNum">    1718 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1719 </span>                :            :                             &quot;incremental source %#llx no longer exists&quot;),
<span class="lineNum">    1720 </span>                :            :                             (longlong_t)fromguid);
<span class="lineNum">    1721 </span>                :<span class="lineNoCov">          0 :                         return (zfs_error(hdl, EZFS_BADPATH, errbuf));</span>
<span class="lineNum">    1722 </span>                :            :                 }
<span class="lineNum">    1723 </span>                :            :                 fromname = name;
<span class="lineNum">    1724 </span>                :            :         }
<span class="lineNum">    1725 </span>                :            : 
<span class="lineNum">    1726 </span>        [<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         14 :         if (flags-&gt;verbose) {</span>
<span class="lineNum">    1727 </span>                :<span class="lineCov">         14 :                 uint64_t size = 0;</span>
<span class="lineNum">    1728 </span>                :<span class="lineCov">         14 :                 error = lzc_send_space(zhp-&gt;zfs_name, fromname,</span>
<span class="lineNum">    1729 </span>                :            :                     lzc_flags, &amp;size);
<span class="lineNum">    1730 </span>        [<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         14 :                 if (error == 0)</span>
<span class="lineNum">    1731 </span>                :<span class="lineCov">         14 :                         size = MAX(0, (int64_t)(size - bytes));</span>
<span class="lineNum">    1732 </span>                :<span class="lineCov">         14 :                 send_print_verbose(stderr, zhp-&gt;zfs_name, fromname,</span>
<span class="lineNum">    1733 </span>                :            :                     size, flags-&gt;parsable);
<span class="lineNum">    1734 </span>                :            :         }
<span class="lineNum">    1735 </span>                :            : 
<span class="lineNum">    1736 </span>        [<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         14 :         if (!flags-&gt;dryrun) {</span>
<span class="lineNum">    1737 </span>                :<span class="lineCov">         14 :                 progress_arg_t pa = { 0 };</span>
<span class="lineNum">    1738 </span>                :            :                 pthread_t tid;
<span class="lineNum">    1739 </span>                :            :                 /*
<span class="lineNum">    1740 </span>                :            :                  * If progress reporting is requested, spawn a new thread to
<span class="lineNum">    1741 </span>                :            :                  * poll ZFS_IOC_SEND_PROGRESS at a regular interval.
<span class="lineNum">    1742 </span>                :            :                  */
<span class="lineNum">    1743 </span>        [<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         14 :                 if (flags-&gt;progress) {</span>
<span class="lineNum">    1744 </span>                :<span class="lineCov">         14 :                         pa.pa_zhp = zhp;</span>
<span class="lineNum">    1745 </span>                :<span class="lineCov">         14 :                         pa.pa_fd = outfd;</span>
<span class="lineNum">    1746 </span>                :<span class="lineCov">         14 :                         pa.pa_parsable = flags-&gt;parsable;</span>
<span class="lineNum">    1747 </span>                :            : 
<span class="lineNum">    1748 </span>                :<span class="lineCov">         14 :                         error = pthread_create(&amp;tid, NULL,</span>
<span class="lineNum">    1749 </span>                :            :                             send_progress_thread, &amp;pa);
<span class="lineNum">    1750 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>]:<span class="lineCov">         14 :                         if (error != 0) {</span>
<span class="lineNum">    1751 </span>                :<span class="lineNoCov">          0 :                                 zfs_close(zhp);</span>
<span class="lineNum">    1752 </span>                :<span class="lineNoCov">          0 :                                 return (error);</span>
<span class="lineNum">    1753 </span>                :            :                         }
<span class="lineNum">    1754 </span>                :            :                 }
<span class="lineNum">    1755 </span>                :            : 
<span class="lineNum">    1756 </span>                :<span class="lineCov">         14 :                 error = lzc_send_resume(zhp-&gt;zfs_name, fromname, outfd,</span>
<span class="lineNum">    1757 </span>                :            :                     lzc_flags, resumeobj, resumeoff);
<span class="lineNum">    1758 </span>                :            : 
<span class="lineNum">    1759 </span>        [<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         14 :                 if (flags-&gt;progress) {</span>
<span class="lineNum">    1760 </span>                :<span class="lineCov">         14 :                         (void) pthread_cancel(tid);</span>
<span class="lineNum">    1761 </span>                :<span class="lineCov">         14 :                         (void) pthread_join(tid, NULL);</span>
<span class="lineNum">    1762 </span>                :            :                 }
<span class="lineNum">    1763 </span>                :            : 
<span class="lineNum">    1764 </span>                :            :                 char errbuf[1024];
<span class="lineNum">    1765 </span>                :<span class="lineCov">         28 :                 (void) snprintf(errbuf, sizeof (errbuf), dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1766 </span>                :            :                     &quot;warning: cannot send '%s'&quot;), zhp-&gt;zfs_name);
<span class="lineNum">    1767 </span>                :            : 
<span class="lineNum">    1768 </span>                :<span class="lineCov">         14 :                 zfs_close(zhp);</span>
<span class="lineNum">    1769 </span>                :            : 
<span class="lineNum">    1770 </span>  [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 14 times"> + </span>]:<span class="lineCov">         14 :                 switch (error) {</span>
<span class="lineNum">    1771 </span>                :            :                 case 0:
<span class="lineNum">    1772 </span>                :            :                         return (0);
<span class="lineNum">    1773 </span>                :            :                 case EACCES:
<span class="lineNum">    1774 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1775 </span>                :            :                             &quot;source key must be loaded&quot;));
<span class="lineNum">    1776 </span>                :<span class="lineNoCov">          0 :                         return (zfs_error(hdl, EZFS_CRYPTOFAILED, errbuf));</span>
<span class="lineNum">    1777 </span>                :            : 
<span class="lineNum">    1778 </span>                :            :                 case EXDEV:
<span class="lineNum">    1779 </span>                :            :                 case ENOENT:
<span class="lineNum">    1780 </span>                :            :                 case EDQUOT:
<span class="lineNum">    1781 </span>                :            :                 case EFBIG:
<span class="lineNum">    1782 </span>                :            :                 case EIO:
<span class="lineNum">    1783 </span>                :            :                 case ENOLINK:
<span class="lineNum">    1784 </span>                :            :                 case ENOSPC:
<span class="lineNum">    1785 </span>                :            :                 case ENOSTR:
<span class="lineNum">    1786 </span>                :            :                 case ENXIO:
<span class="lineNum">    1787 </span>                :            :                 case EPIPE:
<span class="lineNum">    1788 </span>                :            :                 case ERANGE:
<span class="lineNum">    1789 </span>                :            :                 case EFAULT:
<span class="lineNum">    1790 </span>                :            :                 case EROFS:
<span class="lineNum">    1791 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, strerror(errno));</span>
<span class="lineNum">    1792 </span>                :<span class="lineNoCov">          0 :                         return (zfs_error(hdl, EZFS_BADBACKUP, errbuf));</span>
<span class="lineNum">    1793 </span>                :            : 
<span class="lineNum">    1794 </span>                :            :                 default:
<span class="lineNum">    1795 </span>                :<span class="lineCov">         14 :                         return (zfs_standard_error(hdl, errno, errbuf));</span>
<span class="lineNum">    1796 </span>                :            :                 }
<span class="lineNum">    1797 </span>                :            :         }
<span class="lineNum">    1798 </span>                :            : 
<span class="lineNum">    1799 </span>                :            : 
<span class="lineNum">    1800 </span>                :<span class="lineNoCov">          0 :         zfs_close(zhp);</span>
<span class="lineNum">    1801 </span>                :            : 
<span class="lineNum">    1802 </span>                :<span class="lineNoCov">          0 :         return (error);</span>
<span class="lineNum">    1803 </span>                :            : }
<span class="lineNum">    1804 </span>                :            : 
<span class="lineNum">    1805 </span>                :            : /*
<span class="lineNum">    1806 </span>                :            :  * Generate a send stream for the dataset identified by the argument zhp.
<span class="lineNum">    1807 </span>                :            :  *
<span class="lineNum">    1808 </span>                :            :  * The content of the send stream is the snapshot identified by
<span class="lineNum">    1809 </span>                :            :  * 'tosnap'.  Incremental streams are requested in two ways:
<span class="lineNum">    1810 </span>                :            :  *     - from the snapshot identified by &quot;fromsnap&quot; (if non-null) or
<span class="lineNum">    1811 </span>                :            :  *     - from the origin of the dataset identified by zhp, which must
<span class="lineNum">    1812 </span>                :            :  *       be a clone.  In this case, &quot;fromsnap&quot; is null and &quot;fromorigin&quot;
<span class="lineNum">    1813 </span>                :            :  *       is TRUE.
<span class="lineNum">    1814 </span>                :            :  *
<span class="lineNum">    1815 </span>                :            :  * The send stream is recursive (i.e. dumps a hierarchy of snapshots) and
<span class="lineNum">    1816 </span>                :            :  * uses a special header (with a hdrtype field of DMU_COMPOUNDSTREAM)
<span class="lineNum">    1817 </span>                :            :  * if &quot;replicate&quot; is set.  If &quot;doall&quot; is set, dump all the intermediate
<span class="lineNum">    1818 </span>                :            :  * snapshots. The DMU_COMPOUNDSTREAM header is used in the &quot;doall&quot;
<span class="lineNum">    1819 </span>                :            :  * case too. If &quot;props&quot; is set, send properties.
<a name="1820"><span class="lineNum">    1820 </span>                :            :  */</a>
<span class="lineNum">    1821 </span>                :            : int
<span class="lineNum">    1822 </span>                :<span class="lineCov">        252 : zfs_send(zfs_handle_t *zhp, const char *fromsnap, const char *tosnap,</span>
<span class="lineNum">    1823 </span>                :            :     sendflags_t *flags, int outfd, snapfilter_cb_t filter_func,
<span class="lineNum">    1824 </span>                :            :     void *cb_arg, nvlist_t **debugnvp)
<span class="lineNum">    1825 </span>                :            : {
<span class="lineNum">    1826 </span>                :            :         char errbuf[1024];
<span class="lineNum">    1827 </span>                :<span class="lineCov">        252 :         send_dump_data_t sdd = { 0 };</span>
<span class="lineNum">    1828 </span>                :<span class="lineCov">        252 :         int err = 0;</span>
<span class="lineNum">    1829 </span>                :<span class="lineCov">        252 :         nvlist_t *fss = NULL;</span>
<span class="lineNum">    1830 </span>                :<span class="lineCov">        252 :         avl_tree_t *fsavl = NULL;</span>
<span class="lineNum">    1831 </span>                :            :         static uint64_t holdseq;
<span class="lineNum">    1832 </span>                :            :         int spa_version;
<span class="lineNum">    1833 </span>                :<span class="lineCov">        252 :         pthread_t tid = 0;</span>
<span class="lineNum">    1834 </span>                :            :         int pipefd[2];
<span class="lineNum">    1835 </span>                :<span class="lineCov">        252 :         dedup_arg_t dda = { 0 };</span>
<span class="lineNum">    1836 </span>                :<span class="lineCov">        252 :         int featureflags = 0;</span>
<span class="lineNum">    1837 </span>                :            :         FILE *fout;
<span class="lineNum">    1838 </span>                :            : 
<span class="lineNum">    1839 </span>                :<span class="lineCov">        504 :         (void) snprintf(errbuf, sizeof (errbuf), dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1840 </span>                :<span class="lineCov">        252 :             &quot;cannot send '%s'&quot;), zhp-&gt;zfs_name);</span>
<span class="lineNum">    1841 </span>                :            : 
<span class="lineNum">    1842 </span>[<span class="branchCov" title="Branch 0 was taken 56 times"> + </span><span class="branchCov" title="Branch 1 was taken 196 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 56 times"> + </span>]:<span class="lineCov">        252 :         if (fromsnap &amp;&amp; fromsnap[0] == '\0') {</span>
<span class="lineNum">    1843 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(zhp-&gt;zfs_hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1844 </span>                :            :                     &quot;zero-length incremental source&quot;));
<span class="lineNum">    1845 </span>                :<span class="lineNoCov">          0 :                 return (zfs_error(zhp-&gt;zfs_hdl, EZFS_NOENT, errbuf));</span>
<span class="lineNum">    1846 </span>                :            :         }
<span class="lineNum">    1847 </span>                :            : 
<span class="lineNum">    1848 </span>        [<span class="branchCov" title="Branch 0 was taken 243 times"> + </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>]:<span class="lineCov">        252 :         if (zhp-&gt;zfs_type == ZFS_TYPE_FILESYSTEM) {</span>
<span class="lineNum">    1849 </span>                :            :                 uint64_t version;
<span class="lineNum">    1850 </span>                :<span class="lineCov">        243 :                 version = zfs_prop_get_int(zhp, ZFS_PROP_VERSION);</span>
<span class="lineNum">    1851 </span>        [<span class="branchCov" title="Branch 0 was taken 241 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">        243 :                 if (version &gt;= ZPL_VERSION_SA) {</span>
<span class="lineNum">    1852 </span>                :<span class="lineCov">        241 :                         featureflags |= DMU_BACKUP_FEATURE_SA_SPILL;</span>
<span class="lineNum">    1853 </span>                :            :                 }
<span class="lineNum">    1854 </span>                :            :         }
<span class="lineNum">    1855 </span>                :            : 
<span class="lineNum">    1856 </span>                :            :         /*
<span class="lineNum">    1857 </span>                :            :          * Start the dedup thread if this is a dedup stream. We do not bother
<span class="lineNum">    1858 </span>                :            :          * doing this if this a raw send of an encrypted dataset with dedup off
<span class="lineNum">    1859 </span>                :            :          * because normal encrypted blocks won't dedup.
<span class="lineNum">    1860 </span>                :            :          */
<span class="lineNum">    1861 </span>[<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 248 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">        252 :         if (flags-&gt;dedup &amp;&amp; !flags-&gt;dryrun &amp;&amp; !(flags-&gt;raw &amp;&amp;</span>
<span class="lineNum">         </span>  [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 4 times"> + </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span> 
<span class="lineNum">         </span>         <span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">    1862 </span>                :<span class="lineNoCov">          0 :             zfs_prop_get_int(zhp, ZFS_PROP_ENCRYPTION) != ZIO_CRYPT_OFF &amp;&amp;</span>
<span class="lineNum">    1863 </span>                :<span class="lineNoCov">          0 :             zfs_prop_get_int(zhp, ZFS_PROP_DEDUP) == ZIO_CHECKSUM_OFF)) {</span>
<span class="lineNum">    1864 </span>                :<span class="lineCov">          4 :                 featureflags |= (DMU_BACKUP_FEATURE_DEDUP |</span>
<span class="lineNum">    1865 </span>                :            :                     DMU_BACKUP_FEATURE_DEDUPPROPS);
<span class="lineNum">    1866 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">          4 :                 if ((err = socketpair(AF_UNIX, SOCK_STREAM, 0, pipefd)) != 0) {</span>
<span class="lineNum">    1867 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(zhp-&gt;zfs_hdl, strerror(errno));</span>
<span class="lineNum">    1868 </span>                :<span class="lineNoCov">          0 :                         return (zfs_error(zhp-&gt;zfs_hdl, EZFS_PIPEFAILED,</span>
<span class="lineNum">    1869 </span>                :            :                             errbuf));
<span class="lineNum">    1870 </span>                :            :                 }
<span class="lineNum">    1871 </span>                :<span class="lineCov">          4 :                 dda.outputfd = outfd;</span>
<span class="lineNum">    1872 </span>                :<span class="lineCov">          4 :                 dda.inputfd = pipefd[1];</span>
<span class="lineNum">    1873 </span>                :<span class="lineCov">          4 :                 dda.dedup_hdl = zhp-&gt;zfs_hdl;</span>
<span class="lineNum">    1874 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">          4 :                 if ((err = pthread_create(&amp;tid, NULL, cksummer, &amp;dda)) != 0) {</span>
<span class="lineNum">    1875 </span>                :<span class="lineNoCov">          0 :                         (void) close(pipefd[0]);</span>
<span class="lineNum">    1876 </span>                :<span class="lineNoCov">          0 :                         (void) close(pipefd[1]);</span>
<span class="lineNum">    1877 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(zhp-&gt;zfs_hdl, strerror(errno));</span>
<span class="lineNum">    1878 </span>                :<span class="lineNoCov">          0 :                         return (zfs_error(zhp-&gt;zfs_hdl,</span>
<span class="lineNum">    1879 </span>                :            :                             EZFS_THREADCREATEFAILED, errbuf));
<span class="lineNum">    1880 </span>                :            :                 }
<span class="lineNum">    1881 </span>                :            :         }
<span class="lineNum">    1882 </span>                :            : 
<span class="lineNum">    1883 </span>[<span class="branchCov" title="Branch 0 was taken 195 times"> + </span><span class="branchCov" title="Branch 1 was taken 57 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 188 times"> + </span><span class="branchCov" title="Branch 3 was taken 7 times"> + </span>]:<span class="lineCov">        252 :         if (flags-&gt;replicate || flags-&gt;doall || flags-&gt;props) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 25 times"> + </span><span class="branchCov" title="Branch 5 was taken 163 times"> + </span>]
<span class="lineNum">    1884 </span>                :<span class="lineCov">         89 :                 dmu_replay_record_t drr = { 0 };</span>
<span class="lineNum">    1885 </span>                :<span class="lineCov">         89 :                 char *packbuf = NULL;</span>
<span class="lineNum">    1886 </span>                :<span class="lineCov">         89 :                 size_t buflen = 0;</span>
<span class="lineNum">    1887 </span>                :            :                 zio_cksum_t zc;
<span class="lineNum">    1888 </span>                :            : 
<span class="lineNum">    1889 </span>                :<span class="lineCov">         89 :                 ZIO_SET_CHECKSUM(&amp;zc, 0, 0, 0, 0);</span>
<span class="lineNum">    1890 </span>                :            : 
<span class="lineNum">    1891 </span>[<span class="branchCov" title="Branch 0 was taken 32 times"> + </span><span class="branchCov" title="Branch 1 was taken 57 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 26 times"> + </span><span class="branchCov" title="Branch 3 was taken 6 times"> + </span>]:<span class="lineCov">         89 :                 if (flags-&gt;replicate || flags-&gt;props) {</span>
<span class="lineNum">    1892 </span>                :            :                         nvlist_t *hdrnv;
<span class="lineNum">    1893 </span>                :            : 
<span class="lineNum">    1894 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 83 times"> + </span>]:<span class="lineCov">         83 :                         VERIFY(0 == nvlist_alloc(&amp;hdrnv, NV_UNIQUE_NAME, 0));</span>
<span class="lineNum">    1895 </span>        [<span class="branchCov" title="Branch 0 was taken 20 times"> + </span><span class="branchCov" title="Branch 1 was taken 63 times"> + </span>]:<span class="lineCov">         83 :                         if (fromsnap) {</span>
<span class="lineNum">    1896 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 20 times"> + </span>]:<span class="lineCov">         20 :                                 VERIFY(0 == nvlist_add_string(hdrnv,</span>
<span class="lineNum">    1897 </span>                :            :                                     &quot;fromsnap&quot;, fromsnap));
<span class="lineNum">    1898 </span>                :            :                         }
<span class="lineNum">    1899 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 83 times"> + </span>]:<span class="lineCov">         83 :                         VERIFY(0 == nvlist_add_string(hdrnv, &quot;tosnap&quot;, tosnap));</span>
<span class="lineNum">    1900 </span>        [<span class="branchCov" title="Branch 0 was taken 26 times"> + </span><span class="branchCov" title="Branch 1 was taken 57 times"> + </span>]:<span class="lineCov">         83 :                         if (!flags-&gt;replicate) {</span>
<span class="lineNum">    1901 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 26 times"> + </span>]:<span class="lineCov">         26 :                                 VERIFY(0 == nvlist_add_boolean(hdrnv,</span>
<span class="lineNum">    1902 </span>                :            :                                     &quot;not_recursive&quot;));
<span class="lineNum">    1903 </span>                :            :                         }
<span class="lineNum">    1904 </span>        [<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchCov" title="Branch 1 was taken 77 times"> + </span>]:<span class="lineCov">         83 :                         if (flags-&gt;raw) {</span>
<span class="lineNum">    1905 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 6 times"> + </span>]:<span class="lineCov">          6 :                                 VERIFY(0 == nvlist_add_boolean(hdrnv, &quot;raw&quot;));</span>
<span class="lineNum">    1906 </span>                :            :                         }
<span class="lineNum">    1907 </span>                :            : 
<span class="lineNum">    1908 </span>                :<span class="lineCov">         83 :                         err = gather_nvlist(zhp-&gt;zfs_hdl, zhp-&gt;zfs_name,</span>
<span class="lineNum">    1909 </span>                :            :                             fromsnap, tosnap, flags-&gt;replicate, flags-&gt;raw,
<span class="lineNum">    1910 </span>                :            :                             flags-&gt;verbose, &amp;fss, &amp;fsavl);
<span class="lineNum">    1911 </span>        [<span class="branchCov" title="Branch 0 was taken 81 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">         83 :                         if (err)</span>
<span class="lineNum">    1912 </span>                :            :                                 goto err_out;
<span class="lineNum">    1913 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 81 times"> + </span>]:<span class="lineCov">         81 :                         VERIFY(0 == nvlist_add_nvlist(hdrnv, &quot;fss&quot;, fss));</span>
<span class="lineNum">    1914 </span>                :<span class="lineCov">         81 :                         err = nvlist_pack(hdrnv, &amp;packbuf, &amp;buflen,</span>
<span class="lineNum">    1915 </span>                :            :                             NV_ENCODE_XDR, 0);
<span class="lineNum">    1916 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 81 times"> + </span>]:<span class="lineCov">         81 :                         if (debugnvp)</span>
<span class="lineNum">    1917 </span>                :<span class="lineNoCov">          0 :                                 *debugnvp = hdrnv;</span>
<span class="lineNum">    1918 </span>                :            :                         else
<span class="lineNum">    1919 </span>                :<span class="lineCov">         81 :                                 nvlist_free(hdrnv);</span>
<span class="lineNum">    1920 </span>        [<span class="branchCov" title="Branch 0 was taken 81 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         83 :                         if (err)</span>
<span class="lineNum">    1921 </span>                :            :                                 goto stderr_out;
<span class="lineNum">    1922 </span>                :            :                 }
<span class="lineNum">    1923 </span>                :            : 
<span class="lineNum">    1924 </span>        [<span class="branchCov" title="Branch 0 was taken 85 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">         87 :                 if (!flags-&gt;dryrun) {</span>
<span class="lineNum">    1925 </span>                :            :                         /* write first begin record */
<span class="lineNum">    1926 </span>                :<span class="lineCov">         85 :                         drr.drr_type = DRR_BEGIN;</span>
<span class="lineNum">    1927 </span>                :<span class="lineCov">         85 :                         drr.drr_u.drr_begin.drr_magic = DMU_BACKUP_MAGIC;</span>
<span class="lineNum">    1928 </span>                :<span class="lineCov">         85 :                         DMU_SET_STREAM_HDRTYPE(drr.drr_u.drr_begin.</span>
<span class="lineNum">    1929 </span>                :            :                             drr_versioninfo, DMU_COMPOUNDSTREAM);
<span class="lineNum">    1930 </span>                :<span class="lineCov">         85 :                         DMU_SET_FEATUREFLAGS(drr.drr_u.drr_begin.</span>
<span class="lineNum">    1931 </span>                :            :                             drr_versioninfo, featureflags);
<span class="lineNum">    1932 </span>        [<span class="branchCov" title="Branch 0 was taken 85 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         85 :                         if (snprintf(drr.drr_u.drr_begin.drr_toname,</span>
<span class="lineNum">    1933 </span>                :            :                             sizeof (drr.drr_u.drr_begin.drr_toname),
<span class="lineNum">    1934 </span>                :<span class="lineCov">         85 :                             &quot;%s@%s&quot;, zhp-&gt;zfs_name, tosnap) &gt;=</span>
<span class="lineNum">    1935 </span>                :            :                             sizeof (drr.drr_u.drr_begin.drr_toname)) {
<span class="lineNum">    1936 </span>                :            :                                 err = EINVAL;
<span class="lineNum">    1937 </span>                :            :                                 goto stderr_out;
<span class="lineNum">    1938 </span>                :            :                         }
<span class="lineNum">    1939 </span>                :<span class="lineCov">         85 :                         drr.drr_payloadlen = buflen;</span>
<span class="lineNum">    1940 </span>                :            : 
<span class="lineNum">    1941 </span>                :<span class="lineCov">         85 :                         err = dump_record(&amp;drr, packbuf, buflen, &amp;zc, outfd);</span>
<span class="lineNum">    1942 </span>                :<span class="lineCov">         85 :                         free(packbuf);</span>
<span class="lineNum">    1943 </span>        [<span class="branchCov" title="Branch 0 was taken 85 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         85 :                         if (err != 0)</span>
<span class="lineNum">    1944 </span>                :            :                                 goto stderr_out;
<span class="lineNum">    1945 </span>                :            : 
<span class="lineNum">    1946 </span>                :            :                         /* write end record */
<span class="lineNum">    1947 </span>                :<span class="lineCov">         85 :                         bzero(&amp;drr, sizeof (drr));</span>
<span class="lineNum">    1948 </span>                :<span class="lineCov">         85 :                         drr.drr_type = DRR_END;</span>
<span class="lineNum">    1949 </span>                :<span class="lineCov">         85 :                         drr.drr_u.drr_end.drr_checksum = zc;</span>
<span class="lineNum">    1950 </span>                :<span class="lineCov">         85 :                         err = write(outfd, &amp;drr, sizeof (drr));</span>
<span class="lineNum">    1951 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 85 times"> + </span>]:<span class="lineCov">         85 :                         if (err == -1) {</span>
<span class="lineNum">    1952 </span>                :<span class="lineNoCov">          0 :                                 err = errno;</span>
<span class="lineNum">    1953 </span>                :<span class="lineCov">         87 :                                 goto stderr_out;</span>
<span class="lineNum">    1954 </span>                :            :                         }
<span class="lineNum">    1955 </span>                :            : 
<span class="lineNum">    1956 </span>                :            :                         err = 0;
<span class="lineNum">    1957 </span>                :            :                 }
<span class="lineNum">    1958 </span>                :            :         }
<span class="lineNum">    1959 </span>                :            : 
<span class="lineNum">    1960 </span>                :            :         /* dump each stream */
<span class="lineNum">    1961 </span>                :<span class="lineCov">        250 :         sdd.fromsnap = fromsnap;</span>
<span class="lineNum">    1962 </span>                :<span class="lineCov">        250 :         sdd.tosnap = tosnap;</span>
<span class="lineNum">    1963 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 246 times"> + </span>]:<span class="lineCov">        250 :         if (tid != 0)</span>
<span class="lineNum">    1964 </span>                :<span class="lineCov">          4 :                 sdd.outfd = pipefd[0];</span>
<span class="lineNum">    1965 </span>                :            :         else
<span class="lineNum">    1966 </span>                :<span class="lineCov">        246 :                 sdd.outfd = outfd;</span>
<span class="lineNum">    1967 </span>                :<span class="lineCov">        250 :         sdd.replicate = flags-&gt;replicate;</span>
<span class="lineNum">    1968 </span>                :<span class="lineCov">        250 :         sdd.doall = flags-&gt;doall;</span>
<span class="lineNum">    1969 </span>                :<span class="lineCov">        250 :         sdd.fromorigin = flags-&gt;fromorigin;</span>
<span class="lineNum">    1970 </span>                :<span class="lineCov">        250 :         sdd.fss = fss;</span>
<span class="lineNum">    1971 </span>                :<span class="lineCov">        250 :         sdd.fsavl = fsavl;</span>
<span class="lineNum">    1972 </span>                :<span class="lineCov">        250 :         sdd.verbose = flags-&gt;verbose;</span>
<span class="lineNum">    1973 </span>                :<span class="lineCov">        250 :         sdd.parsable = flags-&gt;parsable;</span>
<span class="lineNum">    1974 </span>                :<span class="lineCov">        250 :         sdd.progress = flags-&gt;progress;</span>
<span class="lineNum">    1975 </span>                :<span class="lineCov">        250 :         sdd.dryrun = flags-&gt;dryrun;</span>
<span class="lineNum">    1976 </span>                :<span class="lineCov">        250 :         sdd.large_block = flags-&gt;largeblock;</span>
<span class="lineNum">    1977 </span>                :<span class="lineCov">        250 :         sdd.embed_data = flags-&gt;embed_data;</span>
<span class="lineNum">    1978 </span>                :<span class="lineCov">        250 :         sdd.compress = flags-&gt;compress;</span>
<span class="lineNum">    1979 </span>                :<span class="lineCov">        250 :         sdd.raw = flags-&gt;raw;</span>
<span class="lineNum">    1980 </span>                :<span class="lineCov">        250 :         sdd.filter_cb = filter_func;</span>
<span class="lineNum">    1981 </span>                :<span class="lineCov">        250 :         sdd.filter_cb_arg = cb_arg;</span>
<span class="lineNum">    1982 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 249 times"> + </span>]:<span class="lineCov">        250 :         if (debugnvp)</span>
<span class="lineNum">    1983 </span>                :<span class="lineCov">          1 :                 sdd.debugnv = *debugnvp;</span>
<span class="lineNum">    1984 </span>[<span class="branchCov" title="Branch 0 was taken 22 times"> + </span><span class="branchCov" title="Branch 1 was taken 228 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 8 times"> + </span><span class="branchCov" title="Branch 3 was taken 14 times"> + </span>]:<span class="lineCov">        250 :         if (sdd.verbose &amp;&amp; sdd.dryrun)</span>
<span class="lineNum">    1985 </span>                :<span class="lineCov">          8 :                 sdd.std_out = B_TRUE;</span>
<span class="lineNum">    1986 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 242 times"> + </span>]:<span class="lineCov">        250 :         fout = sdd.std_out ? stdout : stderr;</span>
<span class="lineNum">    1987 </span>                :            : 
<span class="lineNum">    1988 </span>                :            :         /*
<span class="lineNum">    1989 </span>                :            :          * Some flags require that we place user holds on the datasets that are
<span class="lineNum">    1990 </span>                :            :          * being sent so they don't get destroyed during the send. We can skip
<span class="lineNum">    1991 </span>                :            :          * this step if the pool is imported read-only since the datasets cannot
<span class="lineNum">    1992 </span>                :            :          * be destroyed.
<span class="lineNum">    1993 </span>                :            :          */
<span class="lineNum">    1994 </span>[<span class="branchCov" title="Branch 0 was taken 242 times"> + </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>][<span class="branchCov" title="Branch 4 was taken 239 times"> + </span><span class="branchCov" title="Branch 5 was taken 3 times"> + </span>]:<span class="lineCov">        250 :         if (!flags-&gt;dryrun &amp;&amp; !zpool_get_prop_int(zfs_get_pool_handle(zhp),</span>
<span class="lineNum">    1995 </span>        [<span class="branchCov" title="Branch 0 was taken 239 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        239 :             ZPOOL_PROP_READONLY, NULL) &amp;&amp;</span>
<span class="lineNum">    1996 </span>        [<span class="branchCov" title="Branch 1 was taken 237 times"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span>]:<span class="lineCov">        478 :             zfs_spa_version(zhp, &amp;spa_version) == 0 &amp;&amp;</span>
<span class="lineNum">    1997 </span>        [<span class="branchCov" title="Branch 0 was taken 186 times"> + </span><span class="branchCov" title="Branch 1 was taken 51 times"> + </span>]:<span class="lineCov">        237 :             spa_version &gt;= SPA_VERSION_USERREFS &amp;&amp;</span>
<span class="lineNum">    1998 </span>        [<span class="branchCov" title="Branch 0 was taken 7 times"> + </span><span class="branchCov" title="Branch 1 was taken 179 times"> + </span>]:<span class="lineCov">        186 :             (flags-&gt;doall || flags-&gt;replicate)) {</span>
<span class="lineNum">    1999 </span>                :<span class="lineCov">         58 :                 ++holdseq;</span>
<span class="lineNum">    2000 </span>                :<span class="lineCov">         58 :                 (void) snprintf(sdd.holdtag, sizeof (sdd.holdtag),</span>
<span class="lineNum">    2001 </span>                :            :                     &quot;.send-%d-%llu&quot;, getpid(), (u_longlong_t)holdseq);
<span class="lineNum">    2002 </span>                :<span class="lineCov">         58 :                 sdd.cleanup_fd = open(ZFS_DEV, O_RDWR);</span>
<span class="lineNum">    2003 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 58 times"> + </span>]:<span class="lineCov">         58 :                 if (sdd.cleanup_fd &lt; 0) {</span>
<span class="lineNum">    2004 </span>                :<span class="lineNoCov">          0 :                         err = errno;</span>
<span class="lineNum">    2005 </span>                :<span class="lineNoCov">          0 :                         goto stderr_out;</span>
<span class="lineNum">    2006 </span>                :            :                 }
<span class="lineNum">    2007 </span>                :<span class="lineCov">         58 :                 sdd.snapholds = fnvlist_alloc();</span>
<span class="lineNum">    2008 </span>                :            :         } else {
<span class="lineNum">    2009 </span>                :<span class="lineCov">        192 :                 sdd.cleanup_fd = -1;</span>
<span class="lineNum">    2010 </span>                :<span class="lineCov">        192 :                 sdd.snapholds = NULL;</span>
<span class="lineNum">    2011 </span>                :            :         }
<span class="lineNum">    2012 </span>[<span class="branchCov" title="Branch 0 was taken 228 times"> + </span><span class="branchCov" title="Branch 1 was taken 22 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 58 times"> + </span><span class="branchCov" title="Branch 3 was taken 170 times"> + </span>]:<span class="lineCov">        250 :         if (flags-&gt;verbose || sdd.snapholds != NULL) {</span>
<span class="lineNum">    2013 </span>                :            :                 /*
<span class="lineNum">    2014 </span>                :            :                  * Do a verbose no-op dry run to get all the verbose output
<span class="lineNum">    2015 </span>                :            :                  * or to gather snapshot hold's before generating any data,
<span class="lineNum">    2016 </span>                :            :                  * then do a non-verbose real run to generate the streams.
<span class="lineNum">    2017 </span>                :            :                  */
<span class="lineNum">    2018 </span>                :<span class="lineCov">         80 :                 sdd.dryrun = B_TRUE;</span>
<span class="lineNum">    2019 </span>                :<span class="lineCov">         80 :                 err = dump_filesystems(zhp, &amp;sdd);</span>
<span class="lineNum">    2020 </span>                :            : 
<span class="lineNum">    2021 </span>        [<span class="branchCov" title="Branch 0 was taken 80 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         80 :                 if (err != 0)</span>
<span class="lineNum">    2022 </span>                :            :                         goto stderr_out;
<span class="lineNum">    2023 </span>                :            : 
<span class="lineNum">    2024 </span>        [<span class="branchCov" title="Branch 0 was taken 22 times"> + </span><span class="branchCov" title="Branch 1 was taken 58 times"> + </span>]:<span class="lineCov">         80 :                 if (flags-&gt;verbose) {</span>
<span class="lineNum">    2025 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">         22 :                         if (flags-&gt;parsable) {</span>
<span class="lineNum">    2026 </span>                :<span class="lineCov">          4 :                                 (void) fprintf(fout, &quot;size\t%llu\n&quot;,</span>
<span class="lineNum">    2027 </span>                :<span class="lineCov">          4 :                                     (longlong_t)sdd.size);</span>
<span class="lineNum">    2028 </span>                :            :                         } else {
<span class="lineNum">    2029 </span>                :            :                                 char buf[16];
<span class="lineNum">    2030 </span>                :<span class="lineCov">         18 :                                 zfs_nicebytes(sdd.size, buf, sizeof (buf));</span>
<span class="lineNum">    2031 </span>                :<span class="lineCov">         18 :                                 (void) fprintf(fout, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    2032 </span>                :            :                                     &quot;total estimated size is %s\n&quot;), buf);
<span class="lineNum">    2033 </span>                :            :                         }
<span class="lineNum">    2034 </span>                :            :                 }
<span class="lineNum">    2035 </span>                :            : 
<span class="lineNum">    2036 </span>                :            :                 /* Ensure no snaps found is treated as an error. */
<span class="lineNum">    2037 </span>        [<span class="branchCov" title="Branch 0 was taken 80 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         80 :                 if (!sdd.seento) {</span>
<span class="lineNum">    2038 </span>                :            :                         err = ENOENT;
<span class="lineNum">    2039 </span>                :            :                         goto err_out;
<span class="lineNum">    2040 </span>                :            :                 }
<span class="lineNum">    2041 </span>                :            : 
<span class="lineNum">    2042 </span>                :            :                 /* Skip the second run if dryrun was requested. */
<span class="lineNum">    2043 </span>        [<span class="branchCov" title="Branch 0 was taken 72 times"> + </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">         80 :                 if (flags-&gt;dryrun)</span>
<span class="lineNum">    2044 </span>                :            :                         goto err_out;
<span class="lineNum">    2045 </span>                :            : 
<span class="lineNum">    2046 </span>        [<span class="branchCov" title="Branch 0 was taken 58 times"> + </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>]:<span class="lineCov">         72 :                 if (sdd.snapholds != NULL) {</span>
<span class="lineNum">    2047 </span>                :<span class="lineCov">         58 :                         err = zfs_hold_nvl(zhp, sdd.cleanup_fd, sdd.snapholds);</span>
<span class="lineNum">    2048 </span>        [<span class="branchCov" title="Branch 0 was taken 58 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         58 :                         if (err != 0)</span>
<span class="lineNum">    2049 </span>                :            :                                 goto stderr_out;
<span class="lineNum">    2050 </span>                :            : 
<span class="lineNum">    2051 </span>                :<span class="lineCov">         58 :                         fnvlist_free(sdd.snapholds);</span>
<span class="lineNum">    2052 </span>                :<span class="lineCov">         58 :                         sdd.snapholds = NULL;</span>
<span class="lineNum">    2053 </span>                :            :                 }
<span class="lineNum">    2054 </span>                :            : 
<span class="lineNum">    2055 </span>                :<span class="lineCov">         72 :                 sdd.dryrun = B_FALSE;</span>
<span class="lineNum">    2056 </span>                :<span class="lineCov">         72 :                 sdd.verbose = B_FALSE;</span>
<span class="lineNum">    2057 </span>                :            :         }
<span class="lineNum">    2058 </span>                :            : 
<span class="lineNum">    2059 </span>                :<span class="lineCov">        242 :         err = dump_filesystems(zhp, &amp;sdd);</span>
<span class="lineNum">    2060 </span>                :<span class="lineCov">        242 :         fsavl_destroy(fsavl);</span>
<span class="lineNum">    2061 </span>                :<span class="lineCov">        242 :         nvlist_free(fss);</span>
<span class="lineNum">    2062 </span>                :            : 
<span class="lineNum">    2063 </span>                :            :         /* Ensure no snaps found is treated as an error. */
<span class="lineNum">    2064 </span>[<span class="branchCov" title="Branch 0 was taken 238 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 7 times"> + </span><span class="branchCov" title="Branch 3 was taken 231 times"> + </span>]:<span class="lineCov">        242 :         if (err == 0 &amp;&amp; !sdd.seento)</span>
<span class="lineNum">    2065 </span>                :<span class="lineCov">          7 :                 err = ENOENT;</span>
<span class="lineNum">    2066 </span>                :            : 
<span class="lineNum">    2067 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 238 times"> + </span>]:<span class="lineCov">        242 :         if (tid != 0) {</span>
<span class="lineNum">    2068 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">          4 :                 if (err != 0)</span>
<span class="lineNum">    2069 </span>                :<span class="lineNoCov">          0 :                         (void) pthread_cancel(tid);</span>
<span class="lineNum">    2070 </span>                :<span class="lineCov">          4 :                 (void) close(pipefd[0]);</span>
<span class="lineNum">    2071 </span>                :<span class="lineCov">          4 :                 (void) pthread_join(tid, NULL);</span>
<span class="lineNum">    2072 </span>                :            :         }
<span class="lineNum">    2073 </span>                :            : 
<span class="lineNum">    2074 </span>        [<span class="branchCov" title="Branch 0 was taken 58 times"> + </span><span class="branchCov" title="Branch 1 was taken 184 times"> + </span>]:<span class="lineCov">        242 :         if (sdd.cleanup_fd != -1) {</span>
<span class="lineNum">    2075 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 58 times"> + </span>]:<span class="lineCov">         58 :                 VERIFY(0 == close(sdd.cleanup_fd));</span>
<span class="lineNum">    2076 </span>                :<span class="lineCov">         58 :                 sdd.cleanup_fd = -1;</span>
<span class="lineNum">    2077 </span>                :            :         }
<span class="lineNum">    2078 </span>                :            : 
<span class="lineNum">    2079 </span>[<span class="branchCov" title="Branch 0 was taken 242 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 188 times"> + </span><span class="branchCov" title="Branch 3 was taken 54 times"> + </span>]:<span class="lineCov">        242 :         if (!flags-&gt;dryrun &amp;&amp; (flags-&gt;replicate || flags-&gt;doall ||</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 181 times"> + </span><span class="branchCov" title="Branch 5 was taken 7 times"> + </span>][<span class="branchCov" title="Branch 6 was taken 24 times"> + </span><span class="branchCov" title="Branch 7 was taken 157 times"> + </span>]
<span class="lineNum">    2080 </span>                :<span class="lineCov">        181 :             flags-&gt;props)) {</span>
<span class="lineNum">    2081 </span>                :            :                 /*
<span class="lineNum">    2082 </span>                :            :                  * write final end record.  NB: want to do this even if
<span class="lineNum">    2083 </span>                :            :                  * there was some error, because it might not be totally
<span class="lineNum">    2084 </span>                :            :                  * failed.
<span class="lineNum">    2085 </span>                :            :                  */
<span class="lineNum">    2086 </span>                :<span class="lineCov">         85 :                 dmu_replay_record_t drr = { 0 };</span>
<span class="lineNum">    2087 </span>                :<span class="lineCov">         85 :                 drr.drr_type = DRR_END;</span>
<span class="lineNum">    2088 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 83 times"> + </span>]:<span class="lineCov">         85 :                 if (write(outfd, &amp;drr, sizeof (drr)) == -1) {</span>
<span class="lineNum">    2089 </span>                :<span class="lineCov">         85 :                         return (zfs_standard_error(zhp-&gt;zfs_hdl,</span>
<span class="lineNum">    2090 </span>                :<span class="lineCov">          2 :                             errno, errbuf));</span>
<span class="lineNum">    2091 </span>                :            :                 }
<span class="lineNum">    2092 </span>                :            :         }
<span class="lineNum">    2093 </span>                :            : 
<span class="lineNum">    2094 </span>[<span class="branchCov" title="Branch 0 was taken 231 times"> + </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 231 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">        240 :         return (err || sdd.err);</span>
<span class="lineNum">    2095 </span>                :            : 
<span class="lineNum">    2096 </span>                :            : stderr_out:
<span class="lineNum">    2097 </span>                :<span class="lineNoCov">          0 :         err = zfs_standard_error(zhp-&gt;zfs_hdl, err, errbuf);</span>
<span class="lineNum">    2098 </span>                :            : err_out:
<span class="lineNum">    2099 </span>                :<span class="lineCov">         10 :         fsavl_destroy(fsavl);</span>
<span class="lineNum">    2100 </span>                :<span class="lineCov">         10 :         nvlist_free(fss);</span>
<span class="lineNum">    2101 </span>                :<span class="lineCov">         10 :         fnvlist_free(sdd.snapholds);</span>
<span class="lineNum">    2102 </span>                :            : 
<span class="lineNum">    2103 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">         10 :         if (sdd.cleanup_fd != -1)</span>
<span class="lineNum">    2104 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span>]:<span class="lineCov">          2 :                 VERIFY(0 == close(sdd.cleanup_fd));</span>
<span class="lineNum">    2105 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span>]:<span class="lineCov">         10 :         if (tid != 0) {</span>
<span class="lineNum">    2106 </span>                :<span class="lineNoCov">          0 :                 (void) pthread_cancel(tid);</span>
<span class="lineNum">    2107 </span>                :<span class="lineNoCov">          0 :                 (void) close(pipefd[0]);</span>
<span class="lineNum">    2108 </span>                :<span class="lineNoCov">          0 :                 (void) pthread_join(tid, NULL);</span>
<span class="lineNum">    2109 </span>                :            :         }
<span class="lineNum">    2110 </span>                :            :         return (err);
<span class="lineNum">    2111 </span>                :            : }
<a name="2112"><span class="lineNum">    2112 </span>                :            : </a>
<span class="lineNum">    2113 </span>                :            : int
<span class="lineNum">    2114 </span>                :<span class="lineCov">          5 : zfs_send_one(zfs_handle_t *zhp, const char *from, int fd, sendflags_t flags)</span>
<span class="lineNum">    2115 </span>                :            : {
<span class="lineNum">    2116 </span>                :<span class="lineCov">          5 :         int err = 0;</span>
<span class="lineNum">    2117 </span>                :<span class="lineCov">          5 :         libzfs_handle_t *hdl = zhp-&gt;zfs_hdl;</span>
<span class="lineNum">    2118 </span>                :<span class="lineCov">          5 :         enum lzc_send_flags lzc_flags = 0;</span>
<span class="lineNum">    2119 </span>[<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          5 :         FILE *fout = (flags.verbose &amp;&amp; flags.dryrun) ? stdout : stderr;</span>
<span class="lineNum">    2120 </span>                :            :         char errbuf[1024];
<span class="lineNum">    2121 </span>                :            : 
<span class="lineNum">    2122 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">          5 :         if (flags.largeblock)</span>
<span class="lineNum">    2123 </span>                :<span class="lineNoCov">          0 :                 lzc_flags |= LZC_SEND_FLAG_LARGE_BLOCK;</span>
<span class="lineNum">    2124 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">          5 :         if (flags.embed_data)</span>
<span class="lineNum">    2125 </span>                :<span class="lineNoCov">          0 :                 lzc_flags |= LZC_SEND_FLAG_EMBED_DATA;</span>
<span class="lineNum">    2126 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">          5 :         if (flags.compress)</span>
<span class="lineNum">    2127 </span>                :<span class="lineNoCov">          0 :                 lzc_flags |= LZC_SEND_FLAG_COMPRESS;</span>
<span class="lineNum">    2128 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">          5 :         if (flags.raw)</span>
<span class="lineNum">    2129 </span>                :<span class="lineNoCov">          0 :                 lzc_flags |= LZC_SEND_FLAG_RAW;</span>
<span class="lineNum">    2130 </span>                :            : 
<span class="lineNum">    2131 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          5 :         if (flags.verbose) {</span>
<span class="lineNum">    2132 </span>                :<span class="lineCov">          2 :                 uint64_t size = 0;</span>
<span class="lineNum">    2133 </span>                :<span class="lineCov">          2 :                 err = lzc_send_space(zhp-&gt;zfs_name, from, lzc_flags, &amp;size);</span>
<span class="lineNum">    2134 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          2 :                 if (err == 0) {</span>
<span class="lineNum">    2135 </span>                :<span class="lineCov">          2 :                         send_print_verbose(fout, zhp-&gt;zfs_name, from, size,</span>
<span class="lineNum">    2136 </span>                :            :                             flags.parsable);
<span class="lineNum">    2137 </span>                :            :                 } else {
<span class="lineNum">    2138 </span>                :<span class="lineNoCov">          0 :                         (void) fprintf(stderr, &quot;Cannot estimate send size: &quot;</span>
<span class="lineNum">    2139 </span>                :<span class="lineNoCov">          0 :                             &quot;%s\n&quot;, strerror(errno));</span>
<span class="lineNum">    2140 </span>                :            :                 }
<span class="lineNum">    2141 </span>                :            :         }
<span class="lineNum">    2142 </span>                :            : 
<span class="lineNum">    2143 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          5 :         if (flags.dryrun)</span>
<span class="lineNum">    2144 </span>                :            :                 return (err);
<span class="lineNum">    2145 </span>                :            : 
<span class="lineNum">    2146 </span>                :<span class="lineCov">          6 :         (void) snprintf(errbuf, sizeof (errbuf), dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    2147 </span>                :<span class="lineCov">          3 :             &quot;warning: cannot send '%s'&quot;), zhp-&gt;zfs_name);</span>
<span class="lineNum">    2148 </span>                :            : 
<span class="lineNum">    2149 </span>                :<span class="lineCov">          3 :         err = lzc_send(zhp-&gt;zfs_name, from, fd, lzc_flags);</span>
<span class="lineNum">    2150 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          3 :         if (err != 0) {</span>
<span class="lineNum">    2151 </span>  [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 2 times"> + </span> :<span class="lineCov">          2 :                 switch (errno) {</span>
<span class="lineNum">         </span>         <span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>]
<span class="lineNum">    2152 </span>                :            :                 case EXDEV:
<span class="lineNum">    2153 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    2154 </span>                :            :                             &quot;not an earlier snapshot from the same fs&quot;));
<span class="lineNum">    2155 </span>                :<span class="lineNoCov">          0 :                         return (zfs_error(hdl, EZFS_CROSSTARGET, errbuf));</span>
<span class="lineNum">    2156 </span>                :            : 
<span class="lineNum">    2157 </span>                :            :                 case ENOENT:
<span class="lineNum">    2158 </span>                :            :                 case ESRCH:
<span class="lineNum">    2159 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (lzc_exists(zhp-&gt;zfs_name)) {</span>
<span class="lineNum">    2160 </span>                :<span class="lineNoCov">          0 :                                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    2161 </span>                :            :                                     &quot;incremental source (%s) does not exist&quot;),
<span class="lineNum">    2162 </span>                :            :                                     from);
<span class="lineNum">    2163 </span>                :            :                         }
<span class="lineNum">    2164 </span>                :<span class="lineNoCov">          0 :                         return (zfs_error(hdl, EZFS_NOENT, errbuf));</span>
<span class="lineNum">    2165 </span>                :            : 
<span class="lineNum">    2166 </span>                :            :                 case EACCES:
<span class="lineNum">    2167 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    2168 </span>                :            :                             &quot;dataset key must be loaded&quot;));
<span class="lineNum">    2169 </span>                :<span class="lineNoCov">          0 :                         return (zfs_error(hdl, EZFS_CRYPTOFAILED, errbuf));</span>
<span class="lineNum">    2170 </span>                :            : 
<span class="lineNum">    2171 </span>                :            :                 case EBUSY:
<span class="lineNum">    2172 </span>                :<span class="lineCov">          2 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    2173 </span>                :            :                             &quot;target is busy; if a filesystem, &quot;
<span class="lineNum">    2174 </span>                :            :                             &quot;it must not be mounted&quot;));
<span class="lineNum">    2175 </span>                :<span class="lineCov">          2 :                         return (zfs_error(hdl, EZFS_BUSY, errbuf));</span>
<span class="lineNum">    2176 </span>                :            : 
<span class="lineNum">    2177 </span>                :            :                 case EDQUOT:
<span class="lineNum">    2178 </span>                :            :                 case EFBIG:
<span class="lineNum">    2179 </span>                :            :                 case EIO:
<span class="lineNum">    2180 </span>                :            :                 case ENOLINK:
<span class="lineNum">    2181 </span>                :            :                 case ENOSPC:
<span class="lineNum">    2182 </span>                :            :                 case ENOSTR:
<span class="lineNum">    2183 </span>                :            :                 case ENXIO:
<span class="lineNum">    2184 </span>                :            :                 case EPIPE:
<span class="lineNum">    2185 </span>                :            :                 case ERANGE:
<span class="lineNum">    2186 </span>                :            :                 case EFAULT:
<span class="lineNum">    2187 </span>                :            :                 case EROFS:
<span class="lineNum">    2188 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, strerror(errno));</span>
<span class="lineNum">    2189 </span>                :<span class="lineNoCov">          0 :                         return (zfs_error(hdl, EZFS_BADBACKUP, errbuf));</span>
<span class="lineNum">    2190 </span>                :            : 
<span class="lineNum">    2191 </span>                :            :                 default:
<span class="lineNum">    2192 </span>                :<span class="lineNoCov">          0 :                         return (zfs_standard_error(hdl, errno, errbuf));</span>
<span class="lineNum">    2193 </span>                :            :                 }
<span class="lineNum">    2194 </span>                :            :         }
<span class="lineNum">    2195 </span>                :            :         return (err != 0);
<span class="lineNum">    2196 </span>                :            : }
<span class="lineNum">    2197 </span>                :            : 
<span class="lineNum">    2198 </span>                :            : /*
<span class="lineNum">    2199 </span>                :            :  * Routines specific to &quot;zfs recv&quot;
<span class="lineNum">    2200 </span>                :            :  */
<a name="2201"><span class="lineNum">    2201 </span>                :            : </a>
<span class="lineNum">    2202 </span>                :            : static int
<span class="lineNum">    2203 </span>                :<span class="lineCov">       7849 : recv_read(libzfs_handle_t *hdl, int fd, void *buf, int ilen,</span>
<span class="lineNum">    2204 </span>                :            :     boolean_t byteswap, zio_cksum_t *zc)
<span class="lineNum">    2205 </span>                :            : {
<span class="lineNum">    2206 </span>                :<span class="lineCov">       7849 :         char *cp = buf;</span>
<span class="lineNum">    2207 </span>                :            :         int rv;
<span class="lineNum">    2208 </span>                :<span class="lineCov">       7849 :         int len = ilen;</span>
<span class="lineNum">    2209 </span>                :            : 
<span class="lineNum">    2210 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7849 times"> + </span>]:<span class="lineCov">       7849 :         assert(ilen &lt;= SPA_MAXBLOCKSIZE);</span>
<span class="lineNum">    2211 </span>                :            : 
<span class="lineNum">    2212 </span>                :            :         do {
<span class="lineNum">    2213 </span>                :<span class="lineCov">      31356 :                 rv = read(fd, cp, len);</span>
<span class="lineNum">    2214 </span>                :<span class="lineCov">      15678 :                 cp += rv;</span>
<span class="lineNum">    2215 </span>                :<span class="lineCov">      15678 :                 len -= rv;</span>
<span class="lineNum">    2216 </span>        [<span class="branchCov" title="Branch 0 was taken 7829 times"> + </span><span class="branchCov" title="Branch 1 was taken 7849 times"> + </span>]:<span class="lineCov">      15678 :         } while (rv &gt; 0);</span>
<span class="lineNum">    2217 </span>                :            : 
<span class="lineNum">    2218 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7849 times"> + </span>]:<span class="lineCov">       7849 :         if (rv &lt; 0 || len != 0) {</span>
<span class="lineNum">    2219 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    2220 </span>                :            :                     &quot;failed to read from stream&quot;));
<span class="lineNum">    2221 </span>                :<span class="lineNoCov">          0 :                 return (zfs_error(hdl, EZFS_BADSTREAM, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    2222 </span>                :            :                     &quot;cannot receive&quot;)));
<span class="lineNum">    2223 </span>                :            :         }
<span class="lineNum">    2224 </span>                :            : 
<span class="lineNum">    2225 </span>        [<span class="branchCov" title="Branch 0 was taken 1146 times"> + </span><span class="branchCov" title="Branch 1 was taken 6703 times"> + </span>]:<span class="lineCov">       7849 :         if (zc) {</span>
<span class="lineNum">    2226 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1146 times"> + </span>]:<span class="lineCov">       1146 :                 if (byteswap)</span>
<span class="lineNum">    2227 </span>                :<span class="lineNoCov">          0 :                         fletcher_4_incremental_byteswap(buf, ilen, zc);</span>
<span class="lineNum">    2228 </span>                :            :                 else
<span class="lineNum">    2229 </span>                :<span class="lineCov">       1146 :                         fletcher_4_incremental_native(buf, ilen, zc);</span>
<span class="lineNum">    2230 </span>                :            :         }
<span class="lineNum">    2231 </span>                :            :         return (0);
<span class="lineNum">    2232 </span>                :            : }
<a name="2233"><span class="lineNum">    2233 </span>                :            : </a>
<span class="lineNum">    2234 </span>                :            : static int
<span class="lineNum">    2235 </span>                :<span class="lineCov">         73 : recv_read_nvlist(libzfs_handle_t *hdl, int fd, int len, nvlist_t **nvp,</span>
<span class="lineNum">    2236 </span>                :            :     boolean_t byteswap, zio_cksum_t *zc)
<span class="lineNum">    2237 </span>                :            : {
<span class="lineNum">    2238 </span>                :            :         char *buf;
<span class="lineNum">    2239 </span>                :            :         int err;
<span class="lineNum">    2240 </span>                :            : 
<span class="lineNum">    2241 </span>                :<span class="lineCov">         73 :         buf = zfs_alloc(hdl, len);</span>
<span class="lineNum">    2242 </span>        [<span class="branchCov" title="Branch 0 was taken 73 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         73 :         if (buf == NULL)</span>
<span class="lineNum">    2243 </span>                :            :                 return (ENOMEM);
<span class="lineNum">    2244 </span>                :            : 
<span class="lineNum">    2245 </span>                :<span class="lineCov">         73 :         err = recv_read(hdl, fd, buf, len, byteswap, zc);</span>
<span class="lineNum">    2246 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 73 times"> + </span>]:<span class="lineCov">         73 :         if (err != 0) {</span>
<span class="lineNum">    2247 </span>                :<span class="lineNoCov">          0 :                 free(buf);</span>
<span class="lineNum">    2248 </span>                :<span class="lineNoCov">          0 :                 return (err);</span>
<span class="lineNum">    2249 </span>                :            :         }
<span class="lineNum">    2250 </span>                :            : 
<span class="lineNum">    2251 </span>                :<span class="lineCov">         73 :         err = nvlist_unpack(buf, len, nvp, 0);</span>
<span class="lineNum">    2252 </span>                :<span class="lineCov">         73 :         free(buf);</span>
<span class="lineNum">    2253 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 73 times"> + </span>]:<span class="lineCov">         73 :         if (err != 0) {</span>
<span class="lineNum">    2254 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN, &quot;invalid &quot;</span>
<span class="lineNum">    2255 </span>                :            :                     &quot;stream (malformed nvlist)&quot;));
<span class="lineNum">    2256 </span>                :<span class="lineNoCov">          0 :                 return (EINVAL);</span>
<span class="lineNum">    2257 </span>                :            :         }
<span class="lineNum">    2258 </span>                :            :         return (0);
<span class="lineNum">    2259 </span>                :            : }
<span class="lineNum">    2260 </span>                :            : 
<span class="lineNum">    2261 </span>                :            : /*
<span class="lineNum">    2262 </span>                :            :  * Returns the grand origin (origin of origin of origin...) of a given handle.
<span class="lineNum">    2263 </span>                :            :  * If this dataset is not a clone, it simply returns a copy of the original
<span class="lineNum">    2264 </span>                :            :  * handle.
<a name="2265"><span class="lineNum">    2265 </span>                :            :  */</a>
<span class="lineNum">    2266 </span>                :            : static zfs_handle_t *
<span class="lineNum">    2267 </span>                :<span class="lineNoCov">          0 : recv_open_grand_origin(zfs_handle_t *zhp)</span>
<span class="lineNum">    2268 </span>                :            : {
<span class="lineNum">    2269 </span>                :            :         char origin[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    2270 </span>                :            :         zprop_source_t src;
<span class="lineNum">    2271 </span>                :<span class="lineNoCov">          0 :         zfs_handle_t *ozhp = zfs_handle_dup(zhp);</span>
<span class="lineNum">    2272 </span>                :            : 
<span class="lineNum">    2273 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         while (ozhp != NULL) {</span>
<span class="lineNum">    2274 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (zfs_prop_get(ozhp, ZFS_PROP_ORIGIN, origin,</span>
<span class="lineNum">    2275 </span>                :            :                     sizeof (origin), &amp;src, NULL, 0, B_FALSE) != 0)
<span class="lineNum">    2276 </span>                :            :                         break;
<span class="lineNum">    2277 </span>                :            : 
<span class="lineNum">    2278 </span>                :<span class="lineNoCov">          0 :                 (void) zfs_close(ozhp);</span>
<span class="lineNum">    2279 </span>                :<span class="lineNoCov">          0 :                 ozhp = zfs_open(zhp-&gt;zfs_hdl, origin, ZFS_TYPE_FILESYSTEM);</span>
<span class="lineNum">    2280 </span>                :            :         }
<span class="lineNum">    2281 </span>                :            : 
<span class="lineNum">    2282 </span>                :<span class="lineNoCov">          0 :         return (ozhp);</span>
<span class="lineNum">    2283 </span>                :            : }
<a name="2284"><span class="lineNum">    2284 </span>                :            : </a>
<span class="lineNum">    2285 </span>                :            : static int
<span class="lineNum">    2286 </span>                :<span class="lineCov">          5 : recv_rename_impl(zfs_handle_t *zhp, zfs_cmd_t *zc)</span>
<span class="lineNum">    2287 </span>                :            : {
<span class="lineNum">    2288 </span>                :            :         int err;
<span class="lineNum">    2289 </span>                :<span class="lineCov">          5 :         zfs_handle_t *ozhp = NULL;</span>
<span class="lineNum">    2290 </span>                :            : 
<span class="lineNum">    2291 </span>                :            :         /*
<span class="lineNum">    2292 </span>                :            :          * Attempt to rename the dataset. If it fails with EACCES we have
<span class="lineNum">    2293 </span>                :            :          * attempted to rename the dataset outside of its encryption root.
<span class="lineNum">    2294 </span>                :            :          * Force the dataset to become an encryption root and try again.
<span class="lineNum">    2295 </span>                :            :          */
<span class="lineNum">    2296 </span>                :<span class="lineCov">          5 :         err = ioctl(zhp-&gt;zfs_hdl-&gt;libzfs_fd, ZFS_IOC_RENAME, &amp;zc);</span>
<span class="lineNum">    2297 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">          5 :         if (err == EACCES) {</span>
<span class="lineNum">    2298 </span>                :<span class="lineNoCov">          0 :                 ozhp = recv_open_grand_origin(zhp);</span>
<span class="lineNum">    2299 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (ozhp == NULL) {</span>
<span class="lineNum">    2300 </span>                :            :                         err = ENOENT;
<span class="lineNum">    2301 </span>                :            :                         goto out;
<span class="lineNum">    2302 </span>                :            :                 }
<span class="lineNum">    2303 </span>                :            : 
<span class="lineNum">    2304 </span>                :<span class="lineNoCov">          0 :                 err = lzc_change_key(ozhp-&gt;zfs_name, DCP_CMD_FORCE_NEW_KEY,</span>
<span class="lineNum">    2305 </span>                :            :                     NULL, NULL, 0);
<span class="lineNum">    2306 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (err != 0)</span>
<span class="lineNum">    2307 </span>                :            :                         goto out;
<span class="lineNum">    2308 </span>                :            : 
<span class="lineNum">    2309 </span>                :<span class="lineNoCov">          0 :                 err = ioctl(zhp-&gt;zfs_hdl-&gt;libzfs_fd, ZFS_IOC_RENAME, &amp;zc);</span>
<span class="lineNum">    2310 </span>                :            :         }
<span class="lineNum">    2311 </span>                :            : 
<span class="lineNum">    2312 </span>                :            : out:
<span class="lineNum">    2313 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">          5 :         if (ozhp != NULL)</span>
<span class="lineNum">    2314 </span>                :<span class="lineNoCov">          0 :                 zfs_close(ozhp);</span>
<span class="lineNum">    2315 </span>                :<span class="lineCov">          5 :         return (err);</span>
<span class="lineNum">    2316 </span>                :            : }
<a name="2317"><span class="lineNum">    2317 </span>                :            : </a>
<span class="lineNum">    2318 </span>                :            : static int
<span class="lineNum">    2319 </span>                :<span class="lineCov">          5 : recv_rename(libzfs_handle_t *hdl, const char *name, const char *tryname,</span>
<span class="lineNum">    2320 </span>                :            :     int baselen, char *newname, recvflags_t *flags)
<span class="lineNum">    2321 </span>                :            : {
<span class="lineNum">    2322 </span>                :            :         static int seq;
<span class="lineNum">    2323 </span>                :<span class="lineCov">          5 :         zfs_cmd_t zc = {&quot;\0&quot;};</span>
<span class="lineNum">    2324 </span>                :            :         int err;
<span class="lineNum">    2325 </span>                :<span class="lineCov">          5 :         prop_changelist_t *clp = NULL;</span>
<span class="lineNum">    2326 </span>                :<span class="lineCov">          5 :         zfs_handle_t *zhp = NULL;</span>
<span class="lineNum">    2327 </span>                :            : 
<span class="lineNum">    2328 </span>                :<span class="lineCov">          5 :         zhp = zfs_open(hdl, name, ZFS_TYPE_DATASET);</span>
<span class="lineNum">    2329 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          5 :         if (zhp == NULL) {</span>
<span class="lineNum">    2330 </span>                :            :                 err = -1;
<span class="lineNum">    2331 </span>                :            :                 goto out;
<span class="lineNum">    2332 </span>                :            :         }
<span class="lineNum">    2333 </span>                :<span class="lineCov">          5 :         clp = changelist_gather(zhp, ZFS_PROP_NAME, 0,</span>
<span class="lineNum">    2334 </span>                :<span class="lineCov">          5 :             flags-&gt;force ? MS_FORCE : 0);</span>
<span class="lineNum">    2335 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          5 :         if (clp == NULL) {</span>
<span class="lineNum">    2336 </span>                :            :                 err = -1;
<span class="lineNum">    2337 </span>                :            :                 goto out;
<span class="lineNum">    2338 </span>                :            :         }
<span class="lineNum">    2339 </span>                :<span class="lineCov">          5 :         err = changelist_prefix(clp);</span>
<span class="lineNum">    2340 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          5 :         if (err)</span>
<span class="lineNum">    2341 </span>                :            :                 goto out;
<span class="lineNum">    2342 </span>                :            : 
<span class="lineNum">    2343 </span>                :<span class="lineCov">          5 :         zc.zc_objset_type = DMU_OST_ZFS;</span>
<span class="lineNum">    2344 </span>                :<span class="lineCov">          5 :         (void) strlcpy(zc.zc_name, name, sizeof (zc.zc_name));</span>
<span class="lineNum">    2345 </span>                :            : 
<span class="lineNum">    2346 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">          5 :         if (tryname) {</span>
<span class="lineNum">    2347 </span>                :<span class="lineNoCov">          0 :                 (void) strcpy(newname, tryname);</span>
<span class="lineNum">    2348 </span>                :            : 
<span class="lineNum">    2349 </span>                :<span class="lineNoCov">          0 :                 (void) strlcpy(zc.zc_value, tryname, sizeof (zc.zc_value));</span>
<span class="lineNum">    2350 </span>                :            : 
<span class="lineNum">    2351 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (flags-&gt;verbose) {</span>
<span class="lineNum">    2352 </span>                :            :                         (void) printf(&quot;attempting rename %s to %s\n&quot;,
<span class="lineNum">    2353 </span>                :            :                             zc.zc_name, zc.zc_value);
<span class="lineNum">    2354 </span>                :            :                 }
<span class="lineNum">    2355 </span>                :<span class="lineNoCov">          0 :                 err = recv_rename_impl(zhp, &amp;zc);</span>
<span class="lineNum">    2356 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (err == 0)</span>
<span class="lineNum">    2357 </span>                :<span class="lineNoCov">          0 :                         changelist_rename(clp, name, tryname);</span>
<span class="lineNum">    2358 </span>                :            :         } else {
<span class="lineNum">    2359 </span>                :            :                 err = ENOENT;
<span class="lineNum">    2360 </span>                :            :         }
<span class="lineNum">    2361 </span>                :            : 
<span class="lineNum">    2362 </span>[<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          5 :         if (err != 0 &amp;&amp; strncmp(name + baselen, &quot;recv-&quot;, 5) != 0) {</span>
<span class="lineNum">    2363 </span>                :<span class="lineCov">          5 :                 seq++;</span>
<span class="lineNum">    2364 </span>                :            : 
<span class="lineNum">    2365 </span>                :<span class="lineCov">          5 :                 (void) snprintf(newname, ZFS_MAX_DATASET_NAME_LEN,</span>
<span class="lineNum">    2366 </span>                :            :                     &quot;%.*srecv-%u-%u&quot;, baselen, name, getpid(), seq);
<span class="lineNum">    2367 </span>                :<span class="lineCov">          5 :                 (void) strlcpy(zc.zc_value, newname, sizeof (zc.zc_value));</span>
<span class="lineNum">    2368 </span>                :            : 
<span class="lineNum">    2369 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">          5 :                 if (flags-&gt;verbose) {</span>
<span class="lineNum">    2370 </span>                :            :                         (void) printf(&quot;failed - trying rename %s to %s\n&quot;,
<span class="lineNum">    2371 </span>                :            :                             zc.zc_name, zc.zc_value);
<span class="lineNum">    2372 </span>                :            :                 }
<span class="lineNum">    2373 </span>                :<span class="lineCov">          5 :                 err = recv_rename_impl(zhp, &amp;zc);</span>
<span class="lineNum">    2374 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">          5 :                 if (err == 0)</span>
<span class="lineNum">    2375 </span>                :<span class="lineNoCov">          0 :                         changelist_rename(clp, name, newname);</span>
<span class="lineNum">    2376 </span>[<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 5 times"> + </span>]:<span class="lineCov">          5 :                 if (err &amp;&amp; flags-&gt;verbose) {</span>
<span class="lineNum">    2377 </span>                :<span class="lineNoCov">          0 :                         (void) printf(&quot;failed (%u) - &quot;</span>
<span class="lineNum">    2378 </span>                :<span class="lineNoCov">          0 :                             &quot;will try again on next pass\n&quot;, errno);</span>
<span class="lineNum">    2379 </span>                :            :                 }
<span class="lineNum">    2380 </span>                :            :                 err = EAGAIN;
<span class="lineNum">    2381 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         } else if (flags-&gt;verbose) {</span>
<span class="lineNum">    2382 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (err == 0)</span>
<span class="lineNum">    2383 </span>                :            :                         (void) printf(&quot;success\n&quot;);
<span class="lineNum">    2384 </span>                :            :                 else
<span class="lineNum">    2385 </span>                :<span class="lineNoCov">          0 :                         (void) printf(&quot;failed (%u)\n&quot;, errno);</span>
<span class="lineNum">    2386 </span>                :            :         }
<span class="lineNum">    2387 </span>                :            : 
<span class="lineNum">    2388 </span>                :<span class="lineCov">          5 :         (void) changelist_postfix(clp);</span>
<span class="lineNum">    2389 </span>                :            : 
<span class="lineNum">    2390 </span>                :            : out:
<span class="lineNum">    2391 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          5 :         if (clp != NULL)</span>
<span class="lineNum">    2392 </span>                :<span class="lineCov">          5 :                 changelist_free(clp);</span>
<span class="lineNum">    2393 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          5 :         if (zhp != NULL)</span>
<span class="lineNum">    2394 </span>                :<span class="lineCov">          5 :                 zfs_close(zhp);</span>
<span class="lineNum">    2395 </span>                :            : 
<span class="lineNum">    2396 </span>                :<span class="lineCov">          5 :         return (err);</span>
<span class="lineNum">    2397 </span>                :            : }
<a name="2398"><span class="lineNum">    2398 </span>                :            : </a>
<span class="lineNum">    2399 </span>                :            : static int
<span class="lineNum">    2400 </span>                :<span class="lineCov">          2 : recv_promote(libzfs_handle_t *hdl, const char *fsname,</span>
<span class="lineNum">    2401 </span>                :            :     const char *origin_fsname, recvflags_t *flags)
<span class="lineNum">    2402 </span>                :            : {
<span class="lineNum">    2403 </span>                :            :         int err;
<span class="lineNum">    2404 </span>                :<span class="lineCov">          1 :         zfs_cmd_t zc = {&quot;\0&quot;};</span>
<span class="lineNum">    2405 </span>                :<span class="lineCov">          1 :         zfs_handle_t *zhp = NULL, *ozhp = NULL;</span>
<span class="lineNum">    2406 </span>                :            : 
<span class="lineNum">    2407 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :         if (flags-&gt;verbose)</span>
<span class="lineNum">    2408 </span>                :            :                 (void) printf(&quot;promoting %s\n&quot;, fsname);
<span class="lineNum">    2409 </span>                :            : 
<span class="lineNum">    2410 </span>                :<span class="lineCov">          1 :         (void) strlcpy(zc.zc_value, origin_fsname, sizeof (zc.zc_value));</span>
<span class="lineNum">    2411 </span>                :<span class="lineCov">          1 :         (void) strlcpy(zc.zc_name, fsname, sizeof (zc.zc_name));</span>
<span class="lineNum">    2412 </span>                :            : 
<span class="lineNum">    2413 </span>                :            :         /*
<span class="lineNum">    2414 </span>                :            :          * Attempt to promote the dataset. If it fails with EACCES the
<span class="lineNum">    2415 </span>                :            :          * promotion would cause this dataset to leave its encryption root.
<span class="lineNum">    2416 </span>                :            :          * Force the origin to become an encryption root and try again.
<span class="lineNum">    2417 </span>                :            :          */
<span class="lineNum">    2418 </span>                :<span class="lineCov">          1 :         err = zfs_ioctl(hdl, ZFS_IOC_PROMOTE, &amp;zc);</span>
<span class="lineNum">    2419 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :         if (err == EACCES) {</span>
<span class="lineNum">    2420 </span>                :<span class="lineNoCov">          0 :                 zhp = zfs_open(hdl, fsname, ZFS_TYPE_DATASET);</span>
<span class="lineNum">    2421 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (zhp == NULL) {</span>
<span class="lineNum">    2422 </span>                :            :                         err = -1;
<span class="lineNum">    2423 </span>                :            :                         goto out;
<span class="lineNum">    2424 </span>                :            :                 }
<span class="lineNum">    2425 </span>                :            : 
<span class="lineNum">    2426 </span>                :<span class="lineNoCov">          0 :                 ozhp = recv_open_grand_origin(zhp);</span>
<span class="lineNum">    2427 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (ozhp == NULL) {</span>
<span class="lineNum">    2428 </span>                :            :                         err = -1;
<span class="lineNum">    2429 </span>                :            :                         goto out;
<span class="lineNum">    2430 </span>                :            :                 }
<span class="lineNum">    2431 </span>                :            : 
<span class="lineNum">    2432 </span>                :<span class="lineNoCov">          0 :                 err = lzc_change_key(ozhp-&gt;zfs_name, DCP_CMD_FORCE_NEW_KEY,</span>
<span class="lineNum">    2433 </span>                :            :                     NULL, NULL, 0);
<span class="lineNum">    2434 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (err != 0)</span>
<span class="lineNum">    2435 </span>                :            :                         goto out;
<span class="lineNum">    2436 </span>                :            : 
<span class="lineNum">    2437 </span>                :<span class="lineNoCov">          0 :                 err = zfs_ioctl(hdl, ZFS_IOC_PROMOTE, &amp;zc);</span>
<span class="lineNum">    2438 </span>                :            :         }
<span class="lineNum">    2439 </span>                :            : 
<span class="lineNum">    2440 </span>                :            : out:
<span class="lineNum">    2441 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :         if (zhp != NULL)</span>
<span class="lineNum">    2442 </span>                :<span class="lineNoCov">          0 :                 zfs_close(zhp);</span>
<span class="lineNum">    2443 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :         if (ozhp != NULL)</span>
<span class="lineNum">    2444 </span>                :<span class="lineNoCov">          0 :                 zfs_close(ozhp);</span>
<span class="lineNum">    2445 </span>                :            : 
<span class="lineNum">    2446 </span>                :<span class="lineCov">          1 :         return (err);</span>
<span class="lineNum">    2447 </span>                :            : }
<a name="2448"><span class="lineNum">    2448 </span>                :            : </a>
<span class="lineNum">    2449 </span>                :            : static int
<span class="lineNum">    2450 </span>                :<span class="lineCov">         41 : recv_destroy(libzfs_handle_t *hdl, const char *name, int baselen,</span>
<span class="lineNum">    2451 </span>                :            :     char *newname, recvflags_t *flags)
<span class="lineNum">    2452 </span>                :            : {
<span class="lineNum">    2453 </span>                :<span class="lineCov">         41 :         zfs_cmd_t zc = {&quot;\0&quot;};</span>
<span class="lineNum">    2454 </span>                :<span class="lineCov">         41 :         int err = 0;</span>
<span class="lineNum">    2455 </span>                :            :         prop_changelist_t *clp;
<span class="lineNum">    2456 </span>                :            :         zfs_handle_t *zhp;
<span class="lineNum">    2457 </span>                :<span class="lineCov">         41 :         boolean_t defer = B_FALSE;</span>
<span class="lineNum">    2458 </span>                :            :         int spa_version;
<span class="lineNum">    2459 </span>                :            : 
<span class="lineNum">    2460 </span>                :<span class="lineCov">         41 :         zhp = zfs_open(hdl, name, ZFS_TYPE_DATASET);</span>
<span class="lineNum">    2461 </span>        [<span class="branchCov" title="Branch 0 was taken 41 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         41 :         if (zhp == NULL)</span>
<span class="lineNum">    2462 </span>                :            :                 return (-1);
<span class="lineNum">    2463 </span>                :<span class="lineCov">         41 :         clp = changelist_gather(zhp, ZFS_PROP_NAME, 0,</span>
<span class="lineNum">    2464 </span>                :<span class="lineCov">         41 :             flags-&gt;force ? MS_FORCE : 0);</span>
<span class="lineNum">    2465 </span>  [<span class="branchCov" title="Branch 1 was taken 29 times"> + </span><span class="branchCov" title="Branch 2 was taken 12 times"> + </span><span class="branchCov" title="Branch 3 was taken 29 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         70 :         if (zfs_get_type(zhp) == ZFS_TYPE_SNAPSHOT &amp;&amp;</span>
<span class="lineNum">    2466 </span>        [<span class="branchCov" title="Branch 1 was taken 29 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         58 :             zfs_spa_version(zhp, &amp;spa_version) == 0 &amp;&amp;</span>
<span class="lineNum">    2467 </span>                :<span class="lineCov">         29 :             spa_version &gt;= SPA_VERSION_USERREFS)</span>
<span class="lineNum">    2468 </span>                :<span class="lineCov">         29 :                 defer = B_TRUE;</span>
<span class="lineNum">    2469 </span>                :<span class="lineCov">         41 :         zfs_close(zhp);</span>
<span class="lineNum">    2470 </span>        [<span class="branchCov" title="Branch 0 was taken 41 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         41 :         if (clp == NULL)</span>
<span class="lineNum">    2471 </span>                :            :                 return (-1);
<span class="lineNum">    2472 </span>                :<span class="lineCov">         41 :         err = changelist_prefix(clp);</span>
<span class="lineNum">    2473 </span>        [<span class="branchCov" title="Branch 0 was taken 41 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         41 :         if (err)</span>
<span class="lineNum">    2474 </span>                :            :                 return (err);
<span class="lineNum">    2475 </span>                :            : 
<span class="lineNum">    2476 </span>                :<span class="lineCov">         41 :         zc.zc_objset_type = DMU_OST_ZFS;</span>
<span class="lineNum">    2477 </span>                :<span class="lineCov">         41 :         zc.zc_defer_destroy = defer;</span>
<span class="lineNum">    2478 </span>                :<span class="lineCov">         41 :         (void) strlcpy(zc.zc_name, name, sizeof (zc.zc_name));</span>
<span class="lineNum">    2479 </span>                :            : 
<span class="lineNum">    2480 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 41 times"> + </span>]:<span class="lineCov">         41 :         if (flags-&gt;verbose)</span>
<span class="lineNum">    2481 </span>                :            :                 (void) printf(&quot;attempting destroy %s\n&quot;, zc.zc_name);
<span class="lineNum">    2482 </span>                :<span class="lineCov">         41 :         err = ioctl(hdl-&gt;libzfs_fd, ZFS_IOC_DESTROY, &amp;zc);</span>
<span class="lineNum">    2483 </span>        [<span class="branchCov" title="Branch 0 was taken 37 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">         41 :         if (err == 0) {</span>
<span class="lineNum">    2484 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 37 times"> + </span>]:<span class="lineCov">         37 :                 if (flags-&gt;verbose)</span>
<span class="lineNum">    2485 </span>                :            :                         (void) printf(&quot;success\n&quot;);
<span class="lineNum">    2486 </span>                :<span class="lineCov">         37 :                 changelist_remove(clp, zc.zc_name);</span>
<span class="lineNum">    2487 </span>                :            :         }
<span class="lineNum">    2488 </span>                :            : 
<span class="lineNum">    2489 </span>                :<span class="lineCov">         41 :         (void) changelist_postfix(clp);</span>
<span class="lineNum">    2490 </span>                :<span class="lineCov">         41 :         changelist_free(clp);</span>
<span class="lineNum">    2491 </span>                :            : 
<span class="lineNum">    2492 </span>                :            :         /*
<span class="lineNum">    2493 </span>                :            :          * Deferred destroy might destroy the snapshot or only mark it to be
<span class="lineNum">    2494 </span>                :            :          * destroyed later, and it returns success in either case.
<span class="lineNum">    2495 </span>                :            :          */
<span class="lineNum">    2496 </span>[<span class="branchCov" title="Branch 0 was taken 37 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 29 times"> + </span><span class="branchCov" title="Branch 3 was taken 8 times"> + </span>]:<span class="lineCov">         41 :         if (err != 0 || (defer &amp;&amp; zfs_dataset_exists(hdl, name,</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 5 was taken 1 time"> + </span><span class="branchCov" title="Branch 6 was taken 28 times"> + </span>]
<span class="lineNum">    2497 </span>                :            :             ZFS_TYPE_SNAPSHOT))) {
<span class="lineNum">    2498 </span>                :<span class="lineCov">          5 :                 err = recv_rename(hdl, name, NULL, baselen, newname, flags);</span>
<span class="lineNum">    2499 </span>                :            :         }
<span class="lineNum">    2500 </span>                :            : 
<span class="lineNum">    2501 </span>                :            :         return (err);
<span class="lineNum">    2502 </span>                :            : }
<span class="lineNum">    2503 </span>                :            : 
<span class="lineNum">    2504 </span>                :            : typedef struct guid_to_name_data {
<span class="lineNum">    2505 </span>                :            :         uint64_t guid;
<span class="lineNum">    2506 </span>                :            :         boolean_t bookmark_ok;
<span class="lineNum">    2507 </span>                :            :         char *name;
<span class="lineNum">    2508 </span>                :            :         char *skip;
<span class="lineNum">    2509 </span>                :            : } guid_to_name_data_t;
<a name="2510"><span class="lineNum">    2510 </span>                :            : </a>
<span class="lineNum">    2511 </span>                :            : static int
<span class="lineNum">    2512 </span>                :<span class="lineCov">       1000 : guid_to_name_cb(zfs_handle_t *zhp, void *arg)</span>
<span class="lineNum">    2513 </span>                :            : {
<span class="lineNum">    2514 </span>                :<span class="lineCov">       1000 :         guid_to_name_data_t *gtnd = arg;</span>
<span class="lineNum">    2515 </span>                :            :         const char *slash;
<span class="lineNum">    2516 </span>                :            :         int err;
<span class="lineNum">    2517 </span>                :            : 
<span class="lineNum">    2518 </span>[<span class="branchCov" title="Branch 0 was taken 46 times"> + </span><span class="branchCov" title="Branch 1 was taken 954 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 42 times"> + </span><span class="branchCov" title="Branch 3 was taken 4 times"> + </span>]:<span class="lineCov">       1000 :         if (gtnd-&gt;skip != NULL &amp;&amp;</span>
<span class="lineNum">    2519 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 39 times"> + </span>]:<span class="lineCov">         42 :             (slash = strrchr(zhp-&gt;zfs_name, '/')) != NULL &amp;&amp;</span>
<span class="lineNum">    2520 </span>                :<span class="lineCov">         42 :             strcmp(slash + 1, gtnd-&gt;skip) == 0) {</span>
<span class="lineNum">    2521 </span>                :<span class="lineCov">          3 :                 zfs_close(zhp);</span>
<span class="lineNum">    2522 </span>                :<span class="lineCov">          3 :                 return (0);</span>
<span class="lineNum">    2523 </span>                :            :         }
<span class="lineNum">    2524 </span>                :            : 
<span class="lineNum">    2525 </span>        [<span class="branchCov" title="Branch 1 was taken 88 times"> + </span><span class="branchCov" title="Branch 2 was taken 909 times"> + </span>]:<span class="lineCov">        997 :         if (zfs_prop_get_int(zhp, ZFS_PROP_GUID) == gtnd-&gt;guid) {</span>
<span class="lineNum">    2526 </span>                :<span class="lineCov">        176 :                 (void) strcpy(gtnd-&gt;name, zhp-&gt;zfs_name);</span>
<span class="lineNum">    2527 </span>                :<span class="lineCov">         88 :                 zfs_close(zhp);</span>
<span class="lineNum">    2528 </span>                :<span class="lineCov">         88 :                 return (EEXIST);</span>
<span class="lineNum">    2529 </span>                :            :         }
<span class="lineNum">    2530 </span>                :            : 
<span class="lineNum">    2531 </span>                :<span class="lineCov">        909 :         err = zfs_iter_children(zhp, guid_to_name_cb, gtnd);</span>
<span class="lineNum">    2532 </span>[<span class="branchCov" title="Branch 0 was taken 774 times"> + </span><span class="branchCov" title="Branch 1 was taken 135 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 10 times"> + </span><span class="branchCov" title="Branch 3 was taken 764 times"> + </span>]:<span class="lineCov">        909 :         if (err != EEXIST &amp;&amp; gtnd-&gt;bookmark_ok)</span>
<span class="lineNum">    2533 </span>                :<span class="lineCov">         10 :                 err = zfs_iter_bookmarks(zhp, guid_to_name_cb, gtnd);</span>
<span class="lineNum">    2534 </span>                :<span class="lineCov">        909 :         zfs_close(zhp);</span>
<span class="lineNum">    2535 </span>                :<span class="lineCov">        909 :         return (err);</span>
<span class="lineNum">    2536 </span>                :            : }
<span class="lineNum">    2537 </span>                :            : 
<span class="lineNum">    2538 </span>                :            : /*
<span class="lineNum">    2539 </span>                :            :  * Attempt to find the local dataset associated with this guid.  In the case of
<span class="lineNum">    2540 </span>                :            :  * multiple matches, we attempt to find the &quot;best&quot; match by searching
<span class="lineNum">    2541 </span>                :            :  * progressively larger portions of the hierarchy.  This allows one to send a
<span class="lineNum">    2542 </span>                :            :  * tree of datasets individually and guarantee that we will find the source
<span class="lineNum">    2543 </span>                :            :  * guid within that hierarchy, even if there are multiple matches elsewhere.
<a name="2544"><span class="lineNum">    2544 </span>                :            :  */</a>
<span class="lineNum">    2545 </span>                :            : static int
<span class="lineNum">    2546 </span>                :<span class="lineCov">         89 : guid_to_name(libzfs_handle_t *hdl, const char *parent, uint64_t guid,</span>
<span class="lineNum">    2547 </span>                :            :     boolean_t bookmark_ok, char *name)
<span class="lineNum">    2548 </span>                :            : {
<span class="lineNum">    2549 </span>                :            :         char pname[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    2550 </span>                :            :         guid_to_name_data_t gtnd;
<span class="lineNum">    2551 </span>                :            : 
<span class="lineNum">    2552 </span>                :<span class="lineCov">         89 :         gtnd.guid = guid;</span>
<span class="lineNum">    2553 </span>                :<span class="lineCov">         89 :         gtnd.bookmark_ok = bookmark_ok;</span>
<span class="lineNum">    2554 </span>                :<span class="lineCov">         89 :         gtnd.name = name;</span>
<span class="lineNum">    2555 </span>                :<span class="lineCov">         89 :         gtnd.skip = NULL;</span>
<span class="lineNum">    2556 </span>                :            : 
<span class="lineNum">    2557 </span>                :            :         /*
<span class="lineNum">    2558 </span>                :            :          * Search progressively larger portions of the hierarchy, starting
<span class="lineNum">    2559 </span>                :            :          * with the filesystem specified by 'parent'.  This will
<span class="lineNum">    2560 </span>                :            :          * select the &quot;most local&quot; version of the origin snapshot in the case
<span class="lineNum">    2561 </span>                :            :          * that there are multiple matching snapshots in the system.
<span class="lineNum">    2562 </span>                :            :          */
<span class="lineNum">    2563 </span>                :<span class="lineCov">         89 :         (void) strlcpy(pname, parent, sizeof (pname));</span>
<span class="lineNum">    2564 </span>                :<span class="lineCov">         89 :         char *cp = strrchr(pname, '@');</span>
<span class="lineNum">    2565 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 80 times"> + </span>]:<span class="lineCov">         89 :         if (cp == NULL)</span>
<span class="lineNum">    2566 </span>                :<span class="lineCov">         89 :                 cp = strchr(pname, '\0');</span>
<span class="lineNum">    2567 </span>        [<span class="branchCov" title="Branch 0 was taken 151 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">        152 :         for (; cp != NULL; cp = strrchr(pname, '/')) {</span>
<span class="lineNum">    2568 </span>                :            :                 /* Chop off the last component and open the parent */
<span class="lineNum">    2569 </span>                :<span class="lineCov">        151 :                 *cp = '\0';</span>
<span class="lineNum">    2570 </span>                :<span class="lineCov">        151 :                 zfs_handle_t *zhp = make_dataset_handle(hdl, pname);</span>
<span class="lineNum">    2571 </span>                :            : 
<span class="lineNum">    2572 </span>        [<span class="branchCov" title="Branch 0 was taken 59 times"> + </span><span class="branchCov" title="Branch 1 was taken 92 times"> + </span>]:<span class="lineCov">        151 :                 if (zhp == NULL)</span>
<span class="lineNum">    2573 </span>                :<span class="lineCov">         59 :                         continue;</span>
<span class="lineNum">    2574 </span>                :<span class="lineCov">         92 :                 int err = guid_to_name_cb(zfs_handle_dup(zhp), &amp;gtnd);</span>
<span class="lineNum">    2575 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 88 times"> + </span>]:<span class="lineCov">         92 :                 if (err != EEXIST)</span>
<span class="lineNum">    2576 </span>                :<span class="lineCov">          4 :                         err = zfs_iter_children(zhp, guid_to_name_cb, &amp;gtnd);</span>
<span class="lineNum">    2577 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 92 times"> + </span>]:<span class="lineCov">         92 :                 if (err != EEXIST &amp;&amp; bookmark_ok)</span>
<span class="lineNum">    2578 </span>                :<span class="lineNoCov">          0 :                         err = zfs_iter_bookmarks(zhp, guid_to_name_cb, &amp;gtnd);</span>
<span class="lineNum">    2579 </span>                :<span class="lineCov">         92 :                 zfs_close(zhp);</span>
<span class="lineNum">    2580 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 88 times"> + </span>]:<span class="lineCov">         92 :                 if (err == EEXIST)</span>
<span class="lineNum">    2581 </span>                :            :                         return (0);
<span class="lineNum">    2582 </span>                :            : 
<span class="lineNum">    2583 </span>                :            :                 /*
<span class="lineNum">    2584 </span>                :            :                  * Remember the last portion of the dataset so we skip it next
<span class="lineNum">    2585 </span>                :            :                  * time through (as we've already searched that portion of the
<span class="lineNum">    2586 </span>                :            :                  * hierarchy).
<span class="lineNum">    2587 </span>                :            :                  */
<span class="lineNum">    2588 </span>                :<span class="lineCov">          4 :                 gtnd.skip = strrchr(pname, '/') + 1;</span>
<span class="lineNum">    2589 </span>                :            :         }
<span class="lineNum">    2590 </span>                :            : 
<span class="lineNum">    2591 </span>                :            :         return (ENOENT);
<span class="lineNum">    2592 </span>                :            : }
<span class="lineNum">    2593 </span>                :            : 
<span class="lineNum">    2594 </span>                :            : /*
<span class="lineNum">    2595 </span>                :            :  * Return +1 if guid1 is before guid2, 0 if they are the same, and -1 if
<span class="lineNum">    2596 </span>                :            :  * guid1 is after guid2.
<a name="2597"><span class="lineNum">    2597 </span>                :            :  */</a>
<span class="lineNum">    2598 </span>                :            : static int
<span class="lineNum">    2599 </span>                :<span class="lineCov">          1 : created_before(libzfs_handle_t *hdl, avl_tree_t *avl,</span>
<span class="lineNum">    2600 </span>                :            :     uint64_t guid1, uint64_t guid2)
<span class="lineNum">    2601 </span>                :            : {
<span class="lineNum">    2602 </span>                :            :         nvlist_t *nvfs;
<span class="lineNum">    2603 </span>                :<span class="lineCov">          1 :         char *fsname = NULL, *snapname = NULL;</span>
<span class="lineNum">    2604 </span>                :            :         char buf[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    2605 </span>                :            :         int rv;
<span class="lineNum">    2606 </span>                :            :         zfs_handle_t *guid1hdl, *guid2hdl;
<span class="lineNum">    2607 </span>                :            :         uint64_t create1, create2;
<span class="lineNum">    2608 </span>                :            : 
<span class="lineNum">    2609 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :         if (guid2 == 0)</span>
<span class="lineNum">    2610 </span>                :            :                 return (0);
<span class="lineNum">    2611 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :         if (guid1 == 0)</span>
<span class="lineNum">    2612 </span>                :            :                 return (1);
<span class="lineNum">    2613 </span>                :            : 
<span class="lineNum">    2614 </span>                :<span class="lineNoCov">          0 :         nvfs = fsavl_find(avl, guid1, &amp;snapname);</span>
<span class="lineNum">    2615 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         VERIFY(0 == nvlist_lookup_string(nvfs, &quot;name&quot;, &amp;fsname));</span>
<span class="lineNum">    2616 </span>                :<span class="lineNoCov">          0 :         (void) snprintf(buf, sizeof (buf), &quot;%s@%s&quot;, fsname, snapname);</span>
<span class="lineNum">    2617 </span>                :<span class="lineNoCov">          0 :         guid1hdl = zfs_open(hdl, buf, ZFS_TYPE_SNAPSHOT);</span>
<span class="lineNum">    2618 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (guid1hdl == NULL)</span>
<span class="lineNum">    2619 </span>                :            :                 return (-1);
<span class="lineNum">    2620 </span>                :            : 
<span class="lineNum">    2621 </span>                :<span class="lineNoCov">          0 :         nvfs = fsavl_find(avl, guid2, &amp;snapname);</span>
<span class="lineNum">    2622 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         VERIFY(0 == nvlist_lookup_string(nvfs, &quot;name&quot;, &amp;fsname));</span>
<span class="lineNum">    2623 </span>                :<span class="lineNoCov">          0 :         (void) snprintf(buf, sizeof (buf), &quot;%s@%s&quot;, fsname, snapname);</span>
<span class="lineNum">    2624 </span>                :<span class="lineNoCov">          0 :         guid2hdl = zfs_open(hdl, buf, ZFS_TYPE_SNAPSHOT);</span>
<span class="lineNum">    2625 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (guid2hdl == NULL) {</span>
<span class="lineNum">    2626 </span>                :<span class="lineNoCov">          0 :                 zfs_close(guid1hdl);</span>
<span class="lineNum">    2627 </span>                :<span class="lineNoCov">          0 :                 return (-1);</span>
<span class="lineNum">    2628 </span>                :            :         }
<span class="lineNum">    2629 </span>                :            : 
<span class="lineNum">    2630 </span>                :<span class="lineNoCov">          0 :         create1 = zfs_prop_get_int(guid1hdl, ZFS_PROP_CREATETXG);</span>
<span class="lineNum">    2631 </span>                :<span class="lineNoCov">          0 :         create2 = zfs_prop_get_int(guid2hdl, ZFS_PROP_CREATETXG);</span>
<span class="lineNum">    2632 </span>                :            : 
<span class="lineNum">    2633 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (create1 &lt; create2)</span>
<span class="lineNum">    2634 </span>                :            :                 rv = -1;
<span class="lineNum">    2635 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         else if (create1 &gt; create2)</span>
<span class="lineNum">    2636 </span>                :            :                 rv = +1;
<span class="lineNum">    2637 </span>                :            :         else
<span class="lineNum">    2638 </span>                :<span class="lineNoCov">          0 :                 rv = 0;</span>
<span class="lineNum">    2639 </span>                :            : 
<span class="lineNum">    2640 </span>                :<span class="lineNoCov">          0 :         zfs_close(guid1hdl);</span>
<span class="lineNum">    2641 </span>                :<span class="lineNoCov">          0 :         zfs_close(guid2hdl);</span>
<span class="lineNum">    2642 </span>                :            : 
<span class="lineNum">    2643 </span>                :<span class="lineNoCov">          0 :         return (rv);</span>
<span class="lineNum">    2644 </span>                :            : }
<span class="lineNum">    2645 </span>                :            : 
<span class="lineNum">    2646 </span>                :            : /*
<span class="lineNum">    2647 </span>                :            :  * This function reestablishes the heirarchy of encryption roots after a
<span class="lineNum">    2648 </span>                :            :  * recursive incremental receive has completed. This must be done after the
<span class="lineNum">    2649 </span>                :            :  * second call to recv_incremental_replication() has renamed and promoted all
<span class="lineNum">    2650 </span>                :            :  * sent datasets to their final locations in the dataset heriarchy.
<a name="2651"><span class="lineNum">    2651 </span>                :            :  */</a>
<span class="lineNum">    2652 </span>                :            : static int
<span class="lineNum">    2653 </span>                :<span class="lineCov">          2 : recv_fix_encryption_heirarchy(libzfs_handle_t *hdl, const char *destname,</span>
<span class="lineNum">    2654 </span>                :            :     nvlist_t *stream_nv, avl_tree_t *stream_avl)
<span class="lineNum">    2655 </span>                :            : {
<span class="lineNum">    2656 </span>                :            :         int err;
<span class="lineNum">    2657 </span>                :<span class="lineCov">          2 :         nvpair_t *fselem = NULL;</span>
<span class="lineNum">    2658 </span>                :            :         nvlist_t *stream_fss;
<span class="lineNum">    2659 </span>                :            : 
<span class="lineNum">    2660 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          2 :         VERIFY(0 == nvlist_lookup_nvlist(stream_nv, &quot;fss&quot;, &amp;stream_fss));</span>
<span class="lineNum">    2661 </span>                :            : 
<span class="lineNum">    2662 </span>        [<span class="branchCov" title="Branch 1 was taken 8 times"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span>]:<span class="lineCov">         10 :         while ((fselem = nvlist_next_nvpair(stream_fss, fselem)) != NULL) {</span>
<span class="lineNum">    2663 </span>                :<span class="lineCov">          8 :                 zfs_handle_t *zhp = NULL;</span>
<span class="lineNum">    2664 </span>                :            :                 uint64_t crypt;
<span class="lineNum">    2665 </span>                :<span class="lineCov">          8 :                 nvlist_t *snaps, *props, *stream_nvfs = NULL;</span>
<span class="lineNum">    2666 </span>                :<span class="lineCov">          8 :                 nvpair_t *snapel = NULL;</span>
<span class="lineNum">    2667 </span>                :            :                 boolean_t is_encroot, is_clone, stream_encroot;
<span class="lineNum">    2668 </span>                :            :                 char *cp;
<span class="lineNum">    2669 </span>                :<span class="lineCov">          8 :                 char *stream_keylocation = NULL;</span>
<span class="lineNum">    2670 </span>                :            :                 char keylocation[MAXNAMELEN];
<span class="lineNum">    2671 </span>                :            :                 char fsname[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    2672 </span>                :            : 
<span class="lineNum">    2673 </span>                :<span class="lineCov">          8 :                 keylocation[0] = '\0';</span>
<span class="lineNum">    2674 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 8 times"> + </span>]:<span class="lineCov">          8 :                 VERIFY(0 == nvpair_value_nvlist(fselem, &amp;stream_nvfs));</span>
<span class="lineNum">    2675 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 8 times"> + </span>]:<span class="lineCov">          8 :                 VERIFY(0 == nvlist_lookup_nvlist(stream_nvfs, &quot;snaps&quot;, &amp;snaps));</span>
<span class="lineNum">    2676 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 8 times"> + </span>]:<span class="lineCov">          8 :                 VERIFY(0 == nvlist_lookup_nvlist(stream_nvfs, &quot;props&quot;, &amp;props));</span>
<span class="lineNum">    2677 </span>                :<span class="lineCov">          8 :                 stream_encroot = nvlist_exists(stream_nvfs, &quot;is_encroot&quot;);</span>
<span class="lineNum">    2678 </span>                :            : 
<span class="lineNum">    2679 </span>                :            :                 /* find a snapshot from the stream that exists locally */
<span class="lineNum">    2680 </span>                :<span class="lineCov">          8 :                 err = ENOENT;</span>
<span class="lineNum">    2681 </span>        [<span class="branchCov" title="Branch 1 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          8 :                 while ((snapel = nvlist_next_nvpair(snaps, snapel)) != NULL) {</span>
<span class="lineNum">    2682 </span>                :            :                         uint64_t guid;
<span class="lineNum">    2683 </span>                :            : 
<span class="lineNum">    2684 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 8 times"> + </span>]:<span class="lineCov">          8 :                         VERIFY(0 == nvpair_value_uint64(snapel, &amp;guid));</span>
<span class="lineNum">    2685 </span>                :<span class="lineCov">          8 :                         err = guid_to_name(hdl, destname, guid, B_FALSE,</span>
<span class="lineNum">    2686 </span>                :            :                             fsname);
<span class="lineNum">    2687 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">          8 :                         if (err == 0)</span>
<span class="lineNum">    2688 </span>                :            :                                 break;
<span class="lineNum">    2689 </span>                :            :                 }
<span class="lineNum">    2690 </span>                :            : 
<span class="lineNum">    2691 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">          8 :                 if (err != 0)</span>
<span class="lineNum">    2692 </span>                :<span class="lineCov">          2 :                         continue;</span>
<span class="lineNum">    2693 </span>                :            : 
<span class="lineNum">    2694 </span>                :<span class="lineCov">          8 :                 cp = strchr(fsname, '@');</span>
<span class="lineNum">    2695 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          8 :                 if (cp != NULL)</span>
<span class="lineNum">    2696 </span>                :<span class="lineCov">          8 :                         *cp = '\0';</span>
<span class="lineNum">    2697 </span>                :            : 
<span class="lineNum">    2698 </span>                :<span class="lineCov">          8 :                 zhp = zfs_open(hdl, fsname, ZFS_TYPE_DATASET);</span>
<span class="lineNum">    2699 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          8 :                 if (zhp == NULL) {</span>
<span class="lineNum">    2700 </span>                :            :                         err = ENOENT;
<span class="lineNum">    2701 </span>                :<span class="lineCov">          8 :                         goto error;</span>
<span class="lineNum">    2702 </span>                :            :                 }
<span class="lineNum">    2703 </span>                :            : 
<span class="lineNum">    2704 </span>                :<span class="lineCov">          8 :                 crypt = zfs_prop_get_int(zhp, ZFS_PROP_ENCRYPTION);</span>
<span class="lineNum">    2705 </span>                :<span class="lineCov">          8 :                 is_clone = zhp-&gt;zfs_dmustats.dds_origin[0] != '\0';</span>
<span class="lineNum">    2706 </span>                :<span class="lineCov">          8 :                 (void) zfs_crypto_get_encryption_root(zhp, &amp;is_encroot, NULL);</span>
<span class="lineNum">    2707 </span>                :            : 
<span class="lineNum">    2708 </span>                :            :                 /* we don't need to do anything for unencrypted filesystems */
<span class="lineNum">    2709 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">          8 :                 if (crypt == ZIO_CRYPT_OFF) {</span>
<span class="lineNum">    2710 </span>                :<span class="lineCov">          2 :                         zfs_close(zhp);</span>
<span class="lineNum">    2711 </span>                :<span class="lineCov">          2 :                         continue;</span>
<span class="lineNum">    2712 </span>                :            :                 }
<span class="lineNum">    2713 </span>                :            : 
<span class="lineNum">    2714 </span>                :            :                 /*
<span class="lineNum">    2715 </span>                :            :                  * If the dataset is flagged as an encryption root, was not
<span class="lineNum">    2716 </span>                :            :                  * received as a clone and is not currently an encryption root,
<span class="lineNum">    2717 </span>                :            :                  * force it to become one. Fixup the keylocation if necessary.
<span class="lineNum">    2718 </span>                :            :                  */
<span class="lineNum">    2719 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          6 :                 if (stream_encroot) {</span>
<span class="lineNum">    2720 </span>[<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchCov" title="Branch 3 was taken 2 times"> + </span>]:<span class="lineCov">          3 :                         if (!is_clone &amp;&amp; !is_encroot) {</span>
<span class="lineNum">    2721 </span>                :<span class="lineCov">          1 :                                 err = lzc_change_key(fsname,</span>
<span class="lineNum">    2722 </span>                :            :                                     DCP_CMD_FORCE_NEW_KEY, NULL, NULL, 0);
<span class="lineNum">    2723 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                                 if (err != 0) {</span>
<span class="lineNum">    2724 </span>                :<span class="lineNoCov">          0 :                                         zfs_close(zhp);</span>
<span class="lineNum">    2725 </span>                :            :                                         goto error;
<span class="lineNum">    2726 </span>                :            :                                 }
<span class="lineNum">    2727 </span>                :            :                         }
<span class="lineNum">    2728 </span>                :            : 
<span class="lineNum">    2729 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 3 times"> + </span>]:<span class="lineCov">          3 :                         VERIFY(0 == nvlist_lookup_string(props,</span>
<span class="lineNum">    2730 </span>                :            :                             zfs_prop_to_name(ZFS_PROP_KEYLOCATION),
<span class="lineNum">    2731 </span>                :            :                             &amp;stream_keylocation));
<span class="lineNum">    2732 </span>                :            : 
<span class="lineNum">    2733 </span>                :            :                         /*
<span class="lineNum">    2734 </span>                :            :                          * Refresh the properties in case the call to
<span class="lineNum">    2735 </span>                :            :                          * lzc_change_key() changed the value.
<span class="lineNum">    2736 </span>                :            :                          */
<span class="lineNum">    2737 </span>                :<span class="lineCov">          3 :                         zfs_refresh_properties(zhp);</span>
<span class="lineNum">    2738 </span>                :<span class="lineCov">          3 :                         err = zfs_prop_get(zhp, ZFS_PROP_KEYLOCATION,</span>
<span class="lineNum">    2739 </span>                :            :                             keylocation, sizeof (keylocation), NULL, NULL,
<span class="lineNum">    2740 </span>                :            :                             0, B_TRUE);
<span class="lineNum">    2741 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          3 :                         if (err != 0) {</span>
<span class="lineNum">    2742 </span>                :<span class="lineNoCov">          0 :                                 zfs_close(zhp);</span>
<span class="lineNum">    2743 </span>                :            :                                 goto error;
<span class="lineNum">    2744 </span>                :            :                         }
<span class="lineNum">    2745 </span>                :            : 
<span class="lineNum">    2746 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          3 :                         if (strcmp(keylocation, stream_keylocation) != 0) {</span>
<span class="lineNum">    2747 </span>                :<span class="lineNoCov">          0 :                                 err = zfs_prop_set(zhp,</span>
<span class="lineNum">    2748 </span>                :            :                                     zfs_prop_to_name(ZFS_PROP_KEYLOCATION),
<span class="lineNum">    2749 </span>                :            :                                     stream_keylocation);
<span class="lineNum">    2750 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (err != 0) {</span>
<span class="lineNum">    2751 </span>                :<span class="lineNoCov">          0 :                                         zfs_close(zhp);</span>
<span class="lineNum">    2752 </span>                :            :                                         goto error;
<span class="lineNum">    2753 </span>                :            :                                 }
<span class="lineNum">    2754 </span>                :            :                         }
<span class="lineNum">    2755 </span>                :            :                 }
<span class="lineNum">    2756 </span>                :            : 
<span class="lineNum">    2757 </span>                :            :                 /*
<span class="lineNum">    2758 </span>                :            :                  * If the dataset is not flagged as an encryption root and is
<span class="lineNum">    2759 </span>                :            :                  * currently an encryption root, force it to inherit from its
<span class="lineNum">    2760 </span>                :            :                  * parent.
<span class="lineNum">    2761 </span>                :            :                  */
<span class="lineNum">    2762 </span>[<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchCov" title="Branch 3 was taken 2 times"> + </span>]:<span class="lineCov">          6 :                 if (!stream_encroot &amp;&amp; is_encroot) {</span>
<span class="lineNum">    2763 </span>                :<span class="lineCov">          1 :                         err = lzc_change_key(fsname, DCP_CMD_FORCE_INHERIT,</span>
<span class="lineNum">    2764 </span>                :            :                             NULL, NULL, 0);
<span class="lineNum">    2765 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                         if (err != 0) {</span>
<span class="lineNum">    2766 </span>                :<span class="lineNoCov">          0 :                                 zfs_close(zhp);</span>
<span class="lineNum">    2767 </span>                :            :                                 goto error;
<span class="lineNum">    2768 </span>                :            :                         }
<span class="lineNum">    2769 </span>                :            :                 }
<span class="lineNum">    2770 </span>                :            : 
<span class="lineNum">    2771 </span>                :<span class="lineCov">          6 :                 zfs_close(zhp);</span>
<span class="lineNum">    2772 </span>                :            :         }
<span class="lineNum">    2773 </span>                :            : 
<span class="lineNum">    2774 </span>                :            :         return (0);
<span class="lineNum">    2775 </span>                :            : 
<span class="lineNum">    2776 </span>                :            : error:
<span class="lineNum">    2777 </span>                :            :         return (err);
<span class="lineNum">    2778 </span>                :            : }
<a name="2779"><span class="lineNum">    2779 </span>                :            : </a>
<span class="lineNum">    2780 </span>                :            : static int
<span class="lineNum">    2781 </span>                :<span class="lineCov">         34 : recv_incremental_replication(libzfs_handle_t *hdl, const char *tofs,</span>
<span class="lineNum">    2782 </span>                :            :     recvflags_t *flags, nvlist_t *stream_nv, avl_tree_t *stream_avl,
<span class="lineNum">    2783 </span>                :            :     nvlist_t *renamed)
<span class="lineNum">    2784 </span>                :            : {
<span class="lineNum">    2785 </span>                :<span class="lineCov">         34 :         nvlist_t *local_nv, *deleted = NULL;</span>
<span class="lineNum">    2786 </span>                :            :         avl_tree_t *local_avl;
<span class="lineNum">    2787 </span>                :            :         nvpair_t *fselem, *nextfselem;
<span class="lineNum">    2788 </span>                :            :         char *fromsnap;
<span class="lineNum">    2789 </span>                :            :         char newname[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    2790 </span>                :            :         char guidname[32];
<span class="lineNum">    2791 </span>                :            :         int error;
<span class="lineNum">    2792 </span>                :            :         boolean_t needagain, progress, recursive;
<span class="lineNum">    2793 </span>                :            :         char *s1, *s2;
<span class="lineNum">    2794 </span>                :            : 
<span class="lineNum">    2795 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 34 times"> + </span>]:<span class="lineCov">         34 :         VERIFY(0 == nvlist_lookup_string(stream_nv, &quot;fromsnap&quot;, &amp;fromsnap));</span>
<span class="lineNum">    2796 </span>                :            : 
<span class="lineNum">    2797 </span>                :<span class="lineCov">         34 :         recursive = (nvlist_lookup_boolean(stream_nv, &quot;not_recursive&quot;) ==</span>
<span class="lineNum">    2798 </span>                :            :             ENOENT);
<span class="lineNum">    2799 </span>                :            : 
<span class="lineNum">    2800 </span>        [<span class="branchCov" title="Branch 0 was taken 34 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         34 :         if (flags-&gt;dryrun)</span>
<span class="lineNum">    2801 </span>                :            :                 return (0);
<span class="lineNum">    2802 </span>                :            : 
<span class="lineNum">    2803 </span>                :            : again:
<span class="lineNum">    2804 </span>                :<span class="lineCov">         37 :         needagain = progress = B_FALSE;</span>
<span class="lineNum">    2805 </span>                :            : 
<span class="lineNum">    2806 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 37 times"> + </span>]:<span class="lineCov">         37 :         VERIFY(0 == nvlist_alloc(&amp;deleted, NV_UNIQUE_NAME, 0));</span>
<span class="lineNum">    2807 </span>                :            : 
<span class="lineNum">    2808 </span>        [<span class="branchCov" title="Branch 1 was taken 37 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         37 :         if ((error = gather_nvlist(hdl, tofs, fromsnap, NULL,</span>
<span class="lineNum">    2809 </span>                :            :             recursive, B_TRUE, B_FALSE, &amp;local_nv, &amp;local_avl)) != 0)
<span class="lineNum">    2810 </span>                :            :                 return (error);
<span class="lineNum">    2811 </span>                :            : 
<span class="lineNum">    2812 </span>                :            :         /*
<span class="lineNum">    2813 </span>                :            :          * Process deletes and renames
<span class="lineNum">    2814 </span>                :            :          */
<span class="lineNum">    2815 </span>        [<span class="branchCov" title="Branch 1 was taken 160 times"> + </span><span class="branchCov" title="Branch 2 was taken 37 times"> + </span>]:<span class="lineCov">        197 :         for (fselem = nvlist_next_nvpair(local_nv, NULL);</span>
<span class="lineNum">    2816 </span>                :            :             fselem; fselem = nextfselem) {
<span class="lineNum">    2817 </span>                :            :                 nvlist_t *nvfs, *snaps;
<span class="lineNum">    2818 </span>                :<span class="lineCov">        160 :                 nvlist_t *stream_nvfs = NULL;</span>
<span class="lineNum">    2819 </span>                :            :                 nvpair_t *snapelem, *nextsnapelem;
<span class="lineNum">    2820 </span>                :<span class="lineCov">        160 :                 uint64_t fromguid = 0;</span>
<span class="lineNum">    2821 </span>                :<span class="lineCov">        160 :                 uint64_t originguid = 0;</span>
<span class="lineNum">    2822 </span>                :<span class="lineCov">        160 :                 uint64_t stream_originguid = 0;</span>
<span class="lineNum">    2823 </span>                :            :                 uint64_t parent_fromsnap_guid, stream_parent_fromsnap_guid;
<span class="lineNum">    2824 </span>                :            :                 char *fsname, *stream_fsname;
<span class="lineNum">    2825 </span>                :            : 
<span class="lineNum">    2826 </span>                :<span class="lineCov">        160 :                 nextfselem = nvlist_next_nvpair(local_nv, fselem);</span>
<span class="lineNum">    2827 </span>                :            : 
<span class="lineNum">    2828 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 160 times"> + </span>]:<span class="lineCov">        160 :                 VERIFY(0 == nvpair_value_nvlist(fselem, &amp;nvfs));</span>
<span class="lineNum">    2829 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 160 times"> + </span>]:<span class="lineCov">        160 :                 VERIFY(0 == nvlist_lookup_nvlist(nvfs, &quot;snaps&quot;, &amp;snaps));</span>
<span class="lineNum">    2830 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 160 times"> + </span>]:<span class="lineCov">        160 :                 VERIFY(0 == nvlist_lookup_string(nvfs, &quot;name&quot;, &amp;fsname));</span>
<span class="lineNum">    2831 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 160 times"> + </span>]:<span class="lineCov">        160 :                 VERIFY(0 == nvlist_lookup_uint64(nvfs, &quot;parentfromsnap&quot;,</span>
<span class="lineNum">    2832 </span>                :            :                     &amp;parent_fromsnap_guid));
<span class="lineNum">    2833 </span>                :<span class="lineCov">        160 :                 (void) nvlist_lookup_uint64(nvfs, &quot;origin&quot;, &amp;originguid);</span>
<span class="lineNum">    2834 </span>                :            : 
<span class="lineNum">    2835 </span>                :            :                 /*
<span class="lineNum">    2836 </span>                :            :                  * First find the stream's fs, so we can check for
<span class="lineNum">    2837 </span>                :            :                  * a different origin (due to &quot;zfs promote&quot;)
<span class="lineNum">    2838 </span>                :            :                  */
<span class="lineNum">    2839 </span>        [<span class="branchCov" title="Branch 1 was taken 177 times"> + </span><span class="branchCov" title="Branch 2 was taken 12 times"> + </span>]:<span class="lineCov">        189 :                 for (snapelem = nvlist_next_nvpair(snaps, NULL);</span>
<span class="lineNum">    2840 </span>                :<span class="lineCov">        177 :                     snapelem; snapelem = nvlist_next_nvpair(snaps, snapelem)) {</span>
<span class="lineNum">    2841 </span>                :            :                         uint64_t thisguid;
<span class="lineNum">    2842 </span>                :            : 
<span class="lineNum">    2843 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 177 times"> + </span>]:<span class="lineCov">        177 :                         VERIFY(0 == nvpair_value_uint64(snapelem, &amp;thisguid));</span>
<span class="lineNum">    2844 </span>                :<span class="lineCov">        177 :                         stream_nvfs = fsavl_find(stream_avl, thisguid, NULL);</span>
<span class="lineNum">    2845 </span>                :            : 
<span class="lineNum">    2846 </span>        [<span class="branchCov" title="Branch 0 was taken 29 times"> + </span><span class="branchCov" title="Branch 1 was taken 148 times"> + </span>]:<span class="lineCov">        177 :                         if (stream_nvfs != NULL)</span>
<span class="lineNum">    2847 </span>                :            :                                 break;
<span class="lineNum">    2848 </span>                :            :                 }
<span class="lineNum">    2849 </span>                :            : 
<span class="lineNum">    2850 </span>                :            :                 /* check for promote */
<span class="lineNum">    2851 </span>                :<span class="lineCov">        160 :                 (void) nvlist_lookup_uint64(stream_nvfs, &quot;origin&quot;,</span>
<span class="lineNum">    2852 </span>                :            :                     &amp;stream_originguid);
<span class="lineNum">    2853 </span>[<span class="branchCov" title="Branch 0 was taken 148 times"> + </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchCov" title="Branch 3 was taken 147 times"> + </span>]:<span class="lineCov">        160 :                 if (stream_nvfs &amp;&amp; originguid != stream_originguid) {</span>
<span class="lineNum">    2854 </span>     [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :                         switch (created_before(hdl, local_avl,</span>
<span class="lineNum">    2855 </span>                :            :                             stream_originguid, originguid)) {
<span class="lineNum">    2856 </span>                :            :                         case 1: {
<span class="lineNum">    2857 </span>                :            :                                 /* promote it! */
<span class="lineNum">    2858 </span>                :            :                                 nvlist_t *origin_nvfs;
<span class="lineNum">    2859 </span>                :            :                                 char *origin_fsname;
<span class="lineNum">    2860 </span>                :            : 
<span class="lineNum">    2861 </span>                :<span class="lineCov">          1 :                                 origin_nvfs = fsavl_find(local_avl, originguid,</span>
<span class="lineNum">    2862 </span>                :            :                                     NULL);
<span class="lineNum">    2863 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                                 VERIFY(0 == nvlist_lookup_string(origin_nvfs,</span>
<span class="lineNum">    2864 </span>                :            :                                     &quot;name&quot;, &amp;origin_fsname));
<span class="lineNum">    2865 </span>                :<span class="lineCov">          1 :                                 error = recv_promote(hdl, fsname, origin_fsname,</span>
<span class="lineNum">    2866 </span>                :            :                                     flags);
<span class="lineNum">    2867 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :                                 if (error == 0)</span>
<span class="lineNum">    2868 </span>                :<span class="lineCov">          1 :                                         progress = B_TRUE;</span>
<span class="lineNum">    2869 </span>                :            :                                 break;
<span class="lineNum">    2870 </span>                :            :                         }
<span class="lineNum">    2871 </span>                :            :                         default:
<span class="lineNum">    2872 </span>                :            :                                 break;
<span class="lineNum">    2873 </span>                :            :                         case -1:
<span class="lineNum">    2874 </span>                :<span class="lineNoCov">          0 :                                 fsavl_destroy(local_avl);</span>
<span class="lineNum">    2875 </span>                :<span class="lineNoCov">          0 :                                 nvlist_free(local_nv);</span>
<span class="lineNum">    2876 </span>                :<span class="lineNoCov">          0 :                                 return (-1);</span>
<span class="lineNum">    2877 </span>                :            :                         }
<span class="lineNum">    2878 </span>                :            :                         /*
<span class="lineNum">    2879 </span>                :            :                          * We had/have the wrong origin, therefore our
<span class="lineNum">    2880 </span>                :            :                          * list of snapshots is wrong.  Need to handle
<span class="lineNum">    2881 </span>                :            :                          * them on the next pass.
<span class="lineNum">    2882 </span>                :            :                          */
<span class="lineNum">    2883 </span>                :<span class="lineCov">          1 :                         needagain = B_TRUE;</span>
<span class="lineNum">    2884 </span>                :<span class="lineCov">        160 :                         continue;</span>
<span class="lineNum">    2885 </span>                :            :                 }
<span class="lineNum">    2886 </span>                :            : 
<span class="lineNum">    2887 </span>        [<span class="branchCov" title="Branch 1 was taken 343 times"> + </span><span class="branchCov" title="Branch 2 was taken 159 times"> + </span>]:<span class="lineCov">        502 :                 for (snapelem = nvlist_next_nvpair(snaps, NULL);</span>
<span class="lineNum">    2888 </span>                :            :                     snapelem; snapelem = nextsnapelem) {
<span class="lineNum">    2889 </span>                :            :                         uint64_t thisguid;
<span class="lineNum">    2890 </span>                :            :                         char *stream_snapname;
<span class="lineNum">    2891 </span>                :            :                         nvlist_t *found, *props;
<span class="lineNum">    2892 </span>                :            : 
<span class="lineNum">    2893 </span>                :<span class="lineCov">        343 :                         nextsnapelem = nvlist_next_nvpair(snaps, snapelem);</span>
<span class="lineNum">    2894 </span>                :            : 
<span class="lineNum">    2895 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 343 times"> + </span>]:<span class="lineCov">        343 :                         VERIFY(0 == nvpair_value_uint64(snapelem, &amp;thisguid));</span>
<span class="lineNum">    2896 </span>                :<span class="lineCov">        343 :                         found = fsavl_find(stream_avl, thisguid,</span>
<span class="lineNum">    2897 </span>                :            :                             &amp;stream_snapname);
<span class="lineNum">    2898 </span>                :            : 
<span class="lineNum">    2899 </span>                :            :                         /* check for delete */
<span class="lineNum">    2900 </span>        [<span class="branchCov" title="Branch 0 was taken 29 times"> + </span><span class="branchCov" title="Branch 1 was taken 314 times"> + </span>]:<span class="lineCov">        343 :                         if (found == NULL) {</span>
<span class="lineNum">    2901 </span>                :            :                                 char name[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    2902 </span>                :            : 
<span class="lineNum">    2903 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 29 times"> + </span>]:<span class="lineCov">         29 :                                 if (!flags-&gt;force)</span>
<span class="lineNum">    2904 </span>                :<span class="lineNoCov">          0 :                                         continue;</span>
<span class="lineNum">    2905 </span>                :            : 
<span class="lineNum">    2906 </span>                :<span class="lineCov">         29 :                                 (void) snprintf(name, sizeof (name), &quot;%s@%s&quot;,</span>
<span class="lineNum">    2907 </span>                :            :                                     fsname, nvpair_name(snapelem));
<span class="lineNum">    2908 </span>                :            : 
<span class="lineNum">    2909 </span>                :<span class="lineCov">         29 :                                 error = recv_destroy(hdl, name,</span>
<span class="lineNum">    2910 </span>                :<span class="lineCov">         29 :                                     strlen(fsname)+1, newname, flags);</span>
<span class="lineNum">    2911 </span>        [<span class="branchCov" title="Branch 0 was taken 28 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">         29 :                                 if (error)</span>
<span class="lineNum">    2912 </span>                :            :                                         needagain = B_TRUE;
<span class="lineNum">    2913 </span>                :            :                                 else
<span class="lineNum">    2914 </span>                :<span class="lineCov">         28 :                                         progress = B_TRUE;</span>
<span class="lineNum">    2915 </span>                :<span class="lineCov">         58 :                                 sprintf(guidname, &quot;%llu&quot;,</span>
<span class="lineNum">    2916 </span>                :            :                                     (u_longlong_t)thisguid);
<span class="lineNum">    2917 </span>                :<span class="lineCov">         29 :                                 nvlist_add_boolean(deleted, guidname);</span>
<span class="lineNum">    2918 </span>                :<span class="lineCov">         29 :                                 continue;</span>
<span class="lineNum">    2919 </span>                :            :                         }
<span class="lineNum">    2920 </span>                :            : 
<span class="lineNum">    2921 </span>                :<span class="lineCov">        314 :                         stream_nvfs = found;</span>
<span class="lineNum">    2922 </span>                :            : 
<span class="lineNum">    2923 </span>        [<span class="branchCov" title="Branch 1 was taken 314 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        314 :                         if (0 == nvlist_lookup_nvlist(stream_nvfs, &quot;snapprops&quot;,</span>
<span class="lineNum">    2924 </span>        [<span class="branchCov" title="Branch 1 was taken 314 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        314 :                             &amp;props) &amp;&amp; 0 == nvlist_lookup_nvlist(props,</span>
<span class="lineNum">    2925 </span>                :            :                             stream_snapname, &amp;props)) {
<span class="lineNum">    2926 </span>                :<span class="lineCov">        314 :                                 zfs_cmd_t zc = {&quot;\0&quot;};</span>
<span class="lineNum">    2927 </span>                :            : 
<span class="lineNum">    2928 </span>                :<span class="lineCov">        314 :                                 zc.zc_cookie = B_TRUE; /* received */</span>
<span class="lineNum">    2929 </span>                :<span class="lineCov">        314 :                                 (void) snprintf(zc.zc_name, sizeof (zc.zc_name),</span>
<span class="lineNum">    2930 </span>                :            :                                     &quot;%s@%s&quot;, fsname, nvpair_name(snapelem));
<span class="lineNum">    2931 </span>        [<span class="branchCov" title="Branch 1 was taken 314 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        314 :                                 if (zcmd_write_src_nvlist(hdl, &amp;zc,</span>
<span class="lineNum">    2932 </span>                :            :                                     props) == 0) {
<span class="lineNum">    2933 </span>                :<span class="lineCov">        314 :                                         (void) zfs_ioctl(hdl,</span>
<span class="lineNum">    2934 </span>                :            :                                             ZFS_IOC_SET_PROP, &amp;zc);
<span class="lineNum">    2935 </span>                :<span class="lineCov">        314 :                                         zcmd_free_nvlists(&amp;zc);</span>
<span class="lineNum">    2936 </span>                :            :                                 }
<span class="lineNum">    2937 </span>                :            :                         }
<span class="lineNum">    2938 </span>                :            : 
<span class="lineNum">    2939 </span>                :            :                         /* check for different snapname */
<span class="lineNum">    2940 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 314 times"> + </span>]:<span class="lineCov">        314 :                         if (strcmp(nvpair_name(snapelem),</span>
<span class="lineNum">    2941 </span>                :            :                             stream_snapname) != 0) {
<span class="lineNum">    2942 </span>                :            :                                 char name[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    2943 </span>                :            :                                 char tryname[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    2944 </span>                :            : 
<span class="lineNum">    2945 </span>                :<span class="lineNoCov">          0 :                                 (void) snprintf(name, sizeof (name), &quot;%s@%s&quot;,</span>
<span class="lineNum">    2946 </span>                :            :                                     fsname, nvpair_name(snapelem));
<span class="lineNum">    2947 </span>                :<span class="lineNoCov">          0 :                                 (void) snprintf(tryname, sizeof (name), &quot;%s@%s&quot;,</span>
<span class="lineNum">    2948 </span>                :            :                                     fsname, stream_snapname);
<span class="lineNum">    2949 </span>                :            : 
<span class="lineNum">    2950 </span>                :<span class="lineNoCov">          0 :                                 error = recv_rename(hdl, name, tryname,</span>
<span class="lineNum">    2951 </span>                :<span class="lineNoCov">          0 :                                     strlen(fsname)+1, newname, flags);</span>
<span class="lineNum">    2952 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (error)</span>
<span class="lineNum">    2953 </span>                :            :                                         needagain = B_TRUE;
<span class="lineNum">    2954 </span>                :            :                                 else
<span class="lineNum">    2955 </span>                :<span class="lineNoCov">          0 :                                         progress = B_TRUE;</span>
<span class="lineNum">    2956 </span>                :            :                         }
<span class="lineNum">    2957 </span>                :            : 
<span class="lineNum">    2958 </span>        [<span class="branchCov" title="Branch 0 was taken 147 times"> + </span><span class="branchCov" title="Branch 1 was taken 167 times"> + </span>]:<span class="lineCov">        314 :                         if (strcmp(stream_snapname, fromsnap) == 0)</span>
<span class="lineNum">    2959 </span>                :<span class="lineCov">        343 :                                 fromguid = thisguid;</span>
<span class="lineNum">    2960 </span>                :            :                 }
<span class="lineNum">    2961 </span>                :            : 
<span class="lineNum">    2962 </span>                :            :                 /* check for delete */
<span class="lineNum">    2963 </span>        [<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchCov" title="Branch 1 was taken 147 times"> + </span>]:<span class="lineCov">        159 :                 if (stream_nvfs == NULL) {</span>
<span class="lineNum">    2964 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>]:<span class="lineCov">         12 :                         if (!flags-&gt;force)</span>
<span class="lineNum">    2965 </span>                :<span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">    2966 </span>                :            : 
<span class="lineNum">    2967 </span>                :<span class="lineCov">         12 :                         error = recv_destroy(hdl, fsname, strlen(tofs)+1,</span>
<span class="lineNum">    2968 </span>                :            :                             newname, flags);
<span class="lineNum">    2969 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span>]:<span class="lineCov">         12 :                         if (error)</span>
<span class="lineNum">    2970 </span>                :            :                                 needagain = B_TRUE;
<span class="lineNum">    2971 </span>                :            :                         else
<span class="lineNum">    2972 </span>                :<span class="lineCov">          8 :                                 progress = B_TRUE;</span>
<span class="lineNum">    2973 </span>                :<span class="lineCov">         24 :                         sprintf(guidname, &quot;%llu&quot;,</span>
<span class="lineNum">    2974 </span>                :            :                             (u_longlong_t)parent_fromsnap_guid);
<span class="lineNum">    2975 </span>                :<span class="lineCov">         12 :                         nvlist_add_boolean(deleted, guidname);</span>
<span class="lineNum">    2976 </span>                :<span class="lineCov">         12 :                         continue;</span>
<span class="lineNum">    2977 </span>                :            :                 }
<span class="lineNum">    2978 </span>                :            : 
<span class="lineNum">    2979 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 147 times"> + </span>]:<span class="lineCov">        147 :                 if (fromguid == 0) {</span>
<span class="lineNum">    2980 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (flags-&gt;verbose) {</span>
<span class="lineNum">    2981 </span>                :<span class="lineNoCov">          0 :                                 (void) printf(&quot;local fs %s does not have &quot;</span>
<span class="lineNum">    2982 </span>                :            :                                     &quot;fromsnap (%s in stream); must have &quot;
<span class="lineNum">    2983 </span>                :            :                                     &quot;been deleted locally; ignoring\n&quot;,
<span class="lineNum">    2984 </span>                :            :                                     fsname, fromsnap);
<span class="lineNum">    2985 </span>                :            :                         }
<span class="lineNum">    2986 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2987 </span>                :            :                 }
<span class="lineNum">    2988 </span>                :            : 
<span class="lineNum">    2989 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 147 times"> + </span>]:<span class="lineCov">        147 :                 VERIFY(0 == nvlist_lookup_string(stream_nvfs,</span>
<span class="lineNum">    2990 </span>                :            :                     &quot;name&quot;, &amp;stream_fsname));
<span class="lineNum">    2991 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 147 times"> + </span>]:<span class="lineCov">        147 :                 VERIFY(0 == nvlist_lookup_uint64(stream_nvfs,</span>
<span class="lineNum">    2992 </span>                :            :                     &quot;parentfromsnap&quot;, &amp;stream_parent_fromsnap_guid));
<span class="lineNum">    2993 </span>                :            : 
<span class="lineNum">    2994 </span>                :<span class="lineCov">        147 :                 s1 = strrchr(fsname, '/');</span>
<span class="lineNum">    2995 </span>                :<span class="lineCov">        147 :                 s2 = strrchr(stream_fsname, '/');</span>
<span class="lineNum">    2996 </span>                :            : 
<span class="lineNum">    2997 </span>                :            :                 /*
<span class="lineNum">    2998 </span>                :            :                  * Check if we're going to rename based on parent guid change
<span class="lineNum">    2999 </span>                :            :                  * and the current parent guid was also deleted. If it was then
<span class="lineNum">    3000 </span>                :            :                  * rename will fail and is likely unneeded, so avoid this and
<span class="lineNum">    3001 </span>                :            :                  * force an early retry to determine the new
<span class="lineNum">    3002 </span>                :            :                  * parent_fromsnap_guid.
<span class="lineNum">    3003 </span>                :            :                  */
<span class="lineNum">    3004 </span>[<span class="branchCov" title="Branch 0 was taken 110 times"> + </span><span class="branchCov" title="Branch 1 was taken 37 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 110 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">        147 :                 if (stream_parent_fromsnap_guid != 0 &amp;&amp;</span>
<span class="lineNum">    3005 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 110 times"> + </span>]:<span class="lineCov">        110 :                     parent_fromsnap_guid != 0 &amp;&amp;</span>
<span class="lineNum">    3006 </span>                :            :                     stream_parent_fromsnap_guid != parent_fromsnap_guid) {
<span class="lineNum">    3007 </span>                :<span class="lineNoCov">          0 :                         sprintf(guidname, &quot;%llu&quot;,</span>
<span class="lineNum">    3008 </span>                :            :                             (u_longlong_t)parent_fromsnap_guid);
<span class="lineNum">    3009 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (nvlist_exists(deleted, guidname)) {</span>
<span class="lineNum">    3010 </span>                :<span class="lineNoCov">          0 :                                 progress = B_TRUE;</span>
<span class="lineNum">    3011 </span>                :<span class="lineNoCov">          0 :                                 needagain = B_TRUE;</span>
<span class="lineNum">    3012 </span>                :<span class="lineNoCov">          0 :                                 goto doagain;</span>
<span class="lineNum">    3013 </span>                :            :                         }
<span class="lineNum">    3014 </span>                :            :                 }
<span class="lineNum">    3015 </span>                :            : 
<span class="lineNum">    3016 </span>                :            :                 /*
<span class="lineNum">    3017 </span>                :            :                  * Check for rename. If the exact receive path is specified, it
<span class="lineNum">    3018 </span>                :            :                  * does not count as a rename, but we still need to check the
<span class="lineNum">    3019 </span>                :            :                  * datasets beneath it.
<span class="lineNum">    3020 </span>                :            :                  */
<span class="lineNum">    3021 </span>[<span class="branchCov" title="Branch 0 was taken 110 times"> + </span><span class="branchCov" title="Branch 1 was taken 37 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 110 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">        147 :                 if ((stream_parent_fromsnap_guid != 0 &amp;&amp;</span>
<span class="lineNum">    3022 </span>        [<span class="branchCov" title="Branch 0 was taken 110 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        110 :                     parent_fromsnap_guid != 0 &amp;&amp;</span>
<span class="lineNum">    3023 </span>        [<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchCov" title="Branch 1 was taken 129 times"> + </span>]:<span class="lineCov">        147 :                     stream_parent_fromsnap_guid != parent_fromsnap_guid) ||</span>
<span class="lineNum">    3024 </span>        [<span class="branchCov" title="Branch 0 was taken 8 times"> + </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span>]:<span class="lineCov">         18 :                     ((flags-&gt;isprefix || strcmp(tofs, fsname) != 0) &amp;&amp;</span>
<span class="lineNum">    3025 </span>[<span class="branchCov" title="Branch 0 was taken 122 times"> + </span><span class="branchCov" title="Branch 1 was taken 15 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 122 times"> + </span>]:<span class="lineCov">        137 :                     (s1 != NULL) &amp;&amp; (s2 != NULL) &amp;&amp; strcmp(s1, s2) != 0)) {</span>
<span class="lineNum">    3026 </span>                :            :                         nvlist_t *parent;
<span class="lineNum">    3027 </span>                :            :                         char tryname[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    3028 </span>                :            : 
<span class="lineNum">    3029 </span>                :<span class="lineNoCov">          0 :                         parent = fsavl_find(local_avl,</span>
<span class="lineNum">    3030 </span>                :            :                             stream_parent_fromsnap_guid, NULL);
<span class="lineNum">    3031 </span>                :            :                         /*
<span class="lineNum">    3032 </span>                :            :                          * NB: parent might not be found if we used the
<span class="lineNum">    3033 </span>                :            :                          * tosnap for stream_parent_fromsnap_guid,
<span class="lineNum">    3034 </span>                :            :                          * because the parent is a newly-created fs;
<span class="lineNum">    3035 </span>                :            :                          * we'll be able to rename it after we recv the
<span class="lineNum">    3036 </span>                :            :                          * new fs.
<span class="lineNum">    3037 </span>                :            :                          */
<span class="lineNum">    3038 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (parent != NULL) {</span>
<span class="lineNum">    3039 </span>                :            :                                 char *pname;
<span class="lineNum">    3040 </span>                :            : 
<span class="lineNum">    3041 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 VERIFY(0 == nvlist_lookup_string(parent, &quot;name&quot;,</span>
<span class="lineNum">    3042 </span>                :            :                                     &amp;pname));
<span class="lineNum">    3043 </span>                :<span class="lineNoCov">          0 :                                 (void) snprintf(tryname, sizeof (tryname),</span>
<span class="lineNum">    3044 </span>                :            :                                     &quot;%s%s&quot;, pname, strrchr(stream_fsname, '/'));
<span class="lineNum">    3045 </span>                :            :                         } else {
<span class="lineNum">    3046 </span>                :<span class="lineNoCov">          0 :                                 tryname[0] = '\0';</span>
<span class="lineNum">    3047 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (flags-&gt;verbose) {</span>
<span class="lineNum">    3048 </span>                :<span class="lineNoCov">          0 :                                         (void) printf(&quot;local fs %s new parent &quot;</span>
<span class="lineNum">    3049 </span>                :            :                                             &quot;not found\n&quot;, fsname);
<span class="lineNum">    3050 </span>                :            :                                 }
<span class="lineNum">    3051 </span>                :            :                         }
<span class="lineNum">    3052 </span>                :            : 
<span class="lineNum">    3053 </span>                :<span class="lineNoCov">          0 :                         newname[0] = '\0';</span>
<span class="lineNum">    3054 </span>                :            : 
<span class="lineNum">    3055 </span>                :<span class="lineNoCov">          0 :                         error = recv_rename(hdl, fsname, tryname,</span>
<span class="lineNum">    3056 </span>                :<span class="lineNoCov">          0 :                             strlen(tofs)+1, newname, flags);</span>
<span class="lineNum">    3057 </span>                :            : 
<span class="lineNum">    3058 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (renamed != NULL &amp;&amp; newname[0] != '\0') {</span>
<span class="lineNum">    3059 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 VERIFY(0 == nvlist_add_boolean(renamed,</span>
<span class="lineNum">    3060 </span>                :            :                                     newname));
<span class="lineNum">    3061 </span>                :            :                         }
<span class="lineNum">    3062 </span>                :            : 
<span class="lineNum">    3063 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (error)</span>
<span class="lineNum">    3064 </span>                :            :                                 needagain = B_TRUE;
<span class="lineNum">    3065 </span>                :            :                         else
<span class="lineNum">    3066 </span>                :<span class="lineCov">        147 :                                 progress = B_TRUE;</span>
<span class="lineNum">    3067 </span>                :            :                 }
<span class="lineNum">    3068 </span>                :            :         }
<span class="lineNum">    3069 </span>                :            : 
<span class="lineNum">    3070 </span>                :            : doagain:
<span class="lineNum">    3071 </span>                :<span class="lineCov">         37 :         fsavl_destroy(local_avl);</span>
<span class="lineNum">    3072 </span>                :<span class="lineCov">         37 :         nvlist_free(local_nv);</span>
<span class="lineNum">    3073 </span>                :<span class="lineCov">         37 :         nvlist_free(deleted);</span>
<span class="lineNum">    3074 </span>                :            : 
<span class="lineNum">    3075 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 34 times"> + </span>]:<span class="lineCov">         37 :         if (needagain &amp;&amp; progress) {</span>
<span class="lineNum">    3076 </span>                :            :                 /* do another pass to fix up temporary names */
<span class="lineNum">    3077 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          3 :                 if (flags-&gt;verbose)</span>
<span class="lineNum">    3078 </span>                :            :                         (void) printf(&quot;another pass:\n&quot;);
<span class="lineNum">    3079 </span>                :            :                 goto again;
<span class="lineNum">    3080 </span>                :            :         }
<span class="lineNum">    3081 </span>                :            : 
<span class="lineNum">    3082 </span>                :<span class="lineCov">         34 :         return (needagain || error != 0);</span>
<span class="lineNum">    3083 </span>                :            : }
<a name="3084"><span class="lineNum">    3084 </span>                :            : </a>
<span class="lineNum">    3085 </span>                :            : static int
<span class="lineNum">    3086 </span>                :<span class="lineCov">         79 : zfs_receive_package(libzfs_handle_t *hdl, int fd, const char *destname,</span>
<span class="lineNum">    3087 </span>                :            :     recvflags_t *flags, dmu_replay_record_t *drr, zio_cksum_t *zc,
<span class="lineNum">    3088 </span>                :            :     char **top_zfs, int cleanup_fd, uint64_t *action_handlep,
<span class="lineNum">    3089 </span>                :            :     nvlist_t *cmdprops)
<span class="lineNum">    3090 </span>                :            : {
<span class="lineNum">    3091 </span>                :<span class="lineCov">         79 :         nvlist_t *stream_nv = NULL;</span>
<span class="lineNum">    3092 </span>                :<span class="lineCov">         79 :         avl_tree_t *stream_avl = NULL;</span>
<span class="lineNum">    3093 </span>                :<span class="lineCov">         79 :         char *fromsnap = NULL;</span>
<span class="lineNum">    3094 </span>                :<span class="lineCov">         79 :         char *sendsnap = NULL;</span>
<span class="lineNum">    3095 </span>                :            :         char *cp;
<span class="lineNum">    3096 </span>                :            :         char tofs[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    3097 </span>                :            :         char sendfs[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    3098 </span>                :            :         char errbuf[1024];
<span class="lineNum">    3099 </span>                :            :         dmu_replay_record_t drre;
<span class="lineNum">    3100 </span>                :            :         int error;
<span class="lineNum">    3101 </span>                :<span class="lineCov">         79 :         boolean_t anyerr = B_FALSE;</span>
<span class="lineNum">    3102 </span>                :<span class="lineCov">         79 :         boolean_t softerr = B_FALSE;</span>
<span class="lineNum">    3103 </span>                :            :         boolean_t recursive, raw;
<span class="lineNum">    3104 </span>                :            : 
<span class="lineNum">    3105 </span>                :<span class="lineCov">        158 :         (void) snprintf(errbuf, sizeof (errbuf), dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3106 </span>                :            :             &quot;cannot receive&quot;));
<span class="lineNum">    3107 </span>                :            : 
<span class="lineNum">    3108 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 79 times"> + </span>]:<span class="lineCov">         79 :         assert(drr-&gt;drr_type == DRR_BEGIN);</span>
<span class="lineNum">    3109 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 79 times"> + </span>]:<span class="lineCov">         79 :         assert(drr-&gt;drr_u.drr_begin.drr_magic == DMU_BACKUP_MAGIC);</span>
<span class="lineNum">    3110 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 79 times"> + </span>]:<span class="lineCov">         79 :         assert(DMU_GET_STREAM_HDRTYPE(drr-&gt;drr_u.drr_begin.drr_versioninfo) ==</span>
<span class="lineNum">    3111 </span>                :            :             DMU_COMPOUNDSTREAM);
<span class="lineNum">    3112 </span>                :            : 
<span class="lineNum">    3113 </span>                :            :         /*
<span class="lineNum">    3114 </span>                :            :          * Read in the nvlist from the stream.
<span class="lineNum">    3115 </span>                :            :          */
<span class="lineNum">    3116 </span>        [<span class="branchCov" title="Branch 0 was taken 73 times"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">         79 :         if (drr-&gt;drr_payloadlen != 0) {</span>
<span class="lineNum">    3117 </span>                :<span class="lineCov">         73 :                 error = recv_read_nvlist(hdl, fd, drr-&gt;drr_payloadlen,</span>
<span class="lineNum">    3118 </span>                :            :                     &amp;stream_nv, flags-&gt;byteswap, zc);
<span class="lineNum">    3119 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 73 times"> + </span>]:<span class="lineCov">         73 :                 if (error) {</span>
<span class="lineNum">    3120 </span>                :<span class="lineNoCov">          0 :                         error = zfs_error(hdl, EZFS_BADSTREAM, errbuf);</span>
<span class="lineNum">    3121 </span>                :<span class="lineNoCov">          0 :                         goto out;</span>
<span class="lineNum">    3122 </span>                :            :                 }
<span class="lineNum">    3123 </span>                :            :         }
<span class="lineNum">    3124 </span>                :            : 
<span class="lineNum">    3125 </span>                :<span class="lineCov">         79 :         recursive = (nvlist_lookup_boolean(stream_nv, &quot;not_recursive&quot;) ==</span>
<span class="lineNum">    3126 </span>                :            :             ENOENT);
<span class="lineNum">    3127 </span>                :<span class="lineCov">         79 :         raw = (nvlist_lookup_boolean(stream_nv, &quot;raw&quot;) == 0);</span>
<span class="lineNum">    3128 </span>                :            : 
<span class="lineNum">    3129 </span>[<span class="branchCov" title="Branch 0 was taken 50 times"> + </span><span class="branchCov" title="Branch 1 was taken 29 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 50 times"> + </span>]:<span class="lineCov">         79 :         if (recursive &amp;&amp; strchr(destname, '@')) {</span>
<span class="lineNum">    3130 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3131 </span>                :            :                     &quot;cannot specify snapshot name for multi-snapshot stream&quot;));
<span class="lineNum">    3132 </span>                :<span class="lineNoCov">          0 :                 error = zfs_error(hdl, EZFS_BADSTREAM, errbuf);</span>
<span class="lineNum">    3133 </span>                :<span class="lineNoCov">          0 :                 goto out;</span>
<span class="lineNum">    3134 </span>                :            :         }
<span class="lineNum">    3135 </span>                :            : 
<span class="lineNum">    3136 </span>                :            :         /*
<span class="lineNum">    3137 </span>                :            :          * Read in the end record and verify checksum.
<span class="lineNum">    3138 </span>                :            :          */
<span class="lineNum">    3139 </span>        [<span class="branchCov" title="Branch 1 was taken 79 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         79 :         if (0 != (error = recv_read(hdl, fd, &amp;drre, sizeof (drre),</span>
<span class="lineNum">    3140 </span>                :            :             flags-&gt;byteswap, NULL)))
<span class="lineNum">    3141 </span>                :            :                 goto out;
<span class="lineNum">    3142 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 79 times"> + </span>]:<span class="lineCov">         79 :         if (flags-&gt;byteswap) {</span>
<span class="lineNum">    3143 </span>                :<span class="lineNoCov">          0 :                 drre.drr_type = BSWAP_32(drre.drr_type);</span>
<span class="lineNum">    3144 </span>                :<span class="lineNoCov">          0 :                 drre.drr_u.drr_end.drr_checksum.zc_word[0] =</span>
<span class="lineNum">    3145 </span>                :<span class="lineNoCov">          0 :                     BSWAP_64(drre.drr_u.drr_end.drr_checksum.zc_word[0]);</span>
<span class="lineNum">    3146 </span>                :<span class="lineNoCov">          0 :                 drre.drr_u.drr_end.drr_checksum.zc_word[1] =</span>
<span class="lineNum">    3147 </span>                :<span class="lineNoCov">          0 :                     BSWAP_64(drre.drr_u.drr_end.drr_checksum.zc_word[1]);</span>
<span class="lineNum">    3148 </span>                :<span class="lineNoCov">          0 :                 drre.drr_u.drr_end.drr_checksum.zc_word[2] =</span>
<span class="lineNum">    3149 </span>                :<span class="lineNoCov">          0 :                     BSWAP_64(drre.drr_u.drr_end.drr_checksum.zc_word[2]);</span>
<span class="lineNum">    3150 </span>                :<span class="lineNoCov">          0 :                 drre.drr_u.drr_end.drr_checksum.zc_word[3] =</span>
<span class="lineNum">    3151 </span>                :<span class="lineNoCov">          0 :                     BSWAP_64(drre.drr_u.drr_end.drr_checksum.zc_word[3]);</span>
<span class="lineNum">    3152 </span>                :            :         }
<span class="lineNum">    3153 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 79 times"> + </span>]:<span class="lineCov">         79 :         if (drre.drr_type != DRR_END) {</span>
<span class="lineNum">    3154 </span>                :<span class="lineNoCov">          0 :                 error = zfs_error(hdl, EZFS_BADSTREAM, errbuf);</span>
<span class="lineNum">    3155 </span>                :<span class="lineNoCov">          0 :                 goto out;</span>
<span class="lineNum">    3156 </span>                :            :         }
<span class="lineNum">    3157 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 79 times"> + </span>]:<span class="lineCov">         79 :         if (!ZIO_CHECKSUM_EQUAL(drre.drr_u.drr_end.drr_checksum, *zc)) {</span>
<span class="lineNum">    3158 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3159 </span>                :            :                     &quot;incorrect header checksum&quot;));
<span class="lineNum">    3160 </span>                :<span class="lineNoCov">          0 :                 error = zfs_error(hdl, EZFS_BADSTREAM, errbuf);</span>
<span class="lineNum">    3161 </span>                :<span class="lineNoCov">          0 :                 goto out;</span>
<span class="lineNum">    3162 </span>                :            :         }
<span class="lineNum">    3163 </span>                :            : 
<span class="lineNum">    3164 </span>                :<span class="lineCov">         79 :         (void) nvlist_lookup_string(stream_nv, &quot;fromsnap&quot;, &amp;fromsnap);</span>
<span class="lineNum">    3165 </span>                :            : 
<span class="lineNum">    3166 </span>        [<span class="branchCov" title="Branch 0 was taken 73 times"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">         79 :         if (drr-&gt;drr_payloadlen != 0) {</span>
<span class="lineNum">    3167 </span>                :            :                 nvlist_t *stream_fss;
<span class="lineNum">    3168 </span>                :            : 
<span class="lineNum">    3169 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 73 times"> + </span>]:<span class="lineCov">         73 :                 VERIFY(0 == nvlist_lookup_nvlist(stream_nv, &quot;fss&quot;,</span>
<span class="lineNum">    3170 </span>                :            :                     &amp;stream_fss));
<span class="lineNum">    3171 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 73 times"> + </span>]:<span class="lineCov">         73 :                 if ((stream_avl = fsavl_create(stream_fss)) == NULL) {</span>
<span class="lineNum">    3172 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3173 </span>                :            :                             &quot;couldn't allocate avl tree&quot;));
<span class="lineNum">    3174 </span>                :<span class="lineNoCov">          0 :                         error = zfs_error(hdl, EZFS_NOMEM, errbuf);</span>
<span class="lineNum">    3175 </span>                :<span class="lineNoCov">          0 :                         goto out;</span>
<span class="lineNum">    3176 </span>                :            :                 }
<span class="lineNum">    3177 </span>                :            : 
<span class="lineNum">    3178 </span>[<span class="branchCov" title="Branch 0 was taken 20 times"> + </span><span class="branchCov" title="Branch 1 was taken 53 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 17 times"> + </span><span class="branchCov" title="Branch 3 was taken 3 times"> + </span>]:<span class="lineCov">         73 :                 if (fromsnap != NULL &amp;&amp; recursive) {</span>
<span class="lineNum">    3179 </span>                :<span class="lineCov">         17 :                         nvlist_t *renamed = NULL;</span>
<span class="lineNum">    3180 </span>                :<span class="lineCov">         17 :                         nvpair_t *pair = NULL;</span>
<span class="lineNum">    3181 </span>                :            : 
<span class="lineNum">    3182 </span>                :<span class="lineCov">         17 :                         (void) strlcpy(tofs, destname, sizeof (tofs));</span>
<span class="lineNum">    3183 </span>        [<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">         17 :                         if (flags-&gt;isprefix) {</span>
<span class="lineNum">    3184 </span>                :<span class="lineCov">         12 :                                 struct drr_begin *drrb = &amp;drr-&gt;drr_u.drr_begin;</span>
<span class="lineNum">    3185 </span>                :            :                                 int i;
<span class="lineNum">    3186 </span>                :            : 
<span class="lineNum">    3187 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>]:<span class="lineCov">         12 :                                 if (flags-&gt;istail) {</span>
<span class="lineNum">    3188 </span>                :<span class="lineNoCov">          0 :                                         cp = strrchr(drrb-&gt;drr_toname, '/');</span>
<span class="lineNum">    3189 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                         if (cp == NULL) {</span>
<span class="lineNum">    3190 </span>                :<span class="lineNoCov">          0 :                                                 (void) strlcat(tofs, &quot;/&quot;,</span>
<span class="lineNum">    3191 </span>                :            :                                                     sizeof (tofs));
<span class="lineNum">    3192 </span>                :<span class="lineNoCov">          0 :                                                 i = 0;</span>
<span class="lineNum">    3193 </span>                :            :                                         } else {
<span class="lineNum">    3194 </span>                :<span class="lineNoCov">          0 :                                                 i = (cp - drrb-&gt;drr_toname);</span>
<span class="lineNum">    3195 </span>                :            :                                         }
<span class="lineNum">    3196 </span>                :            :                                 } else {
<span class="lineNum">    3197 </span>                :<span class="lineCov">         12 :                                         i = strcspn(drrb-&gt;drr_toname, &quot;/@&quot;);</span>
<span class="lineNum">    3198 </span>                :            :                                 }
<span class="lineNum">    3199 </span>                :            :                                 /* zfs_receive_one() will create_parents() */
<span class="lineNum">    3200 </span>                :<span class="lineCov">         12 :                                 (void) strlcat(tofs, &amp;drrb-&gt;drr_toname[i],</span>
<span class="lineNum">    3201 </span>                :            :                                     sizeof (tofs));
<span class="lineNum">    3202 </span>                :<span class="lineCov">         12 :                                 *strchr(tofs, '@') = '\0';</span>
<span class="lineNum">    3203 </span>                :            :                         }
<span class="lineNum">    3204 </span>                :            : 
<span class="lineNum">    3205 </span>[<span class="branchCov" title="Branch 0 was taken 17 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 17 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">         17 :                         if (!flags-&gt;dryrun &amp;&amp; !flags-&gt;nomount) {</span>
<span class="lineNum">    3206 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 17 times"> + </span>]:<span class="lineCov">         17 :                                 VERIFY(0 == nvlist_alloc(&amp;renamed,</span>
<span class="lineNum">    3207 </span>                :            :                                     NV_UNIQUE_NAME, 0));
<span class="lineNum">    3208 </span>                :            :                         }
<span class="lineNum">    3209 </span>                :            : 
<span class="lineNum">    3210 </span>                :<span class="lineCov">         17 :                         softerr = recv_incremental_replication(hdl, tofs, flags,</span>
<span class="lineNum">    3211 </span>                :            :                             stream_nv, stream_avl, renamed);
<span class="lineNum">    3212 </span>                :            : 
<span class="lineNum">    3213 </span>                :            :                         /* Unmount renamed filesystems before receiving. */
<span class="lineNum">    3214 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 17 times"> + </span>]:<span class="lineCov">         17 :                         while ((pair = nvlist_next_nvpair(renamed,</span>
<span class="lineNum">    3215 </span>                :            :                             pair)) != NULL) {
<span class="lineNum">    3216 </span>                :            :                                 zfs_handle_t *zhp;
<span class="lineNum">    3217 </span>                :<span class="lineNoCov">          0 :                                 prop_changelist_t *clp = NULL;</span>
<span class="lineNum">    3218 </span>                :            : 
<span class="lineNum">    3219 </span>                :<span class="lineNoCov">          0 :                                 zhp = zfs_open(hdl, nvpair_name(pair),</span>
<span class="lineNum">    3220 </span>                :            :                                     ZFS_TYPE_FILESYSTEM);
<span class="lineNum">    3221 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (zhp != NULL) {</span>
<span class="lineNum">    3222 </span>                :<span class="lineNoCov">          0 :                                         clp = changelist_gather(zhp,</span>
<span class="lineNum">    3223 </span>                :            :                                             ZFS_PROP_MOUNTPOINT, 0, 0);
<span class="lineNum">    3224 </span>                :<span class="lineNoCov">          0 :                                         zfs_close(zhp);</span>
<span class="lineNum">    3225 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                         if (clp != NULL) {</span>
<span class="lineNum">    3226 </span>                :<span class="lineNoCov">          0 :                                                 softerr |=</span>
<span class="lineNum">    3227 </span>                :<span class="lineNoCov">          0 :                                                     changelist_prefix(clp);</span>
<span class="lineNum">    3228 </span>                :<span class="lineNoCov">          0 :                                                 changelist_free(clp);</span>
<span class="lineNum">    3229 </span>                :            :                                         }
<span class="lineNum">    3230 </span>                :            :                                 }
<span class="lineNum">    3231 </span>                :            :                         }
<span class="lineNum">    3232 </span>                :            : 
<span class="lineNum">    3233 </span>                :<span class="lineCov">         73 :                         nvlist_free(renamed);</span>
<span class="lineNum">    3234 </span>                :            :                 }
<span class="lineNum">    3235 </span>                :            :         }
<span class="lineNum">    3236 </span>                :            : 
<span class="lineNum">    3237 </span>                :            :         /*
<span class="lineNum">    3238 </span>                :            :          * Get the fs specified by the first path in the stream (the top level
<span class="lineNum">    3239 </span>                :            :          * specified by 'zfs send') and pass it to each invocation of
<span class="lineNum">    3240 </span>                :            :          * zfs_receive_one().
<span class="lineNum">    3241 </span>                :            :          */
<span class="lineNum">    3242 </span>                :<span class="lineCov">         79 :         (void) strlcpy(sendfs, drr-&gt;drr_u.drr_begin.drr_toname,</span>
<span class="lineNum">    3243 </span>                :            :             sizeof (sendfs));
<span class="lineNum">    3244 </span>        [<span class="branchCov" title="Branch 0 was taken 79 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         79 :         if ((cp = strchr(sendfs, '@')) != NULL) {</span>
<span class="lineNum">    3245 </span>                :<span class="lineCov">         79 :                 *cp = '\0';</span>
<span class="lineNum">    3246 </span>                :            :                 /*
<span class="lineNum">    3247 </span>                :            :                  * Find the &quot;sendsnap&quot;, the final snapshot in a replication
<span class="lineNum">    3248 </span>                :            :                  * stream.  zfs_receive_one() handles certain errors
<span class="lineNum">    3249 </span>                :            :                  * differently, depending on if the contained stream is the
<span class="lineNum">    3250 </span>                :            :                  * last one or not.
<span class="lineNum">    3251 </span>                :            :                  */
<span class="lineNum">    3252 </span>                :<span class="lineCov">         79 :                 sendsnap = (cp + 1);</span>
<span class="lineNum">    3253 </span>                :            :         }
<span class="lineNum">    3254 </span>                :            : 
<span class="lineNum">    3255 </span>                :            :         /* Finally, receive each contained stream */
<span class="lineNum">    3256 </span>                :            :         do {
<span class="lineNum">    3257 </span>                :            :                 /*
<span class="lineNum">    3258 </span>                :            :                  * we should figure out if it has a recoverable
<span class="lineNum">    3259 </span>                :            :                  * error, in which case do a recv_skip() and drive on.
<span class="lineNum">    3260 </span>                :            :                  * Note, if we fail due to already having this guid,
<span class="lineNum">    3261 </span>                :            :                  * zfs_receive_one() will take care of it (ie,
<span class="lineNum">    3262 </span>                :            :                  * recv_skip() and return 0).
<span class="lineNum">    3263 </span>                :            :                  */
<span class="lineNum">    3264 </span>                :<span class="lineCov">        858 :                 error = zfs_receive_impl(hdl, destname, NULL, flags, fd,</span>
<span class="lineNum">    3265 </span>                :            :                     sendfs, stream_nv, stream_avl, top_zfs, cleanup_fd,
<span class="lineNum">    3266 </span>                :            :                     action_handlep, sendsnap, cmdprops);
<span class="lineNum">    3267 </span>        [<span class="branchCov" title="Branch 0 was taken 790 times"> + </span><span class="branchCov" title="Branch 1 was taken 68 times"> + </span>]:<span class="lineCov">        858 :                 if (error == ENODATA) {</span>
<span class="lineNum">    3268 </span>                :            :                         error = 0;
<span class="lineNum">    3269 </span>                :            :                         break;
<span class="lineNum">    3270 </span>                :            :                 }
<span class="lineNum">    3271 </span>                :<span class="lineCov">        790 :                 anyerr |= error;</span>
<span class="lineNum">    3272 </span>        [<span class="branchCov" title="Branch 0 was taken 779 times"> + </span><span class="branchCov" title="Branch 1 was taken 11 times"> + </span>]:<span class="lineCov">        790 :         } while (error == 0);</span>
<span class="lineNum">    3273 </span>                :            : 
<span class="lineNum">    3274 </span>[<span class="branchCov" title="Branch 0 was taken 73 times"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 50 times"> + </span><span class="branchCov" title="Branch 3 was taken 23 times"> + </span>]:<span class="lineCov">         79 :         if (drr-&gt;drr_payloadlen != 0 &amp;&amp; recursive &amp;&amp; fromsnap != NULL) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 17 times"> + </span><span class="branchCov" title="Branch 5 was taken 33 times"> + </span>]
<span class="lineNum">    3275 </span>                :            :                 /*
<span class="lineNum">    3276 </span>                :            :                  * Now that we have the fs's they sent us, try the
<span class="lineNum">    3277 </span>                :            :                  * renames again.
<span class="lineNum">    3278 </span>                :            :                  */
<span class="lineNum">    3279 </span>                :<span class="lineCov">         17 :                 softerr = recv_incremental_replication(hdl, tofs, flags,</span>
<span class="lineNum">    3280 </span>                :            :                     stream_nv, stream_avl, NULL);
<span class="lineNum">    3281 </span>                :            :         }
<span class="lineNum">    3282 </span>                :            : 
<span class="lineNum">    3283 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 77 times"> + </span>]:<span class="lineCov">         79 :         if (raw &amp;&amp; softerr == 0) {</span>
<span class="lineNum">    3284 </span>                :<span class="lineCov">          2 :                 softerr = recv_fix_encryption_heirarchy(hdl, destname,</span>
<span class="lineNum">    3285 </span>                :            :                     stream_nv, stream_avl);
<span class="lineNum">    3286 </span>                :            :         }
<span class="lineNum">    3287 </span>                :            : 
<span class="lineNum">    3288 </span>                :            : out:
<span class="lineNum">    3289 </span>                :<span class="lineCov">         79 :         fsavl_destroy(stream_avl);</span>
<span class="lineNum">    3290 </span>                :<span class="lineCov">         79 :         nvlist_free(stream_nv);</span>
<span class="lineNum">    3291 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 79 times"> + </span>]:<span class="lineCov">         79 :         if (softerr)</span>
<span class="lineNum">    3292 </span>                :<span class="lineNoCov">          0 :                 error = -2;</span>
<span class="lineNum">    3293 </span>        [<span class="branchCov" title="Branch 0 was taken 11 times"> + </span><span class="branchCov" title="Branch 1 was taken 68 times"> + </span>]:<span class="lineCov">         79 :         if (anyerr)</span>
<span class="lineNum">    3294 </span>                :<span class="lineCov">         11 :                 error = -1;</span>
<span class="lineNum">    3295 </span>                :<span class="lineCov">         79 :         return (error);</span>
<span class="lineNum">    3296 </span>                :            : }
<a name="3297"><span class="lineNum">    3297 </span>                :            : </a>
<span class="lineNum">    3298 </span>                :            : static void
<span class="lineNum">    3299 </span>                :<span class="lineNoCov">          0 : trunc_prop_errs(int truncated)</span>
<span class="lineNum">    3300 </span>                :            : {
<span class="lineNum">    3301 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(truncated != 0);</span>
<span class="lineNum">    3302 </span>                :            : 
<span class="lineNum">    3303 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (truncated == 1)</span>
<span class="lineNum">    3304 </span>                :<span class="lineNoCov">          0 :                 (void) fprintf(stderr, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3305 </span>                :            :                     &quot;1 more property could not be set\n&quot;));
<span class="lineNum">    3306 </span>                :            :         else
<span class="lineNum">    3307 </span>                :<span class="lineNoCov">          0 :                 (void) fprintf(stderr, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3308 </span>                :            :                     &quot;%d more properties could not be set\n&quot;), truncated);
<span class="lineNum">    3309 </span>                :<span class="lineNoCov">          0 : }</span>
<a name="3310"><span class="lineNum">    3310 </span>                :            : </a>
<span class="lineNum">    3311 </span>                :            : static int
<span class="lineNum">    3312 </span>                :<span class="lineCov">          4 : recv_skip(libzfs_handle_t *hdl, int fd, boolean_t byteswap)</span>
<span class="lineNum">    3313 </span>                :            : {
<span class="lineNum">    3314 </span>                :            :         dmu_replay_record_t *drr;
<span class="lineNum">    3315 </span>                :<span class="lineCov">          4 :         void *buf = zfs_alloc(hdl, SPA_MAXBLOCKSIZE);</span>
<span class="lineNum">    3316 </span>                :            :         char errbuf[1024];
<span class="lineNum">    3317 </span>                :            : 
<span class="lineNum">    3318 </span>                :<span class="lineCov">          8 :         (void) snprintf(errbuf, sizeof (errbuf), dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3319 </span>                :            :             &quot;cannot receive:&quot;));
<span class="lineNum">    3320 </span>                :            : 
<span class="lineNum">    3321 </span>                :            :         /* XXX would be great to use lseek if possible... */
<span class="lineNum">    3322 </span>                :<span class="lineCov">          4 :         drr = buf;</span>
<span class="lineNum">    3323 </span>                :            : 
<span class="lineNum">    3324 </span>        [<span class="branchCov" title="Branch 1 was taken 3360 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       3360 :         while (recv_read(hdl, fd, drr, sizeof (dmu_replay_record_t),</span>
<span class="lineNum">    3325 </span>                :            :             byteswap, NULL) == 0) {
<span class="lineNum">    3326 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3360 times"> + </span>]:<span class="lineCov">       3360 :                 if (byteswap)</span>
<span class="lineNum">    3327 </span>                :<span class="lineNoCov">          0 :                         drr-&gt;drr_type = BSWAP_32(drr-&gt;drr_type);</span>
<span class="lineNum">    3328 </span>                :            : 
<span class="lineNum">    3329 </span>  [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4 times"> + </span><span class="branchCov" title="Branch 2 was taken 32 times"> + </span><span class="branchCov" title="Branch 3 was taken 3232 times"> + </span> :<span class="lineCov">       3360 :                 switch (drr-&gt;drr_type) {</span>
<span class="lineNum">         </span>   <span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchCov" title="Branch 7 was taken 92 times"> + </span>]
<span class="lineNum">    3330 </span>                :            :                 case DRR_BEGIN:
<span class="lineNum">    3331 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (drr-&gt;drr_payloadlen != 0) {</span>
<span class="lineNum">    3332 </span>                :<span class="lineNoCov">          0 :                                 (void) recv_read(hdl, fd, buf,</span>
<span class="lineNum">    3333 </span>                :            :                                     drr-&gt;drr_payloadlen, B_FALSE, NULL);
<span class="lineNum">    3334 </span>                :            :                         }
<span class="lineNum">    3335 </span>                :            :                         break;
<span class="lineNum">    3336 </span>                :            : 
<span class="lineNum">    3337 </span>                :            :                 case DRR_END:
<span class="lineNum">    3338 </span>                :<span class="lineCov">          4 :                         free(buf);</span>
<span class="lineNum">    3339 </span>                :<span class="lineCov">          4 :                         return (0);</span>
<span class="lineNum">    3340 </span>                :            : 
<span class="lineNum">    3341 </span>                :            :                 case DRR_OBJECT:
<span class="lineNum">    3342 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 32 times"> + </span>]:<span class="lineCov">         32 :                         if (byteswap) {</span>
<span class="lineNum">    3343 </span>                :<span class="lineNoCov">          0 :                                 drr-&gt;drr_u.drr_object.drr_bonuslen =</span>
<span class="lineNum">    3344 </span>                :<span class="lineNoCov">          0 :                                     BSWAP_32(drr-&gt;drr_u.drr_object.</span>
<span class="lineNum">    3345 </span>                :            :                                     drr_bonuslen);
<span class="lineNum">    3346 </span>                :            :                         }
<span class="lineNum">    3347 </span>                :<span class="lineCov">         32 :                         (void) recv_read(hdl, fd, buf,</span>
<span class="lineNum">    3348 </span>                :<span class="lineCov">         32 :                             P2ROUNDUP(drr-&gt;drr_u.drr_object.drr_bonuslen, 8),</span>
<span class="lineNum">    3349 </span>                :            :                             B_FALSE, NULL);
<span class="lineNum">    3350 </span>                :<span class="lineCov">       3356 :                         break;</span>
<span class="lineNum">    3351 </span>                :            : 
<span class="lineNum">    3352 </span>                :            :                 case DRR_WRITE:
<span class="lineNum">    3353 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3232 times"> + </span>]:<span class="lineCov">       3232 :                         if (byteswap) {</span>
<span class="lineNum">    3354 </span>                :<span class="lineNoCov">          0 :                                 drr-&gt;drr_u.drr_write.drr_logical_size =</span>
<span class="lineNum">    3355 </span>                :<span class="lineNoCov">          0 :                                     BSWAP_64(</span>
<span class="lineNum">    3356 </span>                :            :                                     drr-&gt;drr_u.drr_write.drr_logical_size);
<span class="lineNum">    3357 </span>                :<span class="lineNoCov">          0 :                                 drr-&gt;drr_u.drr_write.drr_compressed_size =</span>
<span class="lineNum">    3358 </span>                :<span class="lineNoCov">          0 :                                     BSWAP_64(</span>
<span class="lineNum">    3359 </span>                :            :                                     drr-&gt;drr_u.drr_write.drr_compressed_size);
<span class="lineNum">    3360 </span>                :            :                         }
<span class="lineNum">    3361 </span>                :<span class="lineCov">       3232 :                         uint64_t payload_size =</span>
<span class="lineNum">    3362 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3232 times"> + </span>]:<span class="lineCov">       3232 :                             DRR_WRITE_PAYLOAD_SIZE(&amp;drr-&gt;drr_u.drr_write);</span>
<span class="lineNum">    3363 </span>                :<span class="lineCov">       3232 :                         (void) recv_read(hdl, fd, buf,</span>
<span class="lineNum">    3364 </span>                :            :                             payload_size, B_FALSE, NULL);
<span class="lineNum">    3365 </span>                :<span class="lineCov">       3232 :                         break;</span>
<span class="lineNum">    3366 </span>                :            :                 case DRR_SPILL:
<span class="lineNum">    3367 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (byteswap) {</span>
<span class="lineNum">    3368 </span>                :<span class="lineNoCov">          0 :                                 drr-&gt;drr_u.drr_spill.drr_length =</span>
<span class="lineNum">    3369 </span>                :<span class="lineNoCov">          0 :                                     BSWAP_64(drr-&gt;drr_u.drr_spill.drr_length);</span>
<span class="lineNum">    3370 </span>                :            :                         }
<span class="lineNum">    3371 </span>                :<span class="lineNoCov">          0 :                         (void) recv_read(hdl, fd, buf,</span>
<span class="lineNum">    3372 </span>                :<span class="lineNoCov">          0 :                             drr-&gt;drr_u.drr_spill.drr_length, B_FALSE, NULL);</span>
<span class="lineNum">    3373 </span>                :<span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    3374 </span>                :            :                 case DRR_WRITE_EMBEDDED:
<span class="lineNum">    3375 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (byteswap) {</span>
<span class="lineNum">    3376 </span>                :<span class="lineNoCov">          0 :                                 drr-&gt;drr_u.drr_write_embedded.drr_psize =</span>
<span class="lineNum">    3377 </span>                :<span class="lineNoCov">          0 :                                     BSWAP_32(drr-&gt;drr_u.drr_write_embedded.</span>
<span class="lineNum">    3378 </span>                :            :                                     drr_psize);
<span class="lineNum">    3379 </span>                :            :                         }
<span class="lineNum">    3380 </span>                :<span class="lineNoCov">          0 :                         (void) recv_read(hdl, fd, buf,</span>
<span class="lineNum">    3381 </span>                :<span class="lineNoCov">          0 :                             P2ROUNDUP(drr-&gt;drr_u.drr_write_embedded.drr_psize,</span>
<span class="lineNum">    3382 </span>                :            :                             8), B_FALSE, NULL);
<span class="lineNum">    3383 </span>                :<span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    3384 </span>                :            :                 case DRR_WRITE_BYREF:
<span class="lineNum">    3385 </span>                :            :                 case DRR_FREEOBJECTS:
<span class="lineNum">    3386 </span>                :            :                 case DRR_FREE:
<span class="lineNum">    3387 </span>                :            :                         break;
<span class="lineNum">    3388 </span>                :            : 
<span class="lineNum">    3389 </span>                :            :                 default:
<span class="lineNum">    3390 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3391 </span>                :            :                             &quot;invalid record type&quot;));
<span class="lineNum">    3392 </span>                :<span class="lineNoCov">          0 :                         free(buf);</span>
<span class="lineNum">    3393 </span>                :<span class="lineNoCov">          0 :                         return (zfs_error(hdl, EZFS_BADSTREAM, errbuf));</span>
<span class="lineNum">    3394 </span>                :            :                 }
<span class="lineNum">    3395 </span>                :            :         }
<span class="lineNum">    3396 </span>                :            : 
<span class="lineNum">    3397 </span>                :<span class="lineNoCov">          0 :         free(buf);</span>
<span class="lineNum">    3398 </span>                :<span class="lineNoCov">          0 :         return (-1);</span>
<span class="lineNum">    3399 </span>                :            : }
<a name="3400"><span class="lineNum">    3400 </span>                :            : </a>
<span class="lineNum">    3401 </span>                :            : static void
<span class="lineNum">    3402 </span>                :<span class="lineCov">         17 : recv_ecksum_set_aux(libzfs_handle_t *hdl, const char *target_snap,</span>
<span class="lineNum">    3403 </span>                :            :     boolean_t resumable)
<span class="lineNum">    3404 </span>                :            : {
<span class="lineNum">    3405 </span>                :            :         char target_fs[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    3406 </span>                :            : 
<span class="lineNum">    3407 </span>                :<span class="lineCov">         17 :         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3408 </span>                :            :             &quot;checksum mismatch or incomplete stream&quot;));
<span class="lineNum">    3409 </span>                :            : 
<span class="lineNum">    3410 </span>        [<span class="branchCov" title="Branch 0 was taken 15 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">         17 :         if (!resumable)</span>
<span class="lineNum">    3411 </span>                :<span class="lineCov">          2 :                 return;</span>
<span class="lineNum">    3412 </span>                :<span class="lineCov">         15 :         (void) strlcpy(target_fs, target_snap, sizeof (target_fs));</span>
<span class="lineNum">    3413 </span>                :<span class="lineCov">         15 :         *strchr(target_fs, '@') = '\0';</span>
<span class="lineNum">    3414 </span>                :<span class="lineCov">         15 :         zfs_handle_t *zhp = zfs_open(hdl, target_fs,</span>
<span class="lineNum">    3415 </span>                :            :             ZFS_TYPE_FILESYSTEM | ZFS_TYPE_VOLUME);
<span class="lineNum">    3416 </span>        [<span class="branchCov" title="Branch 0 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         15 :         if (zhp == NULL)</span>
<span class="lineNum">    3417 </span>                :            :                 return;
<span class="lineNum">    3418 </span>                :            : 
<span class="lineNum">    3419 </span>                :            :         char token_buf[ZFS_MAXPROPLEN];
<span class="lineNum">    3420 </span>                :<span class="lineCov">         15 :         int error = zfs_prop_get(zhp, ZFS_PROP_RECEIVE_RESUME_TOKEN,</span>
<span class="lineNum">    3421 </span>                :            :             token_buf, sizeof (token_buf),
<span class="lineNum">    3422 </span>                :            :             NULL, NULL, 0, B_TRUE);
<span class="lineNum">    3423 </span>        [<span class="branchCov" title="Branch 0 was taken 15 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         15 :         if (error == 0) {</span>
<span class="lineNum">    3424 </span>                :<span class="lineCov">         15 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3425 </span>                :            :                     &quot;checksum mismatch or incomplete stream.\n&quot;
<span class="lineNum">    3426 </span>                :            :                     &quot;Partially received snapshot is saved.\n&quot;
<span class="lineNum">    3427 </span>                :            :                     &quot;A resuming stream can be generated on the sending &quot;
<span class="lineNum">    3428 </span>                :            :                     &quot;system by running:\n&quot;
<span class="lineNum">    3429 </span>                :            :                     &quot;    zfs send -t %s&quot;),
<span class="lineNum">    3430 </span>                :            :                     token_buf);
<span class="lineNum">    3431 </span>                :            :         }
<span class="lineNum">    3432 </span>                :<span class="lineCov">         15 :         zfs_close(zhp);</span>
<span class="lineNum">    3433 </span>                :            : }
<span class="lineNum">    3434 </span>                :            : 
<span class="lineNum">    3435 </span>                :            : /*
<span class="lineNum">    3436 </span>                :            :  * Prepare a new nvlist of properties that are to override (-o) or be excluded
<span class="lineNum">    3437 </span>                :            :  * (-x) from the received dataset
<span class="lineNum">    3438 </span>                :            :  * recvprops: received properties from the send stream
<span class="lineNum">    3439 </span>                :            :  * cmdprops: raw input properties from command line
<span class="lineNum">    3440 </span>                :            :  * origprops: properties, both locally-set and received, currently set on the
<span class="lineNum">    3441 </span>                :            :  *            target dataset if it exists, NULL otherwise.
<span class="lineNum">    3442 </span>                :            :  * oxprops: valid output override (-o) and excluded (-x) properties
<a name="3443"><span class="lineNum">    3443 </span>                :            :  */</a>
<span class="lineNum">    3444 </span>                :            : static int
<span class="lineNum">    3445 </span>                :<span class="lineCov">        918 : zfs_setup_cmdline_props(libzfs_handle_t *hdl, zfs_type_t type, boolean_t zoned,</span>
<span class="lineNum">    3446 </span>                :            :     boolean_t recursive, boolean_t toplevel, nvlist_t *recvprops,
<span class="lineNum">    3447 </span>                :            :     nvlist_t *cmdprops, nvlist_t *origprops, nvlist_t **oxprops,
<span class="lineNum">    3448 </span>                :            :     const char *errbuf)
<span class="lineNum">    3449 </span>                :            : {
<span class="lineNum">    3450 </span>                :            :         nvpair_t *nvp;
<span class="lineNum">    3451 </span>                :            :         nvlist_t *oprops, *voprops;
<span class="lineNum">    3452 </span>                :<span class="lineCov">        918 :         zfs_handle_t *zhp = NULL;</span>
<span class="lineNum">    3453 </span>                :<span class="lineCov">        918 :         zpool_handle_t *zpool_hdl = NULL;</span>
<span class="lineNum">    3454 </span>                :<span class="lineCov">        918 :         int ret = 0;</span>
<span class="lineNum">    3455 </span>                :            : 
<span class="lineNum">    3456 </span>        [<span class="branchCov" title="Branch 1 was taken 17 times"> + </span><span class="branchCov" title="Branch 2 was taken 901 times"> + </span>]:<span class="lineCov">        918 :         if (nvlist_empty(cmdprops))</span>
<span class="lineNum">    3457 </span>                :            :                 return (0); /* No properties to override or exclude */
<span class="lineNum">    3458 </span>                :            : 
<span class="lineNum">    3459 </span>                :<span class="lineCov">         17 :         *oxprops = fnvlist_alloc();</span>
<span class="lineNum">    3460 </span>                :<span class="lineCov">         17 :         oprops = fnvlist_alloc();</span>
<span class="lineNum">    3461 </span>                :            : 
<span class="lineNum">    3462 </span>                :            :         /*
<span class="lineNum">    3463 </span>                :            :          * first iteration: process excluded (-x) properties now and gather
<span class="lineNum">    3464 </span>                :            :          * added (-o) properties to be later processed by zfs_valid_proplist()
<span class="lineNum">    3465 </span>                :            :          */
<span class="lineNum">    3466 </span>                :<span class="lineCov">         17 :         nvp = NULL;</span>
<span class="lineNum">    3467 </span>        [<span class="branchCov" title="Branch 1 was taken 38 times"> + </span><span class="branchCov" title="Branch 2 was taken 15 times"> + </span>]:<span class="lineCov">         53 :         while ((nvp = nvlist_next_nvpair(cmdprops, nvp)) != NULL) {</span>
<span class="lineNum">    3468 </span>                :<span class="lineCov">         38 :                 const char *name = nvpair_name(nvp);</span>
<span class="lineNum">    3469 </span>                :<span class="lineCov">         38 :                 zfs_prop_t prop = zfs_name_to_prop(name);</span>
<span class="lineNum">    3470 </span>                :            : 
<span class="lineNum">    3471 </span>                :            :                 /* &quot;origin&quot; is processed separately, don't handle it here */
<span class="lineNum">    3472 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 35 times"> + </span>]:<span class="lineCov">         38 :                 if (prop == ZFS_PROP_ORIGIN)</span>
<span class="lineNum">    3473 </span>                :<span class="lineCov">          3 :                         continue;</span>
<span class="lineNum">    3474 </span>                :            : 
<span class="lineNum">    3475 </span>                :            :                 /*
<span class="lineNum">    3476 </span>                :            :                  * we're trying to override or exclude a property that does not
<span class="lineNum">    3477 </span>                :            :                  * make sense for this type of dataset, but we don't want to
<span class="lineNum">    3478 </span>                :            :                  * fail if the receive is recursive: this comes in handy when
<span class="lineNum">    3479 </span>                :            :                  * the send stream contains, for instance, a child ZVOL and
<span class="lineNum">    3480 </span>                :            :                  * we're trying to receive it with &quot;-o atime=on&quot;
<span class="lineNum">    3481 </span>                :            :                  */
<span class="lineNum">    3482 </span>  [<span class="branchCov" title="Branch 1 was taken 15 times"> + </span><span class="branchCov" title="Branch 2 was taken 20 times"> + </span><span class="branchCov" title="Branch 3 was taken 3 times"> + </span><span class="branchCov" title="Branch 4 was taken 12 times"> + </span>]:<span class="lineCov">         50 :                 if (!zfs_prop_valid_for_type(prop, type, B_FALSE) &amp;&amp;</span>
<span class="lineNum">    3483 </span>                :<span class="lineCov">         15 :                     !zfs_prop_user(name)) {</span>
<span class="lineNum">    3484 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          3 :                         if (recursive)</span>
<span class="lineNum">    3485 </span>                :<span class="lineCov">          1 :                                 continue;</span>
<span class="lineNum">    3486 </span>                :<span class="lineCov">          2 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3487 </span>                :            :                             &quot;property '%s' does not apply to datasets of this &quot;
<span class="lineNum">    3488 </span>                :            :                             &quot;type&quot;), name);
<span class="lineNum">    3489 </span>                :<span class="lineCov">          2 :                         ret = zfs_error(hdl, EZFS_BADPROP, errbuf);</span>
<span class="lineNum">    3490 </span>                :<span class="lineCov">          2 :                         goto error;</span>
<span class="lineNum">    3491 </span>                :            :                 }
<span class="lineNum">    3492 </span>                :            : 
<span class="lineNum">    3493 </span>     [<span class="branchCov" title="Branch 1 was taken 20 times"> + </span><span class="branchCov" title="Branch 2 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">         32 :                 switch (nvpair_type(nvp)) {</span>
<span class="lineNum">    3494 </span>                :            :                 case DATA_TYPE_BOOLEAN: /* -x property */
<span class="lineNum">    3495 </span>                :            :                         /*
<span class="lineNum">    3496 </span>                :            :                          * DATA_TYPE_BOOLEAN is the way we're asked to &quot;exclude&quot;
<span class="lineNum">    3497 </span>                :            :                          * a property: this is done by forcing an explicit
<span class="lineNum">    3498 </span>                :            :                          * inherit on the destination so the effective value is
<span class="lineNum">    3499 </span>                :            :                          * not the one we received from the send stream.
<span class="lineNum">    3500 </span>                :            :                          * We do this only if the property is not already
<span class="lineNum">    3501 </span>                :            :                          * locally-set, in which case its value will take
<span class="lineNum">    3502 </span>                :            :                          * priority over the received anyway.
<span class="lineNum">    3503 </span>                :            :                          */
<span class="lineNum">    3504 </span>        [<span class="branchCov" title="Branch 1 was taken 10 times"> + </span><span class="branchCov" title="Branch 2 was taken 10 times"> + </span>]:<span class="lineCov">         20 :                         if (nvlist_exists(origprops, name)) {</span>
<span class="lineNum">    3505 </span>                :            :                                 nvlist_t *attrs;
<span class="lineNum">    3506 </span>                :            : 
<span class="lineNum">    3507 </span>                :<span class="lineCov">         10 :                                 attrs = fnvlist_lookup_nvlist(origprops, name);</span>
<span class="lineNum">    3508 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchCov" title="Branch 2 was taken 3 times"> + </span>]:<span class="lineCov">         10 :                                 if (strcmp(fnvlist_lookup_string(attrs,</span>
<span class="lineNum">    3509 </span>                :            :                                     ZPROP_SOURCE), ZPROP_SOURCE_VAL_RECVD) != 0)
<span class="lineNum">    3510 </span>                :<span class="lineCov">          7 :                                         continue;</span>
<span class="lineNum">    3511 </span>                :            :                         }
<span class="lineNum">    3512 </span>                :            :                         /*
<span class="lineNum">    3513 </span>                :            :                          * We can't force an explicit inherit on non-inheritable
<span class="lineNum">    3514 </span>                :            :                          * properties: if we're asked to exclude this kind of
<span class="lineNum">    3515 </span>                :            :                          * values we remove them from &quot;recvprops&quot; input nvlist.
<span class="lineNum">    3516 </span>                :            :                          */
<span class="lineNum">    3517 </span>  [<span class="branchCov" title="Branch 1 was taken 9 times"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span><span class="branchCov" title="Branch 3 was taken 3 times"> + </span><span class="branchCov" title="Branch 4 was taken 6 times"> + </span>]:<span class="lineCov">         22 :                         if (!zfs_prop_inheritable(prop) &amp;&amp;</span>
<span class="lineNum">    3518 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span>]:<span class="lineCov">         12 :                             !zfs_prop_user(name) &amp;&amp; /* can be inherited too */</span>
<span class="lineNum">    3519 </span>                :<span class="lineCov">          3 :                             nvlist_exists(recvprops, name))</span>
<span class="lineNum">    3520 </span>                :<span class="lineCov">          1 :                                 fnvlist_remove(recvprops, name);</span>
<span class="lineNum">    3521 </span>                :            :                         else
<span class="lineNum">    3522 </span>                :<span class="lineCov">         12 :                                 fnvlist_add_nvpair(*oxprops, nvp);</span>
<span class="lineNum">    3523 </span>                :            :                         break;
<span class="lineNum">    3524 </span>                :            :                 case DATA_TYPE_STRING: /* -o property=value */
<span class="lineNum">    3525 </span>                :<span class="lineCov">         12 :                         fnvlist_add_nvpair(oprops, nvp);</span>
<span class="lineNum">    3526 </span>                :<span class="lineCov">         36 :                         break;</span>
<span class="lineNum">    3527 </span>                :            :                 default:
<span class="lineNum">    3528 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3529 </span>                :            :                             &quot;property '%s' must be a string or boolean&quot;), name);
<span class="lineNum">    3530 </span>                :<span class="lineNoCov">          0 :                         ret = zfs_error(hdl, EZFS_BADPROP, errbuf);</span>
<span class="lineNum">    3531 </span>                :<span class="lineNoCov">          0 :                         goto error;</span>
<span class="lineNum">    3532 </span>                :            :                 }
<span class="lineNum">    3533 </span>                :            :         }
<span class="lineNum">    3534 </span>                :            : 
<span class="lineNum">    3535 </span>        [<span class="branchCov" title="Branch 0 was taken 5 times"> + </span><span class="branchCov" title="Branch 1 was taken 10 times"> + </span>]:<span class="lineCov">         15 :         if (toplevel) {</span>
<span class="lineNum">    3536 </span>                :            :                 /* convert override strings properties to native */
<span class="lineNum">    3537 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 10 times"> + </span>]:<span class="lineCov">         10 :                 if ((voprops = zfs_valid_proplist(hdl, ZFS_TYPE_DATASET,</span>
<span class="lineNum">    3538 </span>                :            :                     oprops, zoned, zhp, zpool_hdl, B_FALSE, errbuf)) == NULL) {
<span class="lineNum">    3539 </span>                :<span class="lineNoCov">          0 :                         ret = zfs_error(hdl, EZFS_BADPROP, errbuf);</span>
<span class="lineNum">    3540 </span>                :<span class="lineNoCov">          0 :                         goto error;</span>
<span class="lineNum">    3541 </span>                :            :                 }
<span class="lineNum">    3542 </span>                :            : 
<span class="lineNum">    3543 </span>                :            :                 /* second pass: process &quot;-o&quot; properties */
<span class="lineNum">    3544 </span>                :<span class="lineCov">         10 :                 fnvlist_merge(*oxprops, voprops);</span>
<span class="lineNum">    3545 </span>                :<span class="lineCov">         10 :                 fnvlist_free(voprops);</span>
<span class="lineNum">    3546 </span>                :            :         } else {
<span class="lineNum">    3547 </span>                :            :                 /* override props on child dataset are inherited */
<span class="lineNum">    3548 </span>                :            :                 nvp = NULL;
<span class="lineNum">    3549 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchCov" title="Branch 2 was taken 5 times"> + </span>]:<span class="lineCov">          8 :                 while ((nvp = nvlist_next_nvpair(oprops, nvp)) != NULL) {</span>
<span class="lineNum">    3550 </span>                :<span class="lineCov">          3 :                         const char *name = nvpair_name(nvp);</span>
<span class="lineNum">    3551 </span>                :<span class="lineCov">          3 :                         fnvlist_add_boolean(*oxprops, name);</span>
<span class="lineNum">    3552 </span>                :            :                 }
<span class="lineNum">    3553 </span>                :            :         }
<span class="lineNum">    3554 </span>                :            : 
<span class="lineNum">    3555 </span>                :            : error:
<span class="lineNum">    3556 </span>                :<span class="lineCov">         17 :         fnvlist_free(oprops);</span>
<span class="lineNum">    3557 </span>                :<span class="lineCov">         17 :         return (ret);</span>
<span class="lineNum">    3558 </span>                :            : }
<span class="lineNum">    3559 </span>                :            : 
<span class="lineNum">    3560 </span>                :            : /*
<span class="lineNum">    3561 </span>                :            :  * Restores a backup of tosnap from the file descriptor specified by infd.
<a name="3562"><span class="lineNum">    3562 </span>                :            :  */</a>
<span class="lineNum">    3563 </span>                :            : static int
<span class="lineNum">    3564 </span>                :<span class="lineCov">        924 : zfs_receive_one(libzfs_handle_t *hdl, int infd, const char *tosnap,</span>
<span class="lineNum">    3565 </span>                :            :     const char *originsnap, recvflags_t *flags, dmu_replay_record_t *drr,
<span class="lineNum">    3566 </span>                :            :     dmu_replay_record_t *drr_noswap, const char *sendfs, nvlist_t *stream_nv,
<span class="lineNum">    3567 </span>                :            :     avl_tree_t *stream_avl, char **top_zfs, int cleanup_fd,
<span class="lineNum">    3568 </span>                :            :     uint64_t *action_handlep, const char *finalsnap, nvlist_t *cmdprops)
<span class="lineNum">    3569 </span>                :            : {
<span class="lineNum">    3570 </span>                :            :         time_t begin_time;
<span class="lineNum">    3571 </span>                :            :         int ioctl_err, ioctl_errno, err;
<span class="lineNum">    3572 </span>                :            :         char *cp;
<span class="lineNum">    3573 </span>                :<span class="lineCov">        924 :         struct drr_begin *drrb = &amp;drr-&gt;drr_u.drr_begin;</span>
<span class="lineNum">    3574 </span>                :            :         char errbuf[1024];
<span class="lineNum">    3575 </span>                :            :         const char *chopprefix;
<span class="lineNum">    3576 </span>                :<span class="lineCov">        924 :         boolean_t newfs = B_FALSE;</span>
<span class="lineNum">    3577 </span>                :            :         boolean_t stream_wantsnewfs;
<span class="lineNum">    3578 </span>                :<span class="lineCov">        924 :         boolean_t newprops = B_FALSE;</span>
<span class="lineNum">    3579 </span>                :<span class="lineCov">        924 :         uint64_t read_bytes = 0;</span>
<span class="lineNum">    3580 </span>                :<span class="lineCov">        924 :         uint64_t errflags = 0;</span>
<span class="lineNum">    3581 </span>                :<span class="lineCov">        924 :         uint64_t parent_snapguid = 0;</span>
<span class="lineNum">    3582 </span>                :<span class="lineCov">        924 :         prop_changelist_t *clp = NULL;</span>
<span class="lineNum">    3583 </span>                :<span class="lineCov">        924 :         nvlist_t *snapprops_nvlist = NULL;</span>
<span class="lineNum">    3584 </span>                :            :         zprop_errflags_t prop_errflags;
<span class="lineNum">    3585 </span>                :<span class="lineCov">        924 :         nvlist_t *prop_errors = NULL;</span>
<span class="lineNum">    3586 </span>                :            :         boolean_t recursive;
<span class="lineNum">    3587 </span>                :<span class="lineCov">        924 :         char *snapname = NULL;</span>
<span class="lineNum">    3588 </span>                :            :         char destsnap[MAXPATHLEN * 2];
<span class="lineNum">    3589 </span>                :            :         char origin[MAXNAMELEN];
<span class="lineNum">    3590 </span>                :            :         char name[MAXPATHLEN];
<span class="lineNum">    3591 </span>                :            :         char tmp_keylocation[MAXNAMELEN];
<span class="lineNum">    3592 </span>                :<span class="lineCov">        924 :         nvlist_t *rcvprops = NULL; /* props received from the send stream */</span>
<span class="lineNum">    3593 </span>                :<span class="lineCov">        924 :         nvlist_t *oxprops = NULL; /* override (-o) and exclude (-x) props */</span>
<span class="lineNum">    3594 </span>                :<span class="lineCov">        924 :         nvlist_t *origprops = NULL; /* original props (if destination exists) */</span>
<span class="lineNum">    3595 </span>                :            :         zfs_type_t type;
<span class="lineNum">    3596 </span>                :            :         boolean_t toplevel;
<span class="lineNum">    3597 </span>                :<span class="lineCov">        924 :         boolean_t zoned = B_FALSE;</span>
<span class="lineNum">    3598 </span>                :            : 
<span class="lineNum">    3599 </span>                :<span class="lineCov">        924 :         begin_time = time(NULL);</span>
<span class="lineNum">    3600 </span>                :<span class="lineCov">        924 :         bzero(origin, MAXNAMELEN);</span>
<span class="lineNum">    3601 </span>                :<span class="lineCov">        924 :         bzero(tmp_keylocation, MAXNAMELEN);</span>
<span class="lineNum">    3602 </span>                :            : 
<span class="lineNum">    3603 </span>                :<span class="lineCov">       1848 :         (void) snprintf(errbuf, sizeof (errbuf), dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3604 </span>                :            :             &quot;cannot receive&quot;));
<span class="lineNum">    3605 </span>                :            : 
<span class="lineNum">    3606 </span>                :<span class="lineCov">        924 :         recursive = (nvlist_lookup_boolean(stream_nv, &quot;not_recursive&quot;) ==</span>
<span class="lineNum">    3607 </span>                :            :             ENOENT);
<span class="lineNum">    3608 </span>                :            : 
<span class="lineNum">    3609 </span>        [<span class="branchCov" title="Branch 0 was taken 771 times"> + </span><span class="branchCov" title="Branch 1 was taken 153 times"> + </span>]:<span class="lineCov">        924 :         if (stream_avl != NULL) {</span>
<span class="lineNum">    3610 </span>                :<span class="lineCov">        771 :                 char *keylocation = NULL;</span>
<span class="lineNum">    3611 </span>                :<span class="lineCov">        771 :                 nvlist_t *lookup = NULL;</span>
<span class="lineNum">    3612 </span>                :<span class="lineCov">        771 :                 nvlist_t *fs = fsavl_find(stream_avl, drrb-&gt;drr_toguid,</span>
<span class="lineNum">    3613 </span>                :            :                     &amp;snapname);
<span class="lineNum">    3614 </span>                :            : 
<span class="lineNum">    3615 </span>                :<span class="lineCov">        771 :                 (void) nvlist_lookup_uint64(fs, &quot;parentfromsnap&quot;,</span>
<span class="lineNum">    3616 </span>                :            :                     &amp;parent_snapguid);
<span class="lineNum">    3617 </span>                :<span class="lineCov">        771 :                 err = nvlist_lookup_nvlist(fs, &quot;props&quot;, &amp;rcvprops);</span>
<span class="lineNum">    3618 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 771 times"> + </span>]:<span class="lineCov">        771 :                 if (err) {</span>
<span class="lineNum">    3619 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         VERIFY(0 == nvlist_alloc(&amp;rcvprops, NV_UNIQUE_NAME, 0));</span>
<span class="lineNum">    3620 </span>                :            :                         newprops = B_TRUE;
<span class="lineNum">    3621 </span>                :            :                 }
<span class="lineNum">    3622 </span>                :            : 
<span class="lineNum">    3623 </span>                :            :                 /*
<span class="lineNum">    3624 </span>                :            :                  * The keylocation property may only be set on encryption roots,
<span class="lineNum">    3625 </span>                :            :                  * but this dataset might not become an encryption root until
<span class="lineNum">    3626 </span>                :            :                  * recv_fix_encryption_heirarchy() is called. That function
<span class="lineNum">    3627 </span>                :            :                  * will fixup the keylocation anyway, so we temporarily unset
<span class="lineNum">    3628 </span>                :            :                  * the keylocation for now to avoid any errors from the receive
<span class="lineNum">    3629 </span>                :            :                  * ioctl.
<span class="lineNum">    3630 </span>                :            :                  */
<span class="lineNum">    3631 </span>                :<span class="lineCov">        771 :                 err = nvlist_lookup_string(rcvprops,</span>
<span class="lineNum">    3632 </span>                :            :                     zfs_prop_to_name(ZFS_PROP_KEYLOCATION), &amp;keylocation);
<span class="lineNum">    3633 </span>        [<span class="branchCov" title="Branch 0 was taken 21 times"> + </span><span class="branchCov" title="Branch 1 was taken 750 times"> + </span>]:<span class="lineCov">        771 :                 if (err == 0) {</span>
<span class="lineNum">    3634 </span>                :<span class="lineCov">         42 :                         strcpy(tmp_keylocation, keylocation);</span>
<span class="lineNum">    3635 </span>                :<span class="lineCov">         21 :                         (void) nvlist_remove_all(rcvprops,</span>
<span class="lineNum">    3636 </span>                :            :                             zfs_prop_to_name(ZFS_PROP_KEYLOCATION));
<span class="lineNum">    3637 </span>                :            :                 }
<span class="lineNum">    3638 </span>                :            : 
<span class="lineNum">    3639 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 771 times"> + </span>]:<span class="lineCov">        771 :                 if (flags-&gt;canmountoff) {</span>
<span class="lineNum">    3640 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         VERIFY(0 == nvlist_add_uint64(rcvprops,</span>
<span class="lineNum">    3641 </span>                :            :                             zfs_prop_to_name(ZFS_PROP_CANMOUNT), 0));
<span class="lineNum">    3642 </span>                :            :                 }
<span class="lineNum">    3643 </span>        [<span class="branchCov" title="Branch 1 was taken 771 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        771 :                 if (0 == nvlist_lookup_nvlist(fs, &quot;snapprops&quot;, &amp;lookup)) {</span>
<span class="lineNum">    3644 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 771 times"> + </span>]:<span class="lineCov">        771 :                         VERIFY(0 == nvlist_lookup_nvlist(lookup,</span>
<span class="lineNum">    3645 </span>                :            :                             snapname, &amp;snapprops_nvlist));
<span class="lineNum">    3646 </span>                :            :                 }
<span class="lineNum">    3647 </span>                :            :         }
<span class="lineNum">    3648 </span>                :            : 
<span class="lineNum">    3649 </span>                :<span class="lineCov">        924 :         cp = NULL;</span>
<span class="lineNum">    3650 </span>                :            : 
<span class="lineNum">    3651 </span>                :            :         /*
<span class="lineNum">    3652 </span>                :            :          * Determine how much of the snapshot name stored in the stream
<span class="lineNum">    3653 </span>                :            :          * we are going to tack on to the name they specified on the
<span class="lineNum">    3654 </span>                :            :          * command line, and how much we are going to chop off.
<span class="lineNum">    3655 </span>                :            :          *
<span class="lineNum">    3656 </span>                :            :          * If they specified a snapshot, chop the entire name stored in
<span class="lineNum">    3657 </span>                :            :          * the stream.
<span class="lineNum">    3658 </span>                :            :          */
<span class="lineNum">    3659 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 924 times"> + </span>]:<span class="lineCov">        924 :         if (flags-&gt;istail) {</span>
<span class="lineNum">    3660 </span>                :            :                 /*
<span class="lineNum">    3661 </span>                :            :                  * A filesystem was specified with -e. We want to tack on only
<span class="lineNum">    3662 </span>                :            :                  * the tail of the sent snapshot path.
<span class="lineNum">    3663 </span>                :            :                  */
<span class="lineNum">    3664 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (strchr(tosnap, '@')) {</span>
<span class="lineNum">    3665 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN, &quot;invalid &quot;</span>
<span class="lineNum">    3666 </span>                :            :                             &quot;argument - snapshot not allowed with -e&quot;));
<span class="lineNum">    3667 </span>                :<span class="lineNoCov">          0 :                         err = zfs_error(hdl, EZFS_INVALIDNAME, errbuf);</span>
<span class="lineNum">    3668 </span>                :<span class="lineNoCov">          0 :                         goto out;</span>
<span class="lineNum">    3669 </span>                :            :                 }
<span class="lineNum">    3670 </span>                :            : 
<span class="lineNum">    3671 </span>                :<span class="lineNoCov">          0 :                 chopprefix = strrchr(sendfs, '/');</span>
<span class="lineNum">    3672 </span>                :            : 
<span class="lineNum">    3673 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (chopprefix == NULL) {</span>
<span class="lineNum">    3674 </span>                :            :                         /*
<span class="lineNum">    3675 </span>                :            :                          * The tail is the poolname, so we need to
<span class="lineNum">    3676 </span>                :            :                          * prepend a path separator.
<span class="lineNum">    3677 </span>                :            :                          */
<span class="lineNum">    3678 </span>                :<span class="lineNoCov">          0 :                         int len = strlen(drrb-&gt;drr_toname);</span>
<span class="lineNum">    3679 </span>                :<span class="lineNoCov">          0 :                         cp = malloc(len + 2);</span>
<span class="lineNum">    3680 </span>                :<span class="lineNoCov">          0 :                         cp[0] = '/';</span>
<span class="lineNum">    3681 </span>                :<span class="lineNoCov">          0 :                         (void) strcpy(&amp;cp[1], drrb-&gt;drr_toname);</span>
<span class="lineNum">    3682 </span>                :<span class="lineNoCov">          0 :                         chopprefix = cp;</span>
<span class="lineNum">    3683 </span>                :            :                 } else {
<span class="lineNum">    3684 </span>                :<span class="lineNoCov">          0 :                         chopprefix = drrb-&gt;drr_toname + (chopprefix - sendfs);</span>
<span class="lineNum">    3685 </span>                :            :                 }
<span class="lineNum">    3686 </span>        [<span class="branchCov" title="Branch 0 was taken 766 times"> + </span><span class="branchCov" title="Branch 1 was taken 158 times"> + </span>]:<span class="lineCov">        924 :         } else if (flags-&gt;isprefix) {</span>
<span class="lineNum">    3687 </span>                :            :                 /*
<span class="lineNum">    3688 </span>                :            :                  * A filesystem was specified with -d. We want to tack on
<span class="lineNum">    3689 </span>                :            :                  * everything but the first element of the sent snapshot path
<span class="lineNum">    3690 </span>                :            :                  * (all but the pool name).
<span class="lineNum">    3691 </span>                :            :                  */
<span class="lineNum">    3692 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 766 times"> + </span>]:<span class="lineCov">        766 :                 if (strchr(tosnap, '@')) {</span>
<span class="lineNum">    3693 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN, &quot;invalid &quot;</span>
<span class="lineNum">    3694 </span>                :            :                             &quot;argument - snapshot not allowed with -d&quot;));
<span class="lineNum">    3695 </span>                :<span class="lineNoCov">          0 :                         err = zfs_error(hdl, EZFS_INVALIDNAME, errbuf);</span>
<span class="lineNum">    3696 </span>                :<span class="lineNoCov">          0 :                         goto out;</span>
<span class="lineNum">    3697 </span>                :            :                 }
<span class="lineNum">    3698 </span>                :            : 
<span class="lineNum">    3699 </span>                :<span class="lineCov">        766 :                 chopprefix = strchr(drrb-&gt;drr_toname, '/');</span>
<span class="lineNum">    3700 </span>        [<span class="branchCov" title="Branch 0 was taken 99 times"> + </span><span class="branchCov" title="Branch 1 was taken 667 times"> + </span>]:<span class="lineCov">        766 :                 if (chopprefix == NULL)</span>
<span class="lineNum">    3701 </span>                :<span class="lineCov">         99 :                         chopprefix = strchr(drrb-&gt;drr_toname, '@');</span>
<span class="lineNum">    3702 </span>        [<span class="branchCov" title="Branch 0 was taken 149 times"> + </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>]:<span class="lineCov">        158 :         } else if (strchr(tosnap, '@') == NULL) {</span>
<span class="lineNum">    3703 </span>                :            :                 /*
<span class="lineNum">    3704 </span>                :            :                  * If a filesystem was specified without -d or -e, we want to
<span class="lineNum">    3705 </span>                :            :                  * tack on everything after the fs specified by 'zfs send'.
<span class="lineNum">    3706 </span>                :            :                  */
<span class="lineNum">    3707 </span>                :<span class="lineCov">        149 :                 chopprefix = drrb-&gt;drr_toname + strlen(sendfs);</span>
<span class="lineNum">    3708 </span>                :            :         } else {
<span class="lineNum">    3709 </span>                :            :                 /* A snapshot was specified as an exact path (no -d or -e). */
<span class="lineNum">    3710 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>]:<span class="lineCov">          9 :                 if (recursive) {</span>
<span class="lineNum">    3711 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3712 </span>                :            :                             &quot;cannot specify snapshot name for multi-snapshot &quot;
<span class="lineNum">    3713 </span>                :            :                             &quot;stream&quot;));
<span class="lineNum">    3714 </span>                :<span class="lineNoCov">          0 :                         err = zfs_error(hdl, EZFS_BADSTREAM, errbuf);</span>
<span class="lineNum">    3715 </span>                :<span class="lineNoCov">          0 :                         goto out;</span>
<span class="lineNum">    3716 </span>                :            :                 }
<span class="lineNum">    3717 </span>                :<span class="lineCov">          9 :                 chopprefix = drrb-&gt;drr_toname + strlen(drrb-&gt;drr_toname);</span>
<span class="lineNum">    3718 </span>                :            :         }
<span class="lineNum">    3719 </span>                :            : 
<span class="lineNum">    3720 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 924 times"> + </span>]:<span class="lineCov">        924 :         ASSERT(strstr(drrb-&gt;drr_toname, sendfs) == drrb-&gt;drr_toname);</span>
<span class="lineNum">    3721 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 924 times"> + </span>]:<span class="lineCov">        924 :         ASSERT(chopprefix &gt; drrb-&gt;drr_toname);</span>
<span class="lineNum">    3722 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 924 times"> + </span>]:<span class="lineCov">        924 :         ASSERT(chopprefix &lt;= drrb-&gt;drr_toname + strlen(drrb-&gt;drr_toname));</span>
<span class="lineNum">    3723 </span>[<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchCov" title="Branch 1 was taken 915 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 9 times"> + </span>]:<span class="lineCov">        924 :         ASSERT(chopprefix[0] == '/' || chopprefix[0] == '@' ||</span>
<span class="lineNum">    3724 </span>                :            :             chopprefix[0] == '\0');
<span class="lineNum">    3725 </span>                :            : 
<span class="lineNum">    3726 </span>                :            :         /*
<span class="lineNum">    3727 </span>                :            :          * Determine name of destination snapshot.
<span class="lineNum">    3728 </span>                :            :          */
<span class="lineNum">    3729 </span>                :<span class="lineCov">        924 :         (void) strlcpy(destsnap, tosnap, sizeof (destsnap));</span>
<span class="lineNum">    3730 </span>                :<span class="lineCov">        924 :         (void) strlcat(destsnap, chopprefix, sizeof (destsnap));</span>
<span class="lineNum">    3731 </span>                :<span class="lineCov">        924 :         free(cp);</span>
<span class="lineNum">    3732 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 924 times"> + </span>]:<span class="lineCov">        924 :         if (!zfs_name_valid(destsnap, ZFS_TYPE_SNAPSHOT)) {</span>
<span class="lineNum">    3733 </span>                :<span class="lineNoCov">          0 :                 err = zfs_error(hdl, EZFS_INVALIDNAME, errbuf);</span>
<span class="lineNum">    3734 </span>                :<span class="lineNoCov">          0 :                 goto out;</span>
<span class="lineNum">    3735 </span>                :            :         }
<span class="lineNum">    3736 </span>                :            : 
<span class="lineNum">    3737 </span>                :            :         /*
<span class="lineNum">    3738 </span>                :            :          * Determine the name of the origin snapshot.
<span class="lineNum">    3739 </span>                :            :          */
<span class="lineNum">    3740 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 921 times"> + </span>]:<span class="lineCov">        924 :         if (originsnap) {</span>
<span class="lineNum">    3741 </span>                :<span class="lineCov">          3 :                 (void) strncpy(origin, originsnap, sizeof (origin));</span>
<span class="lineNum">    3742 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          3 :                 if (flags-&gt;verbose)</span>
<span class="lineNum">    3743 </span>                :            :                         (void) printf(&quot;using provided clone origin %s\n&quot;,
<span class="lineNum">    3744 </span>                :            :                             origin);
<span class="lineNum">    3745 </span>        [<span class="branchCov" title="Branch 0 was taken 58 times"> + </span><span class="branchCov" title="Branch 1 was taken 863 times"> + </span>]:<span class="lineCov">        921 :         } else if (drrb-&gt;drr_flags &amp; DRR_FLAG_CLONE) {</span>
<span class="lineNum">    3746 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 58 times"> + </span>]:<span class="lineCov">         58 :                 if (guid_to_name(hdl, destsnap,</span>
<span class="lineNum">    3747 </span>                :            :                     drrb-&gt;drr_fromguid, B_FALSE, origin) != 0) {
<span class="lineNum">    3748 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3749 </span>                :            :                             &quot;local origin for clone %s does not exist&quot;),
<span class="lineNum">    3750 </span>                :            :                             destsnap);
<span class="lineNum">    3751 </span>                :<span class="lineNoCov">          0 :                         err = zfs_error(hdl, EZFS_NOENT, errbuf);</span>
<span class="lineNum">    3752 </span>                :<span class="lineNoCov">          0 :                         goto out;</span>
<span class="lineNum">    3753 </span>                :            :                 }
<span class="lineNum">    3754 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 58 times"> + </span>]:<span class="lineCov">         58 :                 if (flags-&gt;verbose)</span>
<span class="lineNum">    3755 </span>                :            :                         (void) printf(&quot;found clone origin %s\n&quot;, origin);
<span class="lineNum">    3756 </span>                :            :         }
<span class="lineNum">    3757 </span>                :            : 
<span class="lineNum">    3758 </span>                :<span class="lineCov">        924 :         boolean_t resuming = DMU_GET_FEATUREFLAGS(drrb-&gt;drr_versioninfo) &amp;</span>
<span class="lineNum">    3759 </span>                :            :             DMU_BACKUP_FEATURE_RESUMING;
<span class="lineNum">    3760 </span>                :<span class="lineCov">        924 :         boolean_t raw = DMU_GET_FEATUREFLAGS(drrb-&gt;drr_versioninfo) &amp;</span>
<span class="lineNum">    3761 </span>                :            :             DMU_BACKUP_FEATURE_RAW;
<span class="lineNum">    3762 </span>                :<span class="lineCov">        924 :         boolean_t embedded = DMU_GET_FEATUREFLAGS(drrb-&gt;drr_versioninfo) &amp;</span>
<span class="lineNum">    3763 </span>                :            :             DMU_BACKUP_FEATURE_EMBED_DATA;
<span class="lineNum">    3764 </span>        [<span class="branchCov" title="Branch 0 was taken 619 times"> + </span><span class="branchCov" title="Branch 1 was taken 58 times"> + </span>]:<span class="lineCov">        677 :         stream_wantsnewfs = (drrb-&gt;drr_fromguid == 0 ||</span>
<span class="lineNum">    3765 </span>[<span class="branchCov" title="Branch 0 was taken 677 times"> + </span><span class="branchCov" title="Branch 1 was taken 247 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 619 times"> + </span>]:<span class="lineCov">       1601 :             (drrb-&gt;drr_flags &amp; DRR_FLAG_CLONE) || originsnap) &amp;&amp; !resuming;</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 6 times"> + </span><span class="branchCov" title="Branch 5 was taken 299 times"> + </span>]
<span class="lineNum">    3766 </span>                :            : 
<span class="lineNum">    3767 </span>        [<span class="branchCov" title="Branch 0 was taken 299 times"> + </span><span class="branchCov" title="Branch 1 was taken 625 times"> + </span>]:<span class="lineCov">        924 :         if (stream_wantsnewfs) {</span>
<span class="lineNum">    3768 </span>                :            :                 /*
<span class="lineNum">    3769 </span>                :            :                  * if the parent fs does not exist, look for it based on
<span class="lineNum">    3770 </span>                :            :                  * the parent snap GUID
<span class="lineNum">    3771 </span>                :            :                  */
<span class="lineNum">    3772 </span>                :<span class="lineCov">        598 :                 (void) snprintf(errbuf, sizeof (errbuf), dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3773 </span>                :            :                     &quot;cannot receive new filesystem stream&quot;));
<span class="lineNum">    3774 </span>                :            : 
<span class="lineNum">    3775 </span>                :<span class="lineCov">        299 :                 (void) strcpy(name, destsnap);</span>
<span class="lineNum">    3776 </span>                :<span class="lineCov">        299 :                 cp = strrchr(name, '/');</span>
<span class="lineNum">    3777 </span>        [<span class="branchCov" title="Branch 0 was taken 280 times"> + </span><span class="branchCov" title="Branch 1 was taken 19 times"> + </span>]:<span class="lineCov">        299 :                 if (cp)</span>
<span class="lineNum">    3778 </span>                :<span class="lineCov">        280 :                         *cp = '\0';</span>
<span class="lineNum">    3779 </span>  [<span class="branchCov" title="Branch 0 was taken 280 times"> + </span><span class="branchCov" title="Branch 1 was taken 19 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchCov" title="Branch 3 was taken 279 times"> + </span>]:<span class="lineCov">        579 :                 if (cp &amp;&amp;</span>
<span class="lineNum">    3780 </span>                :<span class="lineCov">        280 :                     !zfs_dataset_exists(hdl, name, ZFS_TYPE_DATASET)) {</span>
<span class="lineNum">    3781 </span>                :            :                         char suffix[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    3782 </span>                :<span class="lineCov">          2 :                         (void) strcpy(suffix, strrchr(destsnap, '/'));</span>
<span class="lineNum">    3783 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                         if (guid_to_name(hdl, name, parent_snapguid,</span>
<span class="lineNum">    3784 </span>                :            :                             B_FALSE, destsnap) == 0) {
<span class="lineNum">    3785 </span>                :<span class="lineNoCov">          0 :                                 *strchr(destsnap, '@') = '\0';</span>
<span class="lineNum">    3786 </span>                :            :                                 (void) strcat(destsnap, suffix);
<span class="lineNum">    3787 </span>                :            :                         }
<span class="lineNum">    3788 </span>                :            :                 }
<span class="lineNum">    3789 </span>                :            :         } else {
<span class="lineNum">    3790 </span>                :            :                 /*
<span class="lineNum">    3791 </span>                :            :                  * if the fs does not exist, look for it based on the
<span class="lineNum">    3792 </span>                :            :                  * fromsnap GUID
<span class="lineNum">    3793 </span>                :            :                  */
<span class="lineNum">    3794 </span>                :<span class="lineCov">       1250 :                 (void) snprintf(errbuf, sizeof (errbuf), dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3795 </span>                :            :                     &quot;cannot receive incremental stream&quot;));
<span class="lineNum">    3796 </span>                :            : 
<span class="lineNum">    3797 </span>                :<span class="lineCov">        625 :                 (void) strcpy(name, destsnap);</span>
<span class="lineNum">    3798 </span>                :<span class="lineCov">        625 :                 *strchr(name, '@') = '\0';</span>
<span class="lineNum">    3799 </span>                :            : 
<span class="lineNum">    3800 </span>                :            :                 /*
<span class="lineNum">    3801 </span>                :            :                  * If the exact receive path was specified and this is the
<span class="lineNum">    3802 </span>                :            :                  * topmost path in the stream, then if the fs does not exist we
<span class="lineNum">    3803 </span>                :            :                  * should look no further.
<span class="lineNum">    3804 </span>                :            :                  */
<span class="lineNum">    3805 </span>[<span class="branchCov" title="Branch 0 was taken 56 times"> + </span><span class="branchCov" title="Branch 1 was taken 569 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 56 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">        625 :                 if ((flags-&gt;isprefix || (*(chopprefix = drrb-&gt;drr_toname +</span>
<span class="lineNum">    3806 </span>  [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 53 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 572 times"> + </span>]:<span class="lineCov">        628 :                     strlen(sendfs)) != '\0' &amp;&amp; *chopprefix != '@')) &amp;&amp;</span>
<span class="lineNum">    3807 </span>                :<span class="lineCov">        572 :                     !zfs_dataset_exists(hdl, name, ZFS_TYPE_DATASET)) {</span>
<span class="lineNum">    3808 </span>                :            :                         char snap[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    3809 </span>                :<span class="lineNoCov">          0 :                         (void) strcpy(snap, strchr(destsnap, '@'));</span>
<span class="lineNum">    3810 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (guid_to_name(hdl, name, drrb-&gt;drr_fromguid,</span>
<span class="lineNum">    3811 </span>                :            :                             B_FALSE, destsnap) == 0) {
<span class="lineNum">    3812 </span>                :<span class="lineNoCov">          0 :                                 *strchr(destsnap, '@') = '\0';</span>
<span class="lineNum">    3813 </span>                :            :                                 (void) strcat(destsnap, snap);
<span class="lineNum">    3814 </span>                :            :                         }
<span class="lineNum">    3815 </span>                :            :                 }
<span class="lineNum">    3816 </span>                :            :         }
<span class="lineNum">    3817 </span>                :            : 
<span class="lineNum">    3818 </span>                :<span class="lineCov">        924 :         (void) strcpy(name, destsnap);</span>
<span class="lineNum">    3819 </span>                :<span class="lineCov">        924 :         *strchr(name, '@') = '\0';</span>
<span class="lineNum">    3820 </span>                :            : 
<span class="lineNum">    3821 </span>        [<span class="branchCov" title="Branch 1 was taken 646 times"> + </span><span class="branchCov" title="Branch 2 was taken 278 times"> + </span>]:<span class="lineCov">        924 :         if (zfs_dataset_exists(hdl, name, ZFS_TYPE_DATASET)) {</span>
<span class="lineNum">    3822 </span>                :<span class="lineCov">        646 :                 zfs_cmd_t zc = {&quot;\0&quot;};</span>
<span class="lineNum">    3823 </span>                :            :                 zfs_handle_t *zhp;
<span class="lineNum">    3824 </span>                :            : 
<span class="lineNum">    3825 </span>                :<span class="lineCov">        646 :                 (void) strcpy(zc.zc_name, name);</span>
<span class="lineNum">    3826 </span>                :            : 
<span class="lineNum">    3827 </span>                :            :                 /*
<span class="lineNum">    3828 </span>                :            :                  * Destination fs exists.  It must be one of these cases:
<span class="lineNum">    3829 </span>                :            :                  *  - an incremental send stream
<span class="lineNum">    3830 </span>                :            :                  *  - the stream specifies a new fs (full stream or clone)
<span class="lineNum">    3831 </span>                :            :                  *    and they want us to blow away the existing fs (and
<span class="lineNum">    3832 </span>                :            :                  *    have therefore specified -F and removed any snapshots)
<span class="lineNum">    3833 </span>                :            :                  *  - we are resuming a failed receive.
<span class="lineNum">    3834 </span>                :            :                  */
<span class="lineNum">    3835 </span>        [<span class="branchCov" title="Branch 0 was taken 21 times"> + </span><span class="branchCov" title="Branch 1 was taken 625 times"> + </span>]:<span class="lineCov">        646 :                 if (stream_wantsnewfs) {</span>
<span class="lineNum">    3836 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 21 times"> + </span>]:<span class="lineCov">         21 :                         if (!flags-&gt;force) {</span>
<span class="lineNum">    3837 </span>                :<span class="lineNoCov">          0 :                                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3838 </span>                :            :                                     &quot;destination '%s' exists\n&quot;
<span class="lineNum">    3839 </span>                :            :                                     &quot;must specify -F to overwrite it&quot;), name);
<span class="lineNum">    3840 </span>                :<span class="lineNoCov">          0 :                                 err = zfs_error(hdl, EZFS_EXISTS, errbuf);</span>
<span class="lineNum">    3841 </span>                :<span class="lineNoCov">          0 :                                 goto out;</span>
<span class="lineNum">    3842 </span>                :            :                         }
<span class="lineNum">    3843 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 21 times"> + </span>]:<span class="lineCov">         21 :                         if (ioctl(hdl-&gt;libzfs_fd, ZFS_IOC_SNAPSHOT_LIST_NEXT,</span>
<span class="lineNum">    3844 </span>                :            :                             &amp;zc) == 0) {
<span class="lineNum">    3845 </span>                :<span class="lineNoCov">          0 :                                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3846 </span>                :            :                                     &quot;destination has snapshots (eg. %s)\n&quot;
<span class="lineNum">    3847 </span>                :            :                                     &quot;must destroy them to overwrite it&quot;),
<span class="lineNum">    3848 </span>                :            :                                     name);
<span class="lineNum">    3849 </span>                :<span class="lineNoCov">          0 :                                 err = zfs_error(hdl, EZFS_EXISTS, errbuf);</span>
<span class="lineNum">    3850 </span>                :<span class="lineNoCov">          0 :                                 goto out;</span>
<span class="lineNum">    3851 </span>                :            :                         }
<span class="lineNum">    3852 </span>                :            :                 }
<span class="lineNum">    3853 </span>                :            : 
<span class="lineNum">    3854 </span>        [<span class="branchCov" title="Branch 1 was taken 646 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        646 :                 if ((zhp = zfs_open(hdl, name,</span>
<span class="lineNum">    3855 </span>                :            :                     ZFS_TYPE_FILESYSTEM | ZFS_TYPE_VOLUME)) == NULL) {
<span class="lineNum">    3856 </span>                :            :                         err = -1;
<span class="lineNum">    3857 </span>                :            :                         goto out;
<span class="lineNum">    3858 </span>                :            :                 }
<span class="lineNum">    3859 </span>                :            : 
<span class="lineNum">    3860 </span>[<span class="branchCov" title="Branch 0 was taken 21 times"> + </span><span class="branchCov" title="Branch 1 was taken 625 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 21 times"> + </span>]:<span class="lineCov">        646 :                 if (stream_wantsnewfs &amp;&amp;</span>
<span class="lineNum">    3861 </span>                :<span class="lineCov">         21 :                     zhp-&gt;zfs_dmustats.dds_origin[0]) {</span>
<span class="lineNum">    3862 </span>                :<span class="lineNoCov">          0 :                         zfs_close(zhp);</span>
<span class="lineNum">    3863 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3864 </span>                :            :                             &quot;destination '%s' is a clone\n&quot;
<span class="lineNum">    3865 </span>                :            :                             &quot;must destroy it to overwrite it&quot;), name);
<span class="lineNum">    3866 </span>                :<span class="lineNoCov">          0 :                         err = zfs_error(hdl, EZFS_EXISTS, errbuf);</span>
<span class="lineNum">    3867 </span>                :<span class="lineNoCov">          0 :                         goto out;</span>
<span class="lineNum">    3868 </span>                :            :                 }
<span class="lineNum">    3869 </span>                :            : 
<span class="lineNum">    3870 </span>                :            :                 /*
<span class="lineNum">    3871 </span>                :            :                  * zfs recv -F cant be used to blow away an existing
<span class="lineNum">    3872 </span>                :            :                  * encrypted filesystem. This is because it would require
<span class="lineNum">    3873 </span>                :            :                  * the dsl dir to point to the the new key (or lack of a
<span class="lineNum">    3874 </span>                :            :                  * key) and the old key at the same time. The -F flag may
<span class="lineNum">    3875 </span>                :            :                  * still be used for deleting intermediate snapshots that
<span class="lineNum">    3876 </span>                :            :                  * would otherwise prevent the receive from working.
<span class="lineNum">    3877 </span>                :            :                  */
<span class="lineNum">    3878 </span>        [<span class="branchCov" title="Branch 0 was taken 21 times"> + </span><span class="branchCov" title="Branch 1 was taken 625 times"> + </span>]:<span class="lineCov">        667 :                 if (stream_wantsnewfs &amp;&amp; flags-&gt;force &amp;&amp;</span>
<span class="lineNum">         </span>  [<span class="branchCov" title="Branch 2 was taken 21 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 21 times"> + </span>]
<span class="lineNum">    3879 </span>                :<span class="lineCov">         21 :                     zfs_prop_get_int(zhp, ZFS_PROP_ENCRYPTION) !=</span>
<span class="lineNum">    3880 </span>                :            :                     ZIO_CRYPT_OFF) {
<span class="lineNum">    3881 </span>                :<span class="lineNoCov">          0 :                         zfs_close(zhp);</span>
<span class="lineNum">    3882 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3883 </span>                :            :                             &quot;zfs receive -F cannot be used to &quot;
<span class="lineNum">    3884 </span>                :            :                             &quot;destroy an encrypted filesystem&quot;));
<span class="lineNum">    3885 </span>                :<span class="lineNoCov">          0 :                         err = zfs_error(hdl, EZFS_BADRESTORE, errbuf);</span>
<span class="lineNum">    3886 </span>                :<span class="lineNoCov">          0 :                         goto out;</span>
<span class="lineNum">    3887 </span>                :            :                 }
<span class="lineNum">    3888 </span>                :            : 
<span class="lineNum">    3889 </span>                :            : 
<span class="lineNum">    3890 </span>[<span class="branchCov" title="Branch 0 was taken 645 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>][<span class="branchCov" title="Branch 2 was taken 457 times"> + </span><span class="branchCov" title="Branch 3 was taken 188 times"> + </span>]:<span class="lineCov">        646 :                 if (!flags-&gt;dryrun &amp;&amp; zhp-&gt;zfs_type == ZFS_TYPE_FILESYSTEM &amp;&amp;</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 20 times"> + </span><span class="branchCov" title="Branch 5 was taken 437 times"> + </span>]
<span class="lineNum">    3891 </span>                :            :                     stream_wantsnewfs) {
<span class="lineNum">    3892 </span>                :            :                         /* We can't do online recv in this case */
<span class="lineNum">    3893 </span>                :<span class="lineCov">         20 :                         clp = changelist_gather(zhp, ZFS_PROP_NAME, 0, 0);</span>
<span class="lineNum">    3894 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 20 times"> + </span>]:<span class="lineCov">         20 :                         if (clp == NULL) {</span>
<span class="lineNum">    3895 </span>                :<span class="lineNoCov">          0 :                                 zfs_close(zhp);</span>
<span class="lineNum">    3896 </span>                :<span class="lineNoCov">          0 :                                 err = -1;</span>
<span class="lineNum">    3897 </span>                :<span class="lineNoCov">          0 :                                 goto out;</span>
<span class="lineNum">    3898 </span>                :            :                         }
<span class="lineNum">    3899 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 20 times"> + </span>]:<span class="lineCov">         20 :                         if (changelist_prefix(clp) != 0) {</span>
<span class="lineNum">    3900 </span>                :<span class="lineNoCov">          0 :                                 changelist_free(clp);</span>
<span class="lineNum">    3901 </span>                :<span class="lineNoCov">          0 :                                 zfs_close(zhp);</span>
<span class="lineNum">    3902 </span>                :<span class="lineNoCov">          0 :                                 err = -1;</span>
<span class="lineNum">    3903 </span>                :<span class="lineNoCov">          0 :                                 goto out;</span>
<span class="lineNum">    3904 </span>                :            :                         }
<span class="lineNum">    3905 </span>                :            :                 }
<span class="lineNum">    3906 </span>                :            : 
<span class="lineNum">    3907 </span>                :            :                 /*
<span class="lineNum">    3908 </span>                :            :                  * If we are resuming a newfs, set newfs here so that we will
<span class="lineNum">    3909 </span>                :            :                  * mount it if the recv succeeds this time.  We can tell
<span class="lineNum">    3910 </span>                :            :                  * that it was a newfs on the first recv because the fs
<span class="lineNum">    3911 </span>                :            :                  * itself will be inconsistent (if the fs existed when we
<span class="lineNum">    3912 </span>                :            :                  * did the first recv, we would have received it into
<span class="lineNum">    3913 </span>                :            :                  * .../%recv).
<span class="lineNum">    3914 </span>                :            :                  */
<span class="lineNum">    3915 </span>[<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchCov" title="Branch 1 was taken 632 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 6 times"> + </span><span class="branchCov" title="Branch 4 was taken 8 times"> + </span>]:<span class="lineCov">        646 :                 if (resuming &amp;&amp; zfs_prop_get_int(zhp, ZFS_PROP_INCONSISTENT))</span>
<span class="lineNum">    3916 </span>                :<span class="lineCov">          6 :                         newfs = B_TRUE;</span>
<span class="lineNum">    3917 </span>                :            : 
<span class="lineNum">    3918 </span>                :            :                 /* we want to know if we're zoned when validating -o|-x props */
<span class="lineNum">    3919 </span>                :<span class="lineCov">        646 :                 zoned = zfs_prop_get_int(zhp, ZFS_PROP_ZONED);</span>
<span class="lineNum">    3920 </span>                :            : 
<span class="lineNum">    3921 </span>                :            :                 /* gather existing properties on destination */
<span class="lineNum">    3922 </span>                :<span class="lineCov">        646 :                 origprops = fnvlist_alloc();</span>
<span class="lineNum">    3923 </span>                :<span class="lineCov">        646 :                 fnvlist_merge(origprops, zhp-&gt;zfs_props);</span>
<span class="lineNum">    3924 </span>                :<span class="lineCov">        646 :                 fnvlist_merge(origprops, zhp-&gt;zfs_user_props);</span>
<span class="lineNum">    3925 </span>                :            : 
<span class="lineNum">    3926 </span>                :<span class="lineCov">        646 :                 zfs_close(zhp);</span>
<span class="lineNum">    3927 </span>                :            :         } else {
<span class="lineNum">    3928 </span>                :            :                 zfs_handle_t *zhp;
<span class="lineNum">    3929 </span>                :            : 
<span class="lineNum">    3930 </span>                :            :                 /*
<span class="lineNum">    3931 </span>                :            :                  * Destination filesystem does not exist.  Therefore we better
<span class="lineNum">    3932 </span>                :            :                  * be creating a new filesystem (either from a full backup, or
<span class="lineNum">    3933 </span>                :            :                  * a clone).  It would therefore be invalid if the user
<span class="lineNum">    3934 </span>                :            :                  * specified only the pool name (i.e. if the destination name
<span class="lineNum">    3935 </span>                :            :                  * contained no slash character).
<span class="lineNum">    3936 </span>                :            :                  */
<span class="lineNum">    3937 </span>                :<span class="lineCov">        278 :                 cp = strrchr(name, '/');</span>
<span class="lineNum">    3938 </span>                :            : 
<span class="lineNum">    3939 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 278 times"> + </span>]:<span class="lineCov">        278 :                 if (!stream_wantsnewfs || cp == NULL) {</span>
<span class="lineNum">    3940 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3941 </span>                :            :                             &quot;destination '%s' does not exist&quot;), name);
<span class="lineNum">    3942 </span>                :<span class="lineNoCov">          0 :                         err = zfs_error(hdl, EZFS_NOENT, errbuf);</span>
<span class="lineNum">    3943 </span>                :<span class="lineNoCov">          0 :                         goto out;</span>
<span class="lineNum">    3944 </span>                :            :                 }
<span class="lineNum">    3945 </span>                :            : 
<span class="lineNum">    3946 </span>                :            :                 /*
<span class="lineNum">    3947 </span>                :            :                  * Trim off the final dataset component so we perform the
<span class="lineNum">    3948 </span>                :            :                  * recvbackup ioctl to the filesystems's parent.
<span class="lineNum">    3949 </span>                :            :                  */
<span class="lineNum">    3950 </span>                :<span class="lineCov">        278 :                 *cp = '\0';</span>
<span class="lineNum">    3951 </span>                :            : 
<span class="lineNum">    3952 </span>[<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchCov" title="Branch 1 was taken 102 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 176 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">        453 :                 if (flags-&gt;isprefix &amp;&amp; !flags-&gt;istail &amp;&amp; !flags-&gt;dryrun &amp;&amp;</span>
<span class="lineNum">         </span>  [<span class="branchCov" title="Branch 4 was taken 175 times"> + </span><span class="branchCov" title="Branch 5 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchCov" title="Branch 7 was taken 175 times"> + </span>]
<span class="lineNum">    3953 </span>                :<span class="lineCov">        175 :                     create_parents(hdl, destsnap, strlen(tosnap)) != 0) {</span>
<span class="lineNum">    3954 </span>                :<span class="lineNoCov">          0 :                         err = zfs_error(hdl, EZFS_BADRESTORE, errbuf);</span>
<span class="lineNum">    3955 </span>                :<span class="lineNoCov">          0 :                         goto out;</span>
<span class="lineNum">    3956 </span>                :            :                 }
<span class="lineNum">    3957 </span>                :            : 
<span class="lineNum">    3958 </span>                :            :                 /*
<span class="lineNum">    3959 </span>                :            :                  * It is invalid to receive a properties stream that was
<span class="lineNum">    3960 </span>                :            :                  * unencrypted on the send side as a child of an encrypted
<span class="lineNum">    3961 </span>                :            :                  * parent. Technically there is nothing preventing this, but
<span class="lineNum">    3962 </span>                :            :                  * it would mean that the encryption=off property which is
<span class="lineNum">    3963 </span>                :            :                  * locally set on the send side would not be received correctly.
<span class="lineNum">    3964 </span>                :            :                  * We can infer encryption=off if the stream is not raw and
<span class="lineNum">    3965 </span>                :            :                  * properties were included since the send side will only ever
<span class="lineNum">    3966 </span>                :            :                  * send the encryption property in a raw nvlist header.
<span class="lineNum">    3967 </span>                :            :                  */
<span class="lineNum">    3968 </span>[<span class="branchCov" title="Branch 0 was taken 272 times"> + </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 183 times"> + </span><span class="branchCov" title="Branch 3 was taken 89 times"> + </span>]:<span class="lineCov">        278 :                 if (!raw &amp;&amp; rcvprops != NULL) {</span>
<span class="lineNum">    3969 </span>                :            :                         uint64_t crypt;
<span class="lineNum">    3970 </span>                :            : 
<span class="lineNum">    3971 </span>                :<span class="lineCov">        183 :                         zhp = zfs_open(hdl, name, ZFS_TYPE_DATASET);</span>
<span class="lineNum">    3972 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 183 times"> + </span>]:<span class="lineCov">        183 :                         if (zhp == NULL) {</span>
<span class="lineNum">    3973 </span>                :<span class="lineNoCov">          0 :                                 err = zfs_error(hdl, EZFS_BADRESTORE, errbuf);</span>
<span class="lineNum">    3974 </span>                :<span class="lineNoCov">          0 :                                 goto out;</span>
<span class="lineNum">    3975 </span>                :            :                         }
<span class="lineNum">    3976 </span>                :            : 
<span class="lineNum">    3977 </span>                :<span class="lineCov">        183 :                         crypt = zfs_prop_get_int(zhp, ZFS_PROP_ENCRYPTION);</span>
<span class="lineNum">    3978 </span>                :<span class="lineCov">        183 :                         zfs_close(zhp);</span>
<span class="lineNum">    3979 </span>                :            : 
<span class="lineNum">    3980 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 181 times"> + </span>]:<span class="lineCov">        183 :                         if (crypt != ZIO_CRYPT_OFF) {</span>
<span class="lineNum">    3981 </span>                :<span class="lineCov">          2 :                                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    3982 </span>                :            :                                     &quot;parent '%s' must not be encrypted to &quot;
<span class="lineNum">    3983 </span>                :            :                                     &quot;receive unenecrypted property&quot;), name);
<span class="lineNum">    3984 </span>                :<span class="lineCov">          2 :                                 err = zfs_error(hdl, EZFS_BADPROP, errbuf);</span>
<span class="lineNum">    3985 </span>                :<span class="lineCov">          2 :                                 goto out;</span>
<span class="lineNum">    3986 </span>                :            :                         }
<span class="lineNum">    3987 </span>                :            :                 }
<span class="lineNum">    3988 </span>                :            : 
<span class="lineNum">    3989 </span>                :<span class="lineCov">        276 :                 newfs = B_TRUE;</span>
<span class="lineNum">    3990 </span>                :<span class="lineCov">        276 :                 *cp = '/';</span>
<span class="lineNum">    3991 </span>                :            :         }
<span class="lineNum">    3992 </span>                :            : 
<span class="lineNum">    3993 </span>        [<span class="branchCov" title="Branch 0 was taken 33 times"> + </span><span class="branchCov" title="Branch 1 was taken 889 times"> + </span>]:<span class="lineCov">        922 :         if (flags-&gt;verbose) {</span>
<span class="lineNum">    3994 </span>[<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchCov" title="Branch 1 was taken 15 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 29 times"> + </span><span class="branchCov" title="Branch 3 was taken 4 times"> + </span>]:<span class="lineCov">         33 :                 (void) printf(&quot;%s %s stream of %s into %s\n&quot;,</span>
<span class="lineNum">    3995 </span>                :<span class="lineCov">         33 :                     flags-&gt;dryrun ? &quot;would receive&quot; : &quot;receiving&quot;,</span>
<span class="lineNum">    3996 </span>                :<span class="lineCov">         33 :                     drrb-&gt;drr_fromguid ? &quot;incremental&quot; : &quot;full&quot;,</span>
<span class="lineNum">    3997 </span>                :            :                     drrb-&gt;drr_toname, destsnap);
<span class="lineNum">    3998 </span>                :<span class="lineCov">         33 :                 (void) fflush(stdout);</span>
<span class="lineNum">    3999 </span>                :            :         }
<span class="lineNum">    4000 </span>                :            : 
<span class="lineNum">    4001 </span>        [<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 918 times"> + </span>]:<span class="lineCov">        922 :         if (flags-&gt;dryrun) {</span>
<span class="lineNum">    4002 </span>                :<span class="lineCov">          4 :                 err = recv_skip(hdl, infd, flags-&gt;byteswap);</span>
<span class="lineNum">    4003 </span>                :<span class="lineCov">          4 :                 goto out;</span>
<span class="lineNum">    4004 </span>                :            :         }
<span class="lineNum">    4005 </span>                :            : 
<span class="lineNum">    4006 </span>                :<span class="lineCov">        918 :         toplevel = chopprefix[0] != '/';</span>
<span class="lineNum">    4007 </span>        [<span class="branchCov" title="Branch 0 was taken 671 times"> + </span><span class="branchCov" title="Branch 1 was taken 247 times"> + </span>]:<span class="lineCov">        918 :         if (drrb-&gt;drr_type == DMU_OST_ZVOL) {</span>
<span class="lineNum">    4008 </span>                :            :                 type = ZFS_TYPE_VOLUME;
<span class="lineNum">    4009 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 671 times"> + </span>]:<span class="lineCov">        671 :         } else if (drrb-&gt;drr_type == DMU_OST_ZFS) {</span>
<span class="lineNum">    4010 </span>                :            :                 type = ZFS_TYPE_FILESYSTEM;
<span class="lineNum">    4011 </span>                :            :         } else {
<span class="lineNum">    4012 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    4013 </span>                :            :                     &quot;invalid record type: 0x%d&quot;), drrb-&gt;drr_type);
<span class="lineNum">    4014 </span>                :<span class="lineNoCov">          0 :                 err = zfs_error(hdl, EZFS_BADSTREAM, errbuf);</span>
<span class="lineNum">    4015 </span>                :<span class="lineNoCov">          0 :                 goto out;</span>
<span class="lineNum">    4016 </span>                :            :         }
<span class="lineNum">    4017 </span>        [<span class="branchCov" title="Branch 1 was taken 916 times"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span>]:<span class="lineCov">        918 :         if ((err = zfs_setup_cmdline_props(hdl, type, zoned, recursive,</span>
<span class="lineNum">    4018 </span>                :            :             toplevel, rcvprops, cmdprops, origprops, &amp;oxprops, errbuf)) != 0)
<span class="lineNum">    4019 </span>                :            :                 goto out;
<span class="lineNum">    4020 </span>                :            : 
<span class="lineNum">    4021 </span>                :<span class="lineCov">        916 :         err = ioctl_err = lzc_receive_with_cmdprops(destsnap, rcvprops, oxprops,</span>
<span class="lineNum">    4022 </span>                :            :             origin, flags-&gt;force, flags-&gt;resumable, raw, infd, drr_noswap,
<span class="lineNum">    4023 </span>                :            :             cleanup_fd, &amp;read_bytes, &amp;errflags, action_handlep, &amp;prop_errors);
<span class="lineNum">    4024 </span>                :<span class="lineCov">        916 :         ioctl_errno = ioctl_err;</span>
<span class="lineNum">    4025 </span>                :<span class="lineCov">        916 :         prop_errflags = errflags;</span>
<span class="lineNum">    4026 </span>                :            : 
<span class="lineNum">    4027 </span>        [<span class="branchCov" title="Branch 0 was taken 876 times"> + </span><span class="branchCov" title="Branch 1 was taken 40 times"> + </span>]:<span class="lineCov">        916 :         if (err == 0) {</span>
<span class="lineNum">    4028 </span>                :            :                 nvpair_t *prop_err = NULL;
<span class="lineNum">    4029 </span>                :            : 
<span class="lineNum">    4030 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 876 times"> + </span>]:<span class="lineCov">        878 :                 while ((prop_err = nvlist_next_nvpair(prop_errors,</span>
<span class="lineNum">    4031 </span>                :            :                     prop_err)) != NULL) {
<span class="lineNum">    4032 </span>                :            :                         char tbuf[1024];
<span class="lineNum">    4033 </span>                :            :                         zfs_prop_t prop;
<span class="lineNum">    4034 </span>                :            :                         int intval;
<span class="lineNum">    4035 </span>                :            : 
<span class="lineNum">    4036 </span>                :<span class="lineCov">          2 :                         prop = zfs_name_to_prop(nvpair_name(prop_err));</span>
<span class="lineNum">    4037 </span>                :<span class="lineCov">          2 :                         (void) nvpair_value_int32(prop_err, &amp;intval);</span>
<span class="lineNum">    4038 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span>]:<span class="lineCov">          2 :                         if (strcmp(nvpair_name(prop_err),</span>
<span class="lineNum">    4039 </span>                :            :                             ZPROP_N_MORE_ERRORS) == 0) {
<span class="lineNum">    4040 </span>                :<span class="lineNoCov">          0 :                                 trunc_prop_errs(intval);</span>
<span class="lineNum">    4041 </span>                :<span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    4042 </span>[<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          2 :                         } else if (snapname == NULL || finalsnap == NULL ||</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchCov" title="Branch 5 was taken 1 time"> + </span>]
<span class="lineNum">    4043 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                             strcmp(finalsnap, snapname) == 0 ||</span>
<span class="lineNum">    4044 </span>                :<span class="lineCov">          1 :                             strcmp(nvpair_name(prop_err),</span>
<span class="lineNum">    4045 </span>                :            :                             zfs_prop_to_name(ZFS_PROP_REFQUOTA)) != 0) {
<span class="lineNum">    4046 </span>                :            :                                 /*
<span class="lineNum">    4047 </span>                :            :                                  * Skip the special case of, for example,
<span class="lineNum">    4048 </span>                :            :                                  * &quot;refquota&quot;, errors on intermediate
<span class="lineNum">    4049 </span>                :            :                                  * snapshots leading up to a final one.
<span class="lineNum">    4050 </span>                :            :                                  * That's why we have all of the checks above.
<span class="lineNum">    4051 </span>                :            :                                  *
<span class="lineNum">    4052 </span>                :            :                                  * See zfs_ioctl.c's extract_delay_props() for
<span class="lineNum">    4053 </span>                :            :                                  * a list of props which can fail on
<span class="lineNum">    4054 </span>                :            :                                  * intermediate snapshots, but shouldn't
<span class="lineNum">    4055 </span>                :            :                                  * affect the overall receive.
<span class="lineNum">    4056 </span>                :            :                                  */
<span class="lineNum">    4057 </span>                :<span class="lineCov">          1 :                                 (void) snprintf(tbuf, sizeof (tbuf),</span>
<span class="lineNum">    4058 </span>                :<span class="lineCov">          1 :                                     dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    4059 </span>                :            :                                     &quot;cannot receive %s property on %s&quot;),
<span class="lineNum">    4060 </span>                :            :                                     nvpair_name(prop_err), name);
<span class="lineNum">    4061 </span>                :<span class="lineCov">          2 :                                 zfs_setprop_error(hdl, prop, intval, tbuf);</span>
<span class="lineNum">    4062 </span>                :            :                         }
<span class="lineNum">    4063 </span>                :            :                 }
<span class="lineNum">    4064 </span>                :            :         }
<span class="lineNum">    4065 </span>                :            : 
<span class="lineNum">    4066 </span>[<span class="branchCov" title="Branch 0 was taken 876 times"> + </span><span class="branchCov" title="Branch 1 was taken 40 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 760 times"> + </span><span class="branchCov" title="Branch 3 was taken 116 times"> + </span>]:<span class="lineCov">        916 :         if (err == 0 &amp;&amp; snapprops_nvlist) {</span>
<span class="lineNum">    4067 </span>                :<span class="lineCov">        760 :                 zfs_cmd_t zc = {&quot;\0&quot;};</span>
<span class="lineNum">    4068 </span>                :            : 
<span class="lineNum">    4069 </span>                :<span class="lineCov">        760 :                 (void) strcpy(zc.zc_name, destsnap);</span>
<span class="lineNum">    4070 </span>                :<span class="lineCov">        760 :                 zc.zc_cookie = B_TRUE; /* received */</span>
<span class="lineNum">    4071 </span>        [<span class="branchCov" title="Branch 1 was taken 760 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        760 :                 if (zcmd_write_src_nvlist(hdl, &amp;zc, snapprops_nvlist) == 0) {</span>
<span class="lineNum">    4072 </span>                :<span class="lineCov">        760 :                         (void) zfs_ioctl(hdl, ZFS_IOC_SET_PROP, &amp;zc);</span>
<span class="lineNum">    4073 </span>                :<span class="lineCov">        760 :                         zcmd_free_nvlists(&amp;zc);</span>
<span class="lineNum">    4074 </span>                :            :                 }
<span class="lineNum">    4075 </span>                :            :         }
<span class="lineNum">    4076 </span>                :            : 
<span class="lineNum">    4077 </span>[<span class="branchCov" title="Branch 0 was taken 40 times"> + </span><span class="branchCov" title="Branch 1 was taken 876 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 40 times"> + </span>]:<span class="lineCov">        916 :         if (err &amp;&amp; (ioctl_errno == ENOENT || ioctl_errno == EEXIST)) {</span>
<span class="lineNum">    4078 </span>                :            :                 /*
<span class="lineNum">    4079 </span>                :            :                  * It may be that this snapshot already exists,
<span class="lineNum">    4080 </span>                :            :                  * in which case we want to consume &amp; ignore it
<span class="lineNum">    4081 </span>                :            :                  * rather than failing.
<span class="lineNum">    4082 </span>                :            :                  */
<span class="lineNum">    4083 </span>                :            :                 avl_tree_t *local_avl;
<span class="lineNum">    4084 </span>                :            :                 nvlist_t *local_nv, *fs;
<span class="lineNum">    4085 </span>                :<span class="lineNoCov">          0 :                 cp = strchr(destsnap, '@');</span>
<span class="lineNum">    4086 </span>                :            : 
<span class="lineNum">    4087 </span>                :            :                 /*
<span class="lineNum">    4088 </span>                :            :                  * XXX Do this faster by just iterating over snaps in
<span class="lineNum">    4089 </span>                :            :                  * this fs.  Also if zc_value does not exist, we will
<span class="lineNum">    4090 </span>                :            :                  * get a strange &quot;does not exist&quot; error message.
<span class="lineNum">    4091 </span>                :            :                  */
<span class="lineNum">    4092 </span>                :<span class="lineNoCov">          0 :                 *cp = '\0';</span>
<span class="lineNum">    4093 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (gather_nvlist(hdl, destsnap, NULL, NULL, B_FALSE, B_TRUE,</span>
<span class="lineNum">    4094 </span>                :            :                     B_FALSE, &amp;local_nv, &amp;local_avl) == 0) {
<span class="lineNum">    4095 </span>                :<span class="lineNoCov">          0 :                         *cp = '@';</span>
<span class="lineNum">    4096 </span>                :<span class="lineNoCov">          0 :                         fs = fsavl_find(local_avl, drrb-&gt;drr_toguid, NULL);</span>
<span class="lineNum">    4097 </span>                :<span class="lineNoCov">          0 :                         fsavl_destroy(local_avl);</span>
<span class="lineNum">    4098 </span>                :<span class="lineNoCov">          0 :                         nvlist_free(local_nv);</span>
<span class="lineNum">    4099 </span>                :            : 
<span class="lineNum">    4100 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (fs != NULL) {</span>
<span class="lineNum">    4101 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (flags-&gt;verbose) {</span>
<span class="lineNum">    4102 </span>                :            :                                         (void) printf(&quot;snap %s already exists; &quot;
<span class="lineNum">    4103 </span>                :            :                                             &quot;ignoring\n&quot;, destsnap);
<span class="lineNum">    4104 </span>                :            :                                 }
<span class="lineNum">    4105 </span>                :<span class="lineNoCov">          0 :                                 err = ioctl_err = recv_skip(hdl, infd,</span>
<span class="lineNum">    4106 </span>                :            :                                     flags-&gt;byteswap);
<span class="lineNum">    4107 </span>                :            :                         }
<span class="lineNum">    4108 </span>                :            :                 }
<span class="lineNum">    4109 </span>                :<span class="lineNoCov">          0 :                 *cp = '@';</span>
<span class="lineNum">    4110 </span>                :            :         }
<span class="lineNum">    4111 </span>                :            : 
<span class="lineNum">    4112 </span>        [<span class="branchCov" title="Branch 0 was taken 40 times"> + </span><span class="branchCov" title="Branch 1 was taken 876 times"> + </span>]:<span class="lineCov">        916 :         if (ioctl_err != 0) {</span>
<span class="lineNum">    4113 </span>  [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">         40 :                 switch (ioctl_errno) {</span>
<span class="lineNum">         </span>   <span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 17 times"> + </span><span class="branchCov" title="Branch 6 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span> 
<span class="lineNum">         </span>            <span class="branchCov" title="Branch 8 was taken 3 times"> + </span>]
<span class="lineNum">    4114 </span>                :            :                 case ENODEV:
<span class="lineNum">    4115 </span>                :<span class="lineCov">          2 :                         cp = strchr(destsnap, '@');</span>
<span class="lineNum">    4116 </span>                :<span class="lineCov">          2 :                         *cp = '\0';</span>
<span class="lineNum">    4117 </span>                :<span class="lineCov">          2 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    4118 </span>                :            :                             &quot;most recent snapshot of %s does not\n&quot;
<span class="lineNum">    4119 </span>                :            :                             &quot;match incremental source&quot;), destsnap);
<span class="lineNum">    4120 </span>                :<span class="lineCov">          2 :                         (void) zfs_error(hdl, EZFS_BADRESTORE, errbuf);</span>
<span class="lineNum">    4121 </span>                :<span class="lineCov">          2 :                         *cp = '@';</span>
<span class="lineNum">    4122 </span>                :<span class="lineCov">          2 :                         break;</span>
<span class="lineNum">    4123 </span>                :            :                 case ETXTBSY:
<span class="lineNum">    4124 </span>                :<span class="lineCov">          3 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    4125 </span>                :            :                             &quot;destination %s has been modified\n&quot;
<span class="lineNum">    4126 </span>                :            :                             &quot;since most recent snapshot&quot;), name);
<span class="lineNum">    4127 </span>                :<span class="lineCov">          3 :                         (void) zfs_error(hdl, EZFS_BADRESTORE, errbuf);</span>
<span class="lineNum">    4128 </span>                :<span class="lineCov">          3 :                         break;</span>
<span class="lineNum">    4129 </span>                :            :                 case EACCES:
<span class="lineNum">    4130 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                         if (raw &amp;&amp; stream_wantsnewfs) {</span>
<span class="lineNum">    4131 </span>                :<span class="lineNoCov">          0 :                                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    4132 </span>                :            :                                     &quot;failed to create encryption key&quot;));
<span class="lineNum">    4133 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                         } else if (raw &amp;&amp; !stream_wantsnewfs) {</span>
<span class="lineNum">    4134 </span>                :<span class="lineNoCov">          0 :                                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    4135 </span>                :            :                                     &quot;encryption key does not match &quot;
<span class="lineNum">    4136 </span>                :            :                                     &quot;existing key&quot;));
<span class="lineNum">    4137 </span>                :            :                         } else {
<span class="lineNum">    4138 </span>                :<span class="lineCov">          1 :                                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    4139 </span>                :            :                                     &quot;inherited key must be loaded&quot;));
<span class="lineNum">    4140 </span>                :            :                         }
<span class="lineNum">    4141 </span>                :<span class="lineCov">          1 :                         (void) zfs_error(hdl, EZFS_CRYPTOFAILED, errbuf);</span>
<span class="lineNum">    4142 </span>                :<span class="lineCov">          1 :                         break;</span>
<span class="lineNum">    4143 </span>                :            :                 case EEXIST:
<span class="lineNum">    4144 </span>                :<span class="lineNoCov">          0 :                         cp = strchr(destsnap, '@');</span>
<span class="lineNum">    4145 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (newfs) {</span>
<span class="lineNum">    4146 </span>                :            :                                 /* it's the containing fs that exists */
<span class="lineNum">    4147 </span>                :<span class="lineNoCov">          0 :                                 *cp = '\0';</span>
<span class="lineNum">    4148 </span>                :            :                         }
<span class="lineNum">    4149 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    4150 </span>                :            :                             &quot;destination already exists&quot;));
<span class="lineNum">    4151 </span>                :<span class="lineNoCov">          0 :                         (void) zfs_error_fmt(hdl, EZFS_EXISTS,</span>
<span class="lineNum">    4152 </span>                :<span class="lineNoCov">          0 :                             dgettext(TEXT_DOMAIN, &quot;cannot restore to %s&quot;),</span>
<span class="lineNum">    4153 </span>                :            :                             destsnap);
<span class="lineNum">    4154 </span>                :<span class="lineNoCov">          0 :                         *cp = '@';</span>
<span class="lineNum">    4155 </span>                :<span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    4156 </span>                :            :                 case EINVAL:
<span class="lineNum">    4157 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (flags-&gt;resumable)</span>
<span class="lineNum">    4158 </span>                :<span class="lineNoCov">          0 :                                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    4159 </span>                :            :                                     &quot;kernel modules must be upgraded to &quot;
<span class="lineNum">    4160 </span>                :            :                                     &quot;receive this stream.&quot;));
<span class="lineNum">    4161 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (embedded &amp;&amp; !raw)</span>
<span class="lineNum">    4162 </span>                :<span class="lineNoCov">          0 :                                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    4163 </span>                :            :                                     &quot;incompatible embedded data stream &quot;
<span class="lineNum">    4164 </span>                :            :                                     &quot;feature with encrypted receive.&quot;));
<span class="lineNum">    4165 </span>                :<span class="lineNoCov">          0 :                         (void) zfs_error(hdl, EZFS_BADSTREAM, errbuf);</span>
<span class="lineNum">    4166 </span>                :<span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    4167 </span>                :            :                 case ECKSUM:
<span class="lineNum">    4168 </span>                :<span class="lineCov">         17 :                         recv_ecksum_set_aux(hdl, destsnap, flags-&gt;resumable);</span>
<span class="lineNum">    4169 </span>                :<span class="lineCov">         17 :                         (void) zfs_error(hdl, EZFS_BADSTREAM, errbuf);</span>
<span class="lineNum">    4170 </span>                :<span class="lineCov">         17 :                         break;</span>
<span class="lineNum">    4171 </span>                :            :                 case ENOTSUP:
<span class="lineNum">    4172 </span>                :<span class="lineCov">         14 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    4173 </span>                :            :                             &quot;pool must be upgraded to receive this stream.&quot;));
<span class="lineNum">    4174 </span>                :<span class="lineCov">         14 :                         (void) zfs_error(hdl, EZFS_BADVERSION, errbuf);</span>
<span class="lineNum">    4175 </span>                :<span class="lineCov">         14 :                         break;</span>
<span class="lineNum">    4176 </span>                :            :                 case EDQUOT:
<span class="lineNum">    4177 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    4178 </span>                :            :                             &quot;destination %s space quota exceeded&quot;), name);
<span class="lineNum">    4179 </span>                :<span class="lineNoCov">          0 :                         (void) zfs_error(hdl, EZFS_NOSPC, errbuf);</span>
<span class="lineNum">    4180 </span>                :<span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    4181 </span>                :            :                 default:
<span class="lineNum">    4182 </span>                :<span class="lineCov">          3 :                         (void) zfs_standard_error(hdl, ioctl_errno, errbuf);</span>
<span class="lineNum">    4183 </span>                :            :                 }
<span class="lineNum">    4184 </span>                :            :         }
<span class="lineNum">    4185 </span>                :            : 
<span class="lineNum">    4186 </span>                :            :         /*
<span class="lineNum">    4187 </span>                :            :          * Mount the target filesystem (if created).  Also mount any
<span class="lineNum">    4188 </span>                :            :          * children of the target filesystem if we did a replication
<span class="lineNum">    4189 </span>                :            :          * receive (indicated by stream_avl being non-NULL).
<span class="lineNum">    4190 </span>                :            :          */
<span class="lineNum">    4191 </span>                :<span class="lineCov">        916 :         cp = strchr(destsnap, '@');</span>
<span class="lineNum">    4192 </span>[<span class="branchCov" title="Branch 0 was taken 916 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 893 times"> + </span><span class="branchCov" title="Branch 3 was taken 23 times"> + </span>]:<span class="lineCov">        916 :         if (cp &amp;&amp; (ioctl_err == 0 || !newfs)) {</span>
<span class="lineNum">    4193 </span>                :            :                 zfs_handle_t *h;
<span class="lineNum">    4194 </span>                :            : 
<span class="lineNum">    4195 </span>                :<span class="lineCov">        893 :                 *cp = '\0';</span>
<span class="lineNum">    4196 </span>                :<span class="lineCov">        893 :                 h = zfs_open(hdl, destsnap,</span>
<span class="lineNum">    4197 </span>                :            :                     ZFS_TYPE_FILESYSTEM | ZFS_TYPE_VOLUME);
<span class="lineNum">    4198 </span>        [<span class="branchCov" title="Branch 0 was taken 893 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        893 :                 if (h != NULL) {</span>
<span class="lineNum">    4199 </span>        [<span class="branchCov" title="Branch 0 was taken 245 times"> + </span><span class="branchCov" title="Branch 1 was taken 648 times"> + </span>]:<span class="lineCov">        893 :                         if (h-&gt;zfs_type == ZFS_TYPE_VOLUME) {</span>
<span class="lineNum">    4200 </span>                :<span class="lineCov">        245 :                                 *cp = '@';</span>
<span class="lineNum">    4201 </span>        [<span class="branchCov" title="Branch 0 was taken 602 times"> + </span><span class="branchCov" title="Branch 1 was taken 46 times"> + </span>]:<span class="lineCov">        648 :                         } else if (newfs || stream_avl) {</span>
<span class="lineNum">    4202 </span>                :            :                                 /*
<span class="lineNum">    4203 </span>                :            :                                  * Track the first/top of hierarchy fs,
<span class="lineNum">    4204 </span>                :            :                                  * for mounting and sharing later.
<span class="lineNum">    4205 </span>                :            :                                  */
<span class="lineNum">    4206 </span>[<span class="branchCov" title="Branch 0 was taken 602 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 136 times"> + </span><span class="branchCov" title="Branch 3 was taken 466 times"> + </span>]:<span class="lineCov">        602 :                                 if (top_zfs &amp;&amp; *top_zfs == NULL)</span>
<span class="lineNum">    4207 </span>                :<span class="lineCov">        136 :                                         *top_zfs = zfs_strdup(hdl, destsnap);</span>
<span class="lineNum">    4208 </span>                :            :                         }
<span class="lineNum">    4209 </span>                :<span class="lineCov">        893 :                         zfs_close(h);</span>
<span class="lineNum">    4210 </span>                :            :                 }
<span class="lineNum">    4211 </span>                :<span class="lineCov">        893 :                 *cp = '@';</span>
<span class="lineNum">    4212 </span>                :            :         }
<span class="lineNum">    4213 </span>                :            : 
<span class="lineNum">    4214 </span>        [<span class="branchCov" title="Branch 0 was taken 20 times"> + </span><span class="branchCov" title="Branch 1 was taken 896 times"> + </span>]:<span class="lineCov">        916 :         if (clp) {</span>
<span class="lineNum">    4215 </span>        [<span class="branchCov" title="Branch 0 was taken 20 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         20 :                 if (!flags-&gt;nomount)</span>
<span class="lineNum">    4216 </span>                :<span class="lineCov">         20 :                         err |= changelist_postfix(clp);</span>
<span class="lineNum">    4217 </span>                :<span class="lineCov">         20 :                 changelist_free(clp);</span>
<span class="lineNum">    4218 </span>                :            :         }
<span class="lineNum">    4219 </span>                :            : 
<span class="lineNum">    4220 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 916 times"> + </span>]:<span class="lineCov">        916 :         if (prop_errflags &amp; ZPROP_ERR_NOCLEAR) {</span>
<span class="lineNum">    4221 </span>                :<span class="lineNoCov">          0 :                 (void) fprintf(stderr, dgettext(TEXT_DOMAIN, &quot;Warning: &quot;</span>
<span class="lineNum">    4222 </span>                :            :                     &quot;failed to clear unreceived properties on %s&quot;), name);
<span class="lineNum">    4223 </span>                :<span class="lineNoCov">          0 :                 (void) fprintf(stderr, &quot;\n&quot;);</span>
<span class="lineNum">    4224 </span>                :            :         }
<span class="lineNum">    4225 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 916 times"> + </span>]:<span class="lineCov">        916 :         if (prop_errflags &amp; ZPROP_ERR_NORESTORE) {</span>
<span class="lineNum">    4226 </span>                :<span class="lineNoCov">          0 :                 (void) fprintf(stderr, dgettext(TEXT_DOMAIN, &quot;Warning: &quot;</span>
<span class="lineNum">    4227 </span>                :            :                     &quot;failed to restore original properties on %s&quot;), name);
<span class="lineNum">    4228 </span>                :<span class="lineNoCov">          0 :                 (void) fprintf(stderr, &quot;\n&quot;);</span>
<span class="lineNum">    4229 </span>                :            :         }
<span class="lineNum">    4230 </span>                :            : 
<span class="lineNum">    4231 </span>        [<span class="branchCov" title="Branch 0 was taken 876 times"> + </span><span class="branchCov" title="Branch 1 was taken 40 times"> + </span>]:<span class="lineCov">        916 :         if (err || ioctl_err) {</span>
<span class="lineNum">    4232 </span>                :            :                 err = -1;
<span class="lineNum">    4233 </span>                :            :                 goto out;
<span class="lineNum">    4234 </span>                :            :         }
<span class="lineNum">    4235 </span>                :            : 
<span class="lineNum">    4236 </span>        [<span class="branchCov" title="Branch 0 was taken 15 times"> + </span><span class="branchCov" title="Branch 1 was taken 861 times"> + </span>]:<span class="lineCov">        876 :         if (flags-&gt;verbose) {</span>
<span class="lineNum">    4237 </span>                :            :                 char buf1[64];
<span class="lineNum">    4238 </span>                :            :                 char buf2[64];
<span class="lineNum">    4239 </span>                :<span class="lineCov">         15 :                 uint64_t bytes = read_bytes;</span>
<span class="lineNum">    4240 </span>                :<span class="lineCov">         15 :                 time_t delta = time(NULL) - begin_time;</span>
<span class="lineNum">    4241 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>]:<span class="lineCov">         15 :                 if (delta == 0)</span>
<span class="lineNum">    4242 </span>                :<span class="lineCov">          3 :                         delta = 1;</span>
<span class="lineNum">    4243 </span>                :<span class="lineCov">         15 :                 zfs_nicebytes(bytes, buf1, sizeof (buf1));</span>
<span class="lineNum">    4244 </span>                :<span class="lineCov">         15 :                 zfs_nicebytes(bytes/delta, buf2, sizeof (buf1));</span>
<span class="lineNum">    4245 </span>                :            : 
<span class="lineNum">    4246 </span>                :<span class="lineCov">         15 :                 (void) printf(&quot;received %s stream in %lu seconds (%s/sec)\n&quot;,</span>
<span class="lineNum">    4247 </span>                :            :                     buf1, delta, buf2);
<span class="lineNum">    4248 </span>                :            :         }
<span class="lineNum">    4249 </span>                :            : 
<span class="lineNum">    4250 </span>                :            :         err = 0;
<span class="lineNum">    4251 </span>                :            : out:
<span class="lineNum">    4252 </span>        [<span class="branchCov" title="Branch 0 was taken 876 times"> + </span><span class="branchCov" title="Branch 1 was taken 48 times"> + </span>]:<span class="lineCov">        924 :         if (prop_errors != NULL)</span>
<span class="lineNum">    4253 </span>                :<span class="lineCov">        876 :                 nvlist_free(prop_errors);</span>
<span class="lineNum">    4254 </span>                :            : 
<span class="lineNum">    4255 </span>        [<span class="branchCov" title="Branch 0 was taken 21 times"> + </span><span class="branchCov" title="Branch 1 was taken 903 times"> + </span>]:<span class="lineCov">        924 :         if (tmp_keylocation[0] != '\0') {</span>
<span class="lineNum">    4256 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 21 times"> + </span>]:<span class="lineCov">         21 :                 VERIFY(0 == nvlist_add_string(rcvprops,</span>
<span class="lineNum">    4257 </span>                :            :                     zfs_prop_to_name(ZFS_PROP_KEYLOCATION), tmp_keylocation));
<span class="lineNum">    4258 </span>                :            :         }
<span class="lineNum">    4259 </span>                :            : 
<span class="lineNum">    4260 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 924 times"> + </span>]:<span class="lineCov">        924 :         if (newprops)</span>
<span class="lineNum">    4261 </span>                :<span class="lineNoCov">          0 :                 nvlist_free(rcvprops);</span>
<span class="lineNum">    4262 </span>                :            : 
<span class="lineNum">    4263 </span>                :<span class="lineCov">        924 :         nvlist_free(oxprops);</span>
<span class="lineNum">    4264 </span>                :<span class="lineCov">        924 :         nvlist_free(origprops);</span>
<span class="lineNum">    4265 </span>                :            : 
<span class="lineNum">    4266 </span>                :<span class="lineCov">        924 :         return (err);</span>
<span class="lineNum">    4267 </span>                :            : }
<span class="lineNum">    4268 </span>                :            : 
<span class="lineNum">    4269 </span>                :            : /*
<span class="lineNum">    4270 </span>                :            :  * Check properties we were asked to override (both -o|-x)
<a name="4271"><span class="lineNum">    4271 </span>                :            :  */</a>
<span class="lineNum">    4272 </span>                :            : static boolean_t
<span class="lineNum">    4273 </span>                :<span class="lineCov">       2156 : zfs_receive_checkprops(libzfs_handle_t *hdl, nvlist_t *props,</span>
<span class="lineNum">    4274 </span>                :            :     const char *errbuf)
<span class="lineNum">    4275 </span>                :            : {
<span class="lineNum">    4276 </span>                :            :         nvpair_t *nvp;
<span class="lineNum">    4277 </span>                :            :         zfs_prop_t prop;
<span class="lineNum">    4278 </span>                :            :         const char *name;
<span class="lineNum">    4279 </span>                :            : 
<span class="lineNum">    4280 </span>                :<span class="lineCov">       1078 :         nvp = NULL;</span>
<span class="lineNum">    4281 </span>        [<span class="branchCov" title="Branch 1 was taken 74 times"> + </span><span class="branchCov" title="Branch 2 was taken 1073 times"> + </span>]:<span class="lineCov">       1147 :         while ((nvp = nvlist_next_nvpair(props, nvp)) != NULL) {</span>
<span class="lineNum">    4282 </span>                :<span class="lineCov">         74 :                 name = nvpair_name(nvp);</span>
<span class="lineNum">    4283 </span>                :<span class="lineCov">         74 :                 prop = zfs_name_to_prop(name);</span>
<span class="lineNum">    4284 </span>                :            : 
<span class="lineNum">    4285 </span>        [<span class="branchCov" title="Branch 0 was taken 23 times"> + </span><span class="branchCov" title="Branch 1 was taken 51 times"> + </span>]:<span class="lineCov">         74 :                 if (prop == ZPROP_INVAL) {</span>
<span class="lineNum">    4286 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 23 times"> + </span>]:<span class="lineCov">         23 :                         if (!zfs_prop_user(name)) {</span>
<span class="lineNum">    4287 </span>                :<span class="lineNoCov">          0 :                                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    4288 </span>                :            :                                     &quot;invalid property '%s'&quot;), name);
<span class="lineNum">    4289 </span>                :            :                                 return (B_FALSE);
<span class="lineNum">    4290 </span>                :            :                         }
<span class="lineNum">    4291 </span>                :<span class="lineCov">         23 :                         continue;</span>
<span class="lineNum">    4292 </span>                :            :                 }
<span class="lineNum">    4293 </span>                :            :                 /*
<span class="lineNum">    4294 </span>                :            :                  * &quot;origin&quot; is readonly but is used to receive datasets as
<span class="lineNum">    4295 </span>                :            :                  * clones so we don't raise an error here
<span class="lineNum">    4296 </span>                :            :                  */
<span class="lineNum">    4297 </span>        [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 48 times"> + </span>]:<span class="lineCov">         51 :                 if (prop == ZFS_PROP_ORIGIN)</span>
<span class="lineNum">    4298 </span>                :<span class="lineCov">          3 :                         continue;</span>
<span class="lineNum">    4299 </span>                :            : 
<span class="lineNum">    4300 </span>                :            :                 /*
<span class="lineNum">    4301 </span>                :            :                  * cannot override readonly, set-once and other specific
<span class="lineNum">    4302 </span>                :            :                  * settable properties
<span class="lineNum">    4303 </span>                :            :                  */
<span class="lineNum">    4304 </span>[<span class="branchCov" title="Branch 1 was taken 47 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>][<span class="branchCov" title="Branch 3 was taken 4 times"> + </span><span class="branchCov" title="Branch 4 was taken 43 times"> + </span>]:<span class="lineCov">         48 :                 if (zfs_prop_readonly(prop) || prop == ZFS_PROP_VERSION ||</span>
<span class="lineNum">    4305 </span>                :<span class="lineCov">         47 :                     prop == ZFS_PROP_VOLSIZE) {</span>
<span class="lineNum">    4306 </span>                :<span class="lineCov">         74 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    4307 </span>                :            :                             &quot;invalid property '%s'&quot;), name);
<span class="lineNum">    4308 </span>                :            :                         return (B_FALSE);
<span class="lineNum">    4309 </span>                :            :                 }
<span class="lineNum">    4310 </span>                :            :         }
<span class="lineNum">    4311 </span>                :            : 
<span class="lineNum">    4312 </span>                :            :         return (B_TRUE);
<span class="lineNum">    4313 </span>                :            : }
<a name="4314"><span class="lineNum">    4314 </span>                :            : </a>
<span class="lineNum">    4315 </span>                :            : static int
<span class="lineNum">    4316 </span>                :<span class="lineCov">       1078 : zfs_receive_impl(libzfs_handle_t *hdl, const char *tosnap,</span>
<span class="lineNum">    4317 </span>                :            :     const char *originsnap, recvflags_t *flags, int infd, const char *sendfs,
<span class="lineNum">    4318 </span>                :            :     nvlist_t *stream_nv, avl_tree_t *stream_avl, char **top_zfs, int cleanup_fd,
<span class="lineNum">    4319 </span>                :            :     uint64_t *action_handlep, const char *finalsnap, nvlist_t *cmdprops)
<span class="lineNum">    4320 </span>                :            : {
<span class="lineNum">    4321 </span>                :            :         int err;
<span class="lineNum">    4322 </span>                :            :         dmu_replay_record_t drr, drr_noswap;
<span class="lineNum">    4323 </span>                :<span class="lineCov">       1078 :         struct drr_begin *drrb = &amp;drr.drr_u.drr_begin;</span>
<span class="lineNum">    4324 </span>                :            :         char errbuf[1024];
<span class="lineNum">    4325 </span>                :<span class="lineCov">       1078 :         zio_cksum_t zcksum = { { 0 } };</span>
<span class="lineNum">    4326 </span>                :            :         uint64_t featureflags;
<span class="lineNum">    4327 </span>                :            :         int hdrtype;
<span class="lineNum">    4328 </span>                :            : 
<span class="lineNum">    4329 </span>                :<span class="lineCov">       2156 :         (void) snprintf(errbuf, sizeof (errbuf), dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    4330 </span>                :            :             &quot;cannot receive&quot;));
<span class="lineNum">    4331 </span>                :            : 
<span class="lineNum">    4332 </span>                :            :         /* check cmdline props, raise an error if they cannot be received */
<span class="lineNum">    4333 </span>        [<span class="branchCov" title="Branch 1 was taken 5 times"> + </span><span class="branchCov" title="Branch 2 was taken 1073 times"> + </span>]:<span class="lineCov">       1078 :         if (!zfs_receive_checkprops(hdl, cmdprops, errbuf)) {</span>
<span class="lineNum">    4334 </span>                :<span class="lineCov">          5 :                 return (zfs_error(hdl, EZFS_BADPROP, errbuf));</span>
<span class="lineNum">    4335 </span>                :            :         }
<span class="lineNum">    4336 </span>                :            : 
<span class="lineNum">    4337 </span>  [<span class="branchCov" title="Branch 0 was taken 849 times"> + </span><span class="branchCov" title="Branch 1 was taken 224 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 849 times"> + </span>]:<span class="lineCov">       1922 :         if (flags-&gt;isprefix &amp;&amp;</span>
<span class="lineNum">    4338 </span>                :<span class="lineCov">        849 :             !zfs_dataset_exists(hdl, tosnap, ZFS_TYPE_DATASET)) {</span>
<span class="lineNum">    4339 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN, &quot;specified fs &quot;</span>
<span class="lineNum">    4340 </span>                :            :                     &quot;(%s) does not exist&quot;), tosnap);
<span class="lineNum">    4341 </span>                :<span class="lineNoCov">          0 :                 return (zfs_error(hdl, EZFS_NOENT, errbuf));</span>
<span class="lineNum">    4342 </span>                :            :         }
<span class="lineNum">    4343 </span>  [<span class="branchCov" title="Branch 0 was taken 3 times"> + </span><span class="branchCov" title="Branch 1 was taken 1070 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 3 times"> + </span>]:<span class="lineCov">       1076 :         if (originsnap &amp;&amp;</span>
<span class="lineNum">    4344 </span>                :<span class="lineCov">          3 :             !zfs_dataset_exists(hdl, originsnap, ZFS_TYPE_DATASET)) {</span>
<span class="lineNum">    4345 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN, &quot;specified origin fs &quot;</span>
<span class="lineNum">    4346 </span>                :            :                     &quot;(%s) does not exist&quot;), originsnap);
<span class="lineNum">    4347 </span>                :<span class="lineNoCov">          0 :                 return (zfs_error(hdl, EZFS_NOENT, errbuf));</span>
<span class="lineNum">    4348 </span>                :            :         }
<span class="lineNum">    4349 </span>                :            : 
<span class="lineNum">    4350 </span>                :            :         /* read in the BEGIN record */
<span class="lineNum">    4351 </span>        [<span class="branchCov" title="Branch 1 was taken 1073 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       1073 :         if (0 != (err = recv_read(hdl, infd, &amp;drr, sizeof (drr), B_FALSE,</span>
<span class="lineNum">    4352 </span>                :            :             &amp;zcksum)))
<span class="lineNum">    4353 </span>                :            :                 return (err);
<span class="lineNum">    4354 </span>                :            : 
<span class="lineNum">    4355 </span>        [<span class="branchCov" title="Branch 0 was taken 1005 times"> + </span><span class="branchCov" title="Branch 1 was taken 68 times"> + </span>]:<span class="lineCov">       1073 :         if (drr.drr_type == DRR_END || drr.drr_type == BSWAP_32(DRR_END)) {</span>
<span class="lineNum">    4356 </span>                :            :                 /* It's the double end record at the end of a package */
<span class="lineNum">    4357 </span>                :            :                 return (ENODATA);
<span class="lineNum">    4358 </span>                :            :         }
<span class="lineNum">    4359 </span>                :            : 
<span class="lineNum">    4360 </span>                :            :         /* the kernel needs the non-byteswapped begin record */
<span class="lineNum">    4361 </span>                :<span class="lineCov">       1005 :         drr_noswap = drr;</span>
<span class="lineNum">    4362 </span>                :            : 
<span class="lineNum">    4363 </span>                :<span class="lineCov">       1005 :         flags-&gt;byteswap = B_FALSE;</span>
<span class="lineNum">    4364 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1005 times"> + </span>]:<span class="lineCov">       1005 :         if (drrb-&gt;drr_magic == BSWAP_64(DMU_BACKUP_MAGIC)) {</span>
<span class="lineNum">    4365 </span>                :            :                 /*
<span class="lineNum">    4366 </span>                :            :                  * We computed the checksum in the wrong byteorder in
<span class="lineNum">    4367 </span>                :            :                  * recv_read() above; do it again correctly.
<span class="lineNum">    4368 </span>                :            :                  */
<span class="lineNum">    4369 </span>                :<span class="lineNoCov">          0 :                 bzero(&amp;zcksum, sizeof (zio_cksum_t));</span>
<span class="lineNum">    4370 </span>                :<span class="lineNoCov">          0 :                 fletcher_4_incremental_byteswap(&amp;drr, sizeof (drr), &amp;zcksum);</span>
<span class="lineNum">    4371 </span>                :<span class="lineNoCov">          0 :                 flags-&gt;byteswap = B_TRUE;</span>
<span class="lineNum">    4372 </span>                :            : 
<span class="lineNum">    4373 </span>                :<span class="lineNoCov">          0 :                 drr.drr_type = BSWAP_32(drr.drr_type);</span>
<span class="lineNum">    4374 </span>                :<span class="lineNoCov">          0 :                 drr.drr_payloadlen = BSWAP_32(drr.drr_payloadlen);</span>
<span class="lineNum">    4375 </span>                :<span class="lineNoCov">          0 :                 drrb-&gt;drr_magic = BSWAP_64(drrb-&gt;drr_magic);</span>
<span class="lineNum">    4376 </span>                :<span class="lineNoCov">          0 :                 drrb-&gt;drr_versioninfo = BSWAP_64(drrb-&gt;drr_versioninfo);</span>
<span class="lineNum">    4377 </span>                :<span class="lineNoCov">          0 :                 drrb-&gt;drr_creation_time = BSWAP_64(drrb-&gt;drr_creation_time);</span>
<span class="lineNum">    4378 </span>                :<span class="lineNoCov">          0 :                 drrb-&gt;drr_type = BSWAP_32(drrb-&gt;drr_type);</span>
<span class="lineNum">    4379 </span>                :<span class="lineNoCov">          0 :                 drrb-&gt;drr_flags = BSWAP_32(drrb-&gt;drr_flags);</span>
<span class="lineNum">    4380 </span>                :<span class="lineNoCov">          0 :                 drrb-&gt;drr_toguid = BSWAP_64(drrb-&gt;drr_toguid);</span>
<span class="lineNum">    4381 </span>                :<span class="lineNoCov">          0 :                 drrb-&gt;drr_fromguid = BSWAP_64(drrb-&gt;drr_fromguid);</span>
<span class="lineNum">    4382 </span>                :            :         }
<span class="lineNum">    4383 </span>                :            : 
<span class="lineNum">    4384 </span>[<span class="branchCov" title="Branch 0 was taken 1003 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1003 times"> + </span>]:<span class="lineCov">       1005 :         if (drrb-&gt;drr_magic != DMU_BACKUP_MAGIC || drr.drr_type != DRR_BEGIN) {</span>
<span class="lineNum">    4385 </span>                :<span class="lineCov">          2 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN, &quot;invalid &quot;</span>
<span class="lineNum">    4386 </span>                :            :                     &quot;stream (bad magic number)&quot;));
<span class="lineNum">    4387 </span>                :<span class="lineCov">          2 :                 return (zfs_error(hdl, EZFS_BADSTREAM, errbuf));</span>
<span class="lineNum">    4388 </span>                :            :         }
<span class="lineNum">    4389 </span>                :            : 
<span class="lineNum">    4390 </span>                :<span class="lineCov">       1003 :         featureflags = DMU_GET_FEATUREFLAGS(drrb-&gt;drr_versioninfo);</span>
<span class="lineNum">    4391 </span>                :<span class="lineCov">       1003 :         hdrtype = DMU_GET_STREAM_HDRTYPE(drrb-&gt;drr_versioninfo);</span>
<span class="lineNum">    4392 </span>                :            : 
<span class="lineNum">    4393 </span>[<span class="branchCov" title="Branch 0 was taken 1003 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1003 times"> + </span>]:<span class="lineCov">       1003 :         if (!DMU_STREAM_SUPPORTED(featureflags) ||</span>
<span class="lineNum">    4394 </span>                :<span class="lineCov">       1003 :             (hdrtype != DMU_SUBSTREAM &amp;&amp; hdrtype != DMU_COMPOUNDSTREAM)) {</span>
<span class="lineNum">    4395 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    4396 </span>                :            :                     &quot;stream has unsupported feature, feature flags = %lx&quot;),
<span class="lineNum">    4397 </span>                :            :                     featureflags);
<span class="lineNum">    4398 </span>                :<span class="lineNoCov">          0 :                 return (zfs_error(hdl, EZFS_BADSTREAM, errbuf));</span>
<span class="lineNum">    4399 </span>                :            :         }
<span class="lineNum">    4400 </span>                :            : 
<span class="lineNum">    4401 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1003 times"> + </span>]:<span class="lineCov">       1003 :         if (strchr(drrb-&gt;drr_toname, '@') == NULL) {</span>
<span class="lineNum">    4402 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN, &quot;invalid &quot;</span>
<span class="lineNum">    4403 </span>                :            :                     &quot;stream (bad snapshot name)&quot;));
<span class="lineNum">    4404 </span>                :<span class="lineNoCov">          0 :                 return (zfs_error(hdl, EZFS_BADSTREAM, errbuf));</span>
<span class="lineNum">    4405 </span>                :            :         }
<span class="lineNum">    4406 </span>                :            : 
<span class="lineNum">    4407 </span>        [<span class="branchCov" title="Branch 0 was taken 924 times"> + </span><span class="branchCov" title="Branch 1 was taken 79 times"> + </span>]:<span class="lineCov">       1003 :         if (DMU_GET_STREAM_HDRTYPE(drrb-&gt;drr_versioninfo) == DMU_SUBSTREAM) {</span>
<span class="lineNum">    4408 </span>                :            :                 char nonpackage_sendfs[ZFS_MAX_DATASET_NAME_LEN];
<span class="lineNum">    4409 </span>        [<span class="branchCov" title="Branch 0 was taken 134 times"> + </span><span class="branchCov" title="Branch 1 was taken 790 times"> + </span>]:<span class="lineCov">        924 :                 if (sendfs == NULL) {</span>
<span class="lineNum">    4410 </span>                :            :                         /*
<span class="lineNum">    4411 </span>                :            :                          * We were not called from zfs_receive_package(). Get
<span class="lineNum">    4412 </span>                :            :                          * the fs specified by 'zfs send'.
<span class="lineNum">    4413 </span>                :            :                          */
<span class="lineNum">    4414 </span>                :            :                         char *cp;
<span class="lineNum">    4415 </span>                :<span class="lineCov">        134 :                         (void) strlcpy(nonpackage_sendfs,</span>
<span class="lineNum">    4416 </span>                :            :                             drr.drr_u.drr_begin.drr_toname,
<span class="lineNum">    4417 </span>                :            :                             sizeof (nonpackage_sendfs));
<span class="lineNum">    4418 </span>        [<span class="branchCov" title="Branch 0 was taken 134 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        134 :                         if ((cp = strchr(nonpackage_sendfs, '@')) != NULL)</span>
<span class="lineNum">    4419 </span>                :<span class="lineCov">        134 :                                 *cp = '\0';</span>
<span class="lineNum">    4420 </span>                :<span class="lineCov">        134 :                         sendfs = nonpackage_sendfs;</span>
<span class="lineNum">    4421 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 134 times"> + </span>]:<span class="lineCov">        134 :                         VERIFY(finalsnap == NULL);</span>
<span class="lineNum">    4422 </span>                :            :                 }
<span class="lineNum">    4423 </span>                :<span class="lineCov">        924 :                 return (zfs_receive_one(hdl, infd, tosnap, originsnap, flags,</span>
<span class="lineNum">    4424 </span>                :            :                     &amp;drr, &amp;drr_noswap, sendfs, stream_nv, stream_avl, top_zfs,
<span class="lineNum">    4425 </span>                :            :                     cleanup_fd, action_handlep, finalsnap, cmdprops));
<span class="lineNum">    4426 </span>                :            :         } else {
<span class="lineNum">    4427 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 79 times"> + </span>]:<span class="lineCov">         79 :                 assert(DMU_GET_STREAM_HDRTYPE(drrb-&gt;drr_versioninfo) ==</span>
<span class="lineNum">    4428 </span>                :            :                     DMU_COMPOUNDSTREAM);
<span class="lineNum">    4429 </span>                :<span class="lineCov">         79 :                 return (zfs_receive_package(hdl, infd, tosnap, flags, &amp;drr,</span>
<span class="lineNum">    4430 </span>                :            :                     &amp;zcksum, top_zfs, cleanup_fd, action_handlep, cmdprops));
<span class="lineNum">    4431 </span>                :            :         }
<span class="lineNum">    4432 </span>                :            : }
<span class="lineNum">    4433 </span>                :            : 
<span class="lineNum">    4434 </span>                :            : /*
<span class="lineNum">    4435 </span>                :            :  * Restores a backup of tosnap from the file descriptor specified by infd.
<span class="lineNum">    4436 </span>                :            :  * Return 0 on total success, -2 if some things couldn't be
<span class="lineNum">    4437 </span>                :            :  * destroyed/renamed/promoted, -1 if some things couldn't be received.
<span class="lineNum">    4438 </span>                :            :  * (-1 will override -2, if -1 and the resumable flag was specified the
<span class="lineNum">    4439 </span>                :            :  * transfer can be resumed if the sending side supports it).
<a name="4440"><span class="lineNum">    4440 </span>                :            :  */</a>
<span class="lineNum">    4441 </span>                :            : int
<span class="lineNum">    4442 </span>                :<span class="lineCov">        220 : zfs_receive(libzfs_handle_t *hdl, const char *tosnap, nvlist_t *props,</span>
<span class="lineNum">    4443 </span>                :            :     recvflags_t *flags, int infd, avl_tree_t *stream_avl)
<span class="lineNum">    4444 </span>                :            : {
<span class="lineNum">    4445 </span>                :<span class="lineCov">        220 :         char *top_zfs = NULL;</span>
<span class="lineNum">    4446 </span>                :            :         int err;
<span class="lineNum">    4447 </span>                :            :         int cleanup_fd;
<span class="lineNum">    4448 </span>                :<span class="lineCov">        220 :         uint64_t action_handle = 0;</span>
<span class="lineNum">    4449 </span>                :            :         struct stat sb;
<span class="lineNum">    4450 </span>                :<span class="lineCov">        220 :         char *originsnap = NULL;</span>
<span class="lineNum">    4451 </span>                :            : 
<span class="lineNum">    4452 </span>                :            :         /*
<span class="lineNum">    4453 </span>                :            :          * The only way fstat can fail is if we do not have a valid file
<span class="lineNum">    4454 </span>                :            :          * descriptor.
<span class="lineNum">    4455 </span>                :            :          */
<span class="lineNum">    4456 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 220 times"> + </span>]:<span class="lineCov">        220 :         if (fstat(infd, &amp;sb) == -1) {</span>
<span class="lineNum">    4457 </span>                :<span class="lineNoCov">          0 :                 perror(&quot;fstat&quot;);</span>
<span class="lineNum">    4458 </span>                :<span class="lineNoCov">          0 :                 return (-2);</span>
<span class="lineNum">    4459 </span>                :            :         }
<span class="lineNum">    4460 </span>                :            : 
<span class="lineNum">    4461 </span>                :            : #ifdef __linux__
<span class="lineNum">    4462 </span>                :            : #ifndef F_SETPIPE_SZ
<span class="lineNum">    4463 </span>                :            : #define F_SETPIPE_SZ (F_SETLEASE + 7)
<span class="lineNum">    4464 </span>                :            : #endif /* F_SETPIPE_SZ */
<span class="lineNum">    4465 </span>                :            : 
<span class="lineNum">    4466 </span>                :            : #ifndef F_GETPIPE_SZ
<span class="lineNum">    4467 </span>                :            : #define F_GETPIPE_SZ (F_GETLEASE + 7)
<span class="lineNum">    4468 </span>                :            : #endif /* F_GETPIPE_SZ */
<span class="lineNum">    4469 </span>                :            : 
<span class="lineNum">    4470 </span>                :            :         /*
<span class="lineNum">    4471 </span>                :            :          * It is not uncommon for gigabytes to be processed in zfs receive.
<span class="lineNum">    4472 </span>                :            :          * Speculatively increase the buffer size via Linux-specific fcntl()
<span class="lineNum">    4473 </span>                :            :          * call.
<span class="lineNum">    4474 </span>                :            :          */
<span class="lineNum">    4475 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 220 times"> + </span>]:<span class="lineCov">        220 :         if (S_ISFIFO(sb.st_mode)) {</span>
<span class="lineNum">    4476 </span>                :<span class="lineNoCov">          0 :                 FILE *procf = fopen(&quot;/proc/sys/fs/pipe-max-size&quot;, &quot;r&quot;);</span>
<span class="lineNum">    4477 </span>                :            : 
<span class="lineNum">    4478 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (procf != NULL) {</span>
<span class="lineNum">    4479 </span>                :            :                         unsigned long max_psize;
<span class="lineNum">    4480 </span>                :            :                         long cur_psize;
<span class="lineNum">    4481 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (fscanf(procf, &quot;%lu&quot;, &amp;max_psize) &gt; 0) {</span>
<span class="lineNum">    4482 </span>                :<span class="lineNoCov">          0 :                                 cur_psize = fcntl(infd, F_GETPIPE_SZ);</span>
<span class="lineNum">    4483 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (cur_psize &gt; 0 &amp;&amp;</span>
<span class="lineNum">    4484 </span>                :<span class="lineNoCov">          0 :                                     max_psize &gt; (unsigned long) cur_psize)</span>
<span class="lineNum">    4485 </span>                :<span class="lineNoCov">          0 :                                         (void) fcntl(infd, F_SETPIPE_SZ,</span>
<span class="lineNum">    4486 </span>                :            :                                             max_psize);
<span class="lineNum">    4487 </span>                :            :                         }
<span class="lineNum">    4488 </span>                :<span class="lineNoCov">          0 :                         fclose(procf);</span>
<span class="lineNum">    4489 </span>                :            :                 }
<span class="lineNum">    4490 </span>                :            :         }
<span class="lineNum">    4491 </span>                :            : #endif /* __linux__ */
<span class="lineNum">    4492 </span>                :            : 
<span class="lineNum">    4493 </span>        [<span class="branchCov" title="Branch 0 was taken 220 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        220 :         if (props) {</span>
<span class="lineNum">    4494 </span>                :<span class="lineCov">        220 :                 err = nvlist_lookup_string(props, &quot;origin&quot;, &amp;originsnap);</span>
<span class="lineNum">    4495 </span>        [<span class="branchCov" title="Branch 0 was taken 220 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        220 :                 if (err &amp;&amp; err != ENOENT)</span>
<span class="lineNum">    4496 </span>                :            :                         return (err);
<span class="lineNum">    4497 </span>                :            :         }
<span class="lineNum">    4498 </span>                :            : 
<span class="lineNum">    4499 </span>                :<span class="lineCov">        220 :         cleanup_fd = open(ZFS_DEV, O_RDWR);</span>
<span class="lineNum">    4500 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 220 times"> + </span>]:<span class="lineCov">        220 :         VERIFY(cleanup_fd &gt;= 0);</span>
<span class="lineNum">    4501 </span>                :            : 
<span class="lineNum">    4502 </span>                :<span class="lineCov">        220 :         err = zfs_receive_impl(hdl, tosnap, originsnap, flags, infd, NULL, NULL,</span>
<span class="lineNum">    4503 </span>                :            :             stream_avl, &amp;top_zfs, cleanup_fd, &amp;action_handle, NULL, props);
<span class="lineNum">    4504 </span>                :            : 
<span class="lineNum">    4505 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 220 times"> + </span>]:<span class="lineCov">        220 :         VERIFY(0 == close(cleanup_fd));</span>
<span class="lineNum">    4506 </span>                :            : 
<span class="lineNum">    4507 </span>[<span class="branchCov" title="Branch 0 was taken 169 times"> + </span><span class="branchCov" title="Branch 1 was taken 51 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 161 times"> + </span><span class="branchCov" title="Branch 3 was taken 8 times"> + </span>]:<span class="lineCov">        220 :         if (err == 0 &amp;&amp; !flags-&gt;nomount &amp;&amp; top_zfs) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 129 times"> + </span><span class="branchCov" title="Branch 5 was taken 32 times"> + </span>]
<span class="lineNum">    4508 </span>                :<span class="lineCov">        129 :                 zfs_handle_t *zhp = NULL;</span>
<span class="lineNum">    4509 </span>                :<span class="lineCov">        129 :                 prop_changelist_t *clp = NULL;</span>
<span class="lineNum">    4510 </span>                :            : 
<span class="lineNum">    4511 </span>                :<span class="lineCov">        129 :                 zhp = zfs_open(hdl, top_zfs, ZFS_TYPE_FILESYSTEM);</span>
<span class="lineNum">    4512 </span>        [<span class="branchCov" title="Branch 0 was taken 129 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        129 :                 if (zhp != NULL) {</span>
<span class="lineNum">    4513 </span>                :<span class="lineCov">        129 :                         clp = changelist_gather(zhp, ZFS_PROP_MOUNTPOINT,</span>
<span class="lineNum">    4514 </span>                :            :                             CL_GATHER_MOUNT_ALWAYS, 0);
<span class="lineNum">    4515 </span>                :<span class="lineCov">        129 :                         zfs_close(zhp);</span>
<span class="lineNum">    4516 </span>        [<span class="branchCov" title="Branch 0 was taken 129 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        129 :                         if (clp != NULL) {</span>
<span class="lineNum">    4517 </span>                :            :                                 /* mount and share received datasets */
<span class="lineNum">    4518 </span>                :<span class="lineCov">        129 :                                 err = changelist_postfix(clp);</span>
<span class="lineNum">    4519 </span>                :<span class="lineCov">        129 :                                 changelist_free(clp);</span>
<span class="lineNum">    4520 </span>                :            :                         }
<span class="lineNum">    4521 </span>                :            :                 }
<span class="lineNum">    4522 </span>[<span class="branchCov" title="Branch 0 was taken 129 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 129 times"> + </span>]:<span class="lineCov">        129 :                 if (zhp == NULL || clp == NULL || err)</span>
<span class="lineNum">    4523 </span>                :<span class="lineNoCov">          0 :                         err = -1;</span>
<span class="lineNum">    4524 </span>                :            :         }
<span class="lineNum">    4525 </span>        [<span class="branchCov" title="Branch 0 was taken 136 times"> + </span><span class="branchCov" title="Branch 1 was taken 84 times"> + </span>]:<span class="lineCov">        220 :         if (top_zfs)</span>
<span class="lineNum">    4526 </span>                :<span class="lineCov">        136 :                 free(top_zfs);</span>
<span class="lineNum">    4527 </span>                :            : 
<span class="lineNum">    4528 </span>                :            :         return (err);
<span class="lineNum">    4529 </span>                :            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
