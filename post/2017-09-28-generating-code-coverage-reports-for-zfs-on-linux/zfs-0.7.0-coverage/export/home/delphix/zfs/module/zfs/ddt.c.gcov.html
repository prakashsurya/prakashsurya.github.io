<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - zfs-0.7.0 Code Coverage - /export/home/delphix/zfs/module/zfs/ddt.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../../index.html">top level</a> - <a href="index.html">export/home/delphix/zfs/module/zfs</a> - ddt.c<span style="font-size: 80%;"> (source / <a href="ddt.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">zfs-0.7.0 Code Coverage</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">568</td>
            <td class="headerCovTableEntry">587</td>
            <td class="headerCovTableEntryHi">96.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-09-28 14:23:58</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">63</td>
            <td class="headerCovTableEntry">65</td>
            <td class="headerCovTableEntryHi">96.9 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
            | Branches:
            <span class="coverLegendCov">+</span> taken
            <span class="coverLegendNoCov">-</span> not taken
            <span class="coverLegendNoCov">#</span> not executed
</td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">292</td>
            <td class="headerCovTableEntry">426</td>
            <td class="headerCovTableEntryLo">68.5 %</td>
          </tr>
          <tr><td><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : /*</a>
<span class="lineNum">       2 </span>                :            :  * CDDL HEADER START
<span class="lineNum">       3 </span>                :            :  *
<span class="lineNum">       4 </span>                :            :  * The contents of this file are subject to the terms of the
<span class="lineNum">       5 </span>                :            :  * Common Development and Distribution License (the &quot;License&quot;).
<span class="lineNum">       6 </span>                :            :  * You may not use this file except in compliance with the License.
<span class="lineNum">       7 </span>                :            :  *
<span class="lineNum">       8 </span>                :            :  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
<span class="lineNum">       9 </span>                :            :  * or http://www.opensolaris.org/os/licensing.
<span class="lineNum">      10 </span>                :            :  * See the License for the specific language governing permissions
<span class="lineNum">      11 </span>                :            :  * and limitations under the License.
<span class="lineNum">      12 </span>                :            :  *
<span class="lineNum">      13 </span>                :            :  * When distributing Covered Code, include this CDDL HEADER in each
<span class="lineNum">      14 </span>                :            :  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.
<span class="lineNum">      15 </span>                :            :  * If applicable, add the following below this CDDL HEADER, with the
<span class="lineNum">      16 </span>                :            :  * fields enclosed by brackets &quot;[]&quot; replaced with your own identifying
<span class="lineNum">      17 </span>                :            :  * information: Portions Copyright [yyyy] [name of copyright owner]
<span class="lineNum">      18 </span>                :            :  *
<span class="lineNum">      19 </span>                :            :  * CDDL HEADER END
<span class="lineNum">      20 </span>                :            :  */
<span class="lineNum">      21 </span>                :            : 
<span class="lineNum">      22 </span>                :            : /*
<span class="lineNum">      23 </span>                :            :  * Copyright (c) 2009, 2010, Oracle and/or its affiliates. All rights reserved.
<span class="lineNum">      24 </span>                :            :  * Copyright (c) 2012, 2016 by Delphix. All rights reserved.
<span class="lineNum">      25 </span>                :            :  */
<span class="lineNum">      26 </span>                :            : 
<span class="lineNum">      27 </span>                :            : #include &lt;sys/zfs_context.h&gt;
<span class="lineNum">      28 </span>                :            : #include &lt;sys/spa.h&gt;
<span class="lineNum">      29 </span>                :            : #include &lt;sys/spa_impl.h&gt;
<span class="lineNum">      30 </span>                :            : #include &lt;sys/zio.h&gt;
<span class="lineNum">      31 </span>                :            : #include &lt;sys/ddt.h&gt;
<span class="lineNum">      32 </span>                :            : #include &lt;sys/zap.h&gt;
<span class="lineNum">      33 </span>                :            : #include &lt;sys/dmu_tx.h&gt;
<span class="lineNum">      34 </span>                :            : #include &lt;sys/arc.h&gt;
<span class="lineNum">      35 </span>                :            : #include &lt;sys/dsl_pool.h&gt;
<span class="lineNum">      36 </span>                :            : #include &lt;sys/zio_checksum.h&gt;
<span class="lineNum">      37 </span>                :            : #include &lt;sys/zio_compress.h&gt;
<span class="lineNum">      38 </span>                :            : #include &lt;sys/dsl_scan.h&gt;
<span class="lineNum">      39 </span>                :            : #include &lt;sys/abd.h&gt;
<span class="lineNum">      40 </span>                :            : 
<span class="lineNum">      41 </span>                :            : static kmem_cache_t *ddt_cache;
<span class="lineNum">      42 </span>                :            : static kmem_cache_t *ddt_entry_cache;
<span class="lineNum">      43 </span>                :            : 
<span class="lineNum">      44 </span>                :            : /*
<span class="lineNum">      45 </span>                :            :  * Enable/disable prefetching of dedup-ed blocks which are going to be freed.
<span class="lineNum">      46 </span>                :            :  */
<span class="lineNum">      47 </span>                :            : int zfs_dedup_prefetch = 0;
<span class="lineNum">      48 </span>                :            : 
<span class="lineNum">      49 </span>                :            : static const ddt_ops_t *ddt_ops[DDT_TYPES] = {
<span class="lineNum">      50 </span>                :            :         &amp;ddt_zap_ops,
<span class="lineNum">      51 </span>                :            : };
<span class="lineNum">      52 </span>                :            : 
<span class="lineNum">      53 </span>                :            : static const char *ddt_class_name[DDT_CLASSES] = {
<span class="lineNum">      54 </span>                :            :         &quot;ditto&quot;,
<span class="lineNum">      55 </span>                :            :         &quot;duplicate&quot;,
<span class="lineNum">      56 </span>                :            :         &quot;unique&quot;,
<span class="lineNum">      57 </span>                :            : };
<a name="58"><span class="lineNum">      58 </span>                :            : </a>
<span class="lineNum">      59 </span>                :            : static void
<span class="lineNum">      60 </span>                :<span class="lineCov">         84 : ddt_object_create(ddt_t *ddt, enum ddt_type type, enum ddt_class class,</span>
<span class="lineNum">      61 </span>                :            :     dmu_tx_t *tx)
<span class="lineNum">      62 </span>                :            : {
<span class="lineNum">      63 </span>                :<span class="lineCov">         84 :         spa_t *spa = ddt-&gt;ddt_spa;</span>
<span class="lineNum">      64 </span>                :<span class="lineCov">         84 :         objset_t *os = ddt-&gt;ddt_os;</span>
<span class="lineNum">      65 </span>                :<span class="lineCov">         84 :         uint64_t *objectp = &amp;ddt-&gt;ddt_object[type][class];</span>
<span class="lineNum">      66 </span>                :<span class="lineCov">         84 :         boolean_t prehash = zio_checksum_table[ddt-&gt;ddt_checksum].ci_flags &amp;</span>
<span class="lineNum">      67 </span>                :            :             ZCHECKSUM_FLAG_DEDUP;
<span class="lineNum">      68 </span>                :            :         char name[DDT_NAMELEN];
<span class="lineNum">      69 </span>                :            : 
<span class="lineNum">      70 </span>                :<span class="lineCov">         84 :         ddt_object_name(ddt, type, class, name);</span>
<span class="lineNum">      71 </span>                :            : 
<span class="lineNum">      72 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 84 times"> + </span>]:<span class="lineCov">         84 :         ASSERT(*objectp == 0);</span>
<span class="lineNum">      73 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 84 times"> + </span>]:<span class="lineCov">         84 :         VERIFY(ddt_ops[type]-&gt;ddt_op_create(os, objectp, tx, prehash) == 0);</span>
<span class="lineNum">      74 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 84 times"> + </span>]:<span class="lineCov">         84 :         ASSERT(*objectp != 0);</span>
<span class="lineNum">      75 </span>                :            : 
<span class="lineNum">      76 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 84 times"> + </span>]:<span class="lineCov">         84 :         VERIFY(zap_add(os, DMU_POOL_DIRECTORY_OBJECT, name,</span>
<span class="lineNum">      77 </span>                :            :             sizeof (uint64_t), 1, objectp, tx) == 0);
<span class="lineNum">      78 </span>                :            : 
<span class="lineNum">      79 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 84 times"> + </span>]:<span class="lineCov">         84 :         VERIFY(zap_add(os, spa-&gt;spa_ddt_stat_object, name,</span>
<span class="lineNum">      80 </span>                :            :             sizeof (uint64_t), sizeof (ddt_histogram_t) / sizeof (uint64_t),
<span class="lineNum">      81 </span>                :            :             &amp;ddt-&gt;ddt_histogram[type][class], tx) == 0);
<span class="lineNum">      82 </span>                :<span class="lineCov">         84 : }</span>
<a name="83"><span class="lineNum">      83 </span>                :            : </a>
<span class="lineNum">      84 </span>                :            : static void
<span class="lineNum">      85 </span>                :<span class="lineCov">          5 : ddt_object_destroy(ddt_t *ddt, enum ddt_type type, enum ddt_class class,</span>
<span class="lineNum">      86 </span>                :            :     dmu_tx_t *tx)
<span class="lineNum">      87 </span>                :            : {
<span class="lineNum">      88 </span>                :<span class="lineCov">          5 :         spa_t *spa = ddt-&gt;ddt_spa;</span>
<span class="lineNum">      89 </span>                :<span class="lineCov">          5 :         objset_t *os = ddt-&gt;ddt_os;</span>
<span class="lineNum">      90 </span>                :<span class="lineCov">          5 :         uint64_t *objectp = &amp;ddt-&gt;ddt_object[type][class];</span>
<span class="lineNum">      91 </span>                :            :         uint64_t count;
<span class="lineNum">      92 </span>                :            :         char name[DDT_NAMELEN];
<span class="lineNum">      93 </span>                :            : 
<span class="lineNum">      94 </span>                :<span class="lineCov">          5 :         ddt_object_name(ddt, type, class, name);</span>
<span class="lineNum">      95 </span>                :            : 
<span class="lineNum">      96 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">          5 :         ASSERT(*objectp != 0);</span>
<span class="lineNum">      97 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 5 times"> + </span>]:<span class="lineCov">          5 :         ASSERT(ddt_histogram_empty(&amp;ddt-&gt;ddt_histogram[type][class]));</span>
<span class="lineNum">      98 </span>[<span class="branchCov" title="Branch 1 was taken 5 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 5 times"> + </span>]:<span class="lineCov">          5 :         VERIFY(ddt_object_count(ddt, type, class, &amp;count) == 0 &amp;&amp; count == 0);</span>
<span class="lineNum">      99 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 5 times"> + </span>]:<span class="lineCov">          5 :         VERIFY(zap_remove(os, DMU_POOL_DIRECTORY_OBJECT, name, tx) == 0);</span>
<span class="lineNum">     100 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 5 times"> + </span>]:<span class="lineCov">          5 :         VERIFY(zap_remove(os, spa-&gt;spa_ddt_stat_object, name, tx) == 0);</span>
<span class="lineNum">     101 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 5 times"> + </span>]:<span class="lineCov">          5 :         VERIFY(ddt_ops[type]-&gt;ddt_op_destroy(os, *objectp, tx) == 0);</span>
<span class="lineNum">     102 </span>                :<span class="lineCov">         10 :         bzero(&amp;ddt-&gt;ddt_object_stats[type][class], sizeof (ddt_object_t));</span>
<span class="lineNum">     103 </span>                :            : 
<span class="lineNum">     104 </span>                :<span class="lineCov">          5 :         *objectp = 0;</span>
<span class="lineNum">     105 </span>                :<span class="lineCov">          5 : }</span>
<a name="106"><span class="lineNum">     106 </span>                :            : </a>
<span class="lineNum">     107 </span>                :            : static int
<span class="lineNum">     108 </span>                :<span class="lineCov">      17136 : ddt_object_load(ddt_t *ddt, enum ddt_type type, enum ddt_class class)</span>
<span class="lineNum">     109 </span>                :            : {
<span class="lineNum">     110 </span>                :<span class="lineCov">      17136 :         ddt_object_t *ddo = &amp;ddt-&gt;ddt_object_stats[type][class];</span>
<span class="lineNum">     111 </span>                :            :         dmu_object_info_t doi;
<span class="lineNum">     112 </span>                :            :         uint64_t count;
<span class="lineNum">     113 </span>                :            :         char name[DDT_NAMELEN];
<span class="lineNum">     114 </span>                :            :         int error;
<span class="lineNum">     115 </span>                :            : 
<span class="lineNum">     116 </span>                :<span class="lineCov">      17136 :         ddt_object_name(ddt, type, class, name);</span>
<span class="lineNum">     117 </span>                :            : 
<span class="lineNum">     118 </span>                :<span class="lineCov">      17136 :         error = zap_lookup(ddt-&gt;ddt_os, DMU_POOL_DIRECTORY_OBJECT, name,</span>
<span class="lineNum">     119 </span>                :<span class="lineCov">      17136 :             sizeof (uint64_t), 1, &amp;ddt-&gt;ddt_object[type][class]);</span>
<span class="lineNum">     120 </span>        [<span class="branchCov" title="Branch 0 was taken 1337 times"> + </span><span class="branchCov" title="Branch 1 was taken 15799 times"> + </span>]:<span class="lineCov">      17136 :         if (error != 0)</span>
<span class="lineNum">     121 </span>                :            :                 return (error);
<span class="lineNum">     122 </span>                :            : 
<span class="lineNum">     123 </span>                :<span class="lineCov">       1337 :         error = zap_lookup(ddt-&gt;ddt_os, ddt-&gt;ddt_spa-&gt;spa_ddt_stat_object, name,</span>
<span class="lineNum">     124 </span>                :            :             sizeof (uint64_t), sizeof (ddt_histogram_t) / sizeof (uint64_t),
<span class="lineNum">     125 </span>                :<span class="lineCov">       1337 :             &amp;ddt-&gt;ddt_histogram[type][class]);</span>
<span class="lineNum">     126 </span>        [<span class="branchCov" title="Branch 0 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1337 :         if (error != 0)</span>
<span class="lineNum">     127 </span>                :            :                 return (error);
<span class="lineNum">     128 </span>                :            : 
<span class="lineNum">     129 </span>                :            :         /*
<span class="lineNum">     130 </span>                :            :          * Seed the cached statistics.
<span class="lineNum">     131 </span>                :            :          */
<span class="lineNum">     132 </span>                :<span class="lineCov">       1337 :         error = ddt_object_info(ddt, type, class, &amp;doi);</span>
<span class="lineNum">     133 </span>        [<span class="branchCov" title="Branch 0 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1337 :         if (error)</span>
<span class="lineNum">     134 </span>                :            :                 return (error);
<span class="lineNum">     135 </span>                :            : 
<span class="lineNum">     136 </span>                :<span class="lineCov">       1337 :         error = ddt_object_count(ddt, type, class, &amp;count);</span>
<span class="lineNum">     137 </span>        [<span class="branchCov" title="Branch 0 was taken 1337 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1337 :         if (error)</span>
<span class="lineNum">     138 </span>                :            :                 return (error);
<span class="lineNum">     139 </span>                :            : 
<span class="lineNum">     140 </span>                :<span class="lineCov">       1337 :         ddo-&gt;ddo_count = count;</span>
<span class="lineNum">     141 </span>                :<span class="lineCov">       1337 :         ddo-&gt;ddo_dspace = doi.doi_physical_blocks_512 &lt;&lt; 9;</span>
<span class="lineNum">     142 </span>                :<span class="lineCov">       1337 :         ddo-&gt;ddo_mspace = doi.doi_fill_count * doi.doi_data_block_size;</span>
<span class="lineNum">     143 </span>                :            : 
<span class="lineNum">     144 </span>                :<span class="lineCov">       1337 :         return (0);</span>
<span class="lineNum">     145 </span>                :            : }
<a name="146"><span class="lineNum">     146 </span>                :            : </a>
<span class="lineNum">     147 </span>                :            : static void
<span class="lineNum">     148 </span>                :<span class="lineCov">       4193 : ddt_object_sync(ddt_t *ddt, enum ddt_type type, enum ddt_class class,</span>
<span class="lineNum">     149 </span>                :            :     dmu_tx_t *tx)
<span class="lineNum">     150 </span>                :            : {
<span class="lineNum">     151 </span>                :<span class="lineCov">       4193 :         ddt_object_t *ddo = &amp;ddt-&gt;ddt_object_stats[type][class];</span>
<span class="lineNum">     152 </span>                :            :         dmu_object_info_t doi;
<span class="lineNum">     153 </span>                :            :         uint64_t count;
<span class="lineNum">     154 </span>                :            :         char name[DDT_NAMELEN];
<span class="lineNum">     155 </span>                :            : 
<span class="lineNum">     156 </span>                :<span class="lineCov">       4193 :         ddt_object_name(ddt, type, class, name);</span>
<span class="lineNum">     157 </span>                :            : 
<span class="lineNum">     158 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 4193 times"> + </span>]:<span class="lineCov">       4193 :         VERIFY(zap_update(ddt-&gt;ddt_os, ddt-&gt;ddt_spa-&gt;spa_ddt_stat_object, name,</span>
<span class="lineNum">     159 </span>                :            :             sizeof (uint64_t), sizeof (ddt_histogram_t) / sizeof (uint64_t),
<span class="lineNum">     160 </span>                :            :             &amp;ddt-&gt;ddt_histogram[type][class], tx) == 0);
<span class="lineNum">     161 </span>                :            : 
<span class="lineNum">     162 </span>                :            :         /*
<span class="lineNum">     163 </span>                :            :          * Cache DDT statistics; this is the only time they'll change.
<span class="lineNum">     164 </span>                :            :          */
<span class="lineNum">     165 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 4193 times"> + </span>]:<span class="lineCov">       4193 :         VERIFY(ddt_object_info(ddt, type, class, &amp;doi) == 0);</span>
<span class="lineNum">     166 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 4193 times"> + </span>]:<span class="lineCov">       4193 :         VERIFY(ddt_object_count(ddt, type, class, &amp;count) == 0);</span>
<span class="lineNum">     167 </span>                :            : 
<span class="lineNum">     168 </span>                :<span class="lineCov">       4193 :         ddo-&gt;ddo_count = count;</span>
<span class="lineNum">     169 </span>                :<span class="lineCov">       4193 :         ddo-&gt;ddo_dspace = doi.doi_physical_blocks_512 &lt;&lt; 9;</span>
<span class="lineNum">     170 </span>                :<span class="lineCov">       4193 :         ddo-&gt;ddo_mspace = doi.doi_fill_count * doi.doi_data_block_size;</span>
<span class="lineNum">     171 </span>                :<span class="lineCov">       4193 : }</span>
<a name="172"><span class="lineNum">     172 </span>                :            : </a>
<span class="lineNum">     173 </span>                :            : static int
<span class="lineNum">     174 </span>                :<span class="lineCov">      79290 : ddt_object_lookup(ddt_t *ddt, enum ddt_type type, enum ddt_class class,</span>
<span class="lineNum">     175 </span>                :            :     ddt_entry_t *dde)
<span class="lineNum">     176 </span>                :            : {
<span class="lineNum">     177 </span>        [<span class="branchCov" title="Branch 1 was taken 19299 times"> + </span><span class="branchCov" title="Branch 2 was taken 59991 times"> + </span>]:<span class="lineCov">      79290 :         if (!ddt_object_exists(ddt, type, class))</span>
<span class="lineNum">     178 </span>                :<span class="lineCov">      19299 :                 return (SET_ERROR(ENOENT));</span>
<span class="lineNum">     179 </span>                :            : 
<span class="lineNum">     180 </span>                :<span class="lineCov">      59991 :         return (ddt_ops[type]-&gt;ddt_op_lookup(ddt-&gt;ddt_os,</span>
<span class="lineNum">     181 </span>                :            :             ddt-&gt;ddt_object[type][class], dde));
<span class="lineNum">     182 </span>                :            : }
<a name="183"><span class="lineNum">     183 </span>                :            : </a>
<span class="lineNum">     184 </span>                :            : static void
<span class="lineNum">     185 </span>                :<span class="lineNoCov">          0 : ddt_object_prefetch(ddt_t *ddt, enum ddt_type type, enum ddt_class class,</span>
<span class="lineNum">     186 </span>                :            :     ddt_entry_t *dde)
<span class="lineNum">     187 </span>                :            : {
<span class="lineNum">     188 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!ddt_object_exists(ddt, type, class))</span>
<span class="lineNum">     189 </span>                :            :                 return;
<span class="lineNum">     190 </span>                :            : 
<span class="lineNum">     191 </span>                :<span class="lineNoCov">          0 :         ddt_ops[type]-&gt;ddt_op_prefetch(ddt-&gt;ddt_os,</span>
<span class="lineNum">     192 </span>                :            :             ddt-&gt;ddt_object[type][class], dde);
<span class="lineNum">     193 </span>                :            : }
<a name="194"><span class="lineNum">     194 </span>                :            : </a>
<span class="lineNum">     195 </span>                :            : int
<span class="lineNum">     196 </span>                :<span class="lineCov">       5274 : ddt_object_update(ddt_t *ddt, enum ddt_type type, enum ddt_class class,</span>
<span class="lineNum">     197 </span>                :            :     ddt_entry_t *dde, dmu_tx_t *tx)
<span class="lineNum">     198 </span>                :            : {
<span class="lineNum">     199 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 5274 times"> + </span>]:<span class="lineCov">       5274 :         ASSERT(ddt_object_exists(ddt, type, class));</span>
<span class="lineNum">     200 </span>                :            : 
<span class="lineNum">     201 </span>                :<span class="lineCov">       5274 :         return (ddt_ops[type]-&gt;ddt_op_update(ddt-&gt;ddt_os,</span>
<span class="lineNum">     202 </span>                :            :             ddt-&gt;ddt_object[type][class], dde, tx));
<span class="lineNum">     203 </span>                :            : }
<a name="204"><span class="lineNum">     204 </span>                :            : </a>
<span class="lineNum">     205 </span>                :            : static int
<span class="lineNum">     206 </span>                :<span class="lineCov">       2971 : ddt_object_remove(ddt_t *ddt, enum ddt_type type, enum ddt_class class,</span>
<span class="lineNum">     207 </span>                :            :     ddt_entry_t *dde, dmu_tx_t *tx)
<span class="lineNum">     208 </span>                :            : {
<span class="lineNum">     209 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2971 times"> + </span>]:<span class="lineCov">       2971 :         ASSERT(ddt_object_exists(ddt, type, class));</span>
<span class="lineNum">     210 </span>                :            : 
<span class="lineNum">     211 </span>                :<span class="lineCov">       2971 :         return (ddt_ops[type]-&gt;ddt_op_remove(ddt-&gt;ddt_os,</span>
<span class="lineNum">     212 </span>                :            :             ddt-&gt;ddt_object[type][class], dde, tx));
<span class="lineNum">     213 </span>                :            : }
<a name="214"><span class="lineNum">     214 </span>                :            : </a>
<span class="lineNum">     215 </span>                :            : int
<span class="lineNum">     216 </span>                :<span class="lineCov">        558 : ddt_object_walk(ddt_t *ddt, enum ddt_type type, enum ddt_class class,</span>
<span class="lineNum">     217 </span>                :            :     uint64_t *walk, ddt_entry_t *dde)
<span class="lineNum">     218 </span>                :            : {
<span class="lineNum">     219 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 558 times"> + </span>]:<span class="lineCov">        558 :         ASSERT(ddt_object_exists(ddt, type, class));</span>
<span class="lineNum">     220 </span>                :            : 
<span class="lineNum">     221 </span>                :<span class="lineCov">        558 :         return (ddt_ops[type]-&gt;ddt_op_walk(ddt-&gt;ddt_os,</span>
<span class="lineNum">     222 </span>                :            :             ddt-&gt;ddt_object[type][class], dde, walk));
<span class="lineNum">     223 </span>                :            : }
<a name="224"><span class="lineNum">     224 </span>                :            : </a>
<span class="lineNum">     225 </span>                :            : int
<span class="lineNum">     226 </span>                :<span class="lineCov">       9870 : ddt_object_count(ddt_t *ddt, enum ddt_type type, enum ddt_class class,</span>
<span class="lineNum">     227 </span>                :            :     uint64_t *count)
<span class="lineNum">     228 </span>                :            : {
<span class="lineNum">     229 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 9870 times"> + </span>]:<span class="lineCov">       9870 :         ASSERT(ddt_object_exists(ddt, type, class));</span>
<span class="lineNum">     230 </span>                :            : 
<span class="lineNum">     231 </span>                :<span class="lineCov">       9870 :         return (ddt_ops[type]-&gt;ddt_op_count(ddt-&gt;ddt_os,</span>
<span class="lineNum">     232 </span>                :            :             ddt-&gt;ddt_object[type][class], count));
<span class="lineNum">     233 </span>                :            : }
<a name="234"><span class="lineNum">     234 </span>                :            : </a>
<span class="lineNum">     235 </span>                :            : int
<span class="lineNum">     236 </span>                :<span class="lineCov">       7588 : ddt_object_info(ddt_t *ddt, enum ddt_type type, enum ddt_class class,</span>
<span class="lineNum">     237 </span>                :            :     dmu_object_info_t *doi)
<span class="lineNum">     238 </span>                :            : {
<span class="lineNum">     239 </span>        [<span class="branchCov" title="Branch 1 was taken 1916 times"> + </span><span class="branchCov" title="Branch 2 was taken 5672 times"> + </span>]:<span class="lineCov">       7588 :         if (!ddt_object_exists(ddt, type, class))</span>
<span class="lineNum">     240 </span>                :<span class="lineCov">       1916 :                 return (SET_ERROR(ENOENT));</span>
<span class="lineNum">     241 </span>                :            : 
<span class="lineNum">     242 </span>                :<span class="lineCov">       5672 :         return (dmu_object_info(ddt-&gt;ddt_os, ddt-&gt;ddt_object[type][class],</span>
<span class="lineNum">     243 </span>                :            :             doi));
<span class="lineNum">     244 </span>                :            : }
<a name="245"><span class="lineNum">     245 </span>                :            : </a>
<span class="lineNum">     246 </span>                :            : boolean_t
<span class="lineNum">     247 </span>                :<span class="lineCov">     130848 : ddt_object_exists(ddt_t *ddt, enum ddt_type type, enum ddt_class class)</span>
<span class="lineNum">     248 </span>                :            : {
<span class="lineNum">     249 </span>                :<span class="lineCov">     130848 :         return (!!ddt-&gt;ddt_object[type][class]);</span>
<span class="lineNum">     250 </span>                :            : }
<a name="251"><span class="lineNum">     251 </span>                :            : </a>
<span class="lineNum">     252 </span>                :            : void
<span class="lineNum">     253 </span>                :<span class="lineCov">      21548 : ddt_object_name(ddt_t *ddt, enum ddt_type type, enum ddt_class class,</span>
<span class="lineNum">     254 </span>                :            :     char *name)
<span class="lineNum">     255 </span>                :            : {
<span class="lineNum">     256 </span>                :<span class="lineCov">      64644 :         (void) sprintf(name, DMU_POOL_DDT,</span>
<span class="lineNum">     257 </span>                :<span class="lineCov">      21548 :             zio_checksum_table[ddt-&gt;ddt_checksum].ci_name,</span>
<span class="lineNum">     258 </span>                :<span class="lineCov">      21548 :             ddt_ops[type]-&gt;ddt_op_name, ddt_class_name[class]);</span>
<span class="lineNum">     259 </span>                :<span class="lineCov">      21548 : }</span>
<a name="260"><span class="lineNum">     260 </span>                :            : </a>
<span class="lineNum">     261 </span>                :            : void
<span class="lineNum">     262 </span>                :<span class="lineCov">      45002 : ddt_bp_fill(const ddt_phys_t *ddp, blkptr_t *bp, uint64_t txg)</span>
<span class="lineNum">     263 </span>                :            : {
<span class="lineNum">     264 </span>                :            :         int d;
<span class="lineNum">     265 </span>        [<span class="branchCov" title="Branch 0 was taken 45002 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      45002 :         ASSERT(txg != 0);</span>
<span class="lineNum">     266 </span>                :            : 
<span class="lineNum">     267 </span>        [<span class="branchCov" title="Branch 0 was taken 135006 times"> + </span><span class="branchCov" title="Branch 1 was taken 45002 times"> + </span>]:<span class="lineCov">     180008 :         for (d = 0; d &lt; SPA_DVAS_PER_BP; d++)</span>
<span class="lineNum">     268 </span>                :<span class="lineCov">     135006 :                 bp-&gt;blk_dva[d] = ddp-&gt;ddp_dva[d];</span>
<span class="lineNum">     269 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 45002 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 839 times"> + </span><span class="branchCov" title="Branch 4 was taken 44163 times"> + </span>]:<span class="lineCov">      45002 :         BP_SET_BIRTH(bp, txg, ddp-&gt;ddp_phys_birth);</span>
<span class="lineNum">     270 </span>                :<span class="lineCov">      45002 : }</span>
<span class="lineNum">     271 </span>                :            : 
<span class="lineNum">     272 </span>                :            : /*
<span class="lineNum">     273 </span>                :            :  * The bp created via this function may be used for repairs and scrub, but it
<span class="lineNum">     274 </span>                :            :  * will be missing the salt / IV required to do a full decrypting read.
<a name="275"><span class="lineNum">     275 </span>                :            :  */</a>
<span class="lineNum">     276 </span>                :            : void
<span class="lineNum">     277 </span>                :<span class="lineCov">      29047 : ddt_bp_create(enum zio_checksum checksum,</span>
<span class="lineNum">     278 </span>                :            :     const ddt_key_t *ddk, const ddt_phys_t *ddp, blkptr_t *bp)
<span class="lineNum">     279 </span>                :            : {
<span class="lineNum">     280 </span>                :<span class="lineCov">      29047 :         BP_ZERO(bp);</span>
<span class="lineNum">     281 </span>                :            : 
<span class="lineNum">     282 </span>        [<span class="branchCov" title="Branch 0 was taken 29046 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">      29047 :         if (ddp != NULL)</span>
<span class="lineNum">     283 </span>                :<span class="lineCov">      29046 :                 ddt_bp_fill(ddp, bp, ddp-&gt;ddp_phys_birth);</span>
<span class="lineNum">     284 </span>                :            : 
<span class="lineNum">     285 </span>                :<span class="lineCov">      29047 :         bp-&gt;blk_cksum = ddk-&gt;ddk_cksum;</span>
<span class="lineNum">     286 </span>                :            : 
<span class="lineNum">     287 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 29047 times"> + </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 29047 times"> + </span>]:<span class="lineCov">      29047 :         BP_SET_LSIZE(bp, DDK_GET_LSIZE(ddk));</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchCov" title="Branch 7 was taken 29047 times"> + </span>]
<span class="lineNum">     288 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 29047 times"> + </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 29047 times"> + </span>]:<span class="lineCov">      29047 :         BP_SET_PSIZE(bp, DDK_GET_PSIZE(ddk));</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchCov" title="Branch 7 was taken 29047 times"> + </span>]
<span class="lineNum">     289 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 29047 times"> + </span>]:<span class="lineCov">      29047 :         BP_SET_COMPRESS(bp, DDK_GET_COMPRESS(ddk));</span>
<span class="lineNum">     290 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 29047 times"> + </span>]:<span class="lineCov">      29047 :         BP_SET_CRYPT(bp, DDK_GET_CRYPT(ddk));</span>
<span class="lineNum">     291 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 29047 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">      29047 :         BP_SET_FILL(bp, 1);</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">     292 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 29047 times"> + </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 29047 times"> + </span>]:<span class="lineCov">      29047 :         BP_SET_CHECKSUM(bp, checksum);</span>
<span class="lineNum">     293 </span>                :<span class="lineCov">      29047 :         BP_SET_TYPE(bp, DMU_OT_DEDUP);</span>
<span class="lineNum">     294 </span>                :<span class="lineCov">      29047 :         BP_SET_LEVEL(bp, 0);</span>
<span class="lineNum">     295 </span>                :<span class="lineCov">      29047 :         BP_SET_DEDUP(bp, 0);</span>
<span class="lineNum">     296 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 29047 times"> + </span>]:<span class="lineCov">      29047 :         BP_SET_BYTEORDER(bp, ZFS_HOST_BYTEORDER);</span>
<span class="lineNum">     297 </span>                :<span class="lineCov">      29047 : }</span>
<a name="298"><span class="lineNum">     298 </span>                :            : </a>
<span class="lineNum">     299 </span>                :            : void
<span class="lineNum">     300 </span>                :<span class="lineCov">     101614 : ddt_key_fill(ddt_key_t *ddk, const blkptr_t *bp)</span>
<span class="lineNum">     301 </span>                :            : {
<span class="lineNum">     302 </span>                :<span class="lineCov">     101614 :         ddk-&gt;ddk_cksum = bp-&gt;blk_cksum;</span>
<span class="lineNum">     303 </span>                :<span class="lineCov">     101614 :         ddk-&gt;ddk_prop = 0;</span>
<span class="lineNum">     304 </span>                :            : 
<span class="lineNum">     305 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 101614 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     101614 :         ASSERT(BP_IS_ENCRYPTED(bp) || !BP_USES_CRYPT(bp));</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>][<span class="branchNoCov" title="Branch 10 was not taken"> - </span><span class="branchCov" title="Branch 11 was taken 101614 times"> + </span>]
<span class="lineNum">     306 </span>                :            : 
<span class="lineNum">     307 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 101614 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     101614 :         DDK_SET_LSIZE(ddk, BP_GET_LSIZE(bp));</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoCov" title="Branch 7 was not taken"> - </span><span class="branchCov" title="Branch 8 was taken 101614 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 9 was not executed"> # </span><span class="branchNoExec" title="Branch 10 was not executed"> # </span>][<span class="branchNoCov" title="Branch 11 was not taken"> - </span><span class="branchCov" title="Branch 12 was taken 101614 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchNoCov" title="Branch 14 was not taken"> - </span><span class="branchCov" title="Branch 15 was taken 101614 times"> + </span>][<span class="branchNoExec" title="Branch 16 was not executed"> # </span><span class="branchNoExec" title="Branch 17 was not executed"> # </span>]
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 18 was not taken"> - </span><span class="branchCov" title="Branch 19 was taken 101614 times"> + </span>]
<span class="lineNum">     308 </span>[<span class="branchCov" title="Branch 0 was taken 101614 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 101614 times"> + </span>]:<span class="lineCov">     101614 :         DDK_SET_PSIZE(ddk, BP_GET_PSIZE(bp));</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 5 was taken 101614 times"> + </span><span class="branchNoCov" title="Branch 6 was not taken"> - </span>][<span class="branchNoCov" title="Branch 7 was not taken"> - </span><span class="branchCov" title="Branch 8 was taken 101614 times"> + </span>]
<span class="lineNum">     309 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 101614 times"> + </span>]:<span class="lineCov">     101614 :         DDK_SET_COMPRESS(ddk, BP_GET_COMPRESS(bp));</span>
<span class="lineNum">     310 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 101614 times"> + </span>]:<span class="lineCov">     101614 :         DDK_SET_CRYPT(ddk, BP_USES_CRYPT(bp));</span>
<span class="lineNum">     311 </span>                :<span class="lineCov">     101614 : }</span>
<a name="312"><span class="lineNum">     312 </span>                :            : </a>
<span class="lineNum">     313 </span>                :            : void
<span class="lineNum">     314 </span>                :<span class="lineCov">       5262 : ddt_phys_fill(ddt_phys_t *ddp, const blkptr_t *bp)</span>
<span class="lineNum">     315 </span>                :            : {
<span class="lineNum">     316 </span>                :            :         int d;
<span class="lineNum">     317 </span>        [<span class="branchCov" title="Branch 0 was taken 5262 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       5262 :         ASSERT(ddp-&gt;ddp_phys_birth == 0);</span>
<span class="lineNum">     318 </span>                :            : 
<span class="lineNum">     319 </span>        [<span class="branchCov" title="Branch 0 was taken 15786 times"> + </span><span class="branchCov" title="Branch 1 was taken 5262 times"> + </span>]:<span class="lineCov">      21048 :         for (d = 0; d &lt; SPA_DVAS_PER_BP; d++)</span>
<span class="lineNum">     320 </span>                :<span class="lineCov">      15786 :                 ddp-&gt;ddp_dva[d] = bp-&gt;blk_dva[d];</span>
<span class="lineNum">     321 </span>[<span class="branchCov" title="Branch 0 was taken 5262 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 5262 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       5262 :         ddp-&gt;ddp_phys_birth = BP_PHYSICAL_BIRTH(bp);</span>
<span class="lineNum">     322 </span>                :<span class="lineCov">       5262 : }</span>
<a name="323"><span class="lineNum">     323 </span>                :            : </a>
<span class="lineNum">     324 </span>                :            : void
<span class="lineNum">     325 </span>                :<span class="lineCov">      28639 : ddt_phys_clear(ddt_phys_t *ddp)</span>
<span class="lineNum">     326 </span>                :            : {
<span class="lineNum">     327 </span>                :<span class="lineCov">      28639 :         bzero(ddp, sizeof (*ddp));</span>
<span class="lineNum">     328 </span>                :<span class="lineCov">      28639 : }</span>
<a name="329"><span class="lineNum">     329 </span>                :            : </a>
<span class="lineNum">     330 </span>                :            : void
<span class="lineNum">     331 </span>                :<span class="lineCov">      15942 : ddt_phys_addref(ddt_phys_t *ddp)</span>
<span class="lineNum">     332 </span>                :            : {
<span class="lineNum">     333 </span>                :<span class="lineCov">      15942 :         ddp-&gt;ddp_refcnt++;</span>
<span class="lineNum">     334 </span>                :<span class="lineCov">      15942 : }</span>
<a name="335"><span class="lineNum">     335 </span>                :            : </a>
<span class="lineNum">     336 </span>                :            : void
<span class="lineNum">     337 </span>                :<span class="lineCov">      28888 : ddt_phys_decref(ddt_phys_t *ddp)</span>
<span class="lineNum">     338 </span>                :            : {
<span class="lineNum">     339 </span>        [<span class="branchCov" title="Branch 0 was taken 28888 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      28888 :         if (ddp) {</span>
<span class="lineNum">     340 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 28888 times"> + </span>]:<span class="lineCov">      28888 :                 ASSERT(ddp-&gt;ddp_refcnt &gt; 0);</span>
<span class="lineNum">     341 </span>                :<span class="lineCov">      28888 :                 ddp-&gt;ddp_refcnt--;</span>
<span class="lineNum">     342 </span>                :            :         }
<span class="lineNum">     343 </span>                :<span class="lineCov">      28888 : }</span>
<a name="344"><span class="lineNum">     344 </span>                :            : </a>
<span class="lineNum">     345 </span>                :            : void
<span class="lineNum">     346 </span>                :<span class="lineCov">       2929 : ddt_phys_free(ddt_t *ddt, ddt_key_t *ddk, ddt_phys_t *ddp, uint64_t txg)</span>
<span class="lineNum">     347 </span>                :            : {
<span class="lineNum">     348 </span>                :            :         blkptr_t blk;
<span class="lineNum">     349 </span>                :            : 
<span class="lineNum">     350 </span>                :<span class="lineCov">       2929 :         ddt_bp_create(ddt-&gt;ddt_checksum, ddk, ddp, &amp;blk);</span>
<span class="lineNum">     351 </span>                :<span class="lineCov">       2929 :         ddt_phys_clear(ddp);</span>
<span class="lineNum">     352 </span>                :<span class="lineCov">       2929 :         zio_free(ddt-&gt;ddt_spa, txg, &amp;blk);</span>
<span class="lineNum">     353 </span>                :<span class="lineCov">       2929 : }</span>
<a name="354"><span class="lineNum">     354 </span>                :            : </a>
<span class="lineNum">     355 </span>                :            : ddt_phys_t *
<span class="lineNum">     356 </span>                :<span class="lineCov">      80304 : ddt_phys_select(const ddt_entry_t *dde, const blkptr_t *bp)</span>
<span class="lineNum">     357 </span>                :            : {
<span class="lineNum">     358 </span>                :<span class="lineCov">      80304 :         ddt_phys_t *ddp = (ddt_phys_t *)dde-&gt;dde_phys;</span>
<span class="lineNum">     359 </span>                :            :         int p;
<span class="lineNum">     360 </span>                :            : 
<span class="lineNum">     361 </span>        [<span class="branchCov" title="Branch 0 was taken 136288 times"> + </span><span class="branchCov" title="Branch 1 was taken 101 times"> + </span>]:<span class="lineCov">     136389 :         for (p = 0; p &lt; DDT_PHYS_TYPES; p++, ddp++) {</span>
<span class="lineNum">     362 </span>   [<span class="branchCov" title="Branch 1 was taken 136315 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 80237 times"> + </span><span class="branchCov" title="Branch 4 was taken 56078 times"> + </span>]:<span class="lineCov">     216522 :                 if (DVA_EQUAL(BP_IDENTITY(bp), &amp;ddp-&gt;ddp_dva[0]) &amp;&amp;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 5 was taken 80234 times"> + </span><span class="branchCov" title="Branch 6 was taken 3 times"> + </span>][<span class="branchCov" title="Branch 7 was taken 4 times"> + </span><span class="branchCov" title="Branch 8 was taken 80230 times"> + </span>]
<span class="lineNum">     363 </span>        [<span class="branchCov" title="Branch 0 was taken 76981 times"> + </span><span class="branchCov" title="Branch 1 was taken 3253 times"> + </span>]:<span class="lineCov">      80234 :                     BP_PHYSICAL_BIRTH(bp) == ddp-&gt;ddp_phys_birth)</span>
<span class="lineNum">     364 </span>                :            :                         return (ddp);
<span class="lineNum">     365 </span>                :            :         }
<span class="lineNum">     366 </span>                :            :         return (NULL);
<span class="lineNum">     367 </span>                :            : }
<a name="368"><span class="lineNum">     368 </span>                :            : </a>
<span class="lineNum">     369 </span>                :            : uint64_t
<span class="lineNum">     370 </span>                :<span class="lineCov">      26077 : ddt_phys_total_refcnt(const ddt_entry_t *dde)</span>
<span class="lineNum">     371 </span>                :            : {
<span class="lineNum">     372 </span>                :<span class="lineCov">      26077 :         uint64_t refcnt = 0;</span>
<span class="lineNum">     373 </span>                :            :         int p;
<span class="lineNum">     374 </span>                :            : 
<span class="lineNum">     375 </span>        [<span class="branchCov" title="Branch 0 was taken 78231 times"> + </span><span class="branchCov" title="Branch 1 was taken 26077 times"> + </span>]:<span class="lineCov">     104308 :         for (p = DDT_PHYS_SINGLE; p &lt;= DDT_PHYS_TRIPLE; p++)</span>
<span class="lineNum">     376 </span>                :<span class="lineCov">      78231 :                 refcnt += dde-&gt;dde_phys[p].ddp_refcnt;</span>
<span class="lineNum">     377 </span>                :            : 
<span class="lineNum">     378 </span>                :<span class="lineCov">      26077 :         return (refcnt);</span>
<span class="lineNum">     379 </span>                :            : }
<a name="380"><span class="lineNum">     380 </span>                :            : </a>
<span class="lineNum">     381 </span>                :            : static void
<span class="lineNum">     382 </span>                :<span class="lineCov">       8415 : ddt_stat_generate(ddt_t *ddt, ddt_entry_t *dde, ddt_stat_t *dds)</span>
<span class="lineNum">     383 </span>                :            : {
<span class="lineNum">     384 </span>                :<span class="lineCov">       8415 :         spa_t *spa = ddt-&gt;ddt_spa;</span>
<span class="lineNum">     385 </span>                :<span class="lineCov">       8415 :         ddt_phys_t *ddp = dde-&gt;dde_phys;</span>
<span class="lineNum">     386 </span>                :<span class="lineCov">       8415 :         ddt_key_t *ddk = &amp;dde-&gt;dde_key;</span>
<span class="lineNum">     387 </span>                :<span class="lineCov">       8415 :         uint64_t lsize = DDK_GET_LSIZE(ddk);</span>
<span class="lineNum">     388 </span>                :<span class="lineCov">       8415 :         uint64_t psize = DDK_GET_PSIZE(ddk);</span>
<span class="lineNum">     389 </span>                :            :         int p, d;
<span class="lineNum">     390 </span>                :            : 
<span class="lineNum">     391 </span>                :<span class="lineCov">       8415 :         bzero(dds, sizeof (*dds));</span>
<span class="lineNum">     392 </span>                :            : 
<span class="lineNum">     393 </span>        [<span class="branchCov" title="Branch 0 was taken 33659 times"> + </span><span class="branchCov" title="Branch 1 was taken 8415 times"> + </span>]:<span class="lineCov">      42074 :         for (p = 0; p &lt; DDT_PHYS_TYPES; p++, ddp++) {</span>
<span class="lineNum">     394 </span>                :<span class="lineCov">      33659 :                 uint64_t dsize = 0;</span>
<span class="lineNum">     395 </span>                :<span class="lineCov">      33659 :                 uint64_t refcnt = ddp-&gt;ddp_refcnt;</span>
<span class="lineNum">     396 </span>                :            : 
<span class="lineNum">     397 </span>        [<span class="branchCov" title="Branch 0 was taken 8599 times"> + </span><span class="branchCov" title="Branch 1 was taken 25060 times"> + </span>]:<span class="lineCov">      33659 :                 if (ddp-&gt;ddp_phys_birth == 0)</span>
<span class="lineNum">     398 </span>                :<span class="lineCov">      25060 :                         continue;</span>
<span class="lineNum">     399 </span>                :            : 
<span class="lineNum">     400 </span>[<span class="branchCov" title="Branch 0 was taken 25796 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>][<span class="branchCov" title="Branch 2 was taken 17198 times"> + </span><span class="branchCov" title="Branch 3 was taken 8599 times"> + </span>]:<span class="lineCov">      25797 :                 for (d = 0; d &lt; DDE_GET_NDVAS(dde); d++)</span>
<span class="lineNum">     401 </span>                :<span class="lineCov">      17198 :                         dsize += dva_get_dsize_sync(spa, &amp;ddp-&gt;ddp_dva[d]);</span>
<span class="lineNum">     402 </span>                :            : 
<span class="lineNum">     403 </span>                :<span class="lineCov">       8599 :                 dds-&gt;dds_blocks += 1;</span>
<span class="lineNum">     404 </span>                :<span class="lineCov">       8599 :                 dds-&gt;dds_lsize += lsize;</span>
<span class="lineNum">     405 </span>                :<span class="lineCov">       8599 :                 dds-&gt;dds_psize += psize;</span>
<span class="lineNum">     406 </span>                :<span class="lineCov">       8599 :                 dds-&gt;dds_dsize += dsize;</span>
<span class="lineNum">     407 </span>                :            : 
<span class="lineNum">     408 </span>                :<span class="lineCov">       8599 :                 dds-&gt;dds_ref_blocks += refcnt;</span>
<span class="lineNum">     409 </span>                :<span class="lineCov">       8599 :                 dds-&gt;dds_ref_lsize += lsize * refcnt;</span>
<span class="lineNum">     410 </span>                :<span class="lineCov">       8599 :                 dds-&gt;dds_ref_psize += psize * refcnt;</span>
<span class="lineNum">     411 </span>                :<span class="lineCov">       8599 :                 dds-&gt;dds_ref_dsize += dsize * refcnt;</span>
<span class="lineNum">     412 </span>                :            :         }
<span class="lineNum">     413 </span>                :<span class="lineCov">       8415 : }</span>
<a name="414"><span class="lineNum">     414 </span>                :            : </a>
<span class="lineNum">     415 </span>                :            : void
<span class="lineNum">     416 </span>                :<span class="lineCov">   11314399 : ddt_stat_add(ddt_stat_t *dst, const ddt_stat_t *src, uint64_t neg)</span>
<span class="lineNum">     417 </span>                :            : {
<span class="lineNum">     418 </span>                :<span class="lineCov">   11314399 :         const uint64_t *s = (const uint64_t *)src;</span>
<span class="lineNum">     419 </span>                :<span class="lineCov">   11314399 :         uint64_t *d = (uint64_t *)dst;</span>
<span class="lineNum">     420 </span>                :<span class="lineCov">   11314399 :         uint64_t *d_end = (uint64_t *)(dst + 1);</span>
<span class="lineNum">     421 </span>                :            : 
<span class="lineNum">     422 </span>        [<span class="branchCov" title="Branch 0 was taken 11314399 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">   11314399 :         ASSERT(neg == 0 || neg == -1ULL);       /* add or subtract */</span>
<span class="lineNum">     423 </span>                :            : 
<span class="lineNum">     424 </span>        [<span class="branchCov" title="Branch 0 was taken 90515192 times"> + </span><span class="branchCov" title="Branch 1 was taken 11314399 times"> + </span>]:<span class="lineCov">  101829591 :         while (d &lt; d_end)</span>
<span class="lineNum">     425 </span>                :<span class="lineCov">   90515192 :                 *d++ += (*s++ ^ neg) - neg;</span>
<span class="lineNum">     426 </span>                :<span class="lineCov">   11314399 : }</span>
<a name="427"><span class="lineNum">     427 </span>                :            : </a>
<span class="lineNum">     428 </span>                :            : static void
<span class="lineNum">     429 </span>                :<span class="lineCov">       8415 : ddt_stat_update(ddt_t *ddt, ddt_entry_t *dde, uint64_t neg)</span>
<span class="lineNum">     430 </span>                :            : {
<span class="lineNum">     431 </span>                :            :         ddt_stat_t dds;
<span class="lineNum">     432 </span>                :            :         ddt_histogram_t *ddh;
<span class="lineNum">     433 </span>                :            :         int bucket;
<span class="lineNum">     434 </span>                :            : 
<span class="lineNum">     435 </span>                :<span class="lineCov">       8415 :         ddt_stat_generate(ddt, dde, &amp;dds);</span>
<span class="lineNum">     436 </span>                :            : 
<span class="lineNum">     437 </span>                :<span class="lineCov">       8415 :         bucket = highbit64(dds.dds_ref_blocks) - 1;</span>
<span class="lineNum">     438 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 8415 times"> + </span>]:<span class="lineCov">       8415 :         ASSERT(bucket &gt;= 0);</span>
<span class="lineNum">     439 </span>                :            : 
<span class="lineNum">     440 </span>                :<span class="lineCov">       8415 :         ddh = &amp;ddt-&gt;ddt_histogram[dde-&gt;dde_type][dde-&gt;dde_class];</span>
<span class="lineNum">     441 </span>                :            : 
<span class="lineNum">     442 </span>                :<span class="lineCov">       8415 :         ddt_stat_add(&amp;ddh-&gt;ddh_stat[bucket], &amp;dds, neg);</span>
<span class="lineNum">     443 </span>                :<span class="lineCov">       8415 : }</span>
<a name="444"><span class="lineNum">     444 </span>                :            : </a>
<span class="lineNum">     445 </span>                :            : void
<span class="lineNum">     446 </span>                :<span class="lineCov">     172872 : ddt_histogram_add(ddt_histogram_t *dst, const ddt_histogram_t *src)</span>
<span class="lineNum">     447 </span>                :            : {
<span class="lineNum">     448 </span>                :            :         int h;
<span class="lineNum">     449 </span>                :            : 
<span class="lineNum">     450 </span>        [<span class="branchCov" title="Branch 0 was taken 11063808 times"> + </span><span class="branchCov" title="Branch 1 was taken 172872 times"> + </span>]:<span class="lineCov">   11236680 :         for (h = 0; h &lt; 64; h++)</span>
<span class="lineNum">     451 </span>                :<span class="lineCov">   11063808 :                 ddt_stat_add(&amp;dst-&gt;ddh_stat[h], &amp;src-&gt;ddh_stat[h], 0);</span>
<span class="lineNum">     452 </span>                :<span class="lineCov">     172872 : }</span>
<a name="453"><span class="lineNum">     453 </span>                :            : </a>
<span class="lineNum">     454 </span>                :            : void
<span class="lineNum">     455 </span>                :<span class="lineCov">       3784 : ddt_histogram_stat(ddt_stat_t *dds, const ddt_histogram_t *ddh)</span>
<span class="lineNum">     456 </span>                :            : {
<span class="lineNum">     457 </span>                :            :         int h;
<span class="lineNum">     458 </span>                :            : 
<span class="lineNum">     459 </span>                :<span class="lineCov">       3784 :         bzero(dds, sizeof (*dds));</span>
<span class="lineNum">     460 </span>                :            : 
<span class="lineNum">     461 </span>        [<span class="branchCov" title="Branch 0 was taken 242176 times"> + </span><span class="branchCov" title="Branch 1 was taken 3784 times"> + </span>]:<span class="lineCov">     245960 :         for (h = 0; h &lt; 64; h++)</span>
<span class="lineNum">     462 </span>                :<span class="lineCov">     242176 :                 ddt_stat_add(dds, &amp;ddh-&gt;ddh_stat[h], 0);</span>
<span class="lineNum">     463 </span>                :<span class="lineCov">       3784 : }</span>
<a name="464"><span class="lineNum">     464 </span>                :            : </a>
<span class="lineNum">     465 </span>                :            : boolean_t
<span class="lineNum">     466 </span>                :<span class="lineCov">          5 : ddt_histogram_empty(const ddt_histogram_t *ddh)</span>
<span class="lineNum">     467 </span>                :            : {
<span class="lineNum">     468 </span>                :<span class="lineCov">          5 :         const uint64_t *s = (const uint64_t *)ddh;</span>
<span class="lineNum">     469 </span>                :<span class="lineCov">          5 :         const uint64_t *s_end = (const uint64_t *)(ddh + 1);</span>
<span class="lineNum">     470 </span>                :            : 
<span class="lineNum">     471 </span>        [<span class="branchCov" title="Branch 0 was taken 2560 times"> + </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">       2565 :         while (s &lt; s_end)</span>
<span class="lineNum">     472 </span>        [<span class="branchCov" title="Branch 0 was taken 2560 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2560 :                 if (*s++ != 0)</span>
<span class="lineNum">     473 </span>                :            :                         return (B_FALSE);
<span class="lineNum">     474 </span>                :            : 
<span class="lineNum">     475 </span>                :            :         return (B_TRUE);
<span class="lineNum">     476 </span>                :            : }
<a name="477"><span class="lineNum">     477 </span>                :            : </a>
<span class="lineNum">     478 </span>                :            : void
<span class="lineNum">     479 </span>                :<span class="lineCov">        293 : ddt_get_dedup_object_stats(spa_t *spa, ddt_object_t *ddo_total)</span>
<span class="lineNum">     480 </span>                :            : {
<span class="lineNum">     481 </span>                :            :         enum zio_checksum c;
<span class="lineNum">     482 </span>                :            :         enum ddt_type type;
<span class="lineNum">     483 </span>                :            :         enum ddt_class class;
<span class="lineNum">     484 </span>                :            : 
<span class="lineNum">     485 </span>                :            :         /* Sum the statistics we cached in ddt_object_sync(). */
<span class="lineNum">     486 </span>        [<span class="branchCov" title="Branch 0 was taken 4102 times"> + </span><span class="branchCov" title="Branch 1 was taken 293 times"> + </span>]:<span class="lineCov">       4395 :         for (c = 0; c &lt; ZIO_CHECKSUM_FUNCTIONS; c++) {</span>
<span class="lineNum">     487 </span>                :<span class="lineCov">       4102 :                 ddt_t *ddt = spa-&gt;spa_ddt[c];</span>
<span class="lineNum">     488 </span>        [<span class="branchCov" title="Branch 0 was taken 4102 times"> + </span><span class="branchCov" title="Branch 1 was taken 4102 times"> + </span>]:<span class="lineCov">       8204 :                 for (type = 0; type &lt; DDT_TYPES; type++) {</span>
<span class="lineNum">     489 </span>        [<span class="branchCov" title="Branch 0 was taken 12306 times"> + </span><span class="branchCov" title="Branch 1 was taken 4102 times"> + </span>]:<span class="lineCov">      16408 :                         for (class = 0; class &lt; DDT_CLASSES;</span>
<span class="lineNum">     490 </span>                :<span class="lineCov">      12306 :                             class++) {</span>
<span class="lineNum">     491 </span>                :<span class="lineCov">      12306 :                                 ddt_object_t *ddo =</span>
<span class="lineNum">     492 </span>                :            :                                     &amp;ddt-&gt;ddt_object_stats[type][class];
<span class="lineNum">     493 </span>                :<span class="lineCov">      12306 :                                 ddo_total-&gt;ddo_count += ddo-&gt;ddo_count;</span>
<span class="lineNum">     494 </span>                :<span class="lineCov">      12306 :                                 ddo_total-&gt;ddo_dspace += ddo-&gt;ddo_dspace;</span>
<span class="lineNum">     495 </span>                :<span class="lineCov">      12306 :                                 ddo_total-&gt;ddo_mspace += ddo-&gt;ddo_mspace;</span>
<span class="lineNum">     496 </span>                :            :                         }
<span class="lineNum">     497 </span>                :            :                 }
<span class="lineNum">     498 </span>                :            :         }
<span class="lineNum">     499 </span>                :            : 
<span class="lineNum">     500 </span>                :            :         /* ... and compute the averages. */
<span class="lineNum">     501 </span>        [<span class="branchCov" title="Branch 0 was taken 171 times"> + </span><span class="branchCov" title="Branch 1 was taken 122 times"> + </span>]:<span class="lineCov">        293 :         if (ddo_total-&gt;ddo_count != 0) {</span>
<span class="lineNum">     502 </span>                :<span class="lineCov">        171 :                 ddo_total-&gt;ddo_dspace /= ddo_total-&gt;ddo_count;</span>
<span class="lineNum">     503 </span>                :<span class="lineCov">        171 :                 ddo_total-&gt;ddo_mspace /= ddo_total-&gt;ddo_count;</span>
<span class="lineNum">     504 </span>                :            :         }
<span class="lineNum">     505 </span>                :<span class="lineCov">        293 : }</span>
<a name="506"><span class="lineNum">     506 </span>                :            : </a>
<span class="lineNum">     507 </span>                :            : void
<span class="lineNum">     508 </span>                :<span class="lineCov">       4116 : ddt_get_dedup_histogram(spa_t *spa, ddt_histogram_t *ddh)</span>
<span class="lineNum">     509 </span>                :            : {
<span class="lineNum">     510 </span>                :            :         enum zio_checksum c;
<span class="lineNum">     511 </span>                :            :         enum ddt_type type;
<span class="lineNum">     512 </span>                :            :         enum ddt_class class;
<span class="lineNum">     513 </span>                :            : 
<span class="lineNum">     514 </span>        [<span class="branchCov" title="Branch 0 was taken 57624 times"> + </span><span class="branchCov" title="Branch 1 was taken 4116 times"> + </span>]:<span class="lineCov">      61740 :         for (c = 0; c &lt; ZIO_CHECKSUM_FUNCTIONS; c++) {</span>
<span class="lineNum">     515 </span>                :<span class="lineCov">      57624 :                 ddt_t *ddt = spa-&gt;spa_ddt[c];</span>
<span class="lineNum">     516 </span>        [<span class="branchCov" title="Branch 0 was taken 57624 times"> + </span><span class="branchCov" title="Branch 1 was taken 57624 times"> + </span>]:<span class="lineCov">     115248 :                 for (type = 0; type &lt; DDT_TYPES; type++) {</span>
<span class="lineNum">     517 </span>        [<span class="branchCov" title="Branch 0 was taken 172872 times"> + </span><span class="branchCov" title="Branch 1 was taken 57624 times"> + </span>]:<span class="lineCov">     230496 :                         for (class = 0; class &lt; DDT_CLASSES;</span>
<span class="lineNum">     518 </span>                :<span class="lineCov">     172872 :                             class++) {</span>
<span class="lineNum">     519 </span>                :<span class="lineCov">     172872 :                                 ddt_histogram_add(ddh,</span>
<span class="lineNum">     520 </span>                :<span class="lineCov">     172872 :                                     &amp;ddt-&gt;ddt_histogram_cache[type][class]);</span>
<span class="lineNum">     521 </span>                :            :                         }
<span class="lineNum">     522 </span>                :            :                 }
<span class="lineNum">     523 </span>                :            :         }
<span class="lineNum">     524 </span>                :<span class="lineCov">       4116 : }</span>
<a name="525"><span class="lineNum">     525 </span>                :            : </a>
<span class="lineNum">     526 </span>                :            : void
<span class="lineNum">     527 </span>                :<span class="lineCov">       3784 : ddt_get_dedup_stats(spa_t *spa, ddt_stat_t *dds_total)</span>
<span class="lineNum">     528 </span>                :            : {
<span class="lineNum">     529 </span>                :            :         ddt_histogram_t *ddh_total;
<span class="lineNum">     530 </span>                :            : 
<span class="lineNum">     531 </span>                :<span class="lineCov">       3784 :         ddh_total = kmem_zalloc(sizeof (ddt_histogram_t), KM_SLEEP);</span>
<span class="lineNum">     532 </span>                :<span class="lineCov">       3784 :         ddt_get_dedup_histogram(spa, ddh_total);</span>
<span class="lineNum">     533 </span>                :<span class="lineCov">       3784 :         ddt_histogram_stat(dds_total, ddh_total);</span>
<span class="lineNum">     534 </span>                :<span class="lineCov">       3784 :         kmem_free(ddh_total, sizeof (ddt_histogram_t));</span>
<span class="lineNum">     535 </span>                :<span class="lineCov">       3784 : }</span>
<a name="536"><span class="lineNum">     536 </span>                :            : </a>
<span class="lineNum">     537 </span>                :            : uint64_t
<span class="lineNum">     538 </span>                :<span class="lineCov">      24645 : ddt_get_dedup_dspace(spa_t *spa)</span>
<span class="lineNum">     539 </span>                :            : {
<span class="lineNum">     540 </span>                :            :         ddt_stat_t dds_total;
<span class="lineNum">     541 </span>                :            : 
<span class="lineNum">     542 </span>        [<span class="branchCov" title="Branch 0 was taken 3387 times"> + </span><span class="branchCov" title="Branch 1 was taken 21258 times"> + </span>]:<span class="lineCov">      24645 :         if (spa-&gt;spa_dedup_dspace != ~0ULL)</span>
<span class="lineNum">     543 </span>                :            :                 return (spa-&gt;spa_dedup_dspace);
<span class="lineNum">     544 </span>                :            : 
<span class="lineNum">     545 </span>                :<span class="lineCov">       3387 :         bzero(&amp;dds_total, sizeof (ddt_stat_t));</span>
<span class="lineNum">     546 </span>                :            : 
<span class="lineNum">     547 </span>                :            :         /* Calculate and cache the stats */
<span class="lineNum">     548 </span>                :<span class="lineCov">       3387 :         ddt_get_dedup_stats(spa, &amp;dds_total);</span>
<span class="lineNum">     549 </span>                :<span class="lineCov">       3387 :         spa-&gt;spa_dedup_dspace = dds_total.dds_ref_dsize - dds_total.dds_dsize;</span>
<span class="lineNum">     550 </span>                :<span class="lineCov">       3387 :         return (spa-&gt;spa_dedup_dspace);</span>
<span class="lineNum">     551 </span>                :            : }
<a name="552"><span class="lineNum">     552 </span>                :            : </a>
<span class="lineNum">     553 </span>                :            : uint64_t
<span class="lineNum">     554 </span>                :<span class="lineCov">         55 : ddt_get_pool_dedup_ratio(spa_t *spa)</span>
<span class="lineNum">     555 </span>                :            : {
<span class="lineNum">     556 </span>                :<span class="lineCov">         55 :         ddt_stat_t dds_total = { 0 };</span>
<span class="lineNum">     557 </span>                :            : 
<span class="lineNum">     558 </span>                :<span class="lineCov">         55 :         ddt_get_dedup_stats(spa, &amp;dds_total);</span>
<span class="lineNum">     559 </span>        [<span class="branchCov" title="Branch 0 was taken 50 times"> + </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">         55 :         if (dds_total.dds_dsize == 0)</span>
<span class="lineNum">     560 </span>                :            :                 return (100);
<span class="lineNum">     561 </span>                :            : 
<span class="lineNum">     562 </span>                :<span class="lineCov">         50 :         return (dds_total.dds_ref_dsize * 100 / dds_total.dds_dsize);</span>
<span class="lineNum">     563 </span>                :            : }
<a name="564"><span class="lineNum">     564 </span>                :            : </a>
<span class="lineNum">     565 </span>                :            : int
<span class="lineNum">     566 </span>                :<span class="lineCov">      15995 : ddt_ditto_copies_needed(ddt_t *ddt, ddt_entry_t *dde, ddt_phys_t *ddp_willref)</span>
<span class="lineNum">     567 </span>                :            : {
<span class="lineNum">     568 </span>                :<span class="lineCov">      15995 :         spa_t *spa = ddt-&gt;ddt_spa;</span>
<span class="lineNum">     569 </span>                :<span class="lineCov">      15995 :         uint64_t total_refcnt = 0;</span>
<span class="lineNum">     570 </span>                :<span class="lineCov">      15995 :         uint64_t ditto = spa-&gt;spa_dedup_ditto;</span>
<span class="lineNum">     571 </span>                :<span class="lineCov">      15995 :         int total_copies = 0;</span>
<span class="lineNum">     572 </span>                :<span class="lineCov">      15995 :         int desired_copies = 0;</span>
<span class="lineNum">     573 </span>                :<span class="lineCov">      15995 :         int copies_needed = 0;</span>
<span class="lineNum">     574 </span>                :            :         int p;
<span class="lineNum">     575 </span>                :            : 
<span class="lineNum">     576 </span>        [<span class="branchCov" title="Branch 0 was taken 47985 times"> + </span><span class="branchCov" title="Branch 1 was taken 15995 times"> + </span>]:<span class="lineCov">      63980 :         for (p = DDT_PHYS_SINGLE; p &lt;= DDT_PHYS_TRIPLE; p++) {</span>
<span class="lineNum">     577 </span>                :<span class="lineCov">      47985 :                 ddt_phys_t *ddp = &amp;dde-&gt;dde_phys[p];</span>
<span class="lineNum">     578 </span>                :<span class="lineCov">      47985 :                 zio_t *zio = dde-&gt;dde_lead_zio[p];</span>
<span class="lineNum">     579 </span>                :<span class="lineCov">      47985 :                 uint64_t refcnt = ddp-&gt;ddp_refcnt;   /* committed refs */</span>
<span class="lineNum">     580 </span>        [<span class="branchCov" title="Branch 0 was taken 4123 times"> + </span><span class="branchCov" title="Branch 1 was taken 43862 times"> + </span>]:<span class="lineCov">      47985 :                 if (zio != NULL)</span>
<span class="lineNum">     581 </span>                :<span class="lineCov">       4123 :                         refcnt += zio-&gt;io_parent_count;      /* pending refs */</span>
<span class="lineNum">     582 </span>        [<span class="branchCov" title="Branch 0 was taken 15942 times"> + </span><span class="branchCov" title="Branch 1 was taken 32043 times"> + </span>]:<span class="lineCov">      47985 :                 if (ddp == ddp_willref)</span>
<span class="lineNum">     583 </span>                :<span class="lineCov">      15942 :                         refcnt++;                       /* caller's ref */</span>
<span class="lineNum">     584 </span>        [<span class="branchCov" title="Branch 0 was taken 15999 times"> + </span><span class="branchCov" title="Branch 1 was taken 31986 times"> + </span>]:<span class="lineCov">      47985 :                 if (refcnt != 0) {</span>
<span class="lineNum">     585 </span>                :<span class="lineCov">      15999 :                         total_refcnt += refcnt;</span>
<span class="lineNum">     586 </span>                :<span class="lineCov">      15999 :                         total_copies += p;</span>
<span class="lineNum">     587 </span>                :            :                 }
<span class="lineNum">     588 </span>                :            :         }
<span class="lineNum">     589 </span>                :            : 
<span class="lineNum">     590 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 15995 times"> + </span>]:<span class="lineCov">      15995 :         if (ditto == 0 || ditto &gt; UINT32_MAX)</span>
<span class="lineNum">     591 </span>                :<span class="lineNoCov">          0 :                 ditto = UINT32_MAX;</span>
<span class="lineNum">     592 </span>                :            : 
<span class="lineNum">     593 </span>        [<span class="branchCov" title="Branch 0 was taken 15995 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      15995 :         if (total_refcnt &gt;= 1)</span>
<span class="lineNum">     594 </span>                :<span class="lineCov">      15995 :                 desired_copies++;</span>
<span class="lineNum">     595 </span>        [<span class="branchCov" title="Branch 0 was taken 2491 times"> + </span><span class="branchCov" title="Branch 1 was taken 13504 times"> + </span>]:<span class="lineCov">      15995 :         if (total_refcnt &gt;= ditto)</span>
<span class="lineNum">     596 </span>                :<span class="lineCov">       2491 :                 desired_copies++;</span>
<span class="lineNum">     597 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 15995 times"> + </span>]:<span class="lineCov">      15995 :         if (total_refcnt &gt;= ditto * ditto)</span>
<span class="lineNum">     598 </span>                :<span class="lineNoCov">          0 :                 desired_copies++;</span>
<span class="lineNum">     599 </span>                :            : 
<span class="lineNum">     600 </span>                :<span class="lineCov">      15995 :         copies_needed = MAX(desired_copies, total_copies) - total_copies;</span>
<span class="lineNum">     601 </span>                :            : 
<span class="lineNum">     602 </span>                :            :         /* encrypted blocks store their IV in DVA[2] */
<span class="lineNum">     603 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 15995 times"> + </span>]:<span class="lineCov">      15995 :         if (DDK_GET_CRYPT(&amp;dde-&gt;dde_key))</span>
<span class="lineNum">     604 </span>                :<span class="lineNoCov">          0 :                 copies_needed = MIN(copies_needed, SPA_DVAS_PER_BP - 1);</span>
<span class="lineNum">     605 </span>                :            : 
<span class="lineNum">     606 </span>                :<span class="lineCov">      15995 :         return (copies_needed);</span>
<span class="lineNum">     607 </span>                :            : }
<a name="608"><span class="lineNum">     608 </span>                :            : </a>
<span class="lineNum">     609 </span>                :            : int
<span class="lineNum">     610 </span>                :<span class="lineCov">      15942 : ddt_ditto_copies_present(ddt_entry_t *dde)</span>
<span class="lineNum">     611 </span>                :            : {
<span class="lineNum">     612 </span>                :<span class="lineCov">      15942 :         ddt_phys_t *ddp = &amp;dde-&gt;dde_phys[DDT_PHYS_DITTO];</span>
<span class="lineNum">     613 </span>                :<span class="lineCov">      15942 :         dva_t *dva = ddp-&gt;ddp_dva;</span>
<span class="lineNum">     614 </span>                :<span class="lineCov">      15942 :         int copies = 0 - DVA_GET_GANG(dva);</span>
<span class="lineNum">     615 </span>                :            :         int d;
<span class="lineNum">     616 </span>                :            : 
<span class="lineNum">     617 </span>[<span class="branchCov" title="Branch 0 was taken 47826 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 31884 times"> + </span><span class="branchCov" title="Branch 3 was taken 15942 times"> + </span>]:<span class="lineCov">      47826 :         for (d = 0; d &lt; DDE_GET_NDVAS(dde); d++, dva++)</span>
<span class="lineNum">     618 </span>        [<span class="branchCov" title="Branch 0 was taken 1532 times"> + </span><span class="branchCov" title="Branch 1 was taken 30352 times"> + </span>]:<span class="lineCov">      31884 :                 if (DVA_IS_VALID(dva))</span>
<span class="lineNum">     619 </span>                :<span class="lineCov">       1532 :                         copies++;</span>
<span class="lineNum">     620 </span>                :            : 
<span class="lineNum">     621 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 15942 times"> + </span>]:<span class="lineCov">      15942 :         ASSERT(copies &gt;= 0 &amp;&amp; copies &lt; SPA_DVAS_PER_BP);</span>
<span class="lineNum">     622 </span>                :            : 
<span class="lineNum">     623 </span>                :<span class="lineCov">      15942 :         return (copies);</span>
<span class="lineNum">     624 </span>                :            : }
<a name="625"><span class="lineNum">     625 </span>                :            : </a>
<span class="lineNum">     626 </span>                :            : size_t
<span class="lineNum">     627 </span>                :<span class="lineCov">       5274 : ddt_compress(void *src, uchar_t *dst, size_t s_len, size_t d_len)</span>
<span class="lineNum">     628 </span>                :            : {
<span class="lineNum">     629 </span>                :<span class="lineCov">       5274 :         uchar_t *version = dst++;</span>
<span class="lineNum">     630 </span>                :<span class="lineCov">       5274 :         int cpfunc = ZIO_COMPRESS_ZLE;</span>
<span class="lineNum">     631 </span>                :<span class="lineCov">       5274 :         zio_compress_info_t *ci = &amp;zio_compress_table[cpfunc];</span>
<span class="lineNum">     632 </span>                :            :         size_t c_len;
<span class="lineNum">     633 </span>                :            : 
<span class="lineNum">     634 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5274 times"> + </span>]:<span class="lineCov">       5274 :         ASSERT(d_len &gt;= s_len + 1);  /* no compression plus version byte */</span>
<span class="lineNum">     635 </span>                :            : 
<span class="lineNum">     636 </span>                :<span class="lineCov">       5274 :         c_len = ci-&gt;ci_compress(src, dst, s_len, d_len - 1, ci-&gt;ci_level);</span>
<span class="lineNum">     637 </span>                :            : 
<span class="lineNum">     638 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5274 times"> + </span>]:<span class="lineCov">       5274 :         if (c_len == s_len) {</span>
<span class="lineNum">     639 </span>                :<span class="lineNoCov">          0 :                 cpfunc = ZIO_COMPRESS_OFF;</span>
<span class="lineNum">     640 </span>                :            :                 bcopy(src, dst, s_len);
<span class="lineNum">     641 </span>                :            :         }
<span class="lineNum">     642 </span>                :            : 
<span class="lineNum">     643 </span>                :<span class="lineCov">       5274 :         *version = cpfunc;</span>
<span class="lineNum">     644 </span>                :            :         /* CONSTCOND */
<span class="lineNum">     645 </span>                :            :         if (ZFS_HOST_BYTEORDER)
<span class="lineNum">     646 </span>                :<span class="lineCov">       5274 :                 *version |= DDT_COMPRESS_BYTEORDER_MASK;</span>
<span class="lineNum">     647 </span>                :            : 
<span class="lineNum">     648 </span>                :<span class="lineCov">       5274 :         return (c_len + 1);</span>
<span class="lineNum">     649 </span>                :            : }
<a name="650"><span class="lineNum">     650 </span>                :            : </a>
<span class="lineNum">     651 </span>                :            : void
<span class="lineNum">     652 </span>                :<span class="lineCov">      45164 : ddt_decompress(uchar_t *src, void *dst, size_t s_len, size_t d_len)</span>
<span class="lineNum">     653 </span>                :            : {
<span class="lineNum">     654 </span>                :<span class="lineCov">      45164 :         uchar_t version = *src++;</span>
<span class="lineNum">     655 </span>                :<span class="lineCov">      45164 :         int cpfunc = version &amp; DDT_COMPRESS_FUNCTION_MASK;</span>
<span class="lineNum">     656 </span>                :<span class="lineCov">      45164 :         zio_compress_info_t *ci = &amp;zio_compress_table[cpfunc];</span>
<span class="lineNum">     657 </span>                :            : 
<span class="lineNum">     658 </span>        [<span class="branchCov" title="Branch 0 was taken 45164 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      45164 :         if (ci-&gt;ci_decompress != NULL)</span>
<span class="lineNum">     659 </span>                :<span class="lineCov">      45164 :                 (void) ci-&gt;ci_decompress(src, dst, s_len, d_len, ci-&gt;ci_level);</span>
<span class="lineNum">     660 </span>                :            :         else
<span class="lineNum">     661 </span>                :            :                 bcopy(src, dst, d_len);
<span class="lineNum">     662 </span>                :            : 
<span class="lineNum">     663 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 45164 times"> + </span>]:<span class="lineCov">      45164 :         if (((version &amp; DDT_COMPRESS_BYTEORDER_MASK) != 0) !=</span>
<span class="lineNum">     664 </span>                :            :             (ZFS_HOST_BYTEORDER != 0))
<span class="lineNum">     665 </span>                :<span class="lineNoCov">          0 :                 byteswap_uint64_array(dst, d_len);</span>
<span class="lineNum">     666 </span>                :<span class="lineCov">      45164 : }</span>
<a name="667"><span class="lineNum">     667 </span>                :            : </a>
<span class="lineNum">     668 </span>                :            : ddt_t *
<span class="lineNum">     669 </span>                :<span class="lineNoCov">          0 : ddt_select_by_checksum(spa_t *spa, enum zio_checksum c)</span>
<span class="lineNum">     670 </span>                :            : {
<span class="lineNum">     671 </span>                :<span class="lineNoCov">          0 :         return (spa-&gt;spa_ddt[c]);</span>
<span class="lineNum">     672 </span>                :            : }
<a name="673"><span class="lineNum">     673 </span>                :            : </a>
<span class="lineNum">     674 </span>                :            : ddt_t *
<span class="lineNum">     675 </span>                :<span class="lineCov">     142427 : ddt_select(spa_t *spa, const blkptr_t *bp)</span>
<span class="lineNum">     676 </span>                :            : {
<span class="lineNum">     677 </span>           [<span class="branchCov" title="Branch 0 was taken 142441 times"> + </span>]:<span class="lineCov">     142427 :         return (spa-&gt;spa_ddt[BP_GET_CHECKSUM(bp)]);</span>
<span class="lineNum">     678 </span>                :            : }
<a name="679"><span class="lineNum">     679 </span>                :            : </a>
<span class="lineNum">     680 </span>                :            : void
<span class="lineNum">     681 </span>                :<span class="lineCov">     434098 : ddt_enter(ddt_t *ddt)</span>
<span class="lineNum">     682 </span>                :            : {
<span class="lineNum">     683 </span>                :<span class="lineCov">     434098 :         mutex_enter(&amp;ddt-&gt;ddt_lock);</span>
<span class="lineNum">     684 </span>                :<span class="lineCov">     434164 : }</span>
<a name="685"><span class="lineNum">     685 </span>                :            : </a>
<span class="lineNum">     686 </span>                :            : void
<span class="lineNum">     687 </span>                :<span class="lineCov">     434163 : ddt_exit(ddt_t *ddt)</span>
<span class="lineNum">     688 </span>                :            : {
<span class="lineNum">     689 </span>                :<span class="lineCov">     434163 :         mutex_exit(&amp;ddt-&gt;ddt_lock);</span>
<span class="lineNum">     690 </span>                :<span class="lineCov">     434156 : }</span>
<a name="691"><span class="lineNum">     691 </span>                :            : </a>
<span class="lineNum">     692 </span>                :            : void
<span class="lineNum">     693 </span>                :<span class="lineCov">       1234 : ddt_init(void)</span>
<span class="lineNum">     694 </span>                :            : {
<span class="lineNum">     695 </span>                :<span class="lineCov">       1234 :         ddt_cache = kmem_cache_create(&quot;ddt_cache&quot;,</span>
<span class="lineNum">     696 </span>                :            :             sizeof (ddt_t), 0, NULL, NULL, NULL, NULL, NULL, 0);
<span class="lineNum">     697 </span>                :<span class="lineCov">       1234 :         ddt_entry_cache = kmem_cache_create(&quot;ddt_entry_cache&quot;,</span>
<span class="lineNum">     698 </span>                :            :             sizeof (ddt_entry_t), 0, NULL, NULL, NULL, NULL, NULL, 0);
<span class="lineNum">     699 </span>                :<span class="lineCov">       1234 : }</span>
<a name="700"><span class="lineNum">     700 </span>                :            : </a>
<span class="lineNum">     701 </span>                :            : void
<span class="lineNum">     702 </span>                :<span class="lineCov">        785 : ddt_fini(void)</span>
<span class="lineNum">     703 </span>                :            : {
<span class="lineNum">     704 </span>                :<span class="lineCov">        785 :         kmem_cache_destroy(ddt_entry_cache);</span>
<span class="lineNum">     705 </span>                :<span class="lineCov">        785 :         kmem_cache_destroy(ddt_cache);</span>
<span class="lineNum">     706 </span>                :<span class="lineCov">        785 : }</span>
<a name="707"><span class="lineNum">     707 </span>                :            : </a>
<span class="lineNum">     708 </span>                :            : static ddt_entry_t *
<span class="lineNum">     709 </span>                :<span class="lineCov">      34064 : ddt_alloc(const ddt_key_t *ddk)</span>
<span class="lineNum">     710 </span>                :            : {
<span class="lineNum">     711 </span>                :            :         ddt_entry_t *dde;
<span class="lineNum">     712 </span>                :            : 
<span class="lineNum">     713 </span>                :<span class="lineCov">      34064 :         dde = kmem_cache_alloc(ddt_entry_cache, KM_SLEEP);</span>
<span class="lineNum">     714 </span>                :<span class="lineCov">      34066 :         bzero(dde, sizeof (ddt_entry_t));</span>
<span class="lineNum">     715 </span>                :<span class="lineCov">      34066 :         cv_init(&amp;dde-&gt;dde_cv, NULL, CV_DEFAULT, NULL);</span>
<span class="lineNum">     716 </span>                :            : 
<span class="lineNum">     717 </span>                :<span class="lineCov">      34062 :         dde-&gt;dde_key = *ddk;</span>
<span class="lineNum">     718 </span>                :            : 
<span class="lineNum">     719 </span>                :<span class="lineCov">      34062 :         return (dde);</span>
<span class="lineNum">     720 </span>                :            : }
<a name="721"><span class="lineNum">     721 </span>                :            : </a>
<span class="lineNum">     722 </span>                :            : static void
<span class="lineNum">     723 </span>                :<span class="lineCov">      34067 : ddt_free(ddt_entry_t *dde)</span>
<span class="lineNum">     724 </span>                :            : {
<span class="lineNum">     725 </span>                :            :         int p;
<span class="lineNum">     726 </span>                :            : 
<span class="lineNum">     727 </span>        [<span class="branchCov" title="Branch 0 was taken 34067 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      34067 :         ASSERT(!dde-&gt;dde_loading);</span>
<span class="lineNum">     728 </span>                :            : 
<span class="lineNum">     729 </span>        [<span class="branchCov" title="Branch 0 was taken 136268 times"> + </span><span class="branchCov" title="Branch 1 was taken 34067 times"> + </span>]:<span class="lineCov">     170335 :         for (p = 0; p &lt; DDT_PHYS_TYPES; p++)</span>
<span class="lineNum">     730 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 136268 times"> + </span>]:<span class="lineCov">     136268 :                 ASSERT(dde-&gt;dde_lead_zio[p] == NULL);</span>
<span class="lineNum">     731 </span>                :            : 
<span class="lineNum">     732 </span>        [<span class="branchCov" title="Branch 0 was taken 25714 times"> + </span><span class="branchCov" title="Branch 1 was taken 8353 times"> + </span>]:<span class="lineCov">      34067 :         if (dde-&gt;dde_repair_abd != NULL)</span>
<span class="lineNum">     733 </span>                :<span class="lineCov">      25714 :                 abd_free(dde-&gt;dde_repair_abd);</span>
<span class="lineNum">     734 </span>                :            : 
<span class="lineNum">     735 </span>                :<span class="lineCov">      34067 :         cv_destroy(&amp;dde-&gt;dde_cv);</span>
<span class="lineNum">     736 </span>                :<span class="lineCov">      34067 :         kmem_cache_free(ddt_entry_cache, dde);</span>
<span class="lineNum">     737 </span>                :<span class="lineCov">      34067 : }</span>
<a name="738"><span class="lineNum">     738 </span>                :            : </a>
<span class="lineNum">     739 </span>                :            : void
<span class="lineNum">     740 </span>                :<span class="lineCov">        149 : ddt_remove(ddt_t *ddt, ddt_entry_t *dde)</span>
<span class="lineNum">     741 </span>                :            : {
<span class="lineNum">     742 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 149 times"> + </span>]:<span class="lineCov">        149 :         ASSERT(MUTEX_HELD(&amp;ddt-&gt;ddt_lock));</span>
<span class="lineNum">     743 </span>                :            : 
<span class="lineNum">     744 </span>                :<span class="lineCov">        149 :         avl_remove(&amp;ddt-&gt;ddt_tree, dde);</span>
<span class="lineNum">     745 </span>                :<span class="lineCov">        149 :         ddt_free(dde);</span>
<span class="lineNum">     746 </span>                :<span class="lineCov">        149 : }</span>
<a name="747"><span class="lineNum">     747 </span>                :            : </a>
<span class="lineNum">     748 </span>                :            : ddt_entry_t *
<span class="lineNum">     749 </span>                :<span class="lineCov">      55039 : ddt_lookup(ddt_t *ddt, const blkptr_t *bp, boolean_t add)</span>
<span class="lineNum">     750 </span>                :            : {
<span class="lineNum">     751 </span>                :            :         ddt_entry_t *dde, dde_search;
<span class="lineNum">     752 </span>                :            :         enum ddt_type type;
<span class="lineNum">     753 </span>                :            :         enum ddt_class class;
<span class="lineNum">     754 </span>                :            :         avl_index_t where;
<span class="lineNum">     755 </span>                :            :         int error;
<span class="lineNum">     756 </span>                :            : 
<span class="lineNum">     757 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 55039 times"> + </span>]:<span class="lineCov">      55039 :         ASSERT(MUTEX_HELD(&amp;ddt-&gt;ddt_lock));</span>
<span class="lineNum">     758 </span>                :            : 
<span class="lineNum">     759 </span>                :<span class="lineCov">      55039 :         ddt_key_fill(&amp;dde_search.dde_key, bp);</span>
<span class="lineNum">     760 </span>                :            : 
<span class="lineNum">     761 </span>                :<span class="lineCov">      55039 :         dde = avl_find(&amp;ddt-&gt;ddt_tree, &amp;dde_search, &amp;where);</span>
<span class="lineNum">     762 </span>        [<span class="branchCov" title="Branch 0 was taken 18411 times"> + </span><span class="branchCov" title="Branch 1 was taken 36628 times"> + </span>]:<span class="lineCov">      55039 :         if (dde == NULL) {</span>
<span class="lineNum">     763 </span>        [<span class="branchCov" title="Branch 0 was taken 8351 times"> + </span><span class="branchCov" title="Branch 1 was taken 10060 times"> + </span>]:<span class="lineCov">      18411 :                 if (!add)</span>
<span class="lineNum">     764 </span>                :            :                         return (NULL);
<span class="lineNum">     765 </span>                :<span class="lineCov">       8351 :                 dde = ddt_alloc(&amp;dde_search.dde_key);</span>
<span class="lineNum">     766 </span>                :<span class="lineCov">      44980 :                 avl_insert(&amp;ddt-&gt;ddt_tree, dde, where);</span>
<span class="lineNum">     767 </span>                :            :         }
<span class="lineNum">     768 </span>                :            : 
<span class="lineNum">     769 </span>        [<span class="branchCov" title="Branch 0 was taken 176 times"> + </span><span class="branchCov" title="Branch 1 was taken 44978 times"> + </span>]:<span class="lineCov">      45154 :         while (dde-&gt;dde_loading)</span>
<span class="lineNum">     770 </span>                :<span class="lineCov">        176 :                 cv_wait(&amp;dde-&gt;dde_cv, &amp;ddt-&gt;ddt_lock);</span>
<span class="lineNum">     771 </span>                :            : 
<span class="lineNum">     772 </span>        [<span class="branchCov" title="Branch 0 was taken 8352 times"> + </span><span class="branchCov" title="Branch 1 was taken 36626 times"> + </span>]:<span class="lineCov">      44978 :         if (dde-&gt;dde_loaded)</span>
<span class="lineNum">     773 </span>                :            :                 return (dde);
<span class="lineNum">     774 </span>                :            : 
<span class="lineNum">     775 </span>                :<span class="lineCov">       8352 :         dde-&gt;dde_loading = B_TRUE;</span>
<span class="lineNum">     776 </span>                :            : 
<span class="lineNum">     777 </span>                :<span class="lineCov">       8352 :         ddt_exit(ddt);</span>
<span class="lineNum">     778 </span>                :            : 
<span class="lineNum">     779 </span>                :<span class="lineCov">       8352 :         error = ENOENT;</span>
<span class="lineNum">     780 </span>                :            : 
<span class="lineNum">     781 </span>        [<span class="branchCov" title="Branch 1 was taken 8351 times"> + </span><span class="branchCov" title="Branch 2 was taken 5212 times"> + </span>]:<span class="lineCov">      13563 :         for (type = 0; type &lt; DDT_TYPES; type++) {</span>
<span class="lineNum">     782 </span>        [<span class="branchCov" title="Branch 0 was taken 24758 times"> + </span><span class="branchCov" title="Branch 1 was taken 5210 times"> + </span>]:<span class="lineCov">      29968 :                 for (class = 0; class &lt; DDT_CLASSES; class++) {</span>
<span class="lineNum">     783 </span>                :<span class="lineCov">      24758 :                         error = ddt_object_lookup(ddt, type, class, dde);</span>
<span class="lineNum">     784 </span>        [<span class="branchCov" title="Branch 0 was taken 21617 times"> + </span><span class="branchCov" title="Branch 1 was taken 3141 times"> + </span>]:<span class="lineCov">      24758 :                         if (error != ENOENT)</span>
<span class="lineNum">     785 </span>                :            :                                 break;
<span class="lineNum">     786 </span>                :            :                 }
<span class="lineNum">     787 </span>        [<span class="branchCov" title="Branch 0 was taken 5211 times"> + </span><span class="branchCov" title="Branch 1 was taken 3140 times"> + </span>]:<span class="lineCov">       8351 :                 if (error != ENOENT)</span>
<span class="lineNum">     788 </span>                :            :                         break;
<span class="lineNum">     789 </span>                :            :         }
<span class="lineNum">     790 </span>                :            : 
<span class="lineNum">     791 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 8352 times"> + </span>]:<span class="lineCov">       8352 :         ASSERT(error == 0 || error == ENOENT);</span>
<span class="lineNum">     792 </span>                :            : 
<span class="lineNum">     793 </span>                :<span class="lineCov">       8352 :         ddt_enter(ddt);</span>
<span class="lineNum">     794 </span>                :            : 
<span class="lineNum">     795 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 8352 times"> + </span>]:<span class="lineCov">       8352 :         ASSERT(dde-&gt;dde_loaded == B_FALSE);</span>
<span class="lineNum">     796 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 8352 times"> + </span>]:<span class="lineCov">       8352 :         ASSERT(dde-&gt;dde_loading == B_TRUE);</span>
<span class="lineNum">     797 </span>                :            : 
<span class="lineNum">     798 </span>                :<span class="lineCov">       8352 :         dde-&gt;dde_type = type;        /* will be DDT_TYPES if no entry found */</span>
<span class="lineNum">     799 </span>                :<span class="lineCov">       8352 :         dde-&gt;dde_class = class;      /* will be DDT_CLASSES if no entry found */</span>
<span class="lineNum">     800 </span>                :<span class="lineCov">       8352 :         dde-&gt;dde_loaded = B_TRUE;</span>
<span class="lineNum">     801 </span>                :<span class="lineCov">       8352 :         dde-&gt;dde_loading = B_FALSE;</span>
<span class="lineNum">     802 </span>                :            : 
<span class="lineNum">     803 </span>        [<span class="branchCov" title="Branch 0 was taken 3141 times"> + </span><span class="branchCov" title="Branch 1 was taken 5211 times"> + </span>]:<span class="lineCov">       8352 :         if (error == 0)</span>
<span class="lineNum">     804 </span>                :<span class="lineCov">       3141 :                 ddt_stat_update(ddt, dde, -1ULL);</span>
<span class="lineNum">     805 </span>                :            : 
<span class="lineNum">     806 </span>                :<span class="lineCov">       8352 :         cv_broadcast(&amp;dde-&gt;dde_cv);</span>
<span class="lineNum">     807 </span>                :            : 
<span class="lineNum">     808 </span>                :<span class="lineCov">       8352 :         return (dde);</span>
<span class="lineNum">     809 </span>                :            : }
<a name="810"><span class="lineNum">     810 </span>                :            : </a>
<span class="lineNum">     811 </span>                :            : void
<span class="lineNum">     812 </span>                :<span class="lineCov">     685283 : ddt_prefetch(spa_t *spa, const blkptr_t *bp)</span>
<span class="lineNum">     813 </span>                :            : {
<span class="lineNum">     814 </span>                :            :         ddt_t *ddt;
<span class="lineNum">     815 </span>                :            :         ddt_entry_t dde;
<span class="lineNum">     816 </span>                :            :         enum ddt_type type;
<span class="lineNum">     817 </span>                :            :         enum ddt_class class;
<span class="lineNum">     818 </span>                :            : 
<span class="lineNum">     819 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 685283 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     685283 :         if (!zfs_dedup_prefetch || bp == NULL || !BP_GET_DEDUP(bp))</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">     820 </span>                :<span class="lineCov">     685283 :                 return;</span>
<span class="lineNum">     821 </span>                :            : 
<span class="lineNum">     822 </span>                :            :         /*
<span class="lineNum">     823 </span>                :            :          * We only remove the DDT once all tables are empty and only
<span class="lineNum">     824 </span>                :            :          * prefetch dedup blocks when there are entries in the DDT.
<span class="lineNum">     825 </span>                :            :          * Thus no locking is required as the DDT can't disappear on us.
<span class="lineNum">     826 </span>                :            :          */
<span class="lineNum">     827 </span>                :<span class="lineNoCov">          0 :         ddt = ddt_select(spa, bp);</span>
<span class="lineNum">     828 </span>                :<span class="lineNoCov">          0 :         ddt_key_fill(&amp;dde.dde_key, bp);</span>
<span class="lineNum">     829 </span>                :            : 
<span class="lineNum">     830 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (type = 0; type &lt; DDT_TYPES; type++) {</span>
<span class="lineNum">     831 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 for (class = 0; class &lt; DDT_CLASSES; class++) {</span>
<span class="lineNum">     832 </span>                :<span class="lineNoCov">          0 :                         ddt_object_prefetch(ddt, type, class, &amp;dde);</span>
<span class="lineNum">     833 </span>                :            :                 }
<span class="lineNum">     834 </span>                :            :         }
<span class="lineNum">     835 </span>                :            : }
<span class="lineNum">     836 </span>                :            : 
<span class="lineNum">     837 </span>                :            : /*
<span class="lineNum">     838 </span>                :            :  * Opaque struct used for ddt_key comparison
<span class="lineNum">     839 </span>                :            :  */
<span class="lineNum">     840 </span>                :            : #define DDT_KEY_CMP_LEN (sizeof (ddt_key_t) / sizeof (uint16_t))
<span class="lineNum">     841 </span>                :            : 
<span class="lineNum">     842 </span>                :            : typedef struct ddt_key_cmp {
<span class="lineNum">     843 </span>                :            :         uint16_t        u16[DDT_KEY_CMP_LEN];
<span class="lineNum">     844 </span>                :            : } ddt_key_cmp_t;
<a name="845"><span class="lineNum">     845 </span>                :            : </a>
<span class="lineNum">     846 </span>                :            : int
<span class="lineNum">     847 </span>                :<span class="lineCov">      62793 : ddt_entry_compare(const void *x1, const void *x2)</span>
<span class="lineNum">     848 </span>                :            : {
<span class="lineNum">     849 </span>                :<span class="lineCov">      62793 :         const ddt_entry_t *dde1 = x1;</span>
<span class="lineNum">     850 </span>                :<span class="lineCov">      62793 :         const ddt_entry_t *dde2 = x2;</span>
<span class="lineNum">     851 </span>                :<span class="lineCov">      62793 :         const ddt_key_cmp_t *k1 = (const ddt_key_cmp_t *)&amp;dde1-&gt;dde_key;</span>
<span class="lineNum">     852 </span>                :<span class="lineCov">      62793 :         const ddt_key_cmp_t *k2 = (const ddt_key_cmp_t *)&amp;dde2-&gt;dde_key;</span>
<span class="lineNum">     853 </span>                :<span class="lineCov">      62793 :         int32_t cmp = 0;</span>
<span class="lineNum">     854 </span>                :            :         int i;
<span class="lineNum">     855 </span>                :            : 
<span class="lineNum">     856 </span>        [<span class="branchCov" title="Branch 0 was taken 762486 times"> + </span><span class="branchCov" title="Branch 1 was taken 36827 times"> + </span>]:<span class="lineCov">     799313 :         for (i = 0; i &lt; DDT_KEY_CMP_LEN; i++) {</span>
<span class="lineNum">     857 </span>                :<span class="lineCov">     762486 :                 cmp = (int32_t)k1-&gt;u16[i] - (int32_t)k2-&gt;u16[i];</span>
<span class="lineNum">     858 </span>        [<span class="branchCov" title="Branch 0 was taken 736520 times"> + </span><span class="branchCov" title="Branch 1 was taken 25966 times"> + </span>]:<span class="lineCov">     762486 :                 if (likely(cmp))</span>
<span class="lineNum">     859 </span>                :            :                         break;
<span class="lineNum">     860 </span>                :            :         }
<span class="lineNum">     861 </span>                :            : 
<span class="lineNum">     862 </span>                :<span class="lineCov">      62793 :         return (AVL_ISIGN(cmp));</span>
<span class="lineNum">     863 </span>                :            : }
<a name="864"><span class="lineNum">     864 </span>                :            : </a>
<span class="lineNum">     865 </span>                :            : static ddt_t *
<span class="lineNum">     866 </span>                :<span class="lineCov">      12516 : ddt_table_alloc(spa_t *spa, enum zio_checksum c)</span>
<span class="lineNum">     867 </span>                :            : {
<span class="lineNum">     868 </span>                :            :         ddt_t *ddt;
<span class="lineNum">     869 </span>                :            : 
<span class="lineNum">     870 </span>                :<span class="lineCov">      12516 :         ddt = kmem_cache_alloc(ddt_cache, KM_SLEEP);</span>
<span class="lineNum">     871 </span>                :<span class="lineCov">      12516 :         bzero(ddt, sizeof (ddt_t));</span>
<span class="lineNum">     872 </span>                :            : 
<span class="lineNum">     873 </span>                :<span class="lineCov">      12516 :         mutex_init(&amp;ddt-&gt;ddt_lock, NULL, MUTEX_DEFAULT, NULL);</span>
<span class="lineNum">     874 </span>                :<span class="lineCov">      12516 :         avl_create(&amp;ddt-&gt;ddt_tree, ddt_entry_compare,</span>
<span class="lineNum">     875 </span>                :            :             sizeof (ddt_entry_t), offsetof(ddt_entry_t, dde_node));
<span class="lineNum">     876 </span>                :<span class="lineCov">      12516 :         avl_create(&amp;ddt-&gt;ddt_repair_tree, ddt_entry_compare,</span>
<span class="lineNum">     877 </span>                :            :             sizeof (ddt_entry_t), offsetof(ddt_entry_t, dde_node));
<span class="lineNum">     878 </span>                :<span class="lineCov">      12516 :         ddt-&gt;ddt_checksum = c;</span>
<span class="lineNum">     879 </span>                :<span class="lineCov">      12516 :         ddt-&gt;ddt_spa = spa;</span>
<span class="lineNum">     880 </span>                :<span class="lineCov">      12516 :         ddt-&gt;ddt_os = spa-&gt;spa_meta_objset;</span>
<span class="lineNum">     881 </span>                :            : 
<span class="lineNum">     882 </span>                :<span class="lineCov">      12516 :         return (ddt);</span>
<span class="lineNum">     883 </span>                :            : }
<a name="884"><span class="lineNum">     884 </span>                :            : </a>
<span class="lineNum">     885 </span>                :            : static void
<span class="lineNum">     886 </span>                :<span class="lineCov">      12502 : ddt_table_free(ddt_t *ddt)</span>
<span class="lineNum">     887 </span>                :            : {
<span class="lineNum">     888 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 12502 times"> + </span>]:<span class="lineCov">      12502 :         ASSERT(avl_numnodes(&amp;ddt-&gt;ddt_tree) == 0);</span>
<span class="lineNum">     889 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 12502 times"> + </span>]:<span class="lineCov">      12502 :         ASSERT(avl_numnodes(&amp;ddt-&gt;ddt_repair_tree) == 0);</span>
<span class="lineNum">     890 </span>                :<span class="lineCov">      12502 :         avl_destroy(&amp;ddt-&gt;ddt_tree);</span>
<span class="lineNum">     891 </span>                :<span class="lineCov">      12502 :         avl_destroy(&amp;ddt-&gt;ddt_repair_tree);</span>
<span class="lineNum">     892 </span>                :<span class="lineCov">      12502 :         mutex_destroy(&amp;ddt-&gt;ddt_lock);</span>
<span class="lineNum">     893 </span>                :<span class="lineCov">      12502 :         kmem_cache_free(ddt_cache, ddt);</span>
<span class="lineNum">     894 </span>                :<span class="lineCov">      12502 : }</span>
<a name="895"><span class="lineNum">     895 </span>                :            : </a>
<span class="lineNum">     896 </span>                :            : void
<span class="lineNum">     897 </span>                :<span class="lineCov">        894 : ddt_create(spa_t *spa)</span>
<span class="lineNum">     898 </span>                :            : {
<span class="lineNum">     899 </span>                :            :         enum zio_checksum c;
<span class="lineNum">     900 </span>                :            : 
<span class="lineNum">     901 </span>                :<span class="lineCov">        894 :         spa-&gt;spa_dedup_checksum = ZIO_DEDUPCHECKSUM;</span>
<span class="lineNum">     902 </span>                :            : 
<span class="lineNum">     903 </span>        [<span class="branchCov" title="Branch 0 was taken 12516 times"> + </span><span class="branchCov" title="Branch 1 was taken 894 times"> + </span>]:<span class="lineCov">      13410 :         for (c = 0; c &lt; ZIO_CHECKSUM_FUNCTIONS; c++)</span>
<span class="lineNum">     904 </span>                :<span class="lineCov">      12516 :                 spa-&gt;spa_ddt[c] = ddt_table_alloc(spa, c);</span>
<span class="lineNum">     905 </span>                :<span class="lineCov">        894 : }</span>
<a name="906"><span class="lineNum">     906 </span>                :            : </a>
<span class="lineNum">     907 </span>                :            : int
<span class="lineNum">     908 </span>                :<span class="lineCov">        841 : ddt_load(spa_t *spa)</span>
<span class="lineNum">     909 </span>                :            : {
<span class="lineNum">     910 </span>                :            :         enum zio_checksum c;
<span class="lineNum">     911 </span>                :            :         enum ddt_type type;
<span class="lineNum">     912 </span>                :            :         enum ddt_class class;
<span class="lineNum">     913 </span>                :            :         int error;
<span class="lineNum">     914 </span>                :            : 
<span class="lineNum">     915 </span>                :<span class="lineCov">        841 :         ddt_create(spa);</span>
<span class="lineNum">     916 </span>                :            : 
<span class="lineNum">     917 </span>                :<span class="lineCov">        841 :         error = zap_lookup(spa-&gt;spa_meta_objset, DMU_POOL_DIRECTORY_OBJECT,</span>
<span class="lineNum">     918 </span>                :            :             DMU_POOL_DDT_STATS, sizeof (uint64_t), 1,
<span class="lineNum">     919 </span>                :<span class="lineCov">        841 :             &amp;spa-&gt;spa_ddt_stat_object);</span>
<span class="lineNum">     920 </span>                :            : 
<span class="lineNum">     921 </span>        [<span class="branchCov" title="Branch 0 was taken 408 times"> + </span><span class="branchCov" title="Branch 1 was taken 433 times"> + </span>]:<span class="lineCov">        841 :         if (error)</span>
<span class="lineNum">     922 </span>        [<span class="branchCov" title="Branch 0 was taken 433 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        433 :                 return (error == ENOENT ? 0 : error);</span>
<span class="lineNum">     923 </span>                :            : 
<span class="lineNum">     924 </span>        [<span class="branchCov" title="Branch 0 was taken 5712 times"> + </span><span class="branchCov" title="Branch 1 was taken 408 times"> + </span>]:<span class="lineCov">       6120 :         for (c = 0; c &lt; ZIO_CHECKSUM_FUNCTIONS; c++) {</span>
<span class="lineNum">     925 </span>                :<span class="lineCov">       5712 :                 ddt_t *ddt = spa-&gt;spa_ddt[c];</span>
<span class="lineNum">     926 </span>        [<span class="branchCov" title="Branch 0 was taken 5712 times"> + </span><span class="branchCov" title="Branch 1 was taken 5712 times"> + </span>]:<span class="lineCov">      11424 :                 for (type = 0; type &lt; DDT_TYPES; type++) {</span>
<span class="lineNum">     927 </span>        [<span class="branchCov" title="Branch 0 was taken 17136 times"> + </span><span class="branchCov" title="Branch 1 was taken 5712 times"> + </span>]:<span class="lineCov">      22848 :                         for (class = 0; class &lt; DDT_CLASSES;</span>
<span class="lineNum">     928 </span>                :<span class="lineCov">      17136 :                             class++) {</span>
<span class="lineNum">     929 </span>                :<span class="lineCov">      17136 :                                 error = ddt_object_load(ddt, type, class);</span>
<span class="lineNum">     930 </span>        [<span class="branchCov" title="Branch 0 was taken 17136 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      17136 :                                 if (error != 0 &amp;&amp; error != ENOENT)</span>
<span class="lineNum">     931 </span>                :            :                                         return (error);
<span class="lineNum">     932 </span>                :            :                         }
<span class="lineNum">     933 </span>                :            :                 }
<span class="lineNum">     934 </span>                :            : 
<span class="lineNum">     935 </span>                :            :                 /*
<span class="lineNum">     936 </span>                :            :                  * Seed the cached histograms.
<span class="lineNum">     937 </span>                :            :                  */
<span class="lineNum">     938 </span>                :<span class="lineCov">      11424 :                 bcopy(ddt-&gt;ddt_histogram, &amp;ddt-&gt;ddt_histogram_cache,</span>
<span class="lineNum">     939 </span>                :            :                     sizeof (ddt-&gt;ddt_histogram));
<span class="lineNum">     940 </span>                :<span class="lineCov">       5712 :                 spa-&gt;spa_dedup_dspace = ~0ULL;</span>
<span class="lineNum">     941 </span>                :            :         }
<span class="lineNum">     942 </span>                :            : 
<span class="lineNum">     943 </span>                :            :         return (0);
<span class="lineNum">     944 </span>                :            : }
<a name="945"><span class="lineNum">     945 </span>                :            : </a>
<span class="lineNum">     946 </span>                :            : void
<span class="lineNum">     947 </span>                :<span class="lineCov">       1760 : ddt_unload(spa_t *spa)</span>
<span class="lineNum">     948 </span>                :            : {
<span class="lineNum">     949 </span>                :            :         enum zio_checksum c;
<span class="lineNum">     950 </span>                :            : 
<span class="lineNum">     951 </span>        [<span class="branchCov" title="Branch 0 was taken 24640 times"> + </span><span class="branchCov" title="Branch 1 was taken 1760 times"> + </span>]:<span class="lineCov">      26400 :         for (c = 0; c &lt; ZIO_CHECKSUM_FUNCTIONS; c++) {</span>
<span class="lineNum">     952 </span>        [<span class="branchCov" title="Branch 0 was taken 12502 times"> + </span><span class="branchCov" title="Branch 1 was taken 12138 times"> + </span>]:<span class="lineCov">      24640 :                 if (spa-&gt;spa_ddt[c]) {</span>
<span class="lineNum">     953 </span>                :<span class="lineCov">      12502 :                         ddt_table_free(spa-&gt;spa_ddt[c]);</span>
<span class="lineNum">     954 </span>                :<span class="lineCov">      12502 :                         spa-&gt;spa_ddt[c] = NULL;</span>
<span class="lineNum">     955 </span>                :            :                 }
<span class="lineNum">     956 </span>                :            :         }
<span class="lineNum">     957 </span>                :<span class="lineCov">       1760 : }</span>
<a name="958"><span class="lineNum">     958 </span>                :            : </a>
<span class="lineNum">     959 </span>                :            : boolean_t
<span class="lineNum">     960 </span>                :<span class="lineCov">     103168 : ddt_class_contains(spa_t *spa, enum ddt_class max_class, const blkptr_t *bp)</span>
<span class="lineNum">     961 </span>                :            : {
<span class="lineNum">     962 </span>                :            :         ddt_t *ddt;
<span class="lineNum">     963 </span>                :            :         ddt_entry_t *dde;
<span class="lineNum">     964 </span>                :            :         enum ddt_type type;
<span class="lineNum">     965 </span>                :            :         enum ddt_class class;
<span class="lineNum">     966 </span>                :            : 
<span class="lineNum">     967 </span>        [<span class="branchCov" title="Branch 0 was taken 20862 times"> + </span><span class="branchCov" title="Branch 1 was taken 82306 times"> + </span>]:<span class="lineCov">     103168 :         if (!BP_GET_DEDUP(bp))</span>
<span class="lineNum">     968 </span>                :            :                 return (B_FALSE);
<span class="lineNum">     969 </span>                :            : 
<span class="lineNum">     970 </span>        [<span class="branchCov" title="Branch 0 was taken 20862 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      20862 :         if (max_class == DDT_CLASS_UNIQUE)</span>
<span class="lineNum">     971 </span>                :            :                 return (B_TRUE);
<span class="lineNum">     972 </span>                :            : 
<span class="lineNum">     973 </span>        [<span class="branchCov" title="Branch 0 was taken 20862 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      20862 :         ddt = spa-&gt;spa_ddt[BP_GET_CHECKSUM(bp)];</span>
<span class="lineNum">     974 </span>                :<span class="lineCov">      20862 :         dde = kmem_cache_alloc(ddt_entry_cache, KM_SLEEP);</span>
<span class="lineNum">     975 </span>                :            : 
<span class="lineNum">     976 </span>                :<span class="lineCov">      20862 :         ddt_key_fill(&amp;(dde-&gt;dde_key), bp);</span>
<span class="lineNum">     977 </span>                :            : 
<span class="lineNum">     978 </span>        [<span class="branchCov" title="Branch 1 was taken 20862 times"> + </span><span class="branchCov" title="Branch 2 was taken 4951 times"> + </span>]:<span class="lineCov">      25813 :         for (type = 0; type &lt; DDT_TYPES; type++) {</span>
<span class="lineNum">     979 </span>        [<span class="branchCov" title="Branch 0 was taken 25848 times"> + </span><span class="branchCov" title="Branch 1 was taken 4951 times"> + </span>]:<span class="lineCov">      30799 :                 for (class = 0; class &lt;= max_class; class++) {</span>
<span class="lineNum">     980 </span>        [<span class="branchCov" title="Branch 1 was taken 15911 times"> + </span><span class="branchCov" title="Branch 2 was taken 9937 times"> + </span>]:<span class="lineCov">      25848 :                         if (ddt_object_lookup(ddt, type, class, dde) == 0) {</span>
<span class="lineNum">     981 </span>                :<span class="lineCov">      15911 :                                 kmem_cache_free(ddt_entry_cache, dde);</span>
<span class="lineNum">     982 </span>                :<span class="lineCov">      15911 :                                 return (B_TRUE);</span>
<span class="lineNum">     983 </span>                :            :                         }
<span class="lineNum">     984 </span>                :            :                 }
<span class="lineNum">     985 </span>                :            :         }
<span class="lineNum">     986 </span>                :            : 
<span class="lineNum">     987 </span>                :<span class="lineCov">       4951 :         kmem_cache_free(ddt_entry_cache, dde);</span>
<span class="lineNum">     988 </span>                :<span class="lineCov">       4951 :         return (B_FALSE);</span>
<span class="lineNum">     989 </span>                :            : }
<a name="990"><span class="lineNum">     990 </span>                :            : </a>
<span class="lineNum">     991 </span>                :            : ddt_entry_t *
<span class="lineNum">     992 </span>                :<span class="lineCov">      25713 : ddt_repair_start(ddt_t *ddt, const blkptr_t *bp)</span>
<span class="lineNum">     993 </span>                :            : {
<span class="lineNum">     994 </span>                :            :         ddt_key_t ddk;
<span class="lineNum">     995 </span>                :            :         ddt_entry_t *dde;
<span class="lineNum">     996 </span>                :            :         enum ddt_type type;
<span class="lineNum">     997 </span>                :            :         enum ddt_class class;
<span class="lineNum">     998 </span>                :            : 
<span class="lineNum">     999 </span>                :<span class="lineCov">      25713 :         ddt_key_fill(&amp;ddk, bp);</span>
<span class="lineNum">    1000 </span>                :            : 
<span class="lineNum">    1001 </span>                :<span class="lineCov">      25713 :         dde = ddt_alloc(&amp;ddk);</span>
<span class="lineNum">    1002 </span>                :            : 
<span class="lineNum">    1003 </span>        [<span class="branchCov" title="Branch 1 was taken 25710 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      25713 :         for (type = 0; type &lt; DDT_TYPES; type++) {</span>
<span class="lineNum">    1004 </span>        [<span class="branchCov" title="Branch 0 was taken 25710 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      25710 :                 for (class = 0; class &lt; DDT_CLASSES; class++) {</span>
<span class="lineNum">    1005 </span>                :            :                         /*
<span class="lineNum">    1006 </span>                :            :                          * We can only do repair if there are multiple copies
<span class="lineNum">    1007 </span>                :            :                          * of the block.  For anything in the UNIQUE class,
<span class="lineNum">    1008 </span>                :            :                          * there's definitely only one copy, so don't even try.
<span class="lineNum">    1009 </span>                :            :                          */
<span class="lineNum">    1010 </span>  [<span class="branchCov" title="Branch 0 was taken 25710 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 25715 times"> + </span>]:<span class="lineCov">      51425 :                         if (class != DDT_CLASS_UNIQUE &amp;&amp;</span>
<span class="lineNum">    1011 </span>                :<span class="lineCov">      25710 :                             ddt_object_lookup(ddt, type, class, dde) == 0)</span>
<span class="lineNum">    1012 </span>                :            :                                 return (dde);
<span class="lineNum">    1013 </span>                :            :                 }
<span class="lineNum">    1014 </span>                :            :         }
<span class="lineNum">    1015 </span>                :            : 
<span class="lineNum">    1016 </span>                :<span class="lineNoCov">          0 :         bzero(dde-&gt;dde_phys, sizeof (dde-&gt;dde_phys));</span>
<span class="lineNum">    1017 </span>                :            : 
<span class="lineNum">    1018 </span>                :<span class="lineNoCov">          0 :         return (dde);</span>
<span class="lineNum">    1019 </span>                :            : }
<a name="1020"><span class="lineNum">    1020 </span>                :            : </a>
<span class="lineNum">    1021 </span>                :            : void
<span class="lineNum">    1022 </span>                :<span class="lineCov">      25700 : ddt_repair_done(ddt_t *ddt, ddt_entry_t *dde)</span>
<span class="lineNum">    1023 </span>                :            : {
<span class="lineNum">    1024 </span>                :            :         avl_index_t where;
<span class="lineNum">    1025 </span>                :            : 
<span class="lineNum">    1026 </span>                :<span class="lineCov">      25700 :         ddt_enter(ddt);</span>
<span class="lineNum">    1027 </span>                :            : 
<span class="lineNum">    1028 </span>        [<span class="branchCov" title="Branch 0 was taken 25714 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">      25915 :         if (dde-&gt;dde_repair_abd != NULL &amp;&amp; spa_writeable(ddt-&gt;ddt_spa) &amp;&amp;</span>
<span class="lineNum">         </span>  [<span class="branchCov" title="Branch 3 was taken 200 times"> + </span><span class="branchCov" title="Branch 4 was taken 25514 times"> + </span><span class="branchCov" title="Branch 5 was taken 1 time"> + </span><span class="branchCov" title="Branch 6 was taken 199 times"> + </span>]
<span class="lineNum">    1029 </span>                :<span class="lineCov">        200 :             avl_find(&amp;ddt-&gt;ddt_repair_tree, dde, &amp;where) == NULL)</span>
<span class="lineNum">    1030 </span>                :<span class="lineCov">          1 :                 avl_insert(&amp;ddt-&gt;ddt_repair_tree, dde, where);</span>
<span class="lineNum">    1031 </span>                :            :         else
<span class="lineNum">    1032 </span>                :<span class="lineCov">      25714 :                 ddt_free(dde);</span>
<span class="lineNum">    1033 </span>                :            : 
<span class="lineNum">    1034 </span>                :<span class="lineCov">      25715 :         ddt_exit(ddt);</span>
<span class="lineNum">    1035 </span>                :<span class="lineCov">      25714 : }</span>
<a name="1036"><span class="lineNum">    1036 </span>                :            : </a>
<span class="lineNum">    1037 </span>                :            : static void
<span class="lineNum">    1038 </span>                :<span class="lineCov">          1 : ddt_repair_entry_done(zio_t *zio)</span>
<span class="lineNum">    1039 </span>                :            : {
<span class="lineNum">    1040 </span>                :<span class="lineCov">          1 :         ddt_entry_t *rdde = zio-&gt;io_private;</span>
<span class="lineNum">    1041 </span>                :            : 
<span class="lineNum">    1042 </span>                :<span class="lineCov">          1 :         ddt_free(rdde);</span>
<span class="lineNum">    1043 </span>                :<span class="lineCov">          1 : }</span>
<a name="1044"><span class="lineNum">    1044 </span>                :            : </a>
<span class="lineNum">    1045 </span>                :            : static void
<span class="lineNum">    1046 </span>                :<span class="lineCov">          1 : ddt_repair_entry(ddt_t *ddt, ddt_entry_t *dde, ddt_entry_t *rdde, zio_t *rio)</span>
<span class="lineNum">    1047 </span>                :            : {
<span class="lineNum">    1048 </span>                :<span class="lineCov">          1 :         ddt_phys_t *ddp = dde-&gt;dde_phys;</span>
<span class="lineNum">    1049 </span>                :<span class="lineCov">          1 :         ddt_phys_t *rddp = rdde-&gt;dde_phys;</span>
<span class="lineNum">    1050 </span>                :<span class="lineCov">          1 :         ddt_key_t *ddk = &amp;dde-&gt;dde_key;</span>
<span class="lineNum">    1051 </span>                :<span class="lineCov">          1 :         ddt_key_t *rddk = &amp;rdde-&gt;dde_key;</span>
<span class="lineNum">    1052 </span>                :            :         zio_t *zio;
<span class="lineNum">    1053 </span>                :            :         blkptr_t blk;
<span class="lineNum">    1054 </span>                :            :         int p;
<span class="lineNum">    1055 </span>                :            : 
<span class="lineNum">    1056 </span>                :<span class="lineCov">          1 :         zio = zio_null(rio, rio-&gt;io_spa, NULL,</span>
<span class="lineNum">    1057 </span>                :            :             ddt_repair_entry_done, rdde, rio-&gt;io_flags);
<span class="lineNum">    1058 </span>                :            : 
<span class="lineNum">    1059 </span>        [<span class="branchCov" title="Branch 1 was taken 4 times"> + </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">          5 :         for (p = 0; p &lt; DDT_PHYS_TYPES; p++, ddp++, rddp++) {</span>
<span class="lineNum">    1060 </span>[<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchCov" title="Branch 3 was taken 1 time"> + </span>]:<span class="lineCov">          4 :                 if (ddp-&gt;ddp_phys_birth == 0 ||</span>
<span class="lineNum">    1061 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                     ddp-&gt;ddp_phys_birth != rddp-&gt;ddp_phys_birth ||</span>
<span class="lineNum">    1062 </span>                :<span class="lineCov">          1 :                     bcmp(ddp-&gt;ddp_dva, rddp-&gt;ddp_dva, sizeof (ddp-&gt;ddp_dva)))</span>
<span class="lineNum">    1063 </span>                :<span class="lineCov">          3 :                         continue;</span>
<span class="lineNum">    1064 </span>                :<span class="lineCov">          1 :                 ddt_bp_create(ddt-&gt;ddt_checksum, ddk, ddp, &amp;blk);</span>
<span class="lineNum">    1065 </span>                :<span class="lineCov">          1 :                 zio_nowait(zio_rewrite(zio, zio-&gt;io_spa, 0, &amp;blk,</span>
<span class="lineNum">    1066 </span>                :<span class="lineCov">          1 :                     rdde-&gt;dde_repair_abd, DDK_GET_PSIZE(rddk), NULL, NULL,</span>
<span class="lineNum">    1067 </span>                :<span class="lineCov">          1 :                     ZIO_PRIORITY_SYNC_WRITE, ZIO_DDT_CHILD_FLAGS(zio), NULL));</span>
<span class="lineNum">    1068 </span>                :            :         }
<span class="lineNum">    1069 </span>                :            : 
<span class="lineNum">    1070 </span>                :<span class="lineCov">          1 :         zio_nowait(zio);</span>
<span class="lineNum">    1071 </span>                :<span class="lineCov">          1 : }</span>
<a name="1072"><span class="lineNum">    1072 </span>                :            : </a>
<span class="lineNum">    1073 </span>                :            : static void
<span class="lineNum">    1074 </span>                :<span class="lineCov">     806596 : ddt_repair_table(ddt_t *ddt, zio_t *rio)</span>
<span class="lineNum">    1075 </span>                :            : {
<span class="lineNum">    1076 </span>                :<span class="lineCov">     806596 :         spa_t *spa = ddt-&gt;ddt_spa;</span>
<span class="lineNum">    1077 </span>                :            :         ddt_entry_t *dde, *rdde_next, *rdde;
<span class="lineNum">    1078 </span>                :<span class="lineCov">     806596 :         avl_tree_t *t = &amp;ddt-&gt;ddt_repair_tree;</span>
<span class="lineNum">    1079 </span>                :            :         blkptr_t blk;
<span class="lineNum">    1080 </span>                :            : 
<span class="lineNum">    1081 </span>        [<span class="branchCov" title="Branch 1 was taken 334572 times"> + </span><span class="branchCov" title="Branch 2 was taken 472024 times"> + </span>]:<span class="lineCov">     806596 :         if (spa_sync_pass(spa) &gt; 1)</span>
<span class="lineNum">    1082 </span>                :<span class="lineCov">     472024 :                 return;</span>
<span class="lineNum">    1083 </span>                :            : 
<span class="lineNum">    1084 </span>                :<span class="lineCov">     334572 :         ddt_enter(ddt);</span>
<span class="lineNum">    1085 </span>        [<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchCov" title="Branch 3 was taken 334572 times"> + </span>]:<span class="lineCov">     334573 :         for (rdde = avl_first(t); rdde != NULL; rdde = rdde_next) {</span>
<span class="lineNum">    1086 </span>                :<span class="lineCov">          1 :                 rdde_next = AVL_NEXT(t, rdde);</span>
<span class="lineNum">    1087 </span>                :<span class="lineCov">          1 :                 avl_remove(&amp;ddt-&gt;ddt_repair_tree, rdde);</span>
<span class="lineNum">    1088 </span>                :<span class="lineCov">          1 :                 ddt_exit(ddt);</span>
<span class="lineNum">    1089 </span>                :<span class="lineCov">          1 :                 ddt_bp_create(ddt-&gt;ddt_checksum, &amp;rdde-&gt;dde_key, NULL, &amp;blk);</span>
<span class="lineNum">    1090 </span>                :<span class="lineCov">          1 :                 dde = ddt_repair_start(ddt, &amp;blk);</span>
<span class="lineNum">    1091 </span>                :<span class="lineCov">          1 :                 ddt_repair_entry(ddt, dde, rdde, rio);</span>
<span class="lineNum">    1092 </span>                :<span class="lineCov">          1 :                 ddt_repair_done(ddt, dde);</span>
<span class="lineNum">    1093 </span>                :<span class="lineCov">          1 :                 ddt_enter(ddt);</span>
<span class="lineNum">    1094 </span>                :            :         }
<span class="lineNum">    1095 </span>                :<span class="lineCov">     334572 :         ddt_exit(ddt);</span>
<span class="lineNum">    1096 </span>                :            : }
<a name="1097"><span class="lineNum">    1097 </span>                :            : </a>
<span class="lineNum">    1098 </span>                :            : static void
<span class="lineNum">    1099 </span>                :<span class="lineCov">       8203 : ddt_sync_entry(ddt_t *ddt, ddt_entry_t *dde, dmu_tx_t *tx, uint64_t txg)</span>
<span class="lineNum">    1100 </span>                :            : {
<span class="lineNum">    1101 </span>                :<span class="lineCov">       8203 :         dsl_pool_t *dp = ddt-&gt;ddt_spa-&gt;spa_dsl_pool;</span>
<span class="lineNum">    1102 </span>                :<span class="lineCov">       8203 :         ddt_phys_t *ddp = dde-&gt;dde_phys;</span>
<span class="lineNum">    1103 </span>                :<span class="lineCov">       8203 :         ddt_key_t *ddk = &amp;dde-&gt;dde_key;</span>
<span class="lineNum">    1104 </span>                :<span class="lineCov">       8203 :         enum ddt_type otype = dde-&gt;dde_type;</span>
<span class="lineNum">    1105 </span>                :<span class="lineCov">       8203 :         enum ddt_type ntype = DDT_TYPE_CURRENT;</span>
<span class="lineNum">    1106 </span>                :<span class="lineCov">       8203 :         enum ddt_class oclass = dde-&gt;dde_class;</span>
<span class="lineNum">    1107 </span>                :            :         enum ddt_class nclass;
<span class="lineNum">    1108 </span>                :<span class="lineCov">       8203 :         uint64_t total_refcnt = 0;</span>
<span class="lineNum">    1109 </span>                :            :         int p;
<span class="lineNum">    1110 </span>                :            : 
<span class="lineNum">    1111 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 8203 times"> + </span>]:<span class="lineCov">       8203 :         ASSERT(dde-&gt;dde_loaded);</span>
<span class="lineNum">    1112 </span>        [<span class="branchCov" title="Branch 0 was taken 8203 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       8203 :         ASSERT(!dde-&gt;dde_loading);</span>
<span class="lineNum">    1113 </span>                :            : 
<span class="lineNum">    1114 </span>        [<span class="branchCov" title="Branch 0 was taken 32812 times"> + </span><span class="branchCov" title="Branch 1 was taken 8203 times"> + </span>]:<span class="lineCov">      41015 :         for (p = 0; p &lt; DDT_PHYS_TYPES; p++, ddp++) {</span>
<span class="lineNum">    1115 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 32812 times"> + </span>]:<span class="lineCov">      32812 :                 ASSERT(dde-&gt;dde_lead_zio[p] == NULL);</span>
<span class="lineNum">    1116 </span>        [<span class="branchCov" title="Branch 0 was taken 24551 times"> + </span><span class="branchCov" title="Branch 1 was taken 8261 times"> + </span>]:<span class="lineCov">      32812 :                 if (ddp-&gt;ddp_phys_birth == 0) {</span>
<span class="lineNum">    1117 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 24551 times"> + </span>]:<span class="lineCov">      24551 :                         ASSERT(ddp-&gt;ddp_refcnt == 0);</span>
<span class="lineNum">    1118 </span>                :<span class="lineCov">      24551 :                         continue;</span>
<span class="lineNum">    1119 </span>                :            :                 }
<span class="lineNum">    1120 </span>        [<span class="branchCov" title="Branch 0 was taken 53 times"> + </span><span class="branchCov" title="Branch 1 was taken 8208 times"> + </span>]:<span class="lineCov">       8261 :                 if (p == DDT_PHYS_DITTO) {</span>
<span class="lineNum">    1121 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 53 times"> + </span>]:<span class="lineCov">         53 :                         if (ddt_ditto_copies_needed(ddt, dde, NULL) == 0)</span>
<span class="lineNum">    1122 </span>                :<span class="lineNoCov">          0 :                                 ddt_phys_free(ddt, ddk, ddp, txg);</span>
<span class="lineNum">    1123 </span>                :<span class="lineCov">         53 :                         continue;</span>
<span class="lineNum">    1124 </span>                :            :                 }
<span class="lineNum">    1125 </span>        [<span class="branchCov" title="Branch 0 was taken 2929 times"> + </span><span class="branchCov" title="Branch 1 was taken 5279 times"> + </span>]:<span class="lineCov">       8208 :                 if (ddp-&gt;ddp_refcnt == 0)</span>
<span class="lineNum">    1126 </span>                :<span class="lineCov">       2929 :                         ddt_phys_free(ddt, ddk, ddp, txg);</span>
<span class="lineNum">    1127 </span>                :<span class="lineCov">       8208 :                 total_refcnt += ddp-&gt;ddp_refcnt;</span>
<span class="lineNum">    1128 </span>                :            :         }
<span class="lineNum">    1129 </span>                :            : 
<span class="lineNum">    1130 </span>        [<span class="branchCov" title="Branch 0 was taken 8150 times"> + </span><span class="branchCov" title="Branch 1 was taken 53 times"> + </span>]:<span class="lineCov">       8203 :         if (dde-&gt;dde_phys[DDT_PHYS_DITTO].ddp_phys_birth != 0)</span>
<span class="lineNum">    1131 </span>                :            :                 nclass = DDT_CLASS_DITTO;
<span class="lineNum">    1132 </span>        [<span class="branchCov" title="Branch 0 was taken 8119 times"> + </span><span class="branchCov" title="Branch 1 was taken 31 times"> + </span>]:<span class="lineCov">       8150 :         else if (total_refcnt &gt; 1)</span>
<span class="lineNum">    1133 </span>                :            :                 nclass = DDT_CLASS_DUPLICATE;
<span class="lineNum">    1134 </span>                :            :         else
<span class="lineNum">    1135 </span>                :<span class="lineCov">       8119 :                 nclass = DDT_CLASS_UNIQUE;</span>
<span class="lineNum">    1136 </span>                :            : 
<span class="lineNum">    1137 </span>[<span class="branchCov" title="Branch 0 was taken 2992 times"> + </span><span class="branchCov" title="Branch 1 was taken 5211 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 2950 times"> + </span><span class="branchCov" title="Branch 3 was taken 42 times"> + </span>]:<span class="lineCov">       8203 :         if (otype != DDT_TYPES &amp;&amp;</span>
<span class="lineNum">    1138 </span>        [<span class="branchCov" title="Branch 0 was taken 2929 times"> + </span><span class="branchCov" title="Branch 1 was taken 21 times"> + </span>]:<span class="lineCov">       2950 :             (otype != ntype || oclass != nclass || total_refcnt == 0)) {</span>
<span class="lineNum">    1139 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2971 times"> + </span>]:<span class="lineCov">       2971 :                 VERIFY(ddt_object_remove(ddt, otype, oclass, dde, tx) == 0);</span>
<span class="lineNum">    1140 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2971 times"> + </span>]:<span class="lineCov">       2971 :                 ASSERT(ddt_object_lookup(ddt, otype, oclass, dde) == ENOENT);</span>
<span class="lineNum">    1141 </span>                :            :         }
<span class="lineNum">    1142 </span>                :            : 
<span class="lineNum">    1143 </span>        [<span class="branchCov" title="Branch 0 was taken 5274 times"> + </span><span class="branchCov" title="Branch 1 was taken 2929 times"> + </span>]:<span class="lineCov">       8203 :         if (total_refcnt != 0) {</span>
<span class="lineNum">    1144 </span>                :<span class="lineCov">       5274 :                 dde-&gt;dde_type = ntype;</span>
<span class="lineNum">    1145 </span>                :<span class="lineCov">       5274 :                 dde-&gt;dde_class = nclass;</span>
<span class="lineNum">    1146 </span>                :<span class="lineCov">       5274 :                 ddt_stat_update(ddt, dde, 0);</span>
<span class="lineNum">    1147 </span>        [<span class="branchCov" title="Branch 1 was taken 84 times"> + </span><span class="branchCov" title="Branch 2 was taken 5190 times"> + </span>]:<span class="lineCov">       5274 :                 if (!ddt_object_exists(ddt, ntype, nclass))</span>
<span class="lineNum">    1148 </span>                :<span class="lineCov">         84 :                         ddt_object_create(ddt, ntype, nclass, tx);</span>
<span class="lineNum">    1149 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 5274 times"> + </span>]:<span class="lineCov">       5274 :                 VERIFY(ddt_object_update(ddt, ntype, nclass, dde, tx) == 0);</span>
<span class="lineNum">    1150 </span>                :            : 
<span class="lineNum">    1151 </span>                :            :                 /*
<span class="lineNum">    1152 </span>                :            :                  * If the class changes, the order that we scan this bp
<span class="lineNum">    1153 </span>                :            :                  * changes.  If it decreases, we could miss it, so
<span class="lineNum">    1154 </span>                :            :                  * scan it right now.  (This covers both class changing
<span class="lineNum">    1155 </span>                :            :                  * while we are doing ddt_walk(), and when we are
<span class="lineNum">    1156 </span>                :            :                  * traversing.)
<span class="lineNum">    1157 </span>                :            :                  */
<span class="lineNum">    1158 </span>        [<span class="branchCov" title="Branch 0 was taken 5236 times"> + </span><span class="branchCov" title="Branch 1 was taken 38 times"> + </span>]:<span class="lineCov">       5274 :                 if (nclass &lt; oclass) {</span>
<span class="lineNum">    1159 </span>                :<span class="lineCov">       5236 :                         dsl_scan_ddt_entry(dp-&gt;dp_scan,</span>
<span class="lineNum">    1160 </span>                :            :                             ddt-&gt;ddt_checksum, dde, tx);
<span class="lineNum">    1161 </span>                :            :                 }
<span class="lineNum">    1162 </span>                :            :         }
<span class="lineNum">    1163 </span>                :<span class="lineCov">       8203 : }</span>
<a name="1164"><span class="lineNum">    1164 </span>                :            : </a>
<span class="lineNum">    1165 </span>                :            : static void
<span class="lineNum">    1166 </span>                :<span class="lineCov">     806596 : ddt_sync_table(ddt_t *ddt, dmu_tx_t *tx, uint64_t txg)</span>
<span class="lineNum">    1167 </span>                :            : {
<span class="lineNum">    1168 </span>                :<span class="lineCov">     806596 :         spa_t *spa = ddt-&gt;ddt_spa;</span>
<span class="lineNum">    1169 </span>                :            :         ddt_entry_t *dde;
<span class="lineNum">    1170 </span>                :<span class="lineCov">     806596 :         void *cookie = NULL;</span>
<span class="lineNum">    1171 </span>                :            :         enum ddt_type type;
<span class="lineNum">    1172 </span>                :            :         enum ddt_class class;
<span class="lineNum">    1173 </span>                :            : 
<span class="lineNum">    1174 </span>        [<span class="branchCov" title="Branch 1 was taken 2786 times"> + </span><span class="branchCov" title="Branch 2 was taken 803810 times"> + </span>]:<span class="lineCov">     806596 :         if (avl_numnodes(&amp;ddt-&gt;ddt_tree) == 0)</span>
<span class="lineNum">    1175 </span>                :<span class="lineCov">     803810 :                 return;</span>
<span class="lineNum">    1176 </span>                :            : 
<span class="lineNum">    1177 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2786 times"> + </span>]:<span class="lineCov">       2786 :         ASSERT(spa-&gt;spa_uberblock.ub_version &gt;= SPA_VERSION_DEDUP);</span>
<span class="lineNum">    1178 </span>                :            : 
<span class="lineNum">    1179 </span>        [<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchCov" title="Branch 1 was taken 2768 times"> + </span>]:<span class="lineCov">       2786 :         if (spa-&gt;spa_ddt_stat_object == 0) {</span>
<span class="lineNum">    1180 </span>                :<span class="lineCov">       2786 :                 spa-&gt;spa_ddt_stat_object = zap_create_link(ddt-&gt;ddt_os,</span>
<span class="lineNum">    1181 </span>                :            :                     DMU_OT_DDT_STATS, DMU_POOL_DIRECTORY_OBJECT,
<span class="lineNum">    1182 </span>                :            :                     DMU_POOL_DDT_STATS, tx);
<span class="lineNum">    1183 </span>                :            :         }
<span class="lineNum">    1184 </span>                :            : 
<span class="lineNum">    1185 </span>        [<span class="branchCov" title="Branch 1 was taken 8203 times"> + </span><span class="branchCov" title="Branch 2 was taken 2786 times"> + </span>]:<span class="lineCov">      10989 :         while ((dde = avl_destroy_nodes(&amp;ddt-&gt;ddt_tree, &amp;cookie)) != NULL) {</span>
<span class="lineNum">    1186 </span>                :<span class="lineCov">       8203 :                 ddt_sync_entry(ddt, dde, tx, txg);</span>
<span class="lineNum">    1187 </span>                :<span class="lineCov">       8203 :                 ddt_free(dde);</span>
<span class="lineNum">    1188 </span>                :            :         }
<span class="lineNum">    1189 </span>                :            : 
<span class="lineNum">    1190 </span>        [<span class="branchCov" title="Branch 0 was taken 2786 times"> + </span><span class="branchCov" title="Branch 1 was taken 2786 times"> + </span>]:<span class="lineCov">       5572 :         for (type = 0; type &lt; DDT_TYPES; type++) {</span>
<span class="lineNum">    1191 </span>                :            :                 uint64_t add, count = 0;
<span class="lineNum">    1192 </span>        [<span class="branchCov" title="Branch 0 was taken 8358 times"> + </span><span class="branchCov" title="Branch 1 was taken 2786 times"> + </span>]:<span class="lineCov">      11144 :                 for (class = 0; class &lt; DDT_CLASSES; class++) {</span>
<span class="lineNum">    1193 </span>        [<span class="branchCov" title="Branch 1 was taken 4193 times"> + </span><span class="branchCov" title="Branch 2 was taken 4165 times"> + </span>]:<span class="lineCov">       8358 :                         if (ddt_object_exists(ddt, type, class)) {</span>
<span class="lineNum">    1194 </span>                :<span class="lineCov">       4193 :                                 ddt_object_sync(ddt, type, class, tx);</span>
<span class="lineNum">    1195 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 4193 times"> + </span>]:<span class="lineCov">       4193 :                                 VERIFY(ddt_object_count(ddt, type, class,</span>
<span class="lineNum">    1196 </span>                :            :                                     &amp;add) == 0);
<span class="lineNum">    1197 </span>                :<span class="lineCov">       4193 :                                 count += add;</span>
<span class="lineNum">    1198 </span>                :            :                         }
<span class="lineNum">    1199 </span>                :            :                 }
<span class="lineNum">    1200 </span>        [<span class="branchCov" title="Branch 0 was taken 8358 times"> + </span><span class="branchCov" title="Branch 1 was taken 2786 times"> + </span>]:<span class="lineCov">      11144 :                 for (class = 0; class &lt; DDT_CLASSES; class++) {</span>
<span class="lineNum">    1201 </span>[<span class="branchCov" title="Branch 0 was taken 15 times"> + </span><span class="branchCov" title="Branch 1 was taken 8343 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 5 times"> + </span><span class="branchCov" title="Branch 4 was taken 10 times"> + </span>]:<span class="lineCov">       8358 :                         if (count == 0 &amp;&amp; ddt_object_exists(ddt, type, class))</span>
<span class="lineNum">    1202 </span>                :<span class="lineCov">          5 :                                 ddt_object_destroy(ddt, type, class, tx);</span>
<span class="lineNum">    1203 </span>                :            :                 }
<span class="lineNum">    1204 </span>                :            :         }
<span class="lineNum">    1205 </span>                :            : 
<span class="lineNum">    1206 </span>                :<span class="lineCov">       5572 :         bcopy(ddt-&gt;ddt_histogram, &amp;ddt-&gt;ddt_histogram_cache,</span>
<span class="lineNum">    1207 </span>                :            :             sizeof (ddt-&gt;ddt_histogram));
<span class="lineNum">    1208 </span>                :<span class="lineCov">       2786 :         spa-&gt;spa_dedup_dspace = ~0ULL;</span>
<span class="lineNum">    1209 </span>                :            : }
<a name="1210"><span class="lineNum">    1210 </span>                :            : </a>
<span class="lineNum">    1211 </span>                :            : void
<span class="lineNum">    1212 </span>                :<span class="lineCov">      57614 : ddt_sync(spa_t *spa, uint64_t txg)</span>
<span class="lineNum">    1213 </span>                :            : {
<span class="lineNum">    1214 </span>                :            :         dmu_tx_t *tx;
<span class="lineNum">    1215 </span>                :<span class="lineCov">      57614 :         zio_t *rio = zio_root(spa, NULL, NULL,</span>
<span class="lineNum">    1216 </span>                :            :             ZIO_FLAG_CANFAIL | ZIO_FLAG_SPECULATIVE);
<span class="lineNum">    1217 </span>                :            :         enum zio_checksum c;
<span class="lineNum">    1218 </span>                :            : 
<span class="lineNum">    1219 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 57614 times"> + </span>]:<span class="lineCov">      57614 :         ASSERT(spa_syncing_txg(spa) == txg);</span>
<span class="lineNum">    1220 </span>                :            : 
<span class="lineNum">    1221 </span>                :<span class="lineCov">      57614 :         tx = dmu_tx_create_assigned(spa-&gt;spa_dsl_pool, txg);</span>
<span class="lineNum">    1222 </span>                :            : 
<span class="lineNum">    1223 </span>        [<span class="branchCov" title="Branch 1 was taken 806596 times"> + </span><span class="branchCov" title="Branch 2 was taken 57614 times"> + </span>]:<span class="lineCov">     864210 :         for (c = 0; c &lt; ZIO_CHECKSUM_FUNCTIONS; c++) {</span>
<span class="lineNum">    1224 </span>                :<span class="lineCov">     806596 :                 ddt_t *ddt = spa-&gt;spa_ddt[c];</span>
<span class="lineNum">    1225 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 806596 times"> + </span>]:<span class="lineCov">     806596 :                 if (ddt == NULL)</span>
<span class="lineNum">    1226 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    1227 </span>                :<span class="lineCov">     806596 :                 ddt_sync_table(ddt, tx, txg);</span>
<span class="lineNum">    1228 </span>                :<span class="lineCov">     806596 :                 ddt_repair_table(ddt, rio);</span>
<span class="lineNum">    1229 </span>                :            :         }
<span class="lineNum">    1230 </span>                :            : 
<span class="lineNum">    1231 </span>                :<span class="lineCov">      57614 :         (void) zio_wait(rio);</span>
<span class="lineNum">    1232 </span>                :            : 
<span class="lineNum">    1233 </span>                :<span class="lineCov">      57614 :         dmu_tx_commit(tx);</span>
<span class="lineNum">    1234 </span>                :<span class="lineCov">      57614 : }</span>
<a name="1235"><span class="lineNum">    1235 </span>                :            : </a>
<span class="lineNum">    1236 </span>                :            : int
<span class="lineNum">    1237 </span>                :<span class="lineCov">       1615 : ddt_walk(spa_t *spa, ddt_bookmark_t *ddb, ddt_entry_t *dde)</span>
<span class="lineNum">    1238 </span>                :            : {
<span class="lineNum">    1239 </span>                :            :         do {
<span class="lineNum">    1240 </span>                :            :                 do {
<span class="lineNum">    1241 </span>                :            :                         do {
<span class="lineNum">    1242 </span>                :<span class="lineCov">      11651 :                                 ddt_t *ddt = spa-&gt;spa_ddt[ddb-&gt;ddb_checksum];</span>
<span class="lineNum">    1243 </span>                :<span class="lineCov">      11651 :                                 int error = ENOENT;</span>
<span class="lineNum">    1244 </span>        [<span class="branchCov" title="Branch 1 was taken 558 times"> + </span><span class="branchCov" title="Branch 2 was taken 11093 times"> + </span>]:<span class="lineCov">      11651 :                                 if (ddt_object_exists(ddt, ddb-&gt;ddb_type,</span>
<span class="lineNum">    1245 </span>                :<span class="lineCov">      11651 :                                     ddb-&gt;ddb_class)) {</span>
<span class="lineNum">    1246 </span>                :<span class="lineCov">        558 :                                         error = ddt_object_walk(ddt,</span>
<span class="lineNum">    1247 </span>                :<span class="lineCov">       1116 :                                             ddb-&gt;ddb_type, ddb-&gt;ddb_class,</span>
<span class="lineNum">    1248 </span>                :            :                                             &amp;ddb-&gt;ddb_cursor, dde);
<span class="lineNum">    1249 </span>                :            :                                 }
<span class="lineNum">    1250 </span>                :<span class="lineCov">      11651 :                                 dde-&gt;dde_type = ddb-&gt;ddb_type;</span>
<span class="lineNum">    1251 </span>                :<span class="lineCov">      11651 :                                 dde-&gt;dde_class = ddb-&gt;ddb_class;</span>
<span class="lineNum">    1252 </span>        [<span class="branchCov" title="Branch 0 was taken 11254 times"> + </span><span class="branchCov" title="Branch 1 was taken 397 times"> + </span>]:<span class="lineCov">      11651 :                                 if (error == 0)</span>
<span class="lineNum">    1253 </span>                :            :                                         return (0);
<span class="lineNum">    1254 </span>        [<span class="branchCov" title="Branch 0 was taken 11254 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      11254 :                                 if (error != ENOENT)</span>
<span class="lineNum">    1255 </span>                :            :                                         return (error);
<span class="lineNum">    1256 </span>                :<span class="lineCov">      11254 :                                 ddb-&gt;ddb_cursor = 0;</span>
<span class="lineNum">    1257 </span>        [<span class="branchCov" title="Branch 0 was taken 10553 times"> + </span><span class="branchCov" title="Branch 1 was taken 701 times"> + </span>]:<span class="lineCov">      11254 :                         } while (++ddb-&gt;ddb_checksum &lt; ZIO_CHECKSUM_FUNCTIONS);</span>
<span class="lineNum">    1258 </span>                :<span class="lineCov">        701 :                         ddb-&gt;ddb_checksum = 0;</span>
<span class="lineNum">    1259 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 701 times"> + </span>]:<span class="lineCov">        701 :                 } while (++ddb-&gt;ddb_type &lt; DDT_TYPES);</span>
<span class="lineNum">    1260 </span>                :<span class="lineCov">        701 :                 ddb-&gt;ddb_type = 0;</span>
<span class="lineNum">    1261 </span>        [<span class="branchCov" title="Branch 0 was taken 581 times"> + </span><span class="branchCov" title="Branch 1 was taken 120 times"> + </span>]:<span class="lineCov">        701 :         } while (++ddb-&gt;ddb_class &lt; DDT_CLASSES);</span>
<span class="lineNum">    1262 </span>                :            : 
<span class="lineNum">    1263 </span>                :<span class="lineCov">        120 :         return (SET_ERROR(ENOENT));</span>
<span class="lineNum">    1264 </span>                :            : }
<span class="lineNum">    1265 </span>                :            : 
<span class="lineNum">    1266 </span>                :            : #if defined(_KERNEL) &amp;&amp; defined(HAVE_SPL)
<span class="lineNum">    1267 </span>                :            : module_param(zfs_dedup_prefetch, int, 0644);
<span class="lineNum">    1268 </span>                :            : MODULE_PARM_DESC(zfs_dedup_prefetch, &quot;Enable prefetching dedup-ed blks&quot;);
<span class="lineNum">    1269 </span>                :            : #endif
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
