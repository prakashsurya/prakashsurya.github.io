<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - zfs-0.7.0 Code Coverage - /export/home/delphix/zfs/module/zfs/arc.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../../index.html">top level</a> - <a href="index.html">export/home/delphix/zfs/module/zfs</a> - arc.c<span style="font-size: 80%;"> (source / <a href="arc.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">zfs-0.7.0 Code Coverage</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">2271</td>
            <td class="headerCovTableEntry">3077</td>
            <td class="headerCovTableEntryLo">73.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-09-28 14:23:58</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">130</td>
            <td class="headerCovTableEntry">158</td>
            <td class="headerCovTableEntryMed">82.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
            | Branches:
            <span class="coverLegendCov">+</span> taken
            <span class="coverLegendNoCov">-</span> not taken
            <span class="coverLegendNoCov">#</span> not executed
</td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">1419</td>
            <td class="headerCovTableEntry">2813</td>
            <td class="headerCovTableEntryLo">50.4 %</td>
          </tr>
          <tr><td><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : /*</a>
<span class="lineNum">       2 </span>                :            :  * CDDL HEADER START
<span class="lineNum">       3 </span>                :            :  *
<span class="lineNum">       4 </span>                :            :  * The contents of this file are subject to the terms of the
<span class="lineNum">       5 </span>                :            :  * Common Development and Distribution License (the &quot;License&quot;).
<span class="lineNum">       6 </span>                :            :  * You may not use this file except in compliance with the License.
<span class="lineNum">       7 </span>                :            :  *
<span class="lineNum">       8 </span>                :            :  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
<span class="lineNum">       9 </span>                :            :  * or http://www.opensolaris.org/os/licensing.
<span class="lineNum">      10 </span>                :            :  * See the License for the specific language governing permissions
<span class="lineNum">      11 </span>                :            :  * and limitations under the License.
<span class="lineNum">      12 </span>                :            :  *
<span class="lineNum">      13 </span>                :            :  * When distributing Covered Code, include this CDDL HEADER in each
<span class="lineNum">      14 </span>                :            :  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.
<span class="lineNum">      15 </span>                :            :  * If applicable, add the following below this CDDL HEADER, with the
<span class="lineNum">      16 </span>                :            :  * fields enclosed by brackets &quot;[]&quot; replaced with your own identifying
<span class="lineNum">      17 </span>                :            :  * information: Portions Copyright [yyyy] [name of copyright owner]
<span class="lineNum">      18 </span>                :            :  *
<span class="lineNum">      19 </span>                :            :  * CDDL HEADER END
<span class="lineNum">      20 </span>                :            :  */
<span class="lineNum">      21 </span>                :            : /*
<span class="lineNum">      22 </span>                :            :  * Copyright (c) 2005, 2010, Oracle and/or its affiliates. All rights reserved.
<span class="lineNum">      23 </span>                :            :  * Copyright (c) 2012, Joyent, Inc. All rights reserved.
<span class="lineNum">      24 </span>                :            :  * Copyright (c) 2011, 2017 by Delphix. All rights reserved.
<span class="lineNum">      25 </span>                :            :  * Copyright (c) 2014 by Saso Kiselkov. All rights reserved.
<span class="lineNum">      26 </span>                :            :  * Copyright 2015 Nexenta Systems, Inc.  All rights reserved.
<span class="lineNum">      27 </span>                :            :  */
<span class="lineNum">      28 </span>                :            : 
<span class="lineNum">      29 </span>                :            : /*
<span class="lineNum">      30 </span>                :            :  * DVA-based Adjustable Replacement Cache
<span class="lineNum">      31 </span>                :            :  *
<span class="lineNum">      32 </span>                :            :  * While much of the theory of operation used here is
<span class="lineNum">      33 </span>                :            :  * based on the self-tuning, low overhead replacement cache
<span class="lineNum">      34 </span>                :            :  * presented by Megiddo and Modha at FAST 2003, there are some
<span class="lineNum">      35 </span>                :            :  * significant differences:
<span class="lineNum">      36 </span>                :            :  *
<span class="lineNum">      37 </span>                :            :  * 1. The Megiddo and Modha model assumes any page is evictable.
<span class="lineNum">      38 </span>                :            :  * Pages in its cache cannot be &quot;locked&quot; into memory.  This makes
<span class="lineNum">      39 </span>                :            :  * the eviction algorithm simple: evict the last page in the list.
<span class="lineNum">      40 </span>                :            :  * This also make the performance characteristics easy to reason
<span class="lineNum">      41 </span>                :            :  * about.  Our cache is not so simple.  At any given moment, some
<span class="lineNum">      42 </span>                :            :  * subset of the blocks in the cache are un-evictable because we
<span class="lineNum">      43 </span>                :            :  * have handed out a reference to them.  Blocks are only evictable
<span class="lineNum">      44 </span>                :            :  * when there are no external references active.  This makes
<span class="lineNum">      45 </span>                :            :  * eviction far more problematic:  we choose to evict the evictable
<span class="lineNum">      46 </span>                :            :  * blocks that are the &quot;lowest&quot; in the list.
<span class="lineNum">      47 </span>                :            :  *
<span class="lineNum">      48 </span>                :            :  * There are times when it is not possible to evict the requested
<span class="lineNum">      49 </span>                :            :  * space.  In these circumstances we are unable to adjust the cache
<span class="lineNum">      50 </span>                :            :  * size.  To prevent the cache growing unbounded at these times we
<span class="lineNum">      51 </span>                :            :  * implement a &quot;cache throttle&quot; that slows the flow of new data
<span class="lineNum">      52 </span>                :            :  * into the cache until we can make space available.
<span class="lineNum">      53 </span>                :            :  *
<span class="lineNum">      54 </span>                :            :  * 2. The Megiddo and Modha model assumes a fixed cache size.
<span class="lineNum">      55 </span>                :            :  * Pages are evicted when the cache is full and there is a cache
<span class="lineNum">      56 </span>                :            :  * miss.  Our model has a variable sized cache.  It grows with
<span class="lineNum">      57 </span>                :            :  * high use, but also tries to react to memory pressure from the
<span class="lineNum">      58 </span>                :            :  * operating system: decreasing its size when system memory is
<span class="lineNum">      59 </span>                :            :  * tight.
<span class="lineNum">      60 </span>                :            :  *
<span class="lineNum">      61 </span>                :            :  * 3. The Megiddo and Modha model assumes a fixed page size. All
<span class="lineNum">      62 </span>                :            :  * elements of the cache are therefore exactly the same size.  So
<span class="lineNum">      63 </span>                :            :  * when adjusting the cache size following a cache miss, its simply
<span class="lineNum">      64 </span>                :            :  * a matter of choosing a single page to evict.  In our model, we
<span class="lineNum">      65 </span>                :            :  * have variable sized cache blocks (rangeing from 512 bytes to
<span class="lineNum">      66 </span>                :            :  * 128K bytes).  We therefore choose a set of blocks to evict to make
<span class="lineNum">      67 </span>                :            :  * space for a cache miss that approximates as closely as possible
<span class="lineNum">      68 </span>                :            :  * the space used by the new block.
<span class="lineNum">      69 </span>                :            :  *
<span class="lineNum">      70 </span>                :            :  * See also:  &quot;ARC: A Self-Tuning, Low Overhead Replacement Cache&quot;
<span class="lineNum">      71 </span>                :            :  * by N. Megiddo &amp; D. Modha, FAST 2003
<span class="lineNum">      72 </span>                :            :  */
<span class="lineNum">      73 </span>                :            : 
<span class="lineNum">      74 </span>                :            : /*
<span class="lineNum">      75 </span>                :            :  * The locking model:
<span class="lineNum">      76 </span>                :            :  *
<span class="lineNum">      77 </span>                :            :  * A new reference to a cache buffer can be obtained in two
<span class="lineNum">      78 </span>                :            :  * ways: 1) via a hash table lookup using the DVA as a key,
<span class="lineNum">      79 </span>                :            :  * or 2) via one of the ARC lists.  The arc_read() interface
<span class="lineNum">      80 </span>                :            :  * uses method 1, while the internal ARC algorithms for
<span class="lineNum">      81 </span>                :            :  * adjusting the cache use method 2.  We therefore provide two
<span class="lineNum">      82 </span>                :            :  * types of locks: 1) the hash table lock array, and 2) the
<span class="lineNum">      83 </span>                :            :  * ARC list locks.
<span class="lineNum">      84 </span>                :            :  *
<span class="lineNum">      85 </span>                :            :  * Buffers do not have their own mutexes, rather they rely on the
<span class="lineNum">      86 </span>                :            :  * hash table mutexes for the bulk of their protection (i.e. most
<span class="lineNum">      87 </span>                :            :  * fields in the arc_buf_hdr_t are protected by these mutexes).
<span class="lineNum">      88 </span>                :            :  *
<span class="lineNum">      89 </span>                :            :  * buf_hash_find() returns the appropriate mutex (held) when it
<span class="lineNum">      90 </span>                :            :  * locates the requested buffer in the hash table.  It returns
<span class="lineNum">      91 </span>                :            :  * NULL for the mutex if the buffer was not in the table.
<span class="lineNum">      92 </span>                :            :  *
<span class="lineNum">      93 </span>                :            :  * buf_hash_remove() expects the appropriate hash mutex to be
<span class="lineNum">      94 </span>                :            :  * already held before it is invoked.
<span class="lineNum">      95 </span>                :            :  *
<span class="lineNum">      96 </span>                :            :  * Each ARC state also has a mutex which is used to protect the
<span class="lineNum">      97 </span>                :            :  * buffer list associated with the state.  When attempting to
<span class="lineNum">      98 </span>                :            :  * obtain a hash table lock while holding an ARC list lock you
<span class="lineNum">      99 </span>                :            :  * must use: mutex_tryenter() to avoid deadlock.  Also note that
<span class="lineNum">     100 </span>                :            :  * the active state mutex must be held before the ghost state mutex.
<span class="lineNum">     101 </span>                :            :  *
<span class="lineNum">     102 </span>                :            :  * It as also possible to register a callback which is run when the
<span class="lineNum">     103 </span>                :            :  * arc_meta_limit is reached and no buffers can be safely evicted.  In
<span class="lineNum">     104 </span>                :            :  * this case the arc user should drop a reference on some arc buffers so
<span class="lineNum">     105 </span>                :            :  * they can be reclaimed and the arc_meta_limit honored.  For example,
<span class="lineNum">     106 </span>                :            :  * when using the ZPL each dentry holds a references on a znode.  These
<span class="lineNum">     107 </span>                :            :  * dentries must be pruned before the arc buffer holding the znode can
<span class="lineNum">     108 </span>                :            :  * be safely evicted.
<span class="lineNum">     109 </span>                :            :  *
<span class="lineNum">     110 </span>                :            :  * Note that the majority of the performance stats are manipulated
<span class="lineNum">     111 </span>                :            :  * with atomic operations.
<span class="lineNum">     112 </span>                :            :  *
<span class="lineNum">     113 </span>                :            :  * The L2ARC uses the l2ad_mtx on each vdev for the following:
<span class="lineNum">     114 </span>                :            :  *
<span class="lineNum">     115 </span>                :            :  *      - L2ARC buflist creation
<span class="lineNum">     116 </span>                :            :  *      - L2ARC buflist eviction
<span class="lineNum">     117 </span>                :            :  *      - L2ARC write completion, which walks L2ARC buflists
<span class="lineNum">     118 </span>                :            :  *      - ARC header destruction, as it removes from L2ARC buflists
<span class="lineNum">     119 </span>                :            :  *      - ARC header release, as it removes from L2ARC buflists
<span class="lineNum">     120 </span>                :            :  */
<span class="lineNum">     121 </span>                :            : 
<span class="lineNum">     122 </span>                :            : /*
<span class="lineNum">     123 </span>                :            :  * ARC operation:
<span class="lineNum">     124 </span>                :            :  *
<span class="lineNum">     125 </span>                :            :  * Every block that is in the ARC is tracked by an arc_buf_hdr_t structure.
<span class="lineNum">     126 </span>                :            :  * This structure can point either to a block that is still in the cache or to
<span class="lineNum">     127 </span>                :            :  * one that is only accessible in an L2 ARC device, or it can provide
<span class="lineNum">     128 </span>                :            :  * information about a block that was recently evicted. If a block is
<span class="lineNum">     129 </span>                :            :  * only accessible in the L2ARC, then the arc_buf_hdr_t only has enough
<span class="lineNum">     130 </span>                :            :  * information to retrieve it from the L2ARC device. This information is
<span class="lineNum">     131 </span>                :            :  * stored in the l2arc_buf_hdr_t sub-structure of the arc_buf_hdr_t. A block
<span class="lineNum">     132 </span>                :            :  * that is in this state cannot access the data directly.
<span class="lineNum">     133 </span>                :            :  *
<span class="lineNum">     134 </span>                :            :  * Blocks that are actively being referenced or have not been evicted
<span class="lineNum">     135 </span>                :            :  * are cached in the L1ARC. The L1ARC (l1arc_buf_hdr_t) is a structure within
<span class="lineNum">     136 </span>                :            :  * the arc_buf_hdr_t that will point to the data block in memory. A block can
<span class="lineNum">     137 </span>                :            :  * only be read by a consumer if it has an l1arc_buf_hdr_t. The L1ARC
<span class="lineNum">     138 </span>                :            :  * caches data in two ways -- in a list of ARC buffers (arc_buf_t) and
<span class="lineNum">     139 </span>                :            :  * also in the arc_buf_hdr_t's private physical data block pointer (b_pabd).
<span class="lineNum">     140 </span>                :            :  *
<span class="lineNum">     141 </span>                :            :  * The L1ARC's data pointer may or may not be uncompressed. The ARC has the
<span class="lineNum">     142 </span>                :            :  * ability to store the physical data (b_pabd) associated with the DVA of the
<span class="lineNum">     143 </span>                :            :  * arc_buf_hdr_t. Since the b_pabd is a copy of the on-disk physical block,
<span class="lineNum">     144 </span>                :            :  * it will match its on-disk compression characteristics. This behavior can be
<span class="lineNum">     145 </span>                :            :  * disabled by setting 'zfs_compressed_arc_enabled' to B_FALSE. When the
<span class="lineNum">     146 </span>                :            :  * compressed ARC functionality is disabled, the b_pabd will point to an
<span class="lineNum">     147 </span>                :            :  * uncompressed version of the on-disk data.
<span class="lineNum">     148 </span>                :            :  *
<span class="lineNum">     149 </span>                :            :  * Data in the L1ARC is not accessed by consumers of the ARC directly. Each
<span class="lineNum">     150 </span>                :            :  * arc_buf_hdr_t can have multiple ARC buffers (arc_buf_t) which reference it.
<span class="lineNum">     151 </span>                :            :  * Each ARC buffer (arc_buf_t) is being actively accessed by a specific ARC
<span class="lineNum">     152 </span>                :            :  * consumer. The ARC will provide references to this data and will keep it
<span class="lineNum">     153 </span>                :            :  * cached until it is no longer in use. The ARC caches only the L1ARC's physical
<span class="lineNum">     154 </span>                :            :  * data block and will evict any arc_buf_t that is no longer referenced. The
<span class="lineNum">     155 </span>                :            :  * amount of memory consumed by the arc_buf_ts' data buffers can be seen via the
<span class="lineNum">     156 </span>                :            :  * &quot;overhead_size&quot; kstat.
<span class="lineNum">     157 </span>                :            :  *
<span class="lineNum">     158 </span>                :            :  * Depending on the consumer, an arc_buf_t can be requested in uncompressed or
<span class="lineNum">     159 </span>                :            :  * compressed form. The typical case is that consumers will want uncompressed
<span class="lineNum">     160 </span>                :            :  * data, and when that happens a new data buffer is allocated where the data is
<span class="lineNum">     161 </span>                :            :  * decompressed for them to use. Currently the only consumer who wants
<span class="lineNum">     162 </span>                :            :  * compressed arc_buf_t's is &quot;zfs send&quot;, when it streams data exactly as it
<span class="lineNum">     163 </span>                :            :  * exists on disk. When this happens, the arc_buf_t's data buffer is shared
<span class="lineNum">     164 </span>                :            :  * with the arc_buf_hdr_t.
<span class="lineNum">     165 </span>                :            :  *
<span class="lineNum">     166 </span>                :            :  * Here is a diagram showing an arc_buf_hdr_t referenced by two arc_buf_t's. The
<span class="lineNum">     167 </span>                :            :  * first one is owned by a compressed send consumer (and therefore references
<span class="lineNum">     168 </span>                :            :  * the same compressed data buffer as the arc_buf_hdr_t) and the second could be
<span class="lineNum">     169 </span>                :            :  * used by any other consumer (and has its own uncompressed copy of the data
<span class="lineNum">     170 </span>                :            :  * buffer).
<span class="lineNum">     171 </span>                :            :  *
<span class="lineNum">     172 </span>                :            :  *   arc_buf_hdr_t
<span class="lineNum">     173 </span>                :            :  *   +-----------+
<span class="lineNum">     174 </span>                :            :  *   | fields    |
<span class="lineNum">     175 </span>                :            :  *   | common to |
<span class="lineNum">     176 </span>                :            :  *   | L1- and   |
<span class="lineNum">     177 </span>                :            :  *   | L2ARC     |
<span class="lineNum">     178 </span>                :            :  *   +-----------+
<span class="lineNum">     179 </span>                :            :  *   | l2arc_buf_hdr_t
<span class="lineNum">     180 </span>                :            :  *   |           |
<span class="lineNum">     181 </span>                :            :  *   +-----------+
<span class="lineNum">     182 </span>                :            :  *   | l1arc_buf_hdr_t
<span class="lineNum">     183 </span>                :            :  *   |           |              arc_buf_t
<span class="lineNum">     184 </span>                :            :  *   | b_buf     +------------&gt;+-----------+      arc_buf_t
<span class="lineNum">     185 </span>                :            :  *   | b_pabd    +-+           |b_next     +----&gt;+-----------+
<span class="lineNum">     186 </span>                :            :  *   +-----------+ |           |-----------|     |b_next     +--&gt;NULL
<span class="lineNum">     187 </span>                :            :  *                 |           |b_comp = T |     +-----------+
<span class="lineNum">     188 </span>                :            :  *                 |           |b_data     +-+   |b_comp = F |
<span class="lineNum">     189 </span>                :            :  *                 |           +-----------+ |   |b_data     +-+
<span class="lineNum">     190 </span>                :            :  *                 +-&gt;+------+               |   +-----------+ |
<span class="lineNum">     191 </span>                :            :  *        compressed  |      |               |                 |
<span class="lineNum">     192 </span>                :            :  *           data     |      |&lt;--------------+                 | uncompressed
<span class="lineNum">     193 </span>                :            :  *                    +------+          compressed,            |     data
<span class="lineNum">     194 </span>                :            :  *                                        shared               +--&gt;+------+
<span class="lineNum">     195 </span>                :            :  *                                         data                    |      |
<span class="lineNum">     196 </span>                :            :  *                                                                 |      |
<span class="lineNum">     197 </span>                :            :  *                                                                 +------+
<span class="lineNum">     198 </span>                :            :  *
<span class="lineNum">     199 </span>                :            :  * When a consumer reads a block, the ARC must first look to see if the
<span class="lineNum">     200 </span>                :            :  * arc_buf_hdr_t is cached. If the hdr is cached then the ARC allocates a new
<span class="lineNum">     201 </span>                :            :  * arc_buf_t and either copies uncompressed data into a new data buffer from an
<span class="lineNum">     202 </span>                :            :  * existing uncompressed arc_buf_t, decompresses the hdr's b_pabd buffer into a
<span class="lineNum">     203 </span>                :            :  * new data buffer, or shares the hdr's b_pabd buffer, depending on whether the
<span class="lineNum">     204 </span>                :            :  * hdr is compressed and the desired compression characteristics of the
<span class="lineNum">     205 </span>                :            :  * arc_buf_t consumer. If the arc_buf_t ends up sharing data with the
<span class="lineNum">     206 </span>                :            :  * arc_buf_hdr_t and both of them are uncompressed then the arc_buf_t must be
<span class="lineNum">     207 </span>                :            :  * the last buffer in the hdr's b_buf list, however a shared compressed buf can
<span class="lineNum">     208 </span>                :            :  * be anywhere in the hdr's list.
<span class="lineNum">     209 </span>                :            :  *
<span class="lineNum">     210 </span>                :            :  * The diagram below shows an example of an uncompressed ARC hdr that is
<span class="lineNum">     211 </span>                :            :  * sharing its data with an arc_buf_t (note that the shared uncompressed buf is
<span class="lineNum">     212 </span>                :            :  * the last element in the buf list):
<span class="lineNum">     213 </span>                :            :  *
<span class="lineNum">     214 </span>                :            :  *                arc_buf_hdr_t
<span class="lineNum">     215 </span>                :            :  *                +-----------+
<span class="lineNum">     216 </span>                :            :  *                |           |
<span class="lineNum">     217 </span>                :            :  *                |           |
<span class="lineNum">     218 </span>                :            :  *                |           |
<span class="lineNum">     219 </span>                :            :  *                +-----------+
<span class="lineNum">     220 </span>                :            :  * l2arc_buf_hdr_t|           |
<span class="lineNum">     221 </span>                :            :  *                |           |
<span class="lineNum">     222 </span>                :            :  *                +-----------+
<span class="lineNum">     223 </span>                :            :  * l1arc_buf_hdr_t|           |
<span class="lineNum">     224 </span>                :            :  *                |           |                 arc_buf_t    (shared)
<span class="lineNum">     225 </span>                :            :  *                |    b_buf  +------------&gt;+---------+      arc_buf_t
<span class="lineNum">     226 </span>                :            :  *                |           |             |b_next   +----&gt;+---------+
<span class="lineNum">     227 </span>                :            :  *                |  b_pabd   +-+           |---------|     |b_next   +--&gt;NULL
<span class="lineNum">     228 </span>                :            :  *                +-----------+ |           |         |     +---------+
<span class="lineNum">     229 </span>                :            :  *                              |           |b_data   +-+   |         |
<span class="lineNum">     230 </span>                :            :  *                              |           +---------+ |   |b_data   +-+
<span class="lineNum">     231 </span>                :            :  *                              +-&gt;+------+             |   +---------+ |
<span class="lineNum">     232 </span>                :            :  *                                 |      |             |               |
<span class="lineNum">     233 </span>                :            :  *                   uncompressed  |      |             |               |
<span class="lineNum">     234 </span>                :            :  *                        data     +------+             |               |
<span class="lineNum">     235 </span>                :            :  *                                    ^                 +-&gt;+------+     |
<span class="lineNum">     236 </span>                :            :  *                                    |       uncompressed |      |     |
<span class="lineNum">     237 </span>                :            :  *                                    |           data     |      |     |
<span class="lineNum">     238 </span>                :            :  *                                    |                    +------+     |
<span class="lineNum">     239 </span>                :            :  *                                    +---------------------------------+
<span class="lineNum">     240 </span>                :            :  *
<span class="lineNum">     241 </span>                :            :  * Writing to the ARC requires that the ARC first discard the hdr's b_pabd
<span class="lineNum">     242 </span>                :            :  * since the physical block is about to be rewritten. The new data contents
<span class="lineNum">     243 </span>                :            :  * will be contained in the arc_buf_t. As the I/O pipeline performs the write,
<span class="lineNum">     244 </span>                :            :  * it may compress the data before writing it to disk. The ARC will be called
<span class="lineNum">     245 </span>                :            :  * with the transformed data and will bcopy the transformed on-disk block into
<span class="lineNum">     246 </span>                :            :  * a newly allocated b_pabd. Writes are always done into buffers which have
<span class="lineNum">     247 </span>                :            :  * either been loaned (and hence are new and don't have other readers) or
<span class="lineNum">     248 </span>                :            :  * buffers which have been released (and hence have their own hdr, if there
<span class="lineNum">     249 </span>                :            :  * were originally other readers of the buf's original hdr). This ensures that
<span class="lineNum">     250 </span>                :            :  * the ARC only needs to update a single buf and its hdr after a write occurs.
<span class="lineNum">     251 </span>                :            :  *
<span class="lineNum">     252 </span>                :            :  * When the L2ARC is in use, it will also take advantage of the b_pabd. The
<span class="lineNum">     253 </span>                :            :  * L2ARC will always write the contents of b_pabd to the L2ARC. This means
<span class="lineNum">     254 </span>                :            :  * that when compressed ARC is enabled that the L2ARC blocks are identical
<span class="lineNum">     255 </span>                :            :  * to the on-disk block in the main data pool. This provides a significant
<span class="lineNum">     256 </span>                :            :  * advantage since the ARC can leverage the bp's checksum when reading from the
<span class="lineNum">     257 </span>                :            :  * L2ARC to determine if the contents are valid. However, if the compressed
<span class="lineNum">     258 </span>                :            :  * ARC is disabled, then the L2ARC's block must be transformed to look
<span class="lineNum">     259 </span>                :            :  * like the physical block in the main data pool before comparing the
<span class="lineNum">     260 </span>                :            :  * checksum and determining its validity.
<span class="lineNum">     261 </span>                :            :  *
<span class="lineNum">     262 </span>                :            :  * The L1ARC has a slightly different system for storing encrypted data.
<span class="lineNum">     263 </span>                :            :  * Raw (encrypted + possibly compressed) data has a few subtle differences from
<span class="lineNum">     264 </span>                :            :  * data that is just compressed. The biggest difference is that it is not
<span class="lineNum">     265 </span>                :            :  * possible to decrypt encrypted data (or visa versa) if the keys aren't loaded.
<span class="lineNum">     266 </span>                :            :  * The other difference is that encryption cannot be treated as a suggestion.
<span class="lineNum">     267 </span>                :            :  * If a caller would prefer compressed data, but they actually wind up with
<span class="lineNum">     268 </span>                :            :  * uncompressed data the worst thing that could happen is there might be a
<span class="lineNum">     269 </span>                :            :  * performance hit. If the caller requests encrypted data, however, we must be
<span class="lineNum">     270 </span>                :            :  * sure they actually get it or else secret information could be leaked. Raw
<span class="lineNum">     271 </span>                :            :  * data is stored in hdr-&gt;b_crypt_hdr.b_rabd. An encrypted header, therefore,
<span class="lineNum">     272 </span>                :            :  * may have both an encrypted version and a decrypted version of its data at
<span class="lineNum">     273 </span>                :            :  * once. When a caller needs a raw arc_buf_t, it is allocated and the data is
<span class="lineNum">     274 </span>                :            :  * copied out of this header. To avoid complications with b_pabd, raw buffers
<span class="lineNum">     275 </span>                :            :  * cannot be shared.
<span class="lineNum">     276 </span>                :            :  */
<span class="lineNum">     277 </span>                :            : 
<span class="lineNum">     278 </span>                :            : #include &lt;sys/spa.h&gt;
<span class="lineNum">     279 </span>                :            : #include &lt;sys/zio.h&gt;
<span class="lineNum">     280 </span>                :            : #include &lt;sys/spa_impl.h&gt;
<span class="lineNum">     281 </span>                :            : #include &lt;sys/zio_compress.h&gt;
<span class="lineNum">     282 </span>                :            : #include &lt;sys/zio_checksum.h&gt;
<span class="lineNum">     283 </span>                :            : #include &lt;sys/zfs_context.h&gt;
<span class="lineNum">     284 </span>                :            : #include &lt;sys/arc.h&gt;
<span class="lineNum">     285 </span>                :            : #include &lt;sys/refcount.h&gt;
<span class="lineNum">     286 </span>                :            : #include &lt;sys/vdev.h&gt;
<span class="lineNum">     287 </span>                :            : #include &lt;sys/vdev_impl.h&gt;
<span class="lineNum">     288 </span>                :            : #include &lt;sys/dsl_pool.h&gt;
<span class="lineNum">     289 </span>                :            : #include &lt;sys/zio_checksum.h&gt;
<span class="lineNum">     290 </span>                :            : #include &lt;sys/multilist.h&gt;
<span class="lineNum">     291 </span>                :            : #include &lt;sys/abd.h&gt;
<span class="lineNum">     292 </span>                :            : #include &lt;sys/zil.h&gt;
<span class="lineNum">     293 </span>                :            : #include &lt;sys/fm/fs/zfs.h&gt;
<span class="lineNum">     294 </span>                :            : #ifdef _KERNEL
<span class="lineNum">     295 </span>                :            : #include &lt;sys/vmsystm.h&gt;
<span class="lineNum">     296 </span>                :            : #include &lt;vm/anon.h&gt;
<span class="lineNum">     297 </span>                :            : #include &lt;sys/fs/swapnode.h&gt;
<span class="lineNum">     298 </span>                :            : #include &lt;sys/zpl.h&gt;
<span class="lineNum">     299 </span>                :            : #include &lt;linux/mm_compat.h&gt;
<span class="lineNum">     300 </span>                :            : #endif
<span class="lineNum">     301 </span>                :            : #include &lt;sys/callb.h&gt;
<span class="lineNum">     302 </span>                :            : #include &lt;sys/kstat.h&gt;
<span class="lineNum">     303 </span>                :            : #include &lt;sys/dmu_tx.h&gt;
<span class="lineNum">     304 </span>                :            : #include &lt;zfs_fletcher.h&gt;
<span class="lineNum">     305 </span>                :            : #include &lt;sys/arc_impl.h&gt;
<span class="lineNum">     306 </span>                :            : #include &lt;sys/trace_arc.h&gt;
<span class="lineNum">     307 </span>                :            : 
<span class="lineNum">     308 </span>                :            : #ifndef _KERNEL
<span class="lineNum">     309 </span>                :            : /* set with ZFS_DEBUG=watch, to enable watchpoints on frozen buffers */
<span class="lineNum">     310 </span>                :            : boolean_t arc_watch = B_FALSE;
<span class="lineNum">     311 </span>                :            : #endif
<span class="lineNum">     312 </span>                :            : 
<span class="lineNum">     313 </span>                :            : static kmutex_t         arc_reclaim_lock;
<span class="lineNum">     314 </span>                :            : static kcondvar_t       arc_reclaim_thread_cv;
<span class="lineNum">     315 </span>                :            : static boolean_t        arc_reclaim_thread_exit;
<span class="lineNum">     316 </span>                :            : static kcondvar_t       arc_reclaim_waiters_cv;
<span class="lineNum">     317 </span>                :            : 
<span class="lineNum">     318 </span>                :            : /*
<span class="lineNum">     319 </span>                :            :  * The number of headers to evict in arc_evict_state_impl() before
<span class="lineNum">     320 </span>                :            :  * dropping the sublist lock and evicting from another sublist. A lower
<span class="lineNum">     321 </span>                :            :  * value means we're more likely to evict the &quot;correct&quot; header (i.e. the
<span class="lineNum">     322 </span>                :            :  * oldest header in the arc state), but comes with higher overhead
<span class="lineNum">     323 </span>                :            :  * (i.e. more invocations of arc_evict_state_impl()).
<span class="lineNum">     324 </span>                :            :  */
<span class="lineNum">     325 </span>                :            : int zfs_arc_evict_batch_limit = 10;
<span class="lineNum">     326 </span>                :            : 
<span class="lineNum">     327 </span>                :            : /* number of seconds before growing cache again */
<span class="lineNum">     328 </span>                :            : static int              arc_grow_retry = 5;
<span class="lineNum">     329 </span>                :            : 
<span class="lineNum">     330 </span>                :            : /* shift of arc_c for calculating overflow limit in arc_get_data_impl */
<span class="lineNum">     331 </span>                :            : int             zfs_arc_overflow_shift = 8;
<span class="lineNum">     332 </span>                :            : 
<span class="lineNum">     333 </span>                :            : /* shift of arc_c for calculating both min and max arc_p */
<span class="lineNum">     334 </span>                :            : static int              arc_p_min_shift = 4;
<span class="lineNum">     335 </span>                :            : 
<span class="lineNum">     336 </span>                :            : /* log2(fraction of arc to reclaim) */
<span class="lineNum">     337 </span>                :            : static int              arc_shrink_shift = 7;
<span class="lineNum">     338 </span>                :            : 
<span class="lineNum">     339 </span>                :            : /* percent of pagecache to reclaim arc to */
<span class="lineNum">     340 </span>                :            : #ifdef _KERNEL
<span class="lineNum">     341 </span>                :            : static uint_t           zfs_arc_pc_percent = 0;
<span class="lineNum">     342 </span>                :            : #endif
<span class="lineNum">     343 </span>                :            : 
<span class="lineNum">     344 </span>                :            : /*
<span class="lineNum">     345 </span>                :            :  * log2(fraction of ARC which must be free to allow growing).
<span class="lineNum">     346 </span>                :            :  * I.e. If there is less than arc_c &gt;&gt; arc_no_grow_shift free memory,
<span class="lineNum">     347 </span>                :            :  * when reading a new block into the ARC, we will evict an equal-sized block
<span class="lineNum">     348 </span>                :            :  * from the ARC.
<span class="lineNum">     349 </span>                :            :  *
<span class="lineNum">     350 </span>                :            :  * This must be less than arc_shrink_shift, so that when we shrink the ARC,
<span class="lineNum">     351 </span>                :            :  * we will still not allow it to grow.
<span class="lineNum">     352 </span>                :            :  */
<span class="lineNum">     353 </span>                :            : int                     arc_no_grow_shift = 5;
<span class="lineNum">     354 </span>                :            : 
<span class="lineNum">     355 </span>                :            : 
<span class="lineNum">     356 </span>                :            : /*
<span class="lineNum">     357 </span>                :            :  * minimum lifespan of a prefetch block in clock ticks
<span class="lineNum">     358 </span>                :            :  * (initialized in arc_init())
<span class="lineNum">     359 </span>                :            :  */
<span class="lineNum">     360 </span>                :            : static int              arc_min_prefetch_lifespan;
<span class="lineNum">     361 </span>                :            : 
<span class="lineNum">     362 </span>                :            : /*
<span class="lineNum">     363 </span>                :            :  * If this percent of memory is free, don't throttle.
<span class="lineNum">     364 </span>                :            :  */
<span class="lineNum">     365 </span>                :            : int arc_lotsfree_percent = 10;
<span class="lineNum">     366 </span>                :            : 
<span class="lineNum">     367 </span>                :            : static int arc_dead;
<span class="lineNum">     368 </span>                :            : 
<span class="lineNum">     369 </span>                :            : /*
<span class="lineNum">     370 </span>                :            :  * The arc has filled available memory and has now warmed up.
<span class="lineNum">     371 </span>                :            :  */
<span class="lineNum">     372 </span>                :            : static boolean_t arc_warm;
<span class="lineNum">     373 </span>                :            : 
<span class="lineNum">     374 </span>                :            : /*
<span class="lineNum">     375 </span>                :            :  * log2 fraction of the zio arena to keep free.
<span class="lineNum">     376 </span>                :            :  */
<span class="lineNum">     377 </span>                :            : int arc_zio_arena_free_shift = 2;
<span class="lineNum">     378 </span>                :            : 
<span class="lineNum">     379 </span>                :            : /*
<span class="lineNum">     380 </span>                :            :  * These tunables are for performance analysis.
<span class="lineNum">     381 </span>                :            :  */
<span class="lineNum">     382 </span>                :            : unsigned long zfs_arc_max = 0;
<span class="lineNum">     383 </span>                :            : unsigned long zfs_arc_min = 0;
<span class="lineNum">     384 </span>                :            : unsigned long zfs_arc_meta_limit = 0;
<span class="lineNum">     385 </span>                :            : unsigned long zfs_arc_meta_min = 0;
<span class="lineNum">     386 </span>                :            : unsigned long zfs_arc_dnode_limit = 0;
<span class="lineNum">     387 </span>                :            : unsigned long zfs_arc_dnode_reduce_percent = 10;
<span class="lineNum">     388 </span>                :            : int zfs_arc_grow_retry = 0;
<span class="lineNum">     389 </span>                :            : int zfs_arc_shrink_shift = 0;
<span class="lineNum">     390 </span>                :            : int zfs_arc_p_min_shift = 0;
<span class="lineNum">     391 </span>                :            : int zfs_arc_average_blocksize = 8 * 1024; /* 8KB */
<span class="lineNum">     392 </span>                :            : 
<span class="lineNum">     393 </span>                :            : int zfs_compressed_arc_enabled = B_TRUE;
<span class="lineNum">     394 </span>                :            : 
<span class="lineNum">     395 </span>                :            : /*
<span class="lineNum">     396 </span>                :            :  * ARC will evict meta buffers that exceed arc_meta_limit. This
<span class="lineNum">     397 </span>                :            :  * tunable make arc_meta_limit adjustable for different workloads.
<span class="lineNum">     398 </span>                :            :  */
<span class="lineNum">     399 </span>                :            : unsigned long zfs_arc_meta_limit_percent = 75;
<span class="lineNum">     400 </span>                :            : 
<span class="lineNum">     401 </span>                :            : /*
<span class="lineNum">     402 </span>                :            :  * Percentage that can be consumed by dnodes of ARC meta buffers.
<span class="lineNum">     403 </span>                :            :  */
<span class="lineNum">     404 </span>                :            : unsigned long zfs_arc_dnode_limit_percent = 10;
<span class="lineNum">     405 </span>                :            : 
<span class="lineNum">     406 </span>                :            : /*
<span class="lineNum">     407 </span>                :            :  * These tunables are Linux specific
<span class="lineNum">     408 </span>                :            :  */
<span class="lineNum">     409 </span>                :            : unsigned long zfs_arc_sys_free = 0;
<span class="lineNum">     410 </span>                :            : int zfs_arc_min_prefetch_lifespan = 0;
<span class="lineNum">     411 </span>                :            : int zfs_arc_p_aggressive_disable = 1;
<span class="lineNum">     412 </span>                :            : int zfs_arc_p_dampener_disable = 1;
<span class="lineNum">     413 </span>                :            : int zfs_arc_meta_prune = 10000;
<span class="lineNum">     414 </span>                :            : int zfs_arc_meta_strategy = ARC_STRATEGY_META_BALANCED;
<span class="lineNum">     415 </span>                :            : int zfs_arc_meta_adjust_restarts = 4096;
<span class="lineNum">     416 </span>                :            : int zfs_arc_lotsfree_percent = 10;
<span class="lineNum">     417 </span>                :            : 
<span class="lineNum">     418 </span>                :            : /* The 6 states: */
<span class="lineNum">     419 </span>                :            : static arc_state_t ARC_anon;
<span class="lineNum">     420 </span>                :            : static arc_state_t ARC_mru;
<span class="lineNum">     421 </span>                :            : static arc_state_t ARC_mru_ghost;
<span class="lineNum">     422 </span>                :            : static arc_state_t ARC_mfu;
<span class="lineNum">     423 </span>                :            : static arc_state_t ARC_mfu_ghost;
<span class="lineNum">     424 </span>                :            : static arc_state_t ARC_l2c_only;
<span class="lineNum">     425 </span>                :            : 
<span class="lineNum">     426 </span>                :            : typedef struct arc_stats {
<span class="lineNum">     427 </span>                :            :         kstat_named_t arcstat_hits;
<span class="lineNum">     428 </span>                :            :         kstat_named_t arcstat_misses;
<span class="lineNum">     429 </span>                :            :         kstat_named_t arcstat_demand_data_hits;
<span class="lineNum">     430 </span>                :            :         kstat_named_t arcstat_demand_data_misses;
<span class="lineNum">     431 </span>                :            :         kstat_named_t arcstat_demand_metadata_hits;
<span class="lineNum">     432 </span>                :            :         kstat_named_t arcstat_demand_metadata_misses;
<span class="lineNum">     433 </span>                :            :         kstat_named_t arcstat_prefetch_data_hits;
<span class="lineNum">     434 </span>                :            :         kstat_named_t arcstat_prefetch_data_misses;
<span class="lineNum">     435 </span>                :            :         kstat_named_t arcstat_prefetch_metadata_hits;
<span class="lineNum">     436 </span>                :            :         kstat_named_t arcstat_prefetch_metadata_misses;
<span class="lineNum">     437 </span>                :            :         kstat_named_t arcstat_mru_hits;
<span class="lineNum">     438 </span>                :            :         kstat_named_t arcstat_mru_ghost_hits;
<span class="lineNum">     439 </span>                :            :         kstat_named_t arcstat_mfu_hits;
<span class="lineNum">     440 </span>                :            :         kstat_named_t arcstat_mfu_ghost_hits;
<span class="lineNum">     441 </span>                :            :         kstat_named_t arcstat_deleted;
<span class="lineNum">     442 </span>                :            :         /*
<span class="lineNum">     443 </span>                :            :          * Number of buffers that could not be evicted because the hash lock
<span class="lineNum">     444 </span>                :            :          * was held by another thread.  The lock may not necessarily be held
<span class="lineNum">     445 </span>                :            :          * by something using the same buffer, since hash locks are shared
<span class="lineNum">     446 </span>                :            :          * by multiple buffers.
<span class="lineNum">     447 </span>                :            :          */
<span class="lineNum">     448 </span>                :            :         kstat_named_t arcstat_mutex_miss;
<span class="lineNum">     449 </span>                :            :         /*
<span class="lineNum">     450 </span>                :            :          * Number of buffers skipped because they have I/O in progress, are
<span class="lineNum">     451 </span>                :            :          * indrect prefetch buffers that have not lived long enough, or are
<span class="lineNum">     452 </span>                :            :          * not from the spa we're trying to evict from.
<span class="lineNum">     453 </span>                :            :          */
<span class="lineNum">     454 </span>                :            :         kstat_named_t arcstat_evict_skip;
<span class="lineNum">     455 </span>                :            :         /*
<span class="lineNum">     456 </span>                :            :          * Number of times arc_evict_state() was unable to evict enough
<span class="lineNum">     457 </span>                :            :          * buffers to reach its target amount.
<span class="lineNum">     458 </span>                :            :          */
<span class="lineNum">     459 </span>                :            :         kstat_named_t arcstat_evict_not_enough;
<span class="lineNum">     460 </span>                :            :         kstat_named_t arcstat_evict_l2_cached;
<span class="lineNum">     461 </span>                :            :         kstat_named_t arcstat_evict_l2_eligible;
<span class="lineNum">     462 </span>                :            :         kstat_named_t arcstat_evict_l2_ineligible;
<span class="lineNum">     463 </span>                :            :         kstat_named_t arcstat_evict_l2_skip;
<span class="lineNum">     464 </span>                :            :         kstat_named_t arcstat_hash_elements;
<span class="lineNum">     465 </span>                :            :         kstat_named_t arcstat_hash_elements_max;
<span class="lineNum">     466 </span>                :            :         kstat_named_t arcstat_hash_collisions;
<span class="lineNum">     467 </span>                :            :         kstat_named_t arcstat_hash_chains;
<span class="lineNum">     468 </span>                :            :         kstat_named_t arcstat_hash_chain_max;
<span class="lineNum">     469 </span>                :            :         kstat_named_t arcstat_p;
<span class="lineNum">     470 </span>                :            :         kstat_named_t arcstat_c;
<span class="lineNum">     471 </span>                :            :         kstat_named_t arcstat_c_min;
<span class="lineNum">     472 </span>                :            :         kstat_named_t arcstat_c_max;
<span class="lineNum">     473 </span>                :            :         kstat_named_t arcstat_size;
<span class="lineNum">     474 </span>                :            :         /*
<span class="lineNum">     475 </span>                :            :          * Number of compressed bytes stored in the arc_buf_hdr_t's b_pabd.
<span class="lineNum">     476 </span>                :            :          * Note that the compressed bytes may match the uncompressed bytes
<span class="lineNum">     477 </span>                :            :          * if the block is either not compressed or compressed arc is disabled.
<span class="lineNum">     478 </span>                :            :          */
<span class="lineNum">     479 </span>                :            :         kstat_named_t arcstat_compressed_size;
<span class="lineNum">     480 </span>                :            :         /*
<span class="lineNum">     481 </span>                :            :          * Uncompressed size of the data stored in b_pabd. If compressed
<span class="lineNum">     482 </span>                :            :          * arc is disabled then this value will be identical to the stat
<span class="lineNum">     483 </span>                :            :          * above.
<span class="lineNum">     484 </span>                :            :          */
<span class="lineNum">     485 </span>                :            :         kstat_named_t arcstat_uncompressed_size;
<span class="lineNum">     486 </span>                :            :         /*
<span class="lineNum">     487 </span>                :            :          * Number of bytes stored in all the arc_buf_t's. This is classified
<span class="lineNum">     488 </span>                :            :          * as &quot;overhead&quot; since this data is typically short-lived and will
<span class="lineNum">     489 </span>                :            :          * be evicted from the arc when it becomes unreferenced unless the
<span class="lineNum">     490 </span>                :            :          * zfs_keep_uncompressed_metadata or zfs_keep_uncompressed_level
<span class="lineNum">     491 </span>                :            :          * values have been set (see comment in dbuf.c for more information).
<span class="lineNum">     492 </span>                :            :          */
<span class="lineNum">     493 </span>                :            :         kstat_named_t arcstat_overhead_size;
<span class="lineNum">     494 </span>                :            :         /*
<span class="lineNum">     495 </span>                :            :          * Number of bytes consumed by internal ARC structures necessary
<span class="lineNum">     496 </span>                :            :          * for tracking purposes; these structures are not actually
<span class="lineNum">     497 </span>                :            :          * backed by ARC buffers. This includes arc_buf_hdr_t structures
<span class="lineNum">     498 </span>                :            :          * (allocated via arc_buf_hdr_t_full and arc_buf_hdr_t_l2only
<span class="lineNum">     499 </span>                :            :          * caches), and arc_buf_t structures (allocated via arc_buf_t
<span class="lineNum">     500 </span>                :            :          * cache).
<span class="lineNum">     501 </span>                :            :          */
<span class="lineNum">     502 </span>                :            :         kstat_named_t arcstat_hdr_size;
<span class="lineNum">     503 </span>                :            :         /*
<span class="lineNum">     504 </span>                :            :          * Number of bytes consumed by ARC buffers of type equal to
<span class="lineNum">     505 </span>                :            :          * ARC_BUFC_DATA. This is generally consumed by buffers backing
<span class="lineNum">     506 </span>                :            :          * on disk user data (e.g. plain file contents).
<span class="lineNum">     507 </span>                :            :          */
<span class="lineNum">     508 </span>                :            :         kstat_named_t arcstat_data_size;
<span class="lineNum">     509 </span>                :            :         /*
<span class="lineNum">     510 </span>                :            :          * Number of bytes consumed by ARC buffers of type equal to
<span class="lineNum">     511 </span>                :            :          * ARC_BUFC_METADATA. This is generally consumed by buffers
<span class="lineNum">     512 </span>                :            :          * backing on disk data that is used for internal ZFS
<span class="lineNum">     513 </span>                :            :          * structures (e.g. ZAP, dnode, indirect blocks, etc).
<span class="lineNum">     514 </span>                :            :          */
<span class="lineNum">     515 </span>                :            :         kstat_named_t arcstat_metadata_size;
<span class="lineNum">     516 </span>                :            :         /*
<span class="lineNum">     517 </span>                :            :          * Number of bytes consumed by dmu_buf_impl_t objects.
<span class="lineNum">     518 </span>                :            :          */
<span class="lineNum">     519 </span>                :            :         kstat_named_t arcstat_dbuf_size;
<span class="lineNum">     520 </span>                :            :         /*
<span class="lineNum">     521 </span>                :            :          * Number of bytes consumed by dnode_t objects.
<span class="lineNum">     522 </span>                :            :          */
<span class="lineNum">     523 </span>                :            :         kstat_named_t arcstat_dnode_size;
<span class="lineNum">     524 </span>                :            :         /*
<span class="lineNum">     525 </span>                :            :          * Number of bytes consumed by bonus buffers.
<span class="lineNum">     526 </span>                :            :          */
<span class="lineNum">     527 </span>                :            :         kstat_named_t arcstat_bonus_size;
<span class="lineNum">     528 </span>                :            :         /*
<span class="lineNum">     529 </span>                :            :          * Total number of bytes consumed by ARC buffers residing in the
<span class="lineNum">     530 </span>                :            :          * arc_anon state. This includes *all* buffers in the arc_anon
<span class="lineNum">     531 </span>                :            :          * state; e.g. data, metadata, evictable, and unevictable buffers
<span class="lineNum">     532 </span>                :            :          * are all included in this value.
<span class="lineNum">     533 </span>                :            :          */
<span class="lineNum">     534 </span>                :            :         kstat_named_t arcstat_anon_size;
<span class="lineNum">     535 </span>                :            :         /*
<span class="lineNum">     536 </span>                :            :          * Number of bytes consumed by ARC buffers that meet the
<span class="lineNum">     537 </span>                :            :          * following criteria: backing buffers of type ARC_BUFC_DATA,
<span class="lineNum">     538 </span>                :            :          * residing in the arc_anon state, and are eligible for eviction
<span class="lineNum">     539 </span>                :            :          * (e.g. have no outstanding holds on the buffer).
<span class="lineNum">     540 </span>                :            :          */
<span class="lineNum">     541 </span>                :            :         kstat_named_t arcstat_anon_evictable_data;
<span class="lineNum">     542 </span>                :            :         /*
<span class="lineNum">     543 </span>                :            :          * Number of bytes consumed by ARC buffers that meet the
<span class="lineNum">     544 </span>                :            :          * following criteria: backing buffers of type ARC_BUFC_METADATA,
<span class="lineNum">     545 </span>                :            :          * residing in the arc_anon state, and are eligible for eviction
<span class="lineNum">     546 </span>                :            :          * (e.g. have no outstanding holds on the buffer).
<span class="lineNum">     547 </span>                :            :          */
<span class="lineNum">     548 </span>                :            :         kstat_named_t arcstat_anon_evictable_metadata;
<span class="lineNum">     549 </span>                :            :         /*
<span class="lineNum">     550 </span>                :            :          * Total number of bytes consumed by ARC buffers residing in the
<span class="lineNum">     551 </span>                :            :          * arc_mru state. This includes *all* buffers in the arc_mru
<span class="lineNum">     552 </span>                :            :          * state; e.g. data, metadata, evictable, and unevictable buffers
<span class="lineNum">     553 </span>                :            :          * are all included in this value.
<span class="lineNum">     554 </span>                :            :          */
<span class="lineNum">     555 </span>                :            :         kstat_named_t arcstat_mru_size;
<span class="lineNum">     556 </span>                :            :         /*
<span class="lineNum">     557 </span>                :            :          * Number of bytes consumed by ARC buffers that meet the
<span class="lineNum">     558 </span>                :            :          * following criteria: backing buffers of type ARC_BUFC_DATA,
<span class="lineNum">     559 </span>                :            :          * residing in the arc_mru state, and are eligible for eviction
<span class="lineNum">     560 </span>                :            :          * (e.g. have no outstanding holds on the buffer).
<span class="lineNum">     561 </span>                :            :          */
<span class="lineNum">     562 </span>                :            :         kstat_named_t arcstat_mru_evictable_data;
<span class="lineNum">     563 </span>                :            :         /*
<span class="lineNum">     564 </span>                :            :          * Number of bytes consumed by ARC buffers that meet the
<span class="lineNum">     565 </span>                :            :          * following criteria: backing buffers of type ARC_BUFC_METADATA,
<span class="lineNum">     566 </span>                :            :          * residing in the arc_mru state, and are eligible for eviction
<span class="lineNum">     567 </span>                :            :          * (e.g. have no outstanding holds on the buffer).
<span class="lineNum">     568 </span>                :            :          */
<span class="lineNum">     569 </span>                :            :         kstat_named_t arcstat_mru_evictable_metadata;
<span class="lineNum">     570 </span>                :            :         /*
<span class="lineNum">     571 </span>                :            :          * Total number of bytes that *would have been* consumed by ARC
<span class="lineNum">     572 </span>                :            :          * buffers in the arc_mru_ghost state. The key thing to note
<span class="lineNum">     573 </span>                :            :          * here, is the fact that this size doesn't actually indicate
<span class="lineNum">     574 </span>                :            :          * RAM consumption. The ghost lists only consist of headers and
<span class="lineNum">     575 </span>                :            :          * don't actually have ARC buffers linked off of these headers.
<span class="lineNum">     576 </span>                :            :          * Thus, *if* the headers had associated ARC buffers, these
<span class="lineNum">     577 </span>                :            :          * buffers *would have* consumed this number of bytes.
<span class="lineNum">     578 </span>                :            :          */
<span class="lineNum">     579 </span>                :            :         kstat_named_t arcstat_mru_ghost_size;
<span class="lineNum">     580 </span>                :            :         /*
<span class="lineNum">     581 </span>                :            :          * Number of bytes that *would have been* consumed by ARC
<span class="lineNum">     582 </span>                :            :          * buffers that are eligible for eviction, of type
<span class="lineNum">     583 </span>                :            :          * ARC_BUFC_DATA, and linked off the arc_mru_ghost state.
<span class="lineNum">     584 </span>                :            :          */
<span class="lineNum">     585 </span>                :            :         kstat_named_t arcstat_mru_ghost_evictable_data;
<span class="lineNum">     586 </span>                :            :         /*
<span class="lineNum">     587 </span>                :            :          * Number of bytes that *would have been* consumed by ARC
<span class="lineNum">     588 </span>                :            :          * buffers that are eligible for eviction, of type
<span class="lineNum">     589 </span>                :            :          * ARC_BUFC_METADATA, and linked off the arc_mru_ghost state.
<span class="lineNum">     590 </span>                :            :          */
<span class="lineNum">     591 </span>                :            :         kstat_named_t arcstat_mru_ghost_evictable_metadata;
<span class="lineNum">     592 </span>                :            :         /*
<span class="lineNum">     593 </span>                :            :          * Total number of bytes consumed by ARC buffers residing in the
<span class="lineNum">     594 </span>                :            :          * arc_mfu state. This includes *all* buffers in the arc_mfu
<span class="lineNum">     595 </span>                :            :          * state; e.g. data, metadata, evictable, and unevictable buffers
<span class="lineNum">     596 </span>                :            :          * are all included in this value.
<span class="lineNum">     597 </span>                :            :          */
<span class="lineNum">     598 </span>                :            :         kstat_named_t arcstat_mfu_size;
<span class="lineNum">     599 </span>                :            :         /*
<span class="lineNum">     600 </span>                :            :          * Number of bytes consumed by ARC buffers that are eligible for
<span class="lineNum">     601 </span>                :            :          * eviction, of type ARC_BUFC_DATA, and reside in the arc_mfu
<span class="lineNum">     602 </span>                :            :          * state.
<span class="lineNum">     603 </span>                :            :          */
<span class="lineNum">     604 </span>                :            :         kstat_named_t arcstat_mfu_evictable_data;
<span class="lineNum">     605 </span>                :            :         /*
<span class="lineNum">     606 </span>                :            :          * Number of bytes consumed by ARC buffers that are eligible for
<span class="lineNum">     607 </span>                :            :          * eviction, of type ARC_BUFC_METADATA, and reside in the
<span class="lineNum">     608 </span>                :            :          * arc_mfu state.
<span class="lineNum">     609 </span>                :            :          */
<span class="lineNum">     610 </span>                :            :         kstat_named_t arcstat_mfu_evictable_metadata;
<span class="lineNum">     611 </span>                :            :         /*
<span class="lineNum">     612 </span>                :            :          * Total number of bytes that *would have been* consumed by ARC
<span class="lineNum">     613 </span>                :            :          * buffers in the arc_mfu_ghost state. See the comment above
<span class="lineNum">     614 </span>                :            :          * arcstat_mru_ghost_size for more details.
<span class="lineNum">     615 </span>                :            :          */
<span class="lineNum">     616 </span>                :            :         kstat_named_t arcstat_mfu_ghost_size;
<span class="lineNum">     617 </span>                :            :         /*
<span class="lineNum">     618 </span>                :            :          * Number of bytes that *would have been* consumed by ARC
<span class="lineNum">     619 </span>                :            :          * buffers that are eligible for eviction, of type
<span class="lineNum">     620 </span>                :            :          * ARC_BUFC_DATA, and linked off the arc_mfu_ghost state.
<span class="lineNum">     621 </span>                :            :          */
<span class="lineNum">     622 </span>                :            :         kstat_named_t arcstat_mfu_ghost_evictable_data;
<span class="lineNum">     623 </span>                :            :         /*
<span class="lineNum">     624 </span>                :            :          * Number of bytes that *would have been* consumed by ARC
<span class="lineNum">     625 </span>                :            :          * buffers that are eligible for eviction, of type
<span class="lineNum">     626 </span>                :            :          * ARC_BUFC_METADATA, and linked off the arc_mru_ghost state.
<span class="lineNum">     627 </span>                :            :          */
<span class="lineNum">     628 </span>                :            :         kstat_named_t arcstat_mfu_ghost_evictable_metadata;
<span class="lineNum">     629 </span>                :            :         kstat_named_t arcstat_l2_hits;
<span class="lineNum">     630 </span>                :            :         kstat_named_t arcstat_l2_misses;
<span class="lineNum">     631 </span>                :            :         kstat_named_t arcstat_l2_feeds;
<span class="lineNum">     632 </span>                :            :         kstat_named_t arcstat_l2_rw_clash;
<span class="lineNum">     633 </span>                :            :         kstat_named_t arcstat_l2_read_bytes;
<span class="lineNum">     634 </span>                :            :         kstat_named_t arcstat_l2_write_bytes;
<span class="lineNum">     635 </span>                :            :         kstat_named_t arcstat_l2_writes_sent;
<span class="lineNum">     636 </span>                :            :         kstat_named_t arcstat_l2_writes_done;
<span class="lineNum">     637 </span>                :            :         kstat_named_t arcstat_l2_writes_error;
<span class="lineNum">     638 </span>                :            :         kstat_named_t arcstat_l2_writes_lock_retry;
<span class="lineNum">     639 </span>                :            :         kstat_named_t arcstat_l2_evict_lock_retry;
<span class="lineNum">     640 </span>                :            :         kstat_named_t arcstat_l2_evict_reading;
<span class="lineNum">     641 </span>                :            :         kstat_named_t arcstat_l2_evict_l1cached;
<span class="lineNum">     642 </span>                :            :         kstat_named_t arcstat_l2_free_on_write;
<span class="lineNum">     643 </span>                :            :         kstat_named_t arcstat_l2_abort_lowmem;
<span class="lineNum">     644 </span>                :            :         kstat_named_t arcstat_l2_cksum_bad;
<span class="lineNum">     645 </span>                :            :         kstat_named_t arcstat_l2_io_error;
<span class="lineNum">     646 </span>                :            :         kstat_named_t arcstat_l2_lsize;
<span class="lineNum">     647 </span>                :            :         kstat_named_t arcstat_l2_psize;
<span class="lineNum">     648 </span>                :            :         kstat_named_t arcstat_l2_hdr_size;
<span class="lineNum">     649 </span>                :            :         kstat_named_t arcstat_memory_throttle_count;
<span class="lineNum">     650 </span>                :            :         kstat_named_t arcstat_memory_direct_count;
<span class="lineNum">     651 </span>                :            :         kstat_named_t arcstat_memory_indirect_count;
<span class="lineNum">     652 </span>                :            :         kstat_named_t arcstat_no_grow;
<span class="lineNum">     653 </span>                :            :         kstat_named_t arcstat_tempreserve;
<span class="lineNum">     654 </span>                :            :         kstat_named_t arcstat_loaned_bytes;
<span class="lineNum">     655 </span>                :            :         kstat_named_t arcstat_prune;
<span class="lineNum">     656 </span>                :            :         kstat_named_t arcstat_meta_used;
<span class="lineNum">     657 </span>                :            :         kstat_named_t arcstat_meta_limit;
<span class="lineNum">     658 </span>                :            :         kstat_named_t arcstat_dnode_limit;
<span class="lineNum">     659 </span>                :            :         kstat_named_t arcstat_meta_max;
<span class="lineNum">     660 </span>                :            :         kstat_named_t arcstat_meta_min;
<span class="lineNum">     661 </span>                :            :         kstat_named_t arcstat_sync_wait_for_async;
<span class="lineNum">     662 </span>                :            :         kstat_named_t arcstat_demand_hit_predictive_prefetch;
<span class="lineNum">     663 </span>                :            :         kstat_named_t arcstat_need_free;
<span class="lineNum">     664 </span>                :            :         kstat_named_t arcstat_sys_free;
<span class="lineNum">     665 </span>                :            :         kstat_named_t arcstat_raw_size;
<span class="lineNum">     666 </span>                :            : } arc_stats_t;
<span class="lineNum">     667 </span>                :            : 
<span class="lineNum">     668 </span>                :            : static arc_stats_t arc_stats = {
<span class="lineNum">     669 </span>                :            :         { &quot;hits&quot;,                     KSTAT_DATA_UINT64 },
<span class="lineNum">     670 </span>                :            :         { &quot;misses&quot;,                   KSTAT_DATA_UINT64 },
<span class="lineNum">     671 </span>                :            :         { &quot;demand_data_hits&quot;,         KSTAT_DATA_UINT64 },
<span class="lineNum">     672 </span>                :            :         { &quot;demand_data_misses&quot;,               KSTAT_DATA_UINT64 },
<span class="lineNum">     673 </span>                :            :         { &quot;demand_metadata_hits&quot;,     KSTAT_DATA_UINT64 },
<span class="lineNum">     674 </span>                :            :         { &quot;demand_metadata_misses&quot;,   KSTAT_DATA_UINT64 },
<span class="lineNum">     675 </span>                :            :         { &quot;prefetch_data_hits&quot;,               KSTAT_DATA_UINT64 },
<span class="lineNum">     676 </span>                :            :         { &quot;prefetch_data_misses&quot;,     KSTAT_DATA_UINT64 },
<span class="lineNum">     677 </span>                :            :         { &quot;prefetch_metadata_hits&quot;,   KSTAT_DATA_UINT64 },
<span class="lineNum">     678 </span>                :            :         { &quot;prefetch_metadata_misses&quot;, KSTAT_DATA_UINT64 },
<span class="lineNum">     679 </span>                :            :         { &quot;mru_hits&quot;,                 KSTAT_DATA_UINT64 },
<span class="lineNum">     680 </span>                :            :         { &quot;mru_ghost_hits&quot;,           KSTAT_DATA_UINT64 },
<span class="lineNum">     681 </span>                :            :         { &quot;mfu_hits&quot;,                 KSTAT_DATA_UINT64 },
<span class="lineNum">     682 </span>                :            :         { &quot;mfu_ghost_hits&quot;,           KSTAT_DATA_UINT64 },
<span class="lineNum">     683 </span>                :            :         { &quot;deleted&quot;,                  KSTAT_DATA_UINT64 },
<span class="lineNum">     684 </span>                :            :         { &quot;mutex_miss&quot;,                       KSTAT_DATA_UINT64 },
<span class="lineNum">     685 </span>                :            :         { &quot;evict_skip&quot;,                       KSTAT_DATA_UINT64 },
<span class="lineNum">     686 </span>                :            :         { &quot;evict_not_enough&quot;,         KSTAT_DATA_UINT64 },
<span class="lineNum">     687 </span>                :            :         { &quot;evict_l2_cached&quot;,          KSTAT_DATA_UINT64 },
<span class="lineNum">     688 </span>                :            :         { &quot;evict_l2_eligible&quot;,                KSTAT_DATA_UINT64 },
<span class="lineNum">     689 </span>                :            :         { &quot;evict_l2_ineligible&quot;,      KSTAT_DATA_UINT64 },
<span class="lineNum">     690 </span>                :            :         { &quot;evict_l2_skip&quot;,            KSTAT_DATA_UINT64 },
<span class="lineNum">     691 </span>                :            :         { &quot;hash_elements&quot;,            KSTAT_DATA_UINT64 },
<span class="lineNum">     692 </span>                :            :         { &quot;hash_elements_max&quot;,                KSTAT_DATA_UINT64 },
<span class="lineNum">     693 </span>                :            :         { &quot;hash_collisions&quot;,          KSTAT_DATA_UINT64 },
<span class="lineNum">     694 </span>                :            :         { &quot;hash_chains&quot;,              KSTAT_DATA_UINT64 },
<span class="lineNum">     695 </span>                :            :         { &quot;hash_chain_max&quot;,           KSTAT_DATA_UINT64 },
<span class="lineNum">     696 </span>                :            :         { &quot;p&quot;,                                KSTAT_DATA_UINT64 },
<span class="lineNum">     697 </span>                :            :         { &quot;c&quot;,                                KSTAT_DATA_UINT64 },
<span class="lineNum">     698 </span>                :            :         { &quot;c_min&quot;,                    KSTAT_DATA_UINT64 },
<span class="lineNum">     699 </span>                :            :         { &quot;c_max&quot;,                    KSTAT_DATA_UINT64 },
<span class="lineNum">     700 </span>                :            :         { &quot;size&quot;,                     KSTAT_DATA_UINT64 },
<span class="lineNum">     701 </span>                :            :         { &quot;compressed_size&quot;,          KSTAT_DATA_UINT64 },
<span class="lineNum">     702 </span>                :            :         { &quot;uncompressed_size&quot;,                KSTAT_DATA_UINT64 },
<span class="lineNum">     703 </span>                :            :         { &quot;overhead_size&quot;,            KSTAT_DATA_UINT64 },
<span class="lineNum">     704 </span>                :            :         { &quot;hdr_size&quot;,                 KSTAT_DATA_UINT64 },
<span class="lineNum">     705 </span>                :            :         { &quot;data_size&quot;,                        KSTAT_DATA_UINT64 },
<span class="lineNum">     706 </span>                :            :         { &quot;metadata_size&quot;,            KSTAT_DATA_UINT64 },
<span class="lineNum">     707 </span>                :            :         { &quot;dbuf_size&quot;,                        KSTAT_DATA_UINT64 },
<span class="lineNum">     708 </span>                :            :         { &quot;dnode_size&quot;,                       KSTAT_DATA_UINT64 },
<span class="lineNum">     709 </span>                :            :         { &quot;bonus_size&quot;,                       KSTAT_DATA_UINT64 },
<span class="lineNum">     710 </span>                :            :         { &quot;anon_size&quot;,                        KSTAT_DATA_UINT64 },
<span class="lineNum">     711 </span>                :            :         { &quot;anon_evictable_data&quot;,      KSTAT_DATA_UINT64 },
<span class="lineNum">     712 </span>                :            :         { &quot;anon_evictable_metadata&quot;,  KSTAT_DATA_UINT64 },
<span class="lineNum">     713 </span>                :            :         { &quot;mru_size&quot;,                 KSTAT_DATA_UINT64 },
<span class="lineNum">     714 </span>                :            :         { &quot;mru_evictable_data&quot;,               KSTAT_DATA_UINT64 },
<span class="lineNum">     715 </span>                :            :         { &quot;mru_evictable_metadata&quot;,   KSTAT_DATA_UINT64 },
<span class="lineNum">     716 </span>                :            :         { &quot;mru_ghost_size&quot;,           KSTAT_DATA_UINT64 },
<span class="lineNum">     717 </span>                :            :         { &quot;mru_ghost_evictable_data&quot;, KSTAT_DATA_UINT64 },
<span class="lineNum">     718 </span>                :            :         { &quot;mru_ghost_evictable_metadata&quot;, KSTAT_DATA_UINT64 },
<span class="lineNum">     719 </span>                :            :         { &quot;mfu_size&quot;,                 KSTAT_DATA_UINT64 },
<span class="lineNum">     720 </span>                :            :         { &quot;mfu_evictable_data&quot;,               KSTAT_DATA_UINT64 },
<span class="lineNum">     721 </span>                :            :         { &quot;mfu_evictable_metadata&quot;,   KSTAT_DATA_UINT64 },
<span class="lineNum">     722 </span>                :            :         { &quot;mfu_ghost_size&quot;,           KSTAT_DATA_UINT64 },
<span class="lineNum">     723 </span>                :            :         { &quot;mfu_ghost_evictable_data&quot;, KSTAT_DATA_UINT64 },
<span class="lineNum">     724 </span>                :            :         { &quot;mfu_ghost_evictable_metadata&quot;, KSTAT_DATA_UINT64 },
<span class="lineNum">     725 </span>                :            :         { &quot;l2_hits&quot;,                  KSTAT_DATA_UINT64 },
<span class="lineNum">     726 </span>                :            :         { &quot;l2_misses&quot;,                        KSTAT_DATA_UINT64 },
<span class="lineNum">     727 </span>                :            :         { &quot;l2_feeds&quot;,                 KSTAT_DATA_UINT64 },
<span class="lineNum">     728 </span>                :            :         { &quot;l2_rw_clash&quot;,              KSTAT_DATA_UINT64 },
<span class="lineNum">     729 </span>                :            :         { &quot;l2_read_bytes&quot;,            KSTAT_DATA_UINT64 },
<span class="lineNum">     730 </span>                :            :         { &quot;l2_write_bytes&quot;,           KSTAT_DATA_UINT64 },
<span class="lineNum">     731 </span>                :            :         { &quot;l2_writes_sent&quot;,           KSTAT_DATA_UINT64 },
<span class="lineNum">     732 </span>                :            :         { &quot;l2_writes_done&quot;,           KSTAT_DATA_UINT64 },
<span class="lineNum">     733 </span>                :            :         { &quot;l2_writes_error&quot;,          KSTAT_DATA_UINT64 },
<span class="lineNum">     734 </span>                :            :         { &quot;l2_writes_lock_retry&quot;,     KSTAT_DATA_UINT64 },
<span class="lineNum">     735 </span>                :            :         { &quot;l2_evict_lock_retry&quot;,      KSTAT_DATA_UINT64 },
<span class="lineNum">     736 </span>                :            :         { &quot;l2_evict_reading&quot;,         KSTAT_DATA_UINT64 },
<span class="lineNum">     737 </span>                :            :         { &quot;l2_evict_l1cached&quot;,                KSTAT_DATA_UINT64 },
<span class="lineNum">     738 </span>                :            :         { &quot;l2_free_on_write&quot;,         KSTAT_DATA_UINT64 },
<span class="lineNum">     739 </span>                :            :         { &quot;l2_abort_lowmem&quot;,          KSTAT_DATA_UINT64 },
<span class="lineNum">     740 </span>                :            :         { &quot;l2_cksum_bad&quot;,             KSTAT_DATA_UINT64 },
<span class="lineNum">     741 </span>                :            :         { &quot;l2_io_error&quot;,              KSTAT_DATA_UINT64 },
<span class="lineNum">     742 </span>                :            :         { &quot;l2_size&quot;,                  KSTAT_DATA_UINT64 },
<span class="lineNum">     743 </span>                :            :         { &quot;l2_asize&quot;,                 KSTAT_DATA_UINT64 },
<span class="lineNum">     744 </span>                :            :         { &quot;l2_hdr_size&quot;,              KSTAT_DATA_UINT64 },
<span class="lineNum">     745 </span>                :            :         { &quot;memory_throttle_count&quot;,    KSTAT_DATA_UINT64 },
<span class="lineNum">     746 </span>                :            :         { &quot;memory_direct_count&quot;,      KSTAT_DATA_UINT64 },
<span class="lineNum">     747 </span>                :            :         { &quot;memory_indirect_count&quot;,    KSTAT_DATA_UINT64 },
<span class="lineNum">     748 </span>                :            :         { &quot;arc_no_grow&quot;,              KSTAT_DATA_UINT64 },
<span class="lineNum">     749 </span>                :            :         { &quot;arc_tempreserve&quot;,          KSTAT_DATA_UINT64 },
<span class="lineNum">     750 </span>                :            :         { &quot;arc_loaned_bytes&quot;,         KSTAT_DATA_UINT64 },
<span class="lineNum">     751 </span>                :            :         { &quot;arc_prune&quot;,                        KSTAT_DATA_UINT64 },
<span class="lineNum">     752 </span>                :            :         { &quot;arc_meta_used&quot;,            KSTAT_DATA_UINT64 },
<span class="lineNum">     753 </span>                :            :         { &quot;arc_meta_limit&quot;,           KSTAT_DATA_UINT64 },
<span class="lineNum">     754 </span>                :            :         { &quot;arc_dnode_limit&quot;,          KSTAT_DATA_UINT64 },
<span class="lineNum">     755 </span>                :            :         { &quot;arc_meta_max&quot;,             KSTAT_DATA_UINT64 },
<span class="lineNum">     756 </span>                :            :         { &quot;arc_meta_min&quot;,             KSTAT_DATA_UINT64 },
<span class="lineNum">     757 </span>                :            :         { &quot;sync_wait_for_async&quot;,      KSTAT_DATA_UINT64 },
<span class="lineNum">     758 </span>                :            :         { &quot;demand_hit_predictive_prefetch&quot;, KSTAT_DATA_UINT64 },
<span class="lineNum">     759 </span>                :            :         { &quot;arc_need_free&quot;,            KSTAT_DATA_UINT64 },
<span class="lineNum">     760 </span>                :            :         { &quot;arc_sys_free&quot;,             KSTAT_DATA_UINT64 },
<span class="lineNum">     761 </span>                :            :         { &quot;arc_raw_size&quot;,             KSTAT_DATA_UINT64 }
<span class="lineNum">     762 </span>                :            : };
<span class="lineNum">     763 </span>                :            : 
<span class="lineNum">     764 </span>                :            : #define ARCSTAT(stat)   (arc_stats.stat.value.ui64)
<span class="lineNum">     765 </span>                :            : 
<span class="lineNum">     766 </span>                :            : #define ARCSTAT_INCR(stat, val) \
<span class="lineNum">     767 </span>                :            :         atomic_add_64(&amp;arc_stats.stat.value.ui64, (val))
<span class="lineNum">     768 </span>                :            : 
<span class="lineNum">     769 </span>                :            : #define ARCSTAT_BUMP(stat)      ARCSTAT_INCR(stat, 1)
<span class="lineNum">     770 </span>                :            : #define ARCSTAT_BUMPDOWN(stat)  ARCSTAT_INCR(stat, -1)
<span class="lineNum">     771 </span>                :            : 
<span class="lineNum">     772 </span>                :            : #define ARCSTAT_MAX(stat, val) {                                        \
<span class="lineNum">     773 </span>                :            :         uint64_t m;                                                     \
<span class="lineNum">     774 </span>                :            :         while ((val) &gt; (m = arc_stats.stat.value.ui64) &amp;&amp;            \
<span class="lineNum">     775 </span>                :            :             (m != atomic_cas_64(&amp;arc_stats.stat.value.ui64, m, (val))))     \
<span class="lineNum">     776 </span>                :            :                 continue;                                               \
<span class="lineNum">     777 </span>                :            : }
<span class="lineNum">     778 </span>                :            : 
<span class="lineNum">     779 </span>                :            : #define ARCSTAT_MAXSTAT(stat) \
<span class="lineNum">     780 </span>                :            :         ARCSTAT_MAX(stat##_max, arc_stats.stat.value.ui64)
<span class="lineNum">     781 </span>                :            : 
<span class="lineNum">     782 </span>                :            : /*
<span class="lineNum">     783 </span>                :            :  * We define a macro to allow ARC hits/misses to be easily broken down by
<span class="lineNum">     784 </span>                :            :  * two separate conditions, giving a total of four different subtypes for
<span class="lineNum">     785 </span>                :            :  * each of hits and misses (so eight statistics total).
<span class="lineNum">     786 </span>                :            :  */
<span class="lineNum">     787 </span>                :            : #define ARCSTAT_CONDSTAT(cond1, stat1, notstat1, cond2, stat2, notstat2, stat) \
<span class="lineNum">     788 </span>                :            :         if (cond1) {                                                    \
<span class="lineNum">     789 </span>                :            :                 if (cond2) {                                            \
<span class="lineNum">     790 </span>                :            :                         ARCSTAT_BUMP(arcstat_##stat1##_##stat2##_##stat); \
<span class="lineNum">     791 </span>                :            :                 } else {                                                \
<span class="lineNum">     792 </span>                :            :                         ARCSTAT_BUMP(arcstat_##stat1##_##notstat2##_##stat); \
<span class="lineNum">     793 </span>                :            :                 }                                                       \
<span class="lineNum">     794 </span>                :            :         } else {                                                        \
<span class="lineNum">     795 </span>                :            :                 if (cond2) {                                            \
<span class="lineNum">     796 </span>                :            :                         ARCSTAT_BUMP(arcstat_##notstat1##_##stat2##_##stat); \
<span class="lineNum">     797 </span>                :            :                 } else {                                                \
<span class="lineNum">     798 </span>                :            :                         ARCSTAT_BUMP(arcstat_##notstat1##_##notstat2##_##stat);\
<span class="lineNum">     799 </span>                :            :                 }                                                       \
<span class="lineNum">     800 </span>                :            :         }
<span class="lineNum">     801 </span>                :            : 
<span class="lineNum">     802 </span>                :            : kstat_t                 *arc_ksp;
<span class="lineNum">     803 </span>                :            : static arc_state_t      *arc_anon;
<span class="lineNum">     804 </span>                :            : static arc_state_t      *arc_mru;
<span class="lineNum">     805 </span>                :            : static arc_state_t      *arc_mru_ghost;
<span class="lineNum">     806 </span>                :            : static arc_state_t      *arc_mfu;
<span class="lineNum">     807 </span>                :            : static arc_state_t      *arc_mfu_ghost;
<span class="lineNum">     808 </span>                :            : static arc_state_t      *arc_l2c_only;
<span class="lineNum">     809 </span>                :            : 
<span class="lineNum">     810 </span>                :            : /*
<span class="lineNum">     811 </span>                :            :  * There are several ARC variables that are critical to export as kstats --
<span class="lineNum">     812 </span>                :            :  * but we don't want to have to grovel around in the kstat whenever we wish to
<span class="lineNum">     813 </span>                :            :  * manipulate them.  For these variables, we therefore define them to be in
<span class="lineNum">     814 </span>                :            :  * terms of the statistic variable.  This assures that we are not introducing
<span class="lineNum">     815 </span>                :            :  * the possibility of inconsistency by having shadow copies of the variables,
<span class="lineNum">     816 </span>                :            :  * while still allowing the code to be readable.
<span class="lineNum">     817 </span>                :            :  */
<span class="lineNum">     818 </span>                :            : #define arc_size        ARCSTAT(arcstat_size)   /* actual total arc size */
<span class="lineNum">     819 </span>                :            : #define arc_p           ARCSTAT(arcstat_p)      /* target size of MRU */
<span class="lineNum">     820 </span>                :            : #define arc_c           ARCSTAT(arcstat_c)      /* target size of cache */
<span class="lineNum">     821 </span>                :            : #define arc_c_min       ARCSTAT(arcstat_c_min)  /* min target cache size */
<span class="lineNum">     822 </span>                :            : #define arc_c_max       ARCSTAT(arcstat_c_max)  /* max target cache size */
<span class="lineNum">     823 </span>                :            : #define arc_no_grow     ARCSTAT(arcstat_no_grow) /* do not grow cache size */
<span class="lineNum">     824 </span>                :            : #define arc_tempreserve ARCSTAT(arcstat_tempreserve)
<span class="lineNum">     825 </span>                :            : #define arc_loaned_bytes        ARCSTAT(arcstat_loaned_bytes)
<span class="lineNum">     826 </span>                :            : #define arc_meta_limit  ARCSTAT(arcstat_meta_limit) /* max size for metadata */
<span class="lineNum">     827 </span>                :            : #define arc_dnode_limit ARCSTAT(arcstat_dnode_limit) /* max size for dnodes */
<span class="lineNum">     828 </span>                :            : #define arc_meta_min    ARCSTAT(arcstat_meta_min) /* min size for metadata */
<span class="lineNum">     829 </span>                :            : #define arc_meta_used   ARCSTAT(arcstat_meta_used) /* size of metadata */
<span class="lineNum">     830 </span>                :            : #define arc_meta_max    ARCSTAT(arcstat_meta_max) /* max size of metadata */
<span class="lineNum">     831 </span>                :            : #define arc_dbuf_size   ARCSTAT(arcstat_dbuf_size) /* dbuf metadata */
<span class="lineNum">     832 </span>                :            : #define arc_dnode_size  ARCSTAT(arcstat_dnode_size) /* dnode metadata */
<span class="lineNum">     833 </span>                :            : #define arc_bonus_size  ARCSTAT(arcstat_bonus_size) /* bonus buffer metadata */
<span class="lineNum">     834 </span>                :            : #define arc_need_free   ARCSTAT(arcstat_need_free) /* bytes to be freed */
<span class="lineNum">     835 </span>                :            : #define arc_sys_free    ARCSTAT(arcstat_sys_free) /* target system free bytes */
<span class="lineNum">     836 </span>                :            : 
<span class="lineNum">     837 </span>                :            : /* size of all b_rabd's in entire arc */
<span class="lineNum">     838 </span>                :            : #define arc_raw_size    ARCSTAT(arcstat_raw_size)
<span class="lineNum">     839 </span>                :            : /* compressed size of entire arc */
<span class="lineNum">     840 </span>                :            : #define arc_compressed_size     ARCSTAT(arcstat_compressed_size)
<span class="lineNum">     841 </span>                :            : /* uncompressed size of entire arc */
<span class="lineNum">     842 </span>                :            : #define arc_uncompressed_size   ARCSTAT(arcstat_uncompressed_size)
<span class="lineNum">     843 </span>                :            : /* number of bytes in the arc from arc_buf_t's */
<span class="lineNum">     844 </span>                :            : #define arc_overhead_size       ARCSTAT(arcstat_overhead_size)
<span class="lineNum">     845 </span>                :            : 
<span class="lineNum">     846 </span>                :            : static list_t arc_prune_list;
<span class="lineNum">     847 </span>                :            : static kmutex_t arc_prune_mtx;
<span class="lineNum">     848 </span>                :            : static taskq_t *arc_prune_taskq;
<span class="lineNum">     849 </span>                :            : 
<span class="lineNum">     850 </span>                :            : #define GHOST_STATE(state)      \
<span class="lineNum">     851 </span>                :            :         ((state) == arc_mru_ghost || (state) == arc_mfu_ghost ||        \
<span class="lineNum">     852 </span>                :            :         (state) == arc_l2c_only)
<span class="lineNum">     853 </span>                :            : 
<span class="lineNum">     854 </span>                :            : #define HDR_IN_HASH_TABLE(hdr)  ((hdr)-&gt;b_flags &amp; ARC_FLAG_IN_HASH_TABLE)
<span class="lineNum">     855 </span>                :            : #define HDR_IO_IN_PROGRESS(hdr) ((hdr)-&gt;b_flags &amp; ARC_FLAG_IO_IN_PROGRESS)
<span class="lineNum">     856 </span>                :            : #define HDR_IO_ERROR(hdr)       ((hdr)-&gt;b_flags &amp; ARC_FLAG_IO_ERROR)
<span class="lineNum">     857 </span>                :            : #define HDR_PREFETCH(hdr)       ((hdr)-&gt;b_flags &amp; ARC_FLAG_PREFETCH)
<span class="lineNum">     858 </span>                :            : #define HDR_COMPRESSION_ENABLED(hdr)    \
<span class="lineNum">     859 </span>                :            :         ((hdr)-&gt;b_flags &amp; ARC_FLAG_COMPRESSED_ARC)
<span class="lineNum">     860 </span>                :            : 
<span class="lineNum">     861 </span>                :            : #define HDR_L2CACHE(hdr)        ((hdr)-&gt;b_flags &amp; ARC_FLAG_L2CACHE)
<span class="lineNum">     862 </span>                :            : #define HDR_L2_READING(hdr)     \
<span class="lineNum">     863 </span>                :            :         (((hdr)-&gt;b_flags &amp; ARC_FLAG_IO_IN_PROGRESS) &amp;&amp;   \
<span class="lineNum">     864 </span>                :            :         ((hdr)-&gt;b_flags &amp; ARC_FLAG_HAS_L2HDR))
<span class="lineNum">     865 </span>                :            : #define HDR_L2_WRITING(hdr)     ((hdr)-&gt;b_flags &amp; ARC_FLAG_L2_WRITING)
<span class="lineNum">     866 </span>                :            : #define HDR_L2_EVICTED(hdr)     ((hdr)-&gt;b_flags &amp; ARC_FLAG_L2_EVICTED)
<span class="lineNum">     867 </span>                :            : #define HDR_L2_WRITE_HEAD(hdr)  ((hdr)-&gt;b_flags &amp; ARC_FLAG_L2_WRITE_HEAD)
<span class="lineNum">     868 </span>                :            : #define HDR_PROTECTED(hdr)      ((hdr)-&gt;b_flags &amp; ARC_FLAG_PROTECTED)
<span class="lineNum">     869 </span>                :            : #define HDR_NOAUTH(hdr)         ((hdr)-&gt;b_flags &amp; ARC_FLAG_NOAUTH)
<span class="lineNum">     870 </span>                :            : #define HDR_SHARED_DATA(hdr)    ((hdr)-&gt;b_flags &amp; ARC_FLAG_SHARED_DATA)
<span class="lineNum">     871 </span>                :            : 
<span class="lineNum">     872 </span>                :            : #define HDR_ISTYPE_METADATA(hdr)        \
<span class="lineNum">     873 </span>                :            :         ((hdr)-&gt;b_flags &amp; ARC_FLAG_BUFC_METADATA)
<span class="lineNum">     874 </span>                :            : #define HDR_ISTYPE_DATA(hdr)    (!HDR_ISTYPE_METADATA(hdr))
<span class="lineNum">     875 </span>                :            : 
<span class="lineNum">     876 </span>                :            : #define HDR_HAS_L1HDR(hdr)      ((hdr)-&gt;b_flags &amp; ARC_FLAG_HAS_L1HDR)
<span class="lineNum">     877 </span>                :            : #define HDR_HAS_L2HDR(hdr)      ((hdr)-&gt;b_flags &amp; ARC_FLAG_HAS_L2HDR)
<span class="lineNum">     878 </span>                :            : #define HDR_HAS_RABD(hdr)       \
<span class="lineNum">     879 </span>                :            :         (HDR_HAS_L1HDR(hdr) &amp;&amp; HDR_PROTECTED(hdr) &amp;&amp;    \
<span class="lineNum">     880 </span>                :            :         (hdr)-&gt;b_crypt_hdr.b_rabd != NULL)
<span class="lineNum">     881 </span>                :            : #define HDR_ENCRYPTED(hdr)      \
<span class="lineNum">     882 </span>                :            :         (HDR_PROTECTED(hdr) &amp;&amp; DMU_OT_IS_ENCRYPTED((hdr)-&gt;b_crypt_hdr.b_ot))
<span class="lineNum">     883 </span>                :            : #define HDR_AUTHENTICATED(hdr)  \
<span class="lineNum">     884 </span>                :            :         (HDR_PROTECTED(hdr) &amp;&amp; !DMU_OT_IS_ENCRYPTED((hdr)-&gt;b_crypt_hdr.b_ot))
<span class="lineNum">     885 </span>                :            : 
<span class="lineNum">     886 </span>                :            : /* For storing compression mode in b_flags */
<span class="lineNum">     887 </span>                :            : #define HDR_COMPRESS_OFFSET     (highbit64(ARC_FLAG_COMPRESS_0) - 1)
<span class="lineNum">     888 </span>                :            : 
<span class="lineNum">     889 </span>                :            : #define HDR_GET_COMPRESS(hdr)   ((enum zio_compress)BF32_GET((hdr)-&gt;b_flags, \
<span class="lineNum">     890 </span>                :            :         HDR_COMPRESS_OFFSET, SPA_COMPRESSBITS))
<span class="lineNum">     891 </span>                :            : #define HDR_SET_COMPRESS(hdr, cmp) BF32_SET((hdr)-&gt;b_flags, \
<span class="lineNum">     892 </span>                :            :         HDR_COMPRESS_OFFSET, SPA_COMPRESSBITS, (cmp));
<span class="lineNum">     893 </span>                :            : 
<span class="lineNum">     894 </span>                :            : #define ARC_BUF_LAST(buf)       ((buf)-&gt;b_next == NULL)
<span class="lineNum">     895 </span>                :            : #define ARC_BUF_SHARED(buf)     ((buf)-&gt;b_flags &amp; ARC_BUF_FLAG_SHARED)
<span class="lineNum">     896 </span>                :            : #define ARC_BUF_COMPRESSED(buf) ((buf)-&gt;b_flags &amp; ARC_BUF_FLAG_COMPRESSED)
<span class="lineNum">     897 </span>                :            : #define ARC_BUF_ENCRYPTED(buf)  ((buf)-&gt;b_flags &amp; ARC_BUF_FLAG_ENCRYPTED)
<span class="lineNum">     898 </span>                :            : 
<span class="lineNum">     899 </span>                :            : /*
<span class="lineNum">     900 </span>                :            :  * Other sizes
<span class="lineNum">     901 </span>                :            :  */
<span class="lineNum">     902 </span>                :            : 
<span class="lineNum">     903 </span>                :            : #define HDR_FULL_CRYPT_SIZE ((int64_t)sizeof (arc_buf_hdr_t))
<span class="lineNum">     904 </span>                :            : #define HDR_FULL_SIZE ((int64_t)offsetof(arc_buf_hdr_t, b_crypt_hdr))
<span class="lineNum">     905 </span>                :            : #define HDR_L2ONLY_SIZE ((int64_t)offsetof(arc_buf_hdr_t, b_l1hdr))
<span class="lineNum">     906 </span>                :            : 
<span class="lineNum">     907 </span>                :            : /*
<span class="lineNum">     908 </span>                :            :  * Hash table routines
<span class="lineNum">     909 </span>                :            :  */
<span class="lineNum">     910 </span>                :            : 
<span class="lineNum">     911 </span>                :            : #define HT_LOCK_ALIGN   64
<span class="lineNum">     912 </span>                :            : #define HT_LOCK_PAD     (P2NPHASE(sizeof (kmutex_t), (HT_LOCK_ALIGN)))
<span class="lineNum">     913 </span>                :            : 
<span class="lineNum">     914 </span>                :            : struct ht_lock {
<span class="lineNum">     915 </span>                :            :         kmutex_t        ht_lock;
<span class="lineNum">     916 </span>                :            : #ifdef _KERNEL
<span class="lineNum">     917 </span>                :            :         unsigned char   pad[HT_LOCK_PAD];
<span class="lineNum">     918 </span>                :            : #endif
<span class="lineNum">     919 </span>                :            : };
<span class="lineNum">     920 </span>                :            : 
<span class="lineNum">     921 </span>                :            : #define BUF_LOCKS 8192
<span class="lineNum">     922 </span>                :            : typedef struct buf_hash_table {
<span class="lineNum">     923 </span>                :            :         uint64_t ht_mask;
<span class="lineNum">     924 </span>                :            :         arc_buf_hdr_t **ht_table;
<span class="lineNum">     925 </span>                :            :         struct ht_lock ht_locks[BUF_LOCKS];
<span class="lineNum">     926 </span>                :            : } buf_hash_table_t;
<span class="lineNum">     927 </span>                :            : 
<span class="lineNum">     928 </span>                :            : static buf_hash_table_t buf_hash_table;
<span class="lineNum">     929 </span>                :            : 
<span class="lineNum">     930 </span>                :            : #define BUF_HASH_INDEX(spa, dva, birth) \
<span class="lineNum">     931 </span>                :            :         (buf_hash(spa, dva, birth) &amp; buf_hash_table.ht_mask)
<span class="lineNum">     932 </span>                :            : #define BUF_HASH_LOCK_NTRY(idx) (buf_hash_table.ht_locks[idx &amp; (BUF_LOCKS-1)])
<span class="lineNum">     933 </span>                :            : #define BUF_HASH_LOCK(idx)      (&amp;(BUF_HASH_LOCK_NTRY(idx).ht_lock))
<span class="lineNum">     934 </span>                :            : #define HDR_LOCK(hdr) \
<span class="lineNum">     935 </span>                :            :         (BUF_HASH_LOCK(BUF_HASH_INDEX(hdr-&gt;b_spa, &amp;hdr-&gt;b_dva, hdr-&gt;b_birth)))
<span class="lineNum">     936 </span>                :            : 
<span class="lineNum">     937 </span>                :            : uint64_t zfs_crc64_table[256];
<span class="lineNum">     938 </span>                :            : 
<span class="lineNum">     939 </span>                :            : /*
<span class="lineNum">     940 </span>                :            :  * Level 2 ARC
<span class="lineNum">     941 </span>                :            :  */
<span class="lineNum">     942 </span>                :            : 
<span class="lineNum">     943 </span>                :            : #define L2ARC_WRITE_SIZE        (8 * 1024 * 1024)       /* initial write max */
<span class="lineNum">     944 </span>                :            : #define L2ARC_HEADROOM          2                       /* num of writes */
<span class="lineNum">     945 </span>                :            : 
<span class="lineNum">     946 </span>                :            : /*
<span class="lineNum">     947 </span>                :            :  * If we discover during ARC scan any buffers to be compressed, we boost
<span class="lineNum">     948 </span>                :            :  * our headroom for the next scanning cycle by this percentage multiple.
<span class="lineNum">     949 </span>                :            :  */
<span class="lineNum">     950 </span>                :            : #define L2ARC_HEADROOM_BOOST    200
<span class="lineNum">     951 </span>                :            : #define L2ARC_FEED_SECS         1               /* caching interval secs */
<span class="lineNum">     952 </span>                :            : #define L2ARC_FEED_MIN_MS       200             /* min caching interval ms */
<span class="lineNum">     953 </span>                :            : 
<span class="lineNum">     954 </span>                :            : /*
<span class="lineNum">     955 </span>                :            :  * We can feed L2ARC from two states of ARC buffers, mru and mfu,
<span class="lineNum">     956 </span>                :            :  * and each of the state has two types: data and metadata.
<span class="lineNum">     957 </span>                :            :  */
<span class="lineNum">     958 </span>                :            : #define L2ARC_FEED_TYPES        4
<span class="lineNum">     959 </span>                :            : 
<span class="lineNum">     960 </span>                :            : #define l2arc_writes_sent       ARCSTAT(arcstat_l2_writes_sent)
<span class="lineNum">     961 </span>                :            : #define l2arc_writes_done       ARCSTAT(arcstat_l2_writes_done)
<span class="lineNum">     962 </span>                :            : 
<span class="lineNum">     963 </span>                :            : /* L2ARC Performance Tunables */
<span class="lineNum">     964 </span>                :            : unsigned long l2arc_write_max = L2ARC_WRITE_SIZE;       /* def max write size */
<span class="lineNum">     965 </span>                :            : unsigned long l2arc_write_boost = L2ARC_WRITE_SIZE;     /* extra warmup write */
<span class="lineNum">     966 </span>                :            : unsigned long l2arc_headroom = L2ARC_HEADROOM;          /* # of dev writes */
<span class="lineNum">     967 </span>                :            : unsigned long l2arc_headroom_boost = L2ARC_HEADROOM_BOOST;
<span class="lineNum">     968 </span>                :            : unsigned long l2arc_feed_secs = L2ARC_FEED_SECS;        /* interval seconds */
<span class="lineNum">     969 </span>                :            : unsigned long l2arc_feed_min_ms = L2ARC_FEED_MIN_MS;    /* min interval msecs */
<span class="lineNum">     970 </span>                :            : int l2arc_noprefetch = B_TRUE;                  /* don't cache prefetch bufs */
<span class="lineNum">     971 </span>                :            : int l2arc_feed_again = B_TRUE;                  /* turbo warmup */
<span class="lineNum">     972 </span>                :            : int l2arc_norw = B_FALSE;                       /* no reads during writes */
<span class="lineNum">     973 </span>                :            : 
<span class="lineNum">     974 </span>                :            : /*
<span class="lineNum">     975 </span>                :            :  * L2ARC Internals
<span class="lineNum">     976 </span>                :            :  */
<span class="lineNum">     977 </span>                :            : static list_t L2ARC_dev_list;                   /* device list */
<span class="lineNum">     978 </span>                :            : static list_t *l2arc_dev_list;                  /* device list pointer */
<span class="lineNum">     979 </span>                :            : static kmutex_t l2arc_dev_mtx;                  /* device list mutex */
<span class="lineNum">     980 </span>                :            : static l2arc_dev_t *l2arc_dev_last;             /* last device used */
<span class="lineNum">     981 </span>                :            : static list_t L2ARC_free_on_write;              /* free after write buf list */
<span class="lineNum">     982 </span>                :            : static list_t *l2arc_free_on_write;             /* free after write list ptr */
<span class="lineNum">     983 </span>                :            : static kmutex_t l2arc_free_on_write_mtx;        /* mutex for list */
<span class="lineNum">     984 </span>                :            : static uint64_t l2arc_ndev;                     /* number of devices */
<span class="lineNum">     985 </span>                :            : 
<span class="lineNum">     986 </span>                :            : typedef struct l2arc_read_callback {
<span class="lineNum">     987 </span>                :            :         arc_buf_hdr_t           *l2rcb_hdr;             /* read header */
<span class="lineNum">     988 </span>                :            :         blkptr_t                l2rcb_bp;               /* original blkptr */
<span class="lineNum">     989 </span>                :            :         zbookmark_phys_t        l2rcb_zb;               /* original bookmark */
<span class="lineNum">     990 </span>                :            :         int                     l2rcb_flags;            /* original flags */
<span class="lineNum">     991 </span>                :            :         abd_t                   *l2rcb_abd;             /* temporary buffer */
<span class="lineNum">     992 </span>                :            : } l2arc_read_callback_t;
<span class="lineNum">     993 </span>                :            : 
<span class="lineNum">     994 </span>                :            : typedef struct l2arc_data_free {
<span class="lineNum">     995 </span>                :            :         /* protected by l2arc_free_on_write_mtx */
<span class="lineNum">     996 </span>                :            :         abd_t           *l2df_abd;
<span class="lineNum">     997 </span>                :            :         size_t          l2df_size;
<span class="lineNum">     998 </span>                :            :         arc_buf_contents_t l2df_type;
<span class="lineNum">     999 </span>                :            :         list_node_t     l2df_list_node;
<span class="lineNum">    1000 </span>                :            : } l2arc_data_free_t;
<span class="lineNum">    1001 </span>                :            : 
<span class="lineNum">    1002 </span>                :            : typedef enum arc_fill_flags {
<span class="lineNum">    1003 </span>                :            :         ARC_FILL_LOCKED         = 1 &lt;&lt; 0, /* hdr lock is held */
<span class="lineNum">    1004 </span>                :            :         ARC_FILL_COMPRESSED     = 1 &lt;&lt; 1, /* fill with compressed data */
<span class="lineNum">    1005 </span>                :            :         ARC_FILL_ENCRYPTED      = 1 &lt;&lt; 2, /* fill with encrypted data */
<span class="lineNum">    1006 </span>                :            :         ARC_FILL_NOAUTH         = 1 &lt;&lt; 3, /* don't attempt to authenticate */
<span class="lineNum">    1007 </span>                :            :         ARC_FILL_IN_PLACE       = 1 &lt;&lt; 4  /* fill in place (special case) */
<span class="lineNum">    1008 </span>                :            : } arc_fill_flags_t;
<span class="lineNum">    1009 </span>                :            : 
<span class="lineNum">    1010 </span>                :            : static kmutex_t l2arc_feed_thr_lock;
<span class="lineNum">    1011 </span>                :            : static kcondvar_t l2arc_feed_thr_cv;
<span class="lineNum">    1012 </span>                :            : static uint8_t l2arc_thread_exit;
<span class="lineNum">    1013 </span>                :            : 
<span class="lineNum">    1014 </span>                :            : static abd_t *arc_get_data_abd(arc_buf_hdr_t *, uint64_t, void *);
<span class="lineNum">    1015 </span>                :            : static void *arc_get_data_buf(arc_buf_hdr_t *, uint64_t, void *);
<span class="lineNum">    1016 </span>                :            : static void arc_get_data_impl(arc_buf_hdr_t *, uint64_t, void *);
<span class="lineNum">    1017 </span>                :            : static void arc_free_data_abd(arc_buf_hdr_t *, abd_t *, uint64_t, void *);
<span class="lineNum">    1018 </span>                :            : static void arc_free_data_buf(arc_buf_hdr_t *, void *, uint64_t, void *);
<span class="lineNum">    1019 </span>                :            : static void arc_free_data_impl(arc_buf_hdr_t *hdr, uint64_t size, void *tag);
<span class="lineNum">    1020 </span>                :            : static void arc_hdr_free_abd(arc_buf_hdr_t *, boolean_t);
<span class="lineNum">    1021 </span>                :            : static void arc_hdr_alloc_abd(arc_buf_hdr_t *, boolean_t);
<span class="lineNum">    1022 </span>                :            : static void arc_access(arc_buf_hdr_t *, kmutex_t *);
<span class="lineNum">    1023 </span>                :            : static boolean_t arc_is_overflowing(void);
<span class="lineNum">    1024 </span>                :            : static void arc_buf_watch(arc_buf_t *);
<span class="lineNum">    1025 </span>                :            : static void arc_tuning_update(void);
<span class="lineNum">    1026 </span>                :            : static void arc_prune_async(int64_t);
<span class="lineNum">    1027 </span>                :            : static uint64_t arc_all_memory(void);
<span class="lineNum">    1028 </span>                :            : 
<span class="lineNum">    1029 </span>                :            : static arc_buf_contents_t arc_buf_type(arc_buf_hdr_t *);
<span class="lineNum">    1030 </span>                :            : static uint32_t arc_bufc_to_flags(arc_buf_contents_t);
<span class="lineNum">    1031 </span>                :            : static inline void arc_hdr_set_flags(arc_buf_hdr_t *hdr, arc_flags_t flags);
<span class="lineNum">    1032 </span>                :            : static inline void arc_hdr_clear_flags(arc_buf_hdr_t *hdr, arc_flags_t flags);
<span class="lineNum">    1033 </span>                :            : 
<span class="lineNum">    1034 </span>                :            : static boolean_t l2arc_write_eligible(uint64_t, arc_buf_hdr_t *);
<span class="lineNum">    1035 </span>                :            : static void l2arc_read_done(zio_t *);
<a name="1036"><span class="lineNum">    1036 </span>                :            : </a>
<span class="lineNum">    1037 </span>                :            : static uint64_t
<span class="lineNum">    1038 </span>                :<span class="lineCov"> 1063621372 : buf_hash(uint64_t spa, const dva_t *dva, uint64_t birth)</span>
<span class="lineNum">    1039 </span>                :            : {
<span class="lineNum">    1040 </span>                :<span class="lineCov"> 1063621372 :         uint8_t *vdva = (uint8_t *)dva;</span>
<span class="lineNum">    1041 </span>                :<span class="lineCov"> 1063621372 :         uint64_t crc = -1ULL;</span>
<span class="lineNum">    1042 </span>                :            :         int i;
<span class="lineNum">    1043 </span>                :            : 
<span class="lineNum">    1044 </span>        [<span class="branchCov" title="Branch 0 was taken 1063621372 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov"> 1063621372 :         ASSERT(zfs_crc64_table[128] == ZFS_CRC64_POLY);</span>
<span class="lineNum">    1045 </span>                :            : 
<span class="lineNum">    1046 </span>        [<span class="branchCov" title="Branch 0 was taken 4129791376 times"> + </span><span class="branchCov" title="Branch 1 was taken 1063621372 times"> + </span>]:<span class="lineCov">18078314636 :         for (i = 0; i &lt; sizeof (dva_t); i++)</span>
<span class="lineNum">    1047 </span>                :<span class="lineCov">17014693264 :                 crc = (crc &gt;&gt; 8) ^ zfs_crc64_table[(crc ^ vdva[i]) &amp; 0xFF];</span>
<span class="lineNum">    1048 </span>                :            : 
<span class="lineNum">    1049 </span>                :<span class="lineCov"> 1063621372 :         crc ^= (spa&gt;&gt;8) ^ birth;</span>
<span class="lineNum">    1050 </span>                :            : 
<span class="lineNum">    1051 </span>                :<span class="lineCov"> 1063621372 :         return (crc);</span>
<span class="lineNum">    1052 </span>                :            : }
<span class="lineNum">    1053 </span>                :            : 
<span class="lineNum">    1054 </span>                :            : #define HDR_EMPTY(hdr)                                          \
<span class="lineNum">    1055 </span>                :            :         ((hdr)-&gt;b_dva.dva_word[0] == 0 &amp;&amp;                    \
<span class="lineNum">    1056 </span>                :            :         (hdr)-&gt;b_dva.dva_word[1] == 0)
<span class="lineNum">    1057 </span>                :            : 
<span class="lineNum">    1058 </span>                :            : #define HDR_EQUAL(spa, dva, birth, hdr)                         \
<span class="lineNum">    1059 </span>                :            :         ((hdr)-&gt;b_dva.dva_word[0] == (dva)-&gt;dva_word[0]) &amp;&amp;       \
<span class="lineNum">    1060 </span>                :            :         ((hdr)-&gt;b_dva.dva_word[1] == (dva)-&gt;dva_word[1]) &amp;&amp;       \
<span class="lineNum">    1061 </span>                :            :         ((hdr)-&gt;b_birth == birth) &amp;&amp; ((hdr)-&gt;b_spa == spa)
<a name="1062"><span class="lineNum">    1062 </span>                :            : </a>
<span class="lineNum">    1063 </span>                :            : static void
<span class="lineNum">    1064 </span>                :<span class="lineCov">    1091865 : buf_discard_identity(arc_buf_hdr_t *hdr)</span>
<span class="lineNum">    1065 </span>                :            : {
<span class="lineNum">    1066 </span>                :<span class="lineCov">    1091865 :         hdr-&gt;b_dva.dva_word[0] = 0;</span>
<span class="lineNum">    1067 </span>                :<span class="lineCov">    1091865 :         hdr-&gt;b_dva.dva_word[1] = 0;</span>
<span class="lineNum">    1068 </span>                :<span class="lineCov">    1091865 :         hdr-&gt;b_birth = 0;</span>
<span class="lineNum">    1069 </span>                :<span class="lineCov">    1091865 : }</span>
<a name="1070"><span class="lineNum">    1070 </span>                :            : </a>
<span class="lineNum">    1071 </span>                :            : static arc_buf_hdr_t *
<span class="lineNum">    1072 </span>                :<span class="lineCov">    1653264 : buf_hash_find(uint64_t spa, const blkptr_t *bp, kmutex_t **lockp)</span>
<span class="lineNum">    1073 </span>                :            : {
<span class="lineNum">    1074 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1653264 times"> + </span>]:<span class="lineCov">    1653264 :         const dva_t *dva = BP_IDENTITY(bp);</span>
<span class="lineNum">    1075 </span>        [<span class="branchCov" title="Branch 0 was taken 1651556 times"> + </span><span class="branchCov" title="Branch 1 was taken 1708 times"> + </span>]:<span class="lineCov">    1653264 :         uint64_t birth = BP_PHYSICAL_BIRTH(bp);</span>
<span class="lineNum">    1076 </span>                :<span class="lineCov">    1653264 :         uint64_t idx = BUF_HASH_INDEX(spa, dva, birth);</span>
<span class="lineNum">    1077 </span>                :<span class="lineCov">    1653316 :         kmutex_t *hash_lock = BUF_HASH_LOCK(idx);</span>
<span class="lineNum">    1078 </span>                :            :         arc_buf_hdr_t *hdr;
<span class="lineNum">    1079 </span>                :            : 
<span class="lineNum">    1080 </span>                :<span class="lineCov">    1653316 :         mutex_enter(hash_lock);</span>
<span class="lineNum">    1081 </span>        [<span class="branchCov" title="Branch 0 was taken 996544 times"> + </span><span class="branchCov" title="Branch 1 was taken 657184 times"> + </span>]:<span class="lineCov">    1653728 :         for (hdr = buf_hash_table.ht_table[idx]; hdr != NULL;</span>
<span class="lineNum">    1082 </span>                :<span class="lineCov">        616 :             hdr = hdr-&gt;b_hash_next) {</span>
<span class="lineNum">    1083 </span>[<span class="branchCov" title="Branch 0 was taken 996411 times"> + </span><span class="branchCov" title="Branch 1 was taken 133 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 995962 times"> + </span><span class="branchCov" title="Branch 3 was taken 449 times"> + </span>]:<span class="lineCov">     996544 :                 if (HDR_EQUAL(spa, dva, birth, hdr)) {</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 995929 times"> + </span><span class="branchCov" title="Branch 5 was taken 33 times"> + </span>][<span class="branchCov" title="Branch 6 was taken 995928 times"> + </span><span class="branchCov" title="Branch 7 was taken 1 time"> + </span>]
<span class="lineNum">    1084 </span>                :<span class="lineCov">     995928 :                         *lockp = hash_lock;</span>
<span class="lineNum">    1085 </span>                :<span class="lineCov">     995928 :                         return (hdr);</span>
<span class="lineNum">    1086 </span>                :            :                 }
<span class="lineNum">    1087 </span>                :            :         }
<span class="lineNum">    1088 </span>                :<span class="lineCov">     657184 :         mutex_exit(hash_lock);</span>
<span class="lineNum">    1089 </span>                :<span class="lineCov">     657185 :         *lockp = NULL;</span>
<span class="lineNum">    1090 </span>                :<span class="lineCov">     657185 :         return (NULL);</span>
<span class="lineNum">    1091 </span>                :            : }
<span class="lineNum">    1092 </span>                :            : 
<span class="lineNum">    1093 </span>                :            : /*
<span class="lineNum">    1094 </span>                :            :  * Insert an entry into the hash table.  If there is already an element
<span class="lineNum">    1095 </span>                :            :  * equal to elem in the hash table, then the already existing element
<span class="lineNum">    1096 </span>                :            :  * will be returned and the new element will not be inserted.
<span class="lineNum">    1097 </span>                :            :  * Otherwise returns NULL.
<span class="lineNum">    1098 </span>                :            :  * If lockp == NULL, the caller is assumed to already hold the hash lock.
<a name="1099"><span class="lineNum">    1099 </span>                :            :  */</a>
<span class="lineNum">    1100 </span>                :            : static arc_buf_hdr_t *
<span class="lineNum">    1101 </span>                :<span class="lineCov">     910218 : buf_hash_insert(arc_buf_hdr_t *hdr, kmutex_t **lockp)</span>
<span class="lineNum">    1102 </span>                :            : {
<span class="lineNum">    1103 </span>                :<span class="lineCov">     910218 :         uint64_t idx = BUF_HASH_INDEX(hdr-&gt;b_spa, &amp;hdr-&gt;b_dva, hdr-&gt;b_birth);</span>
<span class="lineNum">    1104 </span>                :<span class="lineCov">     910199 :         kmutex_t *hash_lock = BUF_HASH_LOCK(idx);</span>
<span class="lineNum">    1105 </span>                :            :         arc_buf_hdr_t *fhdr;
<span class="lineNum">    1106 </span>                :            :         uint32_t i;
<span class="lineNum">    1107 </span>                :            : 
<span class="lineNum">    1108 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 910199 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     910199 :         ASSERT(!DVA_IS_EMPTY(&amp;hdr-&gt;b_dva));</span>
<span class="lineNum">    1109 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 910199 times"> + </span>]:<span class="lineCov">     910199 :         ASSERT(hdr-&gt;b_birth != 0);</span>
<span class="lineNum">    1110 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 910199 times"> + </span>]:<span class="lineCov">     910199 :         ASSERT(!HDR_IN_HASH_TABLE(hdr));</span>
<span class="lineNum">    1111 </span>                :            : 
<span class="lineNum">    1112 </span>        [<span class="branchCov" title="Branch 0 was taken 907455 times"> + </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>]:<span class="lineCov">     910199 :         if (lockp != NULL) {</span>
<span class="lineNum">    1113 </span>                :<span class="lineCov">     907455 :                 *lockp = hash_lock;</span>
<span class="lineNum">    1114 </span>                :<span class="lineCov">     907455 :                 mutex_enter(hash_lock);</span>
<span class="lineNum">    1115 </span>                :            :         } else {
<span class="lineNum">    1116 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 2744 times"> + </span>]:<span class="lineCov">       2744 :                 ASSERT(MUTEX_HELD(hash_lock));</span>
<span class="lineNum">    1117 </span>                :            :         }
<span class="lineNum">    1118 </span>                :            : 
<span class="lineNum">    1119 </span>        [<span class="branchCov" title="Branch 0 was taken 17918 times"> + </span><span class="branchCov" title="Branch 1 was taken 892949 times"> + </span>]:<span class="lineCov">     910867 :         for (fhdr = buf_hash_table.ht_table[idx], i = 0; fhdr != NULL;</span>
<span class="lineNum">    1120 </span>                :<span class="lineCov">        681 :             fhdr = fhdr-&gt;b_hash_next, i++) {</span>
<span class="lineNum">    1121 </span>[<span class="branchCov" title="Branch 0 was taken 17724 times"> + </span><span class="branchCov" title="Branch 1 was taken 194 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 17237 times"> + </span><span class="branchCov" title="Branch 3 was taken 487 times"> + </span>]:<span class="lineCov">      17918 :                 if (HDR_EQUAL(hdr-&gt;b_spa, &amp;hdr-&gt;b_dva, hdr-&gt;b_birth, fhdr))</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 17237 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchCov" title="Branch 7 was taken 17237 times"> + </span>]
<span class="lineNum">    1122 </span>                :            :                         return (fhdr);
<span class="lineNum">    1123 </span>                :            :         }
<span class="lineNum">    1124 </span>                :            : 
<span class="lineNum">    1125 </span>                :<span class="lineCov">     892949 :         hdr-&gt;b_hash_next = buf_hash_table.ht_table[idx];</span>
<span class="lineNum">    1126 </span>                :<span class="lineCov">     892949 :         buf_hash_table.ht_table[idx] = hdr;</span>
<span class="lineNum">    1127 </span>                :<span class="lineCov">     892949 :         arc_hdr_set_flags(hdr, ARC_FLAG_IN_HASH_TABLE);</span>
<span class="lineNum">    1128 </span>                :            : 
<span class="lineNum">    1129 </span>                :            :         /* collect some hash table performance data */
<span class="lineNum">    1130 </span>        [<span class="branchCov" title="Branch 0 was taken 680 times"> + </span><span class="branchCov" title="Branch 1 was taken 892278 times"> + </span>]:<span class="lineCov">     892958 :         if (i &gt; 0) {</span>
<span class="lineNum">    1131 </span>                :<span class="lineCov">        680 :                 ARCSTAT_BUMP(arcstat_hash_collisions);</span>
<span class="lineNum">    1132 </span>        [<span class="branchCov" title="Branch 0 was taken 680 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        680 :                 if (i == 1)</span>
<span class="lineNum">    1133 </span>                :<span class="lineCov">        680 :                         ARCSTAT_BUMP(arcstat_hash_chains);</span>
<span class="lineNum">    1134 </span>                :            : 
<span class="lineNum">    1135 </span>[<span class="branchCov" title="Branch 0 was taken 78 times"> + </span><span class="branchCov" title="Branch 1 was taken 602 times"> + </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 78 times"> + </span>]:<span class="lineCov">        680 :                 ARCSTAT_MAX(arcstat_hash_chain_max, i);</span>
<span class="lineNum">    1136 </span>                :            :         }
<span class="lineNum">    1137 </span>                :            : 
<span class="lineNum">    1138 </span>                :<span class="lineCov">     892958 :         ARCSTAT_BUMP(arcstat_hash_elements);</span>
<span class="lineNum">    1139 </span>[<span class="branchCov" title="Branch 0 was taken 233100 times"> + </span><span class="branchCov" title="Branch 1 was taken 659877 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 7 times"> + </span><span class="branchCov" title="Branch 4 was taken 233092 times"> + </span>]:<span class="lineCov">     892977 :         ARCSTAT_MAXSTAT(arcstat_hash_elements);</span>
<span class="lineNum">    1140 </span>                :            : 
<span class="lineNum">    1141 </span>                :            :         return (NULL);
<span class="lineNum">    1142 </span>                :            : }
<a name="1143"><span class="lineNum">    1143 </span>                :            : </a>
<span class="lineNum">    1144 </span>                :            : static void
<span class="lineNum">    1145 </span>                :<span class="lineCov">     892892 : buf_hash_remove(arc_buf_hdr_t *hdr)</span>
<span class="lineNum">    1146 </span>                :            : {
<span class="lineNum">    1147 </span>                :            :         arc_buf_hdr_t *fhdr, **hdrp;
<span class="lineNum">    1148 </span>                :<span class="lineCov">     892892 :         uint64_t idx = BUF_HASH_INDEX(hdr-&gt;b_spa, &amp;hdr-&gt;b_dva, hdr-&gt;b_birth);</span>
<span class="lineNum">    1149 </span>                :            : 
<span class="lineNum">    1150 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 892921 times"> + </span>]:<span class="lineCov">     892889 :         ASSERT(MUTEX_HELD(BUF_HASH_LOCK(idx)));</span>
<span class="lineNum">    1151 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 892921 times"> + </span>]:<span class="lineCov">     892921 :         ASSERT(HDR_IN_HASH_TABLE(hdr));</span>
<span class="lineNum">    1152 </span>                :            : 
<span class="lineNum">    1153 </span>                :<span class="lineCov">     892921 :         hdrp = &amp;buf_hash_table.ht_table[idx];</span>
<span class="lineNum">    1154 </span>        [<span class="branchCov" title="Branch 0 was taken 236 times"> + </span><span class="branchCov" title="Branch 1 was taken 892921 times"> + </span>]:<span class="lineCov">     893157 :         while ((fhdr = *hdrp) != hdr) {</span>
<span class="lineNum">    1155 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 236 times"> + </span>]:<span class="lineCov">        236 :                 ASSERT3P(fhdr, !=, NULL);</span>
<span class="lineNum">    1156 </span>                :<span class="lineCov">        236 :                 hdrp = &amp;fhdr-&gt;b_hash_next;</span>
<span class="lineNum">    1157 </span>                :            :         }
<span class="lineNum">    1158 </span>                :<span class="lineCov">     892921 :         *hdrp = hdr-&gt;b_hash_next;</span>
<span class="lineNum">    1159 </span>                :<span class="lineCov">     892921 :         hdr-&gt;b_hash_next = NULL;</span>
<span class="lineNum">    1160 </span>                :<span class="lineCov">     892921 :         arc_hdr_clear_flags(hdr, ARC_FLAG_IN_HASH_TABLE);</span>
<span class="lineNum">    1161 </span>                :            : 
<span class="lineNum">    1162 </span>                :            :         /* collect some hash table performance data */
<span class="lineNum">    1163 </span>                :<span class="lineCov">     892920 :         ARCSTAT_BUMPDOWN(arcstat_hash_elements);</span>
<span class="lineNum">    1164 </span>                :            : 
<span class="lineNum">    1165 </span>[<span class="branchCov" title="Branch 0 was taken 680 times"> + </span><span class="branchCov" title="Branch 1 was taken 892239 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 680 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">     892919 :         if (buf_hash_table.ht_table[idx] &amp;&amp;</span>
<span class="lineNum">    1166 </span>                :<span class="lineCov">        680 :             buf_hash_table.ht_table[idx]-&gt;b_hash_next == NULL)</span>
<span class="lineNum">    1167 </span>                :<span class="lineCov">        680 :                 ARCSTAT_BUMPDOWN(arcstat_hash_chains);</span>
<span class="lineNum">    1168 </span>                :<span class="lineCov">     892919 : }</span>
<span class="lineNum">    1169 </span>                :            : 
<span class="lineNum">    1170 </span>                :            : /*
<span class="lineNum">    1171 </span>                :            :  * Global data structures and functions for the buf kmem cache.
<span class="lineNum">    1172 </span>                :            :  */
<span class="lineNum">    1173 </span>                :            : 
<span class="lineNum">    1174 </span>                :            : static kmem_cache_t *hdr_full_cache;
<span class="lineNum">    1175 </span>                :            : static kmem_cache_t *hdr_full_crypt_cache;
<span class="lineNum">    1176 </span>                :            : static kmem_cache_t *hdr_l2only_cache;
<span class="lineNum">    1177 </span>                :            : static kmem_cache_t *buf_cache;
<a name="1178"><span class="lineNum">    1178 </span>                :            : </a>
<span class="lineNum">    1179 </span>                :            : static void
<span class="lineNum">    1180 </span>                :<span class="lineCov">        785 : buf_fini(void)</span>
<span class="lineNum">    1181 </span>                :            : {
<span class="lineNum">    1182 </span>                :            :         int i;
<span class="lineNum">    1183 </span>                :            : 
<span class="lineNum">    1184 </span>                :            : #if defined(_KERNEL) &amp;&amp; defined(HAVE_SPL)
<span class="lineNum">    1185 </span>                :            :         /*
<span class="lineNum">    1186 </span>                :            :          * Large allocations which do not require contiguous pages
<span class="lineNum">    1187 </span>                :            :          * should be using vmem_free() in the linux kernel\
<span class="lineNum">    1188 </span>                :            :          */
<span class="lineNum">    1189 </span>                :            :         vmem_free(buf_hash_table.ht_table,
<span class="lineNum">    1190 </span>                :            :             (buf_hash_table.ht_mask + 1) * sizeof (void *));
<span class="lineNum">    1191 </span>                :            : #else
<span class="lineNum">    1192 </span>                :<span class="lineCov">        785 :         kmem_free(buf_hash_table.ht_table,</span>
<span class="lineNum">    1193 </span>                :            :             (buf_hash_table.ht_mask + 1) * sizeof (void *));
<span class="lineNum">    1194 </span>                :            : #endif
<span class="lineNum">    1195 </span>        [<span class="branchCov" title="Branch 1 was taken 6430720 times"> + </span><span class="branchCov" title="Branch 2 was taken 785 times"> + </span>]:<span class="lineCov">    6431505 :         for (i = 0; i &lt; BUF_LOCKS; i++)</span>
<span class="lineNum">    1196 </span>                :<span class="lineCov">    6430720 :                 mutex_destroy(&amp;buf_hash_table.ht_locks[i].ht_lock);</span>
<span class="lineNum">    1197 </span>                :<span class="lineCov">        785 :         kmem_cache_destroy(hdr_full_cache);</span>
<span class="lineNum">    1198 </span>                :<span class="lineCov">        785 :         kmem_cache_destroy(hdr_full_crypt_cache);</span>
<span class="lineNum">    1199 </span>                :<span class="lineCov">        785 :         kmem_cache_destroy(hdr_l2only_cache);</span>
<span class="lineNum">    1200 </span>                :<span class="lineCov">        785 :         kmem_cache_destroy(buf_cache);</span>
<span class="lineNum">    1201 </span>                :<span class="lineCov">        785 : }</span>
<span class="lineNum">    1202 </span>                :            : 
<span class="lineNum">    1203 </span>                :            : /*
<span class="lineNum">    1204 </span>                :            :  * Constructor callback - called when the cache is empty
<span class="lineNum">    1205 </span>                :            :  * and a new buf is requested.
<span class="lineNum">    1206 </span>                :            :  */
<a name="1207"><span class="lineNum">    1207 </span>                :            : /* ARGSUSED */</a>
<span class="lineNum">    1208 </span>                :            : static int
<span class="lineNum">    1209 </span>                :<span class="lineCov">  499058138 : hdr_full_cons(void *vbuf, void *unused, int kmflag)</span>
<span class="lineNum">    1210 </span>                :            : {
<span class="lineNum">    1211 </span>                :<span class="lineCov">  499058138 :         arc_buf_hdr_t *hdr = vbuf;</span>
<span class="lineNum">    1212 </span>                :            : 
<span class="lineNum">    1213 </span>                :<span class="lineCov">  499058138 :         bzero(hdr, HDR_FULL_SIZE);</span>
<span class="lineNum">    1214 </span>                :<span class="lineCov">  499058138 :         cv_init(&amp;hdr-&gt;b_l1hdr.b_cv, NULL, CV_DEFAULT, NULL);</span>
<span class="lineNum">    1215 </span>                :<span class="lineCov">  499057893 :         refcount_create(&amp;hdr-&gt;b_l1hdr.b_refcnt);</span>
<span class="lineNum">    1216 </span>                :<span class="lineCov">  499057933 :         mutex_init(&amp;hdr-&gt;b_l1hdr.b_freeze_lock, NULL, MUTEX_DEFAULT, NULL);</span>
<span class="lineNum">    1217 </span>                :<span class="lineCov">  499058134 :         list_link_init(&amp;hdr-&gt;b_l1hdr.b_arc_node);</span>
<span class="lineNum">    1218 </span>                :<span class="lineCov">  499057546 :         list_link_init(&amp;hdr-&gt;b_l2hdr.b_l2node);</span>
<span class="lineNum">    1219 </span>                :<span class="lineCov">  499057500 :         multilist_link_init(&amp;hdr-&gt;b_l1hdr.b_arc_node);</span>
<span class="lineNum">    1220 </span>                :<span class="lineCov">  499057606 :         arc_space_consume(HDR_FULL_SIZE, ARC_SPACE_HDRS);</span>
<span class="lineNum">    1221 </span>                :            : 
<span class="lineNum">    1222 </span>                :<span class="lineCov">  499058790 :         return (0);</span>
<span class="lineNum">    1223 </span>                :            : }
<span class="lineNum">    1224 </span>                :            : 
<a name="1225"><span class="lineNum">    1225 </span>                :            : /* ARGSUSED */</a>
<span class="lineNum">    1226 </span>                :            : static int
<span class="lineNum">    1227 </span>                :<span class="lineNoCov">          0 : hdr_full_crypt_cons(void *vbuf, void *unused, int kmflag)</span>
<span class="lineNum">    1228 </span>                :            : {
<span class="lineNum">    1229 </span>                :<span class="lineNoCov">          0 :         arc_buf_hdr_t *hdr = vbuf;</span>
<span class="lineNum">    1230 </span>                :            : 
<span class="lineNum">    1231 </span>                :<span class="lineNoCov">          0 :         hdr_full_cons(vbuf, unused, kmflag);</span>
<span class="lineNum">    1232 </span>                :<span class="lineNoCov">          0 :         bzero(&amp;hdr-&gt;b_crypt_hdr, sizeof (hdr-&gt;b_crypt_hdr));</span>
<span class="lineNum">    1233 </span>                :<span class="lineNoCov">          0 :         arc_space_consume(sizeof (hdr-&gt;b_crypt_hdr), ARC_SPACE_HDRS);</span>
<span class="lineNum">    1234 </span>                :            : 
<span class="lineNum">    1235 </span>                :<span class="lineNoCov">          0 :         return (0);</span>
<span class="lineNum">    1236 </span>                :            : }
<span class="lineNum">    1237 </span>                :            : 
<a name="1238"><span class="lineNum">    1238 </span>                :            : /* ARGSUSED */</a>
<span class="lineNum">    1239 </span>                :            : static int
<span class="lineNum">    1240 </span>                :<span class="lineCov">       3134 : hdr_l2only_cons(void *vbuf, void *unused, int kmflag)</span>
<span class="lineNum">    1241 </span>                :            : {
<span class="lineNum">    1242 </span>                :<span class="lineCov">       3134 :         arc_buf_hdr_t *hdr = vbuf;</span>
<span class="lineNum">    1243 </span>                :            : 
<span class="lineNum">    1244 </span>                :<span class="lineCov">       3134 :         bzero(hdr, HDR_L2ONLY_SIZE);</span>
<span class="lineNum">    1245 </span>                :<span class="lineCov">       3134 :         arc_space_consume(HDR_L2ONLY_SIZE, ARC_SPACE_L2HDRS);</span>
<span class="lineNum">    1246 </span>                :            : 
<span class="lineNum">    1247 </span>                :<span class="lineCov">       3134 :         return (0);</span>
<span class="lineNum">    1248 </span>                :            : }
<span class="lineNum">    1249 </span>                :            : 
<a name="1250"><span class="lineNum">    1250 </span>                :            : /* ARGSUSED */</a>
<span class="lineNum">    1251 </span>                :            : static int
<span class="lineNum">    1252 </span>                :<span class="lineCov">    1637579 : buf_cons(void *vbuf, void *unused, int kmflag)</span>
<span class="lineNum">    1253 </span>                :            : {
<span class="lineNum">    1254 </span>                :<span class="lineCov">    1637579 :         arc_buf_t *buf = vbuf;</span>
<span class="lineNum">    1255 </span>                :            : 
<span class="lineNum">    1256 </span>                :<span class="lineCov">    1637579 :         bzero(buf, sizeof (arc_buf_t));</span>
<span class="lineNum">    1257 </span>                :<span class="lineCov">    1637579 :         mutex_init(&amp;buf-&gt;b_evict_lock, NULL, MUTEX_DEFAULT, NULL);</span>
<span class="lineNum">    1258 </span>                :<span class="lineCov">    1637459 :         arc_space_consume(sizeof (arc_buf_t), ARC_SPACE_HDRS);</span>
<span class="lineNum">    1259 </span>                :            : 
<span class="lineNum">    1260 </span>                :<span class="lineCov">    1638754 :         return (0);</span>
<span class="lineNum">    1261 </span>                :            : }
<span class="lineNum">    1262 </span>                :            : 
<span class="lineNum">    1263 </span>                :            : /*
<span class="lineNum">    1264 </span>                :            :  * Destructor callback - called when a cached buf is
<span class="lineNum">    1265 </span>                :            :  * no longer required.
<span class="lineNum">    1266 </span>                :            :  */
<a name="1267"><span class="lineNum">    1267 </span>                :            : /* ARGSUSED */</a>
<span class="lineNum">    1268 </span>                :            : static void
<span class="lineNum">    1269 </span>                :<span class="lineCov">  499058599 : hdr_full_dest(void *vbuf, void *unused)</span>
<span class="lineNum">    1270 </span>                :            : {
<span class="lineNum">    1271 </span>                :<span class="lineCov">  499058599 :         arc_buf_hdr_t *hdr = vbuf;</span>
<span class="lineNum">    1272 </span>                :            : 
<span class="lineNum">    1273 </span>      [<span class="branchCov" title="Branch 0 was taken 499058650 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 499058705 times"> + </span>]:<span class="lineCov">  499058599 :         ASSERT(HDR_EMPTY(hdr));</span>
<span class="lineNum">    1274 </span>                :<span class="lineCov">  499058705 :         cv_destroy(&amp;hdr-&gt;b_l1hdr.b_cv);</span>
<span class="lineNum">    1275 </span>                :<span class="lineCov">  499058745 :         refcount_destroy(&amp;hdr-&gt;b_l1hdr.b_refcnt);</span>
<span class="lineNum">    1276 </span>                :<span class="lineCov">  499058690 :         mutex_destroy(&amp;hdr-&gt;b_l1hdr.b_freeze_lock);</span>
<span class="lineNum">    1277 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 499058597 times"> + </span>]:<span class="lineCov">  499058628 :         ASSERT(!multilist_link_active(&amp;hdr-&gt;b_l1hdr.b_arc_node));</span>
<span class="lineNum">    1278 </span>                :<span class="lineCov">  499058597 :         arc_space_return(HDR_FULL_SIZE, ARC_SPACE_HDRS);</span>
<span class="lineNum">    1279 </span>                :<span class="lineCov">  499058767 : }</span>
<span class="lineNum">    1280 </span>                :            : 
<a name="1281"><span class="lineNum">    1281 </span>                :            : /* ARGSUSED */</a>
<span class="lineNum">    1282 </span>                :            : static void
<span class="lineNum">    1283 </span>                :<span class="lineNoCov">          0 : hdr_full_crypt_dest(void *vbuf, void *unused)</span>
<span class="lineNum">    1284 </span>                :            : {
<span class="lineNum">    1285 </span>                :<span class="lineNoCov">          0 :         arc_buf_hdr_t *hdr = vbuf;</span>
<span class="lineNum">    1286 </span>                :            : 
<span class="lineNum">    1287 </span>                :<span class="lineNoCov">          0 :         hdr_full_dest(vbuf, unused);</span>
<span class="lineNum">    1288 </span>                :<span class="lineNoCov">          0 :         arc_space_return(sizeof (hdr-&gt;b_crypt_hdr), ARC_SPACE_HDRS);</span>
<span class="lineNum">    1289 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1290 </span>                :            : 
<a name="1291"><span class="lineNum">    1291 </span>                :            : /* ARGSUSED */</a>
<span class="lineNum">    1292 </span>                :            : static void
<span class="lineNum">    1293 </span>                :<span class="lineCov">       3134 : hdr_l2only_dest(void *vbuf, void *unused)</span>
<span class="lineNum">    1294 </span>                :            : {
<span class="lineNum">    1295 </span>                :<span class="lineCov">       3134 :         ASSERTV(arc_buf_hdr_t *hdr = vbuf);</span>
<span class="lineNum">    1296 </span>                :            : 
<span class="lineNum">    1297 </span>[<span class="branchCov" title="Branch 0 was taken 3134 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 3134 times"> + </span>]:<span class="lineCov">       3134 :         ASSERT(HDR_EMPTY(hdr));</span>
<span class="lineNum">    1298 </span>                :<span class="lineCov">       3134 :         arc_space_return(HDR_L2ONLY_SIZE, ARC_SPACE_L2HDRS);</span>
<span class="lineNum">    1299 </span>                :<span class="lineCov">       3134 : }</span>
<span class="lineNum">    1300 </span>                :            : 
<a name="1301"><span class="lineNum">    1301 </span>                :            : /* ARGSUSED */</a>
<span class="lineNum">    1302 </span>                :            : static void
<span class="lineNum">    1303 </span>                :<span class="lineCov">    1638314 : buf_dest(void *vbuf, void *unused)</span>
<span class="lineNum">    1304 </span>                :            : {
<span class="lineNum">    1305 </span>                :<span class="lineCov">    1638314 :         arc_buf_t *buf = vbuf;</span>
<span class="lineNum">    1306 </span>                :            : 
<span class="lineNum">    1307 </span>                :<span class="lineCov">    1638314 :         mutex_destroy(&amp;buf-&gt;b_evict_lock);</span>
<span class="lineNum">    1308 </span>                :<span class="lineCov">    1638224 :         arc_space_return(sizeof (arc_buf_t), ARC_SPACE_HDRS);</span>
<span class="lineNum">    1309 </span>                :<span class="lineCov">    1638472 : }</span>
<span class="lineNum">    1310 </span>                :            : 
<span class="lineNum">    1311 </span>                :            : /*
<span class="lineNum">    1312 </span>                :            :  * Reclaim callback -- invoked when memory is low.
<span class="lineNum">    1313 </span>                :            :  */
<a name="1314"><span class="lineNum">    1314 </span>                :            : /* ARGSUSED */</a>
<span class="lineNum">    1315 </span>                :            : static void
<span class="lineNum">    1316 </span>                :<span class="lineNoCov">          0 : hdr_recl(void *unused)</span>
<span class="lineNum">    1317 </span>                :            : {
<span class="lineNum">    1318 </span>                :<span class="lineNoCov">          0 :         dprintf(&quot;hdr_recl called\n&quot;);</span>
<span class="lineNum">    1319 </span>                :            :         /*
<span class="lineNum">    1320 </span>                :            :          * umem calls the reclaim func when we destroy the buf cache,
<span class="lineNum">    1321 </span>                :            :          * which is after we do arc_fini().
<span class="lineNum">    1322 </span>                :            :          */
<span class="lineNum">    1323 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!arc_dead)</span>
<span class="lineNum">    1324 </span>                :<span class="lineNoCov">          0 :                 cv_signal(&amp;arc_reclaim_thread_cv);</span>
<span class="lineNum">    1325 </span>                :<span class="lineNoCov">          0 : }</span>
<a name="1326"><span class="lineNum">    1326 </span>                :            : </a>
<span class="lineNum">    1327 </span>                :            : static void
<span class="lineNum">    1328 </span>                :<span class="lineCov">       1234 : buf_init(void)</span>
<span class="lineNum">    1329 </span>                :            : {
<span class="lineNum">    1330 </span>                :<span class="lineCov">       1234 :         uint64_t *ct = NULL;</span>
<span class="lineNum">    1331 </span>                :<span class="lineCov">       1234 :         uint64_t hsize = 1ULL &lt;&lt; 12;</span>
<span class="lineNum">    1332 </span>                :            :         int i, j;
<span class="lineNum">    1333 </span>                :            : 
<span class="lineNum">    1334 </span>                :            :         /*
<span class="lineNum">    1335 </span>                :            :          * The hash table is big enough to fill all of physical memory
<span class="lineNum">    1336 </span>                :            :          * with an average block size of zfs_arc_average_blocksize (default 8K).
<span class="lineNum">    1337 </span>                :            :          * By default, the table will take up
<span class="lineNum">    1338 </span>                :            :          * totalmem * sizeof(void*) / 8K (1MB per GB with 8-byte pointers).
<span class="lineNum">    1339 </span>                :            :          */
<span class="lineNum">    1340 </span>        [<span class="branchCov" title="Branch 1 was taken 9872 times"> + </span><span class="branchCov" title="Branch 2 was taken 1234 times"> + </span>]:<span class="lineCov">      11106 :         while (hsize * zfs_arc_average_blocksize &lt; arc_all_memory())</span>
<span class="lineNum">    1341 </span>                :<span class="lineCov">       9872 :                 hsize &lt;&lt;= 1;</span>
<span class="lineNum">    1342 </span>                :            : retry:
<span class="lineNum">    1343 </span>                :<span class="lineCov">       1234 :         buf_hash_table.ht_mask = hsize - 1;</span>
<span class="lineNum">    1344 </span>                :            : #if defined(_KERNEL) &amp;&amp; defined(HAVE_SPL)
<span class="lineNum">    1345 </span>                :            :         /*
<span class="lineNum">    1346 </span>                :            :          * Large allocations which do not require contiguous pages
<span class="lineNum">    1347 </span>                :            :          * should be using vmem_alloc() in the linux kernel
<span class="lineNum">    1348 </span>                :            :          */
<span class="lineNum">    1349 </span>                :            :         buf_hash_table.ht_table =
<span class="lineNum">    1350 </span>                :            :             vmem_zalloc(hsize * sizeof (void*), KM_SLEEP);
<span class="lineNum">    1351 </span>                :            : #else
<span class="lineNum">    1352 </span>                :<span class="lineCov">       1234 :         buf_hash_table.ht_table =</span>
<span class="lineNum">    1353 </span>                :<span class="lineCov">       1234 :             kmem_zalloc(hsize * sizeof (void*), KM_NOSLEEP);</span>
<span class="lineNum">    1354 </span>                :            : #endif
<span class="lineNum">    1355 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1234 times"> + </span>]:<span class="lineCov">       1234 :         if (buf_hash_table.ht_table == NULL) {</span>
<span class="lineNum">    1356 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT(hsize &gt; (1ULL &lt;&lt; 8));</span>
<span class="lineNum">    1357 </span>                :<span class="lineNoCov">          0 :                 hsize &gt;&gt;= 1;</span>
<span class="lineNum">    1358 </span>                :<span class="lineNoCov">          0 :                 goto retry;</span>
<span class="lineNum">    1359 </span>                :            :         }
<span class="lineNum">    1360 </span>                :            : 
<span class="lineNum">    1361 </span>                :<span class="lineCov">       1234 :         hdr_full_cache = kmem_cache_create(&quot;arc_buf_hdr_t_full&quot;, HDR_FULL_SIZE,</span>
<span class="lineNum">    1362 </span>                :            :             0, hdr_full_cons, hdr_full_dest, hdr_recl, NULL, NULL, 0);
<span class="lineNum">    1363 </span>                :<span class="lineCov">       1234 :         hdr_full_crypt_cache = kmem_cache_create(&quot;arc_buf_hdr_t_full_crypt&quot;,</span>
<span class="lineNum">    1364 </span>                :            :             HDR_FULL_CRYPT_SIZE, 0, hdr_full_crypt_cons, hdr_full_crypt_dest,
<span class="lineNum">    1365 </span>                :            :             hdr_recl, NULL, NULL, 0);
<span class="lineNum">    1366 </span>                :<span class="lineCov">       1234 :         hdr_l2only_cache = kmem_cache_create(&quot;arc_buf_hdr_t_l2only&quot;,</span>
<span class="lineNum">    1367 </span>                :            :             HDR_L2ONLY_SIZE, 0, hdr_l2only_cons, hdr_l2only_dest, hdr_recl,
<span class="lineNum">    1368 </span>                :            :             NULL, NULL, 0);
<span class="lineNum">    1369 </span>                :<span class="lineCov">       1234 :         buf_cache = kmem_cache_create(&quot;arc_buf_t&quot;, sizeof (arc_buf_t),</span>
<span class="lineNum">    1370 </span>                :            :             0, buf_cons, buf_dest, NULL, NULL, NULL, 0);
<span class="lineNum">    1371 </span>                :            : 
<span class="lineNum">    1372 </span>        [<span class="branchCov" title="Branch 0 was taken 315904 times"> + </span><span class="branchCov" title="Branch 1 was taken 1234 times"> + </span>]:<span class="lineCov">     317138 :         for (i = 0; i &lt; 256; i++)</span>
<span class="lineNum">    1373 </span>        [<span class="branchCov" title="Branch 0 was taken 2527232 times"> + </span><span class="branchCov" title="Branch 1 was taken 315904 times"> + </span>]:<span class="lineCov">    2843136 :                 for (ct = zfs_crc64_table + i, *ct = i, j = 8; j &gt; 0; j--)</span>
<span class="lineNum">    1374 </span>                :<span class="lineCov">    2527232 :                         *ct = (*ct &gt;&gt; 1) ^ (-(*ct &amp; 1) &amp; ZFS_CRC64_POLY);</span>
<span class="lineNum">    1375 </span>                :            : 
<span class="lineNum">    1376 </span>        [<span class="branchCov" title="Branch 0 was taken 10108928 times"> + </span><span class="branchCov" title="Branch 1 was taken 1234 times"> + </span>]:<span class="lineCov">   10110162 :         for (i = 0; i &lt; BUF_LOCKS; i++) {</span>
<span class="lineNum">    1377 </span>                :<span class="lineCov">   10108928 :                 mutex_init(&amp;buf_hash_table.ht_locks[i].ht_lock,</span>
<span class="lineNum">    1378 </span>                :            :                     NULL, MUTEX_DEFAULT, NULL);
<span class="lineNum">    1379 </span>                :            :         }
<span class="lineNum">    1380 </span>                :<span class="lineCov">       1234 : }</span>
<span class="lineNum">    1381 </span>                :            : 
<span class="lineNum">    1382 </span>                :            : #define ARC_MINTIME     (hz&gt;&gt;4) /* 62 ms */
<span class="lineNum">    1383 </span>                :            : 
<span class="lineNum">    1384 </span>                :            : /*
<span class="lineNum">    1385 </span>                :            :  * This is the size that the buf occupies in memory. If the buf is compressed,
<span class="lineNum">    1386 </span>                :            :  * it will correspond to the compressed size. You should use this method of
<span class="lineNum">    1387 </span>                :            :  * getting the buf size unless you explicitly need the logical size.
<a name="1388"><span class="lineNum">    1388 </span>                :            :  */</a>
<span class="lineNum">    1389 </span>                :            : uint64_t
<span class="lineNum">    1390 </span>                :<span class="lineCov">    9749283 : arc_buf_size(arc_buf_t *buf)</span>
<span class="lineNum">    1391 </span>                :            : {
<span class="lineNum">    1392 </span>                :<span class="lineCov">    9749283 :         return (ARC_BUF_COMPRESSED(buf) ?</span>
<span class="lineNum">    1393 </span>        [<span class="branchCov" title="Branch 0 was taken 30 times"> + </span><span class="branchCov" title="Branch 1 was taken 9749253 times"> + </span>]:<span class="lineCov">    9749283 :             HDR_GET_PSIZE(buf-&gt;b_hdr) : HDR_GET_LSIZE(buf-&gt;b_hdr));</span>
<span class="lineNum">    1394 </span>                :            : }
<a name="1395"><span class="lineNum">    1395 </span>                :            : </a>
<span class="lineNum">    1396 </span>                :            : uint64_t
<span class="lineNum">    1397 </span>                :<span class="lineCov">      26455 : arc_buf_lsize(arc_buf_t *buf)</span>
<span class="lineNum">    1398 </span>                :            : {
<span class="lineNum">    1399 </span>                :<span class="lineCov">      26455 :         return (HDR_GET_LSIZE(buf-&gt;b_hdr));</span>
<span class="lineNum">    1400 </span>                :            : }
<span class="lineNum">    1401 </span>                :            : 
<span class="lineNum">    1402 </span>                :            : /*
<span class="lineNum">    1403 </span>                :            :  * This function will return B_TRUE if the buffer is encrypted in memory.
<span class="lineNum">    1404 </span>                :            :  * This buffer can be decrypted by calling arc_untransform().
<a name="1405"><span class="lineNum">    1405 </span>                :            :  */</a>
<span class="lineNum">    1406 </span>                :            : boolean_t
<span class="lineNum">    1407 </span>                :<span class="lineCov">    1986011 : arc_is_encrypted(arc_buf_t *buf)</span>
<span class="lineNum">    1408 </span>                :            : {
<span class="lineNum">    1409 </span>                :<span class="lineCov">    1986011 :         return (ARC_BUF_ENCRYPTED(buf) != 0);</span>
<span class="lineNum">    1410 </span>                :            : }
<span class="lineNum">    1411 </span>                :            : 
<span class="lineNum">    1412 </span>                :            : /*
<span class="lineNum">    1413 </span>                :            :  * Returns B_TRUE if the buffer represents data that has not had its MAC
<span class="lineNum">    1414 </span>                :            :  * verified yet.
<a name="1415"><span class="lineNum">    1415 </span>                :            :  */</a>
<span class="lineNum">    1416 </span>                :            : boolean_t
<span class="lineNum">    1417 </span>                :<span class="lineCov">      70026 : arc_is_unauthenticated(arc_buf_t *buf)</span>
<span class="lineNum">    1418 </span>                :            : {
<span class="lineNum">    1419 </span>                :<span class="lineCov">      70026 :         return (HDR_NOAUTH(buf-&gt;b_hdr) != 0);</span>
<span class="lineNum">    1420 </span>                :            : }
<a name="1421"><span class="lineNum">    1421 </span>                :            : </a>
<span class="lineNum">    1422 </span>                :            : void
<span class="lineNum">    1423 </span>                :<span class="lineNoCov">          0 : arc_get_raw_params(arc_buf_t *buf, boolean_t *byteorder, uint8_t *salt,</span>
<span class="lineNum">    1424 </span>                :            :     uint8_t *iv, uint8_t *mac)
<span class="lineNum">    1425 </span>                :            : {
<span class="lineNum">    1426 </span>                :<span class="lineNoCov">          0 :         arc_buf_hdr_t *hdr = buf-&gt;b_hdr;</span>
<span class="lineNum">    1427 </span>                :            : 
<span class="lineNum">    1428 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(HDR_PROTECTED(hdr));</span>
<span class="lineNum">    1429 </span>                :            : 
<span class="lineNum">    1430 </span>                :<span class="lineNoCov">          0 :         bcopy(hdr-&gt;b_crypt_hdr.b_salt, salt, ZIO_DATA_SALT_LEN);</span>
<span class="lineNum">    1431 </span>                :<span class="lineNoCov">          0 :         bcopy(hdr-&gt;b_crypt_hdr.b_iv, iv, ZIO_DATA_IV_LEN);</span>
<span class="lineNum">    1432 </span>                :<span class="lineNoCov">          0 :         bcopy(hdr-&gt;b_crypt_hdr.b_mac, mac, ZIO_DATA_MAC_LEN);</span>
<span class="lineNum">    1433 </span>                :<span class="lineNoCov">          0 :         *byteorder = (hdr-&gt;b_l1hdr.b_byteswap == DMU_BSWAP_NUMFUNCS) ?</span>
<span class="lineNum">    1434 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             ZFS_HOST_BYTEORDER : !ZFS_HOST_BYTEORDER;</span>
<span class="lineNum">    1435 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1436 </span>                :            : 
<span class="lineNum">    1437 </span>                :            : /*
<span class="lineNum">    1438 </span>                :            :  * Indicates how this buffer is compressed in memory. If it is not compressed
<span class="lineNum">    1439 </span>                :            :  * the value will be ZIO_COMPRESS_OFF. It can be made normally readable with
<span class="lineNum">    1440 </span>                :            :  * arc_untransform() as long as it is also unencrypted.
<a name="1441"><span class="lineNum">    1441 </span>                :            :  */</a>
<span class="lineNum">    1442 </span>                :            : enum zio_compress
<span class="lineNum">    1443 </span>                :<span class="lineCov">    1986816 : arc_get_compression(arc_buf_t *buf)</span>
<span class="lineNum">    1444 </span>                :            : {
<span class="lineNum">    1445 </span>                :<span class="lineCov">    1986816 :         return (ARC_BUF_COMPRESSED(buf) ?</span>
<span class="lineNum">    1446 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1986816 times"> + </span>]:<span class="lineCov">    1986816 :             HDR_GET_COMPRESS(buf-&gt;b_hdr) : ZIO_COMPRESS_OFF);</span>
<span class="lineNum">    1447 </span>                :            : }
<span class="lineNum">    1448 </span>                :            : 
<span class="lineNum">    1449 </span>                :            : /*
<span class="lineNum">    1450 </span>                :            :  * Return the compression algorithm used to store this data in the ARC. If ARC
<span class="lineNum">    1451 </span>                :            :  * compression is enabled or this is an encrypted block, this will be the same
<span class="lineNum">    1452 </span>                :            :  * as what's used to store it on-disk. Otherwise, this will be ZIO_COMPRESS_OFF.
<a name="1453"><span class="lineNum">    1453 </span>                :            :  */</a>
<span class="lineNum">    1454 </span>                :            : static inline enum zio_compress
<span class="lineNum">    1455 </span>                :<span class="lineCov">   35224568 : arc_hdr_get_compress(arc_buf_hdr_t *hdr)</span>
<span class="lineNum">    1456 </span>                :            : {
<span class="lineNum">    1457 </span>                :<span class="lineCov">   17612284 :         return (HDR_COMPRESSION_ENABLED(hdr) ?</span>
<span class="lineNum">    1458 </span>        [<span class="branchCov" title="Branch 0 was taken 7376308 times"> + </span><span class="branchCov" title="Branch 1 was taken 10235976 times"> + </span>]:<span class="lineCov">   17612284 :             HDR_GET_COMPRESS(hdr) : ZIO_COMPRESS_OFF);</span>
<span class="lineNum">    1459 </span>                :            : }
<a name="1460"><span class="lineNum">    1460 </span>                :            : </a>
<span class="lineNum">    1461 </span>                :            : static inline boolean_t
<span class="lineNum">    1462 </span>                :<span class="lineCov">    8339430 : arc_buf_is_shared(arc_buf_t *buf)</span>
<span class="lineNum">    1463 </span>                :            : {
<span class="lineNum">    1464 </span>        [<span class="branchCov" title="Branch 0 was taken 6886662 times"> + </span><span class="branchCov" title="Branch 1 was taken 1453253 times"> + </span>]:<span class="lineCov">    8339915 :         boolean_t shared = (buf-&gt;b_data != NULL &amp;&amp;</span>
<span class="lineNum">    1465 </span>        [<span class="branchCov" title="Branch 0 was taken 6182315 times"> + </span><span class="branchCov" title="Branch 1 was taken 704160 times"> + </span>]:<span class="lineCov">    6886475 :             buf-&gt;b_hdr-&gt;b_l1hdr.b_pabd != NULL &amp;&amp;</span>
<span class="lineNum">    1466 </span>   [<span class="branchCov" title="Branch 0 was taken 8339915 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 2692200 times"> + </span><span class="branchCov" title="Branch 4 was taken 3489593 times"> + </span>]:<span class="lineCov">   21407885 :             abd_is_linear(buf-&gt;b_hdr-&gt;b_l1hdr.b_pabd) &amp;&amp;</span>
<span class="lineNum">    1467 </span>                :<span class="lineCov">    6182315 :             buf-&gt;b_data == abd_to_buf(buf-&gt;b_hdr-&gt;b_l1hdr.b_pabd));</span>
<span class="lineNum">    1468 </span>[<span class="branchCov" title="Branch 0 was taken 3490064 times"> + </span><span class="branchCov" title="Branch 1 was taken 4848657 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 3490064 times"> + </span>]:<span class="lineCov">    8338721 :         IMPLY(shared, HDR_SHARED_DATA(buf-&gt;b_hdr));</span>
<span class="lineNum">    1469 </span>[<span class="branchCov" title="Branch 0 was taken 3490075 times"> + </span><span class="branchCov" title="Branch 1 was taken 4848646 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 3490075 times"> + </span>]:<span class="lineCov">    8338721 :         IMPLY(shared, ARC_BUF_SHARED(buf));</span>
<span class="lineNum">    1470 </span>[<span class="branchCov" title="Branch 0 was taken 3490070 times"> + </span><span class="branchCov" title="Branch 1 was taken 4848651 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 3490064 times"> + </span><span class="branchCov" title="Branch 3 was taken 6 times"> + </span>]:<span class="lineCov">    8338721 :         IMPLY(shared, ARC_BUF_COMPRESSED(buf) || ARC_BUF_LAST(buf));</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 3490064 times"> + </span>]
<span class="lineNum">    1471 </span>                :            : 
<span class="lineNum">    1472 </span>                :            :         /*
<span class="lineNum">    1473 </span>                :            :          * It would be nice to assert arc_can_share() too, but the &quot;hdr isn't
<span class="lineNum">    1474 </span>                :            :          * already being shared&quot; requirement prevents us from doing that.
<span class="lineNum">    1475 </span>                :            :          */
<span class="lineNum">    1476 </span>                :            : 
<span class="lineNum">    1477 </span>                :<span class="lineCov">    8338721 :         return (shared);</span>
<span class="lineNum">    1478 </span>                :            : }
<span class="lineNum">    1479 </span>                :            : 
<span class="lineNum">    1480 </span>                :            : /*
<span class="lineNum">    1481 </span>                :            :  * Free the checksum associated with this header. If there is no checksum, this
<span class="lineNum">    1482 </span>                :            :  * is a no-op.
<a name="1483"><span class="lineNum">    1483 </span>                :            :  */</a>
<span class="lineNum">    1484 </span>                :            : static inline void
<span class="lineNum">    1485 </span>                :<span class="lineCov">    4657263 : arc_cksum_free(arc_buf_hdr_t *hdr)</span>
<span class="lineNum">    1486 </span>                :            : {
<span class="lineNum">    1487 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4657263 times"> + </span>]:<span class="lineCov">    4657263 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    1488 </span>                :            : 
<span class="lineNum">    1489 </span>                :<span class="lineCov">    4657263 :         mutex_enter(&amp;hdr-&gt;b_l1hdr.b_freeze_lock);</span>
<span class="lineNum">    1490 </span>        [<span class="branchCov" title="Branch 0 was taken 2383236 times"> + </span><span class="branchCov" title="Branch 1 was taken 2275357 times"> + </span>]:<span class="lineCov">    4658593 :         if (hdr-&gt;b_l1hdr.b_freeze_cksum != NULL) {</span>
<span class="lineNum">    1491 </span>                :<span class="lineCov">    2383236 :                 kmem_free(hdr-&gt;b_l1hdr.b_freeze_cksum, sizeof (zio_cksum_t));</span>
<span class="lineNum">    1492 </span>                :<span class="lineCov">    2383276 :                 hdr-&gt;b_l1hdr.b_freeze_cksum = NULL;</span>
<span class="lineNum">    1493 </span>                :            :         }
<span class="lineNum">    1494 </span>                :<span class="lineCov">    4658633 :         mutex_exit(&amp;hdr-&gt;b_l1hdr.b_freeze_lock);</span>
<span class="lineNum">    1495 </span>                :<span class="lineCov">    4658601 : }</span>
<span class="lineNum">    1496 </span>                :            : 
<span class="lineNum">    1497 </span>                :            : /*
<span class="lineNum">    1498 </span>                :            :  * Return true iff at least one of the bufs on hdr is not compressed.
<span class="lineNum">    1499 </span>                :            :  * Encrypted buffers count as compressed.
<a name="1500"><span class="lineNum">    1500 </span>                :            :  */</a>
<span class="lineNum">    1501 </span>                :            : static boolean_t
<span class="lineNum">    1502 </span>                :<span class="lineCov">    8873394 : arc_hdr_has_uncompressed_buf(arc_buf_hdr_t *hdr)</span>
<span class="lineNum">    1503 </span>                :            : {
<span class="lineNum">    1504 </span>        [<span class="branchCov" title="Branch 0 was taken 2889824 times"> + </span><span class="branchCov" title="Branch 1 was taken 1546873 times"> + </span>]:<span class="lineCov">    4436697 :         for (arc_buf_t *b = hdr-&gt;b_l1hdr.b_buf; b != NULL; b = b-&gt;b_next) {</span>
<span class="lineNum">    1505 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2889824 times"> + </span>]:<span class="lineCov">    2889824 :                 if (!ARC_BUF_COMPRESSED(b)) {</span>
<span class="lineNum">    1506 </span>                :            :                         return (B_TRUE);
<span class="lineNum">    1507 </span>                :            :                 }
<span class="lineNum">    1508 </span>                :            :         }
<span class="lineNum">    1509 </span>                :            :         return (B_FALSE);
<span class="lineNum">    1510 </span>                :            : }
<span class="lineNum">    1511 </span>                :            : 
<span class="lineNum">    1512 </span>                :            : 
<span class="lineNum">    1513 </span>                :            : /*
<span class="lineNum">    1514 </span>                :            :  * If we've turned on the ZFS_DEBUG_MODIFY flag, verify that the buf's data
<span class="lineNum">    1515 </span>                :            :  * matches the checksum that is stored in the hdr. If there is no checksum,
<span class="lineNum">    1516 </span>                :            :  * or if the buf is compressed, this is a no-op.
<a name="1517"><span class="lineNum">    1517 </span>                :            :  */</a>
<span class="lineNum">    1518 </span>                :            : static void
<span class="lineNum">    1519 </span>                :<span class="lineCov">    3636604 : arc_cksum_verify(arc_buf_t *buf)</span>
<span class="lineNum">    1520 </span>                :            : {
<span class="lineNum">    1521 </span>                :<span class="lineCov">    3636604 :         arc_buf_hdr_t *hdr = buf-&gt;b_hdr;</span>
<span class="lineNum">    1522 </span>                :            :         zio_cksum_t zc;
<span class="lineNum">    1523 </span>                :            : 
<span class="lineNum">    1524 </span>        [<span class="branchCov" title="Branch 0 was taken 3636588 times"> + </span><span class="branchCov" title="Branch 1 was taken 16 times"> + </span>]:<span class="lineCov">    3636604 :         if (!(zfs_flags &amp; ZFS_DEBUG_MODIFY))</span>
<span class="lineNum">    1525 </span>                :<span class="lineCov">    1695938 :                 return;</span>
<span class="lineNum">    1526 </span>                :            : 
<span class="lineNum">    1527 </span>        [<span class="branchCov" title="Branch 0 was taken 26 times"> + </span><span class="branchCov" title="Branch 1 was taken 3636562 times"> + </span>]:<span class="lineCov">    3636588 :         if (ARC_BUF_COMPRESSED(buf)) {</span>
<span class="lineNum">    1528 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 26 times"> + </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineCov">         26 :                 ASSERT(hdr-&gt;b_l1hdr.b_freeze_cksum == NULL ||</span>
<span class="lineNum">    1529 </span>                :            :                     arc_hdr_has_uncompressed_buf(hdr));
<span class="lineNum">    1530 </span>                :            :                 return;
<span class="lineNum">    1531 </span>                :            :         }
<span class="lineNum">    1532 </span>                :            : 
<span class="lineNum">    1533 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3636562 times"> + </span>]:<span class="lineCov">    3636562 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    1534 </span>                :            : 
<span class="lineNum">    1535 </span>                :<span class="lineCov">    3636562 :         mutex_enter(&amp;hdr-&gt;b_l1hdr.b_freeze_lock);</span>
<span class="lineNum">    1536 </span>[<span class="branchCov" title="Branch 0 was taken 1941146 times"> + </span><span class="branchCov" title="Branch 1 was taken 1695745 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 9 times"> + </span><span class="branchCov" title="Branch 3 was taken 1941137 times"> + </span>]:<span class="lineCov">    3636891 :         if (hdr-&gt;b_l1hdr.b_freeze_cksum == NULL || HDR_IO_ERROR(hdr)) {</span>
<span class="lineNum">    1537 </span>                :<span class="lineCov">    1695754 :                 mutex_exit(&amp;hdr-&gt;b_l1hdr.b_freeze_lock);</span>
<span class="lineNum">    1538 </span>                :<span class="lineCov">    1695896 :                 return;</span>
<span class="lineNum">    1539 </span>                :            :         }
<span class="lineNum">    1540 </span>                :            : 
<span class="lineNum">    1541 </span>                :<span class="lineCov">    1941137 :         fletcher_2_native(buf-&gt;b_data, arc_buf_size(buf), NULL, &amp;zc);</span>
<span class="lineNum">    1542 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1941088 times"> + </span>]:<span class="lineCov">    1941088 :         if (!ZIO_CHECKSUM_EQUAL(*hdr-&gt;b_l1hdr.b_freeze_cksum, zc))</span>
<span class="lineNum">    1543 </span>                :<span class="lineNoCov">          0 :                 panic(&quot;buffer modified while frozen!&quot;);</span>
<span class="lineNum">    1544 </span>                :<span class="lineCov">    1941088 :         mutex_exit(&amp;hdr-&gt;b_l1hdr.b_freeze_lock);</span>
<span class="lineNum">    1545 </span>                :            : }
<span class="lineNum">    1546 </span>                :            : 
<span class="lineNum">    1547 </span>                :            : /*
<span class="lineNum">    1548 </span>                :            :  * This function makes the assumption that data stored in the L2ARC
<span class="lineNum">    1549 </span>                :            :  * will be transformed exactly as it is in the main pool. Because of
<span class="lineNum">    1550 </span>                :            :  * this we can verify the checksum against the reading process's bp.
<a name="1551"><span class="lineNum">    1551 </span>                :            :  */</a>
<span class="lineNum">    1552 </span>                :            : static boolean_t
<span class="lineNum">    1553 </span>                :<span class="lineNoCov">          0 : arc_cksum_is_equal(arc_buf_hdr_t *hdr, zio_t *zio)</span>
<span class="lineNum">    1554 </span>                :            : {
<span class="lineNum">    1555 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(!BP_IS_EMBEDDED(zio-&gt;io_bp));</span>
<span class="lineNum">    1556 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         VERIFY3U(BP_GET_PSIZE(zio-&gt;io_bp), ==, HDR_GET_PSIZE(hdr));</span>
<span class="lineNum">    1557 </span>                :            : 
<span class="lineNum">    1558 </span>                :            :         /*
<span class="lineNum">    1559 </span>                :            :          * Block pointers always store the checksum for the logical data.
<span class="lineNum">    1560 </span>                :            :          * If the block pointer has the gang bit set, then the checksum
<span class="lineNum">    1561 </span>                :            :          * it represents is for the reconstituted data and not for an
<span class="lineNum">    1562 </span>                :            :          * individual gang member. The zio pipeline, however, must be able to
<span class="lineNum">    1563 </span>                :            :          * determine the checksum of each of the gang constituents so it
<span class="lineNum">    1564 </span>                :            :          * treats the checksum comparison differently than what we need
<span class="lineNum">    1565 </span>                :            :          * for l2arc blocks. This prevents us from using the
<span class="lineNum">    1566 </span>                :            :          * zio_checksum_error() interface directly. Instead we must call the
<span class="lineNum">    1567 </span>                :            :          * zio_checksum_error_impl() so that we can ensure the checksum is
<span class="lineNum">    1568 </span>                :            :          * generated using the correct checksum algorithm and accounts for the
<span class="lineNum">    1569 </span>                :            :          * logical I/O size and not just a gang fragment.
<span class="lineNum">    1570 </span>                :            :          */
<span class="lineNum">    1571 </span>                :<span class="lineNoCov">          0 :         return (zio_checksum_error_impl(zio-&gt;io_spa, zio-&gt;io_bp,</span>
<span class="lineNum">    1572 </span>                :<span class="lineNoCov">          0 :             BP_GET_CHECKSUM(zio-&gt;io_bp), zio-&gt;io_abd, zio-&gt;io_size,</span>
<span class="lineNum">    1573 </span>                :<span class="lineNoCov">          0 :             zio-&gt;io_offset, NULL) == 0);</span>
<span class="lineNum">    1574 </span>                :            : }
<span class="lineNum">    1575 </span>                :            : 
<span class="lineNum">    1576 </span>                :            : /*
<span class="lineNum">    1577 </span>                :            :  * Given a buf full of data, if ZFS_DEBUG_MODIFY is enabled this computes a
<span class="lineNum">    1578 </span>                :            :  * checksum and attaches it to the buf's hdr so that we can ensure that the buf
<span class="lineNum">    1579 </span>                :            :  * isn't modified later on. If buf is compressed or there is already a checksum
<span class="lineNum">    1580 </span>                :            :  * on the hdr, this is a no-op (we only checksum uncompressed bufs).
<a name="1581"><span class="lineNum">    1581 </span>                :            :  */</a>
<span class="lineNum">    1582 </span>                :            : static void
<span class="lineNum">    1583 </span>                :<span class="lineCov">    5179645 : arc_cksum_compute(arc_buf_t *buf)</span>
<span class="lineNum">    1584 </span>                :            : {
<span class="lineNum">    1585 </span>                :<span class="lineCov">    5179645 :         arc_buf_hdr_t *hdr = buf-&gt;b_hdr;</span>
<span class="lineNum">    1586 </span>                :            : 
<span class="lineNum">    1587 </span>           [<span class="branchCov" title="Branch 0 was taken 5180816 times"> + </span>]:<span class="lineCov">    5179645 :         if (!(zfs_flags &amp; ZFS_DEBUG_MODIFY))</span>
<span class="lineNum">    1588 </span>                :            :                 return;
<span class="lineNum">    1589 </span>                :            : 
<span class="lineNum">    1590 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5180816 times"> + </span>]:<span class="lineCov">    5180816 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    1591 </span>                :            : 
<span class="lineNum">    1592 </span>                :<span class="lineCov">    5180816 :         mutex_enter(&amp;buf-&gt;b_hdr-&gt;b_l1hdr.b_freeze_lock);</span>
<span class="lineNum">    1593 </span>        [<span class="branchCov" title="Branch 0 was taken 2798890 times"> + </span><span class="branchCov" title="Branch 1 was taken 2383219 times"> + </span>]:<span class="lineCov">    5182109 :         if (hdr-&gt;b_l1hdr.b_freeze_cksum != NULL) {</span>
<span class="lineNum">    1594 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2798821 times"> + </span>]:<span class="lineCov">    2798890 :                 ASSERT(arc_hdr_has_uncompressed_buf(hdr));</span>
<span class="lineNum">    1595 </span>                :<span class="lineCov">    2798821 :                 mutex_exit(&amp;hdr-&gt;b_l1hdr.b_freeze_lock);</span>
<span class="lineNum">    1596 </span>                :<span class="lineCov">    2798922 :                 return;</span>
<span class="lineNum">    1597 </span>        [<span class="branchCov" title="Branch 0 was taken 26 times"> + </span><span class="branchCov" title="Branch 1 was taken 2383193 times"> + </span>]:<span class="lineCov">    2383219 :         } else if (ARC_BUF_COMPRESSED(buf)) {</span>
<span class="lineNum">    1598 </span>                :<span class="lineCov">         26 :                 mutex_exit(&amp;hdr-&gt;b_l1hdr.b_freeze_lock);</span>
<span class="lineNum">    1599 </span>                :<span class="lineCov">         26 :                 return;</span>
<span class="lineNum">    1600 </span>                :            :         }
<span class="lineNum">    1601 </span>                :            : 
<span class="lineNum">    1602 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2383193 times"> + </span>]:<span class="lineCov">    2383193 :         ASSERT(!ARC_BUF_ENCRYPTED(buf));</span>
<span class="lineNum">    1603 </span>                :            :         ASSERT(!ARC_BUF_COMPRESSED(buf));
<span class="lineNum">    1604 </span>                :<span class="lineCov">    2383193 :         hdr-&gt;b_l1hdr.b_freeze_cksum = kmem_alloc(sizeof (zio_cksum_t),</span>
<span class="lineNum">    1605 </span>                :            :             KM_SLEEP);
<span class="lineNum">    1606 </span>                :<span class="lineCov">    2383335 :         fletcher_2_native(buf-&gt;b_data, arc_buf_size(buf), NULL,</span>
<span class="lineNum">    1607 </span>                :            :             hdr-&gt;b_l1hdr.b_freeze_cksum);
<span class="lineNum">    1608 </span>                :<span class="lineCov">    2382999 :         mutex_exit(&amp;hdr-&gt;b_l1hdr.b_freeze_lock);</span>
<span class="lineNum">    1609 </span>                :<span class="lineCov">    2383048 :         arc_buf_watch(buf);</span>
<span class="lineNum">    1610 </span>                :            : }
<span class="lineNum">    1611 </span>                :            : 
<a name="1612"><span class="lineNum">    1612 </span>                :            : #ifndef _KERNEL</a>
<span class="lineNum">    1613 </span>                :            : void
<span class="lineNum">    1614 </span>                :<span class="lineNoCov">          0 : arc_buf_sigsegv(int sig, siginfo_t *si, void *unused)</span>
<span class="lineNum">    1615 </span>                :            : {
<span class="lineNum">    1616 </span>                :<span class="lineNoCov">          0 :         panic(&quot;Got SIGSEGV at address: 0x%lx\n&quot;, (long)si-&gt;si_addr);</span>
<span class="lineNum">    1617 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1618 </span>                :            : #endif
<span class="lineNum">    1619 </span>                :            : 
<a name="1620"><span class="lineNum">    1620 </span>                :            : /* ARGSUSED */</a>
<span class="lineNum">    1621 </span>                :            : static void
<span class="lineNum">    1622 </span>                :<span class="lineCov">    2979698 : arc_buf_unwatch(arc_buf_t *buf)</span>
<span class="lineNum">    1623 </span>                :            : {
<span class="lineNum">    1624 </span>                :            : #ifndef _KERNEL
<span class="lineNum">    1625 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2979698 times"> + </span>]:<span class="lineCov">    2979698 :         if (arc_watch) {</span>
<span class="lineNum">    1626 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT0(mprotect(buf-&gt;b_data, arc_buf_size(buf),</span>
<span class="lineNum">    1627 </span>                :            :                     PROT_READ | PROT_WRITE));
<span class="lineNum">    1628 </span>                :            :         }
<span class="lineNum">    1629 </span>                :            : #endif
<span class="lineNum">    1630 </span>                :<span class="lineCov">    2979698 : }</span>
<span class="lineNum">    1631 </span>                :            : 
<a name="1632"><span class="lineNum">    1632 </span>                :            : /* ARGSUSED */</a>
<span class="lineNum">    1633 </span>                :            : static void
<span class="lineNum">    1634 </span>                :<span class="lineCov">    2382673 : arc_buf_watch(arc_buf_t *buf)</span>
<span class="lineNum">    1635 </span>                :            : {
<span class="lineNum">    1636 </span>                :            : #ifndef _KERNEL
<span class="lineNum">    1637 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2382673 times"> + </span>]:<span class="lineCov">    2382673 :         if (arc_watch)</span>
<span class="lineNum">    1638 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT0(mprotect(buf-&gt;b_data, arc_buf_size(buf),</span>
<span class="lineNum">    1639 </span>                :            :                     PROT_READ));
<span class="lineNum">    1640 </span>                :            : #endif
<span class="lineNum">    1641 </span>                :<span class="lineCov">    2382673 : }</span>
<a name="1642"><span class="lineNum">    1642 </span>                :            : </a>
<span class="lineNum">    1643 </span>                :            : static arc_buf_contents_t
<span class="lineNum">    1644 </span>                :<span class="lineCov">   24346092 : arc_buf_type(arc_buf_hdr_t *hdr)</span>
<span class="lineNum">    1645 </span>                :            : {
<span class="lineNum">    1646 </span>                :            :         arc_buf_contents_t type;
<span class="lineNum">    1647 </span>        [<span class="branchCov" title="Branch 0 was taken 826769 times"> + </span><span class="branchCov" title="Branch 1 was taken 11346277 times"> + </span>]:<span class="lineCov">   12173046 :         if (HDR_ISTYPE_METADATA(hdr)) {</span>
<span class="lineNum">    1648 </span>                :            :                 type = ARC_BUFC_METADATA;
<span class="lineNum">    1649 </span>                :            :         } else {
<span class="lineNum">    1650 </span>                :<span class="lineCov">     826769 :                 type = ARC_BUFC_DATA;</span>
<span class="lineNum">    1651 </span>                :            :         }
<span class="lineNum">    1652 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 12173046 times"> + </span>]:<span class="lineCov">   12173046 :         VERIFY3U(hdr-&gt;b_type, ==, type);</span>
<span class="lineNum">    1653 </span>                :<span class="lineCov">   12173046 :         return (type);</span>
<span class="lineNum">    1654 </span>                :            : }
<a name="1655"><span class="lineNum">    1655 </span>                :            : </a>
<span class="lineNum">    1656 </span>                :            : boolean_t
<span class="lineNum">    1657 </span>                :<span class="lineCov">       4658 : arc_is_metadata(arc_buf_t *buf)</span>
<span class="lineNum">    1658 </span>                :            : {
<span class="lineNum">    1659 </span>                :<span class="lineCov">       4658 :         return (HDR_ISTYPE_METADATA(buf-&gt;b_hdr) != 0);</span>
<span class="lineNum">    1660 </span>                :            : }
<a name="1661"><span class="lineNum">    1661 </span>                :            : </a>
<span class="lineNum">    1662 </span>                :            : static uint32_t
<span class="lineNum">    1663 </span>                :<span class="lineCov">    1499700 : arc_bufc_to_flags(arc_buf_contents_t type)</span>
<span class="lineNum">    1664 </span>                :            : {
<span class="lineNum">    1665 </span>     [<span class="branchCov" title="Branch 0 was taken 1386363 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 113337 times"> + </span>]:<span class="lineCov">    1499700 :         switch (type) {</span>
<span class="lineNum">    1666 </span>                :            :         case ARC_BUFC_DATA:
<span class="lineNum">    1667 </span>                :            :                 /* metadata field is 0 if buffer contains normal data */
<span class="lineNum">    1668 </span>                :            :                 return (0);
<span class="lineNum">    1669 </span>                :            :         case ARC_BUFC_METADATA:
<span class="lineNum">    1670 </span>                :<span class="lineCov">    1386363 :                 return (ARC_FLAG_BUFC_METADATA);</span>
<span class="lineNum">    1671 </span>                :            :         default:
<span class="lineNum">    1672 </span>                :            :                 break;
<span class="lineNum">    1673 </span>                :            :         }
<span class="lineNum">    1674 </span>                :<span class="lineNoCov">          0 :         panic(&quot;undefined ARC buffer type!&quot;);</span>
<span class="lineNum">    1675 </span>                :<span class="lineNoCov">          0 :         return ((uint32_t)-1);</span>
<span class="lineNum">    1676 </span>                :            : }
<a name="1677"><span class="lineNum">    1677 </span>                :            : </a>
<span class="lineNum">    1678 </span>                :            : void
<span class="lineNum">    1679 </span>                :<span class="lineCov">    1340888 : arc_buf_thaw(arc_buf_t *buf)</span>
<span class="lineNum">    1680 </span>                :            : {
<span class="lineNum">    1681 </span>                :<span class="lineCov">    1340888 :         arc_buf_hdr_t *hdr = buf-&gt;b_hdr;</span>
<span class="lineNum">    1682 </span>                :            : 
<span class="lineNum">    1683 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1340888 times"> + </span>]:<span class="lineCov">    1340888 :         ASSERT3P(hdr-&gt;b_l1hdr.b_state, ==, arc_anon);</span>
<span class="lineNum">    1684 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1340888 times"> + </span>]:<span class="lineCov">    1340888 :         ASSERT(!HDR_IO_IN_PROGRESS(hdr));</span>
<span class="lineNum">    1685 </span>                :            : 
<span class="lineNum">    1686 </span>                :<span class="lineCov">    1340888 :         arc_cksum_verify(buf);</span>
<span class="lineNum">    1687 </span>                :            : 
<span class="lineNum">    1688 </span>                :            :         /*
<span class="lineNum">    1689 </span>                :            :          * Compressed buffers do not manipulate the b_freeze_cksum or
<span class="lineNum">    1690 </span>                :            :          * allocate b_thawed.
<span class="lineNum">    1691 </span>                :            :          */
<span class="lineNum">    1692 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1340979 times"> + </span>]:<span class="lineCov">    1340979 :         if (ARC_BUF_COMPRESSED(buf)) {</span>
<span class="lineNum">    1693 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT(hdr-&gt;b_l1hdr.b_freeze_cksum == NULL ||</span>
<span class="lineNum">    1694 </span>                :            :                     arc_hdr_has_uncompressed_buf(hdr));
<span class="lineNum">    1695 </span>                :            :                 return;
<span class="lineNum">    1696 </span>                :            :         }
<span class="lineNum">    1697 </span>                :            : 
<span class="lineNum">    1698 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1340979 times"> + </span>]:<span class="lineCov">    1340979 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    1699 </span>                :<span class="lineCov">    1340979 :         arc_cksum_free(hdr);</span>
<span class="lineNum">    1700 </span>                :<span class="lineCov">    1340953 :         arc_buf_unwatch(buf);</span>
<span class="lineNum">    1701 </span>                :            : }
<a name="1702"><span class="lineNum">    1702 </span>                :            : </a>
<span class="lineNum">    1703 </span>                :            : void
<span class="lineNum">    1704 </span>                :<span class="lineCov">    3147537 : arc_buf_freeze(arc_buf_t *buf)</span>
<span class="lineNum">    1705 </span>                :            : {
<span class="lineNum">    1706 </span>                :<span class="lineCov">    3147537 :         arc_buf_hdr_t *hdr = buf-&gt;b_hdr;</span>
<span class="lineNum">    1707 </span>                :            :         kmutex_t *hash_lock;
<span class="lineNum">    1708 </span>                :            : 
<span class="lineNum">    1709 </span>           [<span class="branchCov" title="Branch 0 was taken 3147666 times"> + </span>]:<span class="lineCov">    3147537 :         if (!(zfs_flags &amp; ZFS_DEBUG_MODIFY))</span>
<span class="lineNum">    1710 </span>                :            :                 return;
<span class="lineNum">    1711 </span>                :            : 
<span class="lineNum">    1712 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3147666 times"> + </span>]:<span class="lineCov">    3147666 :         if (ARC_BUF_COMPRESSED(buf)) {</span>
<span class="lineNum">    1713 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT(hdr-&gt;b_l1hdr.b_freeze_cksum == NULL ||</span>
<span class="lineNum">    1714 </span>                :            :                     arc_hdr_has_uncompressed_buf(hdr));
<span class="lineNum">    1715 </span>                :            :                 return;
<span class="lineNum">    1716 </span>                :            :         }
<span class="lineNum">    1717 </span>                :            : 
<span class="lineNum">    1718 </span>                :<span class="lineCov">    3147666 :         hash_lock = HDR_LOCK(hdr);</span>
<span class="lineNum">    1719 </span>                :<span class="lineCov">    3147555 :         mutex_enter(hash_lock);</span>
<span class="lineNum">    1720 </span>                :            : 
<span class="lineNum">    1721 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3148618 times"> + </span>]:<span class="lineCov">    3148618 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    1722 </span>[<span class="branchCov" title="Branch 0 was taken 544288 times"> + </span><span class="branchCov" title="Branch 1 was taken 2604330 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 544288 times"> + </span>]:<span class="lineCov">    3148618 :         ASSERT(hdr-&gt;b_l1hdr.b_freeze_cksum != NULL ||</span>
<span class="lineNum">    1723 </span>                :            :             hdr-&gt;b_l1hdr.b_state == arc_anon);
<span class="lineNum">    1724 </span>                :<span class="lineCov">    3148618 :         arc_cksum_compute(buf);</span>
<span class="lineNum">    1725 </span>                :<span class="lineCov">    3148653 :         mutex_exit(hash_lock);</span>
<span class="lineNum">    1726 </span>                :            : }
<span class="lineNum">    1727 </span>                :            : 
<span class="lineNum">    1728 </span>                :            : /*
<span class="lineNum">    1729 </span>                :            :  * The arc_buf_hdr_t's b_flags should never be modified directly. Instead,
<span class="lineNum">    1730 </span>                :            :  * the following functions should be used to ensure that the flags are
<span class="lineNum">    1731 </span>                :            :  * updated in a thread-safe way. When manipulating the flags either
<span class="lineNum">    1732 </span>                :            :  * the hash_lock must be held or the hdr must be undiscoverable. This
<span class="lineNum">    1733 </span>                :            :  * ensures that we're not racing with any other threads when updating
<span class="lineNum">    1734 </span>                :            :  * the flags.
<a name="1735"><span class="lineNum">    1735 </span>                :            :  */</a>
<span class="lineNum">    1736 </span>                :            : static inline void
<span class="lineNum">    1737 </span>                :<span class="lineCov">    9675064 : arc_hdr_set_flags(arc_buf_hdr_t *hdr, arc_flags_t flags)</span>
<span class="lineNum">    1738 </span>                :            : {
<span class="lineNum">    1739 </span>   [<span class="branchCov" title="Branch 3 was taken 7486973 times"> + </span><span class="branchCov" title="Branch 4 was taken 2191061 times"> + </span>][<span class="branchCov" title="Branch 5 was taken 7487201 times"> + </span>]:<span class="lineCov">    9675064 :         ASSERT(MUTEX_HELD(HDR_LOCK(hdr)) || HDR_EMPTY(hdr));</span>
<span class="lineNum">         </span>           [<span class="branchCov" title="Branch 8 was taken 7487334 times"> + </span>]
<span class="lineNum">    1740 </span>                :<span class="lineCov">    9678395 :         hdr-&gt;b_flags |= flags;</span>
<span class="lineNum">    1741 </span>                :<span class="lineCov">    9678395 : }</span>
<a name="1742"><span class="lineNum">    1742 </span>                :            : </a>
<span class="lineNum">    1743 </span>                :            : static inline void
<span class="lineNum">    1744 </span>                :<span class="lineCov">    8874465 : arc_hdr_clear_flags(arc_buf_hdr_t *hdr, arc_flags_t flags)</span>
<span class="lineNum">    1745 </span>                :            : {
<span class="lineNum">    1746 </span>   [<span class="branchCov" title="Branch 3 was taken 6225113 times"> + </span><span class="branchCov" title="Branch 4 was taken 2652242 times"> + </span>][<span class="branchCov" title="Branch 5 was taken 6225277 times"> + </span>]:<span class="lineCov">    8874465 :         ASSERT(MUTEX_HELD(HDR_LOCK(hdr)) || HDR_EMPTY(hdr));</span>
<span class="lineNum">         </span>           [<span class="branchCov" title="Branch 8 was taken 6225435 times"> + </span>]
<span class="lineNum">    1747 </span>                :<span class="lineCov">    8877677 :         hdr-&gt;b_flags &amp;= ~flags;</span>
<span class="lineNum">    1748 </span>                :<span class="lineCov">    8877677 : }</span>
<span class="lineNum">    1749 </span>                :            : 
<span class="lineNum">    1750 </span>                :            : /*
<span class="lineNum">    1751 </span>                :            :  * Setting the compression bits in the arc_buf_hdr_t's b_flags is
<span class="lineNum">    1752 </span>                :            :  * done in a special way since we have to clear and set bits
<span class="lineNum">    1753 </span>                :            :  * at the same time. Consumers that wish to set the compression bits
<span class="lineNum">    1754 </span>                :            :  * must use this function to ensure that the flags are updated in
<span class="lineNum">    1755 </span>                :            :  * thread-safe manner.
<a name="1756"><span class="lineNum">    1756 </span>                :            :  */</a>
<span class="lineNum">    1757 </span>                :            : static void
<span class="lineNum">    1758 </span>                :<span class="lineCov">    2954615 : arc_hdr_set_compress(arc_buf_hdr_t *hdr, enum zio_compress cmp)</span>
<span class="lineNum">    1759 </span>                :            : {
<span class="lineNum">    1760 </span>   [<span class="branchCov" title="Branch 3 was taken 2954700 times"> + </span><span class="branchCov" title="Branch 4 was taken 72 times"> + </span>][<span class="branchCov" title="Branch 5 was taken 2954739 times"> + </span>]:<span class="lineCov">    2954615 :         ASSERT(MUTEX_HELD(HDR_LOCK(hdr)) || HDR_EMPTY(hdr));</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 7 was taken 89 times"> + </span><span class="branchCov" title="Branch 8 was taken 2954650 times"> + </span>]
<span class="lineNum">    1761 </span>                :            : 
<span class="lineNum">    1762 </span>                :            :         /*
<span class="lineNum">    1763 </span>                :            :          * Holes and embedded blocks will always have a psize = 0 so
<span class="lineNum">    1764 </span>                :            :          * we ignore the compression of the blkptr and set the
<span class="lineNum">    1765 </span>                :            :          * want to uncompress them. Mark them as uncompressed.
<span class="lineNum">    1766 </span>                :            :          */
<span class="lineNum">    1767 </span>[<span class="branchCov" title="Branch 0 was taken 2026628 times"> + </span><span class="branchCov" title="Branch 1 was taken 928094 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 865229 times"> + </span><span class="branchCov" title="Branch 3 was taken 1161399 times"> + </span>]:<span class="lineCov">    2954722 :         if (!zfs_compressed_arc_enabled || HDR_GET_PSIZE(hdr) == 0) {</span>
<span class="lineNum">    1768 </span>                :<span class="lineCov">    1793323 :                 arc_hdr_clear_flags(hdr, ARC_FLAG_COMPRESSED_ARC);</span>
<span class="lineNum">    1769 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1793283 times"> + </span>]:<span class="lineCov">    1793283 :                 ASSERT(!HDR_COMPRESSION_ENABLED(hdr));</span>
<span class="lineNum">    1770 </span>                :            :         } else {
<span class="lineNum">    1771 </span>                :<span class="lineCov">    1161399 :                 arc_hdr_set_flags(hdr, ARC_FLAG_COMPRESSED_ARC);</span>
<span class="lineNum">    1772 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1161398 times"> + </span>]:<span class="lineCov">    1161398 :                 ASSERT(HDR_COMPRESSION_ENABLED(hdr));</span>
<span class="lineNum">    1773 </span>                :            :         }
<span class="lineNum">    1774 </span>                :            : 
<span class="lineNum">    1775 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2954681 times"> + </span>][<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 2954135 times"> + </span>]:<span class="lineCov">    2954681 :         HDR_SET_COMPRESS(hdr, cmp);</span>
<span class="lineNum">    1776 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2954541 times"> + </span>]:<span class="lineCov">    2954438 :         ASSERT3U(HDR_GET_COMPRESS(hdr), ==, cmp);</span>
<span class="lineNum">    1777 </span>                :<span class="lineCov">    2954541 : }</span>
<span class="lineNum">    1778 </span>                :            : 
<span class="lineNum">    1779 </span>                :            : /*
<span class="lineNum">    1780 </span>                :            :  * Looks for another buf on the same hdr which has the data decompressed, copies
<span class="lineNum">    1781 </span>                :            :  * from it, and returns true. If no such buf exists, returns false.
<a name="1782"><span class="lineNum">    1782 </span>                :            :  */</a>
<span class="lineNum">    1783 </span>                :            : static boolean_t
<span class="lineNum">    1784 </span>                :<span class="lineCov">     301902 : arc_buf_try_copy_decompressed_data(arc_buf_t *buf)</span>
<span class="lineNum">    1785 </span>                :            : {
<span class="lineNum">    1786 </span>                :<span class="lineCov">     301902 :         arc_buf_hdr_t *hdr = buf-&gt;b_hdr;</span>
<span class="lineNum">    1787 </span>                :<span class="lineCov">     301902 :         boolean_t copied = B_FALSE;</span>
<span class="lineNum">    1788 </span>                :            : 
<span class="lineNum">    1789 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 301902 times"> + </span>]:<span class="lineCov">     301902 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    1790 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 301902 times"> + </span>]:<span class="lineCov">     301902 :         ASSERT3P(buf-&gt;b_data, !=, NULL);</span>
<span class="lineNum">    1791 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 301902 times"> + </span>]:<span class="lineCov">     301902 :         ASSERT(!ARC_BUF_COMPRESSED(buf));</span>
<span class="lineNum">    1792 </span>                :            : 
<span class="lineNum">    1793 </span>        [<span class="branchCov" title="Branch 0 was taken 378813 times"> + </span><span class="branchCov" title="Branch 1 was taken 224979 times"> + </span>]:<span class="lineCov">     603792 :         for (arc_buf_t *from = hdr-&gt;b_l1hdr.b_buf; from != NULL;</span>
<span class="lineNum">    1794 </span>                :<span class="lineCov">     301890 :             from = from-&gt;b_next) {</span>
<span class="lineNum">    1795 </span>                :            :                 /* can't use our own data buffer */
<span class="lineNum">    1796 </span>        [<span class="branchCov" title="Branch 0 was taken 301890 times"> + </span><span class="branchCov" title="Branch 1 was taken 76923 times"> + </span>]:<span class="lineCov">     378813 :                 if (from == buf) {</span>
<span class="lineNum">    1797 </span>                :<span class="lineCov">     301890 :                         continue;</span>
<span class="lineNum">    1798 </span>                :            :                 }
<span class="lineNum">    1799 </span>                :            : 
<span class="lineNum">    1800 </span>        [<span class="branchCov" title="Branch 0 was taken 76923 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      76923 :                 if (!ARC_BUF_COMPRESSED(from)) {</span>
<span class="lineNum">    1801 </span>                :<span class="lineCov">      76923 :                         bcopy(from-&gt;b_data, buf-&gt;b_data, arc_buf_size(buf));</span>
<span class="lineNum">    1802 </span>                :<span class="lineCov">      76924 :                         copied = B_TRUE;</span>
<span class="lineNum">    1803 </span>                :<span class="lineCov">      76924 :                         break;</span>
<span class="lineNum">    1804 </span>                :            :                 }
<span class="lineNum">    1805 </span>                :            :         }
<span class="lineNum">    1806 </span>                :            : 
<span class="lineNum">    1807 </span>                :            :         /*
<span class="lineNum">    1808 </span>                :            :          * There were no decompressed bufs, so there should not be a
<span class="lineNum">    1809 </span>                :            :          * checksum on the hdr either.
<span class="lineNum">    1810 </span>                :            :          */
<span class="lineNum">    1811 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 301903 times"> + </span>]:<span class="lineCov">     301903 :         EQUIV(!copied, hdr-&gt;b_l1hdr.b_freeze_cksum == NULL);</span>
<span class="lineNum">    1812 </span>                :            : 
<span class="lineNum">    1813 </span>                :<span class="lineCov">     301903 :         return (copied);</span>
<span class="lineNum">    1814 </span>                :            : }
<span class="lineNum">    1815 </span>                :            : 
<span class="lineNum">    1816 </span>                :            : /*
<span class="lineNum">    1817 </span>                :            :  * Return the size of the block, b_pabd, that is stored in the arc_buf_hdr_t.
<a name="1818"><span class="lineNum">    1818 </span>                :            :  */</a>
<span class="lineNum">    1819 </span>                :            : static uint64_t
<span class="lineNum">    1820 </span>                :<span class="lineCov">   10169384 : arc_hdr_size(arc_buf_hdr_t *hdr)</span>
<span class="lineNum">    1821 </span>                :            : {
<span class="lineNum">    1822 </span>                :            :         uint64_t size;
<span class="lineNum">    1823 </span>                :            : 
<span class="lineNum">    1824 </span>   [<span class="branchCov" title="Branch 1 was taken 3523851 times"> + </span><span class="branchCov" title="Branch 2 was taken 6645023 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 3523860 times"> + </span>]:<span class="lineCov">   10169384 :         if (arc_hdr_get_compress(hdr) != ZIO_COMPRESS_OFF &amp;&amp;</span>
<span class="lineNum">    1825 </span>                :<span class="lineCov">    3523851 :             HDR_GET_PSIZE(hdr) &gt; 0) {</span>
<span class="lineNum">    1826 </span>                :<span class="lineCov">    3523860 :                 size = HDR_GET_PSIZE(hdr);</span>
<span class="lineNum">    1827 </span>                :            :         } else {
<span class="lineNum">    1828 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6645014 times"> + </span>]:<span class="lineCov">    6645014 :                 ASSERT3U(HDR_GET_LSIZE(hdr), !=, 0);</span>
<span class="lineNum">    1829 </span>                :            :                 size = HDR_GET_LSIZE(hdr);
<span class="lineNum">    1830 </span>                :            :         }
<span class="lineNum">    1831 </span>                :<span class="lineCov">   10168874 :         return (size);</span>
<span class="lineNum">    1832 </span>                :            : }
<a name="1833"><span class="lineNum">    1833 </span>                :            : </a>
<span class="lineNum">    1834 </span>                :            : static int
<span class="lineNum">    1835 </span>                :<span class="lineNoCov">          0 : arc_hdr_authenticate(arc_buf_hdr_t *hdr, spa_t *spa, uint64_t dsobj)</span>
<span class="lineNum">    1836 </span>                :            : {
<span class="lineNum">    1837 </span>                :            :         int ret;
<span class="lineNum">    1838 </span>                :            :         uint64_t csize;
<span class="lineNum">    1839 </span>                :<span class="lineNoCov">          0 :         uint64_t lsize = HDR_GET_LSIZE(hdr);</span>
<span class="lineNum">    1840 </span>                :<span class="lineNoCov">          0 :         uint64_t psize = HDR_GET_PSIZE(hdr);</span>
<span class="lineNum">    1841 </span>                :<span class="lineNoCov">          0 :         void *tmpbuf = NULL;</span>
<span class="lineNum">    1842 </span>                :<span class="lineNoCov">          0 :         abd_t *abd = hdr-&gt;b_l1hdr.b_pabd;</span>
<span class="lineNum">    1843 </span>                :            : 
<span class="lineNum">    1844 </span>        [<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(HDR_LOCK(hdr) == NULL || MUTEX_HELD(HDR_LOCK(hdr)));</span>
<span class="lineNum">    1845 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(HDR_AUTHENTICATED(hdr));</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">    1846 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3P(hdr-&gt;b_l1hdr.b_pabd, !=, NULL);</span>
<span class="lineNum">    1847 </span>                :            : 
<span class="lineNum">    1848 </span>                :            :         /*
<span class="lineNum">    1849 </span>                :            :          * The MAC is calculated on the compressed data that is stored on disk.
<span class="lineNum">    1850 </span>                :            :          * However, if compressed arc is disabled we will only have the
<span class="lineNum">    1851 </span>                :            :          * decompressed data available to us now. Compress it into a temporary
<span class="lineNum">    1852 </span>                :            :          * abd so we can verify the MAC. The performance overhead of this will
<span class="lineNum">    1853 </span>                :            :          * be relatively low, since most objects in an encrypted objset will
<span class="lineNum">    1854 </span>                :            :          * be encrypted (instead of authenticated) anyway.
<span class="lineNum">    1855 </span>                :            :          */
<span class="lineNum">    1856 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (HDR_GET_COMPRESS(hdr) != ZIO_COMPRESS_OFF &amp;&amp;</span>
<span class="lineNum">    1857 </span>                :<span class="lineNoCov">          0 :             !HDR_COMPRESSION_ENABLED(hdr)) {</span>
<span class="lineNum">    1858 </span>                :<span class="lineNoCov">          0 :                 tmpbuf = zio_buf_alloc(lsize);</span>
<span class="lineNum">    1859 </span>                :<span class="lineNoCov">          0 :                 abd = abd_get_from_buf(tmpbuf, lsize);</span>
<span class="lineNum">    1860 </span>                :<span class="lineNoCov">          0 :                 abd_take_ownership_of_buf(abd, B_TRUE);</span>
<span class="lineNum">    1861 </span>                :            : 
<span class="lineNum">    1862 </span>                :<span class="lineNoCov">          0 :                 csize = zio_compress_data(HDR_GET_COMPRESS(hdr),</span>
<span class="lineNum">    1863 </span>                :            :                     hdr-&gt;b_l1hdr.b_pabd, tmpbuf, lsize);
<span class="lineNum">    1864 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3U(csize, &lt;=, psize);</span>
<span class="lineNum">    1865 </span>                :<span class="lineNoCov">          0 :                 abd_zero_off(abd, csize, psize - csize);</span>
<span class="lineNum">    1866 </span>                :            :         }
<span class="lineNum">    1867 </span>                :            : 
<span class="lineNum">    1868 </span>                :            :         /*
<span class="lineNum">    1869 </span>                :            :          * Authentication is best effort. We authenticate whenever the key is
<span class="lineNum">    1870 </span>                :            :          * available. If we succeed we clear ARC_FLAG_NOAUTH.
<span class="lineNum">    1871 </span>                :            :          */
<span class="lineNum">    1872 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (hdr-&gt;b_crypt_hdr.b_ot == DMU_OT_OBJSET) {</span>
<span class="lineNum">    1873 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3U(HDR_GET_COMPRESS(hdr), ==, ZIO_COMPRESS_OFF);</span>
<span class="lineNum">    1874 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3U(lsize, ==, psize);</span>
<span class="lineNum">    1875 </span>                :<span class="lineNoCov">          0 :                 ret = spa_do_crypt_objset_mac_abd(B_FALSE, spa, dsobj, abd,</span>
<span class="lineNum">    1876 </span>                :<span class="lineNoCov">          0 :                     psize, hdr-&gt;b_l1hdr.b_byteswap != DMU_BSWAP_NUMFUNCS);</span>
<span class="lineNum">    1877 </span>                :            :         } else {
<span class="lineNum">    1878 </span>                :<span class="lineNoCov">          0 :                 ret = spa_do_crypt_mac_abd(B_FALSE, spa, dsobj, abd, psize,</span>
<span class="lineNum">    1879 </span>                :<span class="lineNoCov">          0 :                     hdr-&gt;b_crypt_hdr.b_mac);</span>
<span class="lineNum">    1880 </span>                :            :         }
<span class="lineNum">    1881 </span>                :            : 
<span class="lineNum">    1882 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ret == 0)</span>
<span class="lineNum">    1883 </span>                :<span class="lineNoCov">          0 :                 arc_hdr_clear_flags(hdr, ARC_FLAG_NOAUTH);</span>
<span class="lineNum">    1884 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         else if (ret != ENOENT)</span>
<span class="lineNum">    1885 </span>                :            :                 goto error;
<span class="lineNum">    1886 </span>                :            : 
<span class="lineNum">    1887 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (tmpbuf != NULL)</span>
<span class="lineNum">    1888 </span>                :<span class="lineNoCov">          0 :                 abd_free(abd);</span>
<span class="lineNum">    1889 </span>                :            : 
<span class="lineNum">    1890 </span>                :            :         return (0);
<span class="lineNum">    1891 </span>                :            : 
<span class="lineNum">    1892 </span>                :            : error:
<span class="lineNum">    1893 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (tmpbuf != NULL)</span>
<span class="lineNum">    1894 </span>                :<span class="lineNoCov">          0 :                 abd_free(abd);</span>
<span class="lineNum">    1895 </span>                :            : 
<span class="lineNum">    1896 </span>                :            :         return (ret);
<span class="lineNum">    1897 </span>                :            : }
<span class="lineNum">    1898 </span>                :            : 
<span class="lineNum">    1899 </span>                :            : /*
<span class="lineNum">    1900 </span>                :            :  * This function will take a header that only has raw encrypted data in
<span class="lineNum">    1901 </span>                :            :  * b_crypt_hdr.b_rabd and decrypt it into a new buffer which is stored in
<span class="lineNum">    1902 </span>                :            :  * b_l1hdr.b_pabd. If designated in the header flags, this function will
<span class="lineNum">    1903 </span>                :            :  * also decompress the data.
<a name="1904"><span class="lineNum">    1904 </span>                :            :  */</a>
<span class="lineNum">    1905 </span>                :            : static int
<span class="lineNum">    1906 </span>                :<span class="lineNoCov">          0 : arc_hdr_decrypt(arc_buf_hdr_t *hdr, spa_t *spa, uint64_t dsobj)</span>
<span class="lineNum">    1907 </span>                :            : {
<span class="lineNum">    1908 </span>                :            :         int ret;
<span class="lineNum">    1909 </span>                :<span class="lineNoCov">          0 :         dsl_crypto_key_t *dck = NULL;</span>
<span class="lineNum">    1910 </span>                :<span class="lineNoCov">          0 :         abd_t *cabd = NULL;</span>
<span class="lineNum">    1911 </span>                :<span class="lineNoCov">          0 :         void *tmp = NULL;</span>
<span class="lineNum">    1912 </span>                :<span class="lineNoCov">          0 :         boolean_t no_crypt = B_FALSE;</span>
<span class="lineNum">    1913 </span>                :<span class="lineNoCov">          0 :         boolean_t bswap = (hdr-&gt;b_l1hdr.b_byteswap != DMU_BSWAP_NUMFUNCS);</span>
<span class="lineNum">    1914 </span>                :            : 
<span class="lineNum">    1915 </span>        [<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(HDR_LOCK(hdr) == NULL || MUTEX_HELD(HDR_LOCK(hdr)));</span>
<span class="lineNum">    1916 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(HDR_ENCRYPTED(hdr));</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">    1917 </span>                :            : 
<span class="lineNum">    1918 </span>                :<span class="lineNoCov">          0 :         arc_hdr_alloc_abd(hdr, B_FALSE);</span>
<span class="lineNum">    1919 </span>                :            : 
<span class="lineNum">    1920 </span>                :            :         /*
<span class="lineNum">    1921 </span>                :            :          * We must be careful to use the passed-in dsobj value here and
<span class="lineNum">    1922 </span>                :            :          * not the value in b_dsobj. b_dsobj is meant to be a best guess for
<span class="lineNum">    1923 </span>                :            :          * the L2ARC, which has the luxury of being able to fail without real
<span class="lineNum">    1924 </span>                :            :          * consequences (the data simply won't make it to the L2ARC). In
<span class="lineNum">    1925 </span>                :            :          * reality, the dsobj stored in the header may belong to a dataset
<span class="lineNum">    1926 </span>                :            :          * that has been unmounted or otherwise disowned, meaning the key
<span class="lineNum">    1927 </span>                :            :          * won't be accessible via that dsobj anymore.
<span class="lineNum">    1928 </span>                :            :          */
<span class="lineNum">    1929 </span>                :<span class="lineNoCov">          0 :         ret = spa_keystore_lookup_key(spa, dsobj, FTAG, &amp;dck);</span>
<span class="lineNum">    1930 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ret != 0) {</span>
<span class="lineNum">    1931 </span>                :<span class="lineNoCov">          0 :                 ret = SET_ERROR(EACCES);</span>
<span class="lineNum">    1932 </span>                :<span class="lineNoCov">          0 :                 goto error;</span>
<span class="lineNum">    1933 </span>                :            :         }
<span class="lineNum">    1934 </span>                :            : 
<span class="lineNum">    1935 </span>                :<span class="lineNoCov">          0 :         ret = zio_do_crypt_abd(B_FALSE, &amp;dck-&gt;dck_key,</span>
<span class="lineNum">    1936 </span>                :<span class="lineNoCov">          0 :             hdr-&gt;b_crypt_hdr.b_salt, hdr-&gt;b_crypt_hdr.b_ot,</span>
<span class="lineNum">    1937 </span>                :<span class="lineNoCov">          0 :             hdr-&gt;b_crypt_hdr.b_iv, hdr-&gt;b_crypt_hdr.b_mac,</span>
<span class="lineNum">    1938 </span>                :<span class="lineNoCov">          0 :             HDR_GET_PSIZE(hdr), bswap, hdr-&gt;b_l1hdr.b_pabd,</span>
<span class="lineNum">    1939 </span>                :            :             hdr-&gt;b_crypt_hdr.b_rabd, &amp;no_crypt);
<span class="lineNum">    1940 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (ret != 0)</span>
<span class="lineNum">    1941 </span>                :            :                 goto error;
<span class="lineNum">    1942 </span>                :            : 
<span class="lineNum">    1943 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (no_crypt) {</span>
<span class="lineNum">    1944 </span>                :<span class="lineNoCov">          0 :                 abd_copy(hdr-&gt;b_l1hdr.b_pabd, hdr-&gt;b_crypt_hdr.b_rabd,</span>
<span class="lineNum">    1945 </span>                :<span class="lineNoCov">          0 :                     HDR_GET_PSIZE(hdr));</span>
<span class="lineNum">    1946 </span>                :            :         }
<span class="lineNum">    1947 </span>                :            : 
<span class="lineNum">    1948 </span>                :            :         /*
<span class="lineNum">    1949 </span>                :            :          * If this header has disabled arc compression but the b_pabd is
<span class="lineNum">    1950 </span>                :            :          * compressed after decrypting it, we need to decompress the newly
<span class="lineNum">    1951 </span>                :            :          * decrypted data.
<span class="lineNum">    1952 </span>                :            :          */
<span class="lineNum">    1953 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (HDR_GET_COMPRESS(hdr) != ZIO_COMPRESS_OFF &amp;&amp;</span>
<span class="lineNum">    1954 </span>                :<span class="lineNoCov">          0 :             !HDR_COMPRESSION_ENABLED(hdr)) {</span>
<span class="lineNum">    1955 </span>                :            :                 /*
<span class="lineNum">    1956 </span>                :            :                  * We want to make sure that we are correctly honoring the
<span class="lineNum">    1957 </span>                :            :                  * zfs_abd_scatter_enabled setting, so we allocate an abd here
<span class="lineNum">    1958 </span>                :            :                  * and then loan a buffer from it, rather than allocating a
<span class="lineNum">    1959 </span>                :            :                  * linear buffer and wrapping it in an abd later.
<span class="lineNum">    1960 </span>                :            :                  */
<span class="lineNum">    1961 </span>                :<span class="lineNoCov">          0 :                 cabd = arc_get_data_abd(hdr, arc_hdr_size(hdr), hdr);</span>
<span class="lineNum">    1962 </span>                :<span class="lineNoCov">          0 :                 tmp = abd_borrow_buf(cabd, arc_hdr_size(hdr));</span>
<span class="lineNum">    1963 </span>                :            : 
<span class="lineNum">    1964 </span>                :<span class="lineNoCov">          0 :                 ret = zio_decompress_data(HDR_GET_COMPRESS(hdr),</span>
<span class="lineNum">    1965 </span>                :<span class="lineNoCov">          0 :                     hdr-&gt;b_l1hdr.b_pabd, tmp, HDR_GET_PSIZE(hdr),</span>
<span class="lineNum">    1966 </span>                :<span class="lineNoCov">          0 :                     HDR_GET_LSIZE(hdr));</span>
<span class="lineNum">    1967 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (ret != 0) {</span>
<span class="lineNum">    1968 </span>                :<span class="lineNoCov">          0 :                         abd_return_buf(cabd, tmp, arc_hdr_size(hdr));</span>
<span class="lineNum">    1969 </span>                :<span class="lineNoCov">          0 :                         goto error;</span>
<span class="lineNum">    1970 </span>                :            :                 }
<span class="lineNum">    1971 </span>                :            : 
<span class="lineNum">    1972 </span>                :<span class="lineNoCov">          0 :                 abd_return_buf_copy(cabd, tmp, arc_hdr_size(hdr));</span>
<span class="lineNum">    1973 </span>                :<span class="lineNoCov">          0 :                 arc_free_data_abd(hdr, hdr-&gt;b_l1hdr.b_pabd,</span>
<span class="lineNum">    1974 </span>                :            :                     arc_hdr_size(hdr), hdr);
<span class="lineNum">    1975 </span>                :<span class="lineNoCov">          0 :                 hdr-&gt;b_l1hdr.b_pabd = cabd;</span>
<span class="lineNum">    1976 </span>                :            :         }
<span class="lineNum">    1977 </span>                :            : 
<span class="lineNum">    1978 </span>                :<span class="lineNoCov">          0 :         spa_keystore_dsl_key_rele(spa, dck, FTAG);</span>
<span class="lineNum">    1979 </span>                :            : 
<span class="lineNum">    1980 </span>                :<span class="lineNoCov">          0 :         return (0);</span>
<span class="lineNum">    1981 </span>                :            : 
<span class="lineNum">    1982 </span>                :            : error:
<span class="lineNum">    1983 </span>                :<span class="lineNoCov">          0 :         arc_hdr_free_abd(hdr, B_FALSE);</span>
<span class="lineNum">    1984 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (dck != NULL)</span>
<span class="lineNum">    1985 </span>                :<span class="lineNoCov">          0 :                 spa_keystore_dsl_key_rele(spa, dck, FTAG);</span>
<span class="lineNum">    1986 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (cabd != NULL)</span>
<span class="lineNum">    1987 </span>                :<span class="lineNoCov">          0 :                 arc_free_data_buf(hdr, cabd, arc_hdr_size(hdr), hdr);</span>
<span class="lineNum">    1988 </span>                :            : 
<span class="lineNum">    1989 </span>                :            :         return (ret);
<span class="lineNum">    1990 </span>                :            : }
<span class="lineNum">    1991 </span>                :            : 
<span class="lineNum">    1992 </span>                :            : /*
<span class="lineNum">    1993 </span>                :            :  * This function is called during arc_buf_fill() to prepare the header's
<span class="lineNum">    1994 </span>                :            :  * abd plaintext pointer for use. This involves authenticated protected
<span class="lineNum">    1995 </span>                :            :  * data and decrypting encrypted data into the plaintext abd.
<a name="1996"><span class="lineNum">    1996 </span>                :            :  */</a>
<span class="lineNum">    1997 </span>                :            : static int
<span class="lineNum">    1998 </span>                :<span class="lineNoCov">          0 : arc_fill_hdr_crypt(arc_buf_hdr_t *hdr, kmutex_t *hash_lock, spa_t *spa,</span>
<span class="lineNum">    1999 </span>                :            :     uint64_t dsobj, boolean_t noauth)
<span class="lineNum">    2000 </span>                :            : {
<span class="lineNum">    2001 </span>                :            :         int ret;
<span class="lineNum">    2002 </span>                :            : 
<span class="lineNum">    2003 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(HDR_PROTECTED(hdr));</span>
<span class="lineNum">    2004 </span>                :            : 
<span class="lineNum">    2005 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (hash_lock != NULL)</span>
<span class="lineNum">    2006 </span>                :<span class="lineNoCov">          0 :                 mutex_enter(hash_lock);</span>
<span class="lineNum">    2007 </span>                :            : 
<span class="lineNum">    2008 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (HDR_NOAUTH(hdr) &amp;&amp; !noauth) {</span>
<span class="lineNum">    2009 </span>                :            :                 /*
<span class="lineNum">    2010 </span>                :            :                  * The caller requested authenticated data but our data has
<span class="lineNum">    2011 </span>                :            :                  * not been authenticated yet. Verify the MAC now if we can.
<span class="lineNum">    2012 </span>                :            :                  */
<span class="lineNum">    2013 </span>                :<span class="lineNoCov">          0 :                 ret = arc_hdr_authenticate(hdr, spa, dsobj);</span>
<span class="lineNum">    2014 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (ret != 0)</span>
<span class="lineNum">    2015 </span>                :            :                         goto error;
<span class="lineNum">    2016 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         } else if (HDR_HAS_RABD(hdr) &amp;&amp; hdr-&gt;b_l1hdr.b_pabd == NULL) {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    2017 </span>                :            :                 /*
<span class="lineNum">    2018 </span>                :            :                  * If we only have the encrypted version of the data, but the
<span class="lineNum">    2019 </span>                :            :                  * unencrypted version was requested we take this opportunity
<span class="lineNum">    2020 </span>                :            :                  * to store the decrypted version in the header for future use.
<span class="lineNum">    2021 </span>                :            :                  */
<span class="lineNum">    2022 </span>                :<span class="lineNoCov">          0 :                 ret = arc_hdr_decrypt(hdr, spa, dsobj);</span>
<span class="lineNum">    2023 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (ret != 0)</span>
<span class="lineNum">    2024 </span>                :            :                         goto error;
<span class="lineNum">    2025 </span>                :            :         }
<span class="lineNum">    2026 </span>                :            : 
<span class="lineNum">    2027 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3P(hdr-&gt;b_l1hdr.b_pabd, !=, NULL);</span>
<span class="lineNum">    2028 </span>                :            : 
<span class="lineNum">    2029 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (hash_lock != NULL)</span>
<span class="lineNum">    2030 </span>                :<span class="lineNoCov">          0 :                 mutex_exit(hash_lock);</span>
<span class="lineNum">    2031 </span>                :            : 
<span class="lineNum">    2032 </span>                :            :         return (0);
<span class="lineNum">    2033 </span>                :            : 
<span class="lineNum">    2034 </span>                :            : error:
<span class="lineNum">    2035 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (hash_lock != NULL)</span>
<span class="lineNum">    2036 </span>                :<span class="lineNoCov">          0 :                 mutex_exit(hash_lock);</span>
<span class="lineNum">    2037 </span>                :            : 
<span class="lineNum">    2038 </span>                :            :         return (ret);
<span class="lineNum">    2039 </span>                :            : }
<span class="lineNum">    2040 </span>                :            : 
<span class="lineNum">    2041 </span>                :            : /*
<span class="lineNum">    2042 </span>                :            :  * This function is used by the dbuf code to decrypt bonus buffers in place.
<span class="lineNum">    2043 </span>                :            :  * The dbuf code itself doesn't have any locking for decrypting a shared dnode
<span class="lineNum">    2044 </span>                :            :  * block, so we use the hash lock here to protect against concurrent calls to
<span class="lineNum">    2045 </span>                :            :  * arc_buf_fill().
<a name="2046"><span class="lineNum">    2046 </span>                :            :  */</a>
<span class="lineNum">    2047 </span>                :            : static void
<span class="lineNum">    2048 </span>                :<span class="lineNoCov">          0 : arc_buf_untransform_in_place(arc_buf_t *buf, kmutex_t *hash_lock)</span>
<span class="lineNum">    2049 </span>                :            : {
<span class="lineNum">    2050 </span>                :<span class="lineNoCov">          0 :         arc_buf_hdr_t *hdr = buf-&gt;b_hdr;</span>
<span class="lineNum">    2051 </span>                :            : 
<span class="lineNum">    2052 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(HDR_ENCRYPTED(hdr));</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">    2053 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3U(hdr-&gt;b_crypt_hdr.b_ot, ==, DMU_OT_DNODE);</span>
<span class="lineNum">    2054 </span>        [<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(HDR_LOCK(hdr) == NULL || MUTEX_HELD(HDR_LOCK(hdr)));</span>
<span class="lineNum">    2055 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3P(hdr-&gt;b_l1hdr.b_pabd, !=, NULL);</span>
<span class="lineNum">    2056 </span>                :            : 
<span class="lineNum">    2057 </span>                :<span class="lineNoCov">          0 :         zio_crypt_copy_dnode_bonus(hdr-&gt;b_l1hdr.b_pabd, buf-&gt;b_data,</span>
<span class="lineNum">    2058 </span>                :<span class="lineNoCov">          0 :             arc_buf_size(buf));</span>
<span class="lineNum">    2059 </span>                :<span class="lineNoCov">          0 :         buf-&gt;b_flags &amp;= ~ARC_BUF_FLAG_ENCRYPTED;</span>
<span class="lineNum">    2060 </span>                :<span class="lineNoCov">          0 :         buf-&gt;b_flags &amp;= ~ARC_BUF_FLAG_COMPRESSED;</span>
<span class="lineNum">    2061 </span>                :<span class="lineNoCov">          0 :         hdr-&gt;b_crypt_hdr.b_ebufcnt -= 1;</span>
<span class="lineNum">    2062 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2063 </span>                :            : 
<span class="lineNum">    2064 </span>                :            : /*
<span class="lineNum">    2065 </span>                :            :  * Given a buf that has a data buffer attached to it, this function will
<span class="lineNum">    2066 </span>                :            :  * efficiently fill the buf with data of the specified compression setting from
<span class="lineNum">    2067 </span>                :            :  * the hdr and update the hdr's b_freeze_cksum if necessary. If the buf and hdr
<span class="lineNum">    2068 </span>                :            :  * are already sharing a data buf, no copy is performed.
<span class="lineNum">    2069 </span>                :            :  *
<span class="lineNum">    2070 </span>                :            :  * If the buf is marked as compressed but uncompressed data was requested, this
<span class="lineNum">    2071 </span>                :            :  * will allocate a new data buffer for the buf, remove that flag, and fill the
<span class="lineNum">    2072 </span>                :            :  * buf with uncompressed data. You can't request a compressed buf on a hdr with
<span class="lineNum">    2073 </span>                :            :  * uncompressed data, and (since we haven't added support for it yet) if you
<span class="lineNum">    2074 </span>                :            :  * want compressed data your buf must already be marked as compressed and have
<span class="lineNum">    2075 </span>                :            :  * the correct-sized data buffer.
<a name="2076"><span class="lineNum">    2076 </span>                :            :  */</a>
<span class="lineNum">    2077 </span>                :            : static int
<span class="lineNum">    2078 </span>                :<span class="lineCov">    1381421 : arc_buf_fill(arc_buf_t *buf, spa_t *spa, uint64_t dsobj, arc_fill_flags_t flags)</span>
<span class="lineNum">    2079 </span>                :            : {
<span class="lineNum">    2080 </span>                :<span class="lineCov">    1381421 :         int error = 0;</span>
<span class="lineNum">    2081 </span>                :<span class="lineCov">    1381421 :         arc_buf_hdr_t *hdr = buf-&gt;b_hdr;</span>
<span class="lineNum">    2082 </span>                :<span class="lineCov">    1381356 :         boolean_t hdr_compressed =</span>
<span class="lineNum">    2083 </span>                :<span class="lineCov">    1381421 :             (arc_hdr_get_compress(hdr) != ZIO_COMPRESS_OFF);</span>
<span class="lineNum">    2084 </span>                :<span class="lineCov">    1381356 :         boolean_t compressed = (flags &amp; ARC_FILL_COMPRESSED) != 0;</span>
<span class="lineNum">    2085 </span>                :<span class="lineCov">    1381356 :         boolean_t encrypted = (flags &amp; ARC_FILL_ENCRYPTED) != 0;</span>
<span class="lineNum">    2086 </span>                :<span class="lineCov">    1381356 :         dmu_object_byteswap_t bswap = hdr-&gt;b_l1hdr.b_byteswap;</span>
<span class="lineNum">    2087 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1381356 times"> + </span>]:<span class="lineCov">    1381356 :         kmutex_t *hash_lock = (flags &amp; ARC_FILL_LOCKED) ? NULL : HDR_LOCK(hdr);</span>
<span class="lineNum">    2088 </span>                :            : 
<span class="lineNum">    2089 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1381356 times"> + </span>]:<span class="lineCov">    1381356 :         ASSERT3P(buf-&gt;b_data, !=, NULL);</span>
<span class="lineNum">    2090 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1381356 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1381356 :         IMPLY(compressed, hdr_compressed || ARC_BUF_ENCRYPTED(buf));</span>
<span class="lineNum">    2091 </span>[<span class="branchCov" title="Branch 0 was taken 26 times"> + </span><span class="branchCov" title="Branch 1 was taken 1381330 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 26 times"> + </span>]:<span class="lineCov">    1381356 :         IMPLY(compressed, ARC_BUF_COMPRESSED(buf));</span>
<span class="lineNum">    2092 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1381356 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1381356 :         IMPLY(encrypted, HDR_ENCRYPTED(hdr));</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">    2093 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1381213 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1381213 :         IMPLY(encrypted, ARC_BUF_ENCRYPTED(buf));</span>
<span class="lineNum">    2094 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1381213 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1381213 :         IMPLY(encrypted, ARC_BUF_COMPRESSED(buf));</span>
<span class="lineNum">    2095 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1381213 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1381213 :         IMPLY(encrypted, !ARC_BUF_SHARED(buf));</span>
<span class="lineNum">    2096 </span>                :            : 
<span class="lineNum">    2097 </span>                :            :         /*
<span class="lineNum">    2098 </span>                :            :          * If the caller wanted encrypted data we just need to copy it from
<span class="lineNum">    2099 </span>                :            :          * b_rabd and potentially byteswap it. We won't be able to do any
<span class="lineNum">    2100 </span>                :            :          * further transforms on it.
<span class="lineNum">    2101 </span>                :            :          */
<span class="lineNum">    2102 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1381213 times"> + </span>]:<span class="lineCov">    1381213 :         if (encrypted) {</span>
<span class="lineNum">    2103 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT(HDR_HAS_RABD(hdr));</span>
<span class="lineNum">    2104 </span>                :<span class="lineNoCov">          0 :                 abd_copy_to_buf(buf-&gt;b_data, hdr-&gt;b_crypt_hdr.b_rabd,</span>
<span class="lineNum">    2105 </span>                :<span class="lineNoCov">          0 :                     HDR_GET_PSIZE(hdr));</span>
<span class="lineNum">    2106 </span>                :<span class="lineNoCov">          0 :                 goto byteswap;</span>
<span class="lineNum">    2107 </span>                :            :         }
<span class="lineNum">    2108 </span>                :            : 
<span class="lineNum">    2109 </span>                :            :         /*
<span class="lineNum">    2110 </span>                :            :          * Adjust encrypted and authenticated headers to accomodate the
<span class="lineNum">    2111 </span>                :            :          * request if needed.
<span class="lineNum">    2112 </span>                :            :          */
<span class="lineNum">    2113 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1381213 times"> + </span>]:<span class="lineCov">    1381213 :         if (HDR_PROTECTED(hdr)) {</span>
<span class="lineNum">    2114 </span>                :<span class="lineNoCov">          0 :                 error = arc_fill_hdr_crypt(hdr, hash_lock, spa,</span>
<span class="lineNum">    2115 </span>                :<span class="lineNoCov">          0 :                     dsobj, !!(flags &amp; ARC_FILL_NOAUTH));</span>
<span class="lineNum">    2116 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (error != 0)</span>
<span class="lineNum">    2117 </span>                :            :                         return (error);
<span class="lineNum">    2118 </span>                :            :         }
<span class="lineNum">    2119 </span>                :            : 
<span class="lineNum">    2120 </span>                :            :         /*
<span class="lineNum">    2121 </span>                :            :          * There is a special case here for dnode blocks which are
<span class="lineNum">    2122 </span>                :            :          * decrypting their bonus buffers. These blocks may request to
<span class="lineNum">    2123 </span>                :            :          * be decrypted in-place. This is necessary because there may
<span class="lineNum">    2124 </span>                :            :          * be many dnodes pointing into this buffer and there is
<span class="lineNum">    2125 </span>                :            :          * currently no method to synchronize replacing the backing
<span class="lineNum">    2126 </span>                :            :          * b_data buffer and updating all of the pointers. Here we use
<span class="lineNum">    2127 </span>                :            :          * the hash lock to ensure there are no races. If the need
<span class="lineNum">    2128 </span>                :            :          * arises for other types to be decrypted in-place, they must
<span class="lineNum">    2129 </span>                :            :          * add handling here as well.
<span class="lineNum">    2130 </span>                :            :          */
<span class="lineNum">    2131 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1381064 times"> + </span>]:<span class="lineCov">    1381064 :         if ((flags &amp; ARC_FILL_IN_PLACE) != 0) {</span>
<span class="lineNum">    2132 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT(!hdr_compressed);</span>
<span class="lineNum">    2133 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT(!compressed);</span>
<span class="lineNum">    2134 </span>                :            :                 ASSERT(!encrypted);
<span class="lineNum">    2135 </span>                :            : 
<span class="lineNum">    2136 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (HDR_ENCRYPTED(hdr) &amp;&amp; ARC_BUF_ENCRYPTED(buf)) {</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">    2137 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         ASSERT3U(hdr-&gt;b_crypt_hdr.b_ot, ==, DMU_OT_DNODE);</span>
<span class="lineNum">    2138 </span>                :            : 
<span class="lineNum">    2139 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (hash_lock != NULL)</span>
<span class="lineNum">    2140 </span>                :<span class="lineNoCov">          0 :                                 mutex_enter(hash_lock);</span>
<span class="lineNum">    2141 </span>                :<span class="lineNoCov">          0 :                         arc_buf_untransform_in_place(buf, hash_lock);</span>
<span class="lineNum">    2142 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (hash_lock != NULL)</span>
<span class="lineNum">    2143 </span>                :<span class="lineNoCov">          0 :                                 mutex_exit(hash_lock);</span>
<span class="lineNum">    2144 </span>                :            : 
<span class="lineNum">    2145 </span>                :            :                         /* Compute the hdr's checksum if necessary */
<span class="lineNum">    2146 </span>                :<span class="lineNoCov">          0 :                         arc_cksum_compute(buf);</span>
<span class="lineNum">    2147 </span>                :            :                 }
<span class="lineNum">    2148 </span>                :            : 
<span class="lineNum">    2149 </span>                :            :                 return (0);
<span class="lineNum">    2150 </span>                :            :         }
<span class="lineNum">    2151 </span>                :            : 
<span class="lineNum">    2152 </span>        [<span class="branchCov" title="Branch 0 was taken 1079160 times"> + </span><span class="branchCov" title="Branch 1 was taken 301904 times"> + </span>]:<span class="lineCov">    1381064 :         if (hdr_compressed == compressed) {</span>
<span class="lineNum">    2153 </span>        [<span class="branchCov" title="Branch 1 was taken 24578 times"> + </span><span class="branchCov" title="Branch 2 was taken 1055655 times"> + </span>]:<span class="lineCov">    1079160 :                 if (!arc_buf_is_shared(buf)) {</span>
<span class="lineNum">    2154 </span>                :<span class="lineCov">      24578 :                         abd_copy_to_buf(buf-&gt;b_data, hdr-&gt;b_l1hdr.b_pabd,</span>
<span class="lineNum">    2155 </span>                :            :                             arc_buf_size(buf));
<span class="lineNum">    2156 </span>                :            :                 }
<span class="lineNum">    2157 </span>                :            :         } else {
<span class="lineNum">    2158 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 301904 times"> + </span>]:<span class="lineCov">     301904 :                 ASSERT(hdr_compressed);</span>
<span class="lineNum">    2159 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 301904 times"> + </span>]:<span class="lineCov">     301904 :                 ASSERT(!compressed);</span>
<span class="lineNum">    2160 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 301904 times"> + </span>]:<span class="lineCov">     301904 :                 ASSERT3U(HDR_GET_LSIZE(hdr), !=, HDR_GET_PSIZE(hdr));</span>
<span class="lineNum">    2161 </span>                :            : 
<span class="lineNum">    2162 </span>                :            :                 /*
<span class="lineNum">    2163 </span>                :            :                  * If the buf is sharing its data with the hdr, unlink it and
<span class="lineNum">    2164 </span>                :            :                  * allocate a new data buffer for the buf.
<span class="lineNum">    2165 </span>                :            :                  */
<span class="lineNum">    2166 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 301902 times"> + </span>]:<span class="lineCov">     301904 :                 if (arc_buf_is_shared(buf)) {</span>
<span class="lineNum">    2167 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         ASSERT(ARC_BUF_COMPRESSED(buf));</span>
<span class="lineNum">    2168 </span>                :            : 
<span class="lineNum">    2169 </span>                :            :                         /* We need to give the buf it's own b_data */
<span class="lineNum">    2170 </span>                :<span class="lineNoCov">          0 :                         buf-&gt;b_flags &amp;= ~ARC_BUF_FLAG_SHARED;</span>
<span class="lineNum">    2171 </span>                :<span class="lineNoCov">          0 :                         buf-&gt;b_data =</span>
<span class="lineNum">    2172 </span>                :<span class="lineNoCov">          0 :                             arc_get_data_buf(hdr, HDR_GET_LSIZE(hdr), buf);</span>
<span class="lineNum">    2173 </span>                :<span class="lineNoCov">          0 :                         arc_hdr_clear_flags(hdr, ARC_FLAG_SHARED_DATA);</span>
<span class="lineNum">    2174 </span>                :            : 
<span class="lineNum">    2175 </span>                :            :                         /* Previously overhead was 0; just add new overhead */
<span class="lineNum">    2176 </span>                :<span class="lineNoCov">          0 :                         ARCSTAT_INCR(arcstat_overhead_size, HDR_GET_LSIZE(hdr));</span>
<span class="lineNum">    2177 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 301902 times"> + </span>]:<span class="lineCov">     301902 :                 } else if (ARC_BUF_COMPRESSED(buf)) {</span>
<span class="lineNum">    2178 </span>                :            :                         /* We need to reallocate the buf's b_data */
<span class="lineNum">    2179 </span>                :<span class="lineNoCov">          0 :                         arc_free_data_buf(hdr, buf-&gt;b_data, HDR_GET_PSIZE(hdr),</span>
<span class="lineNum">    2180 </span>                :            :                             buf);
<span class="lineNum">    2181 </span>                :<span class="lineNoCov">          0 :                         buf-&gt;b_data =</span>
<span class="lineNum">    2182 </span>                :<span class="lineNoCov">          0 :                             arc_get_data_buf(hdr, HDR_GET_LSIZE(hdr), buf);</span>
<span class="lineNum">    2183 </span>                :            : 
<span class="lineNum">    2184 </span>                :            :                         /* We increased the size of b_data; update overhead */
<span class="lineNum">    2185 </span>                :<span class="lineNoCov">          0 :                         ARCSTAT_INCR(arcstat_overhead_size,</span>
<span class="lineNum">    2186 </span>                :            :                             HDR_GET_LSIZE(hdr) - HDR_GET_PSIZE(hdr));
<span class="lineNum">    2187 </span>                :            :                 }
<span class="lineNum">    2188 </span>                :            : 
<span class="lineNum">    2189 </span>                :            :                 /*
<span class="lineNum">    2190 </span>                :            :                  * Regardless of the buf's previous compression settings, it
<span class="lineNum">    2191 </span>                :            :                  * should not be compressed at the end of this function.
<span class="lineNum">    2192 </span>                :            :                  */
<span class="lineNum">    2193 </span>                :<span class="lineCov">     301902 :                 buf-&gt;b_flags &amp;= ~ARC_BUF_FLAG_COMPRESSED;</span>
<span class="lineNum">    2194 </span>                :            : 
<span class="lineNum">    2195 </span>                :            :                 /*
<span class="lineNum">    2196 </span>                :            :                  * Try copying the data from another buf which already has a
<span class="lineNum">    2197 </span>                :            :                  * decompressed version. If that's not possible, it's time to
<span class="lineNum">    2198 </span>                :            :                  * bite the bullet and decompress the data from the hdr.
<span class="lineNum">    2199 </span>                :            :                  */
<span class="lineNum">    2200 </span>        [<span class="branchCov" title="Branch 1 was taken 76923 times"> + </span><span class="branchCov" title="Branch 2 was taken 224974 times"> + </span>]:<span class="lineCov">     301902 :                 if (arc_buf_try_copy_decompressed_data(buf)) {</span>
<span class="lineNum">    2201 </span>                :            :                         /* Skip byteswapping and checksumming (already done) */
<span class="lineNum">    2202 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 76923 times"> + </span>]:<span class="lineCov">      76923 :                         ASSERT3P(hdr-&gt;b_l1hdr.b_freeze_cksum, !=, NULL);</span>
<span class="lineNum">    2203 </span>                :            :                         return (0);
<span class="lineNum">    2204 </span>                :            :                 } else {
<span class="lineNum">    2205 </span>                :<span class="lineCov">     224974 :                         error = zio_decompress_data(HDR_GET_COMPRESS(hdr),</span>
<span class="lineNum">    2206 </span>                :            :                             hdr-&gt;b_l1hdr.b_pabd, buf-&gt;b_data,
<span class="lineNum">    2207 </span>                :<span class="lineCov">     449948 :                             HDR_GET_PSIZE(hdr), HDR_GET_LSIZE(hdr));</span>
<span class="lineNum">    2208 </span>                :            : 
<span class="lineNum">    2209 </span>                :            :                         /*
<span class="lineNum">    2210 </span>                :            :                          * Absent hardware errors or software bugs, this should
<span class="lineNum">    2211 </span>                :            :                          * be impossible, but log it anyway so we can debug it.
<span class="lineNum">    2212 </span>                :            :                          */
<span class="lineNum">    2213 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 224979 times"> + </span>]:<span class="lineCov">     224979 :                         if (error != 0) {</span>
<span class="lineNum">    2214 </span>                :<span class="lineNoCov">          0 :                                 zfs_dbgmsg(</span>
<span class="lineNum">    2215 </span>                :            :                                     &quot;hdr %p, compress %d, psize %d, lsize %d&quot;,
<span class="lineNum">    2216 </span>                :            :                                     hdr, arc_hdr_get_compress(hdr),
<span class="lineNum">    2217 </span>                :            :                                     HDR_GET_PSIZE(hdr), HDR_GET_LSIZE(hdr));
<span class="lineNum">    2218 </span>                :<span class="lineNoCov">          0 :                                 return (SET_ERROR(EIO));</span>
<span class="lineNum">    2219 </span>                :            :                         }
<span class="lineNum">    2220 </span>                :            :                 }
<span class="lineNum">    2221 </span>                :            :         }
<span class="lineNum">    2222 </span>                :            : 
<span class="lineNum">    2223 </span>                :            : byteswap:
<span class="lineNum">    2224 </span>                :            :         /* Byteswap the buf's data if necessary */
<span class="lineNum">    2225 </span>        [<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchCov" title="Branch 1 was taken 1304542 times"> + </span>]:<span class="lineCov">    1304560 :         if (bswap != DMU_BSWAP_NUMFUNCS) {</span>
<span class="lineNum">    2226 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">         18 :                 ASSERT(!HDR_SHARED_DATA(hdr));</span>
<span class="lineNum">    2227 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">         18 :                 ASSERT3U(bswap, &lt;, DMU_BSWAP_NUMFUNCS);</span>
<span class="lineNum">    2228 </span>                :<span class="lineCov">         18 :                 dmu_ot_byteswap[bswap].ob_func(buf-&gt;b_data, HDR_GET_LSIZE(hdr));</span>
<span class="lineNum">    2229 </span>                :            :         }
<span class="lineNum">    2230 </span>                :            : 
<span class="lineNum">    2231 </span>                :            :         /* Compute the hdr's checksum if necessary */
<span class="lineNum">    2232 </span>                :<span class="lineCov">    1304560 :         arc_cksum_compute(buf);</span>
<span class="lineNum">    2233 </span>                :            : 
<span class="lineNum">    2234 </span>                :<span class="lineCov">    1305399 :         return (0);</span>
<span class="lineNum">    2235 </span>                :            : }
<span class="lineNum">    2236 </span>                :            : 
<span class="lineNum">    2237 </span>                :            : /*
<span class="lineNum">    2238 </span>                :            :  * If this function is being called to decrypt an encrypted buffer or verify an
<span class="lineNum">    2239 </span>                :            :  * authenticated one, the key must be loaded and a mapping must be made
<span class="lineNum">    2240 </span>                :            :  * available in the keystore via spa_keystore_create_mapping() or one of its
<span class="lineNum">    2241 </span>                :            :  * callers.
<a name="2242"><span class="lineNum">    2242 </span>                :            :  */</a>
<span class="lineNum">    2243 </span>                :            : int
<span class="lineNum">    2244 </span>                :<span class="lineNoCov">          0 : arc_untransform(arc_buf_t *buf, spa_t *spa, uint64_t dsobj, boolean_t in_place)</span>
<span class="lineNum">    2245 </span>                :            : {
<span class="lineNum">    2246 </span>                :<span class="lineNoCov">          0 :         arc_fill_flags_t flags = 0;</span>
<span class="lineNum">    2247 </span>                :            : 
<span class="lineNum">    2248 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (in_place)</span>
<span class="lineNum">    2249 </span>                :<span class="lineNoCov">          0 :                 flags |= ARC_FILL_IN_PLACE;</span>
<span class="lineNum">    2250 </span>                :            : 
<span class="lineNum">    2251 </span>                :<span class="lineNoCov">          0 :         return (arc_buf_fill(buf, spa, dsobj, flags));</span>
<span class="lineNum">    2252 </span>                :            : }
<span class="lineNum">    2253 </span>                :            : 
<span class="lineNum">    2254 </span>                :            : /*
<span class="lineNum">    2255 </span>                :            :  * Increment the amount of evictable space in the arc_state_t's refcount.
<span class="lineNum">    2256 </span>                :            :  * We account for the space used by the hdr and the arc buf individually
<span class="lineNum">    2257 </span>                :            :  * so that we can add and remove them from the refcount individually.
<a name="2258"><span class="lineNum">    2258 </span>                :            :  */</a>
<span class="lineNum">    2259 </span>                :            : static void
<span class="lineNum">    2260 </span>                :<span class="lineCov">     860175 : arc_evictable_space_increment(arc_buf_hdr_t *hdr, arc_state_t *state)</span>
<span class="lineNum">    2261 </span>                :            : {
<span class="lineNum">    2262 </span>                :<span class="lineCov">     860175 :         arc_buf_contents_t type = arc_buf_type(hdr);</span>
<span class="lineNum">    2263 </span>                :            :         arc_buf_t *buf;
<span class="lineNum">    2264 </span>                :            : 
<span class="lineNum">    2265 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 860181 times"> + </span>]:<span class="lineCov">     860181 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    2266 </span>                :            : 
<span class="lineNum">    2267 </span>[<span class="branchCov" title="Branch 0 was taken 601990 times"> + </span><span class="branchCov" title="Branch 1 was taken 258191 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 587036 times"> + </span><span class="branchCov" title="Branch 3 was taken 14954 times"> + </span>]:<span class="lineCov">     860181 :         if (GHOST_STATE(state)) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchCov" title="Branch 5 was taken 587035 times"> + </span>]
<span class="lineNum">    2268 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>]:<span class="lineCov">     273146 :                 ASSERT0(hdr-&gt;b_l1hdr.b_bufcnt);</span>
<span class="lineNum">    2269 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>]:<span class="lineCov">     273146 :                 ASSERT3P(hdr-&gt;b_l1hdr.b_buf, ==, NULL);</span>
<span class="lineNum">    2270 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>]:<span class="lineCov">     273146 :                 ASSERT3P(hdr-&gt;b_l1hdr.b_pabd, ==, NULL);</span>
<span class="lineNum">    2271 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     273146 :                 ASSERT(!HDR_HAS_RABD(hdr));</span>
<span class="lineNum">    2272 </span>                :<span class="lineCov">     273146 :                 (void) refcount_add_many(&amp;state-&gt;arcs_esize[type],</span>
<span class="lineNum">    2273 </span>                :<span class="lineCov">     273146 :                     HDR_GET_LSIZE(hdr), hdr);</span>
<span class="lineNum">    2274 </span>                :<span class="lineCov">     273146 :                 return;</span>
<span class="lineNum">    2275 </span>                :            :         }
<span class="lineNum">    2276 </span>                :            : 
<span class="lineNum">    2277 </span>                :            :         ASSERT(!GHOST_STATE(state));
<span class="lineNum">    2278 </span>        [<span class="branchCov" title="Branch 0 was taken 586932 times"> + </span><span class="branchCov" title="Branch 1 was taken 103 times"> + </span>]:<span class="lineCov">     587035 :         if (hdr-&gt;b_l1hdr.b_pabd != NULL) {</span>
<span class="lineNum">    2279 </span>                :<span class="lineCov">     586932 :                 (void) refcount_add_many(&amp;state-&gt;arcs_esize[type],</span>
<span class="lineNum">    2280 </span>                :            :                     arc_hdr_size(hdr), hdr);
<span class="lineNum">    2281 </span>                :            :         }
<span class="lineNum">    2282 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 587046 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     587046 :         if (HDR_HAS_RABD(hdr)) {</span>
<span class="lineNum">    2283 </span>                :<span class="lineNoCov">          0 :                 (void) refcount_add_many(&amp;state-&gt;arcs_esize[type],</span>
<span class="lineNum">    2284 </span>                :<span class="lineNoCov">          0 :                     HDR_GET_PSIZE(hdr), hdr);</span>
<span class="lineNum">    2285 </span>                :            :         }
<span class="lineNum">    2286 </span>                :            : 
<span class="lineNum">    2287 </span>        [<span class="branchCov" title="Branch 0 was taken 345483 times"> + </span><span class="branchCov" title="Branch 1 was taken 587046 times"> + </span>]:<span class="lineCov">     932529 :         for (buf = hdr-&gt;b_l1hdr.b_buf; buf != NULL; buf = buf-&gt;b_next) {</span>
<span class="lineNum">    2288 </span>        [<span class="branchCov" title="Branch 1 was taken 69413 times"> + </span><span class="branchCov" title="Branch 2 was taken 276069 times"> + </span>]:<span class="lineCov">     345483 :                 if (arc_buf_is_shared(buf))</span>
<span class="lineNum">    2289 </span>                :<span class="lineCov">      69413 :                         continue;</span>
<span class="lineNum">    2290 </span>                :<span class="lineCov">     276069 :                 (void) refcount_add_many(&amp;state-&gt;arcs_esize[type],</span>
<span class="lineNum">    2291 </span>                :            :                     arc_buf_size(buf), buf);
<span class="lineNum">    2292 </span>                :            :         }
<span class="lineNum">    2293 </span>                :            : }
<span class="lineNum">    2294 </span>                :            : 
<span class="lineNum">    2295 </span>                :            : /*
<span class="lineNum">    2296 </span>                :            :  * Decrement the amount of evictable space in the arc_state_t's refcount.
<span class="lineNum">    2297 </span>                :            :  * We account for the space used by the hdr and the arc buf individually
<span class="lineNum">    2298 </span>                :            :  * so that we can add and remove them from the refcount individually.
<a name="2299"><span class="lineNum">    2299 </span>                :            :  */</a>
<span class="lineNum">    2300 </span>                :            : static void
<span class="lineNum">    2301 </span>                :<span class="lineCov">     860179 : arc_evictable_space_decrement(arc_buf_hdr_t *hdr, arc_state_t *state)</span>
<span class="lineNum">    2302 </span>                :            : {
<span class="lineNum">    2303 </span>                :<span class="lineCov">     860179 :         arc_buf_contents_t type = arc_buf_type(hdr);</span>
<span class="lineNum">    2304 </span>                :            :         arc_buf_t *buf;
<span class="lineNum">    2305 </span>                :            : 
<span class="lineNum">    2306 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 860179 times"> + </span>]:<span class="lineCov">     860179 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    2307 </span>                :            : 
<span class="lineNum">    2308 </span>[<span class="branchCov" title="Branch 0 was taken 601992 times"> + </span><span class="branchCov" title="Branch 1 was taken 258187 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 587033 times"> + </span><span class="branchCov" title="Branch 3 was taken 14959 times"> + </span>]:<span class="lineCov">     860179 :         if (GHOST_STATE(state)) {</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 587033 times"> + </span>]
<span class="lineNum">    2309 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>]:<span class="lineCov">     273146 :                 ASSERT0(hdr-&gt;b_l1hdr.b_bufcnt);</span>
<span class="lineNum">    2310 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>]:<span class="lineCov">     273146 :                 ASSERT3P(hdr-&gt;b_l1hdr.b_buf, ==, NULL);</span>
<span class="lineNum">    2311 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>]:<span class="lineCov">     273146 :                 ASSERT3P(hdr-&gt;b_l1hdr.b_pabd, ==, NULL);</span>
<span class="lineNum">    2312 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     273146 :                 ASSERT(!HDR_HAS_RABD(hdr));</span>
<span class="lineNum">    2313 </span>                :<span class="lineCov">     273146 :                 (void) refcount_remove_many(&amp;state-&gt;arcs_esize[type],</span>
<span class="lineNum">    2314 </span>                :<span class="lineCov">     273146 :                     HDR_GET_LSIZE(hdr), hdr);</span>
<span class="lineNum">    2315 </span>                :<span class="lineCov">     273146 :                 return;</span>
<span class="lineNum">    2316 </span>                :            :         }
<span class="lineNum">    2317 </span>                :            : 
<span class="lineNum">    2318 </span>                :            :         ASSERT(!GHOST_STATE(state));
<span class="lineNum">    2319 </span>        [<span class="branchCov" title="Branch 0 was taken 313887 times"> + </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>]:<span class="lineCov">     587033 :         if (hdr-&gt;b_l1hdr.b_pabd != NULL) {</span>
<span class="lineNum">    2320 </span>                :<span class="lineCov">     313887 :                 (void) refcount_remove_many(&amp;state-&gt;arcs_esize[type],</span>
<span class="lineNum">    2321 </span>                :            :                     arc_hdr_size(hdr), hdr);
<span class="lineNum">    2322 </span>                :            :         }
<span class="lineNum">    2323 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 587033 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     587033 :         if (HDR_HAS_RABD(hdr)) {</span>
<span class="lineNum">    2324 </span>                :<span class="lineNoCov">          0 :                 (void) refcount_remove_many(&amp;state-&gt;arcs_esize[type],</span>
<span class="lineNum">    2325 </span>                :<span class="lineNoCov">          0 :                     HDR_GET_PSIZE(hdr), hdr);</span>
<span class="lineNum">    2326 </span>                :            :         }
<span class="lineNum">    2327 </span>                :            : 
<span class="lineNum">    2328 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 587033 times"> + </span>]:<span class="lineCov">     587033 :         for (buf = hdr-&gt;b_l1hdr.b_buf; buf != NULL; buf = buf-&gt;b_next) {</span>
<span class="lineNum">    2329 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (arc_buf_is_shared(buf))</span>
<span class="lineNum">    2330 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    2331 </span>                :<span class="lineNoCov">          0 :                 (void) refcount_remove_many(&amp;state-&gt;arcs_esize[type],</span>
<span class="lineNum">    2332 </span>                :            :                     arc_buf_size(buf), buf);
<span class="lineNum">    2333 </span>                :            :         }
<span class="lineNum">    2334 </span>                :            : }
<span class="lineNum">    2335 </span>                :            : 
<span class="lineNum">    2336 </span>                :            : /*
<span class="lineNum">    2337 </span>                :            :  * Add a reference to this hdr indicating that someone is actively
<span class="lineNum">    2338 </span>                :            :  * referencing that memory. When the refcount transitions from 0 to 1,
<span class="lineNum">    2339 </span>                :            :  * we remove it from the respective arc_state_t list to indicate that
<span class="lineNum">    2340 </span>                :            :  * it is not evictable.
<a name="2341"><span class="lineNum">    2341 </span>                :            :  */</a>
<span class="lineNum">    2342 </span>                :            : static void
<span class="lineNum">    2343 </span>                :<span class="lineCov">    1637247 : add_reference(arc_buf_hdr_t *hdr, void *tag)</span>
<span class="lineNum">    2344 </span>                :            : {
<span class="lineNum">    2345 </span>                :            :         arc_state_t *state;
<span class="lineNum">    2346 </span>                :            : 
<span class="lineNum">    2347 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1637247 times"> + </span>]:<span class="lineCov">    1637247 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    2348 </span>        [<span class="branchCov" title="Branch 3 was taken 1253205 times"> + </span><span class="branchCov" title="Branch 4 was taken 385347 times"> + </span>]:<span class="lineCov">    1637247 :         if (!MUTEX_HELD(HDR_LOCK(hdr))) {</span>
<span class="lineNum">    2349 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1253205 times"> + </span>]:<span class="lineCov">    1253205 :                 ASSERT(hdr-&gt;b_l1hdr.b_state == arc_anon);</span>
<span class="lineNum">    2350 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1252343 times"> + </span>]:<span class="lineCov">    1253205 :                 ASSERT(refcount_is_zero(&amp;hdr-&gt;b_l1hdr.b_refcnt));</span>
<span class="lineNum">    2351 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1252343 times"> + </span>]:<span class="lineCov">    1252343 :                 ASSERT3P(hdr-&gt;b_l1hdr.b_buf, ==, NULL);</span>
<span class="lineNum">    2352 </span>                :            :         }
<span class="lineNum">    2353 </span>                :            : 
<span class="lineNum">    2354 </span>                :<span class="lineCov">    1637690 :         state = hdr-&gt;b_l1hdr.b_state;</span>
<span class="lineNum">    2355 </span>                :            : 
<span class="lineNum">    2356 </span>[<span class="branchCov" title="Branch 1 was taken 1547765 times"> + </span><span class="branchCov" title="Branch 2 was taken 90992 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 292079 times"> + </span><span class="branchCov" title="Branch 4 was taken 1255686 times"> + </span>]:<span class="lineCov">    1637690 :         if ((refcount_add(&amp;hdr-&gt;b_l1hdr.b_refcnt, tag) == 1) &amp;&amp;</span>
<span class="lineNum">    2357 </span>                :<span class="lineCov">    1547765 :             (state != arc_anon)) {</span>
<span class="lineNum">    2358 </span>                :            :                 /* We don't use the L2-only state list. */
<span class="lineNum">    2359 </span>        [<span class="branchCov" title="Branch 0 was taken 292079 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     292079 :                 if (state != arc_l2c_only) {</span>
<span class="lineNum">    2360 </span>                :<span class="lineCov">     292079 :                         multilist_remove(state-&gt;arcs_list[arc_buf_type(hdr)],</span>
<span class="lineNum">    2361 </span>                :            :                             hdr);
<span class="lineNum">    2362 </span>                :<span class="lineCov">     292080 :                         arc_evictable_space_decrement(hdr, state);</span>
<span class="lineNum">    2363 </span>                :            :                 }
<span class="lineNum">    2364 </span>                :            :                 /* remove the prefetch flag if we get a reference */
<span class="lineNum">    2365 </span>                :<span class="lineCov">     292080 :                 arc_hdr_clear_flags(hdr, ARC_FLAG_PREFETCH);</span>
<span class="lineNum">    2366 </span>                :            :         }
<span class="lineNum">    2367 </span>                :<span class="lineCov">    1638758 : }</span>
<span class="lineNum">    2368 </span>                :            : 
<span class="lineNum">    2369 </span>                :            : /*
<span class="lineNum">    2370 </span>                :            :  * Remove a reference from this hdr. When the reference transitions from
<span class="lineNum">    2371 </span>                :            :  * 1 to 0 and we're not anonymous, then we add this hdr to the arc_state_t's
<span class="lineNum">    2372 </span>                :            :  * list making it eligible for eviction.
<a name="2373"><span class="lineNum">    2373 </span>                :            :  */</a>
<span class="lineNum">    2374 </span>                :            : static int
<span class="lineNum">    2375 </span>                :<span class="lineCov">    1638791 : remove_reference(arc_buf_hdr_t *hdr, kmutex_t *hash_lock, void *tag)</span>
<span class="lineNum">    2376 </span>                :            : {
<span class="lineNum">    2377 </span>                :            :         int cnt;
<span class="lineNum">    2378 </span>                :<span class="lineCov">    1638791 :         arc_state_t *state = hdr-&gt;b_l1hdr.b_state;</span>
<span class="lineNum">    2379 </span>                :            : 
<span class="lineNum">    2380 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1638791 times"> + </span>]:<span class="lineCov">    1638791 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    2381 </span>[<span class="branchCov" title="Branch 0 was taken 436472 times"> + </span><span class="branchCov" title="Branch 1 was taken 1202319 times"> + </span>][<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 436472 times"> + </span>]:<span class="lineCov">    1638791 :         ASSERT(state == arc_anon || MUTEX_HELD(hash_lock));</span>
<span class="lineNum">    2382 </span>      [<span class="branchCov" title="Branch 0 was taken 1638793 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1638831 times"> + </span>]:<span class="lineCov">    1638791 :         ASSERT(!GHOST_STATE(state));</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 16 times"> + </span><span class="branchCov" title="Branch 5 was taken 1638815 times"> + </span>]
<span class="lineNum">    2383 </span>                :            : 
<span class="lineNum">    2384 </span>                :            :         /*
<span class="lineNum">    2385 </span>                :            :          * arc_l2c_only counts as a ghost state so we don't need to explicitly
<span class="lineNum">    2386 </span>                :            :          * check to prevent usage of the arc_l2c_only list.
<span class="lineNum">    2387 </span>                :            :          */
<span class="lineNum">    2388 </span>[<span class="branchCov" title="Branch 1 was taken 1547897 times"> + </span><span class="branchCov" title="Branch 2 was taken 90987 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 345483 times"> + </span><span class="branchCov" title="Branch 4 was taken 1202414 times"> + </span>]:<span class="lineCov">    1638815 :         if (((cnt = refcount_remove(&amp;hdr-&gt;b_l1hdr.b_refcnt, tag)) == 0) &amp;&amp;</span>
<span class="lineNum">    2389 </span>                :<span class="lineCov">    1547897 :             (state != arc_anon)) {</span>
<span class="lineNum">    2390 </span>                :<span class="lineCov">     345483 :                 multilist_insert(state-&gt;arcs_list[arc_buf_type(hdr)], hdr);</span>
<span class="lineNum">    2391 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 345481 times"> + </span>]:<span class="lineCov">     345481 :                 ASSERT3U(hdr-&gt;b_l1hdr.b_bufcnt, &gt;, 0);</span>
<span class="lineNum">    2392 </span>                :<span class="lineCov">     345481 :                 arc_evictable_space_increment(hdr, state);</span>
<span class="lineNum">    2393 </span>                :            :         }
<span class="lineNum">    2394 </span>                :<span class="lineCov">    1638884 :         return (cnt);</span>
<span class="lineNum">    2395 </span>                :            : }
<span class="lineNum">    2396 </span>                :            : 
<span class="lineNum">    2397 </span>                :            : /*
<span class="lineNum">    2398 </span>                :            :  * Returns detailed information about a specific arc buffer.  When the
<span class="lineNum">    2399 </span>                :            :  * state_index argument is set the function will calculate the arc header
<span class="lineNum">    2400 </span>                :            :  * list position for its arc state.  Since this requires a linear traversal
<span class="lineNum">    2401 </span>                :            :  * callers are strongly encourage not to do this.  However, it can be helpful
<span class="lineNum">    2402 </span>                :            :  * for targeted analysis so the functionality is provided.
<a name="2403"><span class="lineNum">    2403 </span>                :            :  */</a>
<span class="lineNum">    2404 </span>                :            : void
<span class="lineNum">    2405 </span>                :<span class="lineNoCov">          0 : arc_buf_info(arc_buf_t *ab, arc_buf_info_t *abi, int state_index)</span>
<span class="lineNum">    2406 </span>                :            : {
<span class="lineNum">    2407 </span>                :<span class="lineNoCov">          0 :         arc_buf_hdr_t *hdr = ab-&gt;b_hdr;</span>
<span class="lineNum">    2408 </span>                :<span class="lineNoCov">          0 :         l1arc_buf_hdr_t *l1hdr = NULL;</span>
<span class="lineNum">    2409 </span>                :<span class="lineNoCov">          0 :         l2arc_buf_hdr_t *l2hdr = NULL;</span>
<span class="lineNum">    2410 </span>                :<span class="lineNoCov">          0 :         arc_state_t *state = NULL;</span>
<span class="lineNum">    2411 </span>                :            : 
<span class="lineNum">    2412 </span>                :<span class="lineNoCov">          0 :         memset(abi, 0, sizeof (arc_buf_info_t));</span>
<span class="lineNum">    2413 </span>                :            : 
<span class="lineNum">    2414 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (hdr == NULL)</span>
<span class="lineNum">    2415 </span>                :            :                 return;
<span class="lineNum">    2416 </span>                :            : 
<span class="lineNum">    2417 </span>                :<span class="lineNoCov">          0 :         abi-&gt;abi_flags = hdr-&gt;b_flags;</span>
<span class="lineNum">    2418 </span>                :            : 
<span class="lineNum">    2419 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (HDR_HAS_L1HDR(hdr)) {</span>
<span class="lineNum">    2420 </span>                :<span class="lineNoCov">          0 :                 l1hdr = &amp;hdr-&gt;b_l1hdr;</span>
<span class="lineNum">    2421 </span>                :<span class="lineNoCov">          0 :                 state = l1hdr-&gt;b_state;</span>
<span class="lineNum">    2422 </span>                :            :         }
<span class="lineNum">    2423 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (HDR_HAS_L2HDR(hdr))</span>
<span class="lineNum">    2424 </span>                :<span class="lineNoCov">          0 :                 l2hdr = &amp;hdr-&gt;b_l2hdr;</span>
<span class="lineNum">    2425 </span>                :            : 
<span class="lineNum">    2426 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (l1hdr) {</span>
<span class="lineNum">    2427 </span>                :<span class="lineNoCov">          0 :                 abi-&gt;abi_bufcnt = l1hdr-&gt;b_bufcnt;</span>
<span class="lineNum">    2428 </span>                :<span class="lineNoCov">          0 :                 abi-&gt;abi_access = l1hdr-&gt;b_arc_access;</span>
<span class="lineNum">    2429 </span>                :<span class="lineNoCov">          0 :                 abi-&gt;abi_mru_hits = l1hdr-&gt;b_mru_hits;</span>
<span class="lineNum">    2430 </span>                :<span class="lineNoCov">          0 :                 abi-&gt;abi_mru_ghost_hits = l1hdr-&gt;b_mru_ghost_hits;</span>
<span class="lineNum">    2431 </span>                :<span class="lineNoCov">          0 :                 abi-&gt;abi_mfu_hits = l1hdr-&gt;b_mfu_hits;</span>
<span class="lineNum">    2432 </span>                :<span class="lineNoCov">          0 :                 abi-&gt;abi_mfu_ghost_hits = l1hdr-&gt;b_mfu_ghost_hits;</span>
<span class="lineNum">    2433 </span>                :<span class="lineNoCov">          0 :                 abi-&gt;abi_holds = refcount_count(&amp;l1hdr-&gt;b_refcnt);</span>
<span class="lineNum">    2434 </span>                :            :         }
<span class="lineNum">    2435 </span>                :            : 
<span class="lineNum">    2436 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (l2hdr) {</span>
<span class="lineNum">    2437 </span>                :<span class="lineNoCov">          0 :                 abi-&gt;abi_l2arc_dattr = l2hdr-&gt;b_daddr;</span>
<span class="lineNum">    2438 </span>                :<span class="lineNoCov">          0 :                 abi-&gt;abi_l2arc_hits = l2hdr-&gt;b_hits;</span>
<span class="lineNum">    2439 </span>                :            :         }
<span class="lineNum">    2440 </span>                :            : 
<span class="lineNum">    2441 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         abi-&gt;abi_state_type = state ? state-&gt;arcs_state : ARC_STATE_ANON;</span>
<span class="lineNum">    2442 </span>                :<span class="lineNoCov">          0 :         abi-&gt;abi_state_contents = arc_buf_type(hdr);</span>
<span class="lineNum">    2443 </span>                :<span class="lineNoCov">          0 :         abi-&gt;abi_size = arc_hdr_size(hdr);</span>
<span class="lineNum">    2444 </span>                :            : }
<span class="lineNum">    2445 </span>                :            : 
<span class="lineNum">    2446 </span>                :            : /*
<span class="lineNum">    2447 </span>                :            :  * Move the supplied buffer to the indicated state. The hash lock
<span class="lineNum">    2448 </span>                :            :  * for the buffer must be held by the caller.
<a name="2449"><span class="lineNum">    2449 </span>                :            :  */</a>
<span class="lineNum">    2450 </span>                :            : static void
<span class="lineNum">    2451 </span>                :<span class="lineCov">    2072462 : arc_change_state(arc_state_t *new_state, arc_buf_hdr_t *hdr,</span>
<span class="lineNum">    2452 </span>                :            :     kmutex_t *hash_lock)
<span class="lineNum">    2453 </span>                :            : {
<span class="lineNum">    2454 </span>                :            :         arc_state_t *old_state;
<span class="lineNum">    2455 </span>                :            :         int64_t refcnt;
<span class="lineNum">    2456 </span>                :            :         uint32_t bufcnt;
<span class="lineNum">    2457 </span>                :            :         boolean_t update_old, update_new;
<span class="lineNum">    2458 </span>                :<span class="lineCov">    2072462 :         arc_buf_contents_t buftype = arc_buf_type(hdr);</span>
<span class="lineNum">    2459 </span>                :            : 
<span class="lineNum">    2460 </span>                :            :         /*
<span class="lineNum">    2461 </span>                :            :          * We almost always have an L1 hdr here, since we call arc_hdr_realloc()
<span class="lineNum">    2462 </span>                :            :          * in arc_read() when bringing a buffer out of the L2ARC.  However, the
<span class="lineNum">    2463 </span>                :            :          * L1 hdr doesn't always exist when we change state to arc_anon before
<span class="lineNum">    2464 </span>                :            :          * destroying a header, in which case reallocating to add the L1 hdr is
<span class="lineNum">    2465 </span>                :            :          * pointless.
<span class="lineNum">    2466 </span>                :            :          */
<span class="lineNum">    2467 </span>        [<span class="branchCov" title="Branch 0 was taken 2069631 times"> + </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>]:<span class="lineCov">    2072375 :         if (HDR_HAS_L1HDR(hdr)) {</span>
<span class="lineNum">    2468 </span>                :<span class="lineCov">    2069631 :                 old_state = hdr-&gt;b_l1hdr.b_state;</span>
<span class="lineNum">    2469 </span>                :<span class="lineCov">    2069631 :                 refcnt = refcount_count(&amp;hdr-&gt;b_l1hdr.b_refcnt);</span>
<span class="lineNum">    2470 </span>                :<span class="lineCov">    2069658 :                 bufcnt = hdr-&gt;b_l1hdr.b_bufcnt;</span>
<span class="lineNum">    2471 </span>[<span class="branchCov" title="Branch 0 was taken 809531 times"> + </span><span class="branchCov" title="Branch 1 was taken 1260127 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 546292 times"> + </span><span class="branchCov" title="Branch 3 was taken 263239 times"> + </span>]:<span class="lineCov">    2615950 :                 update_old = (bufcnt &gt; 0 || hdr-&gt;b_l1hdr.b_pabd != NULL ||</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 546292 times"> + </span>]
<span class="lineNum">    2472 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineCov">     546292 :                     HDR_HAS_RABD(hdr));</span>
<span class="lineNum">    2473 </span>                :            :         } else {
<span class="lineNum">    2474 </span>                :<span class="lineCov">       2744 :                 old_state = arc_l2c_only;</span>
<span class="lineNum">    2475 </span>                :<span class="lineCov">       2744 :                 refcnt = 0;</span>
<span class="lineNum">    2476 </span>                :<span class="lineCov">       2744 :                 bufcnt = 0;</span>
<span class="lineNum">    2477 </span>                :<span class="lineCov">       2744 :                 update_old = B_FALSE;</span>
<span class="lineNum">    2478 </span>                :            :         }
<span class="lineNum">    2479 </span>                :<span class="lineCov">    2072402 :         update_new = update_old;</span>
<span class="lineNum">    2480 </span>                :            : 
<span class="lineNum">    2481 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 2072452 times"> + </span>]:<span class="lineCov">    2072402 :         ASSERT(MUTEX_HELD(hash_lock));</span>
<span class="lineNum">    2482 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2072452 times"> + </span>]:<span class="lineCov">    2072452 :         ASSERT3P(new_state, !=, old_state);</span>
<span class="lineNum">    2483 </span>[<span class="branchCov" title="Branch 0 was taken 1814260 times"> + </span><span class="branchCov" title="Branch 1 was taken 258192 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1799307 times"> + </span><span class="branchCov" title="Branch 3 was taken 14953 times"> + </span>]:<span class="lineCov">    2072452 :         ASSERT(!GHOST_STATE(new_state) || bufcnt == 0);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 2745 times"> + </span><span class="branchCov" title="Branch 5 was taken 1796562 times"> + </span>][<span class="branchNoCov" title="Branch 6 was not taken"> - </span><span class="branchCov" title="Branch 7 was taken 275890 times"> + </span>]
<span class="lineNum">    2484 </span>[<span class="branchCov" title="Branch 0 was taken 887825 times"> + </span><span class="branchCov" title="Branch 1 was taken 1184627 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 887825 times"> + </span>]:<span class="lineCov">    2072452 :         ASSERT(old_state != arc_anon || bufcnt &lt;= 1);</span>
<span class="lineNum">    2485 </span>                :            : 
<span class="lineNum">    2486 </span>                :            :         /*
<span class="lineNum">    2487 </span>                :            :          * If this buffer is evictable, transfer it from the
<span class="lineNum">    2488 </span>                :            :          * old state list to the new state list.
<span class="lineNum">    2489 </span>                :            :          */
<span class="lineNum">    2490 </span>        [<span class="branchCov" title="Branch 0 was taken 812282 times"> + </span><span class="branchCov" title="Branch 1 was taken 1260170 times"> + </span>]:<span class="lineCov">    2072452 :         if (refcnt == 0) {</span>
<span class="lineNum">    2491 </span>[<span class="branchCov" title="Branch 0 was taken 570843 times"> + </span><span class="branchCov" title="Branch 1 was taken 241439 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 568099 times"> + </span><span class="branchCov" title="Branch 3 was taken 2744 times"> + </span>]:<span class="lineCov">     812282 :                 if (old_state != arc_anon &amp;&amp; old_state != arc_l2c_only) {</span>
<span class="lineNum">    2492 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 568099 times"> + </span>]:<span class="lineCov">     568099 :                         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    2493 </span>                :<span class="lineCov">     568099 :                         multilist_remove(old_state-&gt;arcs_list[buftype], hdr);</span>
<span class="lineNum">    2494 </span>                :            : 
<span class="lineNum">    2495 </span>[<span class="branchCov" title="Branch 0 was taken 309912 times"> + </span><span class="branchCov" title="Branch 1 was taken 258187 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 294953 times"> + </span><span class="branchCov" title="Branch 3 was taken 14959 times"> + </span>]:<span class="lineCov">     568099 :                         if (GHOST_STATE(old_state)) {</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 294953 times"> + </span>]
<span class="lineNum">    2496 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>]:<span class="lineCov">     273146 :                                 ASSERT0(bufcnt);</span>
<span class="lineNum">    2497 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>]:<span class="lineCov">     273146 :                                 ASSERT3P(hdr-&gt;b_l1hdr.b_buf, ==, NULL);</span>
<span class="lineNum">    2498 </span>                :            :                                 update_old = B_TRUE;
<span class="lineNum">    2499 </span>                :            :                         }
<span class="lineNum">    2500 </span>                :<span class="lineCov">     568099 :                         arc_evictable_space_decrement(hdr, old_state);</span>
<span class="lineNum">    2501 </span>                :            :                 }
<span class="lineNum">    2502 </span>[<span class="branchCov" title="Branch 0 was taken 517427 times"> + </span><span class="branchCov" title="Branch 1 was taken 294828 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 514682 times"> + </span><span class="branchCov" title="Branch 3 was taken 2745 times"> + </span>]:<span class="lineCov">     812255 :                 if (new_state != arc_anon &amp;&amp; new_state != arc_l2c_only) {</span>
<span class="lineNum">    2503 </span>                :            :                         /*
<span class="lineNum">    2504 </span>                :            :                          * An L1 header always exists here, since if we're
<span class="lineNum">    2505 </span>                :            :                          * moving to some L1-cached state (i.e. not l2c_only or
<span class="lineNum">    2506 </span>                :            :                          * anonymous), we realloc the header to add an L1hdr
<span class="lineNum">    2507 </span>                :            :                          * beforehand.
<span class="lineNum">    2508 </span>                :            :                          */
<span class="lineNum">    2509 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 514682 times"> + </span>]:<span class="lineCov">     514682 :                         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    2510 </span>                :<span class="lineCov">     514682 :                         multilist_insert(new_state-&gt;arcs_list[buftype], hdr);</span>
<span class="lineNum">    2511 </span>                :            : 
<span class="lineNum">    2512 </span>[<span class="branchCov" title="Branch 0 was taken 256521 times"> + </span><span class="branchCov" title="Branch 1 was taken 258188 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 241562 times"> + </span><span class="branchCov" title="Branch 3 was taken 14959 times"> + </span>]:<span class="lineCov">     514709 :                         if (GHOST_STATE(new_state)) {</span>
<span class="lineNum">         </span>           [<span class="branchCov" title="Branch 5 was taken 241563 times"> + </span>]
<span class="lineNum">    2513 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>]:<span class="lineCov">     273146 :                                 ASSERT0(bufcnt);</span>
<span class="lineNum">    2514 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>]:<span class="lineCov">     273146 :                                 ASSERT3P(hdr-&gt;b_l1hdr.b_buf, ==, NULL);</span>
<span class="lineNum">    2515 </span>                :            :                                 update_new = B_TRUE;
<span class="lineNum">    2516 </span>                :            :                         }
<span class="lineNum">    2517 </span>                :<span class="lineCov">     514709 :                         arc_evictable_space_increment(hdr, new_state);</span>
<span class="lineNum">    2518 </span>                :            :                 }
<span class="lineNum">    2519 </span>                :            :         }
<span class="lineNum">    2520 </span>                :            : 
<span class="lineNum">    2521 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2072452 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    2072452 :         ASSERT(!HDR_EMPTY(hdr));</span>
<span class="lineNum">    2522 </span>[<span class="branchCov" title="Branch 0 was taken 887839 times"> + </span><span class="branchCov" title="Branch 1 was taken 1184613 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 887839 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">    2072452 :         if (new_state == arc_anon &amp;&amp; HDR_IN_HASH_TABLE(hdr))</span>
<span class="lineNum">    2523 </span>                :<span class="lineCov">     887839 :                 buf_hash_remove(hdr);</span>
<span class="lineNum">    2524 </span>                :            : 
<span class="lineNum">    2525 </span>                :            :         /* adjust state sizes (ignore arc_l2c_only) */
<span class="lineNum">    2526 </span>                :            : 
<span class="lineNum">    2527 </span>   [<span class="branchCov" title="Branch 0 was taken 1796581 times"> + </span><span class="branchCov" title="Branch 1 was taken 275896 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1796584 times"> + </span>]:<span class="lineCov">    2072477 :         if (update_new &amp;&amp; new_state != arc_l2c_only) {</span>
<span class="lineNum">    2528 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1796584 times"> + </span>]:<span class="lineCov">    1796584 :                 ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    2529 </span>[<span class="branchCov" title="Branch 0 was taken 1538404 times"> + </span><span class="branchCov" title="Branch 1 was taken 258180 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 14966 times"> + </span><span class="branchCov" title="Branch 3 was taken 1523438 times"> + </span>]:<span class="lineCov">    1796584 :                 if (GHOST_STATE(new_state)) {</span>
<span class="lineNum">    2530 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>]:<span class="lineCov">     273146 :                         ASSERT0(bufcnt);</span>
<span class="lineNum">    2531 </span>                :            : 
<span class="lineNum">    2532 </span>                :            :                         /*
<span class="lineNum">    2533 </span>                :            :                          * When moving a header to a ghost state, we first
<span class="lineNum">    2534 </span>                :            :                          * remove all arc buffers. Thus, we'll have a
<span class="lineNum">    2535 </span>                :            :                          * bufcnt of zero, and no arc buffer to use for
<span class="lineNum">    2536 </span>                :            :                          * the reference. As a result, we use the arc
<span class="lineNum">    2537 </span>                :            :                          * header pointer for the reference.
<span class="lineNum">    2538 </span>                :            :                          */
<span class="lineNum">    2539 </span>                :<span class="lineCov">     273146 :                         (void) refcount_add_many(&amp;new_state-&gt;arcs_size,</span>
<span class="lineNum">    2540 </span>                :<span class="lineCov">     273146 :                             HDR_GET_LSIZE(hdr), hdr);</span>
<span class="lineNum">    2541 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>]:<span class="lineCov">     273146 :                         ASSERT3P(hdr-&gt;b_l1hdr.b_pabd, ==, NULL);</span>
<span class="lineNum">    2542 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     273146 :                         ASSERT(!HDR_HAS_RABD(hdr));</span>
<span class="lineNum">    2543 </span>                :            :                 } else {
<span class="lineNum">    2544 </span>                :            :                         arc_buf_t *buf;
<span class="lineNum">    2545 </span>                :<span class="lineCov">    1523438 :                         uint32_t buffers = 0;</span>
<span class="lineNum">    2546 </span>                :            : 
<span class="lineNum">    2547 </span>                :            :                         /*
<span class="lineNum">    2548 </span>                :            :                          * Each individual buffer holds a unique reference,
<span class="lineNum">    2549 </span>                :            :                          * thus we must remove each of these references one
<span class="lineNum">    2550 </span>                :            :                          * at a time.
<span class="lineNum">    2551 </span>                :            :                          */
<span class="lineNum">    2552 </span>        [<span class="branchCov" title="Branch 0 was taken 1260841 times"> + </span><span class="branchCov" title="Branch 1 was taken 1523511 times"> + </span>]:<span class="lineCov">    2784352 :                         for (buf = hdr-&gt;b_l1hdr.b_buf; buf != NULL;</span>
<span class="lineNum">    2553 </span>                :<span class="lineCov">    1260914 :                             buf = buf-&gt;b_next) {</span>
<span class="lineNum">    2554 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 1260839 times"> + </span>]:<span class="lineCov">    1260841 :                                 ASSERT3U(bufcnt, !=, 0);</span>
<span class="lineNum">    2555 </span>                :<span class="lineCov">    1260839 :                                 buffers++;</span>
<span class="lineNum">    2556 </span>                :            : 
<span class="lineNum">    2557 </span>                :            :                                 /*
<span class="lineNum">    2558 </span>                :            :                                  * When the arc_buf_t is sharing the data
<span class="lineNum">    2559 </span>                :            :                                  * block with the hdr, the owner of the
<span class="lineNum">    2560 </span>                :            :                                  * reference belongs to the hdr. Only
<span class="lineNum">    2561 </span>                :            :                                  * add to the refcount if the arc_buf_t is
<span class="lineNum">    2562 </span>                :            :                                  * not shared.
<span class="lineNum">    2563 </span>                :            :                                  */
<span class="lineNum">    2564 </span>        [<span class="branchCov" title="Branch 1 was taken 329402 times"> + </span><span class="branchCov" title="Branch 2 was taken 931450 times"> + </span>]:<span class="lineCov">    1260839 :                                 if (arc_buf_is_shared(buf))</span>
<span class="lineNum">    2565 </span>                :<span class="lineCov">     329402 :                                         continue;</span>
<span class="lineNum">    2566 </span>                :            : 
<span class="lineNum">    2567 </span>                :<span class="lineCov">     931450 :                                 (void) refcount_add_many(&amp;new_state-&gt;arcs_size,</span>
<span class="lineNum">    2568 </span>                :            :                                     arc_buf_size(buf), buf);
<span class="lineNum">    2569 </span>                :            :                         }
<span class="lineNum">    2570 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1523511 times"> + </span>]:<span class="lineCov">    1523511 :                         ASSERT3U(bufcnt, ==, buffers);</span>
<span class="lineNum">    2571 </span>                :            : 
<span class="lineNum">    2572 </span>           [<span class="branchCov" title="Branch 0 was taken 1523512 times"> + </span>]:<span class="lineCov">    1523511 :                         if (hdr-&gt;b_l1hdr.b_pabd != NULL) {</span>
<span class="lineNum">    2573 </span>                :<span class="lineCov">    1523512 :                                 (void) refcount_add_many(&amp;new_state-&gt;arcs_size,</span>
<span class="lineNum">    2574 </span>                :            :                                     arc_hdr_size(hdr), hdr);
<span class="lineNum">    2575 </span>                :            :                         }
<span class="lineNum">    2576 </span>                :            : 
<span class="lineNum">    2577 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1523556 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1523556 :                         if (HDR_HAS_RABD(hdr)) {</span>
<span class="lineNum">    2578 </span>                :<span class="lineNoCov">          0 :                                 (void) refcount_add_many(&amp;new_state-&gt;arcs_size,</span>
<span class="lineNum">    2579 </span>                :<span class="lineNoCov">          0 :                                     HDR_GET_PSIZE(hdr), hdr);</span>
<span class="lineNum">    2580 </span>                :            :                         }
<span class="lineNum">    2581 </span>                :            :                 }
<span class="lineNum">    2582 </span>                :            :         }
<span class="lineNum">    2583 </span>                :            : 
<span class="lineNum">    2584 </span>   [<span class="branchCov" title="Branch 0 was taken 1796701 times"> + </span><span class="branchCov" title="Branch 1 was taken 275894 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1796704 times"> + </span>]:<span class="lineCov">    2072595 :         if (update_old &amp;&amp; old_state != arc_l2c_only) {</span>
<span class="lineNum">    2585 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1796704 times"> + </span>]:<span class="lineCov">    1796704 :                 ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    2586 </span>[<span class="branchCov" title="Branch 0 was taken 1538516 times"> + </span><span class="branchCov" title="Branch 1 was taken 258188 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 14958 times"> + </span><span class="branchCov" title="Branch 3 was taken 1523558 times"> + </span>]:<span class="lineCov">    1796704 :                 if (GHOST_STATE(old_state)) {</span>
<span class="lineNum">    2587 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>]:<span class="lineCov">     273146 :                         ASSERT0(bufcnt);</span>
<span class="lineNum">    2588 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>]:<span class="lineCov">     273146 :                         ASSERT3P(hdr-&gt;b_l1hdr.b_pabd, ==, NULL);</span>
<span class="lineNum">    2589 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     273146 :                         ASSERT(!HDR_HAS_RABD(hdr));</span>
<span class="lineNum">    2590 </span>                :            : 
<span class="lineNum">    2591 </span>                :            :                         /*
<span class="lineNum">    2592 </span>                :            :                          * When moving a header off of a ghost state,
<span class="lineNum">    2593 </span>                :            :                          * the header will not contain any arc buffers.
<span class="lineNum">    2594 </span>                :            :                          * We use the arc header pointer for the reference
<span class="lineNum">    2595 </span>                :            :                          * which is exactly what we did when we put the
<span class="lineNum">    2596 </span>                :            :                          * header on the ghost state.
<span class="lineNum">    2597 </span>                :            :                          */
<span class="lineNum">    2598 </span>                :            : 
<span class="lineNum">    2599 </span>                :<span class="lineCov">     273146 :                         (void) refcount_remove_many(&amp;old_state-&gt;arcs_size,</span>
<span class="lineNum">    2600 </span>                :<span class="lineCov">     273146 :                             HDR_GET_LSIZE(hdr), hdr);</span>
<span class="lineNum">    2601 </span>                :            :                 } else {
<span class="lineNum">    2602 </span>                :            :                         arc_buf_t *buf;
<span class="lineNum">    2603 </span>                :<span class="lineCov">    1523558 :                         uint32_t buffers = 0;</span>
<span class="lineNum">    2604 </span>                :            : 
<span class="lineNum">    2605 </span>                :            :                         /*
<span class="lineNum">    2606 </span>                :            :                          * Each individual buffer holds a unique reference,
<span class="lineNum">    2607 </span>                :            :                          * thus we must remove each of these references one
<span class="lineNum">    2608 </span>                :            :                          * at a time.
<span class="lineNum">    2609 </span>                :            :                          */
<span class="lineNum">    2610 </span>        [<span class="branchCov" title="Branch 0 was taken 1260962 times"> + </span><span class="branchCov" title="Branch 1 was taken 1523554 times"> + </span>]:<span class="lineCov">    2784516 :                         for (buf = hdr-&gt;b_l1hdr.b_buf; buf != NULL;</span>
<span class="lineNum">    2611 </span>                :<span class="lineCov">    1260958 :                             buf = buf-&gt;b_next) {</span>
<span class="lineNum">    2612 </span>        [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 1260960 times"> + </span>]:<span class="lineCov">    1260962 :                                 ASSERT3U(bufcnt, !=, 0);</span>
<span class="lineNum">    2613 </span>                :<span class="lineCov">    1260960 :                                 buffers++;</span>
<span class="lineNum">    2614 </span>                :            : 
<span class="lineNum">    2615 </span>                :            :                                 /*
<span class="lineNum">    2616 </span>                :            :                                  * When the arc_buf_t is sharing the data
<span class="lineNum">    2617 </span>                :            :                                  * block with the hdr, the owner of the
<span class="lineNum">    2618 </span>                :            :                                  * reference belongs to the hdr. Only
<span class="lineNum">    2619 </span>                :            :                                  * add to the refcount if the arc_buf_t is
<span class="lineNum">    2620 </span>                :            :                                  * not shared.
<span class="lineNum">    2621 </span>                :            :                                  */
<span class="lineNum">    2622 </span>        [<span class="branchCov" title="Branch 1 was taken 329440 times"> + </span><span class="branchCov" title="Branch 2 was taken 931511 times"> + </span>]:<span class="lineCov">    1260960 :                                 if (arc_buf_is_shared(buf))</span>
<span class="lineNum">    2623 </span>                :<span class="lineCov">     329440 :                                         continue;</span>
<span class="lineNum">    2624 </span>                :            : 
<span class="lineNum">    2625 </span>                :<span class="lineCov">     931511 :                                 (void) refcount_remove_many(</span>
<span class="lineNum">    2626 </span>                :            :                                     &amp;old_state-&gt;arcs_size, arc_buf_size(buf),
<span class="lineNum">    2627 </span>                :            :                                     buf);
<span class="lineNum">    2628 </span>                :            :                         }
<span class="lineNum">    2629 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1523554 times"> + </span>]:<span class="lineCov">    1523554 :                         ASSERT3U(bufcnt, ==, buffers);</span>
<span class="lineNum">    2630 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1523554 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1523554 :                         ASSERT(hdr-&gt;b_l1hdr.b_pabd != NULL ||</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    2631 </span>                :            :                             HDR_HAS_RABD(hdr));
<span class="lineNum">    2632 </span>                :            : 
<span class="lineNum">    2633 </span>           [<span class="branchCov" title="Branch 0 was taken 1523555 times"> + </span>]:<span class="lineCov">    1523554 :                         if (hdr-&gt;b_l1hdr.b_pabd != NULL) {</span>
<span class="lineNum">    2634 </span>                :<span class="lineCov">    1523555 :                                 (void) refcount_remove_many(</span>
<span class="lineNum">    2635 </span>                :            :                                     &amp;old_state-&gt;arcs_size, arc_hdr_size(hdr),
<span class="lineNum">    2636 </span>                :            :                                     hdr);
<span class="lineNum">    2637 </span>                :            :                         }
<span class="lineNum">    2638 </span>                :            : 
<span class="lineNum">    2639 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1523553 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1523553 :                         if (HDR_HAS_RABD(hdr)) {</span>
<span class="lineNum">    2640 </span>                :<span class="lineNoCov">          0 :                                 (void) refcount_remove_many(</span>
<span class="lineNum">    2641 </span>                :<span class="lineNoCov">          0 :                                     &amp;old_state-&gt;arcs_size, HDR_GET_PSIZE(hdr),</span>
<span class="lineNum">    2642 </span>                :            :                                     hdr);
<span class="lineNum">    2643 </span>                :            :                         }
<span class="lineNum">    2644 </span>                :            :                 }
<span class="lineNum">    2645 </span>                :            :         }
<span class="lineNum">    2646 </span>                :            : 
<span class="lineNum">    2647 </span>        [<span class="branchCov" title="Branch 0 was taken 2069846 times"> + </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>]:<span class="lineCov">    2072590 :         if (HDR_HAS_L1HDR(hdr))</span>
<span class="lineNum">    2648 </span>                :<span class="lineCov">    2069846 :                 hdr-&gt;b_l1hdr.b_state = new_state;</span>
<span class="lineNum">    2649 </span>                :            : 
<span class="lineNum">    2650 </span>                :            :         /*
<span class="lineNum">    2651 </span>                :            :          * L2 headers should never be on the L2 state list since they don't
<span class="lineNum">    2652 </span>                :            :          * have L1 headers allocated.
<span class="lineNum">    2653 </span>                :            :          */
<span class="lineNum">    2654 </span>[<span class="branchCov" title="Branch 1 was taken 2072603 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>][<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 2072602 times"> + </span>]:<span class="lineCov">    2072590 :         ASSERT(multilist_is_empty(arc_l2c_only-&gt;arcs_list[ARC_BUFC_DATA]) &amp;&amp;</span>
<span class="lineNum">    2655 </span>                :            :             multilist_is_empty(arc_l2c_only-&gt;arcs_list[ARC_BUFC_METADATA]));
<span class="lineNum">    2656 </span>                :<span class="lineCov">    2072602 : }</span>
<a name="2657"><span class="lineNum">    2657 </span>                :            : </a>
<span class="lineNum">    2658 </span>                :            : void
<span class="lineNum">    2659 </span>                :<span class="lineCov">  505110041 : arc_space_consume(uint64_t space, arc_space_type_t type)</span>
<span class="lineNum">    2660 </span>                :            : {
<span class="lineNum">    2661 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 505110041 times"> + </span>]:<span class="lineCov">  505110041 :         ASSERT(type &gt;= 0 &amp;&amp; type &lt; ARC_SPACE_NUMTYPES);</span>
<span class="lineNum">    2662 </span>                :            : 
<span class="lineNum">    2663 </span>  [<span class="branchCov" title="Branch 0 was taken 156035 times"> + </span><span class="branchCov" title="Branch 1 was taken 2274623 times"> + </span><span class="branchCov" title="Branch 2 was taken 208708 times"> + </span><span class="branchCov" title="Branch 3 was taken 280373 times"> + </span> :<span class="lineCov">  505110041 :         switch (type) {</span>
<span class="lineNum">         </span>      <span class="branchCov" title="Branch 4 was taken 1497829 times"> + </span><span class="branchCov" title="Branch 5 was taken 500694131 times"> + </span><span class="branchCov" title="Branch 6 was taken 3134 times"> + </span>]
<span class="lineNum">    2664 </span>                :            :         default:
<span class="lineNum">    2665 </span>                :            :                 break;
<span class="lineNum">    2666 </span>                :            :         case ARC_SPACE_DATA:
<span class="lineNum">    2667 </span>                :<span class="lineCov">     156035 :                 ARCSTAT_INCR(arcstat_data_size, space);</span>
<span class="lineNum">    2668 </span>                :<span class="lineCov">     156063 :                 break;</span>
<span class="lineNum">    2669 </span>                :            :         case ARC_SPACE_META:
<span class="lineNum">    2670 </span>                :<span class="lineCov">    2274623 :                 ARCSTAT_INCR(arcstat_metadata_size, space);</span>
<span class="lineNum">    2671 </span>                :<span class="lineCov">    2275442 :                 break;</span>
<span class="lineNum">    2672 </span>                :            :         case ARC_SPACE_BONUS:
<span class="lineNum">    2673 </span>                :<span class="lineCov">     208708 :                 ARCSTAT_INCR(arcstat_bonus_size, space);</span>
<span class="lineNum">    2674 </span>                :<span class="lineCov">     208717 :                 break;</span>
<span class="lineNum">    2675 </span>                :            :         case ARC_SPACE_DNODE:
<span class="lineNum">    2676 </span>                :<span class="lineCov">     280373 :                 ARCSTAT_INCR(arcstat_dnode_size, space);</span>
<span class="lineNum">    2677 </span>                :<span class="lineCov">     280374 :                 break;</span>
<span class="lineNum">    2678 </span>                :            :         case ARC_SPACE_DBUF:
<span class="lineNum">    2679 </span>                :<span class="lineCov">    1497829 :                 ARCSTAT_INCR(arcstat_dbuf_size, space);</span>
<span class="lineNum">    2680 </span>                :<span class="lineCov">    1498564 :                 break;</span>
<span class="lineNum">    2681 </span>                :            :         case ARC_SPACE_HDRS:
<span class="lineNum">    2682 </span>                :<span class="lineCov">  500694131 :                 ARCSTAT_INCR(arcstat_hdr_size, space);</span>
<span class="lineNum">    2683 </span>                :<span class="lineCov">  500697677 :                 break;</span>
<span class="lineNum">    2684 </span>                :            :         case ARC_SPACE_L2HDRS:
<span class="lineNum">    2685 </span>                :<span class="lineCov">       3134 :                 ARCSTAT_INCR(arcstat_l2_hdr_size, space);</span>
<span class="lineNum">    2686 </span>                :<span class="lineCov">       3134 :                 break;</span>
<span class="lineNum">    2687 </span>                :            :         }
<span class="lineNum">    2688 </span>                :            : 
<span class="lineNum">    2689 </span>        [<span class="branchCov" title="Branch 0 was taken 504963276 times"> + </span><span class="branchCov" title="Branch 1 was taken 151903 times"> + </span>]:<span class="lineCov">  505115179 :         if (type != ARC_SPACE_DATA)</span>
<span class="lineNum">    2690 </span>                :<span class="lineCov">  504963276 :                 ARCSTAT_INCR(arcstat_meta_used, space);</span>
<span class="lineNum">    2691 </span>                :            : 
<span class="lineNum">    2692 </span>                :<span class="lineCov">  505115236 :         atomic_add_64(&amp;arc_size, space);</span>
<span class="lineNum">    2693 </span>                :<span class="lineCov">  505118896 : }</span>
<a name="2694"><span class="lineNum">    2694 </span>                :            : </a>
<span class="lineNum">    2695 </span>                :            : void
<span class="lineNum">    2696 </span>                :<span class="lineCov">  505114117 : arc_space_return(uint64_t space, arc_space_type_t type)</span>
<span class="lineNum">    2697 </span>                :            : {
<span class="lineNum">    2698 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 505114117 times"> + </span>]:<span class="lineCov">  505114117 :         ASSERT(type &gt;= 0 &amp;&amp; type &lt; ARC_SPACE_NUMTYPES);</span>
<span class="lineNum">    2699 </span>                :            : 
<span class="lineNum">    2700 </span>  [<span class="branchCov" title="Branch 0 was taken 156037 times"> + </span><span class="branchCov" title="Branch 1 was taken 2275346 times"> + </span><span class="branchCov" title="Branch 2 was taken 208652 times"> + </span><span class="branchCov" title="Branch 3 was taken 280229 times"> + </span> :<span class="lineCov">  505114117 :         switch (type) {</span>
<span class="lineNum">         </span>      <span class="branchCov" title="Branch 4 was taken 1498221 times"> + </span><span class="branchCov" title="Branch 5 was taken 500696258 times"> + </span><span class="branchCov" title="Branch 6 was taken 3134 times"> + </span>]
<span class="lineNum">    2701 </span>                :            :         default:
<span class="lineNum">    2702 </span>                :            :                 break;
<span class="lineNum">    2703 </span>                :            :         case ARC_SPACE_DATA:
<span class="lineNum">    2704 </span>                :<span class="lineCov">     156037 :                 ARCSTAT_INCR(arcstat_data_size, -space);</span>
<span class="lineNum">    2705 </span>                :<span class="lineCov">     156064 :                 break;</span>
<span class="lineNum">    2706 </span>                :            :         case ARC_SPACE_META:
<span class="lineNum">    2707 </span>                :<span class="lineCov">    2275346 :                 ARCSTAT_INCR(arcstat_metadata_size, -space);</span>
<span class="lineNum">    2708 </span>                :<span class="lineCov">    2275396 :                 break;</span>
<span class="lineNum">    2709 </span>                :            :         case ARC_SPACE_BONUS:
<span class="lineNum">    2710 </span>                :<span class="lineCov">     208652 :                 ARCSTAT_INCR(arcstat_bonus_size, -space);</span>
<span class="lineNum">    2711 </span>                :<span class="lineCov">     208652 :                 break;</span>
<span class="lineNum">    2712 </span>                :            :         case ARC_SPACE_DNODE:
<span class="lineNum">    2713 </span>                :<span class="lineCov">     280229 :                 ARCSTAT_INCR(arcstat_dnode_size, -space);</span>
<span class="lineNum">    2714 </span>                :<span class="lineCov">     280229 :                 break;</span>
<span class="lineNum">    2715 </span>                :            :         case ARC_SPACE_DBUF:
<span class="lineNum">    2716 </span>                :<span class="lineCov">    1498221 :                 ARCSTAT_INCR(arcstat_dbuf_size, -space);</span>
<span class="lineNum">    2717 </span>                :<span class="lineCov">    1498437 :                 break;</span>
<span class="lineNum">    2718 </span>                :            :         case ARC_SPACE_HDRS:
<span class="lineNum">    2719 </span>                :<span class="lineCov">  500696258 :                 ARCSTAT_INCR(arcstat_hdr_size, -space);</span>
<span class="lineNum">    2720 </span>                :<span class="lineCov">  500697445 :                 break;</span>
<span class="lineNum">    2721 </span>                :            :         case ARC_SPACE_L2HDRS:
<span class="lineNum">    2722 </span>                :<span class="lineCov">       3134 :                 ARCSTAT_INCR(arcstat_l2_hdr_size, -space);</span>
<span class="lineNum">    2723 </span>                :<span class="lineCov">       3134 :                 break;</span>
<span class="lineNum">    2724 </span>                :            :         }
<span class="lineNum">    2725 </span>                :            : 
<span class="lineNum">    2726 </span>        [<span class="branchCov" title="Branch 0 was taken 504962792 times"> + </span><span class="branchCov" title="Branch 1 was taken 152805 times"> + </span>]:<span class="lineCov">  505115597 :         if (type != ARC_SPACE_DATA) {</span>
<span class="lineNum">    2727 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 504962792 times"> + </span>]:<span class="lineCov">  504962792 :                 ASSERT(arc_meta_used &gt;= space);</span>
<span class="lineNum">    2728 </span>        [<span class="branchCov" title="Branch 0 was taken 69907 times"> + </span><span class="branchCov" title="Branch 1 was taken 504892885 times"> + </span>]:<span class="lineCov">  504962792 :                 if (arc_meta_max &lt; arc_meta_used)</span>
<span class="lineNum">    2729 </span>                :<span class="lineCov">      69907 :                         arc_meta_max = arc_meta_used;</span>
<span class="lineNum">    2730 </span>                :<span class="lineCov">  504962792 :                 ARCSTAT_INCR(arcstat_meta_used, -space);</span>
<span class="lineNum">    2731 </span>                :            :         }
<span class="lineNum">    2732 </span>                :            : 
<span class="lineNum">    2733 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 505118836 times"> + </span>]:<span class="lineCov">  505118836 :         ASSERT(arc_size &gt;= space);</span>
<span class="lineNum">    2734 </span>                :<span class="lineCov">  505118836 :         atomic_add_64(&amp;arc_size, -space);</span>
<span class="lineNum">    2735 </span>                :<span class="lineCov">  505118141 : }</span>
<span class="lineNum">    2736 </span>                :            : 
<span class="lineNum">    2737 </span>                :            : /*
<span class="lineNum">    2738 </span>                :            :  * Given a hdr and a buf, returns whether that buf can share its b_data buffer
<span class="lineNum">    2739 </span>                :            :  * with the hdr's b_pabd.
<a name="2740"><span class="lineNum">    2740 </span>                :            :  */</a>
<span class="lineNum">    2741 </span>                :            : static boolean_t
<span class="lineNum">    2742 </span>                :<span class="lineCov">    2200892 : arc_can_share(arc_buf_hdr_t *hdr, arc_buf_t *buf)</span>
<span class="lineNum">    2743 </span>                :            : {
<span class="lineNum">    2744 </span>                :            :         /*
<span class="lineNum">    2745 </span>                :            :          * The criteria for sharing a hdr's data are:
<span class="lineNum">    2746 </span>                :            :          * 1. the buffer is not encrypted
<span class="lineNum">    2747 </span>                :            :          * 2. the hdr's compression matches the buf's compression
<span class="lineNum">    2748 </span>                :            :          * 3. the hdr doesn't need to be byteswapped
<span class="lineNum">    2749 </span>                :            :          * 4. the hdr isn't already being shared
<span class="lineNum">    2750 </span>                :            :          * 5. the buf is either compressed or it is the last buf in the hdr list
<span class="lineNum">    2751 </span>                :            :          *
<span class="lineNum">    2752 </span>                :            :          * Criterion #5 maintains the invariant that shared uncompressed
<span class="lineNum">    2753 </span>                :            :          * bufs must be the final buf in the hdr's b_buf list. Reading this, you
<span class="lineNum">    2754 </span>                :            :          * might ask, &quot;if a compressed buf is allocated first, won't that be the
<span class="lineNum">    2755 </span>                :            :          * last thing in the list?&quot;, but in that case it's impossible to create
<span class="lineNum">    2756 </span>                :            :          * a shared uncompressed buf anyway (because the hdr must be compressed
<span class="lineNum">    2757 </span>                :            :          * to have the compressed buf). You might also think that #3 is
<span class="lineNum">    2758 </span>                :            :          * sufficient to make this guarantee, however it's possible
<span class="lineNum">    2759 </span>                :            :          * (specifically in the rare L2ARC write race mentioned in
<span class="lineNum">    2760 </span>                :            :          * arc_buf_alloc_impl()) there will be an existing uncompressed buf that
<span class="lineNum">    2761 </span>                :            :          * is sharable, but wasn't at the time of its allocation. Rather than
<span class="lineNum">    2762 </span>                :            :          * allow a new shared uncompressed buf to be created and then shuffle
<span class="lineNum">    2763 </span>                :            :          * the list around to make it the last element, this simply disallows
<span class="lineNum">    2764 </span>                :            :          * sharing if the new buf isn't the first to be added.
<span class="lineNum">    2765 </span>                :            :          */
<span class="lineNum">    2766 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2200892 times"> + </span>]:<span class="lineCov">    2200892 :         ASSERT3P(buf-&gt;b_hdr, ==, hdr);</span>
<span class="lineNum">    2767 </span>                :<span class="lineCov">    2200680 :         boolean_t hdr_compressed =</span>
<span class="lineNum">    2768 </span>                :<span class="lineCov">    2200892 :             arc_hdr_get_compress(hdr) != ZIO_COMPRESS_OFF;</span>
<span class="lineNum">    2769 </span>                :<span class="lineCov">    2200680 :         boolean_t buf_compressed = ARC_BUF_COMPRESSED(buf) != 0;</span>
<span class="lineNum">    2770 </span>        [<span class="branchCov" title="Branch 0 was taken 1754167 times"> + </span><span class="branchCov" title="Branch 1 was taken 446617 times"> + </span>]:<span class="lineCov">    2200784 :         return (!ARC_BUF_ENCRYPTED(buf) &amp;&amp;</span>
<span class="lineNum">    2771 </span>           [<span class="branchCov" title="Branch 0 was taken 1754392 times"> + </span>]:<span class="lineCov">    1754167 :             buf_compressed == hdr_compressed &amp;&amp;</span>
<span class="lineNum">    2772 </span>        [<span class="branchCov" title="Branch 0 was taken 1742443 times"> + </span><span class="branchCov" title="Branch 1 was taken 11949 times"> + </span>]:<span class="lineCov">    1754392 :             hdr-&gt;b_l1hdr.b_byteswap == DMU_BSWAP_NUMFUNCS &amp;&amp;</span>
<span class="lineNum">    2773 </span>   [<span class="branchCov" title="Branch 0 was taken 2200784 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1802 times"> + </span><span class="branchCov" title="Branch 3 was taken 1740641 times"> + </span>]:<span class="lineCov">    3943123 :             !HDR_SHARED_DATA(hdr) &amp;&amp;</span>
<span class="lineNum">    2774 </span>           [<span class="branchCov" title="Branch 0 was taken 2643 times"> + </span>]:<span class="lineCov">     460039 :             (ARC_BUF_LAST(buf) || ARC_BUF_COMPRESSED(buf)));</span>
<span class="lineNum">    2775 </span>                :            : }
<span class="lineNum">    2776 </span>                :            : 
<span class="lineNum">    2777 </span>                :            : /*
<span class="lineNum">    2778 </span>                :            :  * Allocate a buf for this hdr. If you care about the data that's in the hdr,
<span class="lineNum">    2779 </span>                :            :  * or if you want a compressed buffer, pass those flags in. Returns 0 if the
<span class="lineNum">    2780 </span>                :            :  * copy was made successfully, or an error code otherwise.
<a name="2781"><span class="lineNum">    2781 </span>                :            :  */</a>
<span class="lineNum">    2782 </span>                :            : static int
<span class="lineNum">    2783 </span>                :<span class="lineCov">    1636932 : arc_buf_alloc_impl(arc_buf_hdr_t *hdr, spa_t *spa, uint64_t dsobj, void *tag,</span>
<span class="lineNum">    2784 </span>                :            :     boolean_t encrypted, boolean_t compressed, boolean_t noauth,
<span class="lineNum">    2785 </span>                :            :     boolean_t fill, arc_buf_t **ret)
<span class="lineNum">    2786 </span>                :            : {
<span class="lineNum">    2787 </span>                :            :         arc_buf_t *buf;
<span class="lineNum">    2788 </span>                :<span class="lineCov">    1636932 :         arc_fill_flags_t flags = ARC_FILL_LOCKED;</span>
<span class="lineNum">    2789 </span>                :            : 
<span class="lineNum">    2790 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1636932 times"> + </span>]:<span class="lineCov">    1636932 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    2791 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1636932 times"> + </span>]:<span class="lineCov">    1636932 :         ASSERT3U(HDR_GET_LSIZE(hdr), &gt;, 0);</span>
<span class="lineNum">    2792 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1636932 times"> + </span>]:<span class="lineCov">    1636932 :         VERIFY(hdr-&gt;b_type == ARC_BUFC_DATA ||</span>
<span class="lineNum">    2793 </span>                :            :             hdr-&gt;b_type == ARC_BUFC_METADATA);
<span class="lineNum">    2794 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1636932 times"> + </span>]:<span class="lineCov">    1636932 :         ASSERT3P(ret, !=, NULL);</span>
<span class="lineNum">    2795 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1636932 times"> + </span>]:<span class="lineCov">    1636932 :         ASSERT3P(*ret, ==, NULL);</span>
<span class="lineNum">    2796 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1636932 times"> + </span>]:<span class="lineCov">    1636932 :         IMPLY(encrypted, compressed);</span>
<span class="lineNum">    2797 </span>                :            : 
<span class="lineNum">    2798 </span>                :<span class="lineCov">    1636932 :         hdr-&gt;b_l1hdr.b_mru_hits = 0;</span>
<span class="lineNum">    2799 </span>                :<span class="lineCov">    1636932 :         hdr-&gt;b_l1hdr.b_mru_ghost_hits = 0;</span>
<span class="lineNum">    2800 </span>                :<span class="lineCov">    1636932 :         hdr-&gt;b_l1hdr.b_mfu_hits = 0;</span>
<span class="lineNum">    2801 </span>                :<span class="lineCov">    1636932 :         hdr-&gt;b_l1hdr.b_mfu_ghost_hits = 0;</span>
<span class="lineNum">    2802 </span>                :<span class="lineCov">    1636932 :         hdr-&gt;b_l1hdr.b_l2_hits = 0;</span>
<span class="lineNum">    2803 </span>                :            : 
<span class="lineNum">    2804 </span>                :<span class="lineCov">    1636932 :         buf = *ret = kmem_cache_alloc(buf_cache, KM_PUSHPAGE);</span>
<span class="lineNum">    2805 </span>                :<span class="lineCov">    1638719 :         buf-&gt;b_hdr = hdr;</span>
<span class="lineNum">    2806 </span>                :<span class="lineCov">    1638719 :         buf-&gt;b_data = NULL;</span>
<span class="lineNum">    2807 </span>                :<span class="lineCov">    1638719 :         buf-&gt;b_next = hdr-&gt;b_l1hdr.b_buf;</span>
<span class="lineNum">    2808 </span>                :<span class="lineCov">    1638719 :         buf-&gt;b_flags = 0;</span>
<span class="lineNum">    2809 </span>                :            : 
<span class="lineNum">    2810 </span>                :<span class="lineCov">    1638719 :         add_reference(hdr, tag);</span>
<span class="lineNum">    2811 </span>                :            : 
<span class="lineNum">    2812 </span>                :            :         /*
<span class="lineNum">    2813 </span>                :            :          * We're about to change the hdr's b_flags. We must either
<span class="lineNum">    2814 </span>                :            :          * hold the hash_lock or be undiscoverable.
<span class="lineNum">    2815 </span>                :            :          */
<span class="lineNum">    2816 </span>   [<span class="branchCov" title="Branch 3 was taken 1252831 times"> + </span><span class="branchCov" title="Branch 4 was taken 385913 times"> + </span>][<span class="branchCov" title="Branch 5 was taken 1253013 times"> + </span>]:<span class="lineCov">    1638749 :         ASSERT(MUTEX_HELD(HDR_LOCK(hdr)) || HDR_EMPTY(hdr));</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 7 was taken 321 times"> + </span><span class="branchCov" title="Branch 8 was taken 1252692 times"> + </span>]
<span class="lineNum">    2817 </span>                :            : 
<span class="lineNum">    2818 </span>                :            :         /*
<span class="lineNum">    2819 </span>                :            :          * Only honor requests for compressed bufs if the hdr is actually
<span class="lineNum">    2820 </span>                :            :          * compressed. This must be overriden if the buffer is encrypted since
<span class="lineNum">    2821 </span>                :            :          * encrypted buffers cannot be decompressed.
<span class="lineNum">    2822 </span>                :            :          */
<span class="lineNum">    2823 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1638605 times"> + </span>]:<span class="lineCov">    1638605 :         if (encrypted) {</span>
<span class="lineNum">    2824 </span>                :<span class="lineNoCov">          0 :                 buf-&gt;b_flags |= ARC_BUF_FLAG_COMPRESSED;</span>
<span class="lineNum">    2825 </span>                :<span class="lineNoCov">          0 :                 buf-&gt;b_flags |= ARC_BUF_FLAG_ENCRYPTED;</span>
<span class="lineNum">    2826 </span>                :<span class="lineNoCov">          0 :                 flags |= ARC_FILL_COMPRESSED | ARC_FILL_ENCRYPTED;</span>
<span class="lineNum">    2827 </span>  [<span class="branchCov" title="Branch 0 was taken 2632 times"> + </span><span class="branchCov" title="Branch 1 was taken 1635973 times"> + </span><span class="branchCov" title="Branch 2 was taken 26 times"> + </span><span class="branchCov" title="Branch 3 was taken 2606 times"> + </span>]:<span class="lineCov">    1641237 :         } else if (compressed &amp;&amp;</span>
<span class="lineNum">    2828 </span>                :<span class="lineCov">       2632 :             arc_hdr_get_compress(hdr) != ZIO_COMPRESS_OFF) {</span>
<span class="lineNum">    2829 </span>                :<span class="lineCov">         26 :                 buf-&gt;b_flags |= ARC_BUF_FLAG_COMPRESSED;</span>
<span class="lineNum">    2830 </span>                :<span class="lineCov">         26 :                 flags |= ARC_FILL_COMPRESSED;</span>
<span class="lineNum">    2831 </span>                :            :         }
<span class="lineNum">    2832 </span>                :            : 
<span class="lineNum">    2833 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1638605 times"> + </span>]:<span class="lineCov">    1638605 :         if (noauth) {</span>
<span class="lineNum">    2834 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT0(encrypted);</span>
<span class="lineNum">    2835 </span>                :<span class="lineNoCov">          0 :                 flags |= ARC_FILL_NOAUTH;</span>
<span class="lineNum">    2836 </span>                :            :         }
<span class="lineNum">    2837 </span>                :            : 
<span class="lineNum">    2838 </span>                :            :         /*
<span class="lineNum">    2839 </span>                :            :          * If the hdr's data can be shared then we share the data buffer and
<span class="lineNum">    2840 </span>                :            :          * set the appropriate bit in the hdr's b_flags to indicate the hdr is
<span class="lineNum">    2841 </span>                :            :          * allocate a new buffer to store the buf's data.
<span class="lineNum">    2842 </span>                :            :          *
<span class="lineNum">    2843 </span>                :            :          * There are two additional restrictions here because we're sharing
<span class="lineNum">    2844 </span>                :            :          * hdr -&gt; buf instead of the usual buf -&gt; hdr. First, the hdr can't be
<span class="lineNum">    2845 </span>                :            :          * actively involved in an L2ARC write, because if this buf is used by
<span class="lineNum">    2846 </span>                :            :          * an arc_write() then the hdr's data buffer will be released when the
<span class="lineNum">    2847 </span>                :            :          * write completes, even though the L2ARC write might still be using it.
<span class="lineNum">    2848 </span>                :            :          * Second, the hdr's ABD must be linear so that the buf's user doesn't
<span class="lineNum">    2849 </span>                :            :          * need to be ABD-aware.
<span class="lineNum">    2850 </span>                :            :          */
<span class="lineNum">    2851 </span>      [<span class="branchCov" title="Branch 1 was taken 1322530 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 1322575 times"> + </span>]:<span class="lineCov">    2961026 :         boolean_t can_share = arc_can_share(hdr, buf) &amp;&amp; !HDR_L2_WRITING(hdr) &amp;&amp;</span>
<span class="lineNum">    2852 </span>[<span class="branchCov" title="Branch 0 was taken 1322421 times"> + </span><span class="branchCov" title="Branch 1 was taken 316254 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 93340 times"> + </span><span class="branchCov" title="Branch 4 was taken 1228796 times"> + </span>]:<span class="lineCov">    2961250 :             hdr-&gt;b_l1hdr.b_pabd != NULL &amp;&amp; abd_is_linear(hdr-&gt;b_l1hdr.b_pabd);</span>
<span class="lineNum">    2853 </span>                :            : 
<span class="lineNum">    2854 </span>                :            :         /* Set up b_data and sharing */
<span class="lineNum">    2855 </span>        [<span class="branchCov" title="Branch 0 was taken 1228895 times"> + </span><span class="branchCov" title="Branch 1 was taken 409341 times"> + </span>]:<span class="lineCov">    1638236 :         if (can_share) {</span>
<span class="lineNum">    2856 </span>                :<span class="lineCov">    1228895 :                 buf-&gt;b_data = abd_to_buf(hdr-&gt;b_l1hdr.b_pabd);</span>
<span class="lineNum">    2857 </span>                :<span class="lineCov">    1228660 :                 buf-&gt;b_flags |= ARC_BUF_FLAG_SHARED;</span>
<span class="lineNum">    2858 </span>                :<span class="lineCov">    1228660 :                 arc_hdr_set_flags(hdr, ARC_FLAG_SHARED_DATA);</span>
<span class="lineNum">    2859 </span>                :            :         } else {
<span class="lineNum">    2860 </span>                :<span class="lineCov">     409344 :                 buf-&gt;b_data =</span>
<span class="lineNum">    2861 </span>                :<span class="lineCov">     409341 :                     arc_get_data_buf(hdr, arc_buf_size(buf), buf);</span>
<span class="lineNum">    2862 </span>                :<span class="lineCov">     409344 :                 ARCSTAT_INCR(arcstat_overhead_size, arc_buf_size(buf));</span>
<span class="lineNum">    2863 </span>                :            :         }
<span class="lineNum">    2864 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1638498 times"> + </span>]:<span class="lineCov">    1638498 :         VERIFY3P(buf-&gt;b_data, !=, NULL);</span>
<span class="lineNum">    2865 </span>                :            : 
<span class="lineNum">    2866 </span>                :<span class="lineCov">    1638498 :         hdr-&gt;b_l1hdr.b_buf = buf;</span>
<span class="lineNum">    2867 </span>                :<span class="lineCov">    1638498 :         hdr-&gt;b_l1hdr.b_bufcnt += 1;</span>
<span class="lineNum">    2868 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1638498 times"> + </span>]:<span class="lineCov">    1638498 :         if (encrypted)</span>
<span class="lineNum">    2869 </span>                :<span class="lineNoCov">          0 :                 hdr-&gt;b_crypt_hdr.b_ebufcnt += 1;</span>
<span class="lineNum">    2870 </span>                :            : 
<span class="lineNum">    2871 </span>                :            :         /*
<span class="lineNum">    2872 </span>                :            :          * If the user wants the data from the hdr, we need to either copy or
<span class="lineNum">    2873 </span>                :            :          * decompress the data.
<span class="lineNum">    2874 </span>                :            :          */
<span class="lineNum">    2875 </span>        [<span class="branchCov" title="Branch 0 was taken 1382093 times"> + </span><span class="branchCov" title="Branch 1 was taken 256405 times"> + </span>]:<span class="lineCov">    1638498 :         if (fill) {</span>
<span class="lineNum">    2876 </span>                :<span class="lineCov">    1382093 :                 return (arc_buf_fill(buf, spa, dsobj, flags));</span>
<span class="lineNum">    2877 </span>                :            :         }
<span class="lineNum">    2878 </span>                :            : 
<span class="lineNum">    2879 </span>                :            :         return (0);
<span class="lineNum">    2880 </span>                :            : }
<span class="lineNum">    2881 </span>                :            : 
<span class="lineNum">    2882 </span>                :            : static char *arc_onloan_tag = &quot;onloan&quot;;
<a name="2883"><span class="lineNum">    2883 </span>                :            : </a>
<span class="lineNum">    2884 </span>                :            : static inline void
<span class="lineNum">    2885 </span>                :<span class="lineCov">      11722 : arc_loaned_bytes_update(int64_t delta)</span>
<span class="lineNum">    2886 </span>                :            : {
<span class="lineNum">    2887 </span>                :<span class="lineCov">      11722 :         atomic_add_64(&amp;arc_loaned_bytes, delta);</span>
<span class="lineNum">    2888 </span>                :            : 
<span class="lineNum">    2889 </span>                :            :         /* assert that it did not wrap around */
<span class="lineNum">    2890 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 11722 times"> + </span>]:<span class="lineCov">      11722 :         ASSERT3S(atomic_add_64_nv(&amp;arc_loaned_bytes, 0), &gt;=, 0);</span>
<span class="lineNum">    2891 </span>                :<span class="lineCov">      11722 : }</span>
<span class="lineNum">    2892 </span>                :            : 
<span class="lineNum">    2893 </span>                :            : /*
<span class="lineNum">    2894 </span>                :            :  * Loan out an anonymous arc buffer. Loaned buffers are not counted as in
<span class="lineNum">    2895 </span>                :            :  * flight data by arc_tempreserve_space() until they are &quot;returned&quot;. Loaned
<span class="lineNum">    2896 </span>                :            :  * buffers must be returned to the arc before they can be used by the DMU or
<span class="lineNum">    2897 </span>                :            :  * freed.
<a name="2898"><span class="lineNum">    2898 </span>                :            :  */</a>
<span class="lineNum">    2899 </span>                :            : arc_buf_t *
<span class="lineNum">    2900 </span>                :<span class="lineCov">       5861 : arc_loan_buf(spa_t *spa, boolean_t is_metadata, int size)</span>
<span class="lineNum">    2901 </span>                :            : {
<span class="lineNum">    2902 </span>        [<span class="branchCov" title="Branch 0 was taken 5861 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       5861 :         arc_buf_t *buf = arc_alloc_buf(spa, arc_onloan_tag,</span>
<span class="lineNum">    2903 </span>                :            :             is_metadata ? ARC_BUFC_METADATA : ARC_BUFC_DATA, size);
<span class="lineNum">    2904 </span>                :            : 
<span class="lineNum">    2905 </span>                :<span class="lineCov">       5861 :         arc_loaned_bytes_update(size);</span>
<span class="lineNum">    2906 </span>                :            : 
<span class="lineNum">    2907 </span>                :<span class="lineCov">       5861 :         return (buf);</span>
<span class="lineNum">    2908 </span>                :            : }
<a name="2909"><span class="lineNum">    2909 </span>                :            : </a>
<span class="lineNum">    2910 </span>                :            : arc_buf_t *
<span class="lineNum">    2911 </span>                :<span class="lineNoCov">          0 : arc_loan_compressed_buf(spa_t *spa, uint64_t psize, uint64_t lsize,</span>
<span class="lineNum">    2912 </span>                :            :     enum zio_compress compression_type)
<span class="lineNum">    2913 </span>                :            : {
<span class="lineNum">    2914 </span>                :<span class="lineNoCov">          0 :         arc_buf_t *buf = arc_alloc_compressed_buf(spa, arc_onloan_tag,</span>
<span class="lineNum">    2915 </span>                :            :             psize, lsize, compression_type);
<span class="lineNum">    2916 </span>                :            : 
<span class="lineNum">    2917 </span>                :<span class="lineNoCov">          0 :         arc_loaned_bytes_update(psize);</span>
<span class="lineNum">    2918 </span>                :            : 
<span class="lineNum">    2919 </span>                :<span class="lineNoCov">          0 :         return (buf);</span>
<span class="lineNum">    2920 </span>                :            : }
<a name="2921"><span class="lineNum">    2921 </span>                :            : </a>
<span class="lineNum">    2922 </span>                :            : arc_buf_t *
<span class="lineNum">    2923 </span>                :<span class="lineNoCov">          0 : arc_loan_raw_buf(spa_t *spa, uint64_t dsobj, boolean_t byteorder,</span>
<span class="lineNum">    2924 </span>                :            :     const uint8_t *salt, const uint8_t *iv, const uint8_t *mac,
<span class="lineNum">    2925 </span>                :            :     dmu_object_type_t ot, uint64_t psize, uint64_t lsize,
<span class="lineNum">    2926 </span>                :            :     enum zio_compress compression_type)
<span class="lineNum">    2927 </span>                :            : {
<span class="lineNum">    2928 </span>                :<span class="lineNoCov">          0 :         arc_buf_t *buf = arc_alloc_raw_buf(spa, arc_onloan_tag, dsobj,</span>
<span class="lineNum">    2929 </span>                :            :             byteorder, salt, iv, mac, ot, psize, lsize, compression_type);
<span class="lineNum">    2930 </span>                :            : 
<span class="lineNum">    2931 </span>                :<span class="lineNoCov">          0 :         atomic_add_64(&amp;arc_loaned_bytes, psize);</span>
<span class="lineNum">    2932 </span>                :<span class="lineNoCov">          0 :         return (buf);</span>
<span class="lineNum">    2933 </span>                :            : }
<span class="lineNum">    2934 </span>                :            : 
<span class="lineNum">    2935 </span>                :            : 
<span class="lineNum">    2936 </span>                :            : /*
<span class="lineNum">    2937 </span>                :            :  * Return a loaned arc buffer to the arc.
<a name="2938"><span class="lineNum">    2938 </span>                :            :  */</a>
<span class="lineNum">    2939 </span>                :            : void
<span class="lineNum">    2940 </span>                :<span class="lineCov">       5861 : arc_return_buf(arc_buf_t *buf, void *tag)</span>
<span class="lineNum">    2941 </span>                :            : {
<span class="lineNum">    2942 </span>                :<span class="lineCov">       5861 :         arc_buf_hdr_t *hdr = buf-&gt;b_hdr;</span>
<span class="lineNum">    2943 </span>                :            : 
<span class="lineNum">    2944 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5861 times"> + </span>]:<span class="lineCov">       5861 :         ASSERT3P(buf-&gt;b_data, !=, NULL);</span>
<span class="lineNum">    2945 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5861 times"> + </span>]:<span class="lineCov">       5861 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    2946 </span>                :<span class="lineCov">       5861 :         (void) refcount_add(&amp;hdr-&gt;b_l1hdr.b_refcnt, tag);</span>
<span class="lineNum">    2947 </span>                :<span class="lineCov">       5861 :         (void) refcount_remove(&amp;hdr-&gt;b_l1hdr.b_refcnt, arc_onloan_tag);</span>
<span class="lineNum">    2948 </span>                :            : 
<span class="lineNum">    2949 </span>                :<span class="lineCov">       5861 :         arc_loaned_bytes_update(-arc_buf_size(buf));</span>
<span class="lineNum">    2950 </span>                :<span class="lineCov">       5861 : }</span>
<span class="lineNum">    2951 </span>                :            : 
<a name="2952"><span class="lineNum">    2952 </span>                :            : /* Detach an arc_buf from a dbuf (tag) */</a>
<span class="lineNum">    2953 </span>                :            : void
<span class="lineNum">    2954 </span>                :<span class="lineNoCov">          0 : arc_loan_inuse_buf(arc_buf_t *buf, void *tag)</span>
<span class="lineNum">    2955 </span>                :            : {
<span class="lineNum">    2956 </span>                :<span class="lineNoCov">          0 :         arc_buf_hdr_t *hdr = buf-&gt;b_hdr;</span>
<span class="lineNum">    2957 </span>                :            : 
<span class="lineNum">    2958 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3P(buf-&gt;b_data, !=, NULL);</span>
<span class="lineNum">    2959 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    2960 </span>                :<span class="lineNoCov">          0 :         (void) refcount_add(&amp;hdr-&gt;b_l1hdr.b_refcnt, arc_onloan_tag);</span>
<span class="lineNum">    2961 </span>                :<span class="lineNoCov">          0 :         (void) refcount_remove(&amp;hdr-&gt;b_l1hdr.b_refcnt, tag);</span>
<span class="lineNum">    2962 </span>                :            : 
<span class="lineNum">    2963 </span>                :<span class="lineNoCov">          0 :         arc_loaned_bytes_update(arc_buf_size(buf));</span>
<span class="lineNum">    2964 </span>                :<span class="lineNoCov">          0 : }</span>
<a name="2965"><span class="lineNum">    2965 </span>                :            : </a>
<span class="lineNum">    2966 </span>                :            : static void
<span class="lineNum">    2967 </span>                :<span class="lineCov">        986 : l2arc_free_abd_on_write(abd_t *abd, size_t size, arc_buf_contents_t type)</span>
<span class="lineNum">    2968 </span>                :            : {
<span class="lineNum">    2969 </span>                :<span class="lineCov">        986 :         l2arc_data_free_t *df = kmem_alloc(sizeof (*df), KM_SLEEP);</span>
<span class="lineNum">    2970 </span>                :            : 
<span class="lineNum">    2971 </span>                :<span class="lineCov">        986 :         df-&gt;l2df_abd = abd;</span>
<span class="lineNum">    2972 </span>                :<span class="lineCov">        986 :         df-&gt;l2df_size = size;</span>
<span class="lineNum">    2973 </span>                :<span class="lineCov">        986 :         df-&gt;l2df_type = type;</span>
<span class="lineNum">    2974 </span>                :<span class="lineCov">        986 :         mutex_enter(&amp;l2arc_free_on_write_mtx);</span>
<span class="lineNum">    2975 </span>                :<span class="lineCov">        986 :         list_insert_head(l2arc_free_on_write, df);</span>
<span class="lineNum">    2976 </span>                :<span class="lineCov">        986 :         mutex_exit(&amp;l2arc_free_on_write_mtx);</span>
<span class="lineNum">    2977 </span>                :<span class="lineCov">        986 : }</span>
<a name="2978"><span class="lineNum">    2978 </span>                :            : </a>
<span class="lineNum">    2979 </span>                :            : static void
<span class="lineNum">    2980 </span>                :<span class="lineCov">          1 : arc_hdr_free_on_write(arc_buf_hdr_t *hdr, boolean_t free_rdata)</span>
<span class="lineNum">    2981 </span>                :            : {
<span class="lineNum">    2982 </span>                :<span class="lineCov">          1 :         arc_state_t *state = hdr-&gt;b_l1hdr.b_state;</span>
<span class="lineNum">    2983 </span>                :<span class="lineCov">          1 :         arc_buf_contents_t type = arc_buf_type(hdr);</span>
<span class="lineNum">    2984 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :         uint64_t size = (free_rdata) ? HDR_GET_PSIZE(hdr) : arc_hdr_size(hdr);</span>
<span class="lineNum">    2985 </span>                :            : 
<span class="lineNum">    2986 </span>                :            :         /* protected by hash lock, if in the hash table */
<span class="lineNum">    2987 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1 time"> + </span>]:<span class="lineCov">          1 :         if (multilist_link_active(&amp;hdr-&gt;b_l1hdr.b_arc_node)) {</span>
<span class="lineNum">    2988 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT(refcount_is_zero(&amp;hdr-&gt;b_l1hdr.b_refcnt));</span>
<span class="lineNum">    2989 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT(state != arc_anon &amp;&amp; state != arc_l2c_only);</span>
<span class="lineNum">    2990 </span>                :            : 
<span class="lineNum">    2991 </span>                :<span class="lineNoCov">          0 :                 (void) refcount_remove_many(&amp;state-&gt;arcs_esize[type],</span>
<span class="lineNum">    2992 </span>                :            :                     size, hdr);
<span class="lineNum">    2993 </span>                :            :         }
<span class="lineNum">    2994 </span>                :<span class="lineCov">          1 :         (void) refcount_remove_many(&amp;state-&gt;arcs_size, size, hdr);</span>
<span class="lineNum">    2995 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :         if (type == ARC_BUFC_METADATA) {</span>
<span class="lineNum">    2996 </span>                :<span class="lineNoCov">          0 :                 arc_space_return(size, ARC_SPACE_META);</span>
<span class="lineNum">    2997 </span>                :            :         } else {
<span class="lineNum">    2998 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 ASSERT(type == ARC_BUFC_DATA);</span>
<span class="lineNum">    2999 </span>                :<span class="lineCov">          1 :                 arc_space_return(size, ARC_SPACE_DATA);</span>
<span class="lineNum">    3000 </span>                :            :         }
<span class="lineNum">    3001 </span>                :            : 
<span class="lineNum">    3002 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :         if (free_rdata) {</span>
<span class="lineNum">    3003 </span>                :<span class="lineNoCov">          0 :                 l2arc_free_abd_on_write(hdr-&gt;b_crypt_hdr.b_rabd, size, type);</span>
<span class="lineNum">    3004 </span>                :            :         } else {
<span class="lineNum">    3005 </span>                :<span class="lineCov">          1 :                 l2arc_free_abd_on_write(hdr-&gt;b_l1hdr.b_pabd, size, type);</span>
<span class="lineNum">    3006 </span>                :            :         }
<span class="lineNum">    3007 </span>                :<span class="lineCov">          1 : }</span>
<span class="lineNum">    3008 </span>                :            : 
<span class="lineNum">    3009 </span>                :            : /*
<span class="lineNum">    3010 </span>                :            :  * Share the arc_buf_t's data with the hdr. Whenever we are sharing the
<span class="lineNum">    3011 </span>                :            :  * data buffer, we transfer the refcount ownership to the hdr and update
<span class="lineNum">    3012 </span>                :            :  * the appropriate kstats.
<a name="3013"><span class="lineNum">    3013 </span>                :            :  */</a>
<span class="lineNum">    3014 </span>                :            : static void
<span class="lineNum">    3015 </span>                :<span class="lineCov">     212683 : arc_share_buf(arc_buf_hdr_t *hdr, arc_buf_t *buf)</span>
<span class="lineNum">    3016 </span>                :            : {
<span class="lineNum">    3017 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 212700 times"> + </span>]:<span class="lineCov">     212683 :         ASSERT(arc_can_share(hdr, buf));</span>
<span class="lineNum">    3018 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 212700 times"> + </span>]:<span class="lineCov">     212700 :         ASSERT3P(hdr-&gt;b_l1hdr.b_pabd, ==, NULL);</span>
<span class="lineNum">    3019 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 212700 times"> + </span>]:<span class="lineCov">     212700 :         ASSERT(!ARC_BUF_ENCRYPTED(buf));</span>
<span class="lineNum">    3020 </span>   [<span class="branchCov" title="Branch 3 was taken 205623 times"> + </span><span class="branchCov" title="Branch 4 was taken 7109 times"> + </span>][<span class="branchCov" title="Branch 5 was taken 205630 times"> + </span>]:<span class="lineCov">     212700 :         ASSERT(MUTEX_HELD(HDR_LOCK(hdr)) || HDR_EMPTY(hdr));</span>
<span class="lineNum">         </span>           [<span class="branchCov" title="Branch 8 was taken 205640 times"> + </span>]
<span class="lineNum">    3021 </span>                :            : 
<span class="lineNum">    3022 </span>                :            :         /*
<span class="lineNum">    3023 </span>                :            :          * Start sharing the data buffer. We transfer the
<span class="lineNum">    3024 </span>                :            :          * refcount ownership to the hdr since it always owns
<span class="lineNum">    3025 </span>                :            :          * the refcount whenever an arc_buf_t is shared.
<span class="lineNum">    3026 </span>                :            :          */
<span class="lineNum">    3027 </span>                :<span class="lineCov">     212749 :         refcount_transfer_ownership(&amp;hdr-&gt;b_l1hdr.b_state-&gt;arcs_size, buf, hdr);</span>
<span class="lineNum">    3028 </span>                :<span class="lineCov">     212787 :         hdr-&gt;b_l1hdr.b_pabd = abd_get_from_buf(buf-&gt;b_data, arc_buf_size(buf));</span>
<span class="lineNum">    3029 </span>                :<span class="lineCov">     212742 :         abd_take_ownership_of_buf(hdr-&gt;b_l1hdr.b_pabd,</span>
<span class="lineNum">    3030 </span>                :<span class="lineCov">     212742 :             HDR_ISTYPE_METADATA(hdr));</span>
<span class="lineNum">    3031 </span>                :<span class="lineCov">     212781 :         arc_hdr_set_flags(hdr, ARC_FLAG_SHARED_DATA);</span>
<span class="lineNum">    3032 </span>                :<span class="lineCov">     212772 :         buf-&gt;b_flags |= ARC_BUF_FLAG_SHARED;</span>
<span class="lineNum">    3033 </span>                :            : 
<span class="lineNum">    3034 </span>                :            :         /*
<span class="lineNum">    3035 </span>                :            :          * Since we've transferred ownership to the hdr we need
<span class="lineNum">    3036 </span>                :            :          * to increment its compressed and uncompressed kstats and
<span class="lineNum">    3037 </span>                :            :          * decrement the overhead size.
<span class="lineNum">    3038 </span>                :            :          */
<span class="lineNum">    3039 </span>                :<span class="lineCov">     212772 :         ARCSTAT_INCR(arcstat_compressed_size, arc_hdr_size(hdr));</span>
<span class="lineNum">    3040 </span>                :<span class="lineCov">     212792 :         ARCSTAT_INCR(arcstat_uncompressed_size, HDR_GET_LSIZE(hdr));</span>
<span class="lineNum">    3041 </span>                :<span class="lineCov">     212787 :         ARCSTAT_INCR(arcstat_overhead_size, -arc_buf_size(buf));</span>
<span class="lineNum">    3042 </span>                :<span class="lineCov">     212785 : }</span>
<a name="3043"><span class="lineNum">    3043 </span>                :            : </a>
<span class="lineNum">    3044 </span>                :            : static void
<span class="lineNum">    3045 </span>                :<span class="lineCov">     260048 : arc_unshare_buf(arc_buf_hdr_t *hdr, arc_buf_t *buf)</span>
<span class="lineNum">    3046 </span>                :            : {
<span class="lineNum">    3047 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 260049 times"> + </span>]:<span class="lineCov">     260048 :         ASSERT(arc_buf_is_shared(buf));</span>
<span class="lineNum">    3048 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 260049 times"> + </span>]:<span class="lineCov">     260049 :         ASSERT3P(hdr-&gt;b_l1hdr.b_pabd, !=, NULL);</span>
<span class="lineNum">    3049 </span>[<span class="branchCov" title="Branch 3 was taken 260056 times"> + </span><span class="branchCov" title="Branch 4 was taken 2 times"> + </span>][<span class="branchCov" title="Branch 5 was taken 260043 times"> + </span><span class="branchCov" title="Branch 6 was taken 13 times"> + </span>]:<span class="lineCov">     260049 :         ASSERT(MUTEX_HELD(HDR_LOCK(hdr)) || HDR_EMPTY(hdr));</span>
<span class="lineNum">         </span>           [<span class="branchCov" title="Branch 8 was taken 260045 times"> + </span>]
<span class="lineNum">    3050 </span>                :            : 
<span class="lineNum">    3051 </span>                :            :         /*
<span class="lineNum">    3052 </span>                :            :          * We are no longer sharing this buffer so we need
<span class="lineNum">    3053 </span>                :            :          * to transfer its ownership to the rightful owner.
<span class="lineNum">    3054 </span>                :            :          */
<span class="lineNum">    3055 </span>                :<span class="lineCov">     260047 :         refcount_transfer_ownership(&amp;hdr-&gt;b_l1hdr.b_state-&gt;arcs_size, hdr, buf);</span>
<span class="lineNum">    3056 </span>                :<span class="lineCov">     260101 :         arc_hdr_clear_flags(hdr, ARC_FLAG_SHARED_DATA);</span>
<span class="lineNum">    3057 </span>                :<span class="lineCov">     260100 :         abd_release_ownership_of_buf(hdr-&gt;b_l1hdr.b_pabd);</span>
<span class="lineNum">    3058 </span>                :<span class="lineCov">     260102 :         abd_put(hdr-&gt;b_l1hdr.b_pabd);</span>
<span class="lineNum">    3059 </span>                :<span class="lineCov">     260099 :         hdr-&gt;b_l1hdr.b_pabd = NULL;</span>
<span class="lineNum">    3060 </span>                :<span class="lineCov">     260099 :         buf-&gt;b_flags &amp;= ~ARC_BUF_FLAG_SHARED;</span>
<span class="lineNum">    3061 </span>                :            : 
<span class="lineNum">    3062 </span>                :            :         /*
<span class="lineNum">    3063 </span>                :            :          * Since the buffer is no longer shared between
<span class="lineNum">    3064 </span>                :            :          * the arc buf and the hdr, count it as overhead.
<span class="lineNum">    3065 </span>                :            :          */
<span class="lineNum">    3066 </span>                :<span class="lineCov">     260099 :         ARCSTAT_INCR(arcstat_compressed_size, -arc_hdr_size(hdr));</span>
<span class="lineNum">    3067 </span>                :<span class="lineCov">     260097 :         ARCSTAT_INCR(arcstat_uncompressed_size, -HDR_GET_LSIZE(hdr));</span>
<span class="lineNum">    3068 </span>                :<span class="lineCov">     260102 :         ARCSTAT_INCR(arcstat_overhead_size, arc_buf_size(buf));</span>
<span class="lineNum">    3069 </span>                :<span class="lineCov">     260095 : }</span>
<span class="lineNum">    3070 </span>                :            : 
<span class="lineNum">    3071 </span>                :            : /*
<span class="lineNum">    3072 </span>                :            :  * Remove an arc_buf_t from the hdr's buf list and return the last
<span class="lineNum">    3073 </span>                :            :  * arc_buf_t on the list. If no buffers remain on the list then return
<span class="lineNum">    3074 </span>                :            :  * NULL.
<a name="3075"><span class="lineNum">    3075 </span>                :            :  */</a>
<span class="lineNum">    3076 </span>                :            : static arc_buf_t *
<span class="lineNum">    3077 </span>                :<span class="lineCov">    1638309 : arc_buf_remove(arc_buf_hdr_t *hdr, arc_buf_t *buf)</span>
<span class="lineNum">    3078 </span>                :            : {
<span class="lineNum">    3079 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1638309 times"> + </span>]:<span class="lineCov">    1638309 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    3080 </span>[<span class="branchCov" title="Branch 3 was taken 1202189 times"> + </span><span class="branchCov" title="Branch 4 was taken 436430 times"> + </span>][<span class="branchCov" title="Branch 5 was taken 1202184 times"> + </span><span class="branchCov" title="Branch 6 was taken 5 times"> + </span>]:<span class="lineCov">    1638309 :         ASSERT(MUTEX_HELD(HDR_LOCK(hdr)) || HDR_EMPTY(hdr));</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 7 was taken 34 times"> + </span><span class="branchCov" title="Branch 8 was taken 1202150 times"> + </span>]
<span class="lineNum">    3081 </span>                :            : 
<span class="lineNum">    3082 </span>                :<span class="lineCov">    1638580 :         arc_buf_t **bufp = &amp;hdr-&gt;b_l1hdr.b_buf;</span>
<span class="lineNum">    3083 </span>                :<span class="lineCov">    1638580 :         arc_buf_t *lastbuf = NULL;</span>
<span class="lineNum">    3084 </span>                :            : 
<span class="lineNum">    3085 </span>                :            :         /*
<span class="lineNum">    3086 </span>                :            :          * Remove the buf from the hdr list and locate the last
<span class="lineNum">    3087 </span>                :            :          * remaining buffer on the list.
<span class="lineNum">    3088 </span>                :            :          */
<span class="lineNum">    3089 </span>        [<span class="branchCov" title="Branch 0 was taken 1713815 times"> + </span><span class="branchCov" title="Branch 1 was taken 1638580 times"> + </span>]:<span class="lineCov">    3352395 :         while (*bufp != NULL) {</span>
<span class="lineNum">    3090 </span>        [<span class="branchCov" title="Branch 0 was taken 1638458 times"> + </span><span class="branchCov" title="Branch 1 was taken 75357 times"> + </span>]:<span class="lineCov">    1713815 :                 if (*bufp == buf)</span>
<span class="lineNum">    3091 </span>                :<span class="lineCov">    1638458 :                         *bufp = buf-&gt;b_next;</span>
<span class="lineNum">    3092 </span>                :            : 
<span class="lineNum">    3093 </span>                :            :                 /*
<span class="lineNum">    3094 </span>                :            :                  * If we've removed a buffer in the middle of
<span class="lineNum">    3095 </span>                :            :                  * the list then update the lastbuf and update
<span class="lineNum">    3096 </span>                :            :                  * bufp.
<span class="lineNum">    3097 </span>                :            :                  */
<span class="lineNum">    3098 </span>        [<span class="branchCov" title="Branch 0 was taken 108388 times"> + </span><span class="branchCov" title="Branch 1 was taken 1605427 times"> + </span>]:<span class="lineCov">    1713815 :                 if (*bufp != NULL) {</span>
<span class="lineNum">    3099 </span>                :<span class="lineCov">     108388 :                         lastbuf = *bufp;</span>
<span class="lineNum">    3100 </span>                :<span class="lineCov">    1713815 :                         bufp = &amp;(*bufp)-&gt;b_next;</span>
<span class="lineNum">    3101 </span>                :            :                 }
<span class="lineNum">    3102 </span>                :            :         }
<span class="lineNum">    3103 </span>                :<span class="lineCov">    1638580 :         buf-&gt;b_next = NULL;</span>
<span class="lineNum">    3104 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1638580 times"> + </span>]:<span class="lineCov">    1638580 :         ASSERT3P(lastbuf, !=, buf);</span>
<span class="lineNum">    3105 </span>[<span class="branchCov" title="Branch 0 was taken 90998 times"> + </span><span class="branchCov" title="Branch 1 was taken 1547582 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 90998 times"> + </span>]:<span class="lineCov">    1638580 :         IMPLY(hdr-&gt;b_l1hdr.b_bufcnt &gt; 0, lastbuf != NULL);</span>
<span class="lineNum">    3106 </span>[<span class="branchCov" title="Branch 0 was taken 90998 times"> + </span><span class="branchCov" title="Branch 1 was taken 1547582 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 90998 times"> + </span>]:<span class="lineCov">    1638580 :         IMPLY(hdr-&gt;b_l1hdr.b_bufcnt &gt; 0, hdr-&gt;b_l1hdr.b_buf != NULL);</span>
<span class="lineNum">    3107 </span>[<span class="branchCov" title="Branch 0 was taken 90998 times"> + </span><span class="branchCov" title="Branch 1 was taken 1547582 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 90998 times"> + </span>]:<span class="lineCov">    1638580 :         IMPLY(lastbuf != NULL, ARC_BUF_LAST(lastbuf));</span>
<span class="lineNum">    3108 </span>                :            : 
<span class="lineNum">    3109 </span>                :<span class="lineCov">    1638580 :         return (lastbuf);</span>
<span class="lineNum">    3110 </span>                :            : }
<span class="lineNum">    3111 </span>                :            : 
<span class="lineNum">    3112 </span>                :            : /*
<span class="lineNum">    3113 </span>                :            :  * Free up buf-&gt;b_data and pull the arc_buf_t off of the the arc_buf_hdr_t's
<span class="lineNum">    3114 </span>                :            :  * list and free it.
<a name="3115"><span class="lineNum">    3115 </span>                :            :  */</a>
<span class="lineNum">    3116 </span>                :            : static void
<span class="lineNum">    3117 </span>                :<span class="lineCov">    1638648 : arc_buf_destroy_impl(arc_buf_t *buf)</span>
<span class="lineNum">    3118 </span>                :            : {
<span class="lineNum">    3119 </span>                :<span class="lineCov">    1638648 :         arc_buf_hdr_t *hdr = buf-&gt;b_hdr;</span>
<span class="lineNum">    3120 </span>                :            : 
<span class="lineNum">    3121 </span>                :            :         /*
<span class="lineNum">    3122 </span>                :            :          * Free up the data associated with the buf but only if we're not
<span class="lineNum">    3123 </span>                :            :          * sharing this with the hdr. If we are sharing it with the hdr, the
<span class="lineNum">    3124 </span>                :            :          * hdr is responsible for doing the free.
<span class="lineNum">    3125 </span>                :            :          */
<span class="lineNum">    3126 </span>           [<span class="branchCov" title="Branch 0 was taken 1638679 times"> + </span>]:<span class="lineCov">    1638648 :         if (buf-&gt;b_data != NULL) {</span>
<span class="lineNum">    3127 </span>                :            :                 /*
<span class="lineNum">    3128 </span>                :            :                  * We're about to change the hdr's b_flags. We must either
<span class="lineNum">    3129 </span>                :            :                  * hold the hash_lock or be undiscoverable.
<span class="lineNum">    3130 </span>                :            :                  */
<span class="lineNum">    3131 </span>   [<span class="branchCov" title="Branch 3 was taken 1202337 times"> + </span><span class="branchCov" title="Branch 4 was taken 436387 times"> + </span>][<span class="branchCov" title="Branch 5 was taken 1202354 times"> + </span>]:<span class="lineCov">    1638679 :                 ASSERT(MUTEX_HELD(HDR_LOCK(hdr)) || HDR_EMPTY(hdr));</span>
<span class="lineNum">         </span>           [<span class="branchCov" title="Branch 8 was taken 1202366 times"> + </span>]
<span class="lineNum">    3132 </span>                :            : 
<span class="lineNum">    3133 </span>                :<span class="lineCov">    1638753 :                 arc_cksum_verify(buf);</span>
<span class="lineNum">    3134 </span>                :<span class="lineCov">    1638814 :                 arc_buf_unwatch(buf);</span>
<span class="lineNum">    3135 </span>                :            : 
<span class="lineNum">    3136 </span>        [<span class="branchCov" title="Branch 1 was taken 1181966 times"> + </span><span class="branchCov" title="Branch 2 was taken 456554 times"> + </span>]:<span class="lineCov">    1638725 :                 if (arc_buf_is_shared(buf)) {</span>
<span class="lineNum">    3137 </span>                :<span class="lineCov">    1181966 :                         arc_hdr_clear_flags(hdr, ARC_FLAG_SHARED_DATA);</span>
<span class="lineNum">    3138 </span>                :            :                 } else {
<span class="lineNum">    3139 </span>                :<span class="lineCov">     456554 :                         uint64_t size = arc_buf_size(buf);</span>
<span class="lineNum">    3140 </span>                :<span class="lineCov">     456551 :                         arc_free_data_buf(hdr, buf-&gt;b_data, size, buf);</span>
<span class="lineNum">    3141 </span>                :<span class="lineCov">     456582 :                         ARCSTAT_INCR(arcstat_overhead_size, -size);</span>
<span class="lineNum">    3142 </span>                :            :                 }
<span class="lineNum">    3143 </span>                :<span class="lineCov">    1638466 :                 buf-&gt;b_data = NULL;</span>
<span class="lineNum">    3144 </span>                :            : 
<span class="lineNum">    3145 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1638466 times"> + </span>]:<span class="lineCov">    1638466 :                 ASSERT(hdr-&gt;b_l1hdr.b_bufcnt &gt; 0);</span>
<span class="lineNum">    3146 </span>                :<span class="lineCov">    1638466 :                 hdr-&gt;b_l1hdr.b_bufcnt -= 1;</span>
<span class="lineNum">    3147 </span>                :            : 
<span class="lineNum">    3148 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1638466 times"> + </span>]:<span class="lineCov">    1638466 :                 if (ARC_BUF_ENCRYPTED(buf))</span>
<span class="lineNum">    3149 </span>                :<span class="lineNoCov">          0 :                         hdr-&gt;b_crypt_hdr.b_ebufcnt -= 1;</span>
<span class="lineNum">    3150 </span>                :            : 
<span class="lineNum">    3151 </span>                :            :                 /*
<span class="lineNum">    3152 </span>                :            :                  * if we have no more encrypted buffers and we've already
<span class="lineNum">    3153 </span>                :            :                  * gotten a copy of the decrypted data we can free b_rabd to
<span class="lineNum">    3154 </span>                :            :                  * save some space.
<span class="lineNum">    3155 </span>                :            :                  */
<span class="lineNum">    3156 </span>[<span class="branchCov" title="Branch 0 was taken 1614778 times"> + </span><span class="branchCov" title="Branch 1 was taken 23688 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1614778 times"> + </span>]:<span class="lineCov">    1638466 :                 if (hdr-&gt;b_crypt_hdr.b_ebufcnt == 0 &amp;&amp; HDR_HAS_RABD(hdr) &amp;&amp;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">    3157 </span>                :<span class="lineNoCov">          0 :                     hdr-&gt;b_l1hdr.b_pabd != NULL)</span>
<span class="lineNum">    3158 </span>                :<span class="lineNoCov">          0 :                         arc_hdr_free_abd(hdr, B_TRUE);</span>
<span class="lineNum">    3159 </span>                :            :         }
<span class="lineNum">    3160 </span>                :            : 
<span class="lineNum">    3161 </span>                :<span class="lineCov">    1638435 :         arc_buf_t *lastbuf = arc_buf_remove(hdr, buf);</span>
<span class="lineNum">    3162 </span>                :            : 
<span class="lineNum">    3163 </span>        [<span class="branchCov" title="Branch 0 was taken 1181952 times"> + </span><span class="branchCov" title="Branch 1 was taken 456600 times"> + </span>]:<span class="lineCov">    1638552 :         if (ARC_BUF_SHARED(buf) &amp;&amp; !ARC_BUF_COMPRESSED(buf)) {</span>
<span class="lineNum">    3164 </span>                :            :                 /*
<span class="lineNum">    3165 </span>                :            :                  * If the current arc_buf_t is sharing its data buffer with the
<span class="lineNum">    3166 </span>                :            :                  * hdr, then reassign the hdr's b_pabd to share it with the new
<span class="lineNum">    3167 </span>                :            :                  * buffer at the end of the list. The shared buffer is always
<span class="lineNum">    3168 </span>                :            :                  * the last one on the hdr's buffer list.
<span class="lineNum">    3169 </span>                :            :                  *
<span class="lineNum">    3170 </span>                :            :                  * There is an equivalent case for compressed bufs, but since
<span class="lineNum">    3171 </span>                :            :                  * they aren't guaranteed to be the last buf in the list and
<span class="lineNum">    3172 </span>                :            :                  * that is an exceedingly rare case, we just allow that space be
<span class="lineNum">    3173 </span>                :            :                  * wasted temporarily. We must also be careful not to share
<span class="lineNum">    3174 </span>                :            :                  * encrypted buffers, since they cannot be shared.
<span class="lineNum">    3175 </span>                :            :                  */
<span class="lineNum">    3176 </span>[<span class="branchCov" title="Branch 0 was taken 7079 times"> + </span><span class="branchCov" title="Branch 1 was taken 1174873 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 7079 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">    1181952 :                 if (lastbuf != NULL &amp;&amp; !ARC_BUF_ENCRYPTED(lastbuf)) {</span>
<span class="lineNum">    3177 </span>                :            :                         /* Only one buf can be shared at once */
<span class="lineNum">    3178 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 7079 times"> + </span>]:<span class="lineCov">       7079 :                         VERIFY(!arc_buf_is_shared(lastbuf));</span>
<span class="lineNum">    3179 </span>                :            :                         /* hdr is uncompressed so can't have compressed buf */
<span class="lineNum">    3180 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7079 times"> + </span>]:<span class="lineCov">       7079 :                         VERIFY(!ARC_BUF_COMPRESSED(lastbuf));</span>
<span class="lineNum">    3181 </span>                :            : 
<span class="lineNum">    3182 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7079 times"> + </span>]:<span class="lineCov">       7079 :                         ASSERT3P(hdr-&gt;b_l1hdr.b_pabd, !=, NULL);</span>
<span class="lineNum">    3183 </span>                :<span class="lineCov">       7079 :                         arc_hdr_free_abd(hdr, B_FALSE);</span>
<span class="lineNum">    3184 </span>                :            : 
<span class="lineNum">    3185 </span>                :            :                         /*
<span class="lineNum">    3186 </span>                :            :                          * We must setup a new shared block between the
<span class="lineNum">    3187 </span>                :            :                          * last buffer and the hdr. The data would have
<span class="lineNum">    3188 </span>                :            :                          * been allocated by the arc buf so we need to transfer
<span class="lineNum">    3189 </span>                :            :                          * ownership to the hdr since it's now being shared.
<span class="lineNum">    3190 </span>                :            :                          */
<span class="lineNum">    3191 </span>                :<span class="lineCov">       7079 :                         arc_share_buf(hdr, lastbuf);</span>
<span class="lineNum">    3192 </span>                :            :                 }
<span class="lineNum">    3193 </span>        [<span class="branchCov" title="Branch 0 was taken 5172 times"> + </span><span class="branchCov" title="Branch 1 was taken 451428 times"> + </span>]:<span class="lineCov">     456600 :         } else if (HDR_SHARED_DATA(hdr)) {</span>
<span class="lineNum">    3194 </span>                :            :                 /*
<span class="lineNum">    3195 </span>                :            :                  * Uncompressed shared buffers are always at the end
<span class="lineNum">    3196 </span>                :            :                  * of the list. Compressed buffers don't have the
<span class="lineNum">    3197 </span>                :            :                  * same requirements. This makes it hard to
<span class="lineNum">    3198 </span>                :            :                  * simply assert that the lastbuf is shared so
<span class="lineNum">    3199 </span>                :            :                  * we rely on the hdr's compression flags to determine
<span class="lineNum">    3200 </span>                :            :                  * if we have a compressed, shared buffer.
<span class="lineNum">    3201 </span>                :            :                  */
<span class="lineNum">    3202 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5172 times"> + </span>]:<span class="lineCov">       5172 :                 ASSERT3P(lastbuf, !=, NULL);</span>
<span class="lineNum">    3203 </span>[<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 5172 times"> + </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineCov">       5172 :                 ASSERT(arc_buf_is_shared(lastbuf) ||</span>
<span class="lineNum">    3204 </span>                :            :                     arc_hdr_get_compress(hdr) != ZIO_COMPRESS_OFF);
<span class="lineNum">    3205 </span>                :            :         }
<span class="lineNum">    3206 </span>                :            : 
<span class="lineNum">    3207 </span>                :            :         /*
<span class="lineNum">    3208 </span>                :            :          * Free the checksum if we're removing the last uncompressed buf from
<span class="lineNum">    3209 </span>                :            :          * this hdr.
<span class="lineNum">    3210 </span>                :            :          */
<span class="lineNum">    3211 </span>        [<span class="branchCov" title="Branch 1 was taken 1547296 times"> + </span><span class="branchCov" title="Branch 2 was taken 90934 times"> + </span>]:<span class="lineCov">    1638552 :         if (!arc_hdr_has_uncompressed_buf(hdr)) {</span>
<span class="lineNum">    3212 </span>                :<span class="lineCov">    1547296 :                 arc_cksum_free(hdr);</span>
<span class="lineNum">    3213 </span>                :            :         }
<span class="lineNum">    3214 </span>                :            : 
<span class="lineNum">    3215 </span>                :            :         /* clean up the buf */
<span class="lineNum">    3216 </span>                :<span class="lineCov">    1638763 :         buf-&gt;b_hdr = NULL;</span>
<span class="lineNum">    3217 </span>                :<span class="lineCov">    1638763 :         kmem_cache_free(buf_cache, buf);</span>
<span class="lineNum">    3218 </span>                :<span class="lineCov">    1638783 : }</span>
<a name="3219"><span class="lineNum">    3219 </span>                :            : </a>
<span class="lineNum">    3220 </span>                :            : static void
<span class="lineNum">    3221 </span>                :<span class="lineCov">    2020841 : arc_hdr_alloc_abd(arc_buf_hdr_t *hdr, boolean_t alloc_rdata)</span>
<span class="lineNum">    3222 </span>                :            : {
<span class="lineNum">    3223 </span>                :            :         uint64_t size;
<span class="lineNum">    3224 </span>                :            : 
<span class="lineNum">    3225 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2020841 times"> + </span>]:<span class="lineCov">    2020841 :         ASSERT3U(HDR_GET_LSIZE(hdr), &gt;, 0);</span>
<span class="lineNum">    3226 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2020841 times"> + </span>]:<span class="lineCov">    2020841 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    3227 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2020841 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    2020841 :         ASSERT(!HDR_SHARED_DATA(hdr) || alloc_rdata);</span>
<span class="lineNum">    3228 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2020841 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    2020841 :         IMPLY(alloc_rdata, HDR_PROTECTED(hdr));</span>
<span class="lineNum">    3229 </span>                :            : 
<span class="lineNum">    3230 </span>[<span class="branchCov" title="Branch 0 was taken 2020540 times"> + </span><span class="branchCov" title="Branch 1 was taken 301 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 2020540 times"> + </span>]:<span class="lineCov">    2020841 :         if (hdr-&gt;b_l1hdr.b_pabd == NULL &amp;&amp; !HDR_HAS_RABD(hdr))</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    3231 </span>                :<span class="lineCov">    2020513 :                 hdr-&gt;b_l1hdr.b_byteswap = DMU_BSWAP_NUMFUNCS;</span>
<span class="lineNum">    3232 </span>                :            : 
<span class="lineNum">    3233 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2020841 times"> + </span>]:<span class="lineCov">    2020841 :         if (alloc_rdata) {</span>
<span class="lineNum">    3234 </span>                :<span class="lineNoCov">          0 :                 size = HDR_GET_PSIZE(hdr);</span>
<span class="lineNum">    3235 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3P(hdr-&gt;b_crypt_hdr.b_rabd, ==, NULL);</span>
<span class="lineNum">    3236 </span>                :<span class="lineNoCov">          0 :                 hdr-&gt;b_crypt_hdr.b_rabd = arc_get_data_abd(hdr, size, hdr);</span>
<span class="lineNum">    3237 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3P(hdr-&gt;b_crypt_hdr.b_rabd, !=, NULL);</span>
<span class="lineNum">    3238 </span>                :<span class="lineNoCov">          0 :                 ARCSTAT_INCR(arcstat_raw_size, size);</span>
<span class="lineNum">    3239 </span>                :            :         } else {
<span class="lineNum">    3240 </span>                :<span class="lineCov">    2020841 :                 size = arc_hdr_size(hdr);</span>
<span class="lineNum">    3241 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2020729 times"> + </span>]:<span class="lineCov">    2020729 :                 ASSERT3P(hdr-&gt;b_l1hdr.b_pabd, ==, NULL);</span>
<span class="lineNum">    3242 </span>                :<span class="lineCov">    2020729 :                 hdr-&gt;b_l1hdr.b_pabd = arc_get_data_abd(hdr, size, hdr);</span>
<span class="lineNum">    3243 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2022042 times"> + </span>]:<span class="lineCov">    2022042 :                 ASSERT3P(hdr-&gt;b_l1hdr.b_pabd, !=, NULL);</span>
<span class="lineNum">    3244 </span>                :            :         }
<span class="lineNum">    3245 </span>                :            : 
<span class="lineNum">    3246 </span>                :<span class="lineCov">    2022042 :         ARCSTAT_INCR(arcstat_compressed_size, size);</span>
<span class="lineNum">    3247 </span>                :<span class="lineCov">    2022142 :         ARCSTAT_INCR(arcstat_uncompressed_size, HDR_GET_LSIZE(hdr));</span>
<span class="lineNum">    3248 </span>                :<span class="lineCov">    2022231 : }</span>
<a name="3249"><span class="lineNum">    3249 </span>                :            : </a>
<span class="lineNum">    3250 </span>                :            : static void
<span class="lineNum">    3251 </span>                :<span class="lineCov">    1973617 : arc_hdr_free_abd(arc_buf_hdr_t *hdr, boolean_t free_rdata)</span>
<span class="lineNum">    3252 </span>                :            : {
<span class="lineNum">    3253 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1973617 times"> + </span>]:<span class="lineCov">    1973617 :         uint64_t size = (free_rdata) ? HDR_GET_PSIZE(hdr) : arc_hdr_size(hdr);</span>
<span class="lineNum">    3254 </span>                :            : 
<span class="lineNum">    3255 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1973645 times"> + </span>]:<span class="lineCov">    1973645 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    3256 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1973645 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1973645 :         ASSERT(hdr-&gt;b_l1hdr.b_pabd != NULL || HDR_HAS_RABD(hdr));</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    3257 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1973604 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1973604 :         IMPLY(free_rdata, HDR_HAS_RABD(hdr));</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    3258 </span>                :            : 
<span class="lineNum">    3259 </span>                :            :         /*
<span class="lineNum">    3260 </span>                :            :          * If the hdr is currently being written to the l2arc then
<span class="lineNum">    3261 </span>                :            :          * we defer freeing the data by adding it to the l2arc_free_on_write
<span class="lineNum">    3262 </span>                :            :          * list. The l2arc will free the data once it's finished
<span class="lineNum">    3263 </span>                :            :          * writing it to the l2arc device.
<span class="lineNum">    3264 </span>                :            :          */
<span class="lineNum">    3265 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 1973603 times"> + </span>]:<span class="lineCov">    1973604 :         if (HDR_L2_WRITING(hdr)) {</span>
<span class="lineNum">    3266 </span>                :<span class="lineCov">          1 :                 arc_hdr_free_on_write(hdr, free_rdata);</span>
<span class="lineNum">    3267 </span>                :<span class="lineCov">          1 :                 ARCSTAT_BUMP(arcstat_l2_free_on_write);</span>
<span class="lineNum">    3268 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1973603 times"> + </span>]:<span class="lineCov">    1973603 :         } else if (free_rdata) {</span>
<span class="lineNum">    3269 </span>                :<span class="lineNoCov">          0 :                 arc_free_data_abd(hdr, hdr-&gt;b_crypt_hdr.b_rabd, size, hdr);</span>
<span class="lineNum">    3270 </span>                :            :         } else {
<span class="lineNum">    3271 </span>                :<span class="lineCov">    1973603 :                 arc_free_data_abd(hdr, hdr-&gt;b_l1hdr.b_pabd, size, hdr);</span>
<span class="lineNum">    3272 </span>                :            :         }
<span class="lineNum">    3273 </span>                :            : 
<span class="lineNum">    3274 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1974796 times"> + </span>]:<span class="lineCov">    1974796 :         if (free_rdata) {</span>
<span class="lineNum">    3275 </span>                :<span class="lineNoCov">          0 :                 hdr-&gt;b_crypt_hdr.b_rabd = NULL;</span>
<span class="lineNum">    3276 </span>                :<span class="lineNoCov">          0 :                 ARCSTAT_INCR(arcstat_raw_size, -size);</span>
<span class="lineNum">    3277 </span>                :            :         } else {
<span class="lineNum">    3278 </span>                :<span class="lineCov">    1974796 :                 hdr-&gt;b_l1hdr.b_pabd = NULL;</span>
<span class="lineNum">    3279 </span>                :            :         }
<span class="lineNum">    3280 </span>                :            : 
<span class="lineNum">    3281 </span>[<span class="branchCov" title="Branch 0 was taken 1974797 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1974797 times"> + </span>]:<span class="lineCov">    1974797 :         if (hdr-&gt;b_l1hdr.b_pabd == NULL &amp;&amp; !HDR_HAS_RABD(hdr))</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    3282 </span>                :<span class="lineCov">    1974795 :                 hdr-&gt;b_l1hdr.b_byteswap = DMU_BSWAP_NUMFUNCS;</span>
<span class="lineNum">    3283 </span>                :            : 
<span class="lineNum">    3284 </span>                :<span class="lineCov">    1974797 :         ARCSTAT_INCR(arcstat_compressed_size, -size);</span>
<span class="lineNum">    3285 </span>                :<span class="lineCov">    1974854 :         ARCSTAT_INCR(arcstat_uncompressed_size, -HDR_GET_LSIZE(hdr));</span>
<span class="lineNum">    3286 </span>                :<span class="lineCov">    1974806 : }</span>
<a name="3287"><span class="lineNum">    3287 </span>                :            : </a>
<span class="lineNum">    3288 </span>                :            : static arc_buf_hdr_t *
<span class="lineNum">    3289 </span>                :<span class="lineCov">    1499040 : arc_hdr_alloc(uint64_t spa, int32_t psize, int32_t lsize,</span>
<span class="lineNum">    3290 </span>                :            :     boolean_t protected, enum zio_compress compression_type,
<span class="lineNum">    3291 </span>                :            :     arc_buf_contents_t type, boolean_t alloc_rdata)
<span class="lineNum">    3292 </span>                :            : {
<span class="lineNum">    3293 </span>                :            :         arc_buf_hdr_t *hdr;
<span class="lineNum">    3294 </span>                :            : 
<span class="lineNum">    3295 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1499040 times"> + </span>]:<span class="lineCov">    1499040 :         VERIFY(type == ARC_BUFC_DATA || type == ARC_BUFC_METADATA);</span>
<span class="lineNum">    3296 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1499040 times"> + </span>]:<span class="lineCov">    1499040 :         if (protected) {</span>
<span class="lineNum">    3297 </span>                :<span class="lineNoCov">          0 :                 hdr = kmem_cache_alloc(hdr_full_crypt_cache, KM_PUSHPAGE);</span>
<span class="lineNum">    3298 </span>                :            :         } else {
<span class="lineNum">    3299 </span>                :<span class="lineCov">    1499040 :                 hdr = kmem_cache_alloc(hdr_full_cache, KM_PUSHPAGE);</span>
<span class="lineNum">    3300 </span>                :            :         }
<span class="lineNum">    3301 </span>                :            : 
<span class="lineNum">    3302 </span>[<span class="branchCov" title="Branch 0 was taken 1499932 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 106 times"> + </span><span class="branchCov" title="Branch 3 was taken 1499826 times"> + </span>]:<span class="lineCov">    1499932 :         ASSERT(HDR_EMPTY(hdr));</span>
<span class="lineNum">    3303 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1499826 times"> + </span>]:<span class="lineCov">    1499826 :         ASSERT3P(hdr-&gt;b_l1hdr.b_freeze_cksum, ==, NULL);</span>
<span class="lineNum">    3304 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1499826 times"> + </span>]:<span class="lineCov">    1499826 :         HDR_SET_PSIZE(hdr, psize);</span>
<span class="lineNum">    3305 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1499826 times"> + </span>]:<span class="lineCov">    1499826 :         HDR_SET_LSIZE(hdr, lsize);</span>
<span class="lineNum">    3306 </span>                :<span class="lineCov">    1499826 :         hdr-&gt;b_spa = spa;</span>
<span class="lineNum">    3307 </span>                :<span class="lineCov">    1499826 :         hdr-&gt;b_type = type;</span>
<span class="lineNum">    3308 </span>                :<span class="lineCov">    1499826 :         hdr-&gt;b_flags = 0;</span>
<span class="lineNum">    3309 </span>                :<span class="lineCov">    1499826 :         arc_hdr_set_flags(hdr, arc_bufc_to_flags(type) | ARC_FLAG_HAS_L1HDR);</span>
<span class="lineNum">    3310 </span>                :<span class="lineCov">    1499598 :         arc_hdr_set_compress(hdr, compression_type);</span>
<span class="lineNum">    3311 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1499412 times"> + </span>]:<span class="lineCov">    1499412 :         if (protected)</span>
<span class="lineNum">    3312 </span>                :<span class="lineNoCov">          0 :                 arc_hdr_set_flags(hdr, ARC_FLAG_PROTECTED);</span>
<span class="lineNum">    3313 </span>                :            : 
<span class="lineNum">    3314 </span>                :<span class="lineCov">    1499412 :         hdr-&gt;b_l1hdr.b_state = arc_anon;</span>
<span class="lineNum">    3315 </span>                :<span class="lineCov">    1499412 :         hdr-&gt;b_l1hdr.b_arc_access = 0;</span>
<span class="lineNum">    3316 </span>                :<span class="lineCov">    1499412 :         hdr-&gt;b_l1hdr.b_bufcnt = 0;</span>
<span class="lineNum">    3317 </span>                :<span class="lineCov">    1499412 :         hdr-&gt;b_l1hdr.b_buf = NULL;</span>
<span class="lineNum">    3318 </span>                :            : 
<span class="lineNum">    3319 </span>                :            :         /*
<span class="lineNum">    3320 </span>                :            :          * Allocate the hdr's buffer. This will contain either
<span class="lineNum">    3321 </span>                :            :          * the compressed or uncompressed data depending on the block
<span class="lineNum">    3322 </span>                :            :          * it references and compressed arc enablement.
<span class="lineNum">    3323 </span>                :            :          */
<span class="lineNum">    3324 </span>                :<span class="lineCov">    1499412 :         arc_hdr_alloc_abd(hdr, alloc_rdata);</span>
<span class="lineNum">    3325 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1499916 times"> + </span>]:<span class="lineCov">    1500017 :         ASSERT(refcount_is_zero(&amp;hdr-&gt;b_l1hdr.b_refcnt));</span>
<span class="lineNum">    3326 </span>                :            : 
<span class="lineNum">    3327 </span>                :<span class="lineCov">    1499916 :         return (hdr);</span>
<span class="lineNum">    3328 </span>                :            : }
<span class="lineNum">    3329 </span>                :            : 
<span class="lineNum">    3330 </span>                :            : /*
<span class="lineNum">    3331 </span>                :            :  * Transition between the two allocation states for the arc_buf_hdr struct.
<span class="lineNum">    3332 </span>                :            :  * The arc_buf_hdr struct can be allocated with (hdr_full_cache) or without
<span class="lineNum">    3333 </span>                :            :  * (hdr_l2only_cache) the fields necessary for the L1 cache - the smaller
<span class="lineNum">    3334 </span>                :            :  * version is used when a cache buffer is only in the L2ARC in order to reduce
<span class="lineNum">    3335 </span>                :            :  * memory usage.
<a name="3336"><span class="lineNum">    3336 </span>                :            :  */</a>
<span class="lineNum">    3337 </span>                :            : static arc_buf_hdr_t *
<span class="lineNum">    3338 </span>                :<span class="lineCov">       2744 : arc_hdr_realloc(arc_buf_hdr_t *hdr, kmem_cache_t *old, kmem_cache_t *new)</span>
<span class="lineNum">    3339 </span>                :            : {
<span class="lineNum">    3340 </span>                :            :         arc_buf_hdr_t *nhdr;
<span class="lineNum">    3341 </span>                :<span class="lineCov">       2744 :         l2arc_dev_t *dev = hdr-&gt;b_l2hdr.b_dev;</span>
<span class="lineNum">    3342 </span>                :            : 
<span class="lineNum">    3343 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>]:<span class="lineCov">       2744 :         ASSERT(HDR_HAS_L2HDR(hdr));</span>
<span class="lineNum">    3344 </span>[<span class="branchCov" title="Branch 0 was taken 2744 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 2744 times"> + </span>]:<span class="lineCov">       2744 :         ASSERT((old == hdr_full_cache &amp;&amp; new == hdr_l2only_cache) ||</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">    3345 </span>                :            :             (old == hdr_l2only_cache &amp;&amp; new == hdr_full_cache));
<span class="lineNum">    3346 </span>                :            : 
<span class="lineNum">    3347 </span>                :            :         /*
<span class="lineNum">    3348 </span>                :            :          * if the caller wanted a new full header and the header is to be
<span class="lineNum">    3349 </span>                :            :          * encrypted we will actually allocate the header from the full crypt
<span class="lineNum">    3350 </span>                :            :          * cache instead. The same applies to freeing from the old cache.
<span class="lineNum">    3351 </span>                :            :          */
<span class="lineNum">    3352 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       2744 :         if (HDR_PROTECTED(hdr) &amp;&amp; new == hdr_full_cache)</span>
<span class="lineNum">    3353 </span>                :<span class="lineNoCov">          0 :                 new = hdr_full_crypt_cache;</span>
<span class="lineNum">    3354 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       2744 :         if (HDR_PROTECTED(hdr) &amp;&amp; old == hdr_full_cache)</span>
<span class="lineNum">    3355 </span>                :<span class="lineNoCov">          0 :                 old = hdr_full_crypt_cache;</span>
<span class="lineNum">    3356 </span>                :            : 
<span class="lineNum">    3357 </span>                :<span class="lineCov">       2744 :         nhdr = kmem_cache_alloc(new, KM_PUSHPAGE);</span>
<span class="lineNum">    3358 </span>                :            : 
<span class="lineNum">    3359 </span>        [<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 2744 times"> + </span>]:<span class="lineCov">       2744 :         ASSERT(MUTEX_HELD(HDR_LOCK(hdr)));</span>
<span class="lineNum">    3360 </span>                :<span class="lineCov">       2744 :         buf_hash_remove(hdr);</span>
<span class="lineNum">    3361 </span>                :            : 
<span class="lineNum">    3362 </span>                :<span class="lineCov">       2744 :         bcopy(hdr, nhdr, HDR_L2ONLY_SIZE);</span>
<span class="lineNum">    3363 </span>                :            : 
<span class="lineNum">    3364 </span>[<span class="branchCov" title="Branch 0 was taken 2744 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 2744 times"> + </span>]:<span class="lineCov">       2744 :         if (new == hdr_full_cache || new == hdr_full_crypt_cache) {</span>
<span class="lineNum">    3365 </span>                :<span class="lineNoCov">          0 :                 arc_hdr_set_flags(nhdr, ARC_FLAG_HAS_L1HDR);</span>
<span class="lineNum">    3366 </span>                :            :                 /*
<span class="lineNum">    3367 </span>                :            :                  * arc_access and arc_change_state need to be aware that a
<span class="lineNum">    3368 </span>                :            :                  * header has just come out of L2ARC, so we set its state to
<span class="lineNum">    3369 </span>                :            :                  * l2c_only even though it's about to change.
<span class="lineNum">    3370 </span>                :            :                  */
<span class="lineNum">    3371 </span>                :<span class="lineNoCov">          0 :                 nhdr-&gt;b_l1hdr.b_state = arc_l2c_only;</span>
<span class="lineNum">    3372 </span>                :            : 
<span class="lineNum">    3373 </span>                :            :                 /* Verify previous threads set to NULL before freeing */
<span class="lineNum">    3374 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3P(nhdr-&gt;b_l1hdr.b_pabd, ==, NULL);</span>
<span class="lineNum">    3375 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT(!HDR_HAS_RABD(hdr));</span>
<span class="lineNum">    3376 </span>                :            :         } else {
<span class="lineNum">    3377 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>]:<span class="lineCov">       2744 :                 ASSERT3P(hdr-&gt;b_l1hdr.b_buf, ==, NULL);</span>
<span class="lineNum">    3378 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>]:<span class="lineCov">       2744 :                 ASSERT0(hdr-&gt;b_l1hdr.b_bufcnt);</span>
<span class="lineNum">    3379 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>]:<span class="lineCov">       2744 :                 ASSERT3P(hdr-&gt;b_l1hdr.b_freeze_cksum, ==, NULL);</span>
<span class="lineNum">    3380 </span>                :            : 
<span class="lineNum">    3381 </span>                :            :                 /*
<span class="lineNum">    3382 </span>                :            :                  * If we've reached here, We must have been called from
<span class="lineNum">    3383 </span>                :            :                  * arc_evict_hdr(), as such we should have already been
<span class="lineNum">    3384 </span>                :            :                  * removed from any ghost list we were previously on
<span class="lineNum">    3385 </span>                :            :                  * (which protects us from racing with arc_evict_state),
<span class="lineNum">    3386 </span>                :            :                  * thus no locking is needed during this check.
<span class="lineNum">    3387 </span>                :            :                  */
<span class="lineNum">    3388 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2744 times"> + </span>]:<span class="lineCov">       2744 :                 ASSERT(!multilist_link_active(&amp;hdr-&gt;b_l1hdr.b_arc_node));</span>
<span class="lineNum">    3389 </span>                :            : 
<span class="lineNum">    3390 </span>                :            :                 /*
<span class="lineNum">    3391 </span>                :            :                  * A buffer must not be moved into the arc_l2c_only
<span class="lineNum">    3392 </span>                :            :                  * state if it's not finished being written out to the
<span class="lineNum">    3393 </span>                :            :                  * l2arc device. Otherwise, the b_l1hdr.b_pabd field
<span class="lineNum">    3394 </span>                :            :                  * might try to be accessed, even though it was removed.
<span class="lineNum">    3395 </span>                :            :                  */
<span class="lineNum">    3396 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>]:<span class="lineCov">       2744 :                 VERIFY(!HDR_L2_WRITING(hdr));</span>
<span class="lineNum">    3397 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>]:<span class="lineCov">       2744 :                 VERIFY3P(hdr-&gt;b_l1hdr.b_pabd, ==, NULL);</span>
<span class="lineNum">    3398 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       2744 :                 ASSERT(!HDR_HAS_RABD(hdr));</span>
<span class="lineNum">    3399 </span>                :            : 
<span class="lineNum">    3400 </span>                :<span class="lineCov">       2744 :                 arc_hdr_clear_flags(nhdr, ARC_FLAG_HAS_L1HDR);</span>
<span class="lineNum">    3401 </span>                :            :         }
<span class="lineNum">    3402 </span>                :            :         /*
<span class="lineNum">    3403 </span>                :            :          * The header has been reallocated so we need to re-insert it into any
<span class="lineNum">    3404 </span>                :            :          * lists it was on.
<span class="lineNum">    3405 </span>                :            :          */
<span class="lineNum">    3406 </span>                :<span class="lineCov">       2744 :         (void) buf_hash_insert(nhdr, NULL);</span>
<span class="lineNum">    3407 </span>                :            : 
<span class="lineNum">    3408 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2744 times"> + </span>]:<span class="lineCov">       2744 :         ASSERT(list_link_active(&amp;hdr-&gt;b_l2hdr.b_l2node));</span>
<span class="lineNum">    3409 </span>                :            : 
<span class="lineNum">    3410 </span>                :<span class="lineCov">       2744 :         mutex_enter(&amp;dev-&gt;l2ad_mtx);</span>
<span class="lineNum">    3411 </span>                :            : 
<span class="lineNum">    3412 </span>                :            :         /*
<span class="lineNum">    3413 </span>                :            :          * We must place the realloc'ed header back into the list at
<span class="lineNum">    3414 </span>                :            :          * the same spot. Otherwise, if it's placed earlier in the list,
<span class="lineNum">    3415 </span>                :            :          * l2arc_write_buffers() could find it during the function's
<span class="lineNum">    3416 </span>                :            :          * write phase, and try to write it out to the l2arc.
<span class="lineNum">    3417 </span>                :            :          */
<span class="lineNum">    3418 </span>                :<span class="lineCov">       2744 :         list_insert_after(&amp;dev-&gt;l2ad_buflist, hdr, nhdr);</span>
<span class="lineNum">    3419 </span>                :<span class="lineCov">       2744 :         list_remove(&amp;dev-&gt;l2ad_buflist, hdr);</span>
<span class="lineNum">    3420 </span>                :            : 
<span class="lineNum">    3421 </span>                :<span class="lineCov">       2744 :         mutex_exit(&amp;dev-&gt;l2ad_mtx);</span>
<span class="lineNum">    3422 </span>                :            : 
<span class="lineNum">    3423 </span>                :            :         /*
<span class="lineNum">    3424 </span>                :            :          * Since we're using the pointer address as the tag when
<span class="lineNum">    3425 </span>                :            :          * incrementing and decrementing the l2ad_alloc refcount, we
<span class="lineNum">    3426 </span>                :            :          * must remove the old pointer (that we're about to destroy) and
<span class="lineNum">    3427 </span>                :            :          * add the new pointer to the refcount. Otherwise we'd remove
<span class="lineNum">    3428 </span>                :            :          * the wrong pointer address when calling arc_hdr_destroy() later.
<span class="lineNum">    3429 </span>                :            :          */
<span class="lineNum">    3430 </span>                :            : 
<span class="lineNum">    3431 </span>                :<span class="lineCov">       2744 :         (void) refcount_remove_many(&amp;dev-&gt;l2ad_alloc, arc_hdr_size(hdr), hdr);</span>
<span class="lineNum">    3432 </span>                :<span class="lineCov">       2744 :         (void) refcount_add_many(&amp;dev-&gt;l2ad_alloc, arc_hdr_size(nhdr), nhdr);</span>
<span class="lineNum">    3433 </span>                :            : 
<span class="lineNum">    3434 </span>                :<span class="lineCov">       2744 :         buf_discard_identity(hdr);</span>
<span class="lineNum">    3435 </span>                :<span class="lineCov">       2744 :         kmem_cache_free(old, hdr);</span>
<span class="lineNum">    3436 </span>                :            : 
<span class="lineNum">    3437 </span>                :<span class="lineCov">       2744 :         return (nhdr);</span>
<span class="lineNum">    3438 </span>                :            : }
<span class="lineNum">    3439 </span>                :            : 
<span class="lineNum">    3440 </span>                :            : /*
<span class="lineNum">    3441 </span>                :            :  * This function allows an L1 header to be reallocated as a crypt
<span class="lineNum">    3442 </span>                :            :  * header and vice versa. If we are going to a crypt header, the
<span class="lineNum">    3443 </span>                :            :  * new fields will be zeroed out.
<a name="3444"><span class="lineNum">    3444 </span>                :            :  */</a>
<span class="lineNum">    3445 </span>                :            : static arc_buf_hdr_t *
<span class="lineNum">    3446 </span>                :<span class="lineNoCov">          0 : arc_hdr_realloc_crypt(arc_buf_hdr_t *hdr, boolean_t need_crypt)</span>
<span class="lineNum">    3447 </span>                :            : {
<span class="lineNum">    3448 </span>                :            :         arc_buf_hdr_t *nhdr;
<span class="lineNum">    3449 </span>                :            :         arc_buf_t *buf;
<span class="lineNum">    3450 </span>                :            :         kmem_cache_t *ncache, *ocache;
<span class="lineNum">    3451 </span>                :            : 
<span class="lineNum">    3452 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    3453 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3U(!!HDR_PROTECTED(hdr), !=, need_crypt);</span>
<span class="lineNum">    3454 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3P(hdr-&gt;b_l1hdr.b_state, ==, arc_anon);</span>
<span class="lineNum">    3455 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(!multilist_link_active(&amp;hdr-&gt;b_l1hdr.b_arc_node));</span>
<span class="lineNum">    3456 </span>                :            : 
<span class="lineNum">    3457 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (need_crypt) {</span>
<span class="lineNum">    3458 </span>                :<span class="lineNoCov">          0 :                 ncache = hdr_full_crypt_cache;</span>
<span class="lineNum">    3459 </span>                :<span class="lineNoCov">          0 :                 ocache = hdr_full_cache;</span>
<span class="lineNum">    3460 </span>                :            :         } else {
<span class="lineNum">    3461 </span>                :<span class="lineNoCov">          0 :                 ncache = hdr_full_cache;</span>
<span class="lineNum">    3462 </span>                :<span class="lineNoCov">          0 :                 ocache = hdr_full_crypt_cache;</span>
<span class="lineNum">    3463 </span>                :            :         }
<span class="lineNum">    3464 </span>                :            : 
<span class="lineNum">    3465 </span>                :<span class="lineNoCov">          0 :         nhdr = kmem_cache_alloc(ncache, KM_PUSHPAGE);</span>
<span class="lineNum">    3466 </span>                :<span class="lineNoCov">          0 :         bcopy(hdr, nhdr, HDR_L2ONLY_SIZE);</span>
<span class="lineNum">    3467 </span>                :<span class="lineNoCov">          0 :         nhdr-&gt;b_l1hdr.b_freeze_cksum = hdr-&gt;b_l1hdr.b_freeze_cksum;</span>
<span class="lineNum">    3468 </span>                :<span class="lineNoCov">          0 :         nhdr-&gt;b_l1hdr.b_bufcnt = hdr-&gt;b_l1hdr.b_bufcnt;</span>
<span class="lineNum">    3469 </span>                :<span class="lineNoCov">          0 :         nhdr-&gt;b_l1hdr.b_byteswap = hdr-&gt;b_l1hdr.b_byteswap;</span>
<span class="lineNum">    3470 </span>                :<span class="lineNoCov">          0 :         nhdr-&gt;b_l1hdr.b_state = hdr-&gt;b_l1hdr.b_state;</span>
<span class="lineNum">    3471 </span>                :<span class="lineNoCov">          0 :         nhdr-&gt;b_l1hdr.b_arc_access = hdr-&gt;b_l1hdr.b_arc_access;</span>
<span class="lineNum">    3472 </span>                :<span class="lineNoCov">          0 :         nhdr-&gt;b_l1hdr.b_mru_hits = hdr-&gt;b_l1hdr.b_mru_hits;</span>
<span class="lineNum">    3473 </span>                :<span class="lineNoCov">          0 :         nhdr-&gt;b_l1hdr.b_mru_ghost_hits = hdr-&gt;b_l1hdr.b_mru_ghost_hits;</span>
<span class="lineNum">    3474 </span>                :<span class="lineNoCov">          0 :         nhdr-&gt;b_l1hdr.b_mfu_hits = hdr-&gt;b_l1hdr.b_mfu_hits;</span>
<span class="lineNum">    3475 </span>                :<span class="lineNoCov">          0 :         nhdr-&gt;b_l1hdr.b_mfu_ghost_hits = hdr-&gt;b_l1hdr.b_mfu_ghost_hits;</span>
<span class="lineNum">    3476 </span>                :<span class="lineNoCov">          0 :         nhdr-&gt;b_l1hdr.b_l2_hits = hdr-&gt;b_l1hdr.b_l2_hits;</span>
<span class="lineNum">    3477 </span>                :<span class="lineNoCov">          0 :         nhdr-&gt;b_l1hdr.b_acb = hdr-&gt;b_l1hdr.b_acb;</span>
<span class="lineNum">    3478 </span>                :<span class="lineNoCov">          0 :         nhdr-&gt;b_l1hdr.b_pabd = hdr-&gt;b_l1hdr.b_pabd;</span>
<span class="lineNum">    3479 </span>                :<span class="lineNoCov">          0 :         nhdr-&gt;b_l1hdr.b_buf = hdr-&gt;b_l1hdr.b_buf;</span>
<span class="lineNum">    3480 </span>                :            : 
<span class="lineNum">    3481 </span>                :            :         /*
<span class="lineNum">    3482 </span>                :            :          * This refcount_add() exists only to ensure that the individual
<span class="lineNum">    3483 </span>                :            :          * arc buffers always point to a header that is referenced, avoiding
<span class="lineNum">    3484 </span>                :            :          * a small race condition that could trigger ASSERTs.
<span class="lineNum">    3485 </span>                :            :          */
<span class="lineNum">    3486 </span>                :<span class="lineNoCov">          0 :         (void) refcount_add(&amp;nhdr-&gt;b_l1hdr.b_refcnt, FTAG);</span>
<span class="lineNum">    3487 </span>                :            : 
<span class="lineNum">    3488 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (buf = nhdr-&gt;b_l1hdr.b_buf; buf != NULL; buf = buf-&gt;b_next) {</span>
<span class="lineNum">    3489 </span>                :<span class="lineNoCov">          0 :                 mutex_enter(&amp;buf-&gt;b_evict_lock);</span>
<span class="lineNum">    3490 </span>                :<span class="lineNoCov">          0 :                 buf-&gt;b_hdr = nhdr;</span>
<span class="lineNum">    3491 </span>                :<span class="lineNoCov">          0 :                 mutex_exit(&amp;buf-&gt;b_evict_lock);</span>
<span class="lineNum">    3492 </span>                :            :         }
<span class="lineNum">    3493 </span>                :            : 
<span class="lineNum">    3494 </span>                :<span class="lineNoCov">          0 :         refcount_transfer(&amp;nhdr-&gt;b_l1hdr.b_refcnt, &amp;hdr-&gt;b_l1hdr.b_refcnt);</span>
<span class="lineNum">    3495 </span>                :<span class="lineNoCov">          0 :         (void) refcount_remove(&amp;nhdr-&gt;b_l1hdr.b_refcnt, FTAG);</span>
<span class="lineNum">    3496 </span>                :            : 
<span class="lineNum">    3497 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (need_crypt) {</span>
<span class="lineNum">    3498 </span>                :<span class="lineNoCov">          0 :                 arc_hdr_set_flags(nhdr, ARC_FLAG_PROTECTED);</span>
<span class="lineNum">    3499 </span>                :            :         } else {
<span class="lineNum">    3500 </span>                :<span class="lineNoCov">          0 :                 arc_hdr_clear_flags(nhdr, ARC_FLAG_PROTECTED);</span>
<span class="lineNum">    3501 </span>                :            :         }
<span class="lineNum">    3502 </span>                :            : 
<span class="lineNum">    3503 </span>                :<span class="lineNoCov">          0 :         buf_discard_identity(hdr);</span>
<span class="lineNum">    3504 </span>                :<span class="lineNoCov">          0 :         kmem_cache_free(ocache, hdr);</span>
<span class="lineNum">    3505 </span>                :            : 
<span class="lineNum">    3506 </span>                :<span class="lineNoCov">          0 :         return (nhdr);</span>
<span class="lineNum">    3507 </span>                :            : }
<span class="lineNum">    3508 </span>                :            : 
<span class="lineNum">    3509 </span>                :            : /*
<span class="lineNum">    3510 </span>                :            :  * This function is used by the send / receive code to convert a newly
<span class="lineNum">    3511 </span>                :            :  * allocated arc_buf_t to one that is suitable for a raw encrypted write. It
<span class="lineNum">    3512 </span>                :            :  * is also used to allow the root objset block to be uupdated without altering
<span class="lineNum">    3513 </span>                :            :  * its embedded MACs. Both block types will always be uncompressed so we do not
<span class="lineNum">    3514 </span>                :            :  * have to worry about compression type or psize.
<a name="3515"><span class="lineNum">    3515 </span>                :            :  */</a>
<span class="lineNum">    3516 </span>                :            : void
<span class="lineNum">    3517 </span>                :<span class="lineNoCov">          0 : arc_convert_to_raw(arc_buf_t *buf, uint64_t dsobj, boolean_t byteorder,</span>
<span class="lineNum">    3518 </span>                :            :     dmu_object_type_t ot, const uint8_t *salt, const uint8_t *iv,
<span class="lineNum">    3519 </span>                :            :     const uint8_t *mac)
<span class="lineNum">    3520 </span>                :            : {
<span class="lineNum">    3521 </span>                :<span class="lineNoCov">          0 :         arc_buf_hdr_t *hdr = buf-&gt;b_hdr;</span>
<span class="lineNum">    3522 </span>                :            : 
<span class="lineNum">    3523 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(ot == DMU_OT_DNODE || ot == DMU_OT_OBJSET);</span>
<span class="lineNum">    3524 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    3525 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3P(hdr-&gt;b_l1hdr.b_state, ==, arc_anon);</span>
<span class="lineNum">    3526 </span>                :            : 
<span class="lineNum">    3527 </span>                :<span class="lineNoCov">          0 :         buf-&gt;b_flags |= (ARC_BUF_FLAG_COMPRESSED | ARC_BUF_FLAG_ENCRYPTED);</span>
<span class="lineNum">    3528 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!HDR_PROTECTED(hdr))</span>
<span class="lineNum">    3529 </span>                :<span class="lineNoCov">          0 :                 hdr = arc_hdr_realloc_crypt(hdr, B_TRUE);</span>
<span class="lineNum">    3530 </span>                :<span class="lineNoCov">          0 :         hdr-&gt;b_crypt_hdr.b_dsobj = dsobj;</span>
<span class="lineNum">    3531 </span>                :<span class="lineNoCov">          0 :         hdr-&gt;b_crypt_hdr.b_ot = ot;</span>
<span class="lineNum">    3532 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         hdr-&gt;b_l1hdr.b_byteswap = (byteorder == ZFS_HOST_BYTEORDER) ?</span>
<span class="lineNum">    3533 </span>                :<span class="lineNoCov">          0 :             DMU_BSWAP_NUMFUNCS : DMU_OT_BYTESWAP(ot);</span>
<span class="lineNum">    3534 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!arc_hdr_has_uncompressed_buf(hdr))</span>
<span class="lineNum">    3535 </span>                :<span class="lineNoCov">          0 :                 arc_cksum_free(hdr);</span>
<span class="lineNum">    3536 </span>                :            : 
<span class="lineNum">    3537 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (salt != NULL)</span>
<span class="lineNum">    3538 </span>                :<span class="lineNoCov">          0 :                 bcopy(salt, hdr-&gt;b_crypt_hdr.b_salt, ZIO_DATA_SALT_LEN);</span>
<span class="lineNum">    3539 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (iv != NULL)</span>
<span class="lineNum">    3540 </span>                :<span class="lineNoCov">          0 :                 bcopy(iv, hdr-&gt;b_crypt_hdr.b_iv, ZIO_DATA_IV_LEN);</span>
<span class="lineNum">    3541 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (mac != NULL)</span>
<span class="lineNum">    3542 </span>                :<span class="lineNoCov">          0 :                 bcopy(mac, hdr-&gt;b_crypt_hdr.b_mac, ZIO_DATA_MAC_LEN);</span>
<span class="lineNum">    3543 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3544 </span>                :            : 
<span class="lineNum">    3545 </span>                :            : /*
<span class="lineNum">    3546 </span>                :            :  * Allocate a new arc_buf_hdr_t and arc_buf_t and return the buf to the caller.
<span class="lineNum">    3547 </span>                :            :  * The buf is returned thawed since we expect the consumer to modify it.
<a name="3548"><span class="lineNum">    3548 </span>                :            :  */</a>
<span class="lineNum">    3549 </span>                :            : arc_buf_t *
<span class="lineNum">    3550 </span>                :<span class="lineCov">     253730 : arc_alloc_buf(spa_t *spa, void *tag, arc_buf_contents_t type, int32_t size)</span>
<span class="lineNum">    3551 </span>                :            : {
<span class="lineNum">    3552 </span>                :<span class="lineCov">     253730 :         arc_buf_hdr_t *hdr = arc_hdr_alloc(spa_load_guid(spa), size, size,</span>
<span class="lineNum">    3553 </span>                :            :             B_FALSE, ZIO_COMPRESS_OFF, type, B_FALSE);
<span class="lineNum">    3554 </span>        [<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 253741 times"> + </span>]:<span class="lineCov">     253739 :         ASSERT(!MUTEX_HELD(HDR_LOCK(hdr)));</span>
<span class="lineNum">    3555 </span>                :            : 
<span class="lineNum">    3556 </span>                :<span class="lineCov">     253741 :         arc_buf_t *buf = NULL;</span>
<span class="lineNum">    3557 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 253716 times"> + </span>]:<span class="lineCov">     253741 :         VERIFY0(arc_buf_alloc_impl(hdr, spa, 0, tag, B_FALSE, B_FALSE,</span>
<span class="lineNum">    3558 </span>                :            :             B_FALSE, B_FALSE, &amp;buf));
<span class="lineNum">    3559 </span>                :<span class="lineCov">     253716 :         arc_buf_thaw(buf);</span>
<span class="lineNum">    3560 </span>                :            : 
<span class="lineNum">    3561 </span>                :<span class="lineCov">     253732 :         return (buf);</span>
<span class="lineNum">    3562 </span>                :            : }
<span class="lineNum">    3563 </span>                :            : 
<span class="lineNum">    3564 </span>                :            : /*
<span class="lineNum">    3565 </span>                :            :  * Allocate a compressed buf in the same manner as arc_alloc_buf. Don't use this
<span class="lineNum">    3566 </span>                :            :  * for bufs containing metadata.
<a name="3567"><span class="lineNum">    3567 </span>                :            :  */</a>
<span class="lineNum">    3568 </span>                :            : arc_buf_t *
<span class="lineNum">    3569 </span>                :<span class="lineNoCov">          0 : arc_alloc_compressed_buf(spa_t *spa, void *tag, uint64_t psize, uint64_t lsize,</span>
<span class="lineNum">    3570 </span>                :            :     enum zio_compress compression_type)
<span class="lineNum">    3571 </span>                :            : {
<span class="lineNum">    3572 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3U(lsize, &gt;, 0);</span>
<span class="lineNum">    3573 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3U(lsize, &gt;=, psize);</span>
<span class="lineNum">    3574 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3U(compression_type, &gt;, ZIO_COMPRESS_OFF);</span>
<span class="lineNum">    3575 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3U(compression_type, &lt;, ZIO_COMPRESS_FUNCTIONS);</span>
<span class="lineNum">    3576 </span>                :            : 
<span class="lineNum">    3577 </span>                :<span class="lineNoCov">          0 :         arc_buf_hdr_t *hdr = arc_hdr_alloc(spa_load_guid(spa), psize, lsize,</span>
<span class="lineNum">    3578 </span>                :            :             B_FALSE, compression_type, ARC_BUFC_DATA, B_FALSE);
<span class="lineNum">    3579 </span>        [<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(!MUTEX_HELD(HDR_LOCK(hdr)));</span>
<span class="lineNum">    3580 </span>                :            : 
<span class="lineNum">    3581 </span>                :<span class="lineNoCov">          0 :         arc_buf_t *buf = NULL;</span>
<span class="lineNum">    3582 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         VERIFY0(arc_buf_alloc_impl(hdr, spa, 0, tag, B_FALSE,</span>
<span class="lineNum">    3583 </span>                :            :             B_TRUE, B_FALSE, B_FALSE, &amp;buf));
<span class="lineNum">    3584 </span>                :<span class="lineNoCov">          0 :         arc_buf_thaw(buf);</span>
<span class="lineNum">    3585 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3P(hdr-&gt;b_l1hdr.b_freeze_cksum, ==, NULL);</span>
<span class="lineNum">    3586 </span>                :            : 
<span class="lineNum">    3587 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!arc_buf_is_shared(buf)) {</span>
<span class="lineNum">    3588 </span>                :            :                 /*
<span class="lineNum">    3589 </span>                :            :                  * To ensure that the hdr has the correct data in it if we call
<span class="lineNum">    3590 </span>                :            :                  * arc_untransform() on this buf before it's been written to
<span class="lineNum">    3591 </span>                :            :                  * disk, it's easiest if we just set up sharing between the
<span class="lineNum">    3592 </span>                :            :                  * buf and the hdr.
<span class="lineNum">    3593 </span>                :            :                  */
<span class="lineNum">    3594 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT(!abd_is_linear(hdr-&gt;b_l1hdr.b_pabd));</span>
<span class="lineNum">    3595 </span>                :<span class="lineNoCov">          0 :                 arc_hdr_free_abd(hdr, B_FALSE);</span>
<span class="lineNum">    3596 </span>                :<span class="lineNoCov">          0 :                 arc_share_buf(hdr, buf);</span>
<span class="lineNum">    3597 </span>                :            :         }
<span class="lineNum">    3598 </span>                :            : 
<span class="lineNum">    3599 </span>                :<span class="lineNoCov">          0 :         return (buf);</span>
<span class="lineNum">    3600 </span>                :            : }
<a name="3601"><span class="lineNum">    3601 </span>                :            : </a>
<span class="lineNum">    3602 </span>                :            : arc_buf_t *
<span class="lineNum">    3603 </span>                :<span class="lineNoCov">          0 : arc_alloc_raw_buf(spa_t *spa, void *tag, uint64_t dsobj, boolean_t byteorder,</span>
<span class="lineNum">    3604 </span>                :            :     const uint8_t *salt, const uint8_t *iv, const uint8_t *mac,
<span class="lineNum">    3605 </span>                :            :     dmu_object_type_t ot, uint64_t psize, uint64_t lsize,
<span class="lineNum">    3606 </span>                :            :     enum zio_compress compression_type)
<span class="lineNum">    3607 </span>                :            : {
<span class="lineNum">    3608 </span>                :            :         arc_buf_hdr_t *hdr;
<span class="lineNum">    3609 </span>                :            :         arc_buf_t *buf;
<span class="lineNum">    3610 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         arc_buf_contents_t type = DMU_OT_IS_METADATA(ot) ?</span>
<span class="lineNum">    3611 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             ARC_BUFC_METADATA : ARC_BUFC_DATA;</span>
<span class="lineNum">    3612 </span>                :            : 
<span class="lineNum">    3613 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3U(lsize, &gt;, 0);</span>
<span class="lineNum">    3614 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3U(lsize, &gt;=, psize);</span>
<span class="lineNum">    3615 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3U(compression_type, &gt;=, ZIO_COMPRESS_OFF);</span>
<span class="lineNum">    3616 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3U(compression_type, &lt;, ZIO_COMPRESS_FUNCTIONS);</span>
<span class="lineNum">    3617 </span>                :            : 
<span class="lineNum">    3618 </span>                :<span class="lineNoCov">          0 :         hdr = arc_hdr_alloc(spa_load_guid(spa), psize, lsize, B_TRUE,</span>
<span class="lineNum">    3619 </span>                :            :             compression_type, type, B_TRUE);
<span class="lineNum">    3620 </span>        [<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(!MUTEX_HELD(HDR_LOCK(hdr)));</span>
<span class="lineNum">    3621 </span>                :            : 
<span class="lineNum">    3622 </span>                :<span class="lineNoCov">          0 :         hdr-&gt;b_crypt_hdr.b_dsobj = dsobj;</span>
<span class="lineNum">    3623 </span>                :<span class="lineNoCov">          0 :         hdr-&gt;b_crypt_hdr.b_ot = ot;</span>
<span class="lineNum">    3624 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         hdr-&gt;b_l1hdr.b_byteswap = (byteorder == ZFS_HOST_BYTEORDER) ?</span>
<span class="lineNum">    3625 </span>                :<span class="lineNoCov">          0 :             DMU_BSWAP_NUMFUNCS : DMU_OT_BYTESWAP(ot);</span>
<span class="lineNum">    3626 </span>                :<span class="lineNoCov">          0 :         bcopy(salt, hdr-&gt;b_crypt_hdr.b_salt, ZIO_DATA_SALT_LEN);</span>
<span class="lineNum">    3627 </span>                :<span class="lineNoCov">          0 :         bcopy(iv, hdr-&gt;b_crypt_hdr.b_iv, ZIO_DATA_IV_LEN);</span>
<span class="lineNum">    3628 </span>                :<span class="lineNoCov">          0 :         bcopy(mac, hdr-&gt;b_crypt_hdr.b_mac, ZIO_DATA_MAC_LEN);</span>
<span class="lineNum">    3629 </span>                :            : 
<span class="lineNum">    3630 </span>                :            :         /*
<span class="lineNum">    3631 </span>                :            :          * This buffer will be considered encrypted even if the ot is not an
<span class="lineNum">    3632 </span>                :            :          * encrypted type. It will become authenticated instead in
<span class="lineNum">    3633 </span>                :            :          * arc_write_ready().
<span class="lineNum">    3634 </span>                :            :          */
<span class="lineNum">    3635 </span>                :<span class="lineNoCov">          0 :         buf = NULL;</span>
<span class="lineNum">    3636 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         VERIFY0(arc_buf_alloc_impl(hdr, spa, dsobj, tag, B_TRUE, B_TRUE,</span>
<span class="lineNum">    3637 </span>                :            :             B_FALSE, B_FALSE, &amp;buf));
<span class="lineNum">    3638 </span>                :<span class="lineNoCov">          0 :         arc_buf_thaw(buf);</span>
<span class="lineNum">    3639 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3P(hdr-&gt;b_l1hdr.b_freeze_cksum, ==, NULL);</span>
<span class="lineNum">    3640 </span>                :            : 
<span class="lineNum">    3641 </span>                :<span class="lineNoCov">          0 :         return (buf);</span>
<span class="lineNum">    3642 </span>                :            : }
<a name="3643"><span class="lineNum">    3643 </span>                :            : </a>
<span class="lineNum">    3644 </span>                :            : static void
<span class="lineNum">    3645 </span>                :<span class="lineCov">       2947 : arc_hdr_l2hdr_destroy(arc_buf_hdr_t *hdr)</span>
<span class="lineNum">    3646 </span>                :            : {
<span class="lineNum">    3647 </span>                :<span class="lineCov">       2947 :         l2arc_buf_hdr_t *l2hdr = &amp;hdr-&gt;b_l2hdr;</span>
<span class="lineNum">    3648 </span>                :<span class="lineCov">       2947 :         l2arc_dev_t *dev = l2hdr-&gt;b_dev;</span>
<span class="lineNum">    3649 </span>                :<span class="lineCov">       2947 :         uint64_t psize = arc_hdr_size(hdr);</span>
<span class="lineNum">    3650 </span>                :            : 
<span class="lineNum">    3651 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 2947 times"> + </span>]:<span class="lineCov">       2947 :         ASSERT(MUTEX_HELD(&amp;dev-&gt;l2ad_mtx));</span>
<span class="lineNum">    3652 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2947 times"> + </span>]:<span class="lineCov">       2947 :         ASSERT(HDR_HAS_L2HDR(hdr));</span>
<span class="lineNum">    3653 </span>                :            : 
<span class="lineNum">    3654 </span>                :<span class="lineCov">       2947 :         list_remove(&amp;dev-&gt;l2ad_buflist, hdr);</span>
<span class="lineNum">    3655 </span>                :            : 
<span class="lineNum">    3656 </span>                :<span class="lineCov">       2947 :         ARCSTAT_INCR(arcstat_l2_psize, -psize);</span>
<span class="lineNum">    3657 </span>                :<span class="lineCov">       2947 :         ARCSTAT_INCR(arcstat_l2_lsize, -HDR_GET_LSIZE(hdr));</span>
<span class="lineNum">    3658 </span>                :            : 
<span class="lineNum">    3659 </span>                :<span class="lineCov">       2947 :         vdev_space_update(dev-&gt;l2ad_vdev, -psize, 0, 0);</span>
<span class="lineNum">    3660 </span>                :            : 
<span class="lineNum">    3661 </span>                :<span class="lineCov">       2947 :         (void) refcount_remove_many(&amp;dev-&gt;l2ad_alloc, psize, hdr);</span>
<span class="lineNum">    3662 </span>                :<span class="lineCov">       2947 :         arc_hdr_clear_flags(hdr, ARC_FLAG_HAS_L2HDR);</span>
<span class="lineNum">    3663 </span>                :<span class="lineCov">       2947 : }</span>
<a name="3664"><span class="lineNum">    3664 </span>                :            : </a>
<span class="lineNum">    3665 </span>                :            : static void
<span class="lineNum">    3666 </span>                :<span class="lineCov">    1499733 : arc_hdr_destroy(arc_buf_hdr_t *hdr)</span>
<span class="lineNum">    3667 </span>                :            : {
<span class="lineNum">    3668 </span>        [<span class="branchCov" title="Branch 0 was taken 1496962 times"> + </span><span class="branchCov" title="Branch 1 was taken 2771 times"> + </span>]:<span class="lineCov">    1499733 :         if (HDR_HAS_L1HDR(hdr)) {</span>
<span class="lineNum">    3669 </span>[<span class="branchCov" title="Branch 0 was taken 1202278 times"> + </span><span class="branchCov" title="Branch 1 was taken 294684 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1202278 times"> + </span>]:<span class="lineCov">    1496962 :                 ASSERT(hdr-&gt;b_l1hdr.b_buf == NULL ||</span>
<span class="lineNum">    3670 </span>                :            :                     hdr-&gt;b_l1hdr.b_bufcnt &gt; 0);
<span class="lineNum">    3671 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1497006 times"> + </span>]:<span class="lineCov">    1496962 :                 ASSERT(refcount_is_zero(&amp;hdr-&gt;b_l1hdr.b_refcnt));</span>
<span class="lineNum">    3672 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1497006 times"> + </span>]:<span class="lineCov">    1497006 :                 ASSERT3P(hdr-&gt;b_l1hdr.b_state, ==, arc_anon);</span>
<span class="lineNum">    3673 </span>                :            :         }
<span class="lineNum">    3674 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1499777 times"> + </span>]:<span class="lineCov">    1499777 :         ASSERT(!HDR_IO_IN_PROGRESS(hdr));</span>
<span class="lineNum">    3675 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1499777 times"> + </span>]:<span class="lineCov">    1499777 :         ASSERT(!HDR_IN_HASH_TABLE(hdr));</span>
<span class="lineNum">    3676 </span>                :            : 
<span class="lineNum">    3677 </span>[<span class="branchCov" title="Branch 0 was taken 1191907 times"> + </span><span class="branchCov" title="Branch 1 was taken 307870 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 89 times"> + </span><span class="branchCov" title="Branch 3 was taken 1191818 times"> + </span>]:<span class="lineCov">    1499777 :         if (!HDR_EMPTY(hdr))</span>
<span class="lineNum">    3678 </span>                :<span class="lineCov">     307959 :                 buf_discard_identity(hdr);</span>
<span class="lineNum">    3679 </span>                :            : 
<span class="lineNum">    3680 </span>        [<span class="branchCov" title="Branch 0 was taken 2894 times"> + </span><span class="branchCov" title="Branch 1 was taken 1496811 times"> + </span>]:<span class="lineCov">    1499705 :         if (HDR_HAS_L2HDR(hdr)) {</span>
<span class="lineNum">    3681 </span>                :<span class="lineCov">       2894 :                 l2arc_dev_t *dev = hdr-&gt;b_l2hdr.b_dev;</span>
<span class="lineNum">    3682 </span>                :<span class="lineCov">       2894 :                 boolean_t buflist_held = MUTEX_HELD(&amp;dev-&gt;l2ad_mtx);</span>
<span class="lineNum">    3683 </span>                :            : 
<span class="lineNum">    3684 </span>        [<span class="branchCov" title="Branch 0 was taken 150 times"> + </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>]:<span class="lineCov">       2894 :                 if (!buflist_held)</span>
<span class="lineNum">    3685 </span>                :<span class="lineCov">        150 :                         mutex_enter(&amp;dev-&gt;l2ad_mtx);</span>
<span class="lineNum">    3686 </span>                :            : 
<span class="lineNum">    3687 </span>                :            :                 /*
<span class="lineNum">    3688 </span>                :            :                  * Even though we checked this conditional above, we
<span class="lineNum">    3689 </span>                :            :                  * need to check this again now that we have the
<span class="lineNum">    3690 </span>                :            :                  * l2ad_mtx. This is because we could be racing with
<span class="lineNum">    3691 </span>                :            :                  * another thread calling l2arc_evict() which might have
<span class="lineNum">    3692 </span>                :            :                  * destroyed this header's L2 portion as we were waiting
<span class="lineNum">    3693 </span>                :            :                  * to acquire the l2ad_mtx. If that happens, we don't
<span class="lineNum">    3694 </span>                :            :                  * want to re-destroy the header's L2 portion.
<span class="lineNum">    3695 </span>                :            :                  */
<span class="lineNum">    3696 </span>        [<span class="branchCov" title="Branch 0 was taken 2894 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2894 :                 if (HDR_HAS_L2HDR(hdr))</span>
<span class="lineNum">    3697 </span>                :<span class="lineCov">       2894 :                         arc_hdr_l2hdr_destroy(hdr);</span>
<span class="lineNum">    3698 </span>                :            : 
<span class="lineNum">    3699 </span>        [<span class="branchCov" title="Branch 0 was taken 150 times"> + </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>]:<span class="lineCov">       2894 :                 if (!buflist_held)</span>
<span class="lineNum">    3700 </span>                :<span class="lineCov">        150 :                         mutex_exit(&amp;dev-&gt;l2ad_mtx);</span>
<span class="lineNum">    3701 </span>                :            :         }
<span class="lineNum">    3702 </span>                :            : 
<span class="lineNum">    3703 </span>        [<span class="branchCov" title="Branch 0 was taken 1496951 times"> + </span><span class="branchCov" title="Branch 1 was taken 2754 times"> + </span>]:<span class="lineCov">    1499705 :         if (HDR_HAS_L1HDR(hdr)) {</span>
<span class="lineNum">    3704 </span>                :<span class="lineCov">    1496951 :                 arc_cksum_free(hdr);</span>
<span class="lineNum">    3705 </span>                :            : 
<span class="lineNum">    3706 </span>        [<span class="branchCov" title="Branch 0 was taken 1202372 times"> + </span><span class="branchCov" title="Branch 1 was taken 1497121 times"> + </span>]:<span class="lineCov">    2699493 :                 while (hdr-&gt;b_l1hdr.b_buf != NULL)</span>
<span class="lineNum">    3707 </span>                :<span class="lineCov">    1202372 :                         arc_buf_destroy_impl(hdr-&gt;b_l1hdr.b_buf);</span>
<span class="lineNum">    3708 </span>                :            : 
<span class="lineNum">    3709 </span>        [<span class="branchCov" title="Branch 0 was taken 1226404 times"> + </span><span class="branchCov" title="Branch 1 was taken 270717 times"> + </span>]:<span class="lineCov">    1497121 :                 if (hdr-&gt;b_l1hdr.b_pabd != NULL) {</span>
<span class="lineNum">    3710 </span>                :<span class="lineCov">    1226404 :                         arc_hdr_free_abd(hdr, B_FALSE);</span>
<span class="lineNum">    3711 </span>                :            :                 }
<span class="lineNum">    3712 </span>                :            : 
<span class="lineNum">    3713 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1497199 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1497199 :                 if (HDR_HAS_RABD(hdr)) {</span>
<span class="lineNum">    3714 </span>                :<span class="lineNoCov">          0 :                         arc_hdr_free_abd(hdr, B_TRUE);</span>
<span class="lineNum">    3715 </span>                :            :                 }
<span class="lineNum">    3716 </span>                :            :         }
<span class="lineNum">    3717 </span>                :            : 
<span class="lineNum">    3718 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1499953 times"> + </span>]:<span class="lineCov">    1499953 :         ASSERT3P(hdr-&gt;b_hash_next, ==, NULL);</span>
<span class="lineNum">    3719 </span>        [<span class="branchCov" title="Branch 0 was taken 1497209 times"> + </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>]:<span class="lineCov">    1499953 :         if (HDR_HAS_L1HDR(hdr)) {</span>
<span class="lineNum">    3720 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1497166 times"> + </span>]:<span class="lineCov">    1497209 :                 ASSERT(!multilist_link_active(&amp;hdr-&gt;b_l1hdr.b_arc_node));</span>
<span class="lineNum">    3721 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1497166 times"> + </span>]:<span class="lineCov">    1497166 :                 ASSERT3P(hdr-&gt;b_l1hdr.b_acb, ==, NULL);</span>
<span class="lineNum">    3722 </span>                :            : 
<span class="lineNum">    3723 </span>        [<span class="branchCov" title="Branch 0 was taken 1497166 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    1497166 :                 if (!HDR_PROTECTED(hdr)) {</span>
<span class="lineNum">    3724 </span>                :<span class="lineCov">    1497166 :                         kmem_cache_free(hdr_full_cache, hdr);</span>
<span class="lineNum">    3725 </span>                :            :                 } else {
<span class="lineNum">    3726 </span>                :<span class="lineNoCov">          0 :                         kmem_cache_free(hdr_full_crypt_cache, hdr);</span>
<span class="lineNum">    3727 </span>                :            :                 }
<span class="lineNum">    3728 </span>                :            :         } else {
<span class="lineNum">    3729 </span>                :<span class="lineCov">       2744 :                 kmem_cache_free(hdr_l2only_cache, hdr);</span>
<span class="lineNum">    3730 </span>                :            :         }
<span class="lineNum">    3731 </span>                :<span class="lineCov">    1499932 : }</span>
<a name="3732"><span class="lineNum">    3732 </span>                :            : </a>
<span class="lineNum">    3733 </span>                :            : void
<span class="lineNum">    3734 </span>                :<span class="lineCov">    1638805 : arc_buf_destroy(arc_buf_t *buf, void* tag)</span>
<span class="lineNum">    3735 </span>                :            : {
<span class="lineNum">    3736 </span>                :<span class="lineCov">    1638805 :         arc_buf_hdr_t *hdr = buf-&gt;b_hdr;</span>
<span class="lineNum">    3737 </span>                :<span class="lineCov">    1638805 :         kmutex_t *hash_lock = HDR_LOCK(hdr);</span>
<span class="lineNum">    3738 </span>                :            : 
<span class="lineNum">    3739 </span>        [<span class="branchCov" title="Branch 0 was taken 1202369 times"> + </span><span class="branchCov" title="Branch 1 was taken 436428 times"> + </span>]:<span class="lineCov">    1638797 :         if (hdr-&gt;b_l1hdr.b_state == arc_anon) {</span>
<span class="lineNum">    3740 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1202369 times"> + </span>]:<span class="lineCov">    1202369 :                 ASSERT3U(hdr-&gt;b_l1hdr.b_bufcnt, ==, 1);</span>
<span class="lineNum">    3741 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1202369 times"> + </span>]:<span class="lineCov">    1202369 :                 ASSERT(!HDR_IO_IN_PROGRESS(hdr));</span>
<span class="lineNum">    3742 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1202414 times"> + </span>]:<span class="lineCov">    1202369 :                 VERIFY0(remove_reference(hdr, NULL, tag));</span>
<span class="lineNum">    3743 </span>                :<span class="lineCov">    1202414 :                 arc_hdr_destroy(hdr);</span>
<span class="lineNum">    3744 </span>                :<span class="lineCov">    1202373 :                 return;</span>
<span class="lineNum">    3745 </span>                :            :         }
<span class="lineNum">    3746 </span>                :            : 
<span class="lineNum">    3747 </span>                :<span class="lineCov">     436428 :         mutex_enter(hash_lock);</span>
<span class="lineNum">    3748 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 436433 times"> + </span>]:<span class="lineCov">     436433 :         ASSERT3P(hdr, ==, buf-&gt;b_hdr);</span>
<span class="lineNum">    3749 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 436433 times"> + </span>]:<span class="lineCov">     436433 :         ASSERT(hdr-&gt;b_l1hdr.b_bufcnt &gt; 0);</span>
<span class="lineNum">    3750 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 436425 times"> + </span>]:<span class="lineCov">     436433 :         ASSERT3P(hash_lock, ==, HDR_LOCK(hdr));</span>
<span class="lineNum">    3751 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 436425 times"> + </span>]:<span class="lineCov">     436425 :         ASSERT3P(hdr-&gt;b_l1hdr.b_state, !=, arc_anon);</span>
<span class="lineNum">    3752 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 436425 times"> + </span>]:<span class="lineCov">     436425 :         ASSERT3P(buf-&gt;b_data, !=, NULL);</span>
<span class="lineNum">    3753 </span>                :            : 
<span class="lineNum">    3754 </span>                :<span class="lineCov">     436425 :         (void) remove_reference(hdr, hash_lock, tag);</span>
<span class="lineNum">    3755 </span>                :<span class="lineCov">     436433 :         arc_buf_destroy_impl(buf);</span>
<span class="lineNum">    3756 </span>                :<span class="lineCov">     436440 :         mutex_exit(hash_lock);</span>
<span class="lineNum">    3757 </span>                :            : }
<span class="lineNum">    3758 </span>                :            : 
<span class="lineNum">    3759 </span>                :            : /*
<span class="lineNum">    3760 </span>                :            :  * Evict the arc_buf_hdr that is provided as a parameter. The resultant
<span class="lineNum">    3761 </span>                :            :  * state of the header is dependent on its state prior to entering this
<span class="lineNum">    3762 </span>                :            :  * function. The following transitions are possible:
<span class="lineNum">    3763 </span>                :            :  *
<span class="lineNum">    3764 </span>                :            :  *    - arc_mru -&gt; arc_mru_ghost
<span class="lineNum">    3765 </span>                :            :  *    - arc_mfu -&gt; arc_mfu_ghost
<span class="lineNum">    3766 </span>                :            :  *    - arc_mru_ghost -&gt; arc_l2c_only
<span class="lineNum">    3767 </span>                :            :  *    - arc_mru_ghost -&gt; deleted
<span class="lineNum">    3768 </span>                :            :  *    - arc_mfu_ghost -&gt; arc_l2c_only
<span class="lineNum">    3769 </span>                :            :  *    - arc_mfu_ghost -&gt; deleted
<a name="3770"><span class="lineNum">    3770 </span>                :            :  */</a>
<span class="lineNum">    3771 </span>                :            : static int64_t
<span class="lineNum">    3772 </span>                :<span class="lineCov"> 1023281679 : arc_evict_hdr(arc_buf_hdr_t *hdr, kmutex_t *hash_lock)</span>
<span class="lineNum">    3773 </span>                :            : {
<span class="lineNum">    3774 </span>                :            :         arc_state_t *evicted_state, *state;
<span class="lineNum">    3775 </span>                :<span class="lineCov"> 1023281679 :         int64_t bytes_evicted = 0;</span>
<span class="lineNum">    3776 </span>                :            : 
<span class="lineNum">    3777 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1023281679 times"> + </span>]:<span class="lineCov"> 1023281679 :         ASSERT(MUTEX_HELD(hash_lock));</span>
<span class="lineNum">    3778 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1023281679 times"> + </span>]:<span class="lineCov"> 1023281679 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    3779 </span>                :            : 
<span class="lineNum">    3780 </span>                :<span class="lineCov"> 1023281679 :         state = hdr-&gt;b_l1hdr.b_state;</span>
<span class="lineNum">    3781 </span>[<span class="branchCov" title="Branch 0 was taken 1023023492 times"> + </span><span class="branchCov" title="Branch 1 was taken 258187 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1023008634 times"> + </span><span class="branchCov" title="Branch 3 was taken 14858 times"> + </span>]:<span class="lineCov"> 1023281679 :         if (GHOST_STATE(state)) {</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 1023008634 times"> + </span>]
<span class="lineNum">    3782 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273045 times"> + </span>]:<span class="lineCov">     273045 :                 ASSERT(!HDR_IO_IN_PROGRESS(hdr));</span>
<span class="lineNum">    3783 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273045 times"> + </span>]:<span class="lineCov">     273045 :                 ASSERT3P(hdr-&gt;b_l1hdr.b_buf, ==, NULL);</span>
<span class="lineNum">    3784 </span>                :            : 
<span class="lineNum">    3785 </span>                :            :                 /*
<span class="lineNum">    3786 </span>                :            :                  * l2arc_write_buffers() relies on a header's L1 portion
<span class="lineNum">    3787 </span>                :            :                  * (i.e. its b_pabd field) during it's write phase.
<span class="lineNum">    3788 </span>                :            :                  * Thus, we cannot push a header onto the arc_l2c_only
<span class="lineNum">    3789 </span>                :            :                  * state (removing its L1 piece) until the header is
<span class="lineNum">    3790 </span>                :            :                  * done being written to the l2arc.
<span class="lineNum">    3791 </span>                :            :                  */
<span class="lineNum">    3792 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273045 times"> + </span>]:<span class="lineCov">     273045 :                 if (HDR_HAS_L2HDR(hdr) &amp;&amp; HDR_L2_WRITING(hdr)) {</span>
<span class="lineNum">    3793 </span>                :<span class="lineNoCov">          0 :                         ARCSTAT_BUMP(arcstat_evict_l2_skip);</span>
<span class="lineNum">    3794 </span>                :<span class="lineNoCov">          0 :                         return (bytes_evicted);</span>
<span class="lineNum">    3795 </span>                :            :                 }
<span class="lineNum">    3796 </span>                :            : 
<span class="lineNum">    3797 </span>                :<span class="lineCov">     273045 :                 ARCSTAT_BUMP(arcstat_deleted);</span>
<span class="lineNum">    3798 </span>                :<span class="lineCov">     273045 :                 bytes_evicted += HDR_GET_LSIZE(hdr);</span>
<span class="lineNum">    3799 </span>                :            : 
<span class="lineNum">    3800 </span>                :            :                 DTRACE_PROBE1(arc__delete, arc_buf_hdr_t *, hdr);
<span class="lineNum">    3801 </span>                :            : 
<span class="lineNum">    3802 </span>        [<span class="branchCov" title="Branch 0 was taken 2744 times"> + </span><span class="branchCov" title="Branch 1 was taken 270301 times"> + </span>]:<span class="lineCov">     273045 :                 if (HDR_HAS_L2HDR(hdr)) {</span>
<span class="lineNum">    3803 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>]:<span class="lineCov">       2744 :                         ASSERT(hdr-&gt;b_l1hdr.b_pabd == NULL);</span>
<span class="lineNum">    3804 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       2744 :                         ASSERT(!HDR_HAS_RABD(hdr));</span>
<span class="lineNum">    3805 </span>                :            :                         /*
<span class="lineNum">    3806 </span>                :            :                          * This buffer is cached on the 2nd Level ARC;
<span class="lineNum">    3807 </span>                :            :                          * don't destroy the header.
<span class="lineNum">    3808 </span>                :            :                          */
<span class="lineNum">    3809 </span>                :<span class="lineCov">       2744 :                         arc_change_state(arc_l2c_only, hdr, hash_lock);</span>
<span class="lineNum">    3810 </span>                :            :                         /*
<span class="lineNum">    3811 </span>                :            :                          * dropping from L1+L2 cached to L2-only,
<span class="lineNum">    3812 </span>                :            :                          * realloc to remove the L1 header.
<span class="lineNum">    3813 </span>                :            :                          */
<span class="lineNum">    3814 </span>                :<span class="lineCov">       2744 :                         hdr = arc_hdr_realloc(hdr, hdr_full_cache,</span>
<span class="lineNum">    3815 </span>                :            :                             hdr_l2only_cache);
<span class="lineNum">    3816 </span>                :            :                 } else {
<span class="lineNum">    3817 </span>                :<span class="lineCov">     270301 :                         arc_change_state(arc_anon, hdr, hash_lock);</span>
<span class="lineNum">    3818 </span>                :<span class="lineCov">     270301 :                         arc_hdr_destroy(hdr);</span>
<span class="lineNum">    3819 </span>                :            :                 }
<span class="lineNum">    3820 </span>                :            :                 return (bytes_evicted);
<span class="lineNum">    3821 </span>                :            :         }
<span class="lineNum">    3822 </span>                :            : 
<span class="lineNum">    3823 </span>[<span class="branchCov" title="Branch 0 was taken 1295619 times"> + </span><span class="branchCov" title="Branch 1 was taken 1021713015 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1295619 times"> + </span>]:<span class="lineCov"> 1023008634 :         ASSERT(state == arc_mru || state == arc_mfu);</span>
<span class="lineNum">    3824 </span>        [<span class="branchCov" title="Branch 0 was taken 1295619 times"> + </span><span class="branchCov" title="Branch 1 was taken 1021713015 times"> + </span>]:<span class="lineCov"> 1023008634 :         evicted_state = (state == arc_mru) ? arc_mru_ghost : arc_mfu_ghost;</span>
<span class="lineNum">    3825 </span>                :            : 
<span class="lineNum">    3826 </span>                :            :         /* prefetch buffers have a minimum lifespan */
<span class="lineNum">    3827 </span>[<span class="branchCov" title="Branch 0 was taken 1023008634 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1022925119 times"> + </span><span class="branchCov" title="Branch 3 was taken 83515 times"> + </span>]:<span class="lineCov"> 1023008634 :         if (HDR_IO_IN_PROGRESS(hdr) ||</span>
<span class="lineNum">    3828 </span>        [<span class="branchCov" title="Branch 0 was taken 1022735488 times"> + </span><span class="branchCov" title="Branch 1 was taken 189631 times"> + </span>]:<span class="lineCov"> 1022925119 :             ((hdr-&gt;b_flags &amp; (ARC_FLAG_PREFETCH | ARC_FLAG_INDIRECT)) &amp;&amp;</span>
<span class="lineNum">    3829 </span>                :<span class="lineCov"> 1022925119 :             ddi_get_lbolt() - hdr-&gt;b_l1hdr.b_arc_access &lt;</span>
<span class="lineNum">    3830 </span>                :            :             arc_min_prefetch_lifespan)) {
<span class="lineNum">    3831 </span>                :<span class="lineCov"> 1022735488 :                 ARCSTAT_BUMP(arcstat_evict_skip);</span>
<span class="lineNum">    3832 </span>                :<span class="lineCov"> 1022735488 :                 return (bytes_evicted);</span>
<span class="lineNum">    3833 </span>                :            :         }
<span class="lineNum">    3834 </span>                :            : 
<span class="lineNum">    3835 </span>        [<span class="branchCov" title="Branch 1 was taken 273146 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">     273146 :         ASSERT0(refcount_count(&amp;hdr-&gt;b_l1hdr.b_refcnt));</span>
<span class="lineNum">    3836 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>]:<span class="lineCov">     273146 :         while (hdr-&gt;b_l1hdr.b_buf) {</span>
<span class="lineNum">    3837 </span>                :<span class="lineNoCov">          0 :                 arc_buf_t *buf = hdr-&gt;b_l1hdr.b_buf;</span>
<span class="lineNum">    3838 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (!mutex_tryenter(&amp;buf-&gt;b_evict_lock)) {</span>
<span class="lineNum">    3839 </span>                :<span class="lineNoCov">          0 :                         ARCSTAT_BUMP(arcstat_mutex_miss);</span>
<span class="lineNum">    3840 </span>                :<span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    3841 </span>                :            :                 }
<span class="lineNum">    3842 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (buf-&gt;b_data != NULL)</span>
<span class="lineNum">    3843 </span>                :<span class="lineNoCov">          0 :                         bytes_evicted += HDR_GET_LSIZE(hdr);</span>
<span class="lineNum">    3844 </span>                :<span class="lineNoCov">          0 :                 mutex_exit(&amp;buf-&gt;b_evict_lock);</span>
<span class="lineNum">    3845 </span>                :<span class="lineNoCov">          0 :                 arc_buf_destroy_impl(buf);</span>
<span class="lineNum">    3846 </span>                :            :         }
<span class="lineNum">    3847 </span>                :            : 
<span class="lineNum">    3848 </span>        [<span class="branchCov" title="Branch 0 was taken 2744 times"> + </span><span class="branchCov" title="Branch 1 was taken 270402 times"> + </span>]:<span class="lineCov">     273146 :         if (HDR_HAS_L2HDR(hdr)) {</span>
<span class="lineNum">    3849 </span>                :<span class="lineCov">       2744 :                 ARCSTAT_INCR(arcstat_evict_l2_cached, HDR_GET_LSIZE(hdr));</span>
<span class="lineNum">    3850 </span>                :            :         } else {
<span class="lineNum">    3851 </span>        [<span class="branchCov" title="Branch 1 was taken 84651 times"> + </span><span class="branchCov" title="Branch 2 was taken 185751 times"> + </span>]:<span class="lineCov">     270402 :                 if (l2arc_write_eligible(hdr-&gt;b_spa, hdr)) {</span>
<span class="lineNum">    3852 </span>                :<span class="lineCov">      84651 :                         ARCSTAT_INCR(arcstat_evict_l2_eligible,</span>
<span class="lineNum">    3853 </span>                :            :                             HDR_GET_LSIZE(hdr));
<span class="lineNum">    3854 </span>                :            :                 } else {
<span class="lineNum">    3855 </span>                :<span class="lineCov">     185751 :                         ARCSTAT_INCR(arcstat_evict_l2_ineligible,</span>
<span class="lineNum">    3856 </span>                :            :                             HDR_GET_LSIZE(hdr));
<span class="lineNum">    3857 </span>                :            :                 }
<span class="lineNum">    3858 </span>                :            :         }
<span class="lineNum">    3859 </span>                :            : 
<span class="lineNum">    3860 </span>        [<span class="branchCov" title="Branch 0 was taken 273146 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     273146 :         if (hdr-&gt;b_l1hdr.b_bufcnt == 0) {</span>
<span class="lineNum">    3861 </span>                :<span class="lineCov">     273146 :                 arc_cksum_free(hdr);</span>
<span class="lineNum">    3862 </span>                :            : 
<span class="lineNum">    3863 </span>                :<span class="lineCov">     273146 :                 bytes_evicted += arc_hdr_size(hdr);</span>
<span class="lineNum">    3864 </span>                :            : 
<span class="lineNum">    3865 </span>                :            :                 /*
<span class="lineNum">    3866 </span>                :            :                  * If this hdr is being evicted and has a compressed
<span class="lineNum">    3867 </span>                :            :                  * buffer then we discard it here before we change states.
<span class="lineNum">    3868 </span>                :            :                  * This ensures that the accounting is updated correctly
<span class="lineNum">    3869 </span>                :            :                  * in arc_free_data_impl().
<span class="lineNum">    3870 </span>                :            :                  */
<span class="lineNum">    3871 </span>        [<span class="branchCov" title="Branch 0 was taken 273146 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     273146 :                 if (hdr-&gt;b_l1hdr.b_pabd != NULL)</span>
<span class="lineNum">    3872 </span>                :<span class="lineCov">     273146 :                         arc_hdr_free_abd(hdr, B_FALSE);</span>
<span class="lineNum">    3873 </span>                :            : 
<span class="lineNum">    3874 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     273146 :                 if (HDR_HAS_RABD(hdr))</span>
<span class="lineNum">    3875 </span>                :<span class="lineNoCov">          0 :                         arc_hdr_free_abd(hdr, B_TRUE);</span>
<span class="lineNum">    3876 </span>                :            : 
<span class="lineNum">    3877 </span>                :<span class="lineCov">     273146 :                 arc_change_state(evicted_state, hdr, hash_lock);</span>
<span class="lineNum">    3878 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 273146 times"> + </span>]:<span class="lineCov">     273146 :                 ASSERT(HDR_IN_HASH_TABLE(hdr));</span>
<span class="lineNum">    3879 </span>                :<span class="lineCov">     273146 :                 arc_hdr_set_flags(hdr, ARC_FLAG_IN_HASH_TABLE);</span>
<span class="lineNum">    3880 </span>                :            :                 DTRACE_PROBE1(arc__evict, arc_buf_hdr_t *, hdr);
<span class="lineNum">    3881 </span>                :            :         }
<span class="lineNum">    3882 </span>                :            : 
<span class="lineNum">    3883 </span>                :            :         return (bytes_evicted);
<span class="lineNum">    3884 </span>                :            : }
<a name="3885"><span class="lineNum">    3885 </span>                :            : </a>
<span class="lineNum">    3886 </span>                :            : static uint64_t
<span class="lineNum">    3887 </span>                :<span class="lineCov">  497751326 : arc_evict_state_impl(multilist_t *ml, int idx, arc_buf_hdr_t *marker,</span>
<span class="lineNum">    3888 </span>                :            :     uint64_t spa, int64_t bytes)
<span class="lineNum">    3889 </span>                :            : {
<span class="lineNum">    3890 </span>                :            :         multilist_sublist_t *mls;
<span class="lineNum">    3891 </span>                :<span class="lineCov">  497751326 :         uint64_t bytes_evicted = 0;</span>
<span class="lineNum">    3892 </span>                :            :         arc_buf_hdr_t *hdr;
<span class="lineNum">    3893 </span>                :            :         kmutex_t *hash_lock;
<span class="lineNum">    3894 </span>                :<span class="lineCov">  497751326 :         int evict_count = 0;</span>
<span class="lineNum">    3895 </span>                :            : 
<span class="lineNum">    3896 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 497751326 times"> + </span>]:<span class="lineCov">  497751326 :         ASSERT3P(marker, !=, NULL);</span>
<span class="lineNum">    3897 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 497751326 times"> + </span>]:<span class="lineCov">  497751326 :         IMPLY(bytes &lt; 0, bytes == ARC_EVICT_ALL);</span>
<span class="lineNum">    3898 </span>                :            : 
<span class="lineNum">    3899 </span>                :<span class="lineCov">  497751326 :         mls = multilist_sublist_lock(ml, idx);</span>
<span class="lineNum">    3900 </span>                :            : 
<span class="lineNum">    3901 </span>        [<span class="branchCov" title="Branch 1 was taken 1023330783 times"> + </span><span class="branchCov" title="Branch 2 was taken 497713352 times"> + </span>]:<span class="lineCov"> 1521044135 :         for (hdr = multilist_sublist_prev(mls, marker); hdr != NULL;</span>
<span class="lineNum">    3902 </span>                :<span class="lineCov"> 1023292809 :             hdr = multilist_sublist_prev(mls, marker)) {</span>
<span class="lineNum">    3903 </span>[<span class="branchCov" title="Branch 0 was taken 1023330775 times"> + </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1023292809 times"> + </span><span class="branchCov" title="Branch 3 was taken 37966 times"> + </span>]:<span class="lineCov"> 1023330783 :                 if ((bytes != ARC_EVICT_ALL &amp;&amp; bytes_evicted &gt;= bytes) ||</span>
<span class="lineNum">    3904 </span>                :<span class="lineCov"> 1023330775 :                     (evict_count &gt;= zfs_arc_evict_batch_limit))</span>
<span class="lineNum">    3905 </span>                :            :                         break;
<span class="lineNum">    3906 </span>                :            : 
<span class="lineNum">    3907 </span>                :            :                 /*
<span class="lineNum">    3908 </span>                :            :                  * To keep our iteration location, move the marker
<span class="lineNum">    3909 </span>                :            :                  * forward. Since we're not holding hdr's hash lock, we
<span class="lineNum">    3910 </span>                :            :                  * must be very careful and not remove 'hdr' from the
<span class="lineNum">    3911 </span>                :            :                  * sublist. Otherwise, other consumers might mistake the
<span class="lineNum">    3912 </span>                :            :                  * 'hdr' as not being on a sublist when they call the
<span class="lineNum">    3913 </span>                :            :                  * multilist_link_active() function (they all rely on
<span class="lineNum">    3914 </span>                :            :                  * the hash lock protecting concurrent insertions and
<span class="lineNum">    3915 </span>                :            :                  * removals). multilist_sublist_move_forward() was
<span class="lineNum">    3916 </span>                :            :                  * specifically implemented to ensure this is the case
<span class="lineNum">    3917 </span>                :            :                  * (only 'marker' will be removed and re-inserted).
<span class="lineNum">    3918 </span>                :            :                  */
<span class="lineNum">    3919 </span>                :<span class="lineCov"> 1023292809 :                 multilist_sublist_move_forward(mls, marker);</span>
<span class="lineNum">    3920 </span>                :            : 
<span class="lineNum">    3921 </span>                :            :                 /*
<span class="lineNum">    3922 </span>                :            :                  * The only case where the b_spa field should ever be
<span class="lineNum">    3923 </span>                :            :                  * zero, is the marker headers inserted by
<span class="lineNum">    3924 </span>                :            :                  * arc_evict_state(). It's possible for multiple threads
<span class="lineNum">    3925 </span>                :            :                  * to be calling arc_evict_state() concurrently (e.g.
<span class="lineNum">    3926 </span>                :            :                  * dsl_pool_close() and zio_inject_fault()), so we must
<span class="lineNum">    3927 </span>                :            :                  * skip any markers we see from these other threads.
<span class="lineNum">    3928 </span>                :            :                  */
<span class="lineNum">    3929 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1023292809 times"> + </span>]:<span class="lineCov"> 1023292809 :                 if (hdr-&gt;b_spa == 0)</span>
<span class="lineNum">    3930 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    3931 </span>                :            : 
<span class="lineNum">    3932 </span>                :            :                 /* we're only interested in evicting buffers of a certain spa */
<span class="lineNum">    3933 </span>[<span class="branchCov" title="Branch 0 was taken 397762 times"> + </span><span class="branchCov" title="Branch 1 was taken 1022895047 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 11110 times"> + </span><span class="branchCov" title="Branch 3 was taken 386652 times"> + </span>]:<span class="lineCov"> 1023292809 :                 if (spa != 0 &amp;&amp; hdr-&gt;b_spa != spa) {</span>
<span class="lineNum">    3934 </span>                :<span class="lineCov">      11110 :                         ARCSTAT_BUMP(arcstat_evict_skip);</span>
<span class="lineNum">    3935 </span>                :<span class="lineCov">      11110 :                         continue;</span>
<span class="lineNum">    3936 </span>                :            :                 }
<span class="lineNum">    3937 </span>                :            : 
<span class="lineNum">    3938 </span>                :<span class="lineCov"> 1023281699 :                 hash_lock = HDR_LOCK(hdr);</span>
<span class="lineNum">    3939 </span>                :            : 
<span class="lineNum">    3940 </span>                :            :                 /*
<span class="lineNum">    3941 </span>                :            :                  * We aren't calling this function from any code path
<span class="lineNum">    3942 </span>                :            :                  * that would already be holding a hash lock, so we're
<span class="lineNum">    3943 </span>                :            :                  * asserting on this assumption to be defensive in case
<span class="lineNum">    3944 </span>                :            :                  * this ever changes. Without this check, it would be
<span class="lineNum">    3945 </span>                :            :                  * possible to incorrectly increment arcstat_mutex_miss
<span class="lineNum">    3946 </span>                :            :                  * below (e.g. if the code changed such that we called
<span class="lineNum">    3947 </span>                :            :                  * this function with a hash lock held).
<span class="lineNum">    3948 </span>                :            :                  */
<span class="lineNum">    3949 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1023281699 times"> + </span>]:<span class="lineCov"> 1023281699 :                 ASSERT(!MUTEX_HELD(hash_lock));</span>
<span class="lineNum">    3950 </span>                :            : 
<span class="lineNum">    3951 </span>        [<span class="branchCov" title="Branch 1 was taken 1023281679 times"> + </span><span class="branchCov" title="Branch 2 was taken 20 times"> + </span>]:<span class="lineCov"> 1023281699 :                 if (mutex_tryenter(hash_lock)) {</span>
<span class="lineNum">    3952 </span>                :<span class="lineCov"> 1023281679 :                         uint64_t evicted = arc_evict_hdr(hdr, hash_lock);</span>
<span class="lineNum">    3953 </span>                :<span class="lineCov"> 1023281679 :                         mutex_exit(hash_lock);</span>
<span class="lineNum">    3954 </span>                :            : 
<span class="lineNum">    3955 </span>                :<span class="lineCov"> 1023281679 :                         bytes_evicted += evicted;</span>
<span class="lineNum">    3956 </span>                :            : 
<span class="lineNum">    3957 </span>                :            :                         /*
<span class="lineNum">    3958 </span>                :            :                          * If evicted is zero, arc_evict_hdr() must have
<span class="lineNum">    3959 </span>                :            :                          * decided to skip this header, don't increment
<span class="lineNum">    3960 </span>                :            :                          * evict_count in this case.
<span class="lineNum">    3961 </span>                :            :                          */
<span class="lineNum">    3962 </span>        [<span class="branchCov" title="Branch 0 was taken 546191 times"> + </span><span class="branchCov" title="Branch 1 was taken 1022735488 times"> + </span>]:<span class="lineCov"> 1023281679 :                         if (evicted != 0)</span>
<span class="lineNum">    3963 </span>                :<span class="lineCov">     546191 :                                 evict_count++;</span>
<span class="lineNum">    3964 </span>                :            : 
<span class="lineNum">    3965 </span>                :            :                         /*
<span class="lineNum">    3966 </span>                :            :                          * If arc_size isn't overflowing, signal any
<span class="lineNum">    3967 </span>                :            :                          * threads that might happen to be waiting.
<span class="lineNum">    3968 </span>                :            :                          *
<span class="lineNum">    3969 </span>                :            :                          * For each header evicted, we wake up a single
<span class="lineNum">    3970 </span>                :            :                          * thread. If we used cv_broadcast, we could
<span class="lineNum">    3971 </span>                :            :                          * wake up &quot;too many&quot; threads causing arc_size
<span class="lineNum">    3972 </span>                :            :                          * to significantly overflow arc_c; since
<span class="lineNum">    3973 </span>                :            :                          * arc_get_data_impl() doesn't check for overflow
<span class="lineNum">    3974 </span>                :            :                          * when it's woken up (it doesn't because it's
<span class="lineNum">    3975 </span>                :            :                          * possible for the ARC to be overflowing while
<span class="lineNum">    3976 </span>                :            :                          * full of un-evictable buffers, and the
<span class="lineNum">    3977 </span>                :            :                          * function should proceed in this case).
<span class="lineNum">    3978 </span>                :            :                          *
<span class="lineNum">    3979 </span>                :            :                          * If threads are left sleeping, due to not
<span class="lineNum">    3980 </span>                :            :                          * using cv_broadcast, they will be woken up
<span class="lineNum">    3981 </span>                :            :                          * just before arc_reclaim_thread() sleeps.
<span class="lineNum">    3982 </span>                :            :                          */
<span class="lineNum">    3983 </span>                :<span class="lineCov"> 1023281679 :                         mutex_enter(&amp;arc_reclaim_lock);</span>
<span class="lineNum">    3984 </span>        [<span class="branchCov" title="Branch 1 was taken 1023281679 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov"> 1023281679 :                         if (!arc_is_overflowing())</span>
<span class="lineNum">    3985 </span>                :<span class="lineCov"> 1023281679 :                                 cv_signal(&amp;arc_reclaim_waiters_cv);</span>
<span class="lineNum">    3986 </span>                :<span class="lineCov"> 1023281679 :                         mutex_exit(&amp;arc_reclaim_lock);</span>
<span class="lineNum">    3987 </span>                :            :                 } else {
<span class="lineNum">    3988 </span>                :<span class="lineCov">         20 :                         ARCSTAT_BUMP(arcstat_mutex_miss);</span>
<span class="lineNum">    3989 </span>                :            :                 }
<span class="lineNum">    3990 </span>                :            :         }
<span class="lineNum">    3991 </span>                :            : 
<span class="lineNum">    3992 </span>                :<span class="lineCov">  497751326 :         multilist_sublist_unlock(mls);</span>
<span class="lineNum">    3993 </span>                :            : 
<span class="lineNum">    3994 </span>                :<span class="lineCov">  497751326 :         return (bytes_evicted);</span>
<span class="lineNum">    3995 </span>                :            : }
<span class="lineNum">    3996 </span>                :            : 
<span class="lineNum">    3997 </span>                :            : /*
<span class="lineNum">    3998 </span>                :            :  * Evict buffers from the given arc state, until we've removed the
<span class="lineNum">    3999 </span>                :            :  * specified number of bytes. Move the removed buffers to the
<span class="lineNum">    4000 </span>                :            :  * appropriate evict state.
<span class="lineNum">    4001 </span>                :            :  *
<span class="lineNum">    4002 </span>                :            :  * This function makes a &quot;best effort&quot;. It skips over any buffers
<span class="lineNum">    4003 </span>                :            :  * it can't get a hash_lock on, and so, may not catch all candidates.
<span class="lineNum">    4004 </span>                :            :  * It may also return without evicting as much space as requested.
<span class="lineNum">    4005 </span>                :            :  *
<span class="lineNum">    4006 </span>                :            :  * If bytes is specified using the special value ARC_EVICT_ALL, this
<span class="lineNum">    4007 </span>                :            :  * will evict all available (i.e. unlocked and evictable) buffers from
<span class="lineNum">    4008 </span>                :            :  * the given arc state; which is used by arc_flush().
<a name="4009"><span class="lineNum">    4009 </span>                :            :  */</a>
<span class="lineNum">    4010 </span>                :            : static uint64_t
<span class="lineNum">    4011 </span>                :<span class="lineCov">   62194856 : arc_evict_state(arc_state_t *state, uint64_t spa, int64_t bytes,</span>
<span class="lineNum">    4012 </span>                :            :     arc_buf_contents_t type)
<span class="lineNum">    4013 </span>                :            : {
<span class="lineNum">    4014 </span>                :<span class="lineCov">   62194856 :         uint64_t total_evicted = 0;</span>
<span class="lineNum">    4015 </span>                :<span class="lineCov">   62194856 :         multilist_t *ml = state-&gt;arcs_list[type];</span>
<span class="lineNum">    4016 </span>                :            :         int num_sublists;
<span class="lineNum">    4017 </span>                :            :         arc_buf_hdr_t **markers;
<span class="lineNum">    4018 </span>                :            :         int i;
<span class="lineNum">    4019 </span>                :            : 
<span class="lineNum">    4020 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 62194856 times"> + </span>]:<span class="lineCov">   62194856 :         IMPLY(bytes &lt; 0, bytes == ARC_EVICT_ALL);</span>
<span class="lineNum">    4021 </span>                :            : 
<span class="lineNum">    4022 </span>                :<span class="lineCov">   62194856 :         num_sublists = multilist_get_num_sublists(ml);</span>
<span class="lineNum">    4023 </span>                :            : 
<span class="lineNum">    4024 </span>                :            :         /*
<span class="lineNum">    4025 </span>                :            :          * If we've tried to evict from each sublist, made some
<span class="lineNum">    4026 </span>                :            :          * progress, but still have not hit the target number of bytes
<span class="lineNum">    4027 </span>                :            :          * to evict, we want to keep trying. The markers allow us to
<span class="lineNum">    4028 </span>                :            :          * pick up where we left off for each individual sublist, rather
<span class="lineNum">    4029 </span>                :            :          * than starting from the tail each time.
<span class="lineNum">    4030 </span>                :            :          */
<span class="lineNum">    4031 </span>                :<span class="lineCov">   62194856 :         markers = kmem_zalloc(sizeof (*markers) * num_sublists, KM_SLEEP);</span>
<span class="lineNum">    4032 </span>        [<span class="branchCov" title="Branch 1 was taken 497558848 times"> + </span><span class="branchCov" title="Branch 2 was taken 62194856 times"> + </span>]:<span class="lineCov">  559753704 :         for (i = 0; i &lt; num_sublists; i++) {</span>
<span class="lineNum">    4033 </span>                :            :                 multilist_sublist_t *mls;
<span class="lineNum">    4034 </span>                :            : 
<span class="lineNum">    4035 </span>                :<span class="lineCov">  497558848 :                 markers[i] = kmem_cache_alloc(hdr_full_cache, KM_SLEEP);</span>
<span class="lineNum">    4036 </span>                :            : 
<span class="lineNum">    4037 </span>                :            :                 /*
<span class="lineNum">    4038 </span>                :            :                  * A b_spa of 0 is used to indicate that this header is
<span class="lineNum">    4039 </span>                :            :                  * a marker. This fact is used in arc_adjust_type() and
<span class="lineNum">    4040 </span>                :            :                  * arc_evict_state_impl().
<span class="lineNum">    4041 </span>                :            :                  */
<span class="lineNum">    4042 </span>                :<span class="lineCov">  497558848 :                 markers[i]-&gt;b_spa = 0;</span>
<span class="lineNum">    4043 </span>                :            : 
<span class="lineNum">    4044 </span>                :<span class="lineCov">  497558848 :                 mls = multilist_sublist_lock(ml, i);</span>
<span class="lineNum">    4045 </span>                :<span class="lineCov">  497558848 :                 multilist_sublist_insert_tail(mls, markers[i]);</span>
<span class="lineNum">    4046 </span>                :<span class="lineCov">  497558848 :                 multilist_sublist_unlock(mls);</span>
<span class="lineNum">    4047 </span>                :            :         }
<span class="lineNum">    4048 </span>                :            : 
<span class="lineNum">    4049 </span>                :            :         /*
<span class="lineNum">    4050 </span>                :            :          * While we haven't hit our target number of bytes to evict, or
<span class="lineNum">    4051 </span>                :            :          * we're evicting all available buffers.
<span class="lineNum">    4052 </span>                :            :          */
<span class="lineNum">    4053 </span>        [<span class="branchCov" title="Branch 0 was taken 62218922 times"> + </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>]:<span class="lineCov">   62218936 :         while (total_evicted &lt; bytes || bytes == ARC_EVICT_ALL) {</span>
<span class="lineNum">    4054 </span>                :<span class="lineCov">   62218922 :                 int sublist_idx = multilist_get_random_index(ml);</span>
<span class="lineNum">    4055 </span>                :<span class="lineCov">   62218922 :                 uint64_t scan_evicted = 0;</span>
<span class="lineNum">    4056 </span>                :            : 
<span class="lineNum">    4057 </span>                :            :                 /*
<span class="lineNum">    4058 </span>                :            :                  * Try to reduce pinned dnodes with a floor of arc_dnode_limit.
<span class="lineNum">    4059 </span>                :            :                  * Request that 10% of the LRUs be scanned by the superblock
<span class="lineNum">    4060 </span>                :            :                  * shrinker.
<span class="lineNum">    4061 </span>                :            :                  */
<span class="lineNum">    4062 </span>[<span class="branchCov" title="Branch 0 was taken 11666519 times"> + </span><span class="branchCov" title="Branch 1 was taken 50552403 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 11666519 times"> + </span>]:<span class="lineCov">   62218922 :                 if (type == ARC_BUFC_DATA &amp;&amp; arc_dnode_size &gt; arc_dnode_limit)</span>
<span class="lineNum">    4063 </span>                :<span class="lineCov">   62218922 :                         arc_prune_async((arc_dnode_size - arc_dnode_limit) /</span>
<span class="lineNum">    4064 </span>                :<span class="lineNoCov">          0 :                             sizeof (dnode_t) / zfs_arc_dnode_reduce_percent);</span>
<span class="lineNum">    4065 </span>                :            : 
<span class="lineNum">    4066 </span>                :            :                 /*
<span class="lineNum">    4067 </span>                :            :                  * Start eviction using a randomly selected sublist,
<span class="lineNum">    4068 </span>                :            :                  * this is to try and evenly balance eviction across all
<span class="lineNum">    4069 </span>                :            :                  * sublists. Always starting at the same sublist
<span class="lineNum">    4070 </span>                :            :                  * (e.g. index 0) would cause evictions to favor certain
<span class="lineNum">    4071 </span>                :            :                  * sublists over others.
<span class="lineNum">    4072 </span>                :            :                  */
<span class="lineNum">    4073 </span>        [<span class="branchCov" title="Branch 0 was taken 497751338 times"> + </span><span class="branchCov" title="Branch 1 was taken 62218910 times"> + </span>]:<span class="lineCov">  559970248 :                 for (i = 0; i &lt; num_sublists; i++) {</span>
<span class="lineNum">    4074 </span>                :            :                         uint64_t bytes_remaining;
<span class="lineNum">    4075 </span>                :            :                         uint64_t bytes_evicted;
<span class="lineNum">    4076 </span>                :            : 
<span class="lineNum">    4077 </span>        [<span class="branchCov" title="Branch 0 was taken 426 times"> + </span><span class="branchCov" title="Branch 1 was taken 497750912 times"> + </span>]:<span class="lineCov">  497751338 :                         if (bytes == ARC_EVICT_ALL)</span>
<span class="lineNum">    4078 </span>                :            :                                 bytes_remaining = ARC_EVICT_ALL;
<span class="lineNum">    4079 </span>        [<span class="branchCov" title="Branch 0 was taken 414 times"> + </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>]:<span class="lineCov">        426 :                         else if (total_evicted &lt; bytes)</span>
<span class="lineNum">    4080 </span>                :<span class="lineCov">        414 :                                 bytes_remaining = bytes - total_evicted;</span>
<span class="lineNum">    4081 </span>                :            :                         else
<span class="lineNum">    4082 </span>                :            :                                 break;
<span class="lineNum">    4083 </span>                :            : 
<span class="lineNum">    4084 </span>                :<span class="lineCov">  497751326 :                         bytes_evicted = arc_evict_state_impl(ml, sublist_idx,</span>
<span class="lineNum">    4085 </span>                :<span class="lineCov">  497751326 :                             markers[sublist_idx], spa, bytes_remaining);</span>
<span class="lineNum">    4086 </span>                :            : 
<span class="lineNum">    4087 </span>                :<span class="lineCov">  497751326 :                         scan_evicted += bytes_evicted;</span>
<span class="lineNum">    4088 </span>                :<span class="lineCov">  497751326 :                         total_evicted += bytes_evicted;</span>
<span class="lineNum">    4089 </span>                :            : 
<span class="lineNum">    4090 </span>                :            :                         /* we've reached the end, wrap to the beginning */
<span class="lineNum">    4091 </span>        [<span class="branchCov" title="Branch 0 was taken 62218916 times"> + </span><span class="branchCov" title="Branch 1 was taken 435532410 times"> + </span>]:<span class="lineCov">  497751326 :                         if (++sublist_idx &gt;= num_sublists)</span>
<span class="lineNum">    4092 </span>                :<span class="lineCov">   62218916 :                                 sublist_idx = 0;</span>
<span class="lineNum">    4093 </span>                :            :                 }
<span class="lineNum">    4094 </span>                :            : 
<span class="lineNum">    4095 </span>                :            :                 /*
<span class="lineNum">    4096 </span>                :            :                  * If we didn't evict anything during this scan, we have
<span class="lineNum">    4097 </span>                :            :                  * no reason to believe we'll evict more during another
<span class="lineNum">    4098 </span>                :            :                  * scan, so break the loop.
<span class="lineNum">    4099 </span>                :            :                  */
<span class="lineNum">    4100 </span>        [<span class="branchCov" title="Branch 0 was taken 24080 times"> + </span><span class="branchCov" title="Branch 1 was taken 62194842 times"> + </span>]:<span class="lineCov">   62218922 :                 if (scan_evicted == 0) {</span>
<span class="lineNum">    4101 </span>                :            :                         /* This isn't possible, let's make that obvious */
<span class="lineNum">    4102 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 62194842 times"> + </span>]:<span class="lineCov">   62194842 :                         ASSERT3S(bytes, !=, 0);</span>
<span class="lineNum">    4103 </span>                :            : 
<span class="lineNum">    4104 </span>                :            :                         /*
<span class="lineNum">    4105 </span>                :            :                          * When bytes is ARC_EVICT_ALL, the only way to
<span class="lineNum">    4106 </span>                :            :                          * break the loop is when scan_evicted is zero.
<span class="lineNum">    4107 </span>                :            :                          * In that case, we actually have evicted enough,
<span class="lineNum">    4108 </span>                :            :                          * so we don't want to increment the kstat.
<span class="lineNum">    4109 </span>                :            :                          */
<span class="lineNum">    4110 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 62194842 times"> + </span>]:<span class="lineCov">   62194842 :                         if (bytes != ARC_EVICT_ALL) {</span>
<span class="lineNum">    4111 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 ASSERT3S(total_evicted, &lt;, bytes);</span>
<span class="lineNum">    4112 </span>                :<span class="lineCov">   62194856 :                                 ARCSTAT_BUMP(arcstat_evict_not_enough);</span>
<span class="lineNum">    4113 </span>                :            :                         }
<span class="lineNum">    4114 </span>                :            : 
<span class="lineNum">    4115 </span>                :            :                         break;
<span class="lineNum">    4116 </span>                :            :                 }
<span class="lineNum">    4117 </span>                :            :         }
<span class="lineNum">    4118 </span>                :            : 
<span class="lineNum">    4119 </span>        [<span class="branchCov" title="Branch 0 was taken 497558848 times"> + </span><span class="branchCov" title="Branch 1 was taken 62194856 times"> + </span>]:<span class="lineCov">  559753704 :         for (i = 0; i &lt; num_sublists; i++) {</span>
<span class="lineNum">    4120 </span>                :<span class="lineCov">  497558848 :                 multilist_sublist_t *mls = multilist_sublist_lock(ml, i);</span>
<span class="lineNum">    4121 </span>                :<span class="lineCov">  497558848 :                 multilist_sublist_remove(mls, markers[i]);</span>
<span class="lineNum">    4122 </span>                :<span class="lineCov">  497558848 :                 multilist_sublist_unlock(mls);</span>
<span class="lineNum">    4123 </span>                :            : 
<span class="lineNum">    4124 </span>                :<span class="lineCov">  497558848 :                 kmem_cache_free(hdr_full_cache, markers[i]);</span>
<span class="lineNum">    4125 </span>                :            :         }
<span class="lineNum">    4126 </span>                :<span class="lineCov">   62194856 :         kmem_free(markers, sizeof (*markers) * num_sublists);</span>
<span class="lineNum">    4127 </span>                :            : 
<span class="lineNum">    4128 </span>                :<span class="lineCov">   62194856 :         return (total_evicted);</span>
<span class="lineNum">    4129 </span>                :            : }
<span class="lineNum">    4130 </span>                :            : 
<span class="lineNum">    4131 </span>                :            : /*
<span class="lineNum">    4132 </span>                :            :  * Flush all &quot;evictable&quot; data of the given type from the arc state
<span class="lineNum">    4133 </span>                :            :  * specified. This will not evict any &quot;active&quot; buffers (i.e. referenced).
<span class="lineNum">    4134 </span>                :            :  *
<span class="lineNum">    4135 </span>                :            :  * When 'retry' is set to B_FALSE, the function will make a single pass
<span class="lineNum">    4136 </span>                :            :  * over the state and evict any buffers that it can. Since it doesn't
<span class="lineNum">    4137 </span>                :            :  * continually retry the eviction, it might end up leaving some buffers
<span class="lineNum">    4138 </span>                :            :  * in the ARC due to lock misses.
<span class="lineNum">    4139 </span>                :            :  *
<span class="lineNum">    4140 </span>                :            :  * When 'retry' is set to B_TRUE, the function will continually retry the
<span class="lineNum">    4141 </span>                :            :  * eviction until *all* evictable buffers have been removed from the
<span class="lineNum">    4142 </span>                :            :  * state. As a result, if concurrent insertions into the state are
<span class="lineNum">    4143 </span>                :            :  * allowed (e.g. if the ARC isn't shutting down), this function might
<span class="lineNum">    4144 </span>                :            :  * wind up in an infinite loop, continually trying to evict buffers.
<a name="4145"><span class="lineNum">    4145 </span>                :            :  */</a>
<span class="lineNum">    4146 </span>                :            : static uint64_t
<span class="lineNum">    4147 </span>                :<span class="lineCov">      19192 : arc_flush_state(arc_state_t *state, uint64_t spa, arc_buf_contents_t type,</span>
<span class="lineNum">    4148 </span>                :            :     boolean_t retry)
<span class="lineNum">    4149 </span>                :            : {
<span class="lineNum">    4150 </span>                :<span class="lineCov">      19192 :         uint64_t evicted = 0;</span>
<span class="lineNum">    4151 </span>                :            : 
<span class="lineNum">    4152 </span>        [<span class="branchCov" title="Branch 1 was taken 62194842 times"> + </span><span class="branchCov" title="Branch 2 was taken 14771 times"> + </span>]:<span class="lineCov">   62209613 :         while (refcount_count(&amp;state-&gt;arcs_esize[type]) != 0) {</span>
<span class="lineNum">    4153 </span>                :<span class="lineCov">   62194842 :                 evicted += arc_evict_state(state, spa, ARC_EVICT_ALL, type);</span>
<span class="lineNum">    4154 </span>                :            : 
<span class="lineNum">    4155 </span>        [<span class="branchCov" title="Branch 0 was taken 62190421 times"> + </span><span class="branchCov" title="Branch 1 was taken 4421 times"> + </span>]:<span class="lineCov">   62194842 :                 if (!retry)</span>
<span class="lineNum">    4156 </span>                :            :                         break;
<span class="lineNum">    4157 </span>                :            :         }
<span class="lineNum">    4158 </span>                :            : 
<span class="lineNum">    4159 </span>                :<span class="lineCov">      19192 :         return (evicted);</span>
<span class="lineNum">    4160 </span>                :            : }
<span class="lineNum">    4161 </span>                :            : 
<span class="lineNum">    4162 </span>                :            : /*
<span class="lineNum">    4163 </span>                :            :  * Helper function for arc_prune_async() it is responsible for safely
<span class="lineNum">    4164 </span>                :            :  * handling the execution of a registered arc_prune_func_t.
<a name="4165"><span class="lineNum">    4165 </span>                :            :  */</a>
<span class="lineNum">    4166 </span>                :            : static void
<span class="lineNum">    4167 </span>                :<span class="lineNoCov">          0 : arc_prune_task(void *ptr)</span>
<span class="lineNum">    4168 </span>                :            : {
<span class="lineNum">    4169 </span>                :<span class="lineNoCov">          0 :         arc_prune_t *ap = (arc_prune_t *)ptr;</span>
<span class="lineNum">    4170 </span>                :<span class="lineNoCov">          0 :         arc_prune_func_t *func = ap-&gt;p_pfunc;</span>
<span class="lineNum">    4171 </span>                :            : 
<span class="lineNum">    4172 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (func != NULL)</span>
<span class="lineNum">    4173 </span>                :<span class="lineNoCov">          0 :                 func(ap-&gt;p_adjust, ap-&gt;p_private);</span>
<span class="lineNum">    4174 </span>                :            : 
<span class="lineNum">    4175 </span>                :<span class="lineNoCov">          0 :         refcount_remove(&amp;ap-&gt;p_refcnt, func);</span>
<span class="lineNum">    4176 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    4177 </span>                :            : 
<span class="lineNum">    4178 </span>                :            : /*
<span class="lineNum">    4179 </span>                :            :  * Notify registered consumers they must drop holds on a portion of the ARC
<span class="lineNum">    4180 </span>                :            :  * buffered they reference.  This provides a mechanism to ensure the ARC can
<span class="lineNum">    4181 </span>                :            :  * honor the arc_meta_limit and reclaim otherwise pinned ARC buffers.  This
<span class="lineNum">    4182 </span>                :            :  * is analogous to dnlc_reduce_cache() but more generic.
<span class="lineNum">    4183 </span>                :            :  *
<span class="lineNum">    4184 </span>                :            :  * This operation is performed asynchronously so it may be safely called
<span class="lineNum">    4185 </span>                :            :  * in the context of the arc_reclaim_thread().  A reference is taken here
<span class="lineNum">    4186 </span>                :            :  * for each registered arc_prune_t and the arc_prune_task() is responsible
<span class="lineNum">    4187 </span>                :            :  * for releasing it once the registered arc_prune_func_t has completed.
<a name="4188"><span class="lineNum">    4188 </span>                :            :  */</a>
<span class="lineNum">    4189 </span>                :            : static void
<span class="lineNum">    4190 </span>                :<span class="lineCov">      61441 : arc_prune_async(int64_t adjust)</span>
<span class="lineNum">    4191 </span>                :            : {
<span class="lineNum">    4192 </span>                :            :         arc_prune_t *ap;
<span class="lineNum">    4193 </span>                :            : 
<span class="lineNum">    4194 </span>                :<span class="lineCov">      61441 :         mutex_enter(&amp;arc_prune_mtx);</span>
<span class="lineNum">    4195 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 61441 times"> + </span>]:<span class="lineCov">      61441 :         for (ap = list_head(&amp;arc_prune_list); ap != NULL;</span>
<span class="lineNum">    4196 </span>                :<span class="lineNoCov">          0 :             ap = list_next(&amp;arc_prune_list, ap)) {</span>
<span class="lineNum">    4197 </span>                :            : 
<span class="lineNum">    4198 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (refcount_count(&amp;ap-&gt;p_refcnt) &gt;= 2)</span>
<span class="lineNum">    4199 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    4200 </span>                :            : 
<span class="lineNum">    4201 </span>                :<span class="lineNoCov">          0 :                 refcount_add(&amp;ap-&gt;p_refcnt, ap-&gt;p_pfunc);</span>
<span class="lineNum">    4202 </span>                :<span class="lineNoCov">          0 :                 ap-&gt;p_adjust = adjust;</span>
<span class="lineNum">    4203 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (taskq_dispatch(arc_prune_taskq, arc_prune_task,</span>
<span class="lineNum">    4204 </span>                :            :                     ap, TQ_SLEEP) == TASKQID_INVALID) {
<span class="lineNum">    4205 </span>                :<span class="lineNoCov">          0 :                         refcount_remove(&amp;ap-&gt;p_refcnt, ap-&gt;p_pfunc);</span>
<span class="lineNum">    4206 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    4207 </span>                :            :                 }
<span class="lineNum">    4208 </span>                :<span class="lineNoCov">          0 :                 ARCSTAT_BUMP(arcstat_prune);</span>
<span class="lineNum">    4209 </span>                :            :         }
<span class="lineNum">    4210 </span>                :<span class="lineCov">      61441 :         mutex_exit(&amp;arc_prune_mtx);</span>
<span class="lineNum">    4211 </span>                :<span class="lineCov">      61441 : }</span>
<span class="lineNum">    4212 </span>                :            : 
<span class="lineNum">    4213 </span>                :            : /*
<span class="lineNum">    4214 </span>                :            :  * Evict the specified number of bytes from the state specified,
<span class="lineNum">    4215 </span>                :            :  * restricting eviction to the spa and type given. This function
<span class="lineNum">    4216 </span>                :            :  * prevents us from trying to evict more from a state's list than
<span class="lineNum">    4217 </span>                :            :  * is &quot;evictable&quot;, and to skip evicting altogether when passed a
<span class="lineNum">    4218 </span>                :            :  * negative value for &quot;bytes&quot;. In contrast, arc_evict_state() will
<span class="lineNum">    4219 </span>                :            :  * evict everything it can, when passed a negative value for &quot;bytes&quot;.
<a name="4220"><span class="lineNum">    4220 </span>                :            :  */</a>
<span class="lineNum">    4221 </span>                :            : static uint64_t
<span class="lineNum">    4222 </span>                :<span class="lineCov">     210246 : arc_adjust_impl(arc_state_t *state, uint64_t spa, int64_t bytes,</span>
<span class="lineNum">    4223 </span>                :            :     arc_buf_contents_t type)
<span class="lineNum">    4224 </span>                :            : {
<span class="lineNum">    4225 </span>                :            :         int64_t delta;
<span class="lineNum">    4226 </span>                :            : 
<span class="lineNum">    4227 </span>[<span class="branchCov" title="Branch 0 was taken 14 times"> + </span><span class="branchCov" title="Branch 1 was taken 210232 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 14 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">     210246 :         if (bytes &gt; 0 &amp;&amp; refcount_count(&amp;state-&gt;arcs_esize[type]) &gt; 0) {</span>
<span class="lineNum">    4228 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 14 times"> + </span>]:<span class="lineCov">         14 :                 delta = MIN(refcount_count(&amp;state-&gt;arcs_esize[type]), bytes);</span>
<span class="lineNum">    4229 </span>                :<span class="lineCov">         14 :                 return (arc_evict_state(state, spa, delta, type));</span>
<span class="lineNum">    4230 </span>                :            :         }
<span class="lineNum">    4231 </span>                :            : 
<span class="lineNum">    4232 </span>                :            :         return (0);
<span class="lineNum">    4233 </span>                :            : }
<span class="lineNum">    4234 </span>                :            : 
<span class="lineNum">    4235 </span>                :            : /*
<span class="lineNum">    4236 </span>                :            :  * The goal of this function is to evict enough meta data buffers from the
<span class="lineNum">    4237 </span>                :            :  * ARC in order to enforce the arc_meta_limit.  Achieving this is slightly
<span class="lineNum">    4238 </span>                :            :  * more complicated than it appears because it is common for data buffers
<span class="lineNum">    4239 </span>                :            :  * to have holds on meta data buffers.  In addition, dnode meta data buffers
<span class="lineNum">    4240 </span>                :            :  * will be held by the dnodes in the block preventing them from being freed.
<span class="lineNum">    4241 </span>                :            :  * This means we can't simply traverse the ARC and expect to always find
<span class="lineNum">    4242 </span>                :            :  * enough unheld meta data buffer to release.
<span class="lineNum">    4243 </span>                :            :  *
<span class="lineNum">    4244 </span>                :            :  * Therefore, this function has been updated to make alternating passes
<span class="lineNum">    4245 </span>                :            :  * over the ARC releasing data buffers and then newly unheld meta data
<span class="lineNum">    4246 </span>                :            :  * buffers.  This ensures forward progress is maintained and arc_meta_used
<span class="lineNum">    4247 </span>                :            :  * will decrease.  Normally this is sufficient, but if required the ARC
<span class="lineNum">    4248 </span>                :            :  * will call the registered prune callbacks causing dentry and inodes to
<span class="lineNum">    4249 </span>                :            :  * be dropped from the VFS cache.  This will make dnode meta data buffers
<span class="lineNum">    4250 </span>                :            :  * available for reclaim.
<a name="4251"><span class="lineNum">    4251 </span>                :            :  */</a>
<span class="lineNum">    4252 </span>                :            : static uint64_t
<span class="lineNum">    4253 </span>                :<span class="lineCov">      26279 : arc_adjust_meta_balanced(void)</span>
<span class="lineNum">    4254 </span>                :            : {
<span class="lineNum">    4255 </span>                :<span class="lineCov">      26279 :         int64_t delta, prune = 0, adjustmnt;</span>
<span class="lineNum">    4256 </span>                :<span class="lineCov">      26279 :         uint64_t total_evicted = 0;</span>
<span class="lineNum">    4257 </span>                :<span class="lineCov">      26279 :         arc_buf_contents_t type = ARC_BUFC_DATA;</span>
<span class="lineNum">    4258 </span>                :<span class="lineCov">      26279 :         int restarts = MAX(zfs_arc_meta_adjust_restarts, 0);</span>
<span class="lineNum">    4259 </span>                :            : 
<span class="lineNum">    4260 </span>                :            : restart:
<span class="lineNum">    4261 </span>                :            :         /*
<span class="lineNum">    4262 </span>                :            :          * This slightly differs than the way we evict from the mru in
<span class="lineNum">    4263 </span>                :            :          * arc_adjust because we don't have a &quot;target&quot; value (i.e. no
<span class="lineNum">    4264 </span>                :            :          * &quot;meta&quot; arc_p). As a result, I think we can completely
<span class="lineNum">    4265 </span>                :            :          * cannibalize the metadata in the MRU before we evict the
<span class="lineNum">    4266 </span>                :            :          * metadata from the MFU. I think we probably need to implement a
<span class="lineNum">    4267 </span>                :            :          * &quot;metadata arc_p&quot; value to do this properly.
<span class="lineNum">    4268 </span>                :            :          */
<span class="lineNum">    4269 </span>                :<span class="lineCov">     149162 :         adjustmnt = arc_meta_used - arc_meta_limit;</span>
<span class="lineNum">    4270 </span>                :            : 
<span class="lineNum">    4271 </span>[<span class="branchCov" title="Branch 0 was taken 122914 times"> + </span><span class="branchCov" title="Branch 1 was taken 26248 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 2 times"> + </span><span class="branchCov" title="Branch 4 was taken 122912 times"> + </span>]:<span class="lineCov">     149162 :         if (adjustmnt &gt; 0 &amp;&amp; refcount_count(&amp;arc_mru-&gt;arcs_esize[type]) &gt; 0) {</span>
<span class="lineNum">    4272 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          2 :                 delta = MIN(refcount_count(&amp;arc_mru-&gt;arcs_esize[type]),</span>
<span class="lineNum">    4273 </span>                :            :                     adjustmnt);
<span class="lineNum">    4274 </span>                :<span class="lineCov">          2 :                 total_evicted += arc_adjust_impl(arc_mru, 0, delta, type);</span>
<span class="lineNum">    4275 </span>                :<span class="lineCov">          2 :                 adjustmnt -= delta;</span>
<span class="lineNum">    4276 </span>                :            :         }
<span class="lineNum">    4277 </span>                :            : 
<span class="lineNum">    4278 </span>                :            :         /*
<span class="lineNum">    4279 </span>                :            :          * We can't afford to recalculate adjustmnt here. If we do,
<span class="lineNum">    4280 </span>                :            :          * new metadata buffers can sneak into the MRU or ANON lists,
<span class="lineNum">    4281 </span>                :            :          * thus penalize the MFU metadata. Although the fudge factor is
<span class="lineNum">    4282 </span>                :            :          * small, it has been empirically shown to be significant for
<span class="lineNum">    4283 </span>                :            :          * certain workloads (e.g. creating many empty directories). As
<span class="lineNum">    4284 </span>                :            :          * such, we use the original calculation for adjustmnt, and
<span class="lineNum">    4285 </span>                :            :          * simply decrement the amount of data evicted from the MRU.
<span class="lineNum">    4286 </span>                :            :          */
<span class="lineNum">    4287 </span>                :            : 
<span class="lineNum">    4288 </span>[<span class="branchCov" title="Branch 0 was taken 122914 times"> + </span><span class="branchCov" title="Branch 1 was taken 26248 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 3 times"> + </span><span class="branchCov" title="Branch 4 was taken 122911 times"> + </span>]:<span class="lineCov">     149162 :         if (adjustmnt &gt; 0 &amp;&amp; refcount_count(&amp;arc_mfu-&gt;arcs_esize[type]) &gt; 0) {</span>
<span class="lineNum">    4289 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span>]:<span class="lineCov">          3 :                 delta = MIN(refcount_count(&amp;arc_mfu-&gt;arcs_esize[type]),</span>
<span class="lineNum">    4290 </span>                :            :                     adjustmnt);
<span class="lineNum">    4291 </span>                :<span class="lineCov">          3 :                 total_evicted += arc_adjust_impl(arc_mfu, 0, delta, type);</span>
<span class="lineNum">    4292 </span>                :            :         }
<span class="lineNum">    4293 </span>                :            : 
<span class="lineNum">    4294 </span>                :<span class="lineCov">     149162 :         adjustmnt = arc_meta_used - arc_meta_limit;</span>
<span class="lineNum">    4295 </span>                :            : 
<span class="lineNum">    4296 </span>  [<span class="branchCov" title="Branch 0 was taken 122913 times"> + </span><span class="branchCov" title="Branch 1 was taken 26249 times"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span><span class="branchCov" title="Branch 3 was taken 122909 times"> + </span>]:<span class="lineCov">     272075 :         if (adjustmnt &gt; 0 &amp;&amp;</span>
<span class="lineNum">    4297 </span>                :<span class="lineCov">     122913 :             refcount_count(&amp;arc_mru_ghost-&gt;arcs_esize[type]) &gt; 0) {</span>
<span class="lineNum">    4298 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span>]:<span class="lineCov">          4 :                 delta = MIN(adjustmnt,</span>
<span class="lineNum">    4299 </span>                :            :                     refcount_count(&amp;arc_mru_ghost-&gt;arcs_esize[type]));
<span class="lineNum">    4300 </span>                :<span class="lineCov">          4 :                 total_evicted += arc_adjust_impl(arc_mru_ghost, 0, delta, type);</span>
<span class="lineNum">    4301 </span>                :<span class="lineCov">          4 :                 adjustmnt -= delta;</span>
<span class="lineNum">    4302 </span>                :            :         }
<span class="lineNum">    4303 </span>                :            : 
<span class="lineNum">    4304 </span>  [<span class="branchCov" title="Branch 0 was taken 122911 times"> + </span><span class="branchCov" title="Branch 1 was taken 26251 times"> + </span><span class="branchCov" title="Branch 2 was taken 5 times"> + </span><span class="branchCov" title="Branch 3 was taken 122906 times"> + </span>]:<span class="lineCov">     272073 :         if (adjustmnt &gt; 0 &amp;&amp;</span>
<span class="lineNum">    4305 </span>                :<span class="lineCov">     122911 :             refcount_count(&amp;arc_mfu_ghost-&gt;arcs_esize[type]) &gt; 0) {</span>
<span class="lineNum">    4306 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 4 times"> + </span>]:<span class="lineCov">          5 :                 delta = MIN(adjustmnt,</span>
<span class="lineNum">    4307 </span>                :            :                     refcount_count(&amp;arc_mfu_ghost-&gt;arcs_esize[type]));
<span class="lineNum">    4308 </span>                :<span class="lineCov">          5 :                 total_evicted += arc_adjust_impl(arc_mfu_ghost, 0, delta, type);</span>
<span class="lineNum">    4309 </span>                :            :         }
<span class="lineNum">    4310 </span>                :            : 
<span class="lineNum">    4311 </span>                :            :         /*
<span class="lineNum">    4312 </span>                :            :          * If after attempting to make the requested adjustment to the ARC
<span class="lineNum">    4313 </span>                :            :          * the meta limit is still being exceeded then request that the
<span class="lineNum">    4314 </span>                :            :          * higher layers drop some cached objects which have holds on ARC
<span class="lineNum">    4315 </span>                :            :          * meta buffers.  Requests to the upper layers will be made with
<span class="lineNum">    4316 </span>                :            :          * increasingly large scan sizes until the ARC is below the limit.
<span class="lineNum">    4317 </span>                :            :          */
<span class="lineNum">    4318 </span>        [<span class="branchCov" title="Branch 0 was taken 122913 times"> + </span><span class="branchCov" title="Branch 1 was taken 26249 times"> + </span>]:<span class="lineCov">     149162 :         if (arc_meta_used &gt; arc_meta_limit) {</span>
<span class="lineNum">    4319 </span>        [<span class="branchCov" title="Branch 0 was taken 61441 times"> + </span><span class="branchCov" title="Branch 1 was taken 61472 times"> + </span>]:<span class="lineCov">     122913 :                 if (type == ARC_BUFC_DATA) {</span>
<span class="lineNum">    4320 </span>                :            :                         type = ARC_BUFC_METADATA;
<span class="lineNum">    4321 </span>                :            :                 } else {
<span class="lineNum">    4322 </span>                :<span class="lineCov">      61441 :                         type = ARC_BUFC_DATA;</span>
<span class="lineNum">    4323 </span>                :            : 
<span class="lineNum">    4324 </span>        [<span class="branchCov" title="Branch 0 was taken 61441 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      61441 :                         if (zfs_arc_meta_prune) {</span>
<span class="lineNum">    4325 </span>                :<span class="lineCov">      61441 :                                 prune += zfs_arc_meta_prune;</span>
<span class="lineNum">    4326 </span>                :<span class="lineCov">      61441 :                                 arc_prune_async(prune);</span>
<span class="lineNum">    4327 </span>                :            :                         }
<span class="lineNum">    4328 </span>                :            :                 }
<span class="lineNum">    4329 </span>                :            : 
<span class="lineNum">    4330 </span>        [<span class="branchCov" title="Branch 0 was taken 122883 times"> + </span><span class="branchCov" title="Branch 1 was taken 30 times"> + </span>]:<span class="lineCov">     122913 :                 if (restarts &gt; 0) {</span>
<span class="lineNum">    4331 </span>                :<span class="lineCov">     122883 :                         restarts--;</span>
<span class="lineNum">    4332 </span>                :<span class="lineCov">     122883 :                         goto restart;</span>
<span class="lineNum">    4333 </span>                :            :                 }
<span class="lineNum">    4334 </span>                :            :         }
<span class="lineNum">    4335 </span>                :<span class="lineCov">      26279 :         return (total_evicted);</span>
<span class="lineNum">    4336 </span>                :            : }
<span class="lineNum">    4337 </span>                :            : 
<span class="lineNum">    4338 </span>                :            : /*
<span class="lineNum">    4339 </span>                :            :  * Evict metadata buffers from the cache, such that arc_meta_used is
<span class="lineNum">    4340 </span>                :            :  * capped by the arc_meta_limit tunable.
<a name="4341"><span class="lineNum">    4341 </span>                :            :  */</a>
<span class="lineNum">    4342 </span>                :            : static uint64_t
<span class="lineNum">    4343 </span>                :<span class="lineNoCov">          0 : arc_adjust_meta_only(void)</span>
<span class="lineNum">    4344 </span>                :            : {
<span class="lineNum">    4345 </span>                :<span class="lineNoCov">          0 :         uint64_t total_evicted = 0;</span>
<span class="lineNum">    4346 </span>                :            :         int64_t target;
<span class="lineNum">    4347 </span>                :            : 
<span class="lineNum">    4348 </span>                :            :         /*
<span class="lineNum">    4349 </span>                :            :          * If we're over the meta limit, we want to evict enough
<span class="lineNum">    4350 </span>                :            :          * metadata to get back under the meta limit. We don't want to
<span class="lineNum">    4351 </span>                :            :          * evict so much that we drop the MRU below arc_p, though. If
<span class="lineNum">    4352 </span>                :            :          * we're over the meta limit more than we're over arc_p, we
<span class="lineNum">    4353 </span>                :            :          * evict some from the MRU here, and some from the MFU below.
<span class="lineNum">    4354 </span>                :            :          */
<span class="lineNum">    4355 </span>        [<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         target = MIN((int64_t)(arc_meta_used - arc_meta_limit),</span>
<span class="lineNum">    4356 </span>                :            :             (int64_t)(refcount_count(&amp;arc_anon-&gt;arcs_size) +
<span class="lineNum">    4357 </span>                :            :             refcount_count(&amp;arc_mru-&gt;arcs_size) - arc_p));
<span class="lineNum">    4358 </span>                :            : 
<span class="lineNum">    4359 </span>                :<span class="lineNoCov">          0 :         total_evicted += arc_adjust_impl(arc_mru, 0, target, ARC_BUFC_METADATA);</span>
<span class="lineNum">    4360 </span>                :            : 
<span class="lineNum">    4361 </span>                :            :         /*
<span class="lineNum">    4362 </span>                :            :          * Similar to the above, we want to evict enough bytes to get us
<span class="lineNum">    4363 </span>                :            :          * below the meta limit, but not so much as to drop us below the
<span class="lineNum">    4364 </span>                :            :          * space allotted to the MFU (which is defined as arc_c - arc_p).
<span class="lineNum">    4365 </span>                :            :          */
<span class="lineNum">    4366 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         target = MIN((int64_t)(arc_meta_used - arc_meta_limit),</span>
<span class="lineNum">    4367 </span>                :            :             (int64_t)(refcount_count(&amp;arc_mfu-&gt;arcs_size) - (arc_c - arc_p)));
<span class="lineNum">    4368 </span>                :            : 
<span class="lineNum">    4369 </span>                :<span class="lineNoCov">          0 :         total_evicted += arc_adjust_impl(arc_mfu, 0, target, ARC_BUFC_METADATA);</span>
<span class="lineNum">    4370 </span>                :            : 
<span class="lineNum">    4371 </span>                :<span class="lineNoCov">          0 :         return (total_evicted);</span>
<span class="lineNum">    4372 </span>                :            : }
<a name="4373"><span class="lineNum">    4373 </span>                :            : </a>
<span class="lineNum">    4374 </span>                :            : static uint64_t
<span class="lineNum">    4375 </span>                :<span class="lineCov">      26279 : arc_adjust_meta(void)</span>
<span class="lineNum">    4376 </span>                :            : {
<span class="lineNum">    4377 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 26279 times"> + </span>]:<span class="lineCov">      26279 :         if (zfs_arc_meta_strategy == ARC_STRATEGY_META_ONLY)</span>
<span class="lineNum">    4378 </span>                :<span class="lineNoCov">          0 :                 return (arc_adjust_meta_only());</span>
<span class="lineNum">    4379 </span>                :            :         else
<span class="lineNum">    4380 </span>                :<span class="lineCov">      26279 :                 return (arc_adjust_meta_balanced());</span>
<span class="lineNum">    4381 </span>                :            : }
<span class="lineNum">    4382 </span>                :            : 
<span class="lineNum">    4383 </span>                :            : /*
<span class="lineNum">    4384 </span>                :            :  * Return the type of the oldest buffer in the given arc state
<span class="lineNum">    4385 </span>                :            :  *
<span class="lineNum">    4386 </span>                :            :  * This function will select a random sublist of type ARC_BUFC_DATA and
<span class="lineNum">    4387 </span>                :            :  * a random sublist of type ARC_BUFC_METADATA. The tail of each sublist
<span class="lineNum">    4388 </span>                :            :  * is compared, and the type which contains the &quot;older&quot; buffer will be
<span class="lineNum">    4389 </span>                :            :  * returned.
<a name="4390"><span class="lineNum">    4390 </span>                :            :  */</a>
<span class="lineNum">    4391 </span>                :            : static arc_buf_contents_t
<span class="lineNum">    4392 </span>                :<span class="lineCov">     105116 : arc_adjust_type(arc_state_t *state)</span>
<span class="lineNum">    4393 </span>                :            : {
<span class="lineNum">    4394 </span>                :<span class="lineCov">      52558 :         multilist_t *data_ml = state-&gt;arcs_list[ARC_BUFC_DATA];</span>
<span class="lineNum">    4395 </span>                :<span class="lineCov">      52558 :         multilist_t *meta_ml = state-&gt;arcs_list[ARC_BUFC_METADATA];</span>
<span class="lineNum">    4396 </span>                :<span class="lineCov">      52558 :         int data_idx = multilist_get_random_index(data_ml);</span>
<span class="lineNum">    4397 </span>                :<span class="lineCov">      52558 :         int meta_idx = multilist_get_random_index(meta_ml);</span>
<span class="lineNum">    4398 </span>                :            :         multilist_sublist_t *data_mls;
<span class="lineNum">    4399 </span>                :            :         multilist_sublist_t *meta_mls;
<span class="lineNum">    4400 </span>                :            :         arc_buf_contents_t type;
<span class="lineNum">    4401 </span>                :            :         arc_buf_hdr_t *data_hdr;
<span class="lineNum">    4402 </span>                :            :         arc_buf_hdr_t *meta_hdr;
<span class="lineNum">    4403 </span>                :            : 
<span class="lineNum">    4404 </span>                :            :         /*
<span class="lineNum">    4405 </span>                :            :          * We keep the sublist lock until we're finished, to prevent
<span class="lineNum">    4406 </span>                :            :          * the headers from being destroyed via arc_evict_state().
<span class="lineNum">    4407 </span>                :            :          */
<span class="lineNum">    4408 </span>                :<span class="lineCov">      52558 :         data_mls = multilist_sublist_lock(data_ml, data_idx);</span>
<span class="lineNum">    4409 </span>                :<span class="lineCov">      52558 :         meta_mls = multilist_sublist_lock(meta_ml, meta_idx);</span>
<span class="lineNum">    4410 </span>                :            : 
<span class="lineNum">    4411 </span>                :            :         /*
<span class="lineNum">    4412 </span>                :            :          * These two loops are to ensure we skip any markers that
<span class="lineNum">    4413 </span>                :            :          * might be at the tail of the lists due to arc_evict_state().
<span class="lineNum">    4414 </span>                :            :          */
<span class="lineNum">    4415 </span>                :            : 
<span class="lineNum">    4416 </span>        [<span class="branchCov" title="Branch 1 was taken 8485 times"> + </span><span class="branchCov" title="Branch 2 was taken 44073 times"> + </span>]:<span class="lineCov">      52558 :         for (data_hdr = multilist_sublist_tail(data_mls); data_hdr != NULL;</span>
<span class="lineNum">    4417 </span>                :<span class="lineNoCov">          0 :             data_hdr = multilist_sublist_prev(data_mls, data_hdr)) {</span>
<span class="lineNum">    4418 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 8485 times"> + </span>]:<span class="lineCov">       8485 :                 if (data_hdr-&gt;b_spa != 0)</span>
<span class="lineNum">    4419 </span>                :            :                         break;
<span class="lineNum">    4420 </span>                :            :         }
<span class="lineNum">    4421 </span>                :            : 
<span class="lineNum">    4422 </span>        [<span class="branchCov" title="Branch 1 was taken 32002 times"> + </span><span class="branchCov" title="Branch 2 was taken 20556 times"> + </span>]:<span class="lineCov">      52558 :         for (meta_hdr = multilist_sublist_tail(meta_mls); meta_hdr != NULL;</span>
<span class="lineNum">    4423 </span>                :<span class="lineNoCov">          0 :             meta_hdr = multilist_sublist_prev(meta_mls, meta_hdr)) {</span>
<span class="lineNum">    4424 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 32002 times"> + </span>]:<span class="lineCov">      32002 :                 if (meta_hdr-&gt;b_spa != 0)</span>
<span class="lineNum">    4425 </span>                :            :                         break;
<span class="lineNum">    4426 </span>                :            :         }
<span class="lineNum">    4427 </span>                :            : 
<span class="lineNum">    4428 </span>        [<span class="branchCov" title="Branch 0 was taken 32084 times"> + </span><span class="branchCov" title="Branch 1 was taken 20474 times"> + </span>]:<span class="lineCov">      52558 :         if (data_hdr == NULL &amp;&amp; meta_hdr == NULL) {</span>
<span class="lineNum">    4429 </span>                :            :                 type = ARC_BUFC_DATA;
<span class="lineNum">    4430 </span>        [<span class="branchCov" title="Branch 0 was taken 23599 times"> + </span><span class="branchCov" title="Branch 1 was taken 8485 times"> + </span>]:<span class="lineCov">      32084 :         } else if (data_hdr == NULL) {</span>
<span class="lineNum">    4431 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 23599 times"> + </span>]:<span class="lineCov">      23599 :                 ASSERT3P(meta_hdr, !=, NULL);</span>
<span class="lineNum">    4432 </span>                :            :                 type = ARC_BUFC_METADATA;
<span class="lineNum">    4433 </span>        [<span class="branchCov" title="Branch 0 was taken 82 times"> + </span><span class="branchCov" title="Branch 1 was taken 8403 times"> + </span>]:<span class="lineCov">       8485 :         } else if (meta_hdr == NULL) {</span>
<span class="lineNum">    4434 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 82 times"> + </span>]:<span class="lineCov">         82 :                 ASSERT3P(data_hdr, !=, NULL);</span>
<span class="lineNum">    4435 </span>                :            :                 type = ARC_BUFC_DATA;
<span class="lineNum">    4436 </span>                :            :         } else {
<span class="lineNum">    4437 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 8403 times"> + </span>]:<span class="lineCov">       8403 :                 ASSERT3P(data_hdr, !=, NULL);</span>
<span class="lineNum">    4438 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 8403 times"> + </span>]:<span class="lineCov">       8403 :                 ASSERT3P(meta_hdr, !=, NULL);</span>
<span class="lineNum">    4439 </span>                :            : 
<span class="lineNum">    4440 </span>                :            :                 /* The headers can't be on the sublist without an L1 header */
<span class="lineNum">    4441 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 8403 times"> + </span>]:<span class="lineCov">       8403 :                 ASSERT(HDR_HAS_L1HDR(data_hdr));</span>
<span class="lineNum">    4442 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 8403 times"> + </span>]:<span class="lineCov">       8403 :                 ASSERT(HDR_HAS_L1HDR(meta_hdr));</span>
<span class="lineNum">    4443 </span>                :            : 
<span class="lineNum">    4444 </span>        [<span class="branchCov" title="Branch 0 was taken 7108 times"> + </span><span class="branchCov" title="Branch 1 was taken 1295 times"> + </span>]:<span class="lineCov">       8403 :                 if (data_hdr-&gt;b_l1hdr.b_arc_access &lt;</span>
<span class="lineNum">    4445 </span>                :<span class="lineCov">       8403 :                     meta_hdr-&gt;b_l1hdr.b_arc_access) {</span>
<span class="lineNum">    4446 </span>                :            :                         type = ARC_BUFC_DATA;
<span class="lineNum">    4447 </span>                :            :                 } else {
<span class="lineNum">    4448 </span>                :<span class="lineCov">       7108 :                         type = ARC_BUFC_METADATA;</span>
<span class="lineNum">    4449 </span>                :            :                 }
<span class="lineNum">    4450 </span>                :            :         }
<span class="lineNum">    4451 </span>                :            : 
<span class="lineNum">    4452 </span>                :<span class="lineCov">      52558 :         multilist_sublist_unlock(meta_mls);</span>
<span class="lineNum">    4453 </span>                :<span class="lineCov">      52558 :         multilist_sublist_unlock(data_mls);</span>
<span class="lineNum">    4454 </span>                :            : 
<span class="lineNum">    4455 </span>                :<span class="lineCov">      52558 :         return (type);</span>
<span class="lineNum">    4456 </span>                :            : }
<span class="lineNum">    4457 </span>                :            : 
<span class="lineNum">    4458 </span>                :            : /*
<span class="lineNum">    4459 </span>                :            :  * Evict buffers from the cache, such that arc_size is capped by arc_c.
<a name="4460"><span class="lineNum">    4460 </span>                :            :  */</a>
<span class="lineNum">    4461 </span>                :            : static uint64_t
<span class="lineNum">    4462 </span>                :<span class="lineCov">      26279 : arc_adjust(void)</span>
<span class="lineNum">    4463 </span>                :            : {
<span class="lineNum">    4464 </span>                :<span class="lineCov">      26279 :         uint64_t total_evicted = 0;</span>
<span class="lineNum">    4465 </span>                :            :         uint64_t bytes;
<span class="lineNum">    4466 </span>                :            :         int64_t target;
<span class="lineNum">    4467 </span>                :            : 
<span class="lineNum">    4468 </span>                :            :         /*
<span class="lineNum">    4469 </span>                :            :          * If we're over arc_meta_limit, we want to correct that before
<span class="lineNum">    4470 </span>                :            :          * potentially evicting data buffers below.
<span class="lineNum">    4471 </span>                :            :          */
<span class="lineNum">    4472 </span>                :<span class="lineCov">      26279 :         total_evicted += arc_adjust_meta();</span>
<span class="lineNum">    4473 </span>                :            : 
<span class="lineNum">    4474 </span>                :            :         /*
<span class="lineNum">    4475 </span>                :            :          * Adjust MRU size
<span class="lineNum">    4476 </span>                :            :          *
<span class="lineNum">    4477 </span>                :            :          * If we're over the target cache size, we want to evict enough
<span class="lineNum">    4478 </span>                :            :          * from the list to get back to our target size. We don't want
<span class="lineNum">    4479 </span>                :            :          * to evict too much from the MRU, such that it drops below
<span class="lineNum">    4480 </span>                :            :          * arc_p. So, if we're over our target cache size more than
<span class="lineNum">    4481 </span>                :            :          * the MRU is over arc_p, we'll evict enough to get back to
<span class="lineNum">    4482 </span>                :            :          * arc_p here, and then evict more from the MFU below.
<span class="lineNum">    4483 </span>                :            :          */
<span class="lineNum">    4484 </span>        [<span class="branchCov" title="Branch 2 was taken 26279 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">      26279 :         target = MIN((int64_t)(arc_size - arc_c),</span>
<span class="lineNum">    4485 </span>                :            :             (int64_t)(refcount_count(&amp;arc_anon-&gt;arcs_size) +
<span class="lineNum">    4486 </span>                :            :             refcount_count(&amp;arc_mru-&gt;arcs_size) + arc_meta_used - arc_p));
<span class="lineNum">    4487 </span>                :            : 
<span class="lineNum">    4488 </span>                :            :         /*
<span class="lineNum">    4489 </span>                :            :          * If we're below arc_meta_min, always prefer to evict data.
<span class="lineNum">    4490 </span>                :            :          * Otherwise, try to satisfy the requested number of bytes to
<span class="lineNum">    4491 </span>                :            :          * evict from the type which contains older buffers; in an
<span class="lineNum">    4492 </span>                :            :          * effort to keep newer buffers in the cache regardless of their
<span class="lineNum">    4493 </span>                :            :          * type. If we cannot satisfy the number of bytes from this
<span class="lineNum">    4494 </span>                :            :          * type, spill over into the next type.
<span class="lineNum">    4495 </span>                :            :          */
<span class="lineNum">    4496 </span>[<span class="branchCov" title="Branch 1 was taken 19516 times"> + </span><span class="branchCov" title="Branch 2 was taken 6763 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 6870 times"> + </span><span class="branchCov" title="Branch 4 was taken 12646 times"> + </span>]:<span class="lineCov">      26279 :         if (arc_adjust_type(arc_mru) == ARC_BUFC_METADATA &amp;&amp;</span>
<span class="lineNum">    4497 </span>                :<span class="lineCov">      19516 :             arc_meta_used &gt; arc_meta_min) {</span>
<span class="lineNum">    4498 </span>                :<span class="lineCov">       6870 :                 bytes = arc_adjust_impl(arc_mru, 0, target, ARC_BUFC_METADATA);</span>
<span class="lineNum">    4499 </span>                :<span class="lineCov">       6870 :                 total_evicted += bytes;</span>
<span class="lineNum">    4500 </span>                :            : 
<span class="lineNum">    4501 </span>                :            :                 /*
<span class="lineNum">    4502 </span>                :            :                  * If we couldn't evict our target number of bytes from
<span class="lineNum">    4503 </span>                :            :                  * metadata, we try to get the rest from data.
<span class="lineNum">    4504 </span>                :            :                  */
<span class="lineNum">    4505 </span>                :<span class="lineCov">       6870 :                 target -= bytes;</span>
<span class="lineNum">    4506 </span>                :            : 
<span class="lineNum">    4507 </span>                :<span class="lineCov">       6870 :                 total_evicted +=</span>
<span class="lineNum">    4508 </span>                :<span class="lineCov">       6870 :                     arc_adjust_impl(arc_mru, 0, target, ARC_BUFC_DATA);</span>
<span class="lineNum">    4509 </span>                :            :         } else {
<span class="lineNum">    4510 </span>                :<span class="lineCov">      19409 :                 bytes = arc_adjust_impl(arc_mru, 0, target, ARC_BUFC_DATA);</span>
<span class="lineNum">    4511 </span>                :<span class="lineCov">      19409 :                 total_evicted += bytes;</span>
<span class="lineNum">    4512 </span>                :            : 
<span class="lineNum">    4513 </span>                :            :                 /*
<span class="lineNum">    4514 </span>                :            :                  * If we couldn't evict our target number of bytes from
<span class="lineNum">    4515 </span>                :            :                  * data, we try to get the rest from metadata.
<span class="lineNum">    4516 </span>                :            :                  */
<span class="lineNum">    4517 </span>                :<span class="lineCov">      19409 :                 target -= bytes;</span>
<span class="lineNum">    4518 </span>                :            : 
<span class="lineNum">    4519 </span>                :<span class="lineCov">      19409 :                 total_evicted +=</span>
<span class="lineNum">    4520 </span>                :<span class="lineCov">      19409 :                     arc_adjust_impl(arc_mru, 0, target, ARC_BUFC_METADATA);</span>
<span class="lineNum">    4521 </span>                :            :         }
<span class="lineNum">    4522 </span>                :            : 
<span class="lineNum">    4523 </span>                :            :         /*
<span class="lineNum">    4524 </span>                :            :          * Adjust MFU size
<span class="lineNum">    4525 </span>                :            :          *
<span class="lineNum">    4526 </span>                :            :          * Now that we've tried to evict enough from the MRU to get its
<span class="lineNum">    4527 </span>                :            :          * size back to arc_p, if we're still above the target cache
<span class="lineNum">    4528 </span>                :            :          * size, we evict the rest from the MFU.
<span class="lineNum">    4529 </span>                :            :          */
<span class="lineNum">    4530 </span>                :<span class="lineCov">      26279 :         target = arc_size - arc_c;</span>
<span class="lineNum">    4531 </span>                :            : 
<span class="lineNum">    4532 </span>[<span class="branchCov" title="Branch 1 was taken 11191 times"> + </span><span class="branchCov" title="Branch 2 was taken 15088 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 3910 times"> + </span><span class="branchCov" title="Branch 4 was taken 7281 times"> + </span>]:<span class="lineCov">      26279 :         if (arc_adjust_type(arc_mfu) == ARC_BUFC_METADATA &amp;&amp;</span>
<span class="lineNum">    4533 </span>                :<span class="lineCov">      11191 :             arc_meta_used &gt; arc_meta_min) {</span>
<span class="lineNum">    4534 </span>                :<span class="lineCov">       3910 :                 bytes = arc_adjust_impl(arc_mfu, 0, target, ARC_BUFC_METADATA);</span>
<span class="lineNum">    4535 </span>                :<span class="lineCov">       3910 :                 total_evicted += bytes;</span>
<span class="lineNum">    4536 </span>                :            : 
<span class="lineNum">    4537 </span>                :            :                 /*
<span class="lineNum">    4538 </span>                :            :                  * If we couldn't evict our target number of bytes from
<span class="lineNum">    4539 </span>                :            :                  * metadata, we try to get the rest from data.
<span class="lineNum">    4540 </span>                :            :                  */
<span class="lineNum">    4541 </span>                :<span class="lineCov">       3910 :                 target -= bytes;</span>
<span class="lineNum">    4542 </span>                :            : 
<span class="lineNum">    4543 </span>                :<span class="lineCov">       3910 :                 total_evicted +=</span>
<span class="lineNum">    4544 </span>                :<span class="lineCov">       3910 :                     arc_adjust_impl(arc_mfu, 0, target, ARC_BUFC_DATA);</span>
<span class="lineNum">    4545 </span>                :            :         } else {
<span class="lineNum">    4546 </span>                :<span class="lineCov">      22369 :                 bytes = arc_adjust_impl(arc_mfu, 0, target, ARC_BUFC_DATA);</span>
<span class="lineNum">    4547 </span>                :<span class="lineCov">      22369 :                 total_evicted += bytes;</span>
<span class="lineNum">    4548 </span>                :            : 
<span class="lineNum">    4549 </span>                :            :                 /*
<span class="lineNum">    4550 </span>                :            :                  * If we couldn't evict our target number of bytes from
<span class="lineNum">    4551 </span>                :            :                  * data, we try to get the rest from data.
<span class="lineNum">    4552 </span>                :            :                  */
<span class="lineNum">    4553 </span>                :<span class="lineCov">      22369 :                 target -= bytes;</span>
<span class="lineNum">    4554 </span>                :            : 
<span class="lineNum">    4555 </span>                :<span class="lineCov">      22369 :                 total_evicted +=</span>
<span class="lineNum">    4556 </span>                :<span class="lineCov">      22369 :                     arc_adjust_impl(arc_mfu, 0, target, ARC_BUFC_METADATA);</span>
<span class="lineNum">    4557 </span>                :            :         }
<span class="lineNum">    4558 </span>                :            : 
<span class="lineNum">    4559 </span>                :            :         /*
<span class="lineNum">    4560 </span>                :            :          * Adjust ghost lists
<span class="lineNum">    4561 </span>                :            :          *
<span class="lineNum">    4562 </span>                :            :          * In addition to the above, the ARC also defines target values
<span class="lineNum">    4563 </span>                :            :          * for the ghost lists. The sum of the mru list and mru ghost
<span class="lineNum">    4564 </span>                :            :          * list should never exceed the target size of the cache, and
<span class="lineNum">    4565 </span>                :            :          * the sum of the mru list, mfu list, mru ghost list, and mfu
<span class="lineNum">    4566 </span>                :            :          * ghost list should never exceed twice the target size of the
<span class="lineNum">    4567 </span>                :            :          * cache. The following logic enforces these limits on the ghost
<span class="lineNum">    4568 </span>                :            :          * caches, and evicts from them as needed.
<span class="lineNum">    4569 </span>                :            :          */
<span class="lineNum">    4570 </span>                :<span class="lineCov">      26279 :         target = refcount_count(&amp;arc_mru-&gt;arcs_size) +</span>
<span class="lineNum">    4571 </span>                :<span class="lineCov">      26279 :             refcount_count(&amp;arc_mru_ghost-&gt;arcs_size) - arc_c;</span>
<span class="lineNum">    4572 </span>                :            : 
<span class="lineNum">    4573 </span>                :<span class="lineCov">      26279 :         bytes = arc_adjust_impl(arc_mru_ghost, 0, target, ARC_BUFC_DATA);</span>
<span class="lineNum">    4574 </span>                :<span class="lineCov">      26279 :         total_evicted += bytes;</span>
<span class="lineNum">    4575 </span>                :            : 
<span class="lineNum">    4576 </span>                :<span class="lineCov">      26279 :         target -= bytes;</span>
<span class="lineNum">    4577 </span>                :            : 
<span class="lineNum">    4578 </span>                :<span class="lineCov">      26279 :         total_evicted +=</span>
<span class="lineNum">    4579 </span>                :<span class="lineCov">      26279 :             arc_adjust_impl(arc_mru_ghost, 0, target, ARC_BUFC_METADATA);</span>
<span class="lineNum">    4580 </span>                :            : 
<span class="lineNum">    4581 </span>                :            :         /*
<span class="lineNum">    4582 </span>                :            :          * We assume the sum of the mru list and mfu list is less than
<span class="lineNum">    4583 </span>                :            :          * or equal to arc_c (we enforced this above), which means we
<span class="lineNum">    4584 </span>                :            :          * can use the simpler of the two equations below:
<span class="lineNum">    4585 </span>                :            :          *
<span class="lineNum">    4586 </span>                :            :          *      mru + mfu + mru ghost + mfu ghost &lt;= 2 * arc_c
<span class="lineNum">    4587 </span>                :            :          *                  mru ghost + mfu ghost &lt;= arc_c
<span class="lineNum">    4588 </span>                :            :          */
<span class="lineNum">    4589 </span>                :<span class="lineCov">      26279 :         target = refcount_count(&amp;arc_mru_ghost-&gt;arcs_size) +</span>
<span class="lineNum">    4590 </span>                :<span class="lineCov">      26279 :             refcount_count(&amp;arc_mfu_ghost-&gt;arcs_size) - arc_c;</span>
<span class="lineNum">    4591 </span>                :            : 
<span class="lineNum">    4592 </span>                :<span class="lineCov">      26279 :         bytes = arc_adjust_impl(arc_mfu_ghost, 0, target, ARC_BUFC_DATA);</span>
<span class="lineNum">    4593 </span>                :<span class="lineCov">      26279 :         total_evicted += bytes;</span>
<span class="lineNum">    4594 </span>                :            : 
<span class="lineNum">    4595 </span>                :<span class="lineCov">      26279 :         target -= bytes;</span>
<span class="lineNum">    4596 </span>                :            : 
<span class="lineNum">    4597 </span>                :<span class="lineCov">      26279 :         total_evicted +=</span>
<span class="lineNum">    4598 </span>                :<span class="lineCov">      26279 :             arc_adjust_impl(arc_mfu_ghost, 0, target, ARC_BUFC_METADATA);</span>
<span class="lineNum">    4599 </span>                :            : 
<span class="lineNum">    4600 </span>                :<span class="lineCov">      26279 :         return (total_evicted);</span>
<span class="lineNum">    4601 </span>                :            : }
<a name="4602"><span class="lineNum">    4602 </span>                :            : </a>
<span class="lineNum">    4603 </span>                :            : void
<span class="lineNum">    4604 </span>                :<span class="lineCov">       2399 : arc_flush(spa_t *spa, boolean_t retry)</span>
<span class="lineNum">    4605 </span>                :            : {
<span class="lineNum">    4606 </span>                :<span class="lineCov">       2399 :         uint64_t guid = 0;</span>
<span class="lineNum">    4607 </span>                :            : 
<span class="lineNum">    4608 </span>                :            :         /*
<span class="lineNum">    4609 </span>                :            :          * If retry is B_TRUE, a spa must not be specified since we have
<span class="lineNum">    4610 </span>                :            :          * no good way to determine if all of a spa's buffers have been
<span class="lineNum">    4611 </span>                :            :          * evicted from an arc state.
<span class="lineNum">    4612 </span>                :            :          */
<span class="lineNum">    4613 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2399 times"> + </span>]:<span class="lineCov">       2399 :         ASSERT(!retry || spa == 0);</span>
<span class="lineNum">    4614 </span>                :            : 
<span class="lineNum">    4615 </span>        [<span class="branchCov" title="Branch 0 was taken 1614 times"> + </span><span class="branchCov" title="Branch 1 was taken 785 times"> + </span>]:<span class="lineCov">       2399 :         if (spa != NULL)</span>
<span class="lineNum">    4616 </span>                :<span class="lineCov">       1614 :                 guid = spa_load_guid(spa);</span>
<span class="lineNum">    4617 </span>                :            : 
<span class="lineNum">    4618 </span>                :<span class="lineCov">       2399 :         (void) arc_flush_state(arc_mru, guid, ARC_BUFC_DATA, retry);</span>
<span class="lineNum">    4619 </span>                :<span class="lineCov">       2399 :         (void) arc_flush_state(arc_mru, guid, ARC_BUFC_METADATA, retry);</span>
<span class="lineNum">    4620 </span>                :            : 
<span class="lineNum">    4621 </span>                :<span class="lineCov">       2399 :         (void) arc_flush_state(arc_mfu, guid, ARC_BUFC_DATA, retry);</span>
<span class="lineNum">    4622 </span>                :<span class="lineCov">       2399 :         (void) arc_flush_state(arc_mfu, guid, ARC_BUFC_METADATA, retry);</span>
<span class="lineNum">    4623 </span>                :            : 
<span class="lineNum">    4624 </span>                :<span class="lineCov">       2399 :         (void) arc_flush_state(arc_mru_ghost, guid, ARC_BUFC_DATA, retry);</span>
<span class="lineNum">    4625 </span>                :<span class="lineCov">       2399 :         (void) arc_flush_state(arc_mru_ghost, guid, ARC_BUFC_METADATA, retry);</span>
<span class="lineNum">    4626 </span>                :            : 
<span class="lineNum">    4627 </span>                :<span class="lineCov">       2399 :         (void) arc_flush_state(arc_mfu_ghost, guid, ARC_BUFC_DATA, retry);</span>
<span class="lineNum">    4628 </span>                :<span class="lineCov">       2399 :         (void) arc_flush_state(arc_mfu_ghost, guid, ARC_BUFC_METADATA, retry);</span>
<span class="lineNum">    4629 </span>                :<span class="lineCov">       2399 : }</span>
<a name="4630"><span class="lineNum">    4630 </span>                :            : </a>
<span class="lineNum">    4631 </span>                :            : void
<span class="lineNum">    4632 </span>                :<span class="lineCov">          6 : arc_shrink(int64_t to_free)</span>
<span class="lineNum">    4633 </span>                :            : {
<span class="lineNum">    4634 </span>                :<span class="lineCov">          6 :         uint64_t c = arc_c;</span>
<span class="lineNum">    4635 </span>                :            : 
<span class="lineNum">    4636 </span>[<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          6 :         if (c &gt; to_free &amp;&amp; c - to_free &gt; arc_c_min) {</span>
<span class="lineNum">    4637 </span>                :<span class="lineCov">          6 :                 arc_c = c - to_free;</span>
<span class="lineNum">    4638 </span>                :<span class="lineCov">          6 :                 atomic_add_64(&amp;arc_p, -(arc_p &gt;&gt; arc_shrink_shift));</span>
<span class="lineNum">    4639 </span>        [<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          6 :                 if (arc_c &gt; arc_size)</span>
<span class="lineNum">    4640 </span>                :<span class="lineCov">          6 :                         arc_c = MAX(arc_size, arc_c_min);</span>
<span class="lineNum">    4641 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">          6 :                 if (arc_p &gt; arc_c)</span>
<span class="lineNum">    4642 </span>                :<span class="lineNoCov">          0 :                         arc_p = (arc_c &gt;&gt; 1);</span>
<span class="lineNum">    4643 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">          6 :                 ASSERT(arc_c &gt;= arc_c_min);</span>
<span class="lineNum">    4644 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">          6 :                 ASSERT((int64_t)arc_p &gt;= 0);</span>
<span class="lineNum">    4645 </span>                :            :         } else {
<span class="lineNum">    4646 </span>                :<span class="lineNoCov">          0 :                 arc_c = arc_c_min;</span>
<span class="lineNum">    4647 </span>                :            :         }
<span class="lineNum">    4648 </span>                :            : 
<span class="lineNum">    4649 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 6 times"> + </span>]:<span class="lineCov">          6 :         if (arc_size &gt; arc_c)</span>
<span class="lineNum">    4650 </span>                :<span class="lineNoCov">          0 :                 (void) arc_adjust();</span>
<span class="lineNum">    4651 </span>                :<span class="lineCov">          6 : }</span>
<span class="lineNum">    4652 </span>                :            : 
<span class="lineNum">    4653 </span>                :            : /*
<span class="lineNum">    4654 </span>                :            :  * Return maximum amount of memory that we could possibly use.  Reduced
<span class="lineNum">    4655 </span>                :            :  * to half of all memory in user space which is primarily used for testing.
<a name="4656"><span class="lineNum">    4656 </span>                :            :  */</a>
<span class="lineNum">    4657 </span>                :            : static uint64_t
<span class="lineNum">    4658 </span>                :<span class="lineCov">      39853 : arc_all_memory(void)</span>
<span class="lineNum">    4659 </span>                :            : {
<span class="lineNum">    4660 </span>                :            : #ifdef _KERNEL
<span class="lineNum">    4661 </span>                :            :         return (MIN(ptob(physmem),
<span class="lineNum">    4662 </span>                :            :             vmem_size(heap_arena, VMEM_FREE | VMEM_ALLOC)));
<span class="lineNum">    4663 </span>                :            : #else
<span class="lineNum">    4664 </span>                :<span class="lineCov">      39853 :         return (ptob(physmem) / 2);</span>
<span class="lineNum">    4665 </span>                :            : #endif
<span class="lineNum">    4666 </span>                :            : }
<span class="lineNum">    4667 </span>                :            : 
<span class="lineNum">    4668 </span>                :            : #ifdef _KERNEL
<span class="lineNum">    4669 </span>                :            : static uint64_t
<span class="lineNum">    4670 </span>                :            : arc_free_memory(void)
<span class="lineNum">    4671 </span>                :            : {
<span class="lineNum">    4672 </span>                :            : #ifdef ZFS_GLOBAL_NODE_PAGE_STATE
<span class="lineNum">    4673 </span>                :            :         return (nr_free_pages() +
<span class="lineNum">    4674 </span>                :            :             global_node_page_state(NR_INACTIVE_FILE) +
<span class="lineNum">    4675 </span>                :            :             global_node_page_state(NR_INACTIVE_ANON) +
<span class="lineNum">    4676 </span>                :            :             global_node_page_state(NR_SLAB_RECLAIMABLE));
<span class="lineNum">    4677 </span>                :            : #else
<span class="lineNum">    4678 </span>                :            :         return (nr_free_pages() +
<span class="lineNum">    4679 </span>                :            :             global_page_state(NR_INACTIVE_FILE) +
<span class="lineNum">    4680 </span>                :            :             global_page_state(NR_INACTIVE_ANON) +
<span class="lineNum">    4681 </span>                :            :             global_page_state(NR_SLAB_RECLAIMABLE));
<span class="lineNum">    4682 </span>                :            : #endif
<span class="lineNum">    4683 </span>                :            : }
<span class="lineNum">    4684 </span>                :            : #endif
<span class="lineNum">    4685 </span>                :            : 
<span class="lineNum">    4686 </span>                :            : typedef enum free_memory_reason_t {
<span class="lineNum">    4687 </span>                :            :         FMR_UNKNOWN,
<span class="lineNum">    4688 </span>                :            :         FMR_NEEDFREE,
<span class="lineNum">    4689 </span>                :            :         FMR_LOTSFREE,
<span class="lineNum">    4690 </span>                :            :         FMR_SWAPFS_MINFREE,
<span class="lineNum">    4691 </span>                :            :         FMR_PAGES_PP_MAXIMUM,
<span class="lineNum">    4692 </span>                :            :         FMR_HEAP_ARENA,
<span class="lineNum">    4693 </span>                :            :         FMR_ZIO_ARENA,
<span class="lineNum">    4694 </span>                :            : } free_memory_reason_t;
<span class="lineNum">    4695 </span>                :            : 
<span class="lineNum">    4696 </span>                :            : int64_t last_free_memory;
<span class="lineNum">    4697 </span>                :            : free_memory_reason_t last_free_reason;
<span class="lineNum">    4698 </span>                :            : 
<span class="lineNum">    4699 </span>                :            : #ifdef _KERNEL
<span class="lineNum">    4700 </span>                :            : /*
<span class="lineNum">    4701 </span>                :            :  * Additional reserve of pages for pp_reserve.
<span class="lineNum">    4702 </span>                :            :  */
<span class="lineNum">    4703 </span>                :            : int64_t arc_pages_pp_reserve = 64;
<span class="lineNum">    4704 </span>                :            : 
<span class="lineNum">    4705 </span>                :            : /*
<span class="lineNum">    4706 </span>                :            :  * Additional reserve of pages for swapfs.
<span class="lineNum">    4707 </span>                :            :  */
<span class="lineNum">    4708 </span>                :            : int64_t arc_swapfs_reserve = 64;
<span class="lineNum">    4709 </span>                :            : #endif /* _KERNEL */
<span class="lineNum">    4710 </span>                :            : 
<span class="lineNum">    4711 </span>                :            : /*
<span class="lineNum">    4712 </span>                :            :  * Return the amount of memory that can be consumed before reclaim will be
<span class="lineNum">    4713 </span>                :            :  * needed.  Positive if there is sufficient free memory, negative indicates
<span class="lineNum">    4714 </span>                :            :  * the amount of memory that needs to be freed up.
<a name="4715"><span class="lineNum">    4715 </span>                :            :  */</a>
<span class="lineNum">    4716 </span>                :            : static int64_t
<span class="lineNum">    4717 </span>                :<span class="lineCov">    2457217 : arc_available_memory(void)</span>
<span class="lineNum">    4718 </span>                :            : {
<span class="lineNum">    4719 </span>                :<span class="lineCov">    2457217 :         int64_t lowest = INT64_MAX;</span>
<span class="lineNum">    4720 </span>                :<span class="lineCov">    2457217 :         free_memory_reason_t r = FMR_UNKNOWN;</span>
<span class="lineNum">    4721 </span>                :            : #ifdef _KERNEL
<span class="lineNum">    4722 </span>                :            :         uint64_t available_memory = ptob(arc_free_memory());
<span class="lineNum">    4723 </span>                :            :         int64_t n;
<span class="lineNum">    4724 </span>                :            : #ifdef __linux__
<span class="lineNum">    4725 </span>                :            :         pgcnt_t needfree = btop(arc_need_free);
<span class="lineNum">    4726 </span>                :            :         pgcnt_t lotsfree = btop(arc_sys_free);
<span class="lineNum">    4727 </span>                :            :         pgcnt_t desfree = 0;
<span class="lineNum">    4728 </span>                :            : #endif
<span class="lineNum">    4729 </span>                :            : 
<span class="lineNum">    4730 </span>                :            : #if defined(__i386)
<span class="lineNum">    4731 </span>                :            :         available_memory =
<span class="lineNum">    4732 </span>                :            :             MIN(available_memory, vmem_size(heap_arena, VMEM_FREE));
<span class="lineNum">    4733 </span>                :            : #endif
<span class="lineNum">    4734 </span>                :            : 
<span class="lineNum">    4735 </span>                :            :         if (needfree &gt; 0) {
<span class="lineNum">    4736 </span>                :            :                 n = PAGESIZE * (-needfree);
<span class="lineNum">    4737 </span>                :            :                 if (n &lt; lowest) {
<span class="lineNum">    4738 </span>                :            :                         lowest = n;
<span class="lineNum">    4739 </span>                :            :                         r = FMR_NEEDFREE;
<span class="lineNum">    4740 </span>                :            :                 }
<span class="lineNum">    4741 </span>                :            :         }
<span class="lineNum">    4742 </span>                :            : 
<span class="lineNum">    4743 </span>                :            :         /*
<span class="lineNum">    4744 </span>                :            :          * check that we're out of range of the pageout scanner.  It starts to
<span class="lineNum">    4745 </span>                :            :          * schedule paging if freemem is less than lotsfree and needfree.
<span class="lineNum">    4746 </span>                :            :          * lotsfree is the high-water mark for pageout, and needfree is the
<span class="lineNum">    4747 </span>                :            :          * number of needed free pages.  We add extra pages here to make sure
<span class="lineNum">    4748 </span>                :            :          * the scanner doesn't start up while we're freeing memory.
<span class="lineNum">    4749 </span>                :            :          */
<span class="lineNum">    4750 </span>                :            :         n = PAGESIZE * (btop(available_memory) - lotsfree - needfree - desfree);
<span class="lineNum">    4751 </span>                :            :         if (n &lt; lowest) {
<span class="lineNum">    4752 </span>                :            :                 lowest = n;
<span class="lineNum">    4753 </span>                :            :                 r = FMR_LOTSFREE;
<span class="lineNum">    4754 </span>                :            :         }
<span class="lineNum">    4755 </span>                :            : 
<span class="lineNum">    4756 </span>                :            : #ifndef __linux__
<span class="lineNum">    4757 </span>                :            :         /*
<span class="lineNum">    4758 </span>                :            :          * check to make sure that swapfs has enough space so that anon
<span class="lineNum">    4759 </span>                :            :          * reservations can still succeed. anon_resvmem() checks that the
<span class="lineNum">    4760 </span>                :            :          * availrmem is greater than swapfs_minfree, and the number of reserved
<span class="lineNum">    4761 </span>                :            :          * swap pages.  We also add a bit of extra here just to prevent
<span class="lineNum">    4762 </span>                :            :          * circumstances from getting really dire.
<span class="lineNum">    4763 </span>                :            :          */
<span class="lineNum">    4764 </span>                :            :         n = PAGESIZE * (availrmem - swapfs_minfree - swapfs_reserve -
<span class="lineNum">    4765 </span>                :            :             desfree - arc_swapfs_reserve);
<span class="lineNum">    4766 </span>                :            :         if (n &lt; lowest) {
<span class="lineNum">    4767 </span>                :            :                 lowest = n;
<span class="lineNum">    4768 </span>                :            :                 r = FMR_SWAPFS_MINFREE;
<span class="lineNum">    4769 </span>                :            :         }
<span class="lineNum">    4770 </span>                :            : 
<span class="lineNum">    4771 </span>                :            : 
<span class="lineNum">    4772 </span>                :            :         /*
<span class="lineNum">    4773 </span>                :            :          * Check that we have enough availrmem that memory locking (e.g., via
<span class="lineNum">    4774 </span>                :            :          * mlock(3C) or memcntl(2)) can still succeed.  (pages_pp_maximum
<span class="lineNum">    4775 </span>                :            :          * stores the number of pages that cannot be locked; when availrmem
<span class="lineNum">    4776 </span>                :            :          * drops below pages_pp_maximum, page locking mechanisms such as
<span class="lineNum">    4777 </span>                :            :          * page_pp_lock() will fail.)
<span class="lineNum">    4778 </span>                :            :          */
<span class="lineNum">    4779 </span>                :            :         n = PAGESIZE * (availrmem - pages_pp_maximum -
<span class="lineNum">    4780 </span>                :            :             arc_pages_pp_reserve);
<span class="lineNum">    4781 </span>                :            :         if (n &lt; lowest) {
<span class="lineNum">    4782 </span>                :            :                 lowest = n;
<span class="lineNum">    4783 </span>                :            :                 r = FMR_PAGES_PP_MAXIMUM;
<span class="lineNum">    4784 </span>                :            :         }
<span class="lineNum">    4785 </span>                :            : #endif
<span class="lineNum">    4786 </span>                :            : 
<span class="lineNum">    4787 </span>                :            : #if defined(__i386)
<span class="lineNum">    4788 </span>                :            :         /*
<span class="lineNum">    4789 </span>                :            :          * If we're on an i386 platform, it's possible that we'll exhaust the
<span class="lineNum">    4790 </span>                :            :          * kernel heap space before we ever run out of available physical
<span class="lineNum">    4791 </span>                :            :          * memory.  Most checks of the size of the heap_area compare against
<span class="lineNum">    4792 </span>                :            :          * tune.t_minarmem, which is the minimum available real memory that we
<span class="lineNum">    4793 </span>                :            :          * can have in the system.  However, this is generally fixed at 25 pages
<span class="lineNum">    4794 </span>                :            :          * which is so low that it's useless.  In this comparison, we seek to
<span class="lineNum">    4795 </span>                :            :          * calculate the total heap-size, and reclaim if more than 3/4ths of the
<span class="lineNum">    4796 </span>                :            :          * heap is allocated.  (Or, in the calculation, if less than 1/4th is
<span class="lineNum">    4797 </span>                :            :          * free)
<span class="lineNum">    4798 </span>                :            :          */
<span class="lineNum">    4799 </span>                :            :         n = vmem_size(heap_arena, VMEM_FREE) -
<span class="lineNum">    4800 </span>                :            :             (vmem_size(heap_arena, VMEM_FREE | VMEM_ALLOC) &gt;&gt; 2);
<span class="lineNum">    4801 </span>                :            :         if (n &lt; lowest) {
<span class="lineNum">    4802 </span>                :            :                 lowest = n;
<span class="lineNum">    4803 </span>                :            :                 r = FMR_HEAP_ARENA;
<span class="lineNum">    4804 </span>                :            :         }
<span class="lineNum">    4805 </span>                :            : #endif
<span class="lineNum">    4806 </span>                :            : 
<span class="lineNum">    4807 </span>                :            :         /*
<span class="lineNum">    4808 </span>                :            :          * If zio data pages are being allocated out of a separate heap segment,
<span class="lineNum">    4809 </span>                :            :          * then enforce that the size of available vmem for this arena remains
<span class="lineNum">    4810 </span>                :            :          * above about 1/4th (1/(2^arc_zio_arena_free_shift)) free.
<span class="lineNum">    4811 </span>                :            :          *
<span class="lineNum">    4812 </span>                :            :          * Note that reducing the arc_zio_arena_free_shift keeps more virtual
<span class="lineNum">    4813 </span>                :            :          * memory (in the zio_arena) free, which can avoid memory
<span class="lineNum">    4814 </span>                :            :          * fragmentation issues.
<span class="lineNum">    4815 </span>                :            :          */
<span class="lineNum">    4816 </span>                :            :         if (zio_arena != NULL) {
<span class="lineNum">    4817 </span>                :            :                 n = (int64_t)vmem_size(zio_arena, VMEM_FREE) -
<span class="lineNum">    4818 </span>                :            :                     (vmem_size(zio_arena, VMEM_ALLOC) &gt;&gt;
<span class="lineNum">    4819 </span>                :            :                     arc_zio_arena_free_shift);
<span class="lineNum">    4820 </span>                :            :                 if (n &lt; lowest) {
<span class="lineNum">    4821 </span>                :            :                         lowest = n;
<span class="lineNum">    4822 </span>                :            :                         r = FMR_ZIO_ARENA;
<span class="lineNum">    4823 </span>                :            :                 }
<span class="lineNum">    4824 </span>                :            :         }
<span class="lineNum">    4825 </span>                :            : #else /* _KERNEL */
<span class="lineNum">    4826 </span>                :            :         /* Every 100 calls, free a small amount */
<span class="lineNum">    4827 </span>        [<span class="branchCov" title="Branch 1 was taken 24657 times"> + </span><span class="branchCov" title="Branch 2 was taken 2433227 times"> + </span>]:<span class="lineCov">    2457217 :         if (spa_get_random(100) == 0)</span>
<span class="lineNum">    4828 </span>                :<span class="lineCov">      24657 :                 lowest = -1024;</span>
<span class="lineNum">    4829 </span>                :            : #endif /* _KERNEL */
<span class="lineNum">    4830 </span>                :            : 
<span class="lineNum">    4831 </span>                :<span class="lineCov">    2457884 :         last_free_memory = lowest;</span>
<span class="lineNum">    4832 </span>                :<span class="lineCov">    2457884 :         last_free_reason = r;</span>
<span class="lineNum">    4833 </span>                :            : 
<span class="lineNum">    4834 </span>                :<span class="lineCov">    2457884 :         return (lowest);</span>
<span class="lineNum">    4835 </span>                :            : }
<span class="lineNum">    4836 </span>                :            : 
<span class="lineNum">    4837 </span>                :            : /*
<span class="lineNum">    4838 </span>                :            :  * Determine if the system is under memory pressure and is asking
<span class="lineNum">    4839 </span>                :            :  * to reclaim memory. A return value of B_TRUE indicates that the system
<span class="lineNum">    4840 </span>                :            :  * is under memory pressure and that the arc should adjust accordingly.
<a name="4841"><span class="lineNum">    4841 </span>                :            :  */</a>
<span class="lineNum">    4842 </span>                :            : static boolean_t
<span class="lineNum">    4843 </span>                :<span class="lineCov">    2430806 : arc_reclaim_needed(void)</span>
<span class="lineNum">    4844 </span>                :            : {
<span class="lineNum">    4845 </span>                :<span class="lineCov">    2430806 :         return (arc_available_memory() &lt; 0);</span>
<span class="lineNum">    4846 </span>                :            : }
<a name="4847"><span class="lineNum">    4847 </span>                :            : </a>
<span class="lineNum">    4848 </span>                :            : static void
<span class="lineNum">    4849 </span>                :<span class="lineCov">        253 : arc_kmem_reap_now(void)</span>
<span class="lineNum">    4850 </span>                :            : {
<span class="lineNum">    4851 </span>                :            :         size_t                  i;
<span class="lineNum">    4852 </span>                :<span class="lineCov">        253 :         kmem_cache_t            *prev_cache = NULL;</span>
<span class="lineNum">    4853 </span>                :<span class="lineCov">        253 :         kmem_cache_t            *prev_data_cache = NULL;</span>
<span class="lineNum">    4854 </span>                :            :         extern kmem_cache_t     *zio_buf_cache[];
<span class="lineNum">    4855 </span>                :            :         extern kmem_cache_t     *zio_data_buf_cache[];
<span class="lineNum">    4856 </span>                :            :         extern kmem_cache_t     *range_seg_cache;
<span class="lineNum">    4857 </span>                :            : 
<span class="lineNum">    4858 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 253 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">        253 :         if ((arc_meta_used &gt;= arc_meta_limit) &amp;&amp; zfs_arc_meta_prune) {</span>
<span class="lineNum">    4859 </span>                :            :                 /*
<span class="lineNum">    4860 </span>                :            :                  * We are exceeding our meta-data cache limit.
<span class="lineNum">    4861 </span>                :            :                  * Prune some entries to release holds on meta-data.
<span class="lineNum">    4862 </span>                :            :                  */
<span class="lineNum">    4863 </span>                :<span class="lineNoCov">          0 :                 arc_prune_async(zfs_arc_meta_prune);</span>
<span class="lineNum">    4864 </span>                :            :         }
<span class="lineNum">    4865 </span>                :            : 
<span class="lineNum">    4866 </span>                :            :         for (i = 0; i &lt; SPA_MAXBLOCKSIZE &gt;&gt; SPA_MINBLOCKSHIFT; i++) {
<span class="lineNum">    4867 </span>                :            : #ifdef _ILP32
<span class="lineNum">    4868 </span>                :            :                 /* reach upper limit of cache size on 32-bit */
<span class="lineNum">    4869 </span>                :            :                 if (zio_buf_cache[i] == NULL)
<span class="lineNum">    4870 </span>                :            :                         break;
<span class="lineNum">    4871 </span>                :            : #endif
<span class="lineNum">    4872 </span>                :            :                 if (zio_buf_cache[i] != prev_cache) {
<span class="lineNum">    4873 </span>                :            :                         prev_cache = zio_buf_cache[i];
<span class="lineNum">    4874 </span>                :            :                         kmem_cache_reap_now(zio_buf_cache[i]);
<span class="lineNum">    4875 </span>                :            :                 }
<span class="lineNum">    4876 </span>                :            :                 if (zio_data_buf_cache[i] != prev_data_cache) {
<span class="lineNum">    4877 </span>                :            :                         prev_data_cache = zio_data_buf_cache[i];
<span class="lineNum">    4878 </span>                :            :                         kmem_cache_reap_now(zio_data_buf_cache[i]);
<span class="lineNum">    4879 </span>                :            :                 }
<span class="lineNum">    4880 </span>                :            :         }
<span class="lineNum">    4881 </span>                :<span class="lineCov">        253 :         kmem_cache_reap_now(buf_cache);</span>
<span class="lineNum">    4882 </span>                :<span class="lineCov">        253 :         kmem_cache_reap_now(hdr_full_cache);</span>
<span class="lineNum">    4883 </span>                :<span class="lineCov">        253 :         kmem_cache_reap_now(hdr_l2only_cache);</span>
<span class="lineNum">    4884 </span>                :<span class="lineCov">        253 :         kmem_cache_reap_now(range_seg_cache);</span>
<span class="lineNum">    4885 </span>                :            : 
<span class="lineNum">    4886 </span>                :            :         if (zio_arena != NULL) {
<span class="lineNum">    4887 </span>                :            :                 /*
<span class="lineNum">    4888 </span>                :            :                  * Ask the vmem arena to reclaim unused memory from its
<span class="lineNum">    4889 </span>                :            :                  * quantum caches.
<span class="lineNum">    4890 </span>                :            :                  */
<span class="lineNum">    4891 </span>                :            :                 vmem_qcache_reap(zio_arena);
<span class="lineNum">    4892 </span>                :            :         }
<span class="lineNum">    4893 </span>                :<span class="lineCov">        253 : }</span>
<span class="lineNum">    4894 </span>                :            : 
<span class="lineNum">    4895 </span>                :            : /*
<span class="lineNum">    4896 </span>                :            :  * Threads can block in arc_get_data_impl() waiting for this thread to evict
<span class="lineNum">    4897 </span>                :            :  * enough data and signal them to proceed. When this happens, the threads in
<span class="lineNum">    4898 </span>                :            :  * arc_get_data_impl() are sleeping while holding the hash lock for their
<span class="lineNum">    4899 </span>                :            :  * particular arc header. Thus, we must be careful to never sleep on a
<span class="lineNum">    4900 </span>                :            :  * hash lock in this thread. This is to prevent the following deadlock:
<span class="lineNum">    4901 </span>                :            :  *
<span class="lineNum">    4902 </span>                :            :  *  - Thread A sleeps on CV in arc_get_data_impl() holding hash lock &quot;L&quot;,
<span class="lineNum">    4903 </span>                :            :  *    waiting for the reclaim thread to signal it.
<span class="lineNum">    4904 </span>                :            :  *
<span class="lineNum">    4905 </span>                :            :  *  - arc_reclaim_thread() tries to acquire hash lock &quot;L&quot; using mutex_enter,
<span class="lineNum">    4906 </span>                :            :  *    fails, and goes to sleep forever.
<span class="lineNum">    4907 </span>                :            :  *
<span class="lineNum">    4908 </span>                :            :  * This possible deadlock is avoided by always acquiring a hash lock
<span class="lineNum">    4909 </span>                :            :  * using mutex_tryenter() from arc_reclaim_thread().
<a name="4910"><span class="lineNum">    4910 </span>                :            :  */</a>
<span class="lineNum">    4911 </span>                :            : static void
<span class="lineNum">    4912 </span>                :<span class="lineCov">       1234 : arc_reclaim_thread(void *unused)</span>
<span class="lineNum">    4913 </span>                :            : {
<span class="lineNum">    4914 </span>                :<span class="lineCov">       1234 :         fstrans_cookie_t        cookie = spl_fstrans_mark();</span>
<span class="lineNum">    4915 </span>                :<span class="lineCov">       1234 :         hrtime_t                growtime = 0;</span>
<span class="lineNum">    4916 </span>                :            :         callb_cpr_t             cpr;
<span class="lineNum">    4917 </span>                :            : 
<span class="lineNum">    4918 </span>                :<span class="lineCov">       1234 :         CALLB_CPR_INIT(&amp;cpr, &amp;arc_reclaim_lock, callb_generic_cpr, FTAG);</span>
<span class="lineNum">    4919 </span>                :            : 
<span class="lineNum">    4920 </span>                :<span class="lineCov">       1234 :         mutex_enter(&amp;arc_reclaim_lock);</span>
<span class="lineNum">    4921 </span>        [<span class="branchCov" title="Branch 0 was taken 26279 times"> + </span><span class="branchCov" title="Branch 1 was taken 785 times"> + </span>]:<span class="lineCov">      27064 :         while (!arc_reclaim_thread_exit) {</span>
<span class="lineNum">    4922 </span>                :            :                 int64_t to_free;
<span class="lineNum">    4923 </span>                :<span class="lineCov">      26279 :                 uint64_t evicted = 0;</span>
<span class="lineNum">    4924 </span>                :<span class="lineCov">      26279 :                 uint64_t need_free = arc_need_free;</span>
<span class="lineNum">    4925 </span>                :<span class="lineCov">      26279 :                 arc_tuning_update();</span>
<span class="lineNum">    4926 </span>                :            : 
<span class="lineNum">    4927 </span>                :            :                 /*
<span class="lineNum">    4928 </span>                :            :                  * This is necessary in order for the mdb ::arc dcmd to
<span class="lineNum">    4929 </span>                :            :                  * show up to date information. Since the ::arc command
<span class="lineNum">    4930 </span>                :            :                  * does not call the kstat's update function, without
<span class="lineNum">    4931 </span>                :            :                  * this call, the command may show stale stats for the
<span class="lineNum">    4932 </span>                :            :                  * anon, mru, mru_ghost, mfu, and mfu_ghost lists. Even
<span class="lineNum">    4933 </span>                :            :                  * with this change, the data might be up to 1 second
<span class="lineNum">    4934 </span>                :            :                  * out of date; but that should suffice. The arc_state_t
<span class="lineNum">    4935 </span>                :            :                  * structures can be queried directly if more accurate
<span class="lineNum">    4936 </span>                :            :                  * information is needed.
<span class="lineNum">    4937 </span>                :            :                  */
<span class="lineNum">    4938 </span>                :            : #ifndef __linux__
<span class="lineNum">    4939 </span>                :            :                 if (arc_ksp != NULL)
<span class="lineNum">    4940 </span>                :            :                         arc_ksp-&gt;ks_update(arc_ksp, KSTAT_READ);
<span class="lineNum">    4941 </span>                :            : #endif
<span class="lineNum">    4942 </span>                :<span class="lineCov">      26279 :                 mutex_exit(&amp;arc_reclaim_lock);</span>
<span class="lineNum">    4943 </span>                :            : 
<span class="lineNum">    4944 </span>                :            :                 /*
<span class="lineNum">    4945 </span>                :            :                  * We call arc_adjust() before (possibly) calling
<span class="lineNum">    4946 </span>                :            :                  * arc_kmem_reap_now(), so that we can wake up
<span class="lineNum">    4947 </span>                :            :                  * arc_get_data_buf() sooner.
<span class="lineNum">    4948 </span>                :            :                  */
<span class="lineNum">    4949 </span>                :<span class="lineCov">      26279 :                 evicted = arc_adjust();</span>
<span class="lineNum">    4950 </span>                :            : 
<span class="lineNum">    4951 </span>                :<span class="lineCov">      26279 :                 int64_t free_memory = arc_available_memory();</span>
<span class="lineNum">    4952 </span>        [<span class="branchCov" title="Branch 0 was taken 253 times"> + </span><span class="branchCov" title="Branch 1 was taken 26026 times"> + </span>]:<span class="lineCov">      26279 :                 if (free_memory &lt; 0) {</span>
<span class="lineNum">    4953 </span>                :            : 
<span class="lineNum">    4954 </span>                :<span class="lineCov">        253 :                         arc_no_grow = B_TRUE;</span>
<span class="lineNum">    4955 </span>                :<span class="lineCov">        253 :                         arc_warm = B_TRUE;</span>
<span class="lineNum">    4956 </span>                :            : 
<span class="lineNum">    4957 </span>                :            :                         /*
<span class="lineNum">    4958 </span>                :            :                          * Wait at least zfs_grow_retry (default 5) seconds
<span class="lineNum">    4959 </span>                :            :                          * before considering growing.
<span class="lineNum">    4960 </span>                :            :                          */
<span class="lineNum">    4961 </span>                :<span class="lineCov">        253 :                         growtime = gethrtime() + SEC2NSEC(arc_grow_retry);</span>
<span class="lineNum">    4962 </span>                :            : 
<span class="lineNum">    4963 </span>                :<span class="lineCov">        253 :                         arc_kmem_reap_now();</span>
<span class="lineNum">    4964 </span>                :            : 
<span class="lineNum">    4965 </span>                :            :                         /*
<span class="lineNum">    4966 </span>                :            :                          * If we are still low on memory, shrink the ARC
<span class="lineNum">    4967 </span>                :            :                          * so that we have arc_shrink_min free space.
<span class="lineNum">    4968 </span>                :            :                          */
<span class="lineNum">    4969 </span>                :<span class="lineCov">        253 :                         free_memory = arc_available_memory();</span>
<span class="lineNum">    4970 </span>                :            : 
<span class="lineNum">    4971 </span>                :<span class="lineCov">        253 :                         to_free = (arc_c &gt;&gt; arc_shrink_shift) - free_memory;</span>
<span class="lineNum">    4972 </span>        [<span class="branchCov" title="Branch 0 was taken 6 times"> + </span><span class="branchCov" title="Branch 1 was taken 247 times"> + </span>]:<span class="lineCov">        253 :                         if (to_free &gt; 0) {</span>
<span class="lineNum">    4973 </span>                :            : #ifdef _KERNEL
<span class="lineNum">    4974 </span>                :            :                                 to_free = MAX(to_free, need_free);
<span class="lineNum">    4975 </span>                :            : #endif
<span class="lineNum">    4976 </span>                :<span class="lineCov">          6 :                                 arc_shrink(to_free);</span>
<span class="lineNum">    4977 </span>                :            :                         }
<span class="lineNum">    4978 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 26026 times"> + </span>]:<span class="lineCov">      26026 :                 } else if (free_memory &lt; arc_c &gt;&gt; arc_no_grow_shift) {</span>
<span class="lineNum">    4979 </span>                :<span class="lineNoCov">          0 :                         arc_no_grow = B_TRUE;</span>
<span class="lineNum">    4980 </span>        [<span class="branchCov" title="Branch 1 was taken 19785 times"> + </span><span class="branchCov" title="Branch 2 was taken 6241 times"> + </span>]:<span class="lineCov">      26026 :                 } else if (gethrtime() &gt;= growtime) {</span>
<span class="lineNum">    4981 </span>                :<span class="lineCov">      19785 :                         arc_no_grow = B_FALSE;</span>
<span class="lineNum">    4982 </span>                :            :                 }
<span class="lineNum">    4983 </span>                :            : 
<span class="lineNum">    4984 </span>                :<span class="lineCov">      26279 :                 mutex_enter(&amp;arc_reclaim_lock);</span>
<span class="lineNum">    4985 </span>                :            : 
<span class="lineNum">    4986 </span>                :            :                 /*
<span class="lineNum">    4987 </span>                :            :                  * If evicted is zero, we couldn't evict anything via
<span class="lineNum">    4988 </span>                :            :                  * arc_adjust(). This could be due to hash lock
<span class="lineNum">    4989 </span>                :            :                  * collisions, but more likely due to the majority of
<span class="lineNum">    4990 </span>                :            :                  * arc buffers being unevictable. Therefore, even if
<span class="lineNum">    4991 </span>                :            :                  * arc_size is above arc_c, another pass is unlikely to
<span class="lineNum">    4992 </span>                :            :                  * be helpful and could potentially cause us to enter an
<span class="lineNum">    4993 </span>                :            :                  * infinite loop.
<span class="lineNum">    4994 </span>                :            :                  */
<span class="lineNum">    4995 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 26279 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">      26279 :                 if (arc_size &lt;= arc_c || evicted == 0) {</span>
<span class="lineNum">    4996 </span>                :            :                         /*
<span class="lineNum">    4997 </span>                :            :                          * We're either no longer overflowing, or we
<span class="lineNum">    4998 </span>                :            :                          * can't evict anything more, so we should wake
<span class="lineNum">    4999 </span>                :            :                          * up any threads before we go to sleep and remove
<span class="lineNum">    5000 </span>                :            :                          * the bytes we were working on from arc_need_free
<span class="lineNum">    5001 </span>                :            :                          * since nothing more will be done here.
<span class="lineNum">    5002 </span>                :            :                          */
<span class="lineNum">    5003 </span>                :<span class="lineCov">      26279 :                         cv_broadcast(&amp;arc_reclaim_waiters_cv);</span>
<span class="lineNum">    5004 </span>                :<span class="lineCov">      26279 :                         ARCSTAT_INCR(arcstat_need_free, -need_free);</span>
<span class="lineNum">    5005 </span>                :            : 
<span class="lineNum">    5006 </span>                :            :                         /*
<span class="lineNum">    5007 </span>                :            :                          * Block until signaled, or after one second (we
<span class="lineNum">    5008 </span>                :            :                          * might need to perform arc_kmem_reap_now()
<span class="lineNum">    5009 </span>                :            :                          * even if we aren't being signalled)
<span class="lineNum">    5010 </span>                :            :                          */
<span class="lineNum">    5011 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 26279 times"> + </span>]:<span class="lineCov">      26279 :                         CALLB_CPR_SAFE_BEGIN(&amp;cpr);</span>
<span class="lineNum">    5012 </span>                :<span class="lineCov">      26279 :                         (void) cv_timedwait_sig_hires(&amp;arc_reclaim_thread_cv,</span>
<span class="lineNum">    5013 </span>                :            :                             &amp;arc_reclaim_lock, SEC2NSEC(1), MSEC2NSEC(1), 0);
<span class="lineNum">    5014 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 25830 times"> + </span>]:<span class="lineCov">      25830 :                         CALLB_CPR_SAFE_END(&amp;cpr, &amp;arc_reclaim_lock);</span>
<span class="lineNum">    5015 </span>                :            :                 }
<span class="lineNum">    5016 </span>                :            :         }
<span class="lineNum">    5017 </span>                :            : 
<span class="lineNum">    5018 </span>                :<span class="lineCov">        785 :         arc_reclaim_thread_exit = B_FALSE;</span>
<span class="lineNum">    5019 </span>                :<span class="lineCov">        785 :         cv_broadcast(&amp;arc_reclaim_thread_cv);</span>
<span class="lineNum">    5020 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 785 times"> + </span>]:<span class="lineCov">        785 :         CALLB_CPR_EXIT(&amp;cpr);               /* drops arc_reclaim_lock */</span>
<span class="lineNum">    5021 </span>                :<span class="lineCov">        785 :         spl_fstrans_unmark(cookie);</span>
<span class="lineNum">    5022 </span>                :<span class="lineCov">        785 :         thread_exit();</span>
<span class="lineNum">    5023 </span>                :            : }
<span class="lineNum">    5024 </span>                :            : 
<span class="lineNum">    5025 </span>                :            : #ifdef _KERNEL
<span class="lineNum">    5026 </span>                :            : /*
<span class="lineNum">    5027 </span>                :            :  * Determine the amount of memory eligible for eviction contained in the
<span class="lineNum">    5028 </span>                :            :  * ARC. All clean data reported by the ghost lists can always be safely
<span class="lineNum">    5029 </span>                :            :  * evicted. Due to arc_c_min, the same does not hold for all clean data
<span class="lineNum">    5030 </span>                :            :  * contained by the regular mru and mfu lists.
<span class="lineNum">    5031 </span>                :            :  *
<span class="lineNum">    5032 </span>                :            :  * In the case of the regular mru and mfu lists, we need to report as
<span class="lineNum">    5033 </span>                :            :  * much clean data as possible, such that evicting that same reported
<span class="lineNum">    5034 </span>                :            :  * data will not bring arc_size below arc_c_min. Thus, in certain
<span class="lineNum">    5035 </span>                :            :  * circumstances, the total amount of clean data in the mru and mfu
<span class="lineNum">    5036 </span>                :            :  * lists might not actually be evictable.
<span class="lineNum">    5037 </span>                :            :  *
<span class="lineNum">    5038 </span>                :            :  * The following two distinct cases are accounted for:
<span class="lineNum">    5039 </span>                :            :  *
<span class="lineNum">    5040 </span>                :            :  * 1. The sum of the amount of dirty data contained by both the mru and
<span class="lineNum">    5041 </span>                :            :  *    mfu lists, plus the ARC's other accounting (e.g. the anon list),
<span class="lineNum">    5042 </span>                :            :  *    is greater than or equal to arc_c_min.
<span class="lineNum">    5043 </span>                :            :  *    (i.e. amount of dirty data &gt;= arc_c_min)
<span class="lineNum">    5044 </span>                :            :  *
<span class="lineNum">    5045 </span>                :            :  *    This is the easy case; all clean data contained by the mru and mfu
<span class="lineNum">    5046 </span>                :            :  *    lists is evictable. Evicting all clean data can only drop arc_size
<span class="lineNum">    5047 </span>                :            :  *    to the amount of dirty data, which is greater than arc_c_min.
<span class="lineNum">    5048 </span>                :            :  *
<span class="lineNum">    5049 </span>                :            :  * 2. The sum of the amount of dirty data contained by both the mru and
<span class="lineNum">    5050 </span>                :            :  *    mfu lists, plus the ARC's other accounting (e.g. the anon list),
<span class="lineNum">    5051 </span>                :            :  *    is less than arc_c_min.
<span class="lineNum">    5052 </span>                :            :  *    (i.e. arc_c_min &gt; amount of dirty data)
<span class="lineNum">    5053 </span>                :            :  *
<span class="lineNum">    5054 </span>                :            :  *    2.1. arc_size is greater than or equal arc_c_min.
<span class="lineNum">    5055 </span>                :            :  *         (i.e. arc_size &gt;= arc_c_min &gt; amount of dirty data)
<span class="lineNum">    5056 </span>                :            :  *
<span class="lineNum">    5057 </span>                :            :  *         In this case, not all clean data from the regular mru and mfu
<span class="lineNum">    5058 </span>                :            :  *         lists is actually evictable; we must leave enough clean data
<span class="lineNum">    5059 </span>                :            :  *         to keep arc_size above arc_c_min. Thus, the maximum amount of
<span class="lineNum">    5060 </span>                :            :  *         evictable data from the two lists combined, is exactly the
<span class="lineNum">    5061 </span>                :            :  *         difference between arc_size and arc_c_min.
<span class="lineNum">    5062 </span>                :            :  *
<span class="lineNum">    5063 </span>                :            :  *    2.2. arc_size is less than arc_c_min
<span class="lineNum">    5064 </span>                :            :  *         (i.e. arc_c_min &gt; arc_size &gt; amount of dirty data)
<span class="lineNum">    5065 </span>                :            :  *
<span class="lineNum">    5066 </span>                :            :  *         In this case, none of the data contained in the mru and mfu
<span class="lineNum">    5067 </span>                :            :  *         lists is evictable, even if it's clean. Since arc_size is
<span class="lineNum">    5068 </span>                :            :  *         already below arc_c_min, evicting any more would only
<span class="lineNum">    5069 </span>                :            :  *         increase this negative difference.
<span class="lineNum">    5070 </span>                :            :  */
<span class="lineNum">    5071 </span>                :            : static uint64_t
<span class="lineNum">    5072 </span>                :            : arc_evictable_memory(void)
<span class="lineNum">    5073 </span>                :            : {
<span class="lineNum">    5074 </span>                :            :         uint64_t arc_clean =
<span class="lineNum">    5075 </span>                :            :             refcount_count(&amp;arc_mru-&gt;arcs_esize[ARC_BUFC_DATA]) +
<span class="lineNum">    5076 </span>                :            :             refcount_count(&amp;arc_mru-&gt;arcs_esize[ARC_BUFC_METADATA]) +
<span class="lineNum">    5077 </span>                :            :             refcount_count(&amp;arc_mfu-&gt;arcs_esize[ARC_BUFC_DATA]) +
<span class="lineNum">    5078 </span>                :            :             refcount_count(&amp;arc_mfu-&gt;arcs_esize[ARC_BUFC_METADATA]);
<span class="lineNum">    5079 </span>                :            :         uint64_t arc_dirty = MAX((int64_t)arc_size - (int64_t)arc_clean, 0);
<span class="lineNum">    5080 </span>                :            : 
<span class="lineNum">    5081 </span>                :            :         /*
<span class="lineNum">    5082 </span>                :            :          * Scale reported evictable memory in proportion to page cache, cap
<span class="lineNum">    5083 </span>                :            :          * at specified min/max.
<span class="lineNum">    5084 </span>                :            :          */
<span class="lineNum">    5085 </span>                :            : #ifdef ZFS_GLOBAL_NODE_PAGE_STATE
<span class="lineNum">    5086 </span>                :            :         uint64_t min = (ptob(global_node_page_state(NR_FILE_PAGES)) / 100) *
<span class="lineNum">    5087 </span>                :            :             zfs_arc_pc_percent;
<span class="lineNum">    5088 </span>                :            : #else
<span class="lineNum">    5089 </span>                :            :         uint64_t min = (ptob(global_page_state(NR_FILE_PAGES)) / 100) *
<span class="lineNum">    5090 </span>                :            :             zfs_arc_pc_percent;
<span class="lineNum">    5091 </span>                :            : #endif
<span class="lineNum">    5092 </span>                :            :         min = MAX(arc_c_min, MIN(arc_c_max, min));
<span class="lineNum">    5093 </span>                :            : 
<span class="lineNum">    5094 </span>                :            :         if (arc_dirty &gt;= min)
<span class="lineNum">    5095 </span>                :            :                 return (arc_clean);
<span class="lineNum">    5096 </span>                :            : 
<span class="lineNum">    5097 </span>                :            :         return (MAX((int64_t)arc_size - (int64_t)min, 0));
<span class="lineNum">    5098 </span>                :            : }
<span class="lineNum">    5099 </span>                :            : 
<span class="lineNum">    5100 </span>                :            : /*
<span class="lineNum">    5101 </span>                :            :  * If sc-&gt;nr_to_scan is zero, the caller is requesting a query of the
<span class="lineNum">    5102 </span>                :            :  * number of objects which can potentially be freed.  If it is nonzero,
<span class="lineNum">    5103 </span>                :            :  * the request is to free that many objects.
<span class="lineNum">    5104 </span>                :            :  *
<span class="lineNum">    5105 </span>                :            :  * Linux kernels &gt;= 3.12 have the count_objects and scan_objects callbacks
<span class="lineNum">    5106 </span>                :            :  * in struct shrinker and also require the shrinker to return the number
<span class="lineNum">    5107 </span>                :            :  * of objects freed.
<span class="lineNum">    5108 </span>                :            :  *
<span class="lineNum">    5109 </span>                :            :  * Older kernels require the shrinker to return the number of freeable
<span class="lineNum">    5110 </span>                :            :  * objects following the freeing of nr_to_free.
<span class="lineNum">    5111 </span>                :            :  */
<span class="lineNum">    5112 </span>                :            : static spl_shrinker_t
<span class="lineNum">    5113 </span>                :            : __arc_shrinker_func(struct shrinker *shrink, struct shrink_control *sc)
<span class="lineNum">    5114 </span>                :            : {
<span class="lineNum">    5115 </span>                :            :         int64_t pages;
<span class="lineNum">    5116 </span>                :            : 
<span class="lineNum">    5117 </span>                :            :         /* The arc is considered warm once reclaim has occurred */
<span class="lineNum">    5118 </span>                :            :         if (unlikely(arc_warm == B_FALSE))
<span class="lineNum">    5119 </span>                :            :                 arc_warm = B_TRUE;
<span class="lineNum">    5120 </span>                :            : 
<span class="lineNum">    5121 </span>                :            :         /* Return the potential number of reclaimable pages */
<span class="lineNum">    5122 </span>                :            :         pages = btop((int64_t)arc_evictable_memory());
<span class="lineNum">    5123 </span>                :            :         if (sc-&gt;nr_to_scan == 0)
<span class="lineNum">    5124 </span>                :            :                 return (pages);
<span class="lineNum">    5125 </span>                :            : 
<span class="lineNum">    5126 </span>                :            :         /* Not allowed to perform filesystem reclaim */
<span class="lineNum">    5127 </span>                :            :         if (!(sc-&gt;gfp_mask &amp; __GFP_FS))
<span class="lineNum">    5128 </span>                :            :                 return (SHRINK_STOP);
<span class="lineNum">    5129 </span>                :            : 
<span class="lineNum">    5130 </span>                :            :         /* Reclaim in progress */
<span class="lineNum">    5131 </span>                :            :         if (mutex_tryenter(&amp;arc_reclaim_lock) == 0) {
<span class="lineNum">    5132 </span>                :            :                 ARCSTAT_INCR(arcstat_need_free, ptob(sc-&gt;nr_to_scan));
<span class="lineNum">    5133 </span>                :            :                 return (0);
<span class="lineNum">    5134 </span>                :            :         }
<span class="lineNum">    5135 </span>                :            : 
<span class="lineNum">    5136 </span>                :            :         mutex_exit(&amp;arc_reclaim_lock);
<span class="lineNum">    5137 </span>                :            : 
<span class="lineNum">    5138 </span>                :            :         /*
<span class="lineNum">    5139 </span>                :            :          * Evict the requested number of pages by shrinking arc_c the
<span class="lineNum">    5140 </span>                :            :          * requested amount.
<span class="lineNum">    5141 </span>                :            :          */
<span class="lineNum">    5142 </span>                :            :         if (pages &gt; 0) {
<span class="lineNum">    5143 </span>                :            :                 arc_shrink(ptob(sc-&gt;nr_to_scan));
<span class="lineNum">    5144 </span>                :            :                 if (current_is_kswapd())
<span class="lineNum">    5145 </span>                :            :                         arc_kmem_reap_now();
<span class="lineNum">    5146 </span>                :            : #ifdef HAVE_SPLIT_SHRINKER_CALLBACK
<span class="lineNum">    5147 </span>                :            :                 pages = MAX((int64_t)pages -
<span class="lineNum">    5148 </span>                :            :                     (int64_t)btop(arc_evictable_memory()), 0);
<span class="lineNum">    5149 </span>                :            : #else
<span class="lineNum">    5150 </span>                :            :                 pages = btop(arc_evictable_memory());
<span class="lineNum">    5151 </span>                :            : #endif
<span class="lineNum">    5152 </span>                :            :                 /*
<span class="lineNum">    5153 </span>                :            :                  * We've shrunk what we can, wake up threads.
<span class="lineNum">    5154 </span>                :            :                  */
<span class="lineNum">    5155 </span>                :            :                 cv_broadcast(&amp;arc_reclaim_waiters_cv);
<span class="lineNum">    5156 </span>                :            :         } else
<span class="lineNum">    5157 </span>                :            :                 pages = SHRINK_STOP;
<span class="lineNum">    5158 </span>                :            : 
<span class="lineNum">    5159 </span>                :            :         /*
<span class="lineNum">    5160 </span>                :            :          * When direct reclaim is observed it usually indicates a rapid
<span class="lineNum">    5161 </span>                :            :          * increase in memory pressure.  This occurs because the kswapd
<span class="lineNum">    5162 </span>                :            :          * threads were unable to asynchronously keep enough free memory
<span class="lineNum">    5163 </span>                :            :          * available.  In this case set arc_no_grow to briefly pause arc
<span class="lineNum">    5164 </span>                :            :          * growth to avoid compounding the memory pressure.
<span class="lineNum">    5165 </span>                :            :          */
<span class="lineNum">    5166 </span>                :            :         if (current_is_kswapd()) {
<span class="lineNum">    5167 </span>                :            :                 ARCSTAT_BUMP(arcstat_memory_indirect_count);
<span class="lineNum">    5168 </span>                :            :         } else {
<span class="lineNum">    5169 </span>                :            :                 arc_no_grow = B_TRUE;
<span class="lineNum">    5170 </span>                :            :                 arc_kmem_reap_now();
<span class="lineNum">    5171 </span>                :            :                 ARCSTAT_BUMP(arcstat_memory_direct_count);
<span class="lineNum">    5172 </span>                :            :         }
<span class="lineNum">    5173 </span>                :            : 
<span class="lineNum">    5174 </span>                :            :         return (pages);
<span class="lineNum">    5175 </span>                :            : }
<span class="lineNum">    5176 </span>                :            : SPL_SHRINKER_CALLBACK_WRAPPER(arc_shrinker_func);
<span class="lineNum">    5177 </span>                :            : 
<span class="lineNum">    5178 </span>                :            : SPL_SHRINKER_DECLARE(arc_shrinker, arc_shrinker_func, DEFAULT_SEEKS);
<span class="lineNum">    5179 </span>                :            : #endif /* _KERNEL */
<span class="lineNum">    5180 </span>                :            : 
<span class="lineNum">    5181 </span>                :            : /*
<span class="lineNum">    5182 </span>                :            :  * Adapt arc info given the number of bytes we are trying to add and
<span class="lineNum">    5183 </span>                :            :  * the state that we are coming from.  This function is only called
<span class="lineNum">    5184 </span>                :            :  * when we are adding new content to the cache.
<a name="5185"><span class="lineNum">    5185 </span>                :            :  */</a>
<span class="lineNum">    5186 </span>                :            : static void
<span class="lineNum">    5187 </span>                :<span class="lineCov">    2430068 : arc_adapt(int bytes, arc_state_t *state)</span>
<span class="lineNum">    5188 </span>                :            : {
<span class="lineNum">    5189 </span>                :            :         int mult;
<span class="lineNum">    5190 </span>                :<span class="lineCov">    2430068 :         uint64_t arc_p_min = (arc_c &gt;&gt; arc_p_min_shift);</span>
<span class="lineNum">    5191 </span>                :<span class="lineCov">    2430068 :         int64_t mrug_size = refcount_count(&amp;arc_mru_ghost-&gt;arcs_size);</span>
<span class="lineNum">    5192 </span>                :<span class="lineCov">    2430085 :         int64_t mfug_size = refcount_count(&amp;arc_mfu_ghost-&gt;arcs_size);</span>
<span class="lineNum">    5193 </span>                :            : 
<span class="lineNum">    5194 </span>           [<span class="branchCov" title="Branch 0 was taken 2430508 times"> + </span>]:<span class="lineCov">    2430397 :         if (state == arc_l2c_only)</span>
<span class="lineNum">    5195 </span>                :            :                 return;
<span class="lineNum">    5196 </span>                :            : 
<span class="lineNum">    5197 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2430508 times"> + </span>]:<span class="lineCov">    2430508 :         ASSERT(bytes &gt; 0);</span>
<span class="lineNum">    5198 </span>                :            :         /*
<span class="lineNum">    5199 </span>                :            :          * Adapt the target size of the MRU list:
<span class="lineNum">    5200 </span>                :            :          *      - if we just hit in the MRU ghost list, then increase
<span class="lineNum">    5201 </span>                :            :          *        the target size of the MRU list.
<span class="lineNum">    5202 </span>                :            :          *      - if we just hit in the MFU ghost list, then increase
<span class="lineNum">    5203 </span>                :            :          *        the target size of the MFU list by decreasing the
<span class="lineNum">    5204 </span>                :            :          *        target size of the MRU list.
<span class="lineNum">    5205 </span>                :            :          */
<span class="lineNum">    5206 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2430508 times"> + </span>]:<span class="lineCov">    2430508 :         if (state == arc_mru_ghost) {</span>
<span class="lineNum">    5207 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 mult = (mrug_size &gt;= mfug_size) ? 1 : (mfug_size / mrug_size);</span>
<span class="lineNum">    5208 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (!zfs_arc_p_dampener_disable)</span>
<span class="lineNum">    5209 </span>                :<span class="lineNoCov">          0 :                         mult = MIN(mult, 10); /* avoid wild arc_p adjustment */</span>
<span class="lineNum">    5210 </span>                :            : 
<span class="lineNum">    5211 </span>                :<span class="lineNoCov">          0 :                 arc_p = MIN(arc_c - arc_p_min, arc_p + bytes * mult);</span>
<span class="lineNum">    5212 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2430508 times"> + </span>]:<span class="lineCov">    2430508 :         } else if (state == arc_mfu_ghost) {</span>
<span class="lineNum">    5213 </span>                :            :                 uint64_t delta;
<span class="lineNum">    5214 </span>                :            : 
<span class="lineNum">    5215 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 mult = (mfug_size &gt;= mrug_size) ? 1 : (mrug_size / mfug_size);</span>
<span class="lineNum">    5216 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (!zfs_arc_p_dampener_disable)</span>
<span class="lineNum">    5217 </span>                :<span class="lineNoCov">          0 :                         mult = MIN(mult, 10);</span>
<span class="lineNum">    5218 </span>                :            : 
<span class="lineNum">    5219 </span>                :<span class="lineNoCov">          0 :                 delta = MIN(bytes * mult, arc_p);</span>
<span class="lineNum">    5220 </span>                :<span class="lineNoCov">          0 :                 arc_p = MAX(arc_p_min, arc_p - delta);</span>
<span class="lineNum">    5221 </span>                :            :         }
<span class="lineNum">    5222 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2430508 times"> + </span>]:<span class="lineCov">    2430508 :         ASSERT((int64_t)arc_p &gt;= 0);</span>
<span class="lineNum">    5223 </span>                :            : 
<span class="lineNum">    5224 </span>        [<span class="branchCov" title="Branch 1 was taken 24398 times"> + </span><span class="branchCov" title="Branch 2 was taken 2406365 times"> + </span>]:<span class="lineCov">    2430508 :         if (arc_reclaim_needed()) {</span>
<span class="lineNum">    5225 </span>                :<span class="lineCov">      24398 :                 cv_signal(&amp;arc_reclaim_thread_cv);</span>
<span class="lineNum">    5226 </span>                :<span class="lineCov">      24398 :                 return;</span>
<span class="lineNum">    5227 </span>                :            :         }
<span class="lineNum">    5228 </span>                :            : 
<span class="lineNum">    5229 </span>        [<span class="branchCov" title="Branch 0 was taken 1782227 times"> + </span><span class="branchCov" title="Branch 1 was taken 624138 times"> + </span>]:<span class="lineCov">    2406365 :         if (arc_no_grow)</span>
<span class="lineNum">    5230 </span>                :            :                 return;
<span class="lineNum">    5231 </span>                :            : 
<span class="lineNum">    5232 </span>        [<span class="branchCov" title="Branch 0 was taken 40617 times"> + </span><span class="branchCov" title="Branch 1 was taken 1741610 times"> + </span>]:<span class="lineCov">    1782227 :         if (arc_c &gt;= arc_c_max)</span>
<span class="lineNum">    5233 </span>                :            :                 return;
<span class="lineNum">    5234 </span>                :            : 
<span class="lineNum">    5235 </span>                :            :         /*
<span class="lineNum">    5236 </span>                :            :          * If we're within (2 * maxblocksize) bytes of the target
<span class="lineNum">    5237 </span>                :            :          * cache size, increment the target cache size
<span class="lineNum">    5238 </span>                :            :          */
<span class="lineNum">    5239 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 40617 times"> + </span>]:<span class="lineCov">      40617 :         ASSERT3U(arc_c, &gt;=, 2ULL &lt;&lt; SPA_MAXBLOCKSHIFT);</span>
<span class="lineNum">    5240 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 40617 times"> + </span>]:<span class="lineCov">      40617 :         if (arc_size &gt;= arc_c - (2ULL &lt;&lt; SPA_MAXBLOCKSHIFT)) {</span>
<span class="lineNum">    5241 </span>                :<span class="lineNoCov">          0 :                 atomic_add_64(&amp;arc_c, (int64_t)bytes);</span>
<span class="lineNum">    5242 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (arc_c &gt; arc_c_max)</span>
<span class="lineNum">    5243 </span>                :<span class="lineNoCov">          0 :                         arc_c = arc_c_max;</span>
<span class="lineNum">    5244 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 else if (state == arc_anon)</span>
<span class="lineNum">    5245 </span>                :<span class="lineNoCov">          0 :                         atomic_add_64(&amp;arc_p, (int64_t)bytes);</span>
<span class="lineNum">    5246 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (arc_p &gt; arc_c)</span>
<span class="lineNum">    5247 </span>                :<span class="lineNoCov">          0 :                         arc_p = arc_c;</span>
<span class="lineNum">    5248 </span>                :            :         }
<span class="lineNum">    5249 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 40617 times"> + </span>]:<span class="lineCov">      40617 :         ASSERT((int64_t)arc_p &gt;= 0);</span>
<span class="lineNum">    5250 </span>                :            : }
<span class="lineNum">    5251 </span>                :            : 
<span class="lineNum">    5252 </span>                :            : /*
<span class="lineNum">    5253 </span>                :            :  * Check if arc_size has grown past our upper threshold, determined by
<span class="lineNum">    5254 </span>                :            :  * zfs_arc_overflow_shift.
<a name="5255"><span class="lineNum">    5255 </span>                :            :  */</a>
<span class="lineNum">    5256 </span>                :            : static boolean_t
<span class="lineNum">    5257 </span>                :<span class="lineCov"> 1025712281 : arc_is_overflowing(void)</span>
<span class="lineNum">    5258 </span>                :            : {
<span class="lineNum">    5259 </span>                :            :         /* Always allow at least one block of overflow */
<span class="lineNum">    5260 </span>                :<span class="lineCov"> 1025712281 :         uint64_t overflow = MAX(SPA_MAXBLOCKSIZE,</span>
<span class="lineNum">    5261 </span>                :            :             arc_c &gt;&gt; zfs_arc_overflow_shift);
<span class="lineNum">    5262 </span>                :            : 
<span class="lineNum">    5263 </span>                :<span class="lineCov"> 1025712281 :         return (arc_size &gt;= arc_c + overflow);</span>
<span class="lineNum">    5264 </span>                :            : }
<a name="5265"><span class="lineNum">    5265 </span>                :            : </a>
<span class="lineNum">    5266 </span>                :            : static abd_t *
<span class="lineNum">    5267 </span>                :<span class="lineCov">    2020646 : arc_get_data_abd(arc_buf_hdr_t *hdr, uint64_t size, void *tag)</span>
<span class="lineNum">    5268 </span>                :            : {
<span class="lineNum">    5269 </span>                :<span class="lineCov">    2020646 :         arc_buf_contents_t type = arc_buf_type(hdr);</span>
<span class="lineNum">    5270 </span>                :            : 
<span class="lineNum">    5271 </span>                :<span class="lineCov">    2020703 :         arc_get_data_impl(hdr, size, tag);</span>
<span class="lineNum">    5272 </span>        [<span class="branchCov" title="Branch 0 was taken 1878898 times"> + </span><span class="branchCov" title="Branch 1 was taken 143300 times"> + </span>]:<span class="lineCov">    2022198 :         if (type == ARC_BUFC_METADATA) {</span>
<span class="lineNum">    5273 </span>                :<span class="lineCov">    1878898 :                 return (abd_alloc(size, B_TRUE));</span>
<span class="lineNum">    5274 </span>                :            :         } else {
<span class="lineNum">    5275 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 143300 times"> + </span>]:<span class="lineCov">     143300 :                 ASSERT(type == ARC_BUFC_DATA);</span>
<span class="lineNum">    5276 </span>                :<span class="lineCov">     143300 :                 return (abd_alloc(size, B_FALSE));</span>
<span class="lineNum">    5277 </span>                :            :         }
<span class="lineNum">    5278 </span>                :            : }
<a name="5279"><span class="lineNum">    5279 </span>                :            : </a>
<span class="lineNum">    5280 </span>                :            : static void *
<span class="lineNum">    5281 </span>                :<span class="lineCov">     409340 : arc_get_data_buf(arc_buf_hdr_t *hdr, uint64_t size, void *tag)</span>
<span class="lineNum">    5282 </span>                :            : {
<span class="lineNum">    5283 </span>                :<span class="lineCov">     409340 :         arc_buf_contents_t type = arc_buf_type(hdr);</span>
<span class="lineNum">    5284 </span>                :            : 
<span class="lineNum">    5285 </span>                :<span class="lineCov">     409337 :         arc_get_data_impl(hdr, size, tag);</span>
<span class="lineNum">    5286 </span>        [<span class="branchCov" title="Branch 0 was taken 396588 times"> + </span><span class="branchCov" title="Branch 1 was taken 12761 times"> + </span>]:<span class="lineCov">     409349 :         if (type == ARC_BUFC_METADATA) {</span>
<span class="lineNum">    5287 </span>                :<span class="lineCov">     396588 :                 return (zio_buf_alloc(size));</span>
<span class="lineNum">    5288 </span>                :            :         } else {
<span class="lineNum">    5289 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 12761 times"> + </span>]:<span class="lineCov">      12761 :                 ASSERT(type == ARC_BUFC_DATA);</span>
<span class="lineNum">    5290 </span>                :<span class="lineCov">      12761 :                 return (zio_data_buf_alloc(size));</span>
<span class="lineNum">    5291 </span>                :            :         }
<span class="lineNum">    5292 </span>                :            : }
<span class="lineNum">    5293 </span>                :            : 
<span class="lineNum">    5294 </span>                :            : /*
<span class="lineNum">    5295 </span>                :            :  * Allocate a block and return it to the caller. If we are hitting the
<span class="lineNum">    5296 </span>                :            :  * hard limit for the cache size, we must sleep, waiting for the eviction
<span class="lineNum">    5297 </span>                :            :  * thread to catch up. If we're past the target size but below the hard
<span class="lineNum">    5298 </span>                :            :  * limit, we'll only signal the reclaim thread and continue on.
<a name="5299"><span class="lineNum">    5299 </span>                :            :  */</a>
<span class="lineNum">    5300 </span>                :            : static void
<span class="lineNum">    5301 </span>                :<span class="lineCov">    2429991 : arc_get_data_impl(arc_buf_hdr_t *hdr, uint64_t size, void *tag)</span>
<span class="lineNum">    5302 </span>                :            : {
<span class="lineNum">    5303 </span>                :<span class="lineCov">    2429991 :         arc_state_t *state = hdr-&gt;b_l1hdr.b_state;</span>
<span class="lineNum">    5304 </span>                :<span class="lineCov">    2429991 :         arc_buf_contents_t type = arc_buf_type(hdr);</span>
<span class="lineNum">    5305 </span>                :            : 
<span class="lineNum">    5306 </span>                :<span class="lineCov">    2429852 :         arc_adapt(size, state);</span>
<span class="lineNum">    5307 </span>                :            : 
<span class="lineNum">    5308 </span>                :            :         /*
<span class="lineNum">    5309 </span>                :            :          * If arc_size is currently overflowing, and has grown past our
<span class="lineNum">    5310 </span>                :            :          * upper limit, we must be adding data faster than the evict
<span class="lineNum">    5311 </span>                :            :          * thread can evict. Thus, to ensure we don't compound the
<span class="lineNum">    5312 </span>                :            :          * problem by adding more data and forcing arc_size to grow even
<span class="lineNum">    5313 </span>                :            :          * further past it's target size, we halt and wait for the
<span class="lineNum">    5314 </span>                :            :          * eviction thread to catch up.
<span class="lineNum">    5315 </span>                :            :          *
<span class="lineNum">    5316 </span>                :            :          * It's also possible that the reclaim thread is unable to evict
<span class="lineNum">    5317 </span>                :            :          * enough buffers to get arc_size below the overflow limit (e.g.
<span class="lineNum">    5318 </span>                :            :          * due to buffers being un-evictable, or hash lock collisions).
<span class="lineNum">    5319 </span>                :            :          * In this case, we want to proceed regardless if we're
<span class="lineNum">    5320 </span>                :            :          * overflowing; thus we don't use a while loop here.
<span class="lineNum">    5321 </span>                :            :          */
<span class="lineNum">    5322 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2430629 times"> + </span>]:<span class="lineCov">    2430835 :         if (arc_is_overflowing()) {</span>
<span class="lineNum">    5323 </span>                :<span class="lineNoCov">          0 :                 mutex_enter(&amp;arc_reclaim_lock);</span>
<span class="lineNum">    5324 </span>                :            : 
<span class="lineNum">    5325 </span>                :            :                 /*
<span class="lineNum">    5326 </span>                :            :                  * Now that we've acquired the lock, we may no longer be
<span class="lineNum">    5327 </span>                :            :                  * over the overflow limit, lets check.
<span class="lineNum">    5328 </span>                :            :                  *
<span class="lineNum">    5329 </span>                :            :                  * We're ignoring the case of spurious wake ups. If that
<span class="lineNum">    5330 </span>                :            :                  * were to happen, it'd let this thread consume an ARC
<span class="lineNum">    5331 </span>                :            :                  * buffer before it should have (i.e. before we're under
<span class="lineNum">    5332 </span>                :            :                  * the overflow limit and were signalled by the reclaim
<span class="lineNum">    5333 </span>                :            :                  * thread). As long as that is a rare occurrence, it
<span class="lineNum">    5334 </span>                :            :                  * shouldn't cause any harm.
<span class="lineNum">    5335 </span>                :            :                  */
<span class="lineNum">    5336 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (arc_is_overflowing()) {</span>
<span class="lineNum">    5337 </span>                :<span class="lineNoCov">          0 :                         cv_signal(&amp;arc_reclaim_thread_cv);</span>
<span class="lineNum">    5338 </span>                :<span class="lineNoCov">          0 :                         cv_wait(&amp;arc_reclaim_waiters_cv, &amp;arc_reclaim_lock);</span>
<span class="lineNum">    5339 </span>                :            :                 }
<span class="lineNum">    5340 </span>                :            : 
<span class="lineNum">    5341 </span>                :<span class="lineNoCov">          0 :                 mutex_exit(&amp;arc_reclaim_lock);</span>
<span class="lineNum">    5342 </span>                :            :         }
<span class="lineNum">    5343 </span>                :            : 
<span class="lineNum">    5344 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2430782 times"> + </span>]:<span class="lineCov">    2430782 :         VERIFY3U(hdr-&gt;b_type, ==, type);</span>
<span class="lineNum">    5345 </span>        [<span class="branchCov" title="Branch 0 was taken 2274738 times"> + </span><span class="branchCov" title="Branch 1 was taken 156044 times"> + </span>]:<span class="lineCov">    2430782 :         if (type == ARC_BUFC_METADATA) {</span>
<span class="lineNum">    5346 </span>                :<span class="lineCov">    2274738 :                 arc_space_consume(size, ARC_SPACE_META);</span>
<span class="lineNum">    5347 </span>                :            :         } else {
<span class="lineNum">    5348 </span>                :<span class="lineCov">     156044 :                 arc_space_consume(size, ARC_SPACE_DATA);</span>
<span class="lineNum">    5349 </span>                :            :         }
<span class="lineNum">    5350 </span>                :            : 
<span class="lineNum">    5351 </span>                :            :         /*
<span class="lineNum">    5352 </span>                :            :          * Update the state size.  Note that ghost states have a
<span class="lineNum">    5353 </span>                :            :          * &quot;ghost size&quot; and so don't need to be updated.
<span class="lineNum">    5354 </span>                :            :          */
<span class="lineNum">    5355 </span>[<span class="branchCov" title="Branch 0 was taken 2431469 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 2431441 times"> + </span><span class="branchCov" title="Branch 3 was taken 28 times"> + </span>]:<span class="lineCov">    2431469 :         if (!GHOST_STATE(state)) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 2431430 times"> + </span><span class="branchCov" title="Branch 5 was taken 11 times"> + </span>]
<span class="lineNum">    5356 </span>                :            : 
<span class="lineNum">    5357 </span>                :<span class="lineCov">    2431430 :                 (void) refcount_add_many(&amp;state-&gt;arcs_size, size, tag);</span>
<span class="lineNum">    5358 </span>                :            : 
<span class="lineNum">    5359 </span>                :            :                 /*
<span class="lineNum">    5360 </span>                :            :                  * If this is reached via arc_read, the link is
<span class="lineNum">    5361 </span>                :            :                  * protected by the hash lock. If reached via
<span class="lineNum">    5362 </span>                :            :                  * arc_buf_alloc, the header should not be accessed by
<span class="lineNum">    5363 </span>                :            :                  * any other thread. And, if reached via arc_read_done,
<span class="lineNum">    5364 </span>                :            :                  * the hash lock will protect it if it's found in the
<span class="lineNum">    5365 </span>                :            :                  * hash table; otherwise no other thread should be
<span class="lineNum">    5366 </span>                :            :                  * trying to [add|remove]_reference it.
<span class="lineNum">    5367 </span>                :            :                  */
<span class="lineNum">    5368 </span>        [<span class="branchCov" title="Branch 1 was taken 101 times"> + </span><span class="branchCov" title="Branch 2 was taken 2431465 times"> + </span>]:<span class="lineCov">    2431573 :                 if (multilist_link_active(&amp;hdr-&gt;b_l1hdr.b_arc_node)) {</span>
<span class="lineNum">    5369 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 101 times"> + </span>]:<span class="lineCov">        101 :                         ASSERT(refcount_is_zero(&amp;hdr-&gt;b_l1hdr.b_refcnt));</span>
<span class="lineNum">    5370 </span>                :<span class="lineCov">        101 :                         (void) refcount_add_many(&amp;state-&gt;arcs_esize[type],</span>
<span class="lineNum">    5371 </span>                :            :                             size, tag);
<span class="lineNum">    5372 </span>                :            :                 }
<span class="lineNum">    5373 </span>                :            : 
<span class="lineNum">    5374 </span>                :            :                 /*
<span class="lineNum">    5375 </span>                :            :                  * If we are growing the cache, and we are adding anonymous
<span class="lineNum">    5376 </span>                :            :                  * data, and we have outgrown arc_p, update arc_p
<span class="lineNum">    5377 </span>                :            :                  */
<span class="lineNum">    5378 </span>        [<span class="branchCov" title="Branch 0 was taken 2431562 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    4537061 :                 if (arc_size &lt; arc_c &amp;&amp; hdr-&gt;b_l1hdr.b_state == arc_anon &amp;&amp;</span>
<span class="lineNum">         </span>  [<span class="branchCov" title="Branch 2 was taken 2105522 times"> + </span><span class="branchCov" title="Branch 3 was taken 326040 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 2105499 times"> + </span>]
<span class="lineNum">    5379 </span>                :<span class="lineCov">    2105522 :                     (refcount_count(&amp;arc_anon-&gt;arcs_size) +</span>
<span class="lineNum">    5380 </span>                :<span class="lineCov">    2105505 :                     refcount_count(&amp;arc_mru-&gt;arcs_size) &gt; arc_p))</span>
<span class="lineNum">    5381 </span>                :<span class="lineNoCov">          0 :                         arc_p = MIN(arc_c, arc_p + size);</span>
<span class="lineNum">    5382 </span>                :            :         }
<span class="lineNum">    5383 </span>                :<span class="lineCov">    2431578 : }</span>
<a name="5384"><span class="lineNum">    5384 </span>                :            : </a>
<span class="lineNum">    5385 </span>                :            : static void
<span class="lineNum">    5386 </span>                :<span class="lineCov">    1973531 : arc_free_data_abd(arc_buf_hdr_t *hdr, abd_t *abd, uint64_t size, void *tag)</span>
<span class="lineNum">    5387 </span>                :            : {
<span class="lineNum">    5388 </span>                :<span class="lineCov">    1973531 :         arc_free_data_impl(hdr, size, tag);</span>
<span class="lineNum">    5389 </span>                :<span class="lineCov">    1974861 :         abd_free(abd);</span>
<span class="lineNum">    5390 </span>                :<span class="lineCov">    1974803 : }</span>
<a name="5391"><span class="lineNum">    5391 </span>                :            : </a>
<span class="lineNum">    5392 </span>                :            : static void
<span class="lineNum">    5393 </span>                :<span class="lineCov">     456549 : arc_free_data_buf(arc_buf_hdr_t *hdr, void *buf, uint64_t size, void *tag)</span>
<span class="lineNum">    5394 </span>                :            : {
<span class="lineNum">    5395 </span>                :<span class="lineCov">     456549 :         arc_buf_contents_t type = arc_buf_type(hdr);</span>
<span class="lineNum">    5396 </span>                :            : 
<span class="lineNum">    5397 </span>                :<span class="lineCov">     456548 :         arc_free_data_impl(hdr, size, tag);</span>
<span class="lineNum">    5398 </span>        [<span class="branchCov" title="Branch 0 was taken 423252 times"> + </span><span class="branchCov" title="Branch 1 was taken 33339 times"> + </span>]:<span class="lineCov">     456591 :         if (type == ARC_BUFC_METADATA) {</span>
<span class="lineNum">    5399 </span>                :<span class="lineCov">     423252 :                 zio_buf_free(buf, size);</span>
<span class="lineNum">    5400 </span>                :            :         } else {
<span class="lineNum">    5401 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 33339 times"> + </span>]:<span class="lineCov">      33339 :                 ASSERT(type == ARC_BUFC_DATA);</span>
<span class="lineNum">    5402 </span>                :<span class="lineCov">      33339 :                 zio_data_buf_free(buf, size);</span>
<span class="lineNum">    5403 </span>                :            :         }
<span class="lineNum">    5404 </span>                :<span class="lineCov">     456580 : }</span>
<span class="lineNum">    5405 </span>                :            : 
<span class="lineNum">    5406 </span>                :            : /*
<span class="lineNum">    5407 </span>                :            :  * Free the arc data buffer.
<a name="5408"><span class="lineNum">    5408 </span>                :            :  */</a>
<span class="lineNum">    5409 </span>                :            : static void
<span class="lineNum">    5410 </span>                :<span class="lineCov">    2429739 : arc_free_data_impl(arc_buf_hdr_t *hdr, uint64_t size, void *tag)</span>
<span class="lineNum">    5411 </span>                :            : {
<span class="lineNum">    5412 </span>                :<span class="lineCov">    2429739 :         arc_state_t *state = hdr-&gt;b_l1hdr.b_state;</span>
<span class="lineNum">    5413 </span>                :<span class="lineCov">    2429739 :         arc_buf_contents_t type = arc_buf_type(hdr);</span>
<span class="lineNum">    5414 </span>                :            : 
<span class="lineNum">    5415 </span>                :            :         /* protected by hash lock, if in the hash table */
<span class="lineNum">    5416 </span>        [<span class="branchCov" title="Branch 1 was taken 549215 times"> + </span><span class="branchCov" title="Branch 2 was taken 1880555 times"> + </span>]:<span class="lineCov">    2429989 :         if (multilist_link_active(&amp;hdr-&gt;b_l1hdr.b_arc_node)) {</span>
<span class="lineNum">    5417 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 549215 times"> + </span>]:<span class="lineCov">     549215 :                 ASSERT(refcount_is_zero(&amp;hdr-&gt;b_l1hdr.b_refcnt));</span>
<span class="lineNum">    5418 </span>[<span class="branchCov" title="Branch 0 was taken 549215 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 549215 times"> + </span>]:<span class="lineCov">     549215 :                 ASSERT(state != arc_anon &amp;&amp; state != arc_l2c_only);</span>
<span class="lineNum">    5419 </span>                :            : 
<span class="lineNum">    5420 </span>                :<span class="lineCov">     549215 :                 (void) refcount_remove_many(&amp;state-&gt;arcs_esize[type],</span>
<span class="lineNum">    5421 </span>                :            :                     size, tag);
<span class="lineNum">    5422 </span>                :            :         }
<span class="lineNum">    5423 </span>                :<span class="lineCov">    2429771 :         (void) refcount_remove_many(&amp;state-&gt;arcs_size, size, tag);</span>
<span class="lineNum">    5424 </span>                :            : 
<span class="lineNum">    5425 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2431392 times"> + </span>]:<span class="lineCov">    2431392 :         VERIFY3U(hdr-&gt;b_type, ==, type);</span>
<span class="lineNum">    5426 </span>        [<span class="branchCov" title="Branch 0 was taken 2275350 times"> + </span><span class="branchCov" title="Branch 1 was taken 156042 times"> + </span>]:<span class="lineCov">    2431392 :         if (type == ARC_BUFC_METADATA) {</span>
<span class="lineNum">    5427 </span>                :<span class="lineCov">    2275350 :                 arc_space_return(size, ARC_SPACE_META);</span>
<span class="lineNum">    5428 </span>                :            :         } else {
<span class="lineNum">    5429 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 156042 times"> + </span>]:<span class="lineCov">     156042 :                 ASSERT(type == ARC_BUFC_DATA);</span>
<span class="lineNum">    5430 </span>                :<span class="lineCov">     156042 :                 arc_space_return(size, ARC_SPACE_DATA);</span>
<span class="lineNum">    5431 </span>                :            :         }
<span class="lineNum">    5432 </span>                :<span class="lineCov">    2431451 : }</span>
<span class="lineNum">    5433 </span>                :            : 
<span class="lineNum">    5434 </span>                :            : /*
<span class="lineNum">    5435 </span>                :            :  * This routine is called whenever a buffer is accessed.
<span class="lineNum">    5436 </span>                :            :  * NOTE: the hash lock is dropped in this function.
<a name="5437"><span class="lineNum">    5437 </span>                :            :  */</a>
<span class="lineNum">    5438 </span>                :            : static void
<span class="lineNum">    5439 </span>                :<span class="lineCov">    1390695 : arc_access(arc_buf_hdr_t *hdr, kmutex_t *hash_lock)</span>
<span class="lineNum">    5440 </span>                :            : {
<span class="lineNum">    5441 </span>                :            :         clock_t now;
<span class="lineNum">    5442 </span>                :            : 
<span class="lineNum">    5443 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1390703 times"> + </span>]:<span class="lineCov">    1390695 :         ASSERT(MUTEX_HELD(hash_lock));</span>
<span class="lineNum">    5444 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1390703 times"> + </span>]:<span class="lineCov">    1390703 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    5445 </span>                :            : 
<span class="lineNum">    5446 </span>        [<span class="branchCov" title="Branch 0 was taken 887898 times"> + </span><span class="branchCov" title="Branch 1 was taken 502805 times"> + </span>]:<span class="lineCov">    1390703 :         if (hdr-&gt;b_l1hdr.b_state == arc_anon) {</span>
<span class="lineNum">    5447 </span>                :            :                 /*
<span class="lineNum">    5448 </span>                :            :                  * This buffer is not in the cache, and does not
<span class="lineNum">    5449 </span>                :            :                  * appear in our &quot;ghost&quot; list.  Add the new buffer
<span class="lineNum">    5450 </span>                :            :                  * to the MRU state.
<span class="lineNum">    5451 </span>                :            :                  */
<span class="lineNum">    5452 </span>                :            : 
<span class="lineNum">    5453 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 887898 times"> + </span>]:<span class="lineCov">     887898 :                 ASSERT0(hdr-&gt;b_l1hdr.b_arc_access);</span>
<span class="lineNum">    5454 </span>                :<span class="lineCov">     887898 :                 hdr-&gt;b_l1hdr.b_arc_access = ddi_get_lbolt();</span>
<span class="lineNum">    5455 </span>                :            :                 DTRACE_PROBE1(new_state__mru, arc_buf_hdr_t *, hdr);
<span class="lineNum">    5456 </span>                :<span class="lineCov">     887872 :                 arc_change_state(arc_mru, hdr, hash_lock);</span>
<span class="lineNum">    5457 </span>                :            : 
<span class="lineNum">    5458 </span>        [<span class="branchCov" title="Branch 0 was taken 466194 times"> + </span><span class="branchCov" title="Branch 1 was taken 36611 times"> + </span>]:<span class="lineCov">     502805 :         } else if (hdr-&gt;b_l1hdr.b_state == arc_mru) {</span>
<span class="lineNum">    5459 </span>                :<span class="lineCov">     466194 :                 now = ddi_get_lbolt();</span>
<span class="lineNum">    5460 </span>                :            : 
<span class="lineNum">    5461 </span>                :            :                 /*
<span class="lineNum">    5462 </span>                :            :                  * If this buffer is here because of a prefetch, then either:
<span class="lineNum">    5463 </span>                :            :                  * - clear the flag if this is a &quot;referencing&quot; read
<span class="lineNum">    5464 </span>                :            :                  *   (any subsequent access will bump this into the MFU state).
<span class="lineNum">    5465 </span>                :            :                  * or
<span class="lineNum">    5466 </span>                :            :                  * - move the buffer to the head of the list if this is
<span class="lineNum">    5467 </span>                :            :                  *   another prefetch (to make it less likely to be evicted).
<span class="lineNum">    5468 </span>                :            :                  */
<span class="lineNum">    5469 </span>        [<span class="branchCov" title="Branch 0 was taken 120970 times"> + </span><span class="branchCov" title="Branch 1 was taken 345243 times"> + </span>]:<span class="lineCov">     466213 :                 if (HDR_PREFETCH(hdr)) {</span>
<span class="lineNum">    5470 </span>        [<span class="branchCov" title="Branch 1 was taken 120969 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">     120970 :                         if (refcount_count(&amp;hdr-&gt;b_l1hdr.b_refcnt) == 0) {</span>
<span class="lineNum">    5471 </span>                :            :                                 /* link protected by hash lock */
<span class="lineNum">    5472 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 120968 times"> + </span>]:<span class="lineCov">     120969 :                                 ASSERT(multilist_link_active(</span>
<span class="lineNum">    5473 </span>                :            :                                     &amp;hdr-&gt;b_l1hdr.b_arc_node));
<span class="lineNum">    5474 </span>                :            :                         } else {
<span class="lineNum">    5475 </span>                :<span class="lineNoCov">          0 :                                 arc_hdr_clear_flags(hdr, ARC_FLAG_PREFETCH);</span>
<span class="lineNum">    5476 </span>                :<span class="lineNoCov">          0 :                                 atomic_inc_32(&amp;hdr-&gt;b_l1hdr.b_mru_hits);</span>
<span class="lineNum">    5477 </span>                :<span class="lineNoCov">          0 :                                 ARCSTAT_BUMP(arcstat_mru_hits);</span>
<span class="lineNum">    5478 </span>                :            :                         }
<span class="lineNum">    5479 </span>                :<span class="lineCov">     120969 :                         hdr-&gt;b_l1hdr.b_arc_access = now;</span>
<span class="lineNum">    5480 </span>                :<span class="lineCov">     120969 :                         return;</span>
<span class="lineNum">    5481 </span>                :            :                 }
<span class="lineNum">    5482 </span>                :            : 
<span class="lineNum">    5483 </span>                :            :                 /*
<span class="lineNum">    5484 </span>                :            :                  * This buffer has been &quot;accessed&quot; only once so far,
<span class="lineNum">    5485 </span>                :            :                  * but it is still in the cache. Move it to the MFU
<span class="lineNum">    5486 </span>                :            :                  * state.
<span class="lineNum">    5487 </span>                :            :                  */
<span class="lineNum">    5488 </span>        [<span class="branchCov" title="Branch 0 was taken 20791 times"> + </span><span class="branchCov" title="Branch 1 was taken 324452 times"> + </span>]:<span class="lineCov">     345243 :                 if (ddi_time_after(now, hdr-&gt;b_l1hdr.b_arc_access +</span>
<span class="lineNum">    5489 </span>                :            :                     ARC_MINTIME)) {
<span class="lineNum">    5490 </span>                :            :                         /*
<span class="lineNum">    5491 </span>                :            :                          * More than 125ms have passed since we
<span class="lineNum">    5492 </span>                :            :                          * instantiated this buffer.  Move it to the
<span class="lineNum">    5493 </span>                :            :                          * most frequently used state.
<span class="lineNum">    5494 </span>                :            :                          */
<span class="lineNum">    5495 </span>                :<span class="lineCov">      20791 :                         hdr-&gt;b_l1hdr.b_arc_access = now;</span>
<span class="lineNum">    5496 </span>                :            :                         DTRACE_PROBE1(new_state__mfu, arc_buf_hdr_t *, hdr);
<span class="lineNum">    5497 </span>                :<span class="lineCov">      20791 :                         arc_change_state(arc_mfu, hdr, hash_lock);</span>
<span class="lineNum">    5498 </span>                :            :                 }
<span class="lineNum">    5499 </span>                :<span class="lineCov">     345243 :                 atomic_inc_32(&amp;hdr-&gt;b_l1hdr.b_mru_hits);</span>
<span class="lineNum">    5500 </span>                :<span class="lineCov">     345244 :                 ARCSTAT_BUMP(arcstat_mru_hits);</span>
<span class="lineNum">    5501 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 36611 times"> + </span>]:<span class="lineCov">      36611 :         } else if (hdr-&gt;b_l1hdr.b_state == arc_mru_ghost) {</span>
<span class="lineNum">    5502 </span>                :            :                 arc_state_t     *new_state;
<span class="lineNum">    5503 </span>                :            :                 /*
<span class="lineNum">    5504 </span>                :            :                  * This buffer has been &quot;accessed&quot; recently, but
<span class="lineNum">    5505 </span>                :            :                  * was evicted from the cache.  Move it to the
<span class="lineNum">    5506 </span>                :            :                  * MFU state.
<span class="lineNum">    5507 </span>                :            :                  */
<span class="lineNum">    5508 </span>                :            : 
<span class="lineNum">    5509 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (HDR_PREFETCH(hdr)) {</span>
<span class="lineNum">    5510 </span>                :<span class="lineNoCov">          0 :                         new_state = arc_mru;</span>
<span class="lineNum">    5511 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (refcount_count(&amp;hdr-&gt;b_l1hdr.b_refcnt) &gt; 0)</span>
<span class="lineNum">    5512 </span>                :<span class="lineNoCov">          0 :                                 arc_hdr_clear_flags(hdr, ARC_FLAG_PREFETCH);</span>
<span class="lineNum">    5513 </span>                :            :                         DTRACE_PROBE1(new_state__mru, arc_buf_hdr_t *, hdr);
<span class="lineNum">    5514 </span>                :            :                 } else {
<span class="lineNum">    5515 </span>                :<span class="lineNoCov">          0 :                         new_state = arc_mfu;</span>
<span class="lineNum">    5516 </span>                :            :                         DTRACE_PROBE1(new_state__mfu, arc_buf_hdr_t *, hdr);
<span class="lineNum">    5517 </span>                :            :                 }
<span class="lineNum">    5518 </span>                :            : 
<span class="lineNum">    5519 </span>                :<span class="lineNoCov">          0 :                 hdr-&gt;b_l1hdr.b_arc_access = ddi_get_lbolt();</span>
<span class="lineNum">    5520 </span>                :<span class="lineNoCov">          0 :                 arc_change_state(new_state, hdr, hash_lock);</span>
<span class="lineNum">    5521 </span>                :            : 
<span class="lineNum">    5522 </span>                :<span class="lineNoCov">          0 :                 atomic_inc_32(&amp;hdr-&gt;b_l1hdr.b_mru_ghost_hits);</span>
<span class="lineNum">    5523 </span>                :<span class="lineNoCov">          0 :                 ARCSTAT_BUMP(arcstat_mru_ghost_hits);</span>
<span class="lineNum">    5524 </span>        [<span class="branchCov" title="Branch 0 was taken 36510 times"> + </span><span class="branchCov" title="Branch 1 was taken 101 times"> + </span>]:<span class="lineCov">      36611 :         } else if (hdr-&gt;b_l1hdr.b_state == arc_mfu) {</span>
<span class="lineNum">    5525 </span>                :            :                 /*
<span class="lineNum">    5526 </span>                :            :                  * This buffer has been accessed more than once and is
<span class="lineNum">    5527 </span>                :            :                  * still in the cache.  Keep it in the MFU state.
<span class="lineNum">    5528 </span>                :            :                  *
<span class="lineNum">    5529 </span>                :            :                  * NOTE: an add_reference() that occurred when we did
<span class="lineNum">    5530 </span>                :            :                  * the arc_read() will have kicked this off the list.
<span class="lineNum">    5531 </span>                :            :                  * If it was a prefetch, we will explicitly move it to
<span class="lineNum">    5532 </span>                :            :                  * the head of the list now.
<span class="lineNum">    5533 </span>                :            :                  */
<span class="lineNum">    5534 </span>        [<span class="branchCov" title="Branch 0 was taken 8169 times"> + </span><span class="branchCov" title="Branch 1 was taken 28341 times"> + </span>]:<span class="lineCov">      36510 :                 if ((HDR_PREFETCH(hdr)) != 0) {</span>
<span class="lineNum">    5535 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 8169 times"> + </span>]:<span class="lineCov">       8169 :                         ASSERT(refcount_is_zero(&amp;hdr-&gt;b_l1hdr.b_refcnt));</span>
<span class="lineNum">    5536 </span>                :            :                         /* link protected by hash_lock */
<span class="lineNum">    5537 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 8169 times"> + </span>]:<span class="lineCov">       8169 :                         ASSERT(multilist_link_active(&amp;hdr-&gt;b_l1hdr.b_arc_node));</span>
<span class="lineNum">    5538 </span>                :            :                 }
<span class="lineNum">    5539 </span>                :<span class="lineCov">      36510 :                 atomic_inc_32(&amp;hdr-&gt;b_l1hdr.b_mfu_hits);</span>
<span class="lineNum">    5540 </span>                :<span class="lineCov">      36511 :                 ARCSTAT_BUMP(arcstat_mfu_hits);</span>
<span class="lineNum">    5541 </span>                :<span class="lineCov">      36512 :                 hdr-&gt;b_l1hdr.b_arc_access = ddi_get_lbolt();</span>
<span class="lineNum">    5542 </span>        [<span class="branchCov" title="Branch 0 was taken 101 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        101 :         } else if (hdr-&gt;b_l1hdr.b_state == arc_mfu_ghost) {</span>
<span class="lineNum">    5543 </span>                :<span class="lineCov">        101 :                 arc_state_t     *new_state = arc_mfu;</span>
<span class="lineNum">    5544 </span>                :            :                 /*
<span class="lineNum">    5545 </span>                :            :                  * This buffer has been accessed more than once but has
<span class="lineNum">    5546 </span>                :            :                  * been evicted from the cache.  Move it back to the
<span class="lineNum">    5547 </span>                :            :                  * MFU state.
<span class="lineNum">    5548 </span>                :            :                  */
<span class="lineNum">    5549 </span>                :            : 
<span class="lineNum">    5550 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 101 times"> + </span>]:<span class="lineCov">        101 :                 if (HDR_PREFETCH(hdr)) {</span>
<span class="lineNum">    5551 </span>                :            :                         /*
<span class="lineNum">    5552 </span>                :            :                          * This is a prefetch access...
<span class="lineNum">    5553 </span>                :            :                          * move this block back to the MRU state.
<span class="lineNum">    5554 </span>                :            :                          */
<span class="lineNum">    5555 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         ASSERT0(refcount_count(&amp;hdr-&gt;b_l1hdr.b_refcnt));</span>
<span class="lineNum">    5556 </span>                :<span class="lineNoCov">          0 :                         new_state = arc_mru;</span>
<span class="lineNum">    5557 </span>                :            :                 }
<span class="lineNum">    5558 </span>                :            : 
<span class="lineNum">    5559 </span>                :<span class="lineCov">        101 :                 hdr-&gt;b_l1hdr.b_arc_access = ddi_get_lbolt();</span>
<span class="lineNum">    5560 </span>                :            :                 DTRACE_PROBE1(new_state__mfu, arc_buf_hdr_t *, hdr);
<span class="lineNum">    5561 </span>                :<span class="lineCov">        101 :                 arc_change_state(new_state, hdr, hash_lock);</span>
<span class="lineNum">    5562 </span>                :            : 
<span class="lineNum">    5563 </span>                :<span class="lineCov">        101 :                 atomic_inc_32(&amp;hdr-&gt;b_l1hdr.b_mfu_ghost_hits);</span>
<span class="lineNum">    5564 </span>                :<span class="lineCov">        101 :                 ARCSTAT_BUMP(arcstat_mfu_ghost_hits);</span>
<span class="lineNum">    5565 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         } else if (hdr-&gt;b_l1hdr.b_state == arc_l2c_only) {</span>
<span class="lineNum">    5566 </span>                :            :                 /*
<span class="lineNum">    5567 </span>                :            :                  * This buffer is on the 2nd Level ARC.
<span class="lineNum">    5568 </span>                :            :                  */
<span class="lineNum">    5569 </span>                :            : 
<span class="lineNum">    5570 </span>                :<span class="lineNoCov">          0 :                 hdr-&gt;b_l1hdr.b_arc_access = ddi_get_lbolt();</span>
<span class="lineNum">    5571 </span>                :            :                 DTRACE_PROBE1(new_state__mfu, arc_buf_hdr_t *, hdr);
<span class="lineNum">    5572 </span>                :<span class="lineNoCov">          0 :                 arc_change_state(arc_mfu, hdr, hash_lock);</span>
<span class="lineNum">    5573 </span>                :            :         } else {
<span class="lineNum">    5574 </span>                :<span class="lineNoCov">          0 :                 cmn_err(CE_PANIC, &quot;invalid arc state 0x%p&quot;,</span>
<span class="lineNum">    5575 </span>                :            :                     hdr-&gt;b_l1hdr.b_state);
<span class="lineNum">    5576 </span>                :            :         }
<span class="lineNum">    5577 </span>                :            : }
<span class="lineNum">    5578 </span>                :            : 
<span class="lineNum">    5579 </span>                :            : /* a generic arc_read_done_func_t which you can use */
<a name="5580"><span class="lineNum">    5580 </span>                :            : /* ARGSUSED */</a>
<span class="lineNum">    5581 </span>                :            : void
<span class="lineNum">    5582 </span>                :<span class="lineNoCov">          0 : arc_bcopy_func(zio_t *zio, int error, arc_buf_t *buf, void *arg)</span>
<span class="lineNum">    5583 </span>                :            : {
<span class="lineNum">    5584 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (error == 0)</span>
<span class="lineNum">    5585 </span>                :<span class="lineNoCov">          0 :                 bcopy(buf-&gt;b_data, arg, arc_buf_size(buf));</span>
<span class="lineNum">    5586 </span>                :<span class="lineNoCov">          0 :         arc_buf_destroy(buf, arg);</span>
<span class="lineNum">    5587 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    5588 </span>                :            : 
<a name="5589"><span class="lineNum">    5589 </span>                :            : /* a generic arc_read_done_func_t */</a>
<span class="lineNum">    5590 </span>                :            : void
<span class="lineNum">    5591 </span>                :<span class="lineCov">     323510 : arc_getbuf_func(zio_t *zio, int error, arc_buf_t *buf, void *arg)</span>
<span class="lineNum">    5592 </span>                :            : {
<span class="lineNum">    5593 </span>                :<span class="lineCov">     323510 :         arc_buf_t **bufp = arg;</span>
<span class="lineNum">    5594 </span>        [<span class="branchCov" title="Branch 0 was taken 2318 times"> + </span><span class="branchCov" title="Branch 1 was taken 321192 times"> + </span>]:<span class="lineCov">     323510 :         if (error != 0) {</span>
<span class="lineNum">    5595 </span>                :<span class="lineCov">       2318 :                 arc_buf_destroy(buf, arg);</span>
<span class="lineNum">    5596 </span>                :<span class="lineCov">       2318 :                 *bufp = NULL;</span>
<span class="lineNum">    5597 </span>                :            :         } else {
<span class="lineNum">    5598 </span>                :<span class="lineCov">     321192 :                 *bufp = buf;</span>
<span class="lineNum">    5599 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 321192 times"> + </span>]:<span class="lineCov">     321192 :                 ASSERT(buf-&gt;b_data);</span>
<span class="lineNum">    5600 </span>                :            :         }
<span class="lineNum">    5601 </span>                :<span class="lineCov">     323510 : }</span>
<a name="5602"><span class="lineNum">    5602 </span>                :            : </a>
<span class="lineNum">    5603 </span>                :            : static void
<span class="lineNum">    5604 </span>                :<span class="lineCov">    2694968 : arc_hdr_verify(arc_buf_hdr_t *hdr, blkptr_t *bp)</span>
<span class="lineNum">    5605 </span>                :            : {
<span class="lineNum">    5606 </span>[<span class="branchCov" title="Branch 0 was taken 1630366 times"> + </span><span class="branchCov" title="Branch 1 was taken 1064602 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 74641 times"> + </span><span class="branchCov" title="Branch 3 was taken 1555725 times"> + </span>]:<span class="lineCov">    2694968 :         if (BP_IS_HOLE(bp) || BP_IS_EMBEDDED(bp)) {</span>
<span class="lineNum">         </span>   [<span class="branchCov" title="Branch 5 was taken 74684 times"> + </span>][<span class="branchCov" title="Branch 6 was taken 1064558 times"> + </span><span class="branchCov" title="Branch 7 was taken 1555726 times"> + </span>]
<span class="lineNum">    5607 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1139242 times"> + </span>]:<span class="lineCov">    1139242 :                 ASSERT3U(HDR_GET_PSIZE(hdr), ==, 0);</span>
<span class="lineNum">    5608 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1139455 times"> + </span>]:<span class="lineCov">    1139242 :                 ASSERT3U(arc_hdr_get_compress(hdr), ==, ZIO_COMPRESS_OFF);</span>
<span class="lineNum">    5609 </span>                :            :         } else {
<span class="lineNum">    5610 </span>        [<span class="branchCov" title="Branch 0 was taken 969539 times"> + </span><span class="branchCov" title="Branch 1 was taken 586187 times"> + </span>]:<span class="lineCov">    1555726 :                 if (HDR_COMPRESSION_ENABLED(hdr)) {</span>
<span class="lineNum">    5611 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 969528 times"> + </span>]:<span class="lineCov">     969539 :                         ASSERT3U(arc_hdr_get_compress(hdr), ==,</span>
<span class="lineNum">    5612 </span>                :            :                             BP_GET_COMPRESS(bp));
<span class="lineNum">    5613 </span>                :            :                 }
<span class="lineNum">    5614 </span>[<span class="branchCov" title="Branch 0 was taken 19 times"> + </span><span class="branchCov" title="Branch 1 was taken 1555696 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 19 times"> + </span>]:<span class="lineCov">    1555715 :                 ASSERT3U(HDR_GET_LSIZE(hdr), ==, BP_GET_LSIZE(bp));</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 1555715 times"> + </span>]
<span class="lineNum">    5615 </span>[<span class="branchCov" title="Branch 0 was taken 1555682 times"> + </span><span class="branchCov" title="Branch 1 was taken 33 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1555715 times"> + </span>]:<span class="lineCov">    1555715 :                 ASSERT3U(HDR_GET_PSIZE(hdr), ==, BP_GET_PSIZE(bp));</span>
<span class="lineNum">    5616 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1555715 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1555715 :                 ASSERT3U(!!HDR_PROTECTED(hdr), ==, BP_IS_PROTECTED(bp));</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>][<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 12 was not executed"> # </span><span class="branchNoExec" title="Branch 13 was not executed"> # </span>][<span class="branchNoExec" title="Branch 14 was not executed"> # </span><span class="branchNoExec" title="Branch 15 was not executed"> # </span>]
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 16 was not taken"> - </span><span class="branchCov" title="Branch 17 was taken 1555715 times"> + </span>]
<span class="lineNum">    5617 </span>                :            :         }
<span class="lineNum">    5618 </span>                :<span class="lineCov">    2695170 : }</span>
<a name="5619"><span class="lineNum">    5619 </span>                :            : </a>
<span class="lineNum">    5620 </span>                :            : static void
<span class="lineNum">    5621 </span>                :<span class="lineCov">    1242477 : arc_read_done(zio_t *zio)</span>
<span class="lineNum">    5622 </span>                :            : {
<span class="lineNum">    5623 </span>                :<span class="lineCov">    1242477 :         blkptr_t        *bp = zio-&gt;io_bp;</span>
<span class="lineNum">    5624 </span>                :<span class="lineCov">    1242477 :         arc_buf_hdr_t   *hdr = zio-&gt;io_private;</span>
<span class="lineNum">    5625 </span>                :<span class="lineCov">    1242477 :         kmutex_t        *hash_lock = NULL;</span>
<span class="lineNum">    5626 </span>                :            :         arc_callback_t  *callback_list;
<span class="lineNum">    5627 </span>                :            :         arc_callback_t  *acb;
<span class="lineNum">    5628 </span>                :<span class="lineCov">    1242477 :         boolean_t       freeable = B_FALSE;</span>
<span class="lineNum">    5629 </span>                :<span class="lineCov">    1242477 :         boolean_t       no_zio_error = (zio-&gt;io_error == 0);</span>
<span class="lineNum">    5630 </span>                :            : 
<span class="lineNum">    5631 </span>                :            :         /*
<span class="lineNum">    5632 </span>                :            :          * The hdr was inserted into hash-table and removed from lists
<span class="lineNum">    5633 </span>                :            :          * prior to starting I/O.  We should find this header, since
<span class="lineNum">    5634 </span>                :            :          * it's in the hash table, and it should be legit since it's
<span class="lineNum">    5635 </span>                :            :          * not possible to evict it during the I/O.  The only possible
<span class="lineNum">    5636 </span>                :            :          * reason for it not to be found is if we were freed during the
<span class="lineNum">    5637 </span>                :            :          * read.
<span class="lineNum">    5638 </span>                :            :          */
<span class="lineNum">    5639 </span>        [<span class="branchCov" title="Branch 0 was taken 243874 times"> + </span><span class="branchCov" title="Branch 1 was taken 998603 times"> + </span>]:<span class="lineCov">    1242477 :         if (HDR_IN_HASH_TABLE(hdr)) {</span>
<span class="lineNum">    5640 </span>                :            :                 arc_buf_hdr_t *found;
<span class="lineNum">    5641 </span>                :            : 
<span class="lineNum">    5642 </span>   [<span class="branchCov" title="Branch 0 was taken 243875 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 243841 times"> + </span><span class="branchCov" title="Branch 3 was taken 34 times"> + </span>]:<span class="lineCov">     243874 :                 ASSERT3U(hdr-&gt;b_birth, ==, BP_PHYSICAL_BIRTH(zio-&gt;io_bp));</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 243874 times"> + </span>]
<span class="lineNum">    5643 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 243874 times"> + </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 243874 times"> + </span>]:<span class="lineCov">     243874 :                 ASSERT3U(hdr-&gt;b_dva.dva_word[0], ==,</span>
<span class="lineNum">    5644 </span>                :            :                     BP_IDENTITY(zio-&gt;io_bp)-&gt;dva_word[0]);
<span class="lineNum">    5645 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 243874 times"> + </span>]:<span class="lineCov">     243874 :                 ASSERT3U(hdr-&gt;b_dva.dva_word[1], ==,</span>
<span class="lineNum">    5646 </span>                :            :                     BP_IDENTITY(zio-&gt;io_bp)-&gt;dva_word[1]);
<span class="lineNum">    5647 </span>                :            : 
<span class="lineNum">    5648 </span>                :<span class="lineCov">     243874 :                 found = buf_hash_find(hdr-&gt;b_spa, zio-&gt;io_bp, &amp;hash_lock);</span>
<span class="lineNum">    5649 </span>                :            : 
<span class="lineNum">    5650 </span>[<span class="branchCov" title="Branch 0 was taken 243877 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 243877 times"> + </span>]:<span class="lineCov">     243877 :                 ASSERT((found == hdr &amp;&amp;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 5 was taken 243874 times"> + </span><span class="branchCov" title="Branch 6 was taken 3 times"> + </span>][<span class="branchCov" title="Branch 7 was taken 641 times"> + </span><span class="branchCov" title="Branch 8 was taken 243233 times"> + </span>]
<span class="lineNum">         </span>[<span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchCov" title="Branch 10 was taken 644 times"> + </span>][<span class="branchNoExec" title="Branch 11 was not executed"> # </span><span class="branchNoExec" title="Branch 12 was not executed"> # </span>]
<span class="lineNum">    5651 </span>                :            :                     DVA_EQUAL(&amp;hdr-&gt;b_dva, BP_IDENTITY(zio-&gt;io_bp))) ||
<span class="lineNum">    5652 </span>                :            :                     (found == hdr &amp;&amp; HDR_L2_READING(hdr)));
<span class="lineNum">    5653 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 243233 times"> + </span>]:<span class="lineCov">     243233 :                 ASSERT3P(hash_lock, !=, NULL);</span>
<span class="lineNum">    5654 </span>                :            :         }
<span class="lineNum">    5655 </span>                :            : 
<span class="lineNum">    5656 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1241836 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1241836 :         if (BP_IS_PROTECTED(bp)) {</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>][<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 12 was not executed"> # </span><span class="branchNoExec" title="Branch 13 was not executed"> # </span>][<span class="branchNoExec" title="Branch 14 was not executed"> # </span><span class="branchNoExec" title="Branch 15 was not executed"> # </span>]
<span class="lineNum">    5657 </span>                :<span class="lineNoCov">          0 :                 hdr-&gt;b_crypt_hdr.b_ot = BP_GET_TYPE(bp);</span>
<span class="lineNum">    5658 </span>                :<span class="lineNoCov">          0 :                 hdr-&gt;b_crypt_hdr.b_dsobj = zio-&gt;io_bookmark.zb_objset;</span>
<span class="lineNum">    5659 </span>                :<span class="lineNoCov">          0 :                 zio_crypt_decode_params_bp(bp, hdr-&gt;b_crypt_hdr.b_salt,</span>
<span class="lineNum">    5660 </span>                :<span class="lineNoCov">          0 :                     hdr-&gt;b_crypt_hdr.b_iv);</span>
<span class="lineNum">    5661 </span>                :            : 
<span class="lineNum">    5662 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (BP_GET_TYPE(bp) == DMU_OT_INTENT_LOG) {</span>
<span class="lineNum">    5663 </span>                :            :                         void *tmpbuf;
<span class="lineNum">    5664 </span>                :            : 
<span class="lineNum">    5665 </span>                :<span class="lineNoCov">          0 :                         tmpbuf = abd_borrow_buf_copy(zio-&gt;io_abd,</span>
<span class="lineNum">    5666 </span>                :            :                             sizeof (zil_chain_t));
<span class="lineNum">    5667 </span>                :<span class="lineNoCov">          0 :                         zio_crypt_decode_mac_zil(tmpbuf,</span>
<span class="lineNum">    5668 </span>                :<span class="lineNoCov">          0 :                             hdr-&gt;b_crypt_hdr.b_mac);</span>
<span class="lineNum">    5669 </span>                :<span class="lineNoCov">          0 :                         abd_return_buf(zio-&gt;io_abd, tmpbuf,</span>
<span class="lineNum">    5670 </span>                :            :                             sizeof (zil_chain_t));
<span class="lineNum">    5671 </span>                :            :                 } else {
<span class="lineNum">    5672 </span>                :<span class="lineNoCov">          0 :                         zio_crypt_decode_mac_bp(bp, hdr-&gt;b_crypt_hdr.b_mac);</span>
<span class="lineNum">    5673 </span>                :            :                 }
<span class="lineNum">    5674 </span>                :            :         }
<span class="lineNum">    5675 </span>                :            : 
<span class="lineNum">    5676 </span>        [<span class="branchCov" title="Branch 0 was taken 1239518 times"> + </span><span class="branchCov" title="Branch 1 was taken 2318 times"> + </span>]:<span class="lineCov">    1241836 :         if (no_zio_error) {</span>
<span class="lineNum">    5677 </span>                :            :                 /* byteswap if necessary */
<span class="lineNum">    5678 </span>        [<span class="branchCov" title="Branch 0 was taken 18 times"> + </span><span class="branchCov" title="Branch 1 was taken 1239500 times"> + </span>]:<span class="lineCov">    1239518 :                 if (BP_SHOULD_BYTESWAP(zio-&gt;io_bp)) {</span>
<span class="lineNum">    5679 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">         18 :                         if (BP_GET_LEVEL(zio-&gt;io_bp) &gt; 0) {</span>
<span class="lineNum">    5680 </span>                :<span class="lineNoCov">          0 :                                 hdr-&gt;b_l1hdr.b_byteswap = DMU_BSWAP_UINT64;</span>
<span class="lineNum">    5681 </span>                :            :                         } else {
<span class="lineNum">    5682 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">         18 :                                 hdr-&gt;b_l1hdr.b_byteswap =</span>
<span class="lineNum">    5683 </span>                :<span class="lineCov">         36 :                                     DMU_OT_BYTESWAP(BP_GET_TYPE(zio-&gt;io_bp));</span>
<span class="lineNum">    5684 </span>                :            :                         }
<span class="lineNum">    5685 </span>                :            :                 } else {
<span class="lineNum">    5686 </span>                :<span class="lineCov">    1239500 :                         hdr-&gt;b_l1hdr.b_byteswap = DMU_BSWAP_NUMFUNCS;</span>
<span class="lineNum">    5687 </span>                :            :                 }
<span class="lineNum">    5688 </span>                :            :         }
<span class="lineNum">    5689 </span>                :            : 
<span class="lineNum">    5690 </span>                :<span class="lineCov">    1241836 :         arc_hdr_clear_flags(hdr, ARC_FLAG_L2_EVICTED);</span>
<span class="lineNum">    5691 </span>[<span class="branchCov" title="Branch 0 was taken 1242769 times"> + </span><span class="branchCov" title="Branch 1 was taken 34 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 184518 times"> + </span><span class="branchCov" title="Branch 3 was taken 1058251 times"> + </span>]:<span class="lineCov">    1242803 :         if (l2arc_noprefetch &amp;&amp; HDR_PREFETCH(hdr))</span>
<span class="lineNum">    5692 </span>                :<span class="lineCov">     184518 :                 arc_hdr_clear_flags(hdr, ARC_FLAG_L2CACHE);</span>
<span class="lineNum">    5693 </span>                :            : 
<span class="lineNum">    5694 </span>                :<span class="lineCov">    1242807 :         callback_list = hdr-&gt;b_l1hdr.b_acb;</span>
<span class="lineNum">    5695 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1242807 times"> + </span>]:<span class="lineCov">    1242807 :         ASSERT3P(callback_list, !=, NULL);</span>
<span class="lineNum">    5696 </span>                :            : 
<span class="lineNum">    5697 </span>[<span class="branchCov" title="Branch 0 was taken 243874 times"> + </span><span class="branchCov" title="Branch 1 was taken 998933 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 241553 times"> + </span><span class="branchCov" title="Branch 3 was taken 2321 times"> + </span>]:<span class="lineCov">    1242807 :         if (hash_lock &amp;&amp; no_zio_error &amp;&amp; hdr-&gt;b_l1hdr.b_state == arc_anon) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 241453 times"> + </span><span class="branchCov" title="Branch 5 was taken 100 times"> + </span>]
<span class="lineNum">    5698 </span>                :            :                 /*
<span class="lineNum">    5699 </span>                :            :                  * Only call arc_access on anonymous buffers.  This is because
<span class="lineNum">    5700 </span>                :            :                  * if we've issued an I/O for an evicted buffer, we've already
<span class="lineNum">    5701 </span>                :            :                  * called arc_access (to prevent any simultaneous readers from
<span class="lineNum">    5702 </span>                :            :                  * getting confused).
<span class="lineNum">    5703 </span>                :            :                  */
<span class="lineNum">    5704 </span>                :<span class="lineCov">    1242807 :                 arc_access(hdr, hash_lock);</span>
<span class="lineNum">    5705 </span>                :            :         }
<span class="lineNum">    5706 </span>                :            : 
<span class="lineNum">    5707 </span>                :            :         /*
<span class="lineNum">    5708 </span>                :            :          * If a read request has a callback (i.e. acb_done is not NULL), then we
<span class="lineNum">    5709 </span>                :            :          * make a buf containing the data according to the parameters which were
<span class="lineNum">    5710 </span>                :            :          * passed in. The implementation of arc_buf_alloc_impl() ensures that we
<span class="lineNum">    5711 </span>                :            :          * aren't needlessly decompressing the data multiple times.
<span class="lineNum">    5712 </span>                :            :          */
<span class="lineNum">    5713 </span>                :            :         int callback_cnt = 0;
<span class="lineNum">    5714 </span>        [<span class="branchCov" title="Branch 0 was taken 1244578 times"> + </span><span class="branchCov" title="Branch 1 was taken 1243064 times"> + </span>]:<span class="lineCov">    2487642 :         for (acb = callback_list; acb != NULL; acb = acb-&gt;acb_next) {</span>
<span class="lineNum">    5715 </span>        [<span class="branchCov" title="Branch 0 was taken 184525 times"> + </span><span class="branchCov" title="Branch 1 was taken 1060053 times"> + </span>]:<span class="lineCov">    1244578 :                 if (!acb-&gt;acb_done)</span>
<span class="lineNum">    5716 </span>                :<span class="lineCov">     184525 :                         continue;</span>
<span class="lineNum">    5717 </span>                :            : 
<span class="lineNum">    5718 </span>                :            :                 /* This is a demand read since prefetches don't use callbacks */
<span class="lineNum">    5719 </span>                :<span class="lineCov">    1060053 :                 callback_cnt++;</span>
<span class="lineNum">    5720 </span>                :            : 
<span class="lineNum">    5721 </span>                :<span class="lineCov">    1060053 :                 int error = arc_buf_alloc_impl(hdr, zio-&gt;io_spa,</span>
<span class="lineNum">    5722 </span>                :            :                     zio-&gt;io_bookmark.zb_objset, acb-&gt;acb_private,
<span class="lineNum">    5723 </span>                :            :                     acb-&gt;acb_encrypted, acb-&gt;acb_compressed, acb-&gt;acb_noauth,
<span class="lineNum">    5724 </span>                :            :                     no_zio_error, &amp;acb-&gt;acb_buf);
<span class="lineNum">    5725 </span>                :            : 
<span class="lineNum">    5726 </span>                :            :                 /*
<span class="lineNum">    5727 </span>                :            :                  * assert non-speculative zios didn't fail because an
<span class="lineNum">    5728 </span>                :            :                  * encryption key wasn't loaded
<span class="lineNum">    5729 </span>                :            :                  */
<span class="lineNum">    5730 </span>[<span class="branchCov" title="Branch 0 was taken 1055257 times"> + </span><span class="branchCov" title="Branch 1 was taken 5137 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 1055257 times"> + </span>]:<span class="lineCov">    1060394 :                 ASSERT((zio-&gt;io_flags &amp; ZIO_FLAG_SPECULATIVE) ||</span>
<span class="lineNum">    5731 </span>                :            :                     error == 0 || error != ENOENT);
<span class="lineNum">    5732 </span>                :            : 
<span class="lineNum">    5733 </span>                :            :                 /*
<span class="lineNum">    5734 </span>                :            :                  * If we failed to decrypt, report an error now (as the zio
<span class="lineNum">    5735 </span>                :            :                  * layer would have done if it had done the transforms).
<span class="lineNum">    5736 </span>                :            :                  */
<span class="lineNum">    5737 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1060394 times"> + </span>]:<span class="lineCov">    1060394 :                 if (error == ECKSUM) {</span>
<span class="lineNum">    5738 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         ASSERT(BP_IS_PROTECTED(bp));</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>][<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 12 was not executed"> # </span><span class="branchNoExec" title="Branch 13 was not executed"> # </span>][<span class="branchNoExec" title="Branch 14 was not executed"> # </span><span class="branchNoExec" title="Branch 15 was not executed"> # </span>]
<span class="lineNum">    5739 </span>                :<span class="lineNoCov">          0 :                         error = SET_ERROR(EIO);</span>
<span class="lineNum">    5740 </span>                :<span class="lineNoCov">          0 :                         spa_log_error(zio-&gt;io_spa, &amp;zio-&gt;io_bookmark);</span>
<span class="lineNum">    5741 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if ((zio-&gt;io_flags &amp; ZIO_FLAG_SPECULATIVE) == 0) {</span>
<span class="lineNum">    5742 </span>                :<span class="lineNoCov">          0 :                                 zfs_ereport_post(FM_EREPORT_ZFS_AUTHENTICATION,</span>
<span class="lineNum">    5743 </span>                :            :                                     zio-&gt;io_spa, NULL, &amp;zio-&gt;io_bookmark, zio,
<span class="lineNum">    5744 </span>                :            :                                     0, 0);
<span class="lineNum">    5745 </span>                :            :                         }
<span class="lineNum">    5746 </span>                :            :                 }
<span class="lineNum">    5747 </span>                :            : 
<span class="lineNum">    5748 </span>        [<span class="branchCov" title="Branch 0 was taken 1058156 times"> + </span><span class="branchCov" title="Branch 1 was taken 2327 times"> + </span>]:<span class="lineCov">    1060483 :                 if (no_zio_error) {</span>
<span class="lineNum">    5749 </span>                :<span class="lineCov">    1058156 :                         zio-&gt;io_error = error;</span>
<span class="lineNum">    5750 </span>                :            :                 }
<span class="lineNum">    5751 </span>                :            :         }
<span class="lineNum">    5752 </span>                :<span class="lineCov">    1243064 :         hdr-&gt;b_l1hdr.b_acb = NULL;</span>
<span class="lineNum">    5753 </span>                :<span class="lineCov">    1243064 :         arc_hdr_clear_flags(hdr, ARC_FLAG_IO_IN_PROGRESS);</span>
<span class="lineNum">    5754 </span>        [<span class="branchCov" title="Branch 0 was taken 184392 times"> + </span><span class="branchCov" title="Branch 1 was taken 1059045 times"> + </span>]:<span class="lineCov">    1243437 :         if (callback_cnt == 0) {</span>
<span class="lineNum">    5755 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 184392 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     184392 :                 ASSERT(HDR_PREFETCH(hdr) || HDR_HAS_RABD(hdr));</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    5756 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 184391 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     184391 :                 ASSERT(hdr-&gt;b_l1hdr.b_pabd != NULL || HDR_HAS_RABD(hdr));</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    5757 </span>                :            :         }
<span class="lineNum">    5758 </span>                :            : 
<span class="lineNum">    5759 </span>[<span class="branchCov" title="Branch 1 was taken 1058424 times"> + </span><span class="branchCov" title="Branch 2 was taken 184304 times"> + </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 1058424 times"> + </span>]:<span class="lineCov">    1243436 :         ASSERT(refcount_is_zero(&amp;hdr-&gt;b_l1hdr.b_refcnt) ||</span>
<span class="lineNum">    5760 </span>                :            :             callback_list != NULL);
<span class="lineNum">    5761 </span>                :            : 
<span class="lineNum">    5762 </span>        [<span class="branchCov" title="Branch 0 was taken 1240410 times"> + </span><span class="branchCov" title="Branch 1 was taken 2318 times"> + </span>]:<span class="lineCov">    1242728 :         if (no_zio_error) {</span>
<span class="lineNum">    5763 </span>                :<span class="lineCov">    1240410 :                 arc_hdr_verify(hdr, zio-&gt;io_bp);</span>
<span class="lineNum">    5764 </span>                :            :         } else {
<span class="lineNum">    5765 </span>                :<span class="lineCov">       2318 :                 arc_hdr_set_flags(hdr, ARC_FLAG_IO_ERROR);</span>
<span class="lineNum">    5766 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2318 times"> + </span>]:<span class="lineCov">       2318 :                 if (hdr-&gt;b_l1hdr.b_state != arc_anon)</span>
<span class="lineNum">    5767 </span>                :<span class="lineNoCov">          0 :                         arc_change_state(arc_anon, hdr, hash_lock);</span>
<span class="lineNum">    5768 </span>        [<span class="branchCov" title="Branch 0 was taken 2318 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2318 :                 if (HDR_IN_HASH_TABLE(hdr))</span>
<span class="lineNum">    5769 </span>                :<span class="lineCov">       2318 :                         buf_hash_remove(hdr);</span>
<span class="lineNum">    5770 </span>                :<span class="lineCov">       2318 :                 freeable = refcount_is_zero(&amp;hdr-&gt;b_l1hdr.b_refcnt);</span>
<span class="lineNum">    5771 </span>                :            :         }
<span class="lineNum">    5772 </span>                :            : 
<span class="lineNum">    5773 </span>                :            :         /*
<span class="lineNum">    5774 </span>                :            :          * Broadcast before we drop the hash_lock to avoid the possibility
<span class="lineNum">    5775 </span>                :            :          * that the hdr (and hence the cv) might be freed before we get to
<span class="lineNum">    5776 </span>                :            :          * the cv_broadcast().
<span class="lineNum">    5777 </span>                :            :          */
<span class="lineNum">    5778 </span>                :<span class="lineCov">    1242418 :         cv_broadcast(&amp;hdr-&gt;b_l1hdr.b_cv);</span>
<span class="lineNum">    5779 </span>                :            : 
<span class="lineNum">    5780 </span>        [<span class="branchCov" title="Branch 0 was taken 243879 times"> + </span><span class="branchCov" title="Branch 1 was taken 999039 times"> + </span>]:<span class="lineCov">    1242918 :         if (hash_lock != NULL) {</span>
<span class="lineNum">    5781 </span>                :<span class="lineCov">    1242812 :                 mutex_exit(hash_lock);</span>
<span class="lineNum">    5782 </span>                :            :         } else {
<span class="lineNum">    5783 </span>                :            :                 /*
<span class="lineNum">    5784 </span>                :            :                  * This block was freed while we waited for the read to
<span class="lineNum">    5785 </span>                :            :                  * complete.  It has been removed from the hash table and
<span class="lineNum">    5786 </span>                :            :                  * moved to the anonymous state (so that it won't show up
<span class="lineNum">    5787 </span>                :            :                  * in the cache).
<span class="lineNum">    5788 </span>                :            :                  */
<span class="lineNum">    5789 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 999039 times"> + </span>]:<span class="lineCov">     999039 :                 ASSERT3P(hdr-&gt;b_l1hdr.b_state, ==, arc_anon);</span>
<span class="lineNum">    5790 </span>                :<span class="lineCov">     999039 :                 freeable = refcount_is_zero(&amp;hdr-&gt;b_l1hdr.b_refcnt);</span>
<span class="lineNum">    5791 </span>                :            :         }
<span class="lineNum">    5792 </span>                :            : 
<span class="lineNum">    5793 </span>                :            :         /* execute each callback and free its structure */
<span class="lineNum">    5794 </span>        [<span class="branchCov" title="Branch 0 was taken 1244933 times"> + </span><span class="branchCov" title="Branch 1 was taken 1243501 times"> + </span>]:<span class="lineCov">    2488434 :         while ((acb = callback_list) != NULL) {</span>
<span class="lineNum">    5795 </span>        [<span class="branchCov" title="Branch 0 was taken 1060450 times"> + </span><span class="branchCov" title="Branch 1 was taken 184483 times"> + </span>]:<span class="lineCov">    1244933 :                 if (acb-&gt;acb_done) {</span>
<span class="lineNum">    5796 </span>                :<span class="lineCov">    1060450 :                         acb-&gt;acb_done(zio, zio-&gt;io_error, acb-&gt;acb_buf,</span>
<span class="lineNum">    5797 </span>                :            :                             acb-&gt;acb_private);
<span class="lineNum">    5798 </span>                :            :                 }
<span class="lineNum">    5799 </span>                :            : 
<span class="lineNum">    5800 </span>        [<span class="branchCov" title="Branch 0 was taken 1935 times"> + </span><span class="branchCov" title="Branch 1 was taken 1243413 times"> + </span>]:<span class="lineCov">    1245348 :                 if (acb-&gt;acb_zio_dummy != NULL) {</span>
<span class="lineNum">    5801 </span>                :<span class="lineCov">       1935 :                         acb-&gt;acb_zio_dummy-&gt;io_error = zio-&gt;io_error;</span>
<span class="lineNum">    5802 </span>                :<span class="lineCov">       1935 :                         zio_nowait(acb-&gt;acb_zio_dummy);</span>
<span class="lineNum">    5803 </span>                :            :                 }
<span class="lineNum">    5804 </span>                :            : 
<span class="lineNum">    5805 </span>                :<span class="lineCov">    1245348 :                 callback_list = acb-&gt;acb_next;</span>
<span class="lineNum">    5806 </span>                :<span class="lineCov">    1245348 :                 kmem_free(acb, sizeof (arc_callback_t));</span>
<span class="lineNum">    5807 </span>                :            :         }
<span class="lineNum">    5808 </span>                :            : 
<span class="lineNum">    5809 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1243501 times"> + </span>]:<span class="lineCov">    1243501 :         if (freeable)</span>
<span class="lineNum">    5810 </span>                :<span class="lineNoCov">          0 :                 arc_hdr_destroy(hdr);</span>
<span class="lineNum">    5811 </span>                :<span class="lineCov">    1243501 : }</span>
<span class="lineNum">    5812 </span>                :            : 
<span class="lineNum">    5813 </span>                :            : /*
<span class="lineNum">    5814 </span>                :            :  * &quot;Read&quot; the block at the specified DVA (in bp) via the
<span class="lineNum">    5815 </span>                :            :  * cache.  If the block is found in the cache, invoke the provided
<span class="lineNum">    5816 </span>                :            :  * callback immediately and return.  Note that the `zio' parameter
<span class="lineNum">    5817 </span>                :            :  * in the callback will be NULL in this case, since no IO was
<span class="lineNum">    5818 </span>                :            :  * required.  If the block is not in the cache pass the read request
<span class="lineNum">    5819 </span>                :            :  * on to the spa with a substitute callback function, so that the
<span class="lineNum">    5820 </span>                :            :  * requested block will be added to the cache.
<span class="lineNum">    5821 </span>                :            :  *
<span class="lineNum">    5822 </span>                :            :  * If a read request arrives for a block that has a read in-progress,
<span class="lineNum">    5823 </span>                :            :  * either wait for the in-progress read to complete (and return the
<span class="lineNum">    5824 </span>                :            :  * results); or, if this is a read with a &quot;done&quot; func, add a record
<span class="lineNum">    5825 </span>                :            :  * to the read to invoke the &quot;done&quot; func when the read completes,
<span class="lineNum">    5826 </span>                :            :  * and return; or just return.
<span class="lineNum">    5827 </span>                :            :  *
<span class="lineNum">    5828 </span>                :            :  * arc_read_done() will invoke all the requested &quot;done&quot; functions
<span class="lineNum">    5829 </span>                :            :  * for readers of this block.
<a name="5830"><span class="lineNum">    5830 </span>                :            :  */</a>
<span class="lineNum">    5831 </span>                :            : int
<span class="lineNum">    5832 </span>                :<span class="lineCov">    1870313 : arc_read(zio_t *pio, spa_t *spa, const blkptr_t *bp,</span>
<span class="lineNum">    5833 </span>                :            :     arc_read_done_func_t *done, void *private, zio_priority_t priority,
<span class="lineNum">    5834 </span>                :            :     int zio_flags, arc_flags_t *arc_flags, const zbookmark_phys_t *zb)
<span class="lineNum">    5835 </span>                :            : {
<span class="lineNum">    5836 </span>                :<span class="lineCov">    1870313 :         arc_buf_hdr_t *hdr = NULL;</span>
<span class="lineNum">    5837 </span>                :<span class="lineCov">    1870313 :         kmutex_t *hash_lock = NULL;</span>
<span class="lineNum">    5838 </span>                :            :         zio_t *rzio;
<span class="lineNum">    5839 </span>                :<span class="lineCov">    1870313 :         uint64_t guid = spa_load_guid(spa);</span>
<span class="lineNum">    5840 </span>                :<span class="lineCov">    1870047 :         boolean_t compressed_read = (zio_flags &amp; ZIO_FLAG_RAW_COMPRESS) != 0;</span>
<span class="lineNum">    5841 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1870047 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1870047 :         boolean_t encrypted_read = BP_IS_ENCRYPTED(bp) &amp;&amp;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>][<span class="branchNoCov" title="Branch 10 was not taken"> - </span><span class="branchCov" title="Branch 11 was taken 97 times"> + </span>]
<span class="lineNum">    5842 </span>                :<span class="lineCov">         97 :             (zio_flags &amp; ZIO_FLAG_RAW_ENCRYPT) != 0;</span>
<span class="lineNum">    5843 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1870047 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1870047 :         boolean_t noauth_read = BP_IS_AUTHENTICATED(bp) &amp;&amp;</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>][<span class="branchNoCov" title="Branch 10 was not taken"> - </span><span class="branchCov" title="Branch 11 was taken 123 times"> + </span>]
<span class="lineNum">    5844 </span>                :<span class="lineCov">        123 :             (zio_flags &amp; ZIO_FLAG_RAW_ENCRYPT) != 0;</span>
<span class="lineNum">    5845 </span>                :<span class="lineCov">    1870047 :         int rc = 0;</span>
<span class="lineNum">    5846 </span>                :            : 
<span class="lineNum">    5847 </span>[<span class="branchCov" title="Branch 0 was taken 871157 times"> + </span><span class="branchCov" title="Branch 1 was taken 998890 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 998890 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">    1870047 :         ASSERT(!BP_IS_EMBEDDED(bp) ||</span>
<span class="lineNum">    5848 </span>                :            :             BPE_GET_ETYPE(bp) == BP_EMBEDDED_TYPE_DATA);
<span class="lineNum">    5849 </span>                :            : 
<span class="lineNum">    5850 </span>                :            : top:
<span class="lineNum">    5851 </span>        [<span class="branchCov" title="Branch 0 was taken 980762 times"> + </span><span class="branchCov" title="Branch 1 was taken 998952 times"> + </span>]:<span class="lineCov">    1979714 :         if (!BP_IS_EMBEDDED(bp)) {</span>
<span class="lineNum">    5852 </span>                :            :                 /*
<span class="lineNum">    5853 </span>                :            :                  * Embedded BP's have no DVA and require no I/O to &quot;read&quot;.
<span class="lineNum">    5854 </span>                :            :                  * Create an anonymous arc buf to back it.
<span class="lineNum">    5855 </span>                :            :                  */
<span class="lineNum">    5856 </span>                :<span class="lineCov">     980762 :                 hdr = buf_hash_find(guid, bp, &amp;hash_lock);</span>
<span class="lineNum">    5857 </span>                :            :         }
<span class="lineNum">    5858 </span>                :            : 
<span class="lineNum">    5859 </span>                :            :         /*
<span class="lineNum">    5860 </span>                :            :          * Determine if we have an L1 cache hit or a cache miss. For simplicity
<span class="lineNum">    5861 </span>                :            :          * we maintain encrypted data seperately from compressed / uncompressed
<span class="lineNum">    5862 </span>                :            :          * data. If the user is requesting raw encrypted data and we don't have
<span class="lineNum">    5863 </span>                :            :          * that in the header we will read from disk to guarantee that we can
<span class="lineNum">    5864 </span>                :            :          * get it even if the encryption keys aren't loaded.
<span class="lineNum">    5865 </span>                :            :          */
<span class="lineNum">    5866 </span>[<span class="branchCov" title="Branch 0 was taken 734337 times"> + </span><span class="branchCov" title="Branch 1 was taken 1245322 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 734337 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">    1979659 :         if (hdr != NULL &amp;&amp; HDR_HAS_L1HDR(hdr) &amp;&amp; (HDR_HAS_RABD(hdr) ||</span>
<span class="lineNum">         </span>[<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 734337 times"> + </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 8 was taken 734245 times"> + </span><span class="branchCov" title="Branch 9 was taken 58 times"> + </span>]
<span class="lineNum">    5867 </span>        [<span class="branchCov" title="Branch 0 was taken 734245 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    1236968 :             (hdr-&gt;b_l1hdr.b_pabd != NULL &amp;&amp; !encrypted_read))) {</span>
<span class="lineNum">    5868 </span>                :<span class="lineCov">     734279 :                 arc_buf_t *buf = NULL;</span>
<span class="lineNum">    5869 </span>                :<span class="lineCov">     734279 :                 *arc_flags |= ARC_FLAG_CACHED;</span>
<span class="lineNum">    5870 </span>                :            : 
<span class="lineNum">    5871 </span>        [<span class="branchCov" title="Branch 0 was taken 231568 times"> + </span><span class="branchCov" title="Branch 1 was taken 502711 times"> + </span>]:<span class="lineCov">     734279 :                 if (HDR_IO_IN_PROGRESS(hdr)) {</span>
<span class="lineNum">    5872 </span>                :            : 
<span class="lineNum">    5873 </span>[<span class="branchCov" title="Branch 0 was taken 229627 times"> + </span><span class="branchCov" title="Branch 1 was taken 1941 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 229627 times"> + </span>]:<span class="lineCov">     231568 :                         if ((hdr-&gt;b_flags &amp; ARC_FLAG_PRIO_ASYNC_READ) &amp;&amp;</span>
<span class="lineNum">    5874 </span>                :            :                             priority == ZIO_PRIORITY_SYNC_READ) {
<span class="lineNum">    5875 </span>                :            :                                 /*
<span class="lineNum">    5876 </span>                :            :                                  * This sync read must wait for an
<span class="lineNum">    5877 </span>                :            :                                  * in-progress async read (e.g. a predictive
<span class="lineNum">    5878 </span>                :            :                                  * prefetch).  Async reads are queued
<span class="lineNum">    5879 </span>                :            :                                  * separately at the vdev_queue layer, so
<span class="lineNum">    5880 </span>                :            :                                  * this is a form of priority inversion.
<span class="lineNum">    5881 </span>                :            :                                  * Ideally, we would &quot;inherit&quot; the demand
<span class="lineNum">    5882 </span>                :            :                                  * i/o's priority by moving the i/o from
<span class="lineNum">    5883 </span>                :            :                                  * the async queue to the synchronous queue,
<span class="lineNum">    5884 </span>                :            :                                  * but there is currently no mechanism to do
<span class="lineNum">    5885 </span>                :            :                                  * so.  Track this so that we can evaluate
<span class="lineNum">    5886 </span>                :            :                                  * the magnitude of this potential performance
<span class="lineNum">    5887 </span>                :            :                                  * problem.
<span class="lineNum">    5888 </span>                :            :                                  *
<span class="lineNum">    5889 </span>                :            :                                  * Note that if the prefetch i/o is already
<span class="lineNum">    5890 </span>                :            :                                  * active (has been issued to the device),
<span class="lineNum">    5891 </span>                :            :                                  * the prefetch improved performance, because
<span class="lineNum">    5892 </span>                :            :                                  * we issued it sooner than we would have
<span class="lineNum">    5893 </span>                :            :                                  * without the prefetch.
<span class="lineNum">    5894 </span>                :            :                                  */
<span class="lineNum">    5895 </span>                :            :                                 DTRACE_PROBE1(arc__sync__wait__for__async,
<span class="lineNum">    5896 </span>                :            :                                     arc_buf_hdr_t *, hdr);
<span class="lineNum">    5897 </span>                :<span class="lineNoCov">          0 :                                 ARCSTAT_BUMP(arcstat_sync_wait_for_async);</span>
<span class="lineNum">    5898 </span>                :            :                         }
<span class="lineNum">    5899 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 231568 times"> + </span>]:<span class="lineCov">     231568 :                         if (hdr-&gt;b_flags &amp; ARC_FLAG_PREDICTIVE_PREFETCH) {</span>
<span class="lineNum">    5900 </span>                :<span class="lineNoCov">          0 :                                 arc_hdr_clear_flags(hdr,</span>
<span class="lineNum">    5901 </span>                :            :                                     ARC_FLAG_PREDICTIVE_PREFETCH);
<span class="lineNum">    5902 </span>                :            :                         }
<span class="lineNum">    5903 </span>                :            : 
<span class="lineNum">    5904 </span>        [<span class="branchCov" title="Branch 0 was taken 107016 times"> + </span><span class="branchCov" title="Branch 1 was taken 124552 times"> + </span>]:<span class="lineCov">     231568 :                         if (*arc_flags &amp; ARC_FLAG_WAIT) {</span>
<span class="lineNum">    5905 </span>                :<span class="lineCov">     107016 :                                 cv_wait(&amp;hdr-&gt;b_l1hdr.b_cv, hash_lock);</span>
<span class="lineNum">    5906 </span>                :<span class="lineCov">     107016 :                                 mutex_exit(hash_lock);</span>
<span class="lineNum">    5907 </span>                :<span class="lineCov">     107016 :                                 goto top;</span>
<span class="lineNum">    5908 </span>                :            :                         }
<span class="lineNum">    5909 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 124552 times"> + </span>]:<span class="lineCov">     124552 :                         ASSERT(*arc_flags &amp; ARC_FLAG_NOWAIT);</span>
<span class="lineNum">    5910 </span>                :            : 
<span class="lineNum">    5911 </span>        [<span class="branchCov" title="Branch 0 was taken 1935 times"> + </span><span class="branchCov" title="Branch 1 was taken 122617 times"> + </span>]:<span class="lineCov">     124552 :                         if (done) {</span>
<span class="lineNum">    5912 </span>                :<span class="lineCov">       1935 :                                 arc_callback_t *acb = NULL;</span>
<span class="lineNum">    5913 </span>                :            : 
<span class="lineNum">    5914 </span>                :<span class="lineCov">       1935 :                                 acb = kmem_zalloc(sizeof (arc_callback_t),</span>
<span class="lineNum">    5915 </span>                :            :                                     KM_SLEEP);
<span class="lineNum">    5916 </span>                :<span class="lineCov">       1935 :                                 acb-&gt;acb_done = done;</span>
<span class="lineNum">    5917 </span>                :<span class="lineCov">       1935 :                                 acb-&gt;acb_private = private;</span>
<span class="lineNum">    5918 </span>                :<span class="lineCov">       1935 :                                 acb-&gt;acb_compressed = compressed_read;</span>
<span class="lineNum">    5919 </span>        [<span class="branchCov" title="Branch 0 was taken 1935 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1935 :                                 if (pio != NULL)</span>
<span class="lineNum">    5920 </span>                :<span class="lineCov">       1935 :                                         acb-&gt;acb_zio_dummy = zio_null(pio,</span>
<span class="lineNum">    5921 </span>                :            :                                             spa, NULL, NULL, NULL, zio_flags);
<span class="lineNum">    5922 </span>                :            : 
<span class="lineNum">    5923 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1935 times"> + </span>]:<span class="lineCov">       1935 :                                 ASSERT3P(acb-&gt;acb_done, !=, NULL);</span>
<span class="lineNum">    5924 </span>                :<span class="lineCov">       1935 :                                 acb-&gt;acb_next = hdr-&gt;b_l1hdr.b_acb;</span>
<span class="lineNum">    5925 </span>                :<span class="lineCov">       1935 :                                 hdr-&gt;b_l1hdr.b_acb = acb;</span>
<span class="lineNum">    5926 </span>                :<span class="lineCov">       1935 :                                 mutex_exit(hash_lock);</span>
<span class="lineNum">    5927 </span>                :<span class="lineCov">     124552 :                                 goto out;</span>
<span class="lineNum">    5928 </span>                :            :                         }
<span class="lineNum">    5929 </span>                :<span class="lineCov">     122617 :                         mutex_exit(hash_lock);</span>
<span class="lineNum">    5930 </span>                :<span class="lineCov">     122617 :                         goto out;</span>
<span class="lineNum">    5931 </span>                :            :                 }
<span class="lineNum">    5932 </span>                :            : 
<span class="lineNum">    5933 </span>[<span class="branchCov" title="Branch 0 was taken 36510 times"> + </span><span class="branchCov" title="Branch 1 was taken 466201 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 36510 times"> + </span>]:<span class="lineCov">     502711 :                 ASSERT(hdr-&gt;b_l1hdr.b_state == arc_mru ||</span>
<span class="lineNum">    5934 </span>                :            :                     hdr-&gt;b_l1hdr.b_state == arc_mfu);
<span class="lineNum">    5935 </span>                :            : 
<span class="lineNum">    5936 </span>        [<span class="branchCov" title="Branch 0 was taken 324097 times"> + </span><span class="branchCov" title="Branch 1 was taken 178614 times"> + </span>]:<span class="lineCov">     502711 :                 if (done) {</span>
<span class="lineNum">    5937 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 324097 times"> + </span>]:<span class="lineCov">     324097 :                         if (hdr-&gt;b_flags &amp; ARC_FLAG_PREDICTIVE_PREFETCH) {</span>
<span class="lineNum">    5938 </span>                :            :                                 /*
<span class="lineNum">    5939 </span>                :            :                                  * This is a demand read which does not have to
<span class="lineNum">    5940 </span>                :            :                                  * wait for i/o because we did a predictive
<span class="lineNum">    5941 </span>                :            :                                  * prefetch i/o for it, which has completed.
<span class="lineNum">    5942 </span>                :            :                                  */
<span class="lineNum">    5943 </span>                :            :                                 DTRACE_PROBE1(
<span class="lineNum">    5944 </span>                :            :                                     arc__demand__hit__predictive__prefetch,
<span class="lineNum">    5945 </span>                :            :                                     arc_buf_hdr_t *, hdr);
<span class="lineNum">    5946 </span>                :<span class="lineNoCov">          0 :                                 ARCSTAT_BUMP(</span>
<span class="lineNum">    5947 </span>                :            :                                     arcstat_demand_hit_predictive_prefetch);
<span class="lineNum">    5948 </span>                :<span class="lineNoCov">          0 :                                 arc_hdr_clear_flags(hdr,</span>
<span class="lineNum">    5949 </span>                :            :                                     ARC_FLAG_PREDICTIVE_PREFETCH);
<span class="lineNum">    5950 </span>                :            :                         }
<span class="lineNum">    5951 </span>                :            :                         ASSERT(!BP_IS_EMBEDDED(bp) || !BP_IS_HOLE(bp));
<span class="lineNum">    5952 </span>                :            : 
<span class="lineNum">    5953 </span>                :            :                         /* Get a buf with the desired data in it. */
<span class="lineNum">    5954 </span>                :<span class="lineCov">     324097 :                         rc = arc_buf_alloc_impl(hdr, spa, zb-&gt;zb_objset,</span>
<span class="lineNum">    5955 </span>                :            :                             private, encrypted_read, compressed_read,
<span class="lineNum">    5956 </span>                :            :                             noauth_read, B_TRUE, &amp;buf);
<span class="lineNum">    5957 </span>                :            : 
<span class="lineNum">    5958 </span>[<span class="branchCov" title="Branch 0 was taken 323616 times"> + </span><span class="branchCov" title="Branch 1 was taken 483 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 323616 times"> + </span>]:<span class="lineCov">     324099 :                         ASSERT((zio_flags &amp; ZIO_FLAG_SPECULATIVE) ||</span>
<span class="lineNum">    5959 </span>                :            :                             rc == 0 || rc != ENOENT);
<span class="lineNum">    5960 </span>  [<span class="branchCov" title="Branch 0 was taken 178614 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 129140 times"> + </span><span class="branchCov" title="Branch 3 was taken 49470 times"> + </span>]:<span class="lineCov">     357224 :                 } else if (*arc_flags &amp; ARC_FLAG_PREFETCH &amp;&amp;</span>
<span class="lineNum">    5961 </span>                :<span class="lineCov">     178614 :                     refcount_count(&amp;hdr-&gt;b_l1hdr.b_refcnt) == 0) {</span>
<span class="lineNum">    5962 </span>                :<span class="lineCov">     129140 :                         arc_hdr_set_flags(hdr, ARC_FLAG_PREFETCH);</span>
<span class="lineNum">    5963 </span>                :            :                 }
<span class="lineNum">    5964 </span>                :            :                 DTRACE_PROBE1(arc__hit, arc_buf_hdr_t *, hdr);
<span class="lineNum">    5965 </span>                :<span class="lineCov">     502709 :                 arc_access(hdr, hash_lock);</span>
<span class="lineNum">    5966 </span>        [<span class="branchCov" title="Branch 0 was taken 11736 times"> + </span><span class="branchCov" title="Branch 1 was taken 490962 times"> + </span>]:<span class="lineCov">     502698 :                 if (*arc_flags &amp; ARC_FLAG_L2CACHE)</span>
<span class="lineNum">    5967 </span>                :<span class="lineCov">      11736 :                         arc_hdr_set_flags(hdr, ARC_FLAG_L2CACHE);</span>
<span class="lineNum">    5968 </span>                :<span class="lineCov">     502698 :                 mutex_exit(hash_lock);</span>
<span class="lineNum">    5969 </span>                :<span class="lineCov">     502719 :                 ARCSTAT_BUMP(arcstat_hits);</span>
<span class="lineNum">    5970 </span>[<span class="branchCov" title="Branch 0 was taken 373578 times"> + </span><span class="branchCov" title="Branch 1 was taken 129139 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 174 times"> + </span><span class="branchCov" title="Branch 3 was taken 373404 times"> + </span>]:<span class="lineCov">     502717 :                 ARCSTAT_CONDSTAT(!HDR_PREFETCH(hdr),</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 2287 times"> + </span><span class="branchCov" title="Branch 7 was taken 126852 times"> + </span>]
<span class="lineNum">    5971 </span>                :            :                     demand, prefetch, !HDR_ISTYPE_METADATA(hdr),
<span class="lineNum">    5972 </span>                :            :                     data, metadata, hits);
<span class="lineNum">    5973 </span>                :            : 
<span class="lineNum">    5974 </span>        [<span class="branchCov" title="Branch 0 was taken 324104 times"> + </span><span class="branchCov" title="Branch 1 was taken 178622 times"> + </span>]:<span class="lineCov">     502726 :                 if (done)</span>
<span class="lineNum">    5975 </span>                :<span class="lineCov">     324104 :                         done(NULL, rc, buf, private);</span>
<span class="lineNum">    5976 </span>                :            :         } else {
<span class="lineNum">    5977 </span>   [<span class="branchCov" title="Branch 0 was taken 998849 times"> + </span><span class="branchCov" title="Branch 1 was taken 246531 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 998908 times"> + </span>]:<span class="lineCov">    1245380 :                 uint64_t lsize = BP_GET_LSIZE(bp);</span>
<span class="lineNum">    5978 </span>        [<span class="branchCov" title="Branch 0 was taken 246531 times"> + </span><span class="branchCov" title="Branch 1 was taken 998849 times"> + </span>]:<span class="lineCov">    1245380 :                 uint64_t psize = BP_GET_PSIZE(bp);</span>
<span class="lineNum">    5979 </span>                :            :                 arc_callback_t *acb;
<span class="lineNum">    5980 </span>                :<span class="lineCov">    1245380 :                 vdev_t *vd = NULL;</span>
<span class="lineNum">    5981 </span>                :<span class="lineCov">    1245380 :                 uint64_t addr = 0;</span>
<span class="lineNum">    5982 </span>                :<span class="lineCov">    1245380 :                 boolean_t devw = B_FALSE;</span>
<span class="lineNum">    5983 </span>                :            :                 uint64_t size;
<span class="lineNum">    5984 </span>                :            :                 void *hdr_abd;
<span class="lineNum">    5985 </span>                :            : 
<span class="lineNum">    5986 </span>                :            :                 /*
<span class="lineNum">    5987 </span>                :            :                  * Gracefully handle a damaged logical block size as a
<span class="lineNum">    5988 </span>                :            :                  * checksum error.
<span class="lineNum">    5989 </span>                :            :                  */
<span class="lineNum">    5990 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 1245825 times"> + </span>]:<span class="lineCov">    1245380 :                 if (lsize &gt; spa_maxblocksize(spa)) {</span>
<span class="lineNum">    5991 </span>                :<span class="lineNoCov">          0 :                         rc = SET_ERROR(ECKSUM);</span>
<span class="lineNum">    5992 </span>                :<span class="lineNoCov">          0 :                         goto out;</span>
<span class="lineNum">    5993 </span>                :            :                 }
<span class="lineNum">    5994 </span>                :            : 
<span class="lineNum">    5995 </span>        [<span class="branchCov" title="Branch 0 was taken 1245724 times"> + </span><span class="branchCov" title="Branch 1 was taken 101 times"> + </span>]:<span class="lineCov">    1245825 :                 if (hdr == NULL) {</span>
<span class="lineNum">    5996 </span>                :            :                         /* this block is not in the cache */
<span class="lineNum">    5997 </span>                :<span class="lineCov">    1245724 :                         arc_buf_hdr_t *exists = NULL;</span>
<span class="lineNum">    5998 </span>[<span class="branchCov" title="Branch 0 was taken 1096311 times"> + </span><span class="branchCov" title="Branch 1 was taken 149413 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 231544 times"> + </span><span class="branchCov" title="Branch 3 was taken 864767 times"> + </span>]:<span class="lineCov">    1245724 :                         arc_buf_contents_t type = BP_GET_BUFC_TYPE(bp);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchCov" title="Branch 5 was taken 231543 times"> + </span>][<span class="branchCov" title="Branch 6 was taken 38581 times"> + </span><span class="branchCov" title="Branch 7 was taken 826186 times"> + </span>]
<span class="lineNum">    5999 </span>                :<span class="lineCov">    1245724 :                         hdr = arc_hdr_alloc(spa_load_guid(spa), psize, lsize,</span>
<span class="lineNum">    6000 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1245724 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1245724 :                             BP_IS_PROTECTED(bp), BP_GET_COMPRESS(bp), type,</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>][<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 12 was not executed"> # </span><span class="branchNoExec" title="Branch 13 was not executed"> # </span>][<span class="branchNoExec" title="Branch 14 was not executed"> # </span><span class="branchNoExec" title="Branch 15 was not executed"> # </span>]
<span class="lineNum">    6001 </span>                :            :                             encrypted_read);
<span class="lineNum">    6002 </span>                :            : 
<span class="lineNum">    6003 </span>        [<span class="branchCov" title="Branch 0 was taken 246432 times"> + </span><span class="branchCov" title="Branch 1 was taken 999664 times"> + </span>]:<span class="lineCov">    1246096 :                         if (!BP_IS_EMBEDDED(bp)) {</span>
<span class="lineNum">    6004 </span>                :<span class="lineCov">     246432 :                                 hdr-&gt;b_dva = *BP_IDENTITY(bp);</span>
<span class="lineNum">    6005 </span>[<span class="branchCov" title="Branch 0 was taken 246431 times"> + </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>][<span class="branchCov" title="Branch 2 was taken 246397 times"> + </span><span class="branchCov" title="Branch 3 was taken 34 times"> + </span>]:<span class="lineCov">     246432 :                                 hdr-&gt;b_birth = BP_PHYSICAL_BIRTH(bp);</span>
<span class="lineNum">    6006 </span>                :<span class="lineCov">     246432 :                                 exists = buf_hash_insert(hdr, &amp;hash_lock);</span>
<span class="lineNum">    6007 </span>                :            :                         }
<span class="lineNum">    6008 </span>        [<span class="branchCov" title="Branch 0 was taken 2651 times"> + </span><span class="branchCov" title="Branch 1 was taken 1243418 times"> + </span>]:<span class="lineCov">    1246069 :                         if (exists != NULL) {</span>
<span class="lineNum">    6009 </span>                :            :                                 /* somebody beat us to the hash insert */
<span class="lineNum">    6010 </span>                :<span class="lineCov">       2651 :                                 mutex_exit(hash_lock);</span>
<span class="lineNum">    6011 </span>                :<span class="lineCov">       2651 :                                 buf_discard_identity(hdr);</span>
<span class="lineNum">    6012 </span>                :<span class="lineCov">       2651 :                                 arc_hdr_destroy(hdr);</span>
<span class="lineNum">    6013 </span>                :<span class="lineCov">     109667 :                                 goto top; /* restart the IO request */</span>
<span class="lineNum">    6014 </span>                :            :                         }
<span class="lineNum">    6015 </span>                :            :                 } else {
<span class="lineNum">    6016 </span>                :            :                         /*
<span class="lineNum">    6017 </span>                :            :                          * This block is in the ghost cache or encrypted data
<span class="lineNum">    6018 </span>                :            :                          * was requested and we didn't have it. If it was
<span class="lineNum">    6019 </span>                :            :                          * L2-only (and thus didn't have an L1 hdr),
<span class="lineNum">    6020 </span>                :            :                          * we realloc the header to add an L1 hdr.
<span class="lineNum">    6021 </span>                :            :                          */
<span class="lineNum">    6022 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 101 times"> + </span>]:<span class="lineCov">        101 :                         if (!HDR_HAS_L1HDR(hdr)) {</span>
<span class="lineNum">    6023 </span>                :<span class="lineNoCov">          0 :                                 hdr = arc_hdr_realloc(hdr, hdr_l2only_cache,</span>
<span class="lineNum">    6024 </span>                :            :                                     hdr_full_cache);
<span class="lineNum">    6025 </span>                :            :                         }
<span class="lineNum">    6026 </span>                :            : 
<span class="lineNum">    6027 </span>[<span class="branchCov" title="Branch 0 was taken 101 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 101 times"> + </span>]:<span class="lineCov">        101 :                         if (GHOST_STATE(hdr-&gt;b_l1hdr.b_state)) {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    6028 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 101 times"> + </span>]:<span class="lineCov">        101 :                                 ASSERT3P(hdr-&gt;b_l1hdr.b_pabd, ==, NULL);</span>
<span class="lineNum">    6029 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 101 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">        101 :                                 ASSERT(!HDR_HAS_RABD(hdr));</span>
<span class="lineNum">    6030 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 101 times"> + </span>]:<span class="lineCov">        101 :                                 ASSERT(!HDR_IO_IN_PROGRESS(hdr));</span>
<span class="lineNum">    6031 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 101 times"> + </span>]:<span class="lineCov">        101 :                                 ASSERT0(refcount_count(&amp;hdr-&gt;b_l1hdr.b_refcnt));</span>
<span class="lineNum">    6032 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 101 times"> + </span>]:<span class="lineCov">        101 :                                 ASSERT3P(hdr-&gt;b_l1hdr.b_buf, ==, NULL);</span>
<span class="lineNum">    6033 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 101 times"> + </span>]:<span class="lineCov">        101 :                                 ASSERT3P(hdr-&gt;b_l1hdr.b_freeze_cksum, ==, NULL);</span>
<span class="lineNum">    6034 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         } else if (HDR_IO_IN_PROGRESS(hdr)) {</span>
<span class="lineNum">    6035 </span>                :            :                                 /*
<span class="lineNum">    6036 </span>                :            :                                  * If this header already had an IO in progress
<span class="lineNum">    6037 </span>                :            :                                  * and we are performing another IO to fetch
<span class="lineNum">    6038 </span>                :            :                                  * encrypted data we must wait until the first
<span class="lineNum">    6039 </span>                :            :                                  * IO completes so as not to confuse
<span class="lineNum">    6040 </span>                :            :                                  * arc_read_done(). This should be very rare
<span class="lineNum">    6041 </span>                :            :                                  * and so the performance impact shouldn't
<span class="lineNum">    6042 </span>                :            :                                  * matter.
<span class="lineNum">    6043 </span>                :            :                                  */
<span class="lineNum">    6044 </span>                :<span class="lineNoCov">          0 :                                 cv_wait(&amp;hdr-&gt;b_l1hdr.b_cv, hash_lock);</span>
<span class="lineNum">    6045 </span>                :<span class="lineNoCov">          0 :                                 mutex_exit(hash_lock);</span>
<span class="lineNum">    6046 </span>                :<span class="lineNoCov">          0 :                                 goto top;</span>
<span class="lineNum">    6047 </span>                :            :                         }
<span class="lineNum">    6048 </span>                :            : 
<span class="lineNum">    6049 </span>                :            :                         /*
<span class="lineNum">    6050 </span>                :            :                          * This is a delicate dance that we play here.
<span class="lineNum">    6051 </span>                :            :                          * This hdr might be in the ghost list so we access
<span class="lineNum">    6052 </span>                :            :                          * it to move it out of the ghost list before we
<span class="lineNum">    6053 </span>                :            :                          * initiate the read. If it's a prefetch then
<span class="lineNum">    6054 </span>                :            :                          * it won't have a callback so we'll remove the
<span class="lineNum">    6055 </span>                :            :                          * reference that arc_buf_alloc_impl() created. We
<span class="lineNum">    6056 </span>                :            :                          * do this after we've called arc_access() to
<span class="lineNum">    6057 </span>                :            :                          * avoid hitting an assert in remove_reference().
<span class="lineNum">    6058 </span>                :            :                          */
<span class="lineNum">    6059 </span>                :<span class="lineCov">        101 :                         arc_access(hdr, hash_lock);</span>
<span class="lineNum">    6060 </span>                :<span class="lineCov">        101 :                         arc_hdr_alloc_abd(hdr, encrypted_read);</span>
<span class="lineNum">    6061 </span>                :            :                 }
<span class="lineNum">    6062 </span>                :            : 
<span class="lineNum">    6063 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1243519 times"> + </span>]:<span class="lineCov">    1243519 :                 if (encrypted_read) {</span>
<span class="lineNum">    6064 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         ASSERT(HDR_HAS_RABD(hdr));</span>
<span class="lineNum">    6065 </span>                :<span class="lineNoCov">          0 :                         size = HDR_GET_PSIZE(hdr);</span>
<span class="lineNum">    6066 </span>                :<span class="lineNoCov">          0 :                         hdr_abd = hdr-&gt;b_crypt_hdr.b_rabd;</span>
<span class="lineNum">    6067 </span>                :<span class="lineNoCov">          0 :                         zio_flags |= ZIO_FLAG_RAW;</span>
<span class="lineNum">    6068 </span>                :            :                 } else {
<span class="lineNum">    6069 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1243519 times"> + </span>]:<span class="lineCov">    1243519 :                         ASSERT3P(hdr-&gt;b_l1hdr.b_pabd, !=, NULL);</span>
<span class="lineNum">    6070 </span>                :<span class="lineCov">    1243519 :                         size = arc_hdr_size(hdr);</span>
<span class="lineNum">    6071 </span>                :<span class="lineCov">    1243368 :                         hdr_abd = hdr-&gt;b_l1hdr.b_pabd;</span>
<span class="lineNum">    6072 </span>                :            : 
<span class="lineNum">    6073 </span>        [<span class="branchCov" title="Branch 1 was taken 175206 times"> + </span><span class="branchCov" title="Branch 2 was taken 1068159 times"> + </span>]:<span class="lineCov">    1243368 :                         if (arc_hdr_get_compress(hdr) != ZIO_COMPRESS_OFF) {</span>
<span class="lineNum">    6074 </span>                :<span class="lineCov">     175206 :                                 zio_flags |= ZIO_FLAG_RAW_COMPRESS;</span>
<span class="lineNum">    6075 </span>                :            :                         }
<span class="lineNum">    6076 </span>                :            : 
<span class="lineNum">    6077 </span>                :            :                         /*
<span class="lineNum">    6078 </span>                :            :                          * For authenticated bp's, we do not ask the ZIO layer
<span class="lineNum">    6079 </span>                :            :                          * to authenticate them since this will cause the entire
<span class="lineNum">    6080 </span>                :            :                          * IO to fail if the key isn't loaded. Instead, we
<span class="lineNum">    6081 </span>                :            :                          * defer authentication until arc_buf_fill(), which will
<span class="lineNum">    6082 </span>                :            :                          * verify the data when the key is available.
<span class="lineNum">    6083 </span>                :            :                          */
<span class="lineNum">    6084 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1243365 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1243365 :                         if (BP_IS_AUTHENTICATED(bp))</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">    6085 </span>                :<span class="lineNoCov">          0 :                                 zio_flags |= ZIO_FLAG_RAW_ENCRYPT;</span>
<span class="lineNum">    6086 </span>                :            :                 }
<span class="lineNum">    6087 </span>                :            : 
<span class="lineNum">    6088 </span>  [<span class="branchCov" title="Branch 0 was taken 184526 times"> + </span><span class="branchCov" title="Branch 1 was taken 1058839 times"> + </span><span class="branchCov" title="Branch 2 was taken 184526 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">    1427891 :                 if (*arc_flags &amp; ARC_FLAG_PREFETCH &amp;&amp;</span>
<span class="lineNum">    6089 </span>                :<span class="lineCov">     184526 :                     refcount_is_zero(&amp;hdr-&gt;b_l1hdr.b_refcnt))</span>
<span class="lineNum">    6090 </span>                :<span class="lineCov">     184526 :                         arc_hdr_set_flags(hdr, ARC_FLAG_PREFETCH);</span>
<span class="lineNum">    6091 </span>        [<span class="branchCov" title="Branch 0 was taken 1046437 times"> + </span><span class="branchCov" title="Branch 1 was taken 196849 times"> + </span>]:<span class="lineCov">    1243286 :                 if (*arc_flags &amp; ARC_FLAG_L2CACHE)</span>
<span class="lineNum">    6092 </span>                :<span class="lineCov">    1046437 :                         arc_hdr_set_flags(hdr, ARC_FLAG_L2CACHE);</span>
<span class="lineNum">    6093 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1243285 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1243285 :                 if (BP_IS_AUTHENTICATED(bp))</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">    6094 </span>                :<span class="lineNoCov">          0 :                         arc_hdr_set_flags(hdr, ARC_FLAG_NOAUTH);</span>
<span class="lineNum">    6095 </span>        [<span class="branchCov" title="Branch 0 was taken 146847 times"> + </span><span class="branchCov" title="Branch 1 was taken 1096438 times"> + </span>]:<span class="lineCov">    1243285 :                 if (BP_GET_LEVEL(bp) &gt; 0)</span>
<span class="lineNum">    6096 </span>                :<span class="lineCov">     146847 :                         arc_hdr_set_flags(hdr, ARC_FLAG_INDIRECT);</span>
<span class="lineNum">    6097 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1243285 times"> + </span>]:<span class="lineCov">    1243285 :                 if (*arc_flags &amp; ARC_FLAG_PREDICTIVE_PREFETCH)</span>
<span class="lineNum">    6098 </span>                :<span class="lineNoCov">          0 :                         arc_hdr_set_flags(hdr, ARC_FLAG_PREDICTIVE_PREFETCH);</span>
<span class="lineNum">    6099 </span>   [<span class="branchCov" title="Branch 0 was taken 1243285 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1243295 times"> + </span>]:<span class="lineCov">    1243285 :                 ASSERT(!GHOST_STATE(hdr-&gt;b_l1hdr.b_state));</span>
<span class="lineNum">         </span>           [<span class="branchCov" title="Branch 5 was taken 1243303 times"> + </span>]
<span class="lineNum">    6100 </span>                :            : 
<span class="lineNum">    6101 </span>                :<span class="lineCov">    1243303 :                 acb = kmem_zalloc(sizeof (arc_callback_t), KM_SLEEP);</span>
<span class="lineNum">    6102 </span>                :<span class="lineCov">    1243360 :                 acb-&gt;acb_done = done;</span>
<span class="lineNum">    6103 </span>                :<span class="lineCov">    1243360 :                 acb-&gt;acb_private = private;</span>
<span class="lineNum">    6104 </span>                :<span class="lineCov">    1243360 :                 acb-&gt;acb_compressed = compressed_read;</span>
<span class="lineNum">    6105 </span>                :<span class="lineCov">    1243360 :                 acb-&gt;acb_encrypted = encrypted_read;</span>
<span class="lineNum">    6106 </span>                :<span class="lineCov">    1243360 :                 acb-&gt;acb_noauth = noauth_read;</span>
<span class="lineNum">    6107 </span>                :            : 
<span class="lineNum">    6108 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1243360 times"> + </span>]:<span class="lineCov">    1243360 :                 ASSERT3P(hdr-&gt;b_l1hdr.b_acb, ==, NULL);</span>
<span class="lineNum">    6109 </span>                :<span class="lineCov">    1243360 :                 hdr-&gt;b_l1hdr.b_acb = acb;</span>
<span class="lineNum">    6110 </span>                :<span class="lineCov">    1243360 :                 arc_hdr_set_flags(hdr, ARC_FLAG_IO_IN_PROGRESS);</span>
<span class="lineNum">    6111 </span>                :            : 
<span class="lineNum">    6112 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1243358 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1243358 :                 if (HDR_HAS_L2HDR(hdr) &amp;&amp;</span>
<span class="lineNum">    6113 </span>                :<span class="lineNoCov">          0 :                     (vd = hdr-&gt;b_l2hdr.b_dev-&gt;l2ad_vdev) != NULL) {</span>
<span class="lineNum">    6114 </span>                :<span class="lineNoCov">          0 :                         devw = hdr-&gt;b_l2hdr.b_dev-&gt;l2ad_writing;</span>
<span class="lineNum">    6115 </span>                :<span class="lineNoCov">          0 :                         addr = hdr-&gt;b_l2hdr.b_daddr;</span>
<span class="lineNum">    6116 </span>                :            :                         /*
<span class="lineNum">    6117 </span>                :            :                          * Lock out device removal.
<span class="lineNum">    6118 </span>                :            :                          */
<span class="lineNum">    6119 </span>  [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (vdev_is_dead(vd) ||</span>
<span class="lineNum">    6120 </span>                :<span class="lineNoCov">          0 :                             !spa_config_tryenter(spa, SCL_L2ARC, vd, RW_READER))</span>
<span class="lineNum">    6121 </span>                :            :                                 vd = NULL;
<span class="lineNum">    6122 </span>                :            :                 }
<span class="lineNum">    6123 </span>                :            : 
<span class="lineNum">    6124 </span>        [<span class="branchCov" title="Branch 0 was taken 187659 times"> + </span><span class="branchCov" title="Branch 1 was taken 1055699 times"> + </span>]:<span class="lineCov">    1243358 :                 if (priority == ZIO_PRIORITY_ASYNC_READ)</span>
<span class="lineNum">    6125 </span>                :<span class="lineCov">     187659 :                         arc_hdr_set_flags(hdr, ARC_FLAG_PRIO_ASYNC_READ);</span>
<span class="lineNum">    6126 </span>                :            :                 else
<span class="lineNum">    6127 </span>                :<span class="lineCov">    1055699 :                         arc_hdr_clear_flags(hdr, ARC_FLAG_PRIO_ASYNC_READ);</span>
<span class="lineNum">    6128 </span>                :            : 
<span class="lineNum">    6129 </span>        [<span class="branchCov" title="Branch 0 was taken 243878 times"> + </span><span class="branchCov" title="Branch 1 was taken 999624 times"> + </span>]:<span class="lineCov">    1243502 :                 if (hash_lock != NULL)</span>
<span class="lineNum">    6130 </span>                :<span class="lineCov">     243878 :                         mutex_exit(hash_lock);</span>
<span class="lineNum">    6131 </span>                :            : 
<span class="lineNum">    6132 </span>                :            :                 /*
<span class="lineNum">    6133 </span>                :            :                  * At this point, we have a level 1 cache miss.  Try again in
<span class="lineNum">    6134 </span>                :            :                  * L2ARC if possible.
<span class="lineNum">    6135 </span>                :            :                  */
<span class="lineNum">    6136 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1243504 times"> + </span>]:<span class="lineCov">    1243504 :                 ASSERT3U(HDR_GET_LSIZE(hdr), ==, lsize);</span>
<span class="lineNum">    6137 </span>                :            : 
<span class="lineNum">    6138 </span>                :            :                 DTRACE_PROBE4(arc__miss, arc_buf_hdr_t *, hdr, blkptr_t *, bp,
<span class="lineNum">    6139 </span>                :            :                     uint64_t, lsize, zbookmark_phys_t *, zb);
<span class="lineNum">    6140 </span>                :<span class="lineCov">    1243504 :                 ARCSTAT_BUMP(arcstat_misses);</span>
<span class="lineNum">    6141 </span>[<span class="branchCov" title="Branch 0 was taken 1059090 times"> + </span><span class="branchCov" title="Branch 1 was taken 184526 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 3459 times"> + </span><span class="branchCov" title="Branch 3 was taken 1055631 times"> + </span>]:<span class="lineCov">    1243616 :                 ARCSTAT_CONDSTAT(!HDR_PREFETCH(hdr),</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 6 was taken 35123 times"> + </span><span class="branchCov" title="Branch 7 was taken 149403 times"> + </span>]
<span class="lineNum">    6142 </span>                :            :                     demand, prefetch, !HDR_ISTYPE_METADATA(hdr),
<span class="lineNum">    6143 </span>                :            :                     data, metadata, misses);
<span class="lineNum">    6144 </span>                :            : 
<span class="lineNum">    6145 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1243620 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1243620 :                 if (vd != NULL &amp;&amp; l2arc_ndev != 0 &amp;&amp; !(l2arc_norw &amp;&amp; devw)) {</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">    6146 </span>                :            :                         /*
<span class="lineNum">    6147 </span>                :            :                          * Read from the L2ARC if the following are true:
<span class="lineNum">    6148 </span>                :            :                          * 1. The L2ARC vdev was previously cached.
<span class="lineNum">    6149 </span>                :            :                          * 2. This buffer still has L2ARC metadata.
<span class="lineNum">    6150 </span>                :            :                          * 3. This buffer isn't currently writing to the L2ARC.
<span class="lineNum">    6151 </span>                :            :                          * 4. The L2ARC entry wasn't evicted, which may
<span class="lineNum">    6152 </span>                :            :                          *    also have invalidated the vdev.
<span class="lineNum">    6153 </span>                :            :                          * 5. This isn't prefetch and l2arc_noprefetch is set.
<span class="lineNum">    6154 </span>                :            :                          */
<span class="lineNum">    6155 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (HDR_HAS_L2HDR(hdr) &amp;&amp;</span>
<span class="lineNum">    6156 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                             !HDR_L2_WRITING(hdr) &amp;&amp; !HDR_L2_EVICTED(hdr) &amp;&amp;</span>
<span class="lineNum">    6157 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                             !(l2arc_noprefetch &amp;&amp; HDR_PREFETCH(hdr))) {</span>
<span class="lineNum">    6158 </span>                :            :                                 l2arc_read_callback_t *cb;
<span class="lineNum">    6159 </span>                :            :                                 abd_t *abd;
<span class="lineNum">    6160 </span>                :            :                                 uint64_t asize;
<span class="lineNum">    6161 </span>                :            : 
<span class="lineNum">    6162 </span>                :            :                                 DTRACE_PROBE1(l2arc__hit, arc_buf_hdr_t *, hdr);
<span class="lineNum">    6163 </span>                :<span class="lineNoCov">          0 :                                 ARCSTAT_BUMP(arcstat_l2_hits);</span>
<span class="lineNum">    6164 </span>                :<span class="lineNoCov">          0 :                                 atomic_inc_32(&amp;hdr-&gt;b_l2hdr.b_hits);</span>
<span class="lineNum">    6165 </span>                :            : 
<span class="lineNum">    6166 </span>                :<span class="lineNoCov">          0 :                                 cb = kmem_zalloc(sizeof (l2arc_read_callback_t),</span>
<span class="lineNum">    6167 </span>                :            :                                     KM_SLEEP);
<span class="lineNum">    6168 </span>                :<span class="lineNoCov">          0 :                                 cb-&gt;l2rcb_hdr = hdr;</span>
<span class="lineNum">    6169 </span>                :<span class="lineNoCov">          0 :                                 cb-&gt;l2rcb_bp = *bp;</span>
<span class="lineNum">    6170 </span>                :<span class="lineNoCov">          0 :                                 cb-&gt;l2rcb_zb = *zb;</span>
<span class="lineNum">    6171 </span>                :<span class="lineNoCov">          0 :                                 cb-&gt;l2rcb_flags = zio_flags;</span>
<span class="lineNum">    6172 </span>                :            : 
<span class="lineNum">    6173 </span>                :<span class="lineNoCov">          0 :                                 asize = vdev_psize_to_asize(vd, size);</span>
<span class="lineNum">    6174 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (asize != size) {</span>
<span class="lineNum">    6175 </span>                :<span class="lineNoCov">          0 :                                         abd = abd_alloc_for_io(asize,</span>
<span class="lineNum">    6176 </span>                :<span class="lineNoCov">          0 :                                             HDR_ISTYPE_METADATA(hdr));</span>
<span class="lineNum">    6177 </span>                :<span class="lineNoCov">          0 :                                         cb-&gt;l2rcb_abd = abd;</span>
<span class="lineNum">    6178 </span>                :            :                                 } else {
<span class="lineNum">    6179 </span>                :            :                                         abd = hdr_abd;
<span class="lineNum">    6180 </span>                :            :                                 }
<span class="lineNum">    6181 </span>                :            : 
<span class="lineNum">    6182 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 ASSERT(addr &gt;= VDEV_LABEL_START_SIZE &amp;&amp;</span>
<span class="lineNum">    6183 </span>                :            :                                     addr + asize &lt;= vd-&gt;vdev_psize -
<span class="lineNum">    6184 </span>                :            :                                     VDEV_LABEL_END_SIZE);
<span class="lineNum">    6185 </span>                :            : 
<span class="lineNum">    6186 </span>                :            :                                 /*
<span class="lineNum">    6187 </span>                :            :                                  * l2arc read.  The SCL_L2ARC lock will be
<span class="lineNum">    6188 </span>                :            :                                  * released by l2arc_read_done().
<span class="lineNum">    6189 </span>                :            :                                  * Issue a null zio if the underlying buffer
<span class="lineNum">    6190 </span>                :            :                                  * was squashed to zero size by compression.
<span class="lineNum">    6191 </span>                :            :                                  */
<span class="lineNum">    6192 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 ASSERT3U(arc_hdr_get_compress(hdr), !=,</span>
<span class="lineNum">    6193 </span>                :            :                                     ZIO_COMPRESS_EMPTY);
<span class="lineNum">    6194 </span>                :<span class="lineNoCov">          0 :                                 rzio = zio_read_phys(pio, vd, addr,</span>
<span class="lineNum">    6195 </span>                :            :                                     asize, abd,
<span class="lineNum">    6196 </span>                :            :                                     ZIO_CHECKSUM_OFF,
<span class="lineNum">    6197 </span>                :            :                                     l2arc_read_done, cb, priority,
<span class="lineNum">    6198 </span>                :            :                                     zio_flags | ZIO_FLAG_DONT_CACHE |
<span class="lineNum">    6199 </span>                :            :                                     ZIO_FLAG_CANFAIL |
<span class="lineNum">    6200 </span>                :<span class="lineNoCov">          0 :                                     ZIO_FLAG_DONT_PROPAGATE |</span>
<span class="lineNum">    6201 </span>                :            :                                     ZIO_FLAG_DONT_RETRY, B_FALSE);
<span class="lineNum">    6202 </span>                :            : 
<span class="lineNum">    6203 </span>                :            :                                 DTRACE_PROBE2(l2arc__read, vdev_t *, vd,
<span class="lineNum">    6204 </span>                :            :                                     zio_t *, rzio);
<span class="lineNum">    6205 </span>                :<span class="lineNoCov">          0 :                                 ARCSTAT_INCR(arcstat_l2_read_bytes,</span>
<span class="lineNum">    6206 </span>                :            :                                     HDR_GET_PSIZE(hdr));
<span class="lineNum">    6207 </span>                :            : 
<span class="lineNum">    6208 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (*arc_flags &amp; ARC_FLAG_NOWAIT) {</span>
<span class="lineNum">    6209 </span>                :<span class="lineNoCov">          0 :                                         zio_nowait(rzio);</span>
<span class="lineNum">    6210 </span>                :<span class="lineNoCov">          0 :                                         goto out;</span>
<span class="lineNum">    6211 </span>                :            :                                 }
<span class="lineNum">    6212 </span>                :            : 
<span class="lineNum">    6213 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 ASSERT(*arc_flags &amp; ARC_FLAG_WAIT);</span>
<span class="lineNum">    6214 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (zio_wait(rzio) == 0)</span>
<span class="lineNum">    6215 </span>                :            :                                         goto out;
<span class="lineNum">    6216 </span>                :            : 
<span class="lineNum">    6217 </span>                :            :                                 /* l2arc read error; goto zio_read() */
<span class="lineNum">    6218 </span>                :            :                         } else {
<span class="lineNum">    6219 </span>                :            :                                 DTRACE_PROBE1(l2arc__miss,
<span class="lineNum">    6220 </span>                :            :                                     arc_buf_hdr_t *, hdr);
<span class="lineNum">    6221 </span>                :<span class="lineNoCov">          0 :                                 ARCSTAT_BUMP(arcstat_l2_misses);</span>
<span class="lineNum">    6222 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (HDR_L2_WRITING(hdr))</span>
<span class="lineNum">    6223 </span>                :<span class="lineNoCov">          0 :                                         ARCSTAT_BUMP(arcstat_l2_rw_clash);</span>
<span class="lineNum">    6224 </span>                :<span class="lineNoCov">          0 :                                 spa_config_exit(spa, SCL_L2ARC, vd);</span>
<span class="lineNum">    6225 </span>                :            :                         }
<span class="lineNum">    6226 </span>                :            :                 } else {
<span class="lineNum">    6227 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1243620 times"> + </span>]:<span class="lineCov">    1243620 :                         if (vd != NULL)</span>
<span class="lineNum">    6228 </span>                :<span class="lineNoCov">          0 :                                 spa_config_exit(spa, SCL_L2ARC, vd);</span>
<span class="lineNum">    6229 </span>        [<span class="branchCov" title="Branch 0 was taken 284048 times"> + </span><span class="branchCov" title="Branch 1 was taken 959572 times"> + </span>]:<span class="lineCov">    1243620 :                         if (l2arc_ndev != 0) {</span>
<span class="lineNum">    6230 </span>                :            :                                 DTRACE_PROBE1(l2arc__miss,
<span class="lineNum">    6231 </span>                :            :                                     arc_buf_hdr_t *, hdr);
<span class="lineNum">    6232 </span>                :<span class="lineCov">     284048 :                                 ARCSTAT_BUMP(arcstat_l2_misses);</span>
<span class="lineNum">    6233 </span>                :            :                         }
<span class="lineNum">    6234 </span>                :            :                 }
<span class="lineNum">    6235 </span>                :            : 
<span class="lineNum">    6236 </span>                :<span class="lineCov">    1243625 :                 rzio = zio_read(pio, spa, bp, hdr_abd, size,</span>
<span class="lineNum">    6237 </span>                :            :                     arc_read_done, hdr, priority, zio_flags, zb);
<span class="lineNum">    6238 </span>                :            : 
<span class="lineNum">    6239 </span>        [<span class="branchCov" title="Branch 0 was taken 11521 times"> + </span><span class="branchCov" title="Branch 1 was taken 1231302 times"> + </span>]:<span class="lineCov">    1242823 :                 if (*arc_flags &amp; ARC_FLAG_WAIT) {</span>
<span class="lineNum">    6240 </span>                :<span class="lineCov">      11521 :                         rc = zio_wait(rzio);</span>
<span class="lineNum">    6241 </span>                :<span class="lineCov">      11521 :                         goto out;</span>
<span class="lineNum">    6242 </span>                :            :                 }
<span class="lineNum">    6243 </span>                :            : 
<span class="lineNum">    6244 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1231302 times"> + </span>]:<span class="lineCov">    1231302 :                 ASSERT(*arc_flags &amp; ARC_FLAG_NOWAIT);</span>
<span class="lineNum">    6245 </span>                :<span class="lineCov">    1231302 :                 zio_nowait(rzio);</span>
<span class="lineNum">    6246 </span>                :            :         }
<span class="lineNum">    6247 </span>                :            : 
<span class="lineNum">    6248 </span>                :            : out:
<span class="lineNum">    6249 </span>                :<span class="lineCov">    1870051 :         spa_read_history_add(spa, zb, *arc_flags);</span>
<span class="lineNum">    6250 </span>                :<span class="lineCov">    1870030 :         return (rc);</span>
<span class="lineNum">    6251 </span>                :            : }
<a name="6252"><span class="lineNum">    6252 </span>                :            : </a>
<span class="lineNum">    6253 </span>                :            : arc_prune_t *
<span class="lineNum">    6254 </span>                :<span class="lineNoCov">          0 : arc_add_prune_callback(arc_prune_func_t *func, void *private)</span>
<span class="lineNum">    6255 </span>                :            : {
<span class="lineNum">    6256 </span>                :            :         arc_prune_t *p;
<span class="lineNum">    6257 </span>                :            : 
<span class="lineNum">    6258 </span>                :<span class="lineNoCov">          0 :         p = kmem_alloc(sizeof (*p), KM_SLEEP);</span>
<span class="lineNum">    6259 </span>                :<span class="lineNoCov">          0 :         p-&gt;p_pfunc = func;</span>
<span class="lineNum">    6260 </span>                :<span class="lineNoCov">          0 :         p-&gt;p_private = private;</span>
<span class="lineNum">    6261 </span>                :<span class="lineNoCov">          0 :         list_link_init(&amp;p-&gt;p_node);</span>
<span class="lineNum">    6262 </span>                :<span class="lineNoCov">          0 :         refcount_create(&amp;p-&gt;p_refcnt);</span>
<span class="lineNum">    6263 </span>                :            : 
<span class="lineNum">    6264 </span>                :<span class="lineNoCov">          0 :         mutex_enter(&amp;arc_prune_mtx);</span>
<span class="lineNum">    6265 </span>                :<span class="lineNoCov">          0 :         refcount_add(&amp;p-&gt;p_refcnt, &amp;arc_prune_list);</span>
<span class="lineNum">    6266 </span>                :<span class="lineNoCov">          0 :         list_insert_head(&amp;arc_prune_list, p);</span>
<span class="lineNum">    6267 </span>                :<span class="lineNoCov">          0 :         mutex_exit(&amp;arc_prune_mtx);</span>
<span class="lineNum">    6268 </span>                :            : 
<span class="lineNum">    6269 </span>                :<span class="lineNoCov">          0 :         return (p);</span>
<span class="lineNum">    6270 </span>                :            : }
<a name="6271"><span class="lineNum">    6271 </span>                :            : </a>
<span class="lineNum">    6272 </span>                :            : void
<span class="lineNum">    6273 </span>                :<span class="lineNoCov">          0 : arc_remove_prune_callback(arc_prune_t *p)</span>
<span class="lineNum">    6274 </span>                :            : {
<span class="lineNum">    6275 </span>                :<span class="lineNoCov">          0 :         boolean_t wait = B_FALSE;</span>
<span class="lineNum">    6276 </span>                :<span class="lineNoCov">          0 :         mutex_enter(&amp;arc_prune_mtx);</span>
<span class="lineNum">    6277 </span>                :<span class="lineNoCov">          0 :         list_remove(&amp;arc_prune_list, p);</span>
<span class="lineNum">    6278 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (refcount_remove(&amp;p-&gt;p_refcnt, &amp;arc_prune_list) &gt; 0)</span>
<span class="lineNum">    6279 </span>                :<span class="lineNoCov">          0 :                 wait = B_TRUE;</span>
<span class="lineNum">    6280 </span>                :<span class="lineNoCov">          0 :         mutex_exit(&amp;arc_prune_mtx);</span>
<span class="lineNum">    6281 </span>                :            : 
<span class="lineNum">    6282 </span>                :            :         /* wait for arc_prune_task to finish */
<span class="lineNum">    6283 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (wait)</span>
<span class="lineNum">    6284 </span>                :<span class="lineNoCov">          0 :                 taskq_wait_outstanding(arc_prune_taskq, 0);</span>
<span class="lineNum">    6285 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT0(refcount_count(&amp;p-&gt;p_refcnt));</span>
<span class="lineNum">    6286 </span>                :<span class="lineNoCov">          0 :         refcount_destroy(&amp;p-&gt;p_refcnt);</span>
<span class="lineNum">    6287 </span>                :<span class="lineNoCov">          0 :         kmem_free(p, sizeof (*p));</span>
<span class="lineNum">    6288 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    6289 </span>                :            : 
<span class="lineNum">    6290 </span>                :            : /*
<span class="lineNum">    6291 </span>                :            :  * Notify the arc that a block was freed, and thus will never be used again.
<a name="6292"><span class="lineNum">    6292 </span>                :            :  */</a>
<span class="lineNum">    6293 </span>                :            : void
<span class="lineNum">    6294 </span>                :<span class="lineCov">     428716 : arc_freed(spa_t *spa, const blkptr_t *bp)</span>
<span class="lineNum">    6295 </span>                :            : {
<span class="lineNum">    6296 </span>                :            :         arc_buf_hdr_t *hdr;
<span class="lineNum">    6297 </span>                :            :         kmutex_t *hash_lock;
<span class="lineNum">    6298 </span>                :<span class="lineCov">     428716 :         uint64_t guid = spa_load_guid(spa);</span>
<span class="lineNum">    6299 </span>                :            : 
<span class="lineNum">    6300 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 428714 times"> + </span>]:<span class="lineCov">     428714 :         ASSERT(!BP_IS_EMBEDDED(bp));</span>
<span class="lineNum">    6301 </span>                :            : 
<span class="lineNum">    6302 </span>                :<span class="lineCov">     428714 :         hdr = buf_hash_find(guid, bp, &amp;hash_lock);</span>
<span class="lineNum">    6303 </span>        [<span class="branchCov" title="Branch 0 was taken 17960 times"> + </span><span class="branchCov" title="Branch 1 was taken 410755 times"> + </span>]:<span class="lineCov">     428715 :         if (hdr == NULL)</span>
<span class="lineNum">    6304 </span>                :<span class="lineCov">     410755 :                 return;</span>
<span class="lineNum">    6305 </span>                :            : 
<span class="lineNum">    6306 </span>                :            :         /*
<span class="lineNum">    6307 </span>                :            :          * We might be trying to free a block that is still doing I/O
<span class="lineNum">    6308 </span>                :            :          * (i.e. prefetch) or has a reference (i.e. a dedup-ed,
<span class="lineNum">    6309 </span>                :            :          * dmu_sync-ed block). If this block is being prefetched, then it
<span class="lineNum">    6310 </span>                :            :          * would still have the ARC_FLAG_IO_IN_PROGRESS flag set on the hdr
<span class="lineNum">    6311 </span>                :            :          * until the I/O completes. A block may also have a reference if it is
<span class="lineNum">    6312 </span>                :            :          * part of a dedup-ed, dmu_synced write. The dmu_sync() function would
<span class="lineNum">    6313 </span>                :            :          * have written the new block to its final resting place on disk but
<span class="lineNum">    6314 </span>                :            :          * without the dedup flag set. This would have left the hdr in the MRU
<span class="lineNum">    6315 </span>                :            :          * state and discoverable. When the txg finally syncs it detects that
<span class="lineNum">    6316 </span>                :            :          * the block was overridden in open context and issues an override I/O.
<span class="lineNum">    6317 </span>                :            :          * Since this is a dedup block, the override I/O will determine if the
<span class="lineNum">    6318 </span>                :            :          * block is already in the DDT. If so, then it will replace the io_bp
<span class="lineNum">    6319 </span>                :            :          * with the bp from the DDT and allow the I/O to finish. When the I/O
<span class="lineNum">    6320 </span>                :            :          * reaches the done callback, dbuf_write_override_done, it will
<span class="lineNum">    6321 </span>                :            :          * check to see if the io_bp and io_bp_override are identical.
<span class="lineNum">    6322 </span>                :            :          * If they are not, then it indicates that the bp was replaced with
<span class="lineNum">    6323 </span>                :            :          * the bp in the DDT and the override bp is freed. This allows
<span class="lineNum">    6324 </span>                :            :          * us to arrive here with a reference on a block that is being
<span class="lineNum">    6325 </span>                :            :          * freed. So if we have an I/O in progress, or a reference to
<span class="lineNum">    6326 </span>                :            :          * this hdr, then we don't destroy the hdr.
<span class="lineNum">    6327 </span>                :            :          */
<span class="lineNum">    6328 </span>        [<span class="branchCov" title="Branch 0 was taken 17960 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      35920 :         if (!HDR_HAS_L1HDR(hdr) || (!HDR_IO_IN_PROGRESS(hdr) &amp;&amp;</span>
<span class="lineNum">         </span>  [<span class="branchCov" title="Branch 2 was taken 17960 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 17942 times"> + </span><span class="branchCov" title="Branch 5 was taken 18 times"> + </span>]
<span class="lineNum">    6329 </span>                :<span class="lineCov">      17960 :             refcount_is_zero(&amp;hdr-&gt;b_l1hdr.b_refcnt))) {</span>
<span class="lineNum">    6330 </span>                :<span class="lineCov">      17942 :                 arc_change_state(arc_anon, hdr, hash_lock);</span>
<span class="lineNum">    6331 </span>                :<span class="lineCov">      17942 :                 arc_hdr_destroy(hdr);</span>
<span class="lineNum">    6332 </span>                :<span class="lineCov">      17942 :                 mutex_exit(hash_lock);</span>
<span class="lineNum">    6333 </span>                :            :         } else {
<span class="lineNum">    6334 </span>                :<span class="lineCov">      17960 :                 mutex_exit(hash_lock);</span>
<span class="lineNum">    6335 </span>                :            :         }
<span class="lineNum">    6336 </span>                :            : 
<span class="lineNum">    6337 </span>                :            : }
<span class="lineNum">    6338 </span>                :            : 
<span class="lineNum">    6339 </span>                :            : /*
<span class="lineNum">    6340 </span>                :            :  * Release this buffer from the cache, making it an anonymous buffer.  This
<span class="lineNum">    6341 </span>                :            :  * must be done after a read and prior to modifying the buffer contents.
<span class="lineNum">    6342 </span>                :            :  * If the buffer has more than one reference, we must make
<span class="lineNum">    6343 </span>                :            :  * a new hdr for the buffer.
<a name="6344"><span class="lineNum">    6344 </span>                :            :  */</a>
<span class="lineNum">    6345 </span>                :            : void
<span class="lineNum">    6346 </span>                :<span class="lineCov">     708100 : arc_release(arc_buf_t *buf, void *tag)</span>
<span class="lineNum">    6347 </span>                :            : {
<span class="lineNum">    6348 </span>                :            :         kmutex_t *hash_lock;
<span class="lineNum">    6349 </span>                :            :         arc_state_t *state;
<span class="lineNum">    6350 </span>                :<span class="lineCov">     708100 :         arc_buf_hdr_t *hdr = buf-&gt;b_hdr;</span>
<span class="lineNum">    6351 </span>                :            : 
<span class="lineNum">    6352 </span>                :            :         /*
<span class="lineNum">    6353 </span>                :            :          * It would be nice to assert that if its DMU metadata (level &gt;
<span class="lineNum">    6354 </span>                :            :          * 0 || it's the dnode file), then it must be syncing context.
<span class="lineNum">    6355 </span>                :            :          * But we don't know that information at this level.
<span class="lineNum">    6356 </span>                :            :          */
<span class="lineNum">    6357 </span>                :            : 
<span class="lineNum">    6358 </span>                :<span class="lineCov">     708100 :         mutex_enter(&amp;buf-&gt;b_evict_lock);</span>
<span class="lineNum">    6359 </span>                :            : 
<span class="lineNum">    6360 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 708118 times"> + </span>]:<span class="lineCov">     708118 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    6361 </span>                :            : 
<span class="lineNum">    6362 </span>                :            :         /*
<span class="lineNum">    6363 </span>                :            :          * We don't grab the hash lock prior to this check, because if
<span class="lineNum">    6364 </span>                :            :          * the buffer's header is in the arc_anon state, it won't be
<span class="lineNum">    6365 </span>                :            :          * linked into the hash table.
<span class="lineNum">    6366 </span>                :            :          */
<span class="lineNum">    6367 </span>        [<span class="branchCov" title="Branch 0 was taken 115071 times"> + </span><span class="branchCov" title="Branch 1 was taken 593047 times"> + </span>]:<span class="lineCov">     708118 :         if (hdr-&gt;b_l1hdr.b_state == arc_anon) {</span>
<span class="lineNum">    6368 </span>                :<span class="lineCov">     115071 :                 mutex_exit(&amp;buf-&gt;b_evict_lock);</span>
<span class="lineNum">    6369 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 115074 times"> + </span>]:<span class="lineCov">     115074 :                 ASSERT(!HDR_IO_IN_PROGRESS(hdr));</span>
<span class="lineNum">    6370 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 115074 times"> + </span>]:<span class="lineCov">     115074 :                 ASSERT(!HDR_IN_HASH_TABLE(hdr));</span>
<span class="lineNum">    6371 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 115074 times"> + </span>]:<span class="lineCov">     115074 :                 ASSERT(!HDR_HAS_L2HDR(hdr));</span>
<span class="lineNum">    6372 </span>      [<span class="branchCov" title="Branch 0 was taken 115075 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 115078 times"> + </span>]:<span class="lineCov">     115074 :                 ASSERT(HDR_EMPTY(hdr));</span>
<span class="lineNum">    6373 </span>                :            : 
<span class="lineNum">    6374 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 115078 times"> + </span>]:<span class="lineCov">     115078 :                 ASSERT3U(hdr-&gt;b_l1hdr.b_bufcnt, ==, 1);</span>
<span class="lineNum">    6375 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 115077 times"> + </span>]:<span class="lineCov">     115078 :                 ASSERT3S(refcount_count(&amp;hdr-&gt;b_l1hdr.b_refcnt), ==, 1);</span>
<span class="lineNum">    6376 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 115073 times"> + </span>]:<span class="lineCov">     115077 :                 ASSERT(!list_link_active(&amp;hdr-&gt;b_l1hdr.b_arc_node));</span>
<span class="lineNum">    6377 </span>                :            : 
<span class="lineNum">    6378 </span>                :<span class="lineCov">     115073 :                 hdr-&gt;b_l1hdr.b_arc_access = 0;</span>
<span class="lineNum">    6379 </span>                :            : 
<span class="lineNum">    6380 </span>                :            :                 /*
<span class="lineNum">    6381 </span>                :            :                  * If the buf is being overridden then it may already
<span class="lineNum">    6382 </span>                :            :                  * have a hdr that is not empty.
<span class="lineNum">    6383 </span>                :            :                  */
<span class="lineNum">    6384 </span>                :<span class="lineCov">     115073 :                 buf_discard_identity(hdr);</span>
<span class="lineNum">    6385 </span>                :<span class="lineCov">     115076 :                 arc_buf_thaw(buf);</span>
<span class="lineNum">    6386 </span>                :            : 
<span class="lineNum">    6387 </span>                :<span class="lineCov">     115075 :                 return;</span>
<span class="lineNum">    6388 </span>                :            :         }
<span class="lineNum">    6389 </span>                :            : 
<span class="lineNum">    6390 </span>                :<span class="lineCov">     593047 :         hash_lock = HDR_LOCK(hdr);</span>
<span class="lineNum">    6391 </span>                :<span class="lineCov">     593048 :         mutex_enter(hash_lock);</span>
<span class="lineNum">    6392 </span>                :            : 
<span class="lineNum">    6393 </span>                :            :         /*
<span class="lineNum">    6394 </span>                :            :          * This assignment is only valid as long as the hash_lock is
<span class="lineNum">    6395 </span>                :            :          * held, we must be careful not to reference state or the
<span class="lineNum">    6396 </span>                :            :          * b_state field after dropping the lock.
<span class="lineNum">    6397 </span>                :            :          */
<span class="lineNum">    6398 </span>                :<span class="lineCov">     593050 :         state = hdr-&gt;b_l1hdr.b_state;</span>
<span class="lineNum">    6399 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 593045 times"> + </span>]:<span class="lineCov">     593050 :         ASSERT3P(hash_lock, ==, HDR_LOCK(hdr));</span>
<span class="lineNum">    6400 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 593045 times"> + </span>]:<span class="lineCov">     593045 :         ASSERT3P(state, !=, arc_anon);</span>
<span class="lineNum">    6401 </span>                :            : 
<span class="lineNum">    6402 </span>                :            :         /* this buffer is not on any list */
<span class="lineNum">    6403 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 593046 times"> + </span>]:<span class="lineCov">     593045 :         ASSERT3S(refcount_count(&amp;hdr-&gt;b_l1hdr.b_refcnt), &gt;, 0);</span>
<span class="lineNum">    6404 </span>                :            : 
<span class="lineNum">    6405 </span>        [<span class="branchCov" title="Branch 0 was taken 37 times"> + </span><span class="branchCov" title="Branch 1 was taken 593009 times"> + </span>]:<span class="lineCov">     593046 :         if (HDR_HAS_L2HDR(hdr)) {</span>
<span class="lineNum">    6406 </span>                :<span class="lineCov">         37 :                 mutex_enter(&amp;hdr-&gt;b_l2hdr.b_dev-&gt;l2ad_mtx);</span>
<span class="lineNum">    6407 </span>                :            : 
<span class="lineNum">    6408 </span>                :            :                 /*
<span class="lineNum">    6409 </span>                :            :                  * We have to recheck this conditional again now that
<span class="lineNum">    6410 </span>                :            :                  * we're holding the l2ad_mtx to prevent a race with
<span class="lineNum">    6411 </span>                :            :                  * another thread which might be concurrently calling
<span class="lineNum">    6412 </span>                :            :                  * l2arc_evict(). In that case, l2arc_evict() might have
<span class="lineNum">    6413 </span>                :            :                  * destroyed the header's L2 portion as we were waiting
<span class="lineNum">    6414 </span>                :            :                  * to acquire the l2ad_mtx.
<span class="lineNum">    6415 </span>                :            :                  */
<span class="lineNum">    6416 </span>        [<span class="branchCov" title="Branch 0 was taken 37 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         37 :                 if (HDR_HAS_L2HDR(hdr))</span>
<span class="lineNum">    6417 </span>                :<span class="lineCov">         37 :                         arc_hdr_l2hdr_destroy(hdr);</span>
<span class="lineNum">    6418 </span>                :            : 
<span class="lineNum">    6419 </span>                :<span class="lineCov">         37 :                 mutex_exit(&amp;hdr-&gt;b_l2hdr.b_dev-&gt;l2ad_mtx);</span>
<span class="lineNum">    6420 </span>                :            :         }
<span class="lineNum">    6421 </span>                :            : 
<span class="lineNum">    6422 </span>                :            :         /*
<span class="lineNum">    6423 </span>                :            :          * Do we have more than one buf?
<span class="lineNum">    6424 </span>                :            :          */
<span class="lineNum">    6425 </span>        [<span class="branchCov" title="Branch 0 was taken 38 times"> + </span><span class="branchCov" title="Branch 1 was taken 593008 times"> + </span>]:<span class="lineCov">     593046 :         if (hdr-&gt;b_l1hdr.b_bufcnt &gt; 1) {</span>
<span class="lineNum">    6426 </span>                :            :                 arc_buf_hdr_t *nhdr;
<span class="lineNum">    6427 </span>                :<span class="lineCov">         38 :                 uint64_t spa = hdr-&gt;b_spa;</span>
<span class="lineNum">    6428 </span>                :<span class="lineCov">         38 :                 uint64_t psize = HDR_GET_PSIZE(hdr);</span>
<span class="lineNum">    6429 </span>                :<span class="lineCov">         38 :                 uint64_t lsize = HDR_GET_LSIZE(hdr);</span>
<span class="lineNum">    6430 </span>                :<span class="lineCov">         38 :                 boolean_t protected = HDR_PROTECTED(hdr);</span>
<span class="lineNum">    6431 </span>                :<span class="lineCov">         38 :                 enum zio_compress compress = arc_hdr_get_compress(hdr);</span>
<span class="lineNum">    6432 </span>                :<span class="lineCov">         38 :                 arc_buf_contents_t type = arc_buf_type(hdr);</span>
<span class="lineNum">    6433 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 38 times"> + </span>]:<span class="lineCov">         38 :                 VERIFY3U(hdr-&gt;b_type, ==, type);</span>
<span class="lineNum">    6434 </span>                :            : 
<span class="lineNum">    6435 </span>[<span class="branchCov" title="Branch 0 was taken 36 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 36 times"> + </span>]:<span class="lineCov">         38 :                 ASSERT(hdr-&gt;b_l1hdr.b_buf != buf || buf-&gt;b_next != NULL);</span>
<span class="lineNum">    6436 </span>                :<span class="lineCov">         38 :                 (void) remove_reference(hdr, hash_lock, tag);</span>
<span class="lineNum">    6437 </span>                :            : 
<span class="lineNum">    6438 </span>[<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 36 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span>]:<span class="lineCov">         38 :                 if (arc_buf_is_shared(buf) &amp;&amp; !ARC_BUF_COMPRESSED(buf)) {</span>
<span class="lineNum">    6439 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :                         ASSERT3P(hdr-&gt;b_l1hdr.b_buf, !=, buf);</span>
<span class="lineNum">    6440 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :                         ASSERT(ARC_BUF_LAST(buf));</span>
<span class="lineNum">    6441 </span>                :            :                 }
<span class="lineNum">    6442 </span>                :            : 
<span class="lineNum">    6443 </span>                :            :                 /*
<span class="lineNum">    6444 </span>                :            :                  * Pull the data off of this hdr and attach it to
<span class="lineNum">    6445 </span>                :            :                  * a new anonymous hdr. Also find the last buffer
<span class="lineNum">    6446 </span>                :            :                  * in the hdr's buffer list.
<span class="lineNum">    6447 </span>                :            :                  */
<span class="lineNum">    6448 </span>                :<span class="lineCov">         38 :                 arc_buf_t *lastbuf = arc_buf_remove(hdr, buf);</span>
<span class="lineNum">    6449 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 38 times"> + </span>]:<span class="lineCov">         38 :                 ASSERT3P(lastbuf, !=, NULL);</span>
<span class="lineNum">    6450 </span>                :            : 
<span class="lineNum">    6451 </span>                :            :                 /*
<span class="lineNum">    6452 </span>                :            :                  * If the current arc_buf_t and the hdr are sharing their data
<span class="lineNum">    6453 </span>                :            :                  * buffer, then we must stop sharing that block.
<span class="lineNum">    6454 </span>                :            :                  */
<span class="lineNum">    6455 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 36 times"> + </span>]:<span class="lineCov">         38 :                 if (arc_buf_is_shared(buf)) {</span>
<span class="lineNum">    6456 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :                         ASSERT3P(hdr-&gt;b_l1hdr.b_buf, !=, buf);</span>
<span class="lineNum">    6457 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span>]:<span class="lineCov">          2 :                         VERIFY(!arc_buf_is_shared(lastbuf));</span>
<span class="lineNum">    6458 </span>                :            : 
<span class="lineNum">    6459 </span>                :            :                         /*
<span class="lineNum">    6460 </span>                :            :                          * First, sever the block sharing relationship between
<span class="lineNum">    6461 </span>                :            :                          * buf and the arc_buf_hdr_t.
<span class="lineNum">    6462 </span>                :            :                          */
<span class="lineNum">    6463 </span>                :<span class="lineCov">          2 :                         arc_unshare_buf(hdr, buf);</span>
<span class="lineNum">    6464 </span>                :            : 
<span class="lineNum">    6465 </span>                :            :                         /*
<span class="lineNum">    6466 </span>                :            :                          * Now we need to recreate the hdr's b_pabd. Since we
<span class="lineNum">    6467 </span>                :            :                          * have lastbuf handy, we try to share with it, but if
<span class="lineNum">    6468 </span>                :            :                          * we can't then we allocate a new b_pabd and copy the
<span class="lineNum">    6469 </span>                :            :                          * data from buf into it.
<span class="lineNum">    6470 </span>                :            :                          */
<span class="lineNum">    6471 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          2 :                         if (arc_can_share(hdr, lastbuf)) {</span>
<span class="lineNum">    6472 </span>                :<span class="lineCov">          2 :                                 arc_share_buf(hdr, lastbuf);</span>
<span class="lineNum">    6473 </span>                :            :                         } else {
<span class="lineNum">    6474 </span>                :<span class="lineNoCov">          0 :                                 arc_hdr_alloc_abd(hdr, B_FALSE);</span>
<span class="lineNum">    6475 </span>                :<span class="lineNoCov">          0 :                                 abd_copy_from_buf(hdr-&gt;b_l1hdr.b_pabd,</span>
<span class="lineNum">    6476 </span>                :<span class="lineNoCov">          0 :                                     buf-&gt;b_data, psize);</span>
<span class="lineNum">    6477 </span>                :            :                         }
<span class="lineNum">    6478 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">          2 :                         VERIFY3P(lastbuf-&gt;b_data, !=, NULL);</span>
<span class="lineNum">    6479 </span>        [<span class="branchCov" title="Branch 0 was taken 19 times"> + </span><span class="branchCov" title="Branch 1 was taken 17 times"> + </span>]:<span class="lineCov">         36 :                 } else if (HDR_SHARED_DATA(hdr)) {</span>
<span class="lineNum">    6480 </span>                :            :                         /*
<span class="lineNum">    6481 </span>                :            :                          * Uncompressed shared buffers are always at the end
<span class="lineNum">    6482 </span>                :            :                          * of the list. Compressed buffers don't have the
<span class="lineNum">    6483 </span>                :            :                          * same requirements. This makes it hard to
<span class="lineNum">    6484 </span>                :            :                          * simply assert that the lastbuf is shared so
<span class="lineNum">    6485 </span>                :            :                          * we rely on the hdr's compression flags to determine
<span class="lineNum">    6486 </span>                :            :                          * if we have a compressed, shared buffer.
<span class="lineNum">    6487 </span>                :            :                          */
<span class="lineNum">    6488 </span>[<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 19 times"> + </span>][<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]:<span class="lineCov">         19 :                         ASSERT(arc_buf_is_shared(lastbuf) ||</span>
<span class="lineNum">    6489 </span>                :            :                             arc_hdr_get_compress(hdr) != ZIO_COMPRESS_OFF);
<span class="lineNum">    6490 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 19 times"> + </span>]:<span class="lineCov">         19 :                         ASSERT(!ARC_BUF_SHARED(buf));</span>
<span class="lineNum">    6491 </span>                :            :                 }
<span class="lineNum">    6492 </span>                :            : 
<span class="lineNum">    6493 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 38 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">         38 :                 ASSERT(hdr-&gt;b_l1hdr.b_pabd != NULL || HDR_HAS_RABD(hdr));</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    6494 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 38 times"> + </span>]:<span class="lineCov">         38 :                 ASSERT3P(state, !=, arc_l2c_only);</span>
<span class="lineNum">    6495 </span>                :            : 
<span class="lineNum">    6496 </span>                :<span class="lineCov">         38 :                 (void) refcount_remove_many(&amp;state-&gt;arcs_size,</span>
<span class="lineNum">    6497 </span>                :            :                     arc_buf_size(buf), buf);
<span class="lineNum">    6498 </span>                :            : 
<span class="lineNum">    6499 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 38 times"> + </span>]:<span class="lineCov">         38 :                 if (refcount_is_zero(&amp;hdr-&gt;b_l1hdr.b_refcnt)) {</span>
<span class="lineNum">    6500 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         ASSERT3P(state, !=, arc_l2c_only);</span>
<span class="lineNum">    6501 </span>                :<span class="lineNoCov">          0 :                         (void) refcount_remove_many(&amp;state-&gt;arcs_esize[type],</span>
<span class="lineNum">    6502 </span>                :            :                             arc_buf_size(buf), buf);
<span class="lineNum">    6503 </span>                :            :                 }
<span class="lineNum">    6504 </span>                :            : 
<span class="lineNum">    6505 </span>                :<span class="lineCov">         38 :                 hdr-&gt;b_l1hdr.b_bufcnt -= 1;</span>
<span class="lineNum">    6506 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 38 times"> + </span>]:<span class="lineCov">         38 :                 if (ARC_BUF_ENCRYPTED(buf))</span>
<span class="lineNum">    6507 </span>                :<span class="lineNoCov">          0 :                         hdr-&gt;b_crypt_hdr.b_ebufcnt -= 1;</span>
<span class="lineNum">    6508 </span>                :            : 
<span class="lineNum">    6509 </span>                :<span class="lineCov">         38 :                 arc_cksum_verify(buf);</span>
<span class="lineNum">    6510 </span>                :<span class="lineCov">         38 :                 arc_buf_unwatch(buf);</span>
<span class="lineNum">    6511 </span>                :            : 
<span class="lineNum">    6512 </span>                :            :                 /* if this is the last uncompressed buf free the checksum */
<span class="lineNum">    6513 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 38 times"> + </span>]:<span class="lineCov">         38 :                 if (!arc_hdr_has_uncompressed_buf(hdr))</span>
<span class="lineNum">    6514 </span>                :<span class="lineNoCov">          0 :                         arc_cksum_free(hdr);</span>
<span class="lineNum">    6515 </span>                :            : 
<span class="lineNum">    6516 </span>                :<span class="lineCov">         38 :                 mutex_exit(hash_lock);</span>
<span class="lineNum">    6517 </span>                :            : 
<span class="lineNum">    6518 </span>                :            :                 /*
<span class="lineNum">    6519 </span>                :            :                  * Allocate a new hdr. The new hdr will contain a b_pabd
<span class="lineNum">    6520 </span>                :            :                  * buffer which will be freed in arc_write().
<span class="lineNum">    6521 </span>                :            :                  */
<span class="lineNum">    6522 </span>                :<span class="lineCov">         38 :                 nhdr = arc_hdr_alloc(spa, psize, lsize, protected,</span>
<span class="lineNum">    6523 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 38 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">         38 :                     compress, type, HDR_HAS_RABD(hdr));</span>
<span class="lineNum">    6524 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 38 times"> + </span>]:<span class="lineCov">         38 :                 ASSERT3P(nhdr-&gt;b_l1hdr.b_buf, ==, NULL);</span>
<span class="lineNum">    6525 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 38 times"> + </span>]:<span class="lineCov">         38 :                 ASSERT0(nhdr-&gt;b_l1hdr.b_bufcnt);</span>
<span class="lineNum">    6526 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 38 times"> + </span>]:<span class="lineCov">         38 :                 ASSERT0(refcount_count(&amp;nhdr-&gt;b_l1hdr.b_refcnt));</span>
<span class="lineNum">    6527 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 38 times"> + </span>]:<span class="lineCov">         38 :                 VERIFY3U(nhdr-&gt;b_type, ==, type);</span>
<span class="lineNum">    6528 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 38 times"> + </span>]:<span class="lineCov">         38 :                 ASSERT(!HDR_SHARED_DATA(nhdr));</span>
<span class="lineNum">    6529 </span>                :            : 
<span class="lineNum">    6530 </span>                :<span class="lineCov">         38 :                 nhdr-&gt;b_l1hdr.b_buf = buf;</span>
<span class="lineNum">    6531 </span>                :<span class="lineCov">         38 :                 nhdr-&gt;b_l1hdr.b_bufcnt = 1;</span>
<span class="lineNum">    6532 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 38 times"> + </span>]:<span class="lineCov">         38 :                 if (ARC_BUF_ENCRYPTED(buf))</span>
<span class="lineNum">    6533 </span>                :<span class="lineNoCov">          0 :                         nhdr-&gt;b_crypt_hdr.b_ebufcnt = 1;</span>
<span class="lineNum">    6534 </span>                :<span class="lineCov">         38 :                 nhdr-&gt;b_l1hdr.b_mru_hits = 0;</span>
<span class="lineNum">    6535 </span>                :<span class="lineCov">         38 :                 nhdr-&gt;b_l1hdr.b_mru_ghost_hits = 0;</span>
<span class="lineNum">    6536 </span>                :<span class="lineCov">         38 :                 nhdr-&gt;b_l1hdr.b_mfu_hits = 0;</span>
<span class="lineNum">    6537 </span>                :<span class="lineCov">         38 :                 nhdr-&gt;b_l1hdr.b_mfu_ghost_hits = 0;</span>
<span class="lineNum">    6538 </span>                :<span class="lineCov">         38 :                 nhdr-&gt;b_l1hdr.b_l2_hits = 0;</span>
<span class="lineNum">    6539 </span>                :<span class="lineCov">         38 :                 (void) refcount_add(&amp;nhdr-&gt;b_l1hdr.b_refcnt, tag);</span>
<span class="lineNum">    6540 </span>                :<span class="lineCov">         38 :                 buf-&gt;b_hdr = nhdr;</span>
<span class="lineNum">    6541 </span>                :            : 
<span class="lineNum">    6542 </span>                :<span class="lineCov">         38 :                 mutex_exit(&amp;buf-&gt;b_evict_lock);</span>
<span class="lineNum">    6543 </span>                :<span class="lineCov">         38 :                 (void) refcount_add_many(&amp;arc_anon-&gt;arcs_size,</span>
<span class="lineNum">    6544 </span>                :<span class="lineCov">         38 :                     HDR_GET_LSIZE(nhdr), buf);</span>
<span class="lineNum">    6545 </span>                :            :         } else {
<span class="lineNum">    6546 </span>                :<span class="lineCov">     593008 :                 mutex_exit(&amp;buf-&gt;b_evict_lock);</span>
<span class="lineNum">    6547 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 593009 times"> + </span>]:<span class="lineCov">     593015 :                 ASSERT(refcount_count(&amp;hdr-&gt;b_l1hdr.b_refcnt) == 1);</span>
<span class="lineNum">    6548 </span>                :            :                 /* protected by hash lock, or hdr is on arc_anon */
<span class="lineNum">    6549 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 592952 times"> + </span>]:<span class="lineCov">     593009 :                 ASSERT(!multilist_link_active(&amp;hdr-&gt;b_l1hdr.b_arc_node));</span>
<span class="lineNum">    6550 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 592952 times"> + </span>]:<span class="lineCov">     592952 :                 ASSERT(!HDR_IO_IN_PROGRESS(hdr));</span>
<span class="lineNum">    6551 </span>                :<span class="lineCov">     592952 :                 hdr-&gt;b_l1hdr.b_mru_hits = 0;</span>
<span class="lineNum">    6552 </span>                :<span class="lineCov">     592952 :                 hdr-&gt;b_l1hdr.b_mru_ghost_hits = 0;</span>
<span class="lineNum">    6553 </span>                :<span class="lineCov">     592952 :                 hdr-&gt;b_l1hdr.b_mfu_hits = 0;</span>
<span class="lineNum">    6554 </span>                :<span class="lineCov">     592952 :                 hdr-&gt;b_l1hdr.b_mfu_ghost_hits = 0;</span>
<span class="lineNum">    6555 </span>                :<span class="lineCov">     592952 :                 hdr-&gt;b_l1hdr.b_l2_hits = 0;</span>
<span class="lineNum">    6556 </span>                :<span class="lineCov">     592952 :                 arc_change_state(arc_anon, hdr, hash_lock);</span>
<span class="lineNum">    6557 </span>                :<span class="lineCov">     593018 :                 hdr-&gt;b_l1hdr.b_arc_access = 0;</span>
<span class="lineNum">    6558 </span>                :            : 
<span class="lineNum">    6559 </span>                :<span class="lineCov">     593018 :                 mutex_exit(hash_lock);</span>
<span class="lineNum">    6560 </span>                :<span class="lineCov">     593018 :                 buf_discard_identity(hdr);</span>
<span class="lineNum">    6561 </span>                :<span class="lineCov">     593018 :                 arc_buf_thaw(buf);</span>
<span class="lineNum">    6562 </span>                :            :         }
<span class="lineNum">    6563 </span>                :            : }
<a name="6564"><span class="lineNum">    6564 </span>                :            : </a>
<span class="lineNum">    6565 </span>                :            : int
<span class="lineNum">    6566 </span>                :<span class="lineCov">    4941101 : arc_released(arc_buf_t *buf)</span>
<span class="lineNum">    6567 </span>                :            : {
<span class="lineNum">    6568 </span>                :            :         int released;
<span class="lineNum">    6569 </span>                :            : 
<span class="lineNum">    6570 </span>                :<span class="lineCov">    4941101 :         mutex_enter(&amp;buf-&gt;b_evict_lock);</span>
<span class="lineNum">    6571 </span>   [<span class="branchCov" title="Branch 0 was taken 4942130 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 1264322 times"> + </span><span class="branchCov" title="Branch 3 was taken 3677808 times"> + </span>]:<span class="lineCov">    4942069 :         released = (buf-&gt;b_data != NULL &amp;&amp;</span>
<span class="lineNum">    6572 </span>                :<span class="lineCov">    4942130 :             buf-&gt;b_hdr-&gt;b_l1hdr.b_state == arc_anon);</span>
<span class="lineNum">    6573 </span>                :<span class="lineCov">    4942069 :         mutex_exit(&amp;buf-&gt;b_evict_lock);</span>
<span class="lineNum">    6574 </span>                :<span class="lineCov">    4942620 :         return (released);</span>
<span class="lineNum">    6575 </span>                :            : }
<span class="lineNum">    6576 </span>                :            : 
<a name="6577"><span class="lineNum">    6577 </span>                :            : #ifdef ZFS_DEBUG</a>
<span class="lineNum">    6578 </span>                :            : int
<span class="lineNum">    6579 </span>                :<span class="lineCov">    5493337 : arc_referenced(arc_buf_t *buf)</span>
<span class="lineNum">    6580 </span>                :            : {
<span class="lineNum">    6581 </span>                :            :         int referenced;
<span class="lineNum">    6582 </span>                :            : 
<span class="lineNum">    6583 </span>                :<span class="lineCov">    5493337 :         mutex_enter(&amp;buf-&gt;b_evict_lock);</span>
<span class="lineNum">    6584 </span>                :<span class="lineCov">    5494388 :         referenced = (refcount_count(&amp;buf-&gt;b_hdr-&gt;b_l1hdr.b_refcnt));</span>
<span class="lineNum">    6585 </span>                :<span class="lineCov">    5493715 :         mutex_exit(&amp;buf-&gt;b_evict_lock);</span>
<span class="lineNum">    6586 </span>                :<span class="lineCov">    5494168 :         return (referenced);</span>
<span class="lineNum">    6587 </span>                :            : }
<span class="lineNum">    6588 </span>                :            : #endif
<a name="6589"><span class="lineNum">    6589 </span>                :            : </a>
<span class="lineNum">    6590 </span>                :            : static void
<span class="lineNum">    6591 </span>                :<span class="lineCov">     727701 : arc_write_ready(zio_t *zio)</span>
<span class="lineNum">    6592 </span>                :            : {
<span class="lineNum">    6593 </span>                :<span class="lineCov">     727701 :         arc_write_callback_t *callback = zio-&gt;io_private;</span>
<span class="lineNum">    6594 </span>                :<span class="lineCov">     727701 :         arc_buf_t *buf = callback-&gt;awcb_buf;</span>
<span class="lineNum">    6595 </span>                :<span class="lineCov">     727701 :         arc_buf_hdr_t *hdr = buf-&gt;b_hdr;</span>
<span class="lineNum">    6596 </span>                :<span class="lineCov">     727701 :         blkptr_t *bp = zio-&gt;io_bp;</span>
<span class="lineNum">    6597 </span>[<span class="branchCov" title="Branch 0 was taken 694559 times"> + </span><span class="branchCov" title="Branch 1 was taken 33142 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 37368 times"> + </span><span class="branchCov" title="Branch 3 was taken 657191 times"> + </span>]:<span class="lineCov">     727701 :         uint64_t psize = BP_IS_HOLE(bp) ? 0 : BP_GET_PSIZE(bp);</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 85 times"> + </span><span class="branchCov" title="Branch 5 was taken 37283 times"> + </span>][<span class="branchCov" title="Branch 6 was taken 657197 times"> + </span><span class="branchCov" title="Branch 7 was taken 33221 times"> + </span>]
<span class="lineNum">    6598 </span>                :            :         enum zio_compress compress;
<span class="lineNum">    6599 </span>                :<span class="lineCov">     727701 :         fstrans_cookie_t cookie = spl_fstrans_mark();</span>
<span class="lineNum">    6600 </span>                :            : 
<span class="lineNum">    6601 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727749 times"> + </span>]:<span class="lineCov">     727749 :         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    6602 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 727739 times"> + </span>]:<span class="lineCov">     727749 :         ASSERT(!refcount_is_zero(&amp;buf-&gt;b_hdr-&gt;b_l1hdr.b_refcnt));</span>
<span class="lineNum">    6603 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727739 times"> + </span>]:<span class="lineCov">     727739 :         ASSERT(hdr-&gt;b_l1hdr.b_bufcnt &gt; 0);</span>
<span class="lineNum">    6604 </span>                :            : 
<span class="lineNum">    6605 </span>                :            :         /*
<span class="lineNum">    6606 </span>                :            :          * If we're reexecuting this zio because the pool suspended, then
<span class="lineNum">    6607 </span>                :            :          * cleanup any state that was previously set the first time the
<span class="lineNum">    6608 </span>                :            :          * callback was invoked.
<span class="lineNum">    6609 </span>                :            :          */
<span class="lineNum">    6610 </span>        [<span class="branchCov" title="Branch 0 was taken 66 times"> + </span><span class="branchCov" title="Branch 1 was taken 727673 times"> + </span>]:<span class="lineCov">     727739 :         if (zio-&gt;io_flags &amp; ZIO_FLAG_REEXECUTED) {</span>
<span class="lineNum">    6611 </span>                :<span class="lineCov">         66 :                 arc_cksum_free(hdr);</span>
<span class="lineNum">    6612 </span>                :<span class="lineCov">         66 :                 arc_buf_unwatch(buf);</span>
<span class="lineNum">    6613 </span>        [<span class="branchCov" title="Branch 0 was taken 66 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         66 :                 if (hdr-&gt;b_l1hdr.b_pabd != NULL) {</span>
<span class="lineNum">    6614 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 64 times"> + </span>]:<span class="lineCov">         66 :                         if (arc_buf_is_shared(buf)) {</span>
<span class="lineNum">    6615 </span>                :<span class="lineCov">          2 :                                 arc_unshare_buf(hdr, buf);</span>
<span class="lineNum">    6616 </span>                :            :                         } else {
<span class="lineNum">    6617 </span>                :<span class="lineCov">         64 :                                 arc_hdr_free_abd(hdr, B_FALSE);</span>
<span class="lineNum">    6618 </span>                :            :                         }
<span class="lineNum">    6619 </span>                :            :                 }
<span class="lineNum">    6620 </span>                :            : 
<span class="lineNum">    6621 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 56 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">         56 :                 if (HDR_HAS_RABD(hdr))</span>
<span class="lineNum">    6622 </span>                :<span class="lineNoCov">          0 :                         arc_hdr_free_abd(hdr, B_TRUE);</span>
<span class="lineNum">    6623 </span>                :            :         }
<span class="lineNum">    6624 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727729 times"> + </span>]:<span class="lineCov">     727729 :         ASSERT3P(hdr-&gt;b_l1hdr.b_pabd, ==, NULL);</span>
<span class="lineNum">    6625 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727729 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     727729 :         ASSERT(!HDR_HAS_RABD(hdr));</span>
<span class="lineNum">    6626 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727729 times"> + </span>]:<span class="lineCov">     727729 :         ASSERT(!HDR_SHARED_DATA(hdr));</span>
<span class="lineNum">    6627 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 727729 times"> + </span>]:<span class="lineCov">     727729 :         ASSERT(!arc_buf_is_shared(buf));</span>
<span class="lineNum">    6628 </span>                :            : 
<span class="lineNum">    6629 </span>                :<span class="lineCov">     727729 :         callback-&gt;awcb_ready(zio, buf, callback-&gt;awcb_private);</span>
<span class="lineNum">    6630 </span>                :            : 
<span class="lineNum">    6631 </span>        [<span class="branchCov" title="Branch 0 was taken 66 times"> + </span><span class="branchCov" title="Branch 1 was taken 727646 times"> + </span>]:<span class="lineCov">     727712 :         if (HDR_IO_IN_PROGRESS(hdr))</span>
<span class="lineNum">    6632 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 66 times"> + </span>]:<span class="lineCov">         66 :                 ASSERT(zio-&gt;io_flags &amp; ZIO_FLAG_REEXECUTED);</span>
<span class="lineNum">    6633 </span>                :            : 
<span class="lineNum">    6634 </span>                :<span class="lineCov">     727712 :         arc_hdr_set_flags(hdr, ARC_FLAG_IO_IN_PROGRESS);</span>
<span class="lineNum">    6635 </span>                :            : 
<span class="lineNum">    6636 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727749 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     727749 :         if (BP_IS_PROTECTED(bp) != !!HDR_PROTECTED(hdr))</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>][<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 12 was not executed"> # </span><span class="branchNoExec" title="Branch 13 was not executed"> # </span>][<span class="branchNoExec" title="Branch 14 was not executed"> # </span><span class="branchNoExec" title="Branch 15 was not executed"> # </span>]
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 16 was not taken"> - </span><span class="branchCov" title="Branch 17 was taken 727749 times"> + </span>]
<span class="lineNum">    6637 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 hdr = arc_hdr_realloc_crypt(hdr, BP_IS_PROTECTED(bp));</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>][<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 12 was not executed"> # </span><span class="branchNoExec" title="Branch 13 was not executed"> # </span>][<span class="branchNoExec" title="Branch 14 was not executed"> # </span><span class="branchNoExec" title="Branch 15 was not executed"> # </span>]
<span class="lineNum">    6638 </span>                :            : 
<span class="lineNum">    6639 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727687 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     727687 :         if (BP_IS_PROTECTED(bp)) {</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>][<span class="branchNoExec" title="Branch 10 was not executed"> # </span><span class="branchNoExec" title="Branch 11 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 12 was not executed"> # </span><span class="branchNoExec" title="Branch 13 was not executed"> # </span>][<span class="branchNoExec" title="Branch 14 was not executed"> # </span><span class="branchNoExec" title="Branch 15 was not executed"> # </span>]
<span class="lineNum">    6640 </span>                :            :                 /* ZIL blocks are written through zio_rewrite */
<span class="lineNum">    6641 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3U(BP_GET_TYPE(bp), !=, DMU_OT_INTENT_LOG);</span>
<span class="lineNum">    6642 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT(HDR_PROTECTED(hdr));</span>
<span class="lineNum">    6643 </span>                :            : 
<span class="lineNum">    6644 </span>                :<span class="lineNoCov">          0 :                 hdr-&gt;b_crypt_hdr.b_ot = BP_GET_TYPE(bp);</span>
<span class="lineNum">    6645 </span>                :<span class="lineNoCov">          0 :                 hdr-&gt;b_crypt_hdr.b_dsobj = zio-&gt;io_bookmark.zb_objset;</span>
<span class="lineNum">    6646 </span>                :<span class="lineNoCov">          0 :                 zio_crypt_decode_params_bp(bp, hdr-&gt;b_crypt_hdr.b_salt,</span>
<span class="lineNum">    6647 </span>                :<span class="lineNoCov">          0 :                     hdr-&gt;b_crypt_hdr.b_iv);</span>
<span class="lineNum">    6648 </span>                :<span class="lineNoCov">          0 :                 zio_crypt_decode_mac_bp(bp, hdr-&gt;b_crypt_hdr.b_mac);</span>
<span class="lineNum">    6649 </span>                :            :         }
<span class="lineNum">    6650 </span>                :            : 
<span class="lineNum">    6651 </span>                :            :         /*
<span class="lineNum">    6652 </span>                :            :          * If this block was written for raw encryption but the zio layer
<span class="lineNum">    6653 </span>                :            :          * ended up only authenticating it, adjust the buffer flags now.
<span class="lineNum">    6654 </span>                :            :          */
<span class="lineNum">    6655 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727687 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     727687 :         if (BP_IS_AUTHENTICATED(bp) &amp;&amp; ARC_BUF_ENCRYPTED(buf)) {</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">    6656 </span>                :<span class="lineNoCov">          0 :                 arc_hdr_set_flags(hdr, ARC_FLAG_NOAUTH);</span>
<span class="lineNum">    6657 </span>                :<span class="lineNoCov">          0 :                 buf-&gt;b_flags &amp;= ~ARC_BUF_FLAG_ENCRYPTED;</span>
<span class="lineNum">    6658 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (BP_GET_COMPRESS(bp) == ZIO_COMPRESS_OFF)</span>
<span class="lineNum">    6659 </span>                :<span class="lineNoCov">          0 :                         buf-&gt;b_flags &amp;= ~ARC_BUF_FLAG_COMPRESSED;</span>
<span class="lineNum">    6660 </span>                :            :         }
<span class="lineNum">    6661 </span>                :            : 
<span class="lineNum">    6662 </span>                :            :         /* this must be done after the buffer flags are adjusted */
<span class="lineNum">    6663 </span>                :<span class="lineCov">     727687 :         arc_cksum_compute(buf);</span>
<span class="lineNum">    6664 </span>                :            : 
<span class="lineNum">    6665 </span>[<span class="branchCov" title="Branch 0 was taken 694508 times"> + </span><span class="branchCov" title="Branch 1 was taken 33198 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 37368 times"> + </span><span class="branchCov" title="Branch 3 was taken 657140 times"> + </span>]:<span class="lineCov">     727706 :         if (BP_IS_HOLE(bp) || BP_IS_EMBEDDED(bp)) {</span>
<span class="lineNum">         </span>   [<span class="branchCov" title="Branch 5 was taken 37404 times"> + </span>][<span class="branchCov" title="Branch 6 was taken 657080 times"> + </span><span class="branchCov" title="Branch 7 was taken 33222 times"> + </span>]
<span class="lineNum">    6666 </span>                :            :                 compress = ZIO_COMPRESS_OFF;
<span class="lineNum">    6667 </span>                :            :         } else {
<span class="lineNum">    6668 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 657080 times"> + </span>]:<span class="lineCov">     657080 :                 ASSERT3U(HDR_GET_LSIZE(hdr), ==, BP_GET_LSIZE(bp));</span>
<span class="lineNum">    6669 </span>                :<span class="lineCov">     657080 :                 compress = BP_GET_COMPRESS(bp);</span>
<span class="lineNum">    6670 </span>                :            :         }
<span class="lineNum">    6671 </span>                :<span class="lineCov">     727706 :         HDR_SET_PSIZE(hdr, psize);</span>
<span class="lineNum">    6672 </span>                :<span class="lineCov">     727706 :         arc_hdr_set_compress(hdr, compress);</span>
<span class="lineNum">    6673 </span>                :            : 
<span class="lineNum">    6674 </span>                :            :         /*
<span class="lineNum">    6675 </span>                :            :          * Fill the hdr with data. If the buffer is encrypted we have no choice
<span class="lineNum">    6676 </span>                :            :          * but to copy the data into b_radb. If the hdr is compressed, the data
<span class="lineNum">    6677 </span>                :            :          * we want is available from the zio, otherwise we can take it from
<span class="lineNum">    6678 </span>                :            :          * the buf.
<span class="lineNum">    6679 </span>                :            :          *
<span class="lineNum">    6680 </span>                :            :          * We might be able to share the buf's data with the hdr here. However,
<span class="lineNum">    6681 </span>                :            :          * doing so would cause the ARC to be full of linear ABDs if we write a
<span class="lineNum">    6682 </span>                :            :          * lot of shareable data. As a compromise, we check whether scattered
<span class="lineNum">    6683 </span>                :            :          * ABDs are allowed, and assume that if they are then the user wants
<span class="lineNum">    6684 </span>                :            :          * the ARC to be primarily filled with them regardless of the data being
<span class="lineNum">    6685 </span>                :            :          * written. Therefore, if they're allowed then we allocate one and copy
<span class="lineNum">    6686 </span>                :            :          * the data into it; otherwise, we share the data directly if we can.
<span class="lineNum">    6687 </span>                :            :          */
<span class="lineNum">    6688 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727551 times"> + </span>]:<span class="lineCov">     727551 :         if (ARC_BUF_ENCRYPTED(buf)) {</span>
<span class="lineNum">    6689 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT(ARC_BUF_COMPRESSED(buf));</span>
<span class="lineNum">    6690 </span>                :<span class="lineNoCov">          0 :                 arc_hdr_alloc_abd(hdr, B_TRUE);</span>
<span class="lineNum">    6691 </span>                :<span class="lineNoCov">          0 :                 abd_copy(hdr-&gt;b_crypt_hdr.b_rabd, zio-&gt;io_abd, psize);</span>
<span class="lineNum">    6692 </span>[<span class="branchCov" title="Branch 0 was taken 350493 times"> + </span><span class="branchCov" title="Branch 1 was taken 377058 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 144867 times"> + </span><span class="branchCov" title="Branch 4 was taken 205661 times"> + </span>]:<span class="lineCov">     727551 :         } else if (zfs_abd_scatter_enabled || !arc_can_share(hdr, buf)) {</span>
<span class="lineNum">    6693 </span>                :            :                 /*
<span class="lineNum">    6694 </span>                :            :                  * Ideally, we would always copy the io_abd into b_pabd, but the
<span class="lineNum">    6695 </span>                :            :                  * user may have disabled compressed ARC, thus we must check the
<span class="lineNum">    6696 </span>                :            :                  * hdr's compression setting rather than the io_bp's.
<span class="lineNum">    6697 </span>                :            :                  */
<span class="lineNum">    6698 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 521925 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     521925 :                 if (BP_IS_ENCRYPTED(bp)) {</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 8 was not executed"> # </span><span class="branchNoExec" title="Branch 9 was not executed"> # </span>]
<span class="lineNum">    6699 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         ASSERT3U(psize, &gt;, 0);</span>
<span class="lineNum">    6700 </span>                :<span class="lineNoCov">          0 :                         arc_hdr_alloc_abd(hdr, B_TRUE);</span>
<span class="lineNum">    6701 </span>                :<span class="lineNoCov">          0 :                         abd_copy(hdr-&gt;b_crypt_hdr.b_rabd, zio-&gt;io_abd, psize);</span>
<span class="lineNum">    6702 </span>   [<span class="branchCov" title="Branch 1 was taken 298780 times"> + </span><span class="branchCov" title="Branch 2 was taken 223147 times"> + </span>][<span class="branchCov" title="Branch 3 was taken 298792 times"> + </span>]:<span class="lineCov">     521925 :                 } else if (arc_hdr_get_compress(hdr) != ZIO_COMPRESS_OFF &amp;&amp;</span>
<span class="lineNum">    6703 </span>                :<span class="lineCov">     298780 :                     !ARC_BUF_COMPRESSED(buf)) {</span>
<span class="lineNum">    6704 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 298792 times"> + </span>]:<span class="lineCov">     298792 :                         ASSERT3U(psize, &gt;, 0);</span>
<span class="lineNum">    6705 </span>                :<span class="lineCov">     298792 :                         arc_hdr_alloc_abd(hdr, B_FALSE);</span>
<span class="lineNum">    6706 </span>                :<span class="lineCov">     298837 :                         abd_copy(hdr-&gt;b_l1hdr.b_pabd, zio-&gt;io_abd, psize);</span>
<span class="lineNum">    6707 </span>                :            :                 } else {
<span class="lineNum">    6708 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 223146 times"> + </span>]:<span class="lineCov">     223135 :                         ASSERT3U(zio-&gt;io_orig_size, ==, arc_hdr_size(hdr));</span>
<span class="lineNum">    6709 </span>                :<span class="lineCov">     223146 :                         arc_hdr_alloc_abd(hdr, B_FALSE);</span>
<span class="lineNum">    6710 </span>                :<span class="lineCov">     223242 :                         abd_copy_from_buf(hdr-&gt;b_l1hdr.b_pabd, buf-&gt;b_data,</span>
<span class="lineNum">    6711 </span>                :            :                             arc_buf_size(buf));
<span class="lineNum">    6712 </span>                :            :                 }
<span class="lineNum">    6713 </span>                :            :         } else {
<span class="lineNum">    6714 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 205620 times"> + </span>]:<span class="lineCov">     205661 :                 ASSERT3P(buf-&gt;b_data, ==, abd_to_buf(zio-&gt;io_orig_abd));</span>
<span class="lineNum">    6715 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 205608 times"> + </span>]:<span class="lineCov">     205620 :                 ASSERT3U(zio-&gt;io_orig_size, ==, arc_buf_size(buf));</span>
<span class="lineNum">    6716 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 205608 times"> + </span>]:<span class="lineCov">     205608 :                 ASSERT3U(hdr-&gt;b_l1hdr.b_bufcnt, ==, 1);</span>
<span class="lineNum">    6717 </span>                :            : 
<span class="lineNum">    6718 </span>                :<span class="lineCov">     205608 :                 arc_share_buf(hdr, buf);</span>
<span class="lineNum">    6719 </span>                :            :         }
<span class="lineNum">    6720 </span>                :            : 
<span class="lineNum">    6721 </span>                :<span class="lineCov">     727666 :         arc_hdr_verify(hdr, bp);</span>
<span class="lineNum">    6722 </span>                :<span class="lineCov">     727569 :         spl_fstrans_unmark(cookie);</span>
<span class="lineNum">    6723 </span>                :<span class="lineCov">     727556 : }</span>
<a name="6724"><span class="lineNum">    6724 </span>                :            : </a>
<span class="lineNum">    6725 </span>                :            : static void
<span class="lineNum">    6726 </span>                :<span class="lineCov">     310370 : arc_write_children_ready(zio_t *zio)</span>
<span class="lineNum">    6727 </span>                :            : {
<span class="lineNum">    6728 </span>                :<span class="lineCov">     310370 :         arc_write_callback_t *callback = zio-&gt;io_private;</span>
<span class="lineNum">    6729 </span>                :<span class="lineCov">     310370 :         arc_buf_t *buf = callback-&gt;awcb_buf;</span>
<span class="lineNum">    6730 </span>                :            : 
<span class="lineNum">    6731 </span>                :<span class="lineCov">     310370 :         callback-&gt;awcb_children_ready(zio, buf, callback-&gt;awcb_private);</span>
<span class="lineNum">    6732 </span>                :<span class="lineCov">     310376 : }</span>
<span class="lineNum">    6733 </span>                :            : 
<span class="lineNum">    6734 </span>                :            : /*
<span class="lineNum">    6735 </span>                :            :  * The SPA calls this callback for each physical write that happens on behalf
<span class="lineNum">    6736 </span>                :            :  * of a logical write.  See the comment in dbuf_write_physdone() for details.
<a name="6737"><span class="lineNum">    6737 </span>                :            :  */</a>
<span class="lineNum">    6738 </span>                :            : static void
<span class="lineNum">    6739 </span>                :<span class="lineCov">    3382072 : arc_write_physdone(zio_t *zio)</span>
<span class="lineNum">    6740 </span>                :            : {
<span class="lineNum">    6741 </span>                :<span class="lineCov">    3382072 :         arc_write_callback_t *cb = zio-&gt;io_private;</span>
<span class="lineNum">    6742 </span>        [<span class="branchCov" title="Branch 0 was taken 3027711 times"> + </span><span class="branchCov" title="Branch 1 was taken 354361 times"> + </span>]:<span class="lineCov">    3382072 :         if (cb-&gt;awcb_physdone != NULL)</span>
<span class="lineNum">    6743 </span>                :<span class="lineCov">    3027711 :                 cb-&gt;awcb_physdone(zio, cb-&gt;awcb_buf, cb-&gt;awcb_private);</span>
<span class="lineNum">    6744 </span>                :<span class="lineCov">    3381996 : }</span>
<a name="6745"><span class="lineNum">    6745 </span>                :            : </a>
<span class="lineNum">    6746 </span>                :            : static void
<span class="lineNum">    6747 </span>                :<span class="lineCov">     727675 : arc_write_done(zio_t *zio)</span>
<span class="lineNum">    6748 </span>                :            : {
<span class="lineNum">    6749 </span>                :<span class="lineCov">     727675 :         arc_write_callback_t *callback = zio-&gt;io_private;</span>
<span class="lineNum">    6750 </span>                :<span class="lineCov">     727675 :         arc_buf_t *buf = callback-&gt;awcb_buf;</span>
<span class="lineNum">    6751 </span>                :<span class="lineCov">     727675 :         arc_buf_hdr_t *hdr = buf-&gt;b_hdr;</span>
<span class="lineNum">    6752 </span>                :            : 
<span class="lineNum">    6753 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727675 times"> + </span>]:<span class="lineCov">     727675 :         ASSERT3P(hdr-&gt;b_l1hdr.b_acb, ==, NULL);</span>
<span class="lineNum">    6754 </span>                :            : 
<span class="lineNum">    6755 </span>        [<span class="branchCov" title="Branch 0 was taken 727675 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     727675 :         if (zio-&gt;io_error == 0) {</span>
<span class="lineNum">    6756 </span>                :<span class="lineCov">     727675 :                 arc_hdr_verify(hdr, zio-&gt;io_bp);</span>
<span class="lineNum">    6757 </span>                :            : 
<span class="lineNum">    6758 </span>[<span class="branchCov" title="Branch 0 was taken 694446 times"> + </span><span class="branchCov" title="Branch 1 was taken 33223 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 37301 times"> + </span><span class="branchCov" title="Branch 3 was taken 657145 times"> + </span>]:<span class="lineCov">     727669 :                 if (BP_IS_HOLE(zio-&gt;io_bp) || BP_IS_EMBEDDED(zio-&gt;io_bp)) {</span>
<span class="lineNum">         </span>   [<span class="branchCov" title="Branch 5 was taken 37334 times"> + </span>][<span class="branchCov" title="Branch 6 was taken 33214 times"> + </span><span class="branchCov" title="Branch 7 was taken 657121 times"> + </span>]
<span class="lineNum">    6759 </span>                :<span class="lineCov">      70548 :                         buf_discard_identity(hdr);</span>
<span class="lineNum">    6760 </span>                :            :                 } else {
<span class="lineNum">    6761 </span>                :<span class="lineCov">     657121 :                         hdr-&gt;b_dva = *BP_IDENTITY(zio-&gt;io_bp);</span>
<span class="lineNum">    6762 </span>[<span class="branchCov" title="Branch 0 was taken 657107 times"> + </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 656283 times"> + </span><span class="branchCov" title="Branch 3 was taken 824 times"> + </span>]:<span class="lineCov">     657121 :                         hdr-&gt;b_birth = BP_PHYSICAL_BIRTH(zio-&gt;io_bp);</span>
<span class="lineNum">    6763 </span>                :            :                 }
<span class="lineNum">    6764 </span>                :            :         } else {
<span class="lineNum">    6765 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT(HDR_EMPTY(hdr));</span>
<span class="lineNum">    6766 </span>                :            :         }
<span class="lineNum">    6767 </span>                :            : 
<span class="lineNum">    6768 </span>                :            :         /*
<span class="lineNum">    6769 </span>                :            :          * If the block to be written was all-zero or compressed enough to be
<span class="lineNum">    6770 </span>                :            :          * embedded in the BP, no write was performed so there will be no
<span class="lineNum">    6771 </span>                :            :          * dva/birth/checksum.  The buffer must therefore remain anonymous
<span class="lineNum">    6772 </span>                :            :          * (and uncached).
<span class="lineNum">    6773 </span>                :            :          */
<span class="lineNum">    6774 </span>[<span class="branchCov" title="Branch 0 was taken 70507 times"> + </span><span class="branchCov" title="Branch 1 was taken 657112 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 4 times"> + </span><span class="branchCov" title="Branch 3 was taken 70503 times"> + </span>]:<span class="lineCov">    1384826 :         if (!HDR_EMPTY(hdr)) {</span>
<span class="lineNum">    6775 </span>                :            :                 arc_buf_hdr_t *exists;
<span class="lineNum">    6776 </span>                :            :                 kmutex_t *hash_lock;
<span class="lineNum">    6777 </span>                :            : 
<span class="lineNum">    6778 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 657116 times"> + </span>]:<span class="lineCov">     657116 :                 ASSERT3U(zio-&gt;io_error, ==, 0);</span>
<span class="lineNum">    6779 </span>                :            : 
<span class="lineNum">    6780 </span>                :<span class="lineCov">     657116 :                 arc_cksum_verify(buf);</span>
<span class="lineNum">    6781 </span>                :            : 
<span class="lineNum">    6782 </span>                :<span class="lineCov">     657184 :                 exists = buf_hash_insert(hdr, &amp;hash_lock);</span>
<span class="lineNum">    6783 </span>        [<span class="branchCov" title="Branch 0 was taken 14586 times"> + </span><span class="branchCov" title="Branch 1 was taken 642589 times"> + </span>]:<span class="lineCov">     657175 :                 if (exists != NULL) {</span>
<span class="lineNum">    6784 </span>                :            :                         /*
<span class="lineNum">    6785 </span>                :            :                          * This can only happen if we overwrite for
<span class="lineNum">    6786 </span>                :            :                          * sync-to-convergence, because we remove
<span class="lineNum">    6787 </span>                :            :                          * buffers from the hash table when we arc_free().
<span class="lineNum">    6788 </span>                :            :                          */
<span class="lineNum">    6789 </span>        [<span class="branchCov" title="Branch 0 was taken 3865 times"> + </span><span class="branchCov" title="Branch 1 was taken 10721 times"> + </span>]:<span class="lineCov">      14586 :                         if (zio-&gt;io_flags &amp; ZIO_FLAG_IO_REWRITE) {</span>
<span class="lineNum">    6790 </span>[<span class="branchCov" title="Branch 0 was taken 3865 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 3865 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       3865 :                                 if (!BP_EQUAL(&amp;zio-&gt;io_bp_orig, zio-&gt;io_bp))</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 3865 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchCov" title="Branch 6 was taken 3865 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 8 was taken 3865 times"> + </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span>][<span class="branchCov" title="Branch 10 was taken 3865 times"> + </span><span class="branchNoCov" title="Branch 11 was not taken"> - </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 12 was taken 3865 times"> + </span><span class="branchNoCov" title="Branch 13 was not taken"> - </span>][<span class="branchCov" title="Branch 14 was taken 3865 times"> + </span><span class="branchNoCov" title="Branch 15 was not taken"> - </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 16 was taken 3865 times"> + </span><span class="branchNoCov" title="Branch 17 was not taken"> - </span>][<span class="branchCov" title="Branch 18 was taken 3865 times"> + </span><span class="branchNoCov" title="Branch 19 was not taken"> - </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 20 was taken 3865 times"> + </span><span class="branchNoCov" title="Branch 21 was not taken"> - </span>][<span class="branchNoCov" title="Branch 22 was not taken"> - </span><span class="branchCov" title="Branch 23 was taken 3865 times"> + </span>]
<span class="lineNum">    6791 </span>                :<span class="lineNoCov">          0 :                                         panic(&quot;bad overwrite, hdr=%p exists=%p&quot;,</span>
<span class="lineNum">    6792 </span>                :            :                                             (void *)hdr, (void *)exists);
<span class="lineNum">    6793 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 3865 times"> + </span>]:<span class="lineCov">       3865 :                                 ASSERT(refcount_is_zero(</span>
<span class="lineNum">    6794 </span>                :            :                                     &amp;exists-&gt;b_l1hdr.b_refcnt));
<span class="lineNum">    6795 </span>                :<span class="lineCov">       3865 :                                 arc_change_state(arc_anon, exists, hash_lock);</span>
<span class="lineNum">    6796 </span>                :<span class="lineCov">       3865 :                                 mutex_exit(hash_lock);</span>
<span class="lineNum">    6797 </span>                :<span class="lineCov">       3865 :                                 arc_hdr_destroy(exists);</span>
<span class="lineNum">    6798 </span>                :<span class="lineCov">       3865 :                                 exists = buf_hash_insert(hdr, &amp;hash_lock);</span>
<span class="lineNum">    6799 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3865 times"> + </span>]:<span class="lineCov">       3865 :                                 ASSERT3P(exists, ==, NULL);</span>
<span class="lineNum">    6800 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 10720 times"> + </span>]:<span class="lineCov">      10721 :                         } else if (zio-&gt;io_flags &amp; ZIO_FLAG_NOPWRITE) {</span>
<span class="lineNum">    6801 </span>                :            :                                 /* nopwrite */
<span class="lineNum">    6802 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                                 ASSERT(zio-&gt;io_prop.zp_nopwrite);</span>
<span class="lineNum">    6803 </span>[<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :                                 if (!BP_EQUAL(&amp;zio-&gt;io_bp_orig, zio-&gt;io_bp))</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchCov" title="Branch 6 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 8 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 9 was not taken"> - </span>][<span class="branchCov" title="Branch 10 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 11 was not taken"> - </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 12 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 13 was not taken"> - </span>][<span class="branchCov" title="Branch 14 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 15 was not taken"> - </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 16 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 17 was not taken"> - </span>][<span class="branchCov" title="Branch 18 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 19 was not taken"> - </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 20 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 21 was not taken"> - </span>][<span class="branchNoCov" title="Branch 22 was not taken"> - </span><span class="branchCov" title="Branch 23 was taken 1 time"> + </span>]
<span class="lineNum">    6804 </span>                :<span class="lineNoCov">          0 :                                         panic(&quot;bad nopwrite, hdr=%p exists=%p&quot;,</span>
<span class="lineNum">    6805 </span>                :            :                                             (void *)hdr, (void *)exists);
<span class="lineNum">    6806 </span>                :            :                         } else {
<span class="lineNum">    6807 </span>                :            :                                 /* Dedup */
<span class="lineNum">    6808 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 10720 times"> + </span>]:<span class="lineCov">      10720 :                                 ASSERT(hdr-&gt;b_l1hdr.b_bufcnt == 1);</span>
<span class="lineNum">    6809 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 10720 times"> + </span>]:<span class="lineCov">      10720 :                                 ASSERT(hdr-&gt;b_l1hdr.b_state == arc_anon);</span>
<span class="lineNum">    6810 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 10720 times"> + </span>]:<span class="lineCov">      10720 :                                 ASSERT(BP_GET_DEDUP(zio-&gt;io_bp));</span>
<span class="lineNum">    6811 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 10720 times"> + </span>]:<span class="lineCov">      10720 :                                 ASSERT(BP_GET_LEVEL(zio-&gt;io_bp) == 0);</span>
<span class="lineNum">    6812 </span>                :            :                         }
<span class="lineNum">    6813 </span>                :            :                 }
<span class="lineNum">    6814 </span>                :<span class="lineCov">     657175 :                 arc_hdr_clear_flags(hdr, ARC_FLAG_IO_IN_PROGRESS);</span>
<span class="lineNum">    6815 </span>                :            :                 /* if it's not anon, we are doing a scrub */
<span class="lineNum">    6816 </span>[<span class="branchCov" title="Branch 0 was taken 646447 times"> + </span><span class="branchCov" title="Branch 1 was taken 10724 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 646444 times"> + </span><span class="branchCov" title="Branch 3 was taken 3 times"> + </span>]:<span class="lineCov">     657171 :                 if (exists == NULL &amp;&amp; hdr-&gt;b_l1hdr.b_state == arc_anon)</span>
<span class="lineNum">    6817 </span>                :<span class="lineCov">     646444 :                         arc_access(hdr, hash_lock);</span>
<span class="lineNum">    6818 </span>                :<span class="lineCov">     657215 :                 mutex_exit(hash_lock);</span>
<span class="lineNum">    6819 </span>                :            :         } else {
<span class="lineNum">    6820 </span>                :<span class="lineCov">      70503 :                 arc_hdr_clear_flags(hdr, ARC_FLAG_IO_IN_PROGRESS);</span>
<span class="lineNum">    6821 </span>                :            :         }
<span class="lineNum">    6822 </span>                :            : 
<span class="lineNum">    6823 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 727715 times"> + </span>]:<span class="lineCov">     727725 :         ASSERT(!refcount_is_zero(&amp;hdr-&gt;b_l1hdr.b_refcnt));</span>
<span class="lineNum">    6824 </span>                :<span class="lineCov">     727715 :         callback-&gt;awcb_done(zio, buf, callback-&gt;awcb_private);</span>
<span class="lineNum">    6825 </span>                :            : 
<span class="lineNum">    6826 </span>                :<span class="lineCov">     727722 :         abd_put(zio-&gt;io_abd);</span>
<span class="lineNum">    6827 </span>                :<span class="lineCov">     727748 :         kmem_free(callback, sizeof (arc_write_callback_t));</span>
<span class="lineNum">    6828 </span>                :<span class="lineCov">     727745 : }</span>
<a name="6829"><span class="lineNum">    6829 </span>                :            : </a>
<span class="lineNum">    6830 </span>                :            : zio_t *
<span class="lineNum">    6831 </span>                :<span class="lineCov">     727674 : arc_write(zio_t *pio, spa_t *spa, uint64_t txg,</span>
<span class="lineNum">    6832 </span>                :            :     blkptr_t *bp, arc_buf_t *buf, boolean_t l2arc,
<span class="lineNum">    6833 </span>                :            :     const zio_prop_t *zp, arc_write_done_func_t *ready,
<span class="lineNum">    6834 </span>                :            :     arc_write_done_func_t *children_ready, arc_write_done_func_t *physdone,
<span class="lineNum">    6835 </span>                :            :     arc_write_done_func_t *done, void *private, zio_priority_t priority,
<span class="lineNum">    6836 </span>                :            :     int zio_flags, const zbookmark_phys_t *zb)
<span class="lineNum">    6837 </span>                :            : {
<span class="lineNum">    6838 </span>                :<span class="lineCov">     727674 :         arc_buf_hdr_t *hdr = buf-&gt;b_hdr;</span>
<span class="lineNum">    6839 </span>                :            :         arc_write_callback_t *callback;
<span class="lineNum">    6840 </span>                :            :         zio_t *zio;
<span class="lineNum">    6841 </span>                :<span class="lineCov">     727674 :         zio_prop_t localprop = *zp;</span>
<span class="lineNum">    6842 </span>                :            : 
<span class="lineNum">    6843 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727674 times"> + </span>]:<span class="lineCov">     727674 :         ASSERT3P(ready, !=, NULL);</span>
<span class="lineNum">    6844 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727674 times"> + </span>]:<span class="lineCov">     727674 :         ASSERT3P(done, !=, NULL);</span>
<span class="lineNum">    6845 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727674 times"> + </span>]:<span class="lineCov">     727674 :         ASSERT(!HDR_IO_ERROR(hdr));</span>
<span class="lineNum">    6846 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727674 times"> + </span>]:<span class="lineCov">     727674 :         ASSERT(!HDR_IO_IN_PROGRESS(hdr));</span>
<span class="lineNum">    6847 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727674 times"> + </span>]:<span class="lineCov">     727674 :         ASSERT3P(hdr-&gt;b_l1hdr.b_acb, ==, NULL);</span>
<span class="lineNum">    6848 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727674 times"> + </span>]:<span class="lineCov">     727674 :         ASSERT3U(hdr-&gt;b_l1hdr.b_bufcnt, &gt;, 0);</span>
<span class="lineNum">    6849 </span>           [<span class="branchCov" title="Branch 0 was taken 727689 times"> + </span>]:<span class="lineCov">     727674 :         if (l2arc)</span>
<span class="lineNum">    6850 </span>                :<span class="lineCov">     727689 :                 arc_hdr_set_flags(hdr, ARC_FLAG_L2CACHE);</span>
<span class="lineNum">    6851 </span>                :            : 
<span class="lineNum">    6852 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727685 times"> + </span>]:<span class="lineCov">     727685 :         if (ARC_BUF_ENCRYPTED(buf)) {</span>
<span class="lineNum">    6853 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT(ARC_BUF_COMPRESSED(buf));</span>
<span class="lineNum">    6854 </span>                :<span class="lineNoCov">          0 :                 localprop.zp_encrypt = B_TRUE;</span>
<span class="lineNum">    6855 </span>                :<span class="lineNoCov">          0 :                 localprop.zp_compress = HDR_GET_COMPRESS(hdr);</span>
<span class="lineNum">    6856 </span>                :<span class="lineNoCov">          0 :                 localprop.zp_byteorder =</span>
<span class="lineNum">    6857 </span>                :<span class="lineNoCov">          0 :                     (hdr-&gt;b_l1hdr.b_byteswap == DMU_BSWAP_NUMFUNCS) ?</span>
<span class="lineNum">    6858 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                     ZFS_HOST_BYTEORDER : !ZFS_HOST_BYTEORDER;</span>
<span class="lineNum">    6859 </span>                :<span class="lineNoCov">          0 :                 bcopy(hdr-&gt;b_crypt_hdr.b_salt, localprop.zp_salt,</span>
<span class="lineNum">    6860 </span>                :            :                     ZIO_DATA_SALT_LEN);
<span class="lineNum">    6861 </span>                :<span class="lineNoCov">          0 :                 bcopy(hdr-&gt;b_crypt_hdr.b_iv, localprop.zp_iv,</span>
<span class="lineNum">    6862 </span>                :            :                     ZIO_DATA_IV_LEN);
<span class="lineNum">    6863 </span>                :<span class="lineNoCov">          0 :                 bcopy(hdr-&gt;b_crypt_hdr.b_mac, localprop.zp_mac,</span>
<span class="lineNum">    6864 </span>                :            :                     ZIO_DATA_MAC_LEN);
<span class="lineNum">    6865 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (DMU_OT_IS_ENCRYPTED(localprop.zp_type)) {</span>
<span class="lineNum">    6866 </span>                :<span class="lineNoCov">          0 :                         localprop.zp_nopwrite = B_FALSE;</span>
<span class="lineNum">    6867 </span>                :<span class="lineNoCov">          0 :                         localprop.zp_copies =</span>
<span class="lineNum">    6868 </span>                :<span class="lineNoCov">          0 :                             MIN(localprop.zp_copies, SPA_DVAS_PER_BP - 1);</span>
<span class="lineNum">    6869 </span>                :            :                 }
<span class="lineNum">    6870 </span>                :<span class="lineNoCov">          0 :                 zio_flags |= ZIO_FLAG_RAW;</span>
<span class="lineNum">    6871 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727685 times"> + </span>]:<span class="lineCov">     727685 :         } else if (ARC_BUF_COMPRESSED(buf)) {</span>
<span class="lineNum">    6872 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3U(HDR_GET_LSIZE(hdr), !=, arc_buf_size(buf));</span>
<span class="lineNum">    6873 </span>                :<span class="lineNoCov">          0 :                 localprop.zp_compress = HDR_GET_COMPRESS(hdr);</span>
<span class="lineNum">    6874 </span>                :<span class="lineNoCov">          0 :                 zio_flags |= ZIO_FLAG_RAW_COMPRESS;</span>
<span class="lineNum">    6875 </span>                :            :         }
<span class="lineNum">    6876 </span>                :<span class="lineCov">     727685 :         callback = kmem_zalloc(sizeof (arc_write_callback_t), KM_SLEEP);</span>
<span class="lineNum">    6877 </span>                :<span class="lineCov">     727655 :         callback-&gt;awcb_ready = ready;</span>
<span class="lineNum">    6878 </span>                :<span class="lineCov">     727655 :         callback-&gt;awcb_children_ready = children_ready;</span>
<span class="lineNum">    6879 </span>                :<span class="lineCov">     727655 :         callback-&gt;awcb_physdone = physdone;</span>
<span class="lineNum">    6880 </span>                :<span class="lineCov">     727655 :         callback-&gt;awcb_done = done;</span>
<span class="lineNum">    6881 </span>                :<span class="lineCov">     727655 :         callback-&gt;awcb_private = private;</span>
<span class="lineNum">    6882 </span>                :<span class="lineCov">     727655 :         callback-&gt;awcb_buf = buf;</span>
<span class="lineNum">    6883 </span>                :            : 
<span class="lineNum">    6884 </span>                :            :         /*
<span class="lineNum">    6885 </span>                :            :          * The hdr's b_pabd is now stale, free it now. A new data block
<span class="lineNum">    6886 </span>                :            :          * will be allocated when the zio pipeline calls arc_write_ready().
<span class="lineNum">    6887 </span>                :            :          */
<span class="lineNum">    6888 </span>        [<span class="branchCov" title="Branch 0 was taken 727646 times"> + </span><span class="branchCov" title="Branch 1 was taken 9 times"> + </span>]:<span class="lineCov">     727655 :         if (hdr-&gt;b_l1hdr.b_pabd != NULL) {</span>
<span class="lineNum">    6889 </span>                :            :                 /*
<span class="lineNum">    6890 </span>                :            :                  * If the buf is currently sharing the data block with
<span class="lineNum">    6891 </span>                :            :                  * the hdr then we need to break that relationship here.
<span class="lineNum">    6892 </span>                :            :                  * The hdr will remain with a NULL data pointer and the
<span class="lineNum">    6893 </span>                :            :                  * buf will take sole ownership of the block.
<span class="lineNum">    6894 </span>                :            :                  */
<span class="lineNum">    6895 </span>        [<span class="branchCov" title="Branch 1 was taken 260052 times"> + </span><span class="branchCov" title="Branch 2 was taken 467607 times"> + </span>]:<span class="lineCov">     727646 :                 if (arc_buf_is_shared(buf)) {</span>
<span class="lineNum">    6896 </span>                :<span class="lineCov">     260052 :                         arc_unshare_buf(hdr, buf);</span>
<span class="lineNum">    6897 </span>                :            :                 } else {
<span class="lineNum">    6898 </span>                :<span class="lineCov">     467607 :                         arc_hdr_free_abd(hdr, B_FALSE);</span>
<span class="lineNum">    6899 </span>                :            :                 }
<span class="lineNum">    6900 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727710 times"> + </span>]:<span class="lineCov">     727710 :                 VERIFY3P(buf-&gt;b_data, !=, NULL);</span>
<span class="lineNum">    6901 </span>                :            :         }
<span class="lineNum">    6902 </span>                :            : 
<span class="lineNum">    6903 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727719 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     727719 :         if (HDR_HAS_RABD(hdr))</span>
<span class="lineNum">    6904 </span>                :<span class="lineNoCov">          0 :                 arc_hdr_free_abd(hdr, B_TRUE);</span>
<span class="lineNum">    6905 </span>                :            : 
<span class="lineNum">    6906 </span>                :<span class="lineCov">     727719 :         arc_hdr_set_compress(hdr, ZIO_COMPRESS_OFF);</span>
<span class="lineNum">    6907 </span>                :            : 
<span class="lineNum">    6908 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 727688 times"> + </span>]:<span class="lineCov">     727682 :         ASSERT(!arc_buf_is_shared(buf));</span>
<span class="lineNum">    6909 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 727688 times"> + </span>]:<span class="lineCov">     727688 :         ASSERT3P(hdr-&gt;b_l1hdr.b_pabd, ==, NULL);</span>
<span class="lineNum">    6910 </span>                :            : 
<span class="lineNum">    6911 </span>        [<span class="branchCov" title="Branch 0 was taken 417363 times"> + </span><span class="branchCov" title="Branch 1 was taken 310325 times"> + </span>]:<span class="lineCov">    1455129 :         zio = zio_write(pio, spa, txg, bp,</span>
<span class="lineNum">    6912 </span>                :<span class="lineCov">     727675 :             abd_get_from_buf(buf-&gt;b_data, HDR_GET_LSIZE(hdr)),</span>
<span class="lineNum">    6913 </span>                :<span class="lineCov">     727675 :             HDR_GET_LSIZE(hdr), arc_buf_size(buf), &amp;localprop, arc_write_ready,</span>
<span class="lineNum">    6914 </span>                :            :             (children_ready != NULL) ? arc_write_children_ready : NULL,
<span class="lineNum">    6915 </span>                :            :             arc_write_physdone, arc_write_done, callback,
<span class="lineNum">    6916 </span>                :            :             priority, zio_flags, zb);
<span class="lineNum">    6917 </span>                :            : 
<span class="lineNum">    6918 </span>                :<span class="lineCov">     727677 :         return (zio);</span>
<span class="lineNum">    6919 </span>                :            : }
<a name="6920"><span class="lineNum">    6920 </span>                :            : </a>
<span class="lineNum">    6921 </span>                :            : static int
<span class="lineNum">    6922 </span>                :<span class="lineCov">     578266 : arc_memory_throttle(uint64_t reserve, uint64_t txg)</span>
<span class="lineNum">    6923 </span>                :            : {
<span class="lineNum">    6924 </span>                :            : #ifdef _KERNEL
<span class="lineNum">    6925 </span>                :            :         uint64_t available_memory = ptob(arc_free_memory());
<span class="lineNum">    6926 </span>                :            :         static uint64_t page_load = 0;
<span class="lineNum">    6927 </span>                :            :         static uint64_t last_txg = 0;
<span class="lineNum">    6928 </span>                :            : #ifdef __linux__
<span class="lineNum">    6929 </span>                :            :         pgcnt_t minfree = btop(arc_sys_free / 4);
<span class="lineNum">    6930 </span>                :            : #endif
<span class="lineNum">    6931 </span>                :            : 
<span class="lineNum">    6932 </span>                :            : #if defined(__i386)
<span class="lineNum">    6933 </span>                :            :         available_memory =
<span class="lineNum">    6934 </span>                :            :             MIN(available_memory, vmem_size(heap_arena, VMEM_FREE));
<span class="lineNum">    6935 </span>                :            : #endif
<span class="lineNum">    6936 </span>                :            : 
<span class="lineNum">    6937 </span>                :            :         if (available_memory &gt; arc_all_memory() * arc_lotsfree_percent / 100)
<span class="lineNum">    6938 </span>                :            :                 return (0);
<span class="lineNum">    6939 </span>                :            : 
<span class="lineNum">    6940 </span>                :            :         if (txg &gt; last_txg) {
<span class="lineNum">    6941 </span>                :            :                 last_txg = txg;
<span class="lineNum">    6942 </span>                :            :                 page_load = 0;
<span class="lineNum">    6943 </span>                :            :         }
<span class="lineNum">    6944 </span>                :            :         /*
<span class="lineNum">    6945 </span>                :            :          * If we are in pageout, we know that memory is already tight,
<span class="lineNum">    6946 </span>                :            :          * the arc is already going to be evicting, so we just want to
<span class="lineNum">    6947 </span>                :            :          * continue to let page writes occur as quickly as possible.
<span class="lineNum">    6948 </span>                :            :          */
<span class="lineNum">    6949 </span>                :            :         if (current_is_kswapd()) {
<span class="lineNum">    6950 </span>                :            :                 if (page_load &gt; MAX(ptob(minfree), available_memory) / 4) {
<span class="lineNum">    6951 </span>                :            :                         DMU_TX_STAT_BUMP(dmu_tx_memory_reclaim);
<span class="lineNum">    6952 </span>                :            :                         return (SET_ERROR(ERESTART));
<span class="lineNum">    6953 </span>                :            :                 }
<span class="lineNum">    6954 </span>                :            :                 /* Note: reserve is inflated, so we deflate */
<span class="lineNum">    6955 </span>                :            :                 page_load += reserve / 8;
<span class="lineNum">    6956 </span>                :            :                 return (0);
<span class="lineNum">    6957 </span>                :            :         } else if (page_load &gt; 0 &amp;&amp; arc_reclaim_needed()) {
<span class="lineNum">    6958 </span>                :            :                 /* memory is low, delay before restarting */
<span class="lineNum">    6959 </span>                :            :                 ARCSTAT_INCR(arcstat_memory_throttle_count, 1);
<span class="lineNum">    6960 </span>                :            :                 DMU_TX_STAT_BUMP(dmu_tx_memory_reclaim);
<span class="lineNum">    6961 </span>                :            :                 return (SET_ERROR(EAGAIN));
<span class="lineNum">    6962 </span>                :            :         }
<span class="lineNum">    6963 </span>                :            :         page_load = 0;
<span class="lineNum">    6964 </span>                :            : #endif
<span class="lineNum">    6965 </span>                :<span class="lineCov">     289133 :         return (0);</span>
<span class="lineNum">    6966 </span>                :            : }
<a name="6967"><span class="lineNum">    6967 </span>                :            : </a>
<span class="lineNum">    6968 </span>                :            : void
<span class="lineNum">    6969 </span>                :<span class="lineCov">     289105 : arc_tempreserve_clear(uint64_t reserve)</span>
<span class="lineNum">    6970 </span>                :            : {
<span class="lineNum">    6971 </span>                :<span class="lineCov">     289105 :         atomic_add_64(&amp;arc_tempreserve, -reserve);</span>
<span class="lineNum">    6972 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 289106 times"> + </span>]:<span class="lineCov">     289106 :         ASSERT((int64_t)arc_tempreserve &gt;= 0);</span>
<span class="lineNum">    6973 </span>                :<span class="lineCov">     289106 : }</span>
<a name="6974"><span class="lineNum">    6974 </span>                :            : </a>
<span class="lineNum">    6975 </span>                :            : int
<span class="lineNum">    6976 </span>                :<span class="lineCov">     289133 : arc_tempreserve_space(uint64_t reserve, uint64_t txg)</span>
<span class="lineNum">    6977 </span>                :            : {
<span class="lineNum">    6978 </span>                :            :         int error;
<span class="lineNum">    6979 </span>                :            :         uint64_t anon_size;
<span class="lineNum">    6980 </span>                :            : 
<span class="lineNum">    6981 </span>[<span class="branchCov" title="Branch 0 was taken 204815 times"> + </span><span class="branchCov" title="Branch 1 was taken 84318 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 204815 times"> + </span>]:<span class="lineCov">     289133 :         if (!arc_no_grow &amp;&amp;</span>
<span class="lineNum">    6982 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             reserve &gt; arc_c/4 &amp;&amp;</span>
<span class="lineNum">    6983 </span>                :<span class="lineNoCov">          0 :             reserve * 4 &gt; (2ULL &lt;&lt; SPA_MAXBLOCKSHIFT))</span>
<span class="lineNum">    6984 </span>                :<span class="lineNoCov">          0 :                 arc_c = MIN(arc_c_max, reserve * 4);</span>
<span class="lineNum">    6985 </span>                :            : 
<span class="lineNum">    6986 </span>                :            :         /*
<span class="lineNum">    6987 </span>                :            :          * Throttle when the calculated memory footprint for the TXG
<span class="lineNum">    6988 </span>                :            :          * exceeds the target ARC size.
<span class="lineNum">    6989 </span>                :            :          */
<span class="lineNum">    6990 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 289133 times"> + </span>]:<span class="lineCov">     289133 :         if (reserve &gt; arc_c) {</span>
<span class="lineNum">    6991 </span>                :<span class="lineNoCov">          0 :                 DMU_TX_STAT_BUMP(dmu_tx_memory_reserve);</span>
<span class="lineNum">    6992 </span>                :<span class="lineNoCov">          0 :                 return (SET_ERROR(ERESTART));</span>
<span class="lineNum">    6993 </span>                :            :         }
<span class="lineNum">    6994 </span>                :            : 
<span class="lineNum">    6995 </span>                :            :         /*
<span class="lineNum">    6996 </span>                :            :          * Don't count loaned bufs as in flight dirty data to prevent long
<span class="lineNum">    6997 </span>                :            :          * network delays from blocking transactions that are ready to be
<span class="lineNum">    6998 </span>                :            :          * assigned to a txg.
<span class="lineNum">    6999 </span>                :            :          */
<span class="lineNum">    7000 </span>                :            : 
<span class="lineNum">    7001 </span>                :            :         /* assert that it has not wrapped around */
<span class="lineNum">    7002 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 289133 times"> + </span>]:<span class="lineCov">     289133 :         ASSERT3S(atomic_add_64_nv(&amp;arc_loaned_bytes, 0), &gt;=, 0);</span>
<span class="lineNum">    7003 </span>                :            : 
<span class="lineNum">    7004 </span>        [<span class="branchCov" title="Branch 1 was taken 289119 times"> + </span><span class="branchCov" title="Branch 2 was taken 14 times"> + </span>]:<span class="lineCov">     289133 :         anon_size = MAX((int64_t)(refcount_count(&amp;arc_anon-&gt;arcs_size) -</span>
<span class="lineNum">    7005 </span>                :            :             arc_loaned_bytes), 0);
<span class="lineNum">    7006 </span>                :            : 
<span class="lineNum">    7007 </span>                :            :         /*
<span class="lineNum">    7008 </span>                :            :          * Writes will, almost always, require additional memory allocations
<span class="lineNum">    7009 </span>                :            :          * in order to compress/encrypt/etc the data.  We therefore need to
<span class="lineNum">    7010 </span>                :            :          * make sure that there is sufficient available memory for this.
<span class="lineNum">    7011 </span>                :            :          */
<span class="lineNum">    7012 </span>                :<span class="lineCov">     289133 :         error = arc_memory_throttle(reserve, txg);</span>
<span class="lineNum">    7013 </span>        [<span class="branchCov" title="Branch 0 was taken 289133 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     289133 :         if (error != 0)</span>
<span class="lineNum">    7014 </span>                :            :                 return (error);
<span class="lineNum">    7015 </span>                :            : 
<span class="lineNum">    7016 </span>                :            :         /*
<span class="lineNum">    7017 </span>                :            :          * Throttle writes when the amount of dirty data in the cache
<span class="lineNum">    7018 </span>                :            :          * gets too large.  We try to keep the cache less than half full
<span class="lineNum">    7019 </span>                :            :          * of dirty blocks so that our sync times don't grow too large.
<span class="lineNum">    7020 </span>                :            :          * Note: if two requests come in concurrently, we might let them
<span class="lineNum">    7021 </span>                :            :          * both succeed, when one of them should fail.  Not a huge deal.
<span class="lineNum">    7022 </span>                :            :          */
<span class="lineNum">    7023 </span>                :            : 
<span class="lineNum">    7024 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 289133 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">     289133 :         if (reserve + arc_tempreserve + anon_size &gt; arc_c / 2 &amp;&amp;</span>
<span class="lineNum">    7025 </span>                :<span class="lineNoCov">          0 :             anon_size &gt; arc_c / 4) {</span>
<span class="lineNum">    7026 </span>                :<span class="lineNoCov">          0 :                 uint64_t meta_esize =</span>
<span class="lineNum">    7027 </span>                :<span class="lineNoCov">          0 :                     refcount_count(&amp;arc_anon-&gt;arcs_esize[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7028 </span>                :<span class="lineNoCov">          0 :                 uint64_t data_esize =</span>
<span class="lineNum">    7029 </span>                :<span class="lineNoCov">          0 :                     refcount_count(&amp;arc_anon-&gt;arcs_esize[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7030 </span>                :<span class="lineNoCov">          0 :                 dprintf(&quot;failing, arc_tempreserve=%lluK anon_meta=%lluK &quot;</span>
<span class="lineNum">    7031 </span>                :            :                     &quot;anon_data=%lluK tempreserve=%lluK arc_c=%lluK\n&quot;,
<span class="lineNum">    7032 </span>                :            :                     arc_tempreserve &gt;&gt; 10, meta_esize &gt;&gt; 10,
<span class="lineNum">    7033 </span>                :            :                     data_esize &gt;&gt; 10, reserve &gt;&gt; 10, arc_c &gt;&gt; 10);
<span class="lineNum">    7034 </span>                :<span class="lineNoCov">          0 :                 DMU_TX_STAT_BUMP(dmu_tx_dirty_throttle);</span>
<span class="lineNum">    7035 </span>                :<span class="lineNoCov">          0 :                 return (SET_ERROR(ERESTART));</span>
<span class="lineNum">    7036 </span>                :            :         }
<span class="lineNum">    7037 </span>                :<span class="lineCov">     289133 :         atomic_add_64(&amp;arc_tempreserve, reserve);</span>
<span class="lineNum">    7038 </span>                :<span class="lineCov">     289133 :         return (0);</span>
<span class="lineNum">    7039 </span>                :            : }
<a name="7040"><span class="lineNum">    7040 </span>                :            : </a>
<span class="lineNum">    7041 </span>                :            : static void
<span class="lineNum">    7042 </span>                :<span class="lineNoCov">          0 : arc_kstat_update_state(arc_state_t *state, kstat_named_t *size,</span>
<span class="lineNum">    7043 </span>                :            :     kstat_named_t *evict_data, kstat_named_t *evict_metadata)
<span class="lineNum">    7044 </span>                :            : {
<span class="lineNum">    7045 </span>                :<span class="lineNoCov">          0 :         size-&gt;value.ui64 = refcount_count(&amp;state-&gt;arcs_size);</span>
<span class="lineNum">    7046 </span>                :<span class="lineNoCov">          0 :         evict_data-&gt;value.ui64 =</span>
<span class="lineNum">    7047 </span>                :<span class="lineNoCov">          0 :             refcount_count(&amp;state-&gt;arcs_esize[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7048 </span>                :<span class="lineNoCov">          0 :         evict_metadata-&gt;value.ui64 =</span>
<span class="lineNum">    7049 </span>                :<span class="lineNoCov">          0 :             refcount_count(&amp;state-&gt;arcs_esize[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7050 </span>                :<span class="lineNoCov">          0 : }</span>
<a name="7051"><span class="lineNum">    7051 </span>                :            : </a>
<span class="lineNum">    7052 </span>                :            : static int
<span class="lineNum">    7053 </span>                :<span class="lineNoCov">          0 : arc_kstat_update(kstat_t *ksp, int rw)</span>
<span class="lineNum">    7054 </span>                :            : {
<span class="lineNum">    7055 </span>                :<span class="lineNoCov">          0 :         arc_stats_t *as = ksp-&gt;ks_data;</span>
<span class="lineNum">    7056 </span>                :            : 
<span class="lineNum">    7057 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (rw == KSTAT_WRITE) {</span>
<span class="lineNum">    7058 </span>                :<span class="lineNoCov">          0 :                 return (SET_ERROR(EACCES));</span>
<span class="lineNum">    7059 </span>                :            :         } else {
<span class="lineNum">    7060 </span>                :<span class="lineNoCov">          0 :                 arc_kstat_update_state(arc_anon,</span>
<span class="lineNum">    7061 </span>                :            :                     &amp;as-&gt;arcstat_anon_size,
<span class="lineNum">    7062 </span>                :            :                     &amp;as-&gt;arcstat_anon_evictable_data,
<span class="lineNum">    7063 </span>                :            :                     &amp;as-&gt;arcstat_anon_evictable_metadata);
<span class="lineNum">    7064 </span>                :<span class="lineNoCov">          0 :                 arc_kstat_update_state(arc_mru,</span>
<span class="lineNum">    7065 </span>                :            :                     &amp;as-&gt;arcstat_mru_size,
<span class="lineNum">    7066 </span>                :            :                     &amp;as-&gt;arcstat_mru_evictable_data,
<span class="lineNum">    7067 </span>                :            :                     &amp;as-&gt;arcstat_mru_evictable_metadata);
<span class="lineNum">    7068 </span>                :<span class="lineNoCov">          0 :                 arc_kstat_update_state(arc_mru_ghost,</span>
<span class="lineNum">    7069 </span>                :            :                     &amp;as-&gt;arcstat_mru_ghost_size,
<span class="lineNum">    7070 </span>                :            :                     &amp;as-&gt;arcstat_mru_ghost_evictable_data,
<span class="lineNum">    7071 </span>                :            :                     &amp;as-&gt;arcstat_mru_ghost_evictable_metadata);
<span class="lineNum">    7072 </span>                :<span class="lineNoCov">          0 :                 arc_kstat_update_state(arc_mfu,</span>
<span class="lineNum">    7073 </span>                :            :                     &amp;as-&gt;arcstat_mfu_size,
<span class="lineNum">    7074 </span>                :            :                     &amp;as-&gt;arcstat_mfu_evictable_data,
<span class="lineNum">    7075 </span>                :            :                     &amp;as-&gt;arcstat_mfu_evictable_metadata);
<span class="lineNum">    7076 </span>                :<span class="lineNoCov">          0 :                 arc_kstat_update_state(arc_mfu_ghost,</span>
<span class="lineNum">    7077 </span>                :            :                     &amp;as-&gt;arcstat_mfu_ghost_size,
<span class="lineNum">    7078 </span>                :            :                     &amp;as-&gt;arcstat_mfu_ghost_evictable_data,
<span class="lineNum">    7079 </span>                :            :                     &amp;as-&gt;arcstat_mfu_ghost_evictable_metadata);
<span class="lineNum">    7080 </span>                :            :         }
<span class="lineNum">    7081 </span>                :            : 
<span class="lineNum">    7082 </span>                :<span class="lineNoCov">          0 :         return (0);</span>
<span class="lineNum">    7083 </span>                :            : }
<span class="lineNum">    7084 </span>                :            : 
<span class="lineNum">    7085 </span>                :            : /*
<span class="lineNum">    7086 </span>                :            :  * This function *must* return indices evenly distributed between all
<span class="lineNum">    7087 </span>                :            :  * sublists of the multilist. This is needed due to how the ARC eviction
<span class="lineNum">    7088 </span>                :            :  * code is laid out; arc_evict_state() assumes ARC buffers are evenly
<span class="lineNum">    7089 </span>                :            :  * distributed between all sublists and uses this assumption when
<span class="lineNum">    7090 </span>                :            :  * deciding which sublist to evict from and how much to evict from it.
<a name="7091"><span class="lineNum">    7091 </span>                :            :  */</a>
<span class="lineNum">    7092 </span>                :            : unsigned int
<span class="lineNum">    7093 </span>                :<span class="lineCov">    1720289 : arc_state_multilist_index_func(multilist_t *ml, void *obj)</span>
<span class="lineNum">    7094 </span>                :            : {
<span class="lineNum">    7095 </span>                :<span class="lineCov">    1720289 :         arc_buf_hdr_t *hdr = obj;</span>
<span class="lineNum">    7096 </span>                :            : 
<span class="lineNum">    7097 </span>                :            :         /*
<span class="lineNum">    7098 </span>                :            :          * We rely on b_dva to generate evenly distributed index
<span class="lineNum">    7099 </span>                :            :          * numbers using buf_hash below. So, as an added precaution,
<span class="lineNum">    7100 </span>                :            :          * let's make sure we never add empty buffers to the arc lists.
<span class="lineNum">    7101 </span>                :            :          */
<span class="lineNum">    7102 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1720289 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    1720289 :         ASSERT(!HDR_EMPTY(hdr));</span>
<span class="lineNum">    7103 </span>                :            : 
<span class="lineNum">    7104 </span>                :            :         /*
<span class="lineNum">    7105 </span>                :            :          * The assumption here, is the hash value for a given
<span class="lineNum">    7106 </span>                :            :          * arc_buf_hdr_t will remain constant throughout its lifetime
<span class="lineNum">    7107 </span>                :            :          * (i.e. its b_spa, b_dva, and b_birth fields don't change).
<span class="lineNum">    7108 </span>                :            :          * Thus, we don't need to store the header's sublist index
<span class="lineNum">    7109 </span>                :            :          * on insertion, as this index can be recalculated on removal.
<span class="lineNum">    7110 </span>                :            :          *
<span class="lineNum">    7111 </span>                :            :          * Also, the low order bits of the hash value are thought to be
<span class="lineNum">    7112 </span>                :            :          * distributed evenly. Otherwise, in the case that the multilist
<span class="lineNum">    7113 </span>                :            :          * has a power of two number of sublists, each sublists' usage
<span class="lineNum">    7114 </span>                :            :          * would not be evenly distributed.
<span class="lineNum">    7115 </span>                :            :          */
<span class="lineNum">    7116 </span>                :<span class="lineCov">    1720289 :         return (buf_hash(hdr-&gt;b_spa, &amp;hdr-&gt;b_dva, hdr-&gt;b_birth) %</span>
<span class="lineNum">    7117 </span>                :<span class="lineCov">    1720291 :             multilist_get_num_sublists(ml));</span>
<span class="lineNum">    7118 </span>                :            : }
<span class="lineNum">    7119 </span>                :            : 
<span class="lineNum">    7120 </span>                :            : /*
<span class="lineNum">    7121 </span>                :            :  * Called during module initialization and periodically thereafter to
<span class="lineNum">    7122 </span>                :            :  * apply reasonable changes to the exposed performance tunings.  Non-zero
<span class="lineNum">    7123 </span>                :            :  * zfs_* values which differ from the currently set values will be applied.
<a name="7124"><span class="lineNum">    7124 </span>                :            :  */</a>
<span class="lineNum">    7125 </span>                :            : static void
<span class="lineNum">    7126 </span>                :<span class="lineCov">      27513 : arc_tuning_update(void)</span>
<span class="lineNum">    7127 </span>                :            : {
<span class="lineNum">    7128 </span>                :<span class="lineCov">      27513 :         uint64_t allmem = arc_all_memory();</span>
<span class="lineNum">    7129 </span>                :            :         unsigned long limit;
<span class="lineNum">    7130 </span>                :            : 
<span class="lineNum">    7131 </span>                :            :         /* Valid range: 64M - &lt;all physical memory&gt; */
<span class="lineNum">    7132 </span>[<span class="branchCov" title="Branch 0 was taken 10146 times"> + </span><span class="branchCov" title="Branch 1 was taken 17367 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 10146 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">      27513 :         if ((zfs_arc_max) &amp;&amp; (zfs_arc_max != arc_c_max) &amp;&amp;</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 10146 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]
<span class="lineNum">    7133 </span>[<span class="branchCov" title="Branch 0 was taken 10146 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 10146 times"> + </span>]:<span class="lineCov">      10146 :             (zfs_arc_max &gt; 64 &lt;&lt; 20) &amp;&amp; (zfs_arc_max &lt; allmem) &amp;&amp;</span>
<span class="lineNum">    7134 </span>                :<span class="lineCov">      10146 :             (zfs_arc_max &gt; arc_c_min)) {</span>
<span class="lineNum">    7135 </span>                :<span class="lineNoCov">          0 :                 arc_c_max = zfs_arc_max;</span>
<span class="lineNum">    7136 </span>                :<span class="lineNoCov">          0 :                 arc_c = arc_c_max;</span>
<span class="lineNum">    7137 </span>                :<span class="lineNoCov">          0 :                 arc_p = (arc_c &gt;&gt; 1);</span>
<span class="lineNum">    7138 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (arc_meta_limit &gt; arc_c_max)</span>
<span class="lineNum">    7139 </span>                :<span class="lineNoCov">          0 :                         arc_meta_limit = arc_c_max;</span>
<span class="lineNum">    7140 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (arc_dnode_limit &gt; arc_meta_limit)</span>
<span class="lineNum">    7141 </span>                :<span class="lineNoCov">          0 :                         arc_dnode_limit = arc_meta_limit;</span>
<span class="lineNum">    7142 </span>                :            :         }
<span class="lineNum">    7143 </span>                :            : 
<span class="lineNum">    7144 </span>                :            :         /* Valid range: 32M - &lt;arc_c_max&gt; */
<span class="lineNum">    7145 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 27513 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">      27513 :         if ((zfs_arc_min) &amp;&amp; (zfs_arc_min != arc_c_min) &amp;&amp;</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    7146 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             (zfs_arc_min &gt;= 2ULL &lt;&lt; SPA_MAXBLOCKSHIFT) &amp;&amp;</span>
<span class="lineNum">    7147 </span>                :<span class="lineNoCov">          0 :             (zfs_arc_min &lt;= arc_c_max)) {</span>
<span class="lineNum">    7148 </span>                :<span class="lineNoCov">          0 :                 arc_c_min = zfs_arc_min;</span>
<span class="lineNum">    7149 </span>                :<span class="lineNoCov">          0 :                 arc_c = MAX(arc_c, arc_c_min);</span>
<span class="lineNum">    7150 </span>                :            :         }
<span class="lineNum">    7151 </span>                :            : 
<span class="lineNum">    7152 </span>                :            :         /* Valid range: 16M - &lt;arc_c_max&gt; */
<span class="lineNum">    7153 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 27513 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">      27513 :         if ((zfs_arc_meta_min) &amp;&amp; (zfs_arc_meta_min != arc_meta_min) &amp;&amp;</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    7154 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             (zfs_arc_meta_min &gt;= 1ULL &lt;&lt; SPA_MAXBLOCKSHIFT) &amp;&amp;</span>
<span class="lineNum">    7155 </span>                :<span class="lineNoCov">          0 :             (zfs_arc_meta_min &lt;= arc_c_max)) {</span>
<span class="lineNum">    7156 </span>                :<span class="lineNoCov">          0 :                 arc_meta_min = zfs_arc_meta_min;</span>
<span class="lineNum">    7157 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (arc_meta_limit &lt; arc_meta_min)</span>
<span class="lineNum">    7158 </span>                :<span class="lineNoCov">          0 :                         arc_meta_limit = arc_meta_min;</span>
<span class="lineNum">    7159 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (arc_dnode_limit &lt; arc_meta_min)</span>
<span class="lineNum">    7160 </span>                :<span class="lineNoCov">          0 :                         arc_dnode_limit = arc_meta_min;</span>
<span class="lineNum">    7161 </span>                :            :         }
<span class="lineNum">    7162 </span>                :            : 
<span class="lineNum">    7163 </span>                :            :         /* Valid range: &lt;arc_meta_min&gt; - &lt;arc_c_max&gt; */
<span class="lineNum">    7164 </span>        [<span class="branchCov" title="Branch 0 was taken 17367 times"> + </span><span class="branchCov" title="Branch 1 was taken 10146 times"> + </span>]:<span class="lineCov">      27513 :         limit = zfs_arc_meta_limit ? zfs_arc_meta_limit :</span>
<span class="lineNum">    7165 </span>                :<span class="lineCov">      17367 :             MIN(zfs_arc_meta_limit_percent, 100) * arc_c_max / 100;</span>
<span class="lineNum">    7166 </span>[<span class="branchCov" title="Branch 0 was taken 880 times"> + </span><span class="branchCov" title="Branch 1 was taken 26633 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 880 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">      27513 :         if ((limit != arc_meta_limit) &amp;&amp;</span>
<span class="lineNum">    7167 </span>        [<span class="branchCov" title="Branch 0 was taken 880 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        880 :             (limit &gt;= arc_meta_min) &amp;&amp;</span>
<span class="lineNum">    7168 </span>                :<span class="lineCov">        880 :             (limit &lt;= arc_c_max))</span>
<span class="lineNum">    7169 </span>                :<span class="lineCov">        880 :                 arc_meta_limit = limit;</span>
<span class="lineNum">    7170 </span>                :            : 
<span class="lineNum">    7171 </span>                :            :         /* Valid range: &lt;arc_meta_min&gt; - &lt;arc_meta_limit&gt; */
<span class="lineNum">    7172 </span>        [<span class="branchCov" title="Branch 0 was taken 27513 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      27513 :         limit = zfs_arc_dnode_limit ? zfs_arc_dnode_limit :</span>
<span class="lineNum">    7173 </span>                :<span class="lineCov">      27513 :             MIN(zfs_arc_dnode_limit_percent, 100) * arc_meta_limit / 100;</span>
<span class="lineNum">    7174 </span>[<span class="branchCov" title="Branch 0 was taken 880 times"> + </span><span class="branchCov" title="Branch 1 was taken 26633 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 880 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">      27513 :         if ((limit != arc_dnode_limit) &amp;&amp;</span>
<span class="lineNum">    7175 </span>        [<span class="branchCov" title="Branch 0 was taken 880 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        880 :             (limit &gt;= arc_meta_min) &amp;&amp;</span>
<span class="lineNum">    7176 </span>                :<span class="lineCov">        880 :             (limit &lt;= arc_meta_limit))</span>
<span class="lineNum">    7177 </span>                :<span class="lineCov">        880 :                 arc_dnode_limit = limit;</span>
<span class="lineNum">    7178 </span>                :            : 
<span class="lineNum">    7179 </span>                :            :         /* Valid range: 1 - N */
<span class="lineNum">    7180 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 27513 times"> + </span>]:<span class="lineCov">      27513 :         if (zfs_arc_grow_retry)</span>
<span class="lineNum">    7181 </span>                :<span class="lineNoCov">          0 :                 arc_grow_retry = zfs_arc_grow_retry;</span>
<span class="lineNum">    7182 </span>                :            : 
<span class="lineNum">    7183 </span>                :            :         /* Valid range: 1 - N */
<span class="lineNum">    7184 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 27513 times"> + </span>]:<span class="lineCov">      27513 :         if (zfs_arc_shrink_shift) {</span>
<span class="lineNum">    7185 </span>                :<span class="lineNoCov">          0 :                 arc_shrink_shift = zfs_arc_shrink_shift;</span>
<span class="lineNum">    7186 </span>                :<span class="lineNoCov">          0 :                 arc_no_grow_shift = MIN(arc_no_grow_shift, arc_shrink_shift -1);</span>
<span class="lineNum">    7187 </span>                :            :         }
<span class="lineNum">    7188 </span>                :            : 
<span class="lineNum">    7189 </span>                :            :         /* Valid range: 1 - N */
<span class="lineNum">    7190 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 27513 times"> + </span>]:<span class="lineCov">      27513 :         if (zfs_arc_p_min_shift)</span>
<span class="lineNum">    7191 </span>                :<span class="lineNoCov">          0 :                 arc_p_min_shift = zfs_arc_p_min_shift;</span>
<span class="lineNum">    7192 </span>                :            : 
<span class="lineNum">    7193 </span>                :            :         /* Valid range: 1 - N ticks */
<span class="lineNum">    7194 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 27513 times"> + </span>]:<span class="lineCov">      27513 :         if (zfs_arc_min_prefetch_lifespan)</span>
<span class="lineNum">    7195 </span>                :<span class="lineNoCov">          0 :                 arc_min_prefetch_lifespan = zfs_arc_min_prefetch_lifespan;</span>
<span class="lineNum">    7196 </span>                :            : 
<span class="lineNum">    7197 </span>                :            :         /* Valid range: 0 - 100 */
<span class="lineNum">    7198 </span>        [<span class="branchCov" title="Branch 0 was taken 27513 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      27513 :         if ((zfs_arc_lotsfree_percent &gt;= 0) &amp;&amp;</span>
<span class="lineNum">    7199 </span>                :            :             (zfs_arc_lotsfree_percent &lt;= 100))
<span class="lineNum">    7200 </span>                :<span class="lineCov">      27513 :                 arc_lotsfree_percent = zfs_arc_lotsfree_percent;</span>
<span class="lineNum">    7201 </span>                :            : 
<span class="lineNum">    7202 </span>                :            :         /* Valid range: 0 - &lt;all physical memory&gt; */
<span class="lineNum">    7203 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 27513 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">      27513 :         if ((zfs_arc_sys_free) &amp;&amp; (zfs_arc_sys_free != arc_sys_free))</span>
<span class="lineNum">    7204 </span>                :<span class="lineNoCov">          0 :                 arc_sys_free = MIN(MAX(zfs_arc_sys_free, 0), allmem);</span>
<span class="lineNum">    7205 </span>                :            : 
<span class="lineNum">    7206 </span>                :<span class="lineCov">      27513 : }</span>
<a name="7207"><span class="lineNum">    7207 </span>                :            : </a>
<span class="lineNum">    7208 </span>                :            : static void
<span class="lineNum">    7209 </span>                :<span class="lineCov">       1234 : arc_state_init(void)</span>
<span class="lineNum">    7210 </span>                :            : {
<span class="lineNum">    7211 </span>                :<span class="lineCov">       1234 :         arc_anon = &amp;ARC_anon;</span>
<span class="lineNum">    7212 </span>                :<span class="lineCov">       1234 :         arc_mru = &amp;ARC_mru;</span>
<span class="lineNum">    7213 </span>                :<span class="lineCov">       1234 :         arc_mru_ghost = &amp;ARC_mru_ghost;</span>
<span class="lineNum">    7214 </span>                :<span class="lineCov">       1234 :         arc_mfu = &amp;ARC_mfu;</span>
<span class="lineNum">    7215 </span>                :<span class="lineCov">       1234 :         arc_mfu_ghost = &amp;ARC_mfu_ghost;</span>
<span class="lineNum">    7216 </span>                :<span class="lineCov">       1234 :         arc_l2c_only = &amp;ARC_l2c_only;</span>
<span class="lineNum">    7217 </span>                :            : 
<span class="lineNum">    7218 </span>                :<span class="lineCov">       1234 :         arc_mru-&gt;arcs_list[ARC_BUFC_METADATA] =</span>
<span class="lineNum">    7219 </span>                :<span class="lineCov">       1234 :             multilist_create(sizeof (arc_buf_hdr_t),</span>
<span class="lineNum">    7220 </span>                :            :             offsetof(arc_buf_hdr_t, b_l1hdr.b_arc_node),
<span class="lineNum">    7221 </span>                :            :             arc_state_multilist_index_func);
<span class="lineNum">    7222 </span>                :<span class="lineCov">       2468 :         arc_mru-&gt;arcs_list[ARC_BUFC_DATA] =</span>
<span class="lineNum">    7223 </span>                :<span class="lineCov">       1234 :             multilist_create(sizeof (arc_buf_hdr_t),</span>
<span class="lineNum">    7224 </span>                :            :             offsetof(arc_buf_hdr_t, b_l1hdr.b_arc_node),
<span class="lineNum">    7225 </span>                :            :             arc_state_multilist_index_func);
<span class="lineNum">    7226 </span>                :<span class="lineCov">       2468 :         arc_mru_ghost-&gt;arcs_list[ARC_BUFC_METADATA] =</span>
<span class="lineNum">    7227 </span>                :<span class="lineCov">       1234 :             multilist_create(sizeof (arc_buf_hdr_t),</span>
<span class="lineNum">    7228 </span>                :            :             offsetof(arc_buf_hdr_t, b_l1hdr.b_arc_node),
<span class="lineNum">    7229 </span>                :            :             arc_state_multilist_index_func);
<span class="lineNum">    7230 </span>                :<span class="lineCov">       2468 :         arc_mru_ghost-&gt;arcs_list[ARC_BUFC_DATA] =</span>
<span class="lineNum">    7231 </span>                :<span class="lineCov">       1234 :             multilist_create(sizeof (arc_buf_hdr_t),</span>
<span class="lineNum">    7232 </span>                :            :             offsetof(arc_buf_hdr_t, b_l1hdr.b_arc_node),
<span class="lineNum">    7233 </span>                :            :             arc_state_multilist_index_func);
<span class="lineNum">    7234 </span>                :<span class="lineCov">       2468 :         arc_mfu-&gt;arcs_list[ARC_BUFC_METADATA] =</span>
<span class="lineNum">    7235 </span>                :<span class="lineCov">       1234 :             multilist_create(sizeof (arc_buf_hdr_t),</span>
<span class="lineNum">    7236 </span>                :            :             offsetof(arc_buf_hdr_t, b_l1hdr.b_arc_node),
<span class="lineNum">    7237 </span>                :            :             arc_state_multilist_index_func);
<span class="lineNum">    7238 </span>                :<span class="lineCov">       2468 :         arc_mfu-&gt;arcs_list[ARC_BUFC_DATA] =</span>
<span class="lineNum">    7239 </span>                :<span class="lineCov">       1234 :             multilist_create(sizeof (arc_buf_hdr_t),</span>
<span class="lineNum">    7240 </span>                :            :             offsetof(arc_buf_hdr_t, b_l1hdr.b_arc_node),
<span class="lineNum">    7241 </span>                :            :             arc_state_multilist_index_func);
<span class="lineNum">    7242 </span>                :<span class="lineCov">       2468 :         arc_mfu_ghost-&gt;arcs_list[ARC_BUFC_METADATA] =</span>
<span class="lineNum">    7243 </span>                :<span class="lineCov">       1234 :             multilist_create(sizeof (arc_buf_hdr_t),</span>
<span class="lineNum">    7244 </span>                :            :             offsetof(arc_buf_hdr_t, b_l1hdr.b_arc_node),
<span class="lineNum">    7245 </span>                :            :             arc_state_multilist_index_func);
<span class="lineNum">    7246 </span>                :<span class="lineCov">       2468 :         arc_mfu_ghost-&gt;arcs_list[ARC_BUFC_DATA] =</span>
<span class="lineNum">    7247 </span>                :<span class="lineCov">       1234 :             multilist_create(sizeof (arc_buf_hdr_t),</span>
<span class="lineNum">    7248 </span>                :            :             offsetof(arc_buf_hdr_t, b_l1hdr.b_arc_node),
<span class="lineNum">    7249 </span>                :            :             arc_state_multilist_index_func);
<span class="lineNum">    7250 </span>                :<span class="lineCov">       2468 :         arc_l2c_only-&gt;arcs_list[ARC_BUFC_METADATA] =</span>
<span class="lineNum">    7251 </span>                :<span class="lineCov">       1234 :             multilist_create(sizeof (arc_buf_hdr_t),</span>
<span class="lineNum">    7252 </span>                :            :             offsetof(arc_buf_hdr_t, b_l1hdr.b_arc_node),
<span class="lineNum">    7253 </span>                :            :             arc_state_multilist_index_func);
<span class="lineNum">    7254 </span>                :<span class="lineCov">       2468 :         arc_l2c_only-&gt;arcs_list[ARC_BUFC_DATA] =</span>
<span class="lineNum">    7255 </span>                :<span class="lineCov">       1234 :             multilist_create(sizeof (arc_buf_hdr_t),</span>
<span class="lineNum">    7256 </span>                :            :             offsetof(arc_buf_hdr_t, b_l1hdr.b_arc_node),
<span class="lineNum">    7257 </span>                :            :             arc_state_multilist_index_func);
<span class="lineNum">    7258 </span>                :            : 
<span class="lineNum">    7259 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_anon-&gt;arcs_esize[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7260 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_anon-&gt;arcs_esize[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7261 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_mru-&gt;arcs_esize[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7262 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_mru-&gt;arcs_esize[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7263 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_mru_ghost-&gt;arcs_esize[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7264 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_mru_ghost-&gt;arcs_esize[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7265 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_mfu-&gt;arcs_esize[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7266 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_mfu-&gt;arcs_esize[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7267 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_mfu_ghost-&gt;arcs_esize[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7268 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_mfu_ghost-&gt;arcs_esize[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7269 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_l2c_only-&gt;arcs_esize[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7270 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_l2c_only-&gt;arcs_esize[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7271 </span>                :            : 
<span class="lineNum">    7272 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_anon-&gt;arcs_size);</span>
<span class="lineNum">    7273 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_mru-&gt;arcs_size);</span>
<span class="lineNum">    7274 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_mru_ghost-&gt;arcs_size);</span>
<span class="lineNum">    7275 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_mfu-&gt;arcs_size);</span>
<span class="lineNum">    7276 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_mfu_ghost-&gt;arcs_size);</span>
<span class="lineNum">    7277 </span>                :<span class="lineCov">       1234 :         refcount_create(&amp;arc_l2c_only-&gt;arcs_size);</span>
<span class="lineNum">    7278 </span>                :            : 
<span class="lineNum">    7279 </span>                :<span class="lineCov">       1234 :         arc_anon-&gt;arcs_state = ARC_STATE_ANON;</span>
<span class="lineNum">    7280 </span>                :<span class="lineCov">       1234 :         arc_mru-&gt;arcs_state = ARC_STATE_MRU;</span>
<span class="lineNum">    7281 </span>                :<span class="lineCov">       1234 :         arc_mru_ghost-&gt;arcs_state = ARC_STATE_MRU_GHOST;</span>
<span class="lineNum">    7282 </span>                :<span class="lineCov">       1234 :         arc_mfu-&gt;arcs_state = ARC_STATE_MFU;</span>
<span class="lineNum">    7283 </span>                :<span class="lineCov">       1234 :         arc_mfu_ghost-&gt;arcs_state = ARC_STATE_MFU_GHOST;</span>
<span class="lineNum">    7284 </span>                :<span class="lineCov">       1234 :         arc_l2c_only-&gt;arcs_state = ARC_STATE_L2C_ONLY;</span>
<span class="lineNum">    7285 </span>                :<span class="lineCov">       1234 : }</span>
<a name="7286"><span class="lineNum">    7286 </span>                :            : </a>
<span class="lineNum">    7287 </span>                :            : static void
<span class="lineNum">    7288 </span>                :<span class="lineCov">        785 : arc_state_fini(void)</span>
<span class="lineNum">    7289 </span>                :            : {
<span class="lineNum">    7290 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_anon-&gt;arcs_esize[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7291 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_anon-&gt;arcs_esize[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7292 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_mru-&gt;arcs_esize[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7293 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_mru-&gt;arcs_esize[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7294 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_mru_ghost-&gt;arcs_esize[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7295 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_mru_ghost-&gt;arcs_esize[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7296 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_mfu-&gt;arcs_esize[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7297 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_mfu-&gt;arcs_esize[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7298 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_mfu_ghost-&gt;arcs_esize[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7299 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_mfu_ghost-&gt;arcs_esize[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7300 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_l2c_only-&gt;arcs_esize[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7301 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_l2c_only-&gt;arcs_esize[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7302 </span>                :            : 
<span class="lineNum">    7303 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_anon-&gt;arcs_size);</span>
<span class="lineNum">    7304 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_mru-&gt;arcs_size);</span>
<span class="lineNum">    7305 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_mru_ghost-&gt;arcs_size);</span>
<span class="lineNum">    7306 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_mfu-&gt;arcs_size);</span>
<span class="lineNum">    7307 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_mfu_ghost-&gt;arcs_size);</span>
<span class="lineNum">    7308 </span>                :<span class="lineCov">        785 :         refcount_destroy(&amp;arc_l2c_only-&gt;arcs_size);</span>
<span class="lineNum">    7309 </span>                :            : 
<span class="lineNum">    7310 </span>                :<span class="lineCov">        785 :         multilist_destroy(arc_mru-&gt;arcs_list[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7311 </span>                :<span class="lineCov">        785 :         multilist_destroy(arc_mru_ghost-&gt;arcs_list[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7312 </span>                :<span class="lineCov">        785 :         multilist_destroy(arc_mfu-&gt;arcs_list[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7313 </span>                :<span class="lineCov">        785 :         multilist_destroy(arc_mfu_ghost-&gt;arcs_list[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7314 </span>                :<span class="lineCov">        785 :         multilist_destroy(arc_mru-&gt;arcs_list[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7315 </span>                :<span class="lineCov">        785 :         multilist_destroy(arc_mru_ghost-&gt;arcs_list[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7316 </span>                :<span class="lineCov">        785 :         multilist_destroy(arc_mfu-&gt;arcs_list[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7317 </span>                :<span class="lineCov">        785 :         multilist_destroy(arc_mfu_ghost-&gt;arcs_list[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7318 </span>                :<span class="lineCov">        785 :         multilist_destroy(arc_l2c_only-&gt;arcs_list[ARC_BUFC_METADATA]);</span>
<span class="lineNum">    7319 </span>                :<span class="lineCov">        785 :         multilist_destroy(arc_l2c_only-&gt;arcs_list[ARC_BUFC_DATA]);</span>
<span class="lineNum">    7320 </span>                :<span class="lineCov">        785 : }</span>
<a name="7321"><span class="lineNum">    7321 </span>                :            : </a>
<span class="lineNum">    7322 </span>                :            : uint64_t
<span class="lineNum">    7323 </span>                :<span class="lineCov">       1234 : arc_max_bytes(void)</span>
<span class="lineNum">    7324 </span>                :            : {
<span class="lineNum">    7325 </span>                :<span class="lineCov">       1234 :         return (arc_c_max);</span>
<span class="lineNum">    7326 </span>                :            : }
<a name="7327"><span class="lineNum">    7327 </span>                :            : </a>
<span class="lineNum">    7328 </span>                :            : void
<span class="lineNum">    7329 </span>                :<span class="lineCov">       1234 : arc_init(void)</span>
<span class="lineNum">    7330 </span>                :            : {
<span class="lineNum">    7331 </span>                :<span class="lineCov">       1234 :         uint64_t percent, allmem = arc_all_memory();</span>
<span class="lineNum">    7332 </span>                :            : 
<span class="lineNum">    7333 </span>                :<span class="lineCov">       1234 :         mutex_init(&amp;arc_reclaim_lock, NULL, MUTEX_DEFAULT, NULL);</span>
<span class="lineNum">    7334 </span>                :<span class="lineCov">       1234 :         cv_init(&amp;arc_reclaim_thread_cv, NULL, CV_DEFAULT, NULL);</span>
<span class="lineNum">    7335 </span>                :<span class="lineCov">       1234 :         cv_init(&amp;arc_reclaim_waiters_cv, NULL, CV_DEFAULT, NULL);</span>
<span class="lineNum">    7336 </span>                :            : 
<span class="lineNum">    7337 </span>                :            :         /* Convert seconds to clock ticks */
<span class="lineNum">    7338 </span>                :<span class="lineCov">       1234 :         arc_min_prefetch_lifespan = 1 * hz;</span>
<span class="lineNum">    7339 </span>                :            : 
<span class="lineNum">    7340 </span>                :            : #ifdef _KERNEL
<span class="lineNum">    7341 </span>                :            :         /*
<span class="lineNum">    7342 </span>                :            :          * Register a shrinker to support synchronous (direct) memory
<span class="lineNum">    7343 </span>                :            :          * reclaim from the arc.  This is done to prevent kswapd from
<span class="lineNum">    7344 </span>                :            :          * swapping out pages when it is preferable to shrink the arc.
<span class="lineNum">    7345 </span>                :            :          */
<span class="lineNum">    7346 </span>                :            :         spl_register_shrinker(&amp;arc_shrinker);
<span class="lineNum">    7347 </span>                :            : 
<span class="lineNum">    7348 </span>                :            :         /* Set to 1/64 of all memory or a minimum of 512K */
<span class="lineNum">    7349 </span>                :            :         arc_sys_free = MAX(allmem / 64, (512 * 1024));
<span class="lineNum">    7350 </span>                :            :         arc_need_free = 0;
<span class="lineNum">    7351 </span>                :            : #endif
<span class="lineNum">    7352 </span>                :            : 
<span class="lineNum">    7353 </span>                :            :         /* Set max to 1/2 of all memory */
<span class="lineNum">    7354 </span>                :<span class="lineCov">       1234 :         arc_c_max = allmem / 2;</span>
<span class="lineNum">    7355 </span>                :            : 
<span class="lineNum">    7356 </span>                :            : #ifdef  _KERNEL
<span class="lineNum">    7357 </span>                :            :         /* Set min cache to 1/32 of all memory, or 32MB, whichever is more */
<span class="lineNum">    7358 </span>                :            :         arc_c_min = MAX(allmem / 32, 2ULL &lt;&lt; SPA_MAXBLOCKSHIFT);
<span class="lineNum">    7359 </span>                :            : #else
<span class="lineNum">    7360 </span>                :            :         /*
<span class="lineNum">    7361 </span>                :            :          * In userland, there's only the memory pressure that we artificially
<span class="lineNum">    7362 </span>                :            :          * create (see arc_available_memory()).  Don't let arc_c get too
<span class="lineNum">    7363 </span>                :            :          * small, because it can cause transactions to be larger than
<span class="lineNum">    7364 </span>                :            :          * arc_c, causing arc_tempreserve_space() to fail.
<span class="lineNum">    7365 </span>                :            :          */
<span class="lineNum">    7366 </span>        [<span class="branchCov" title="Branch 0 was taken 1234 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1234 :         arc_c_min = MAX(arc_c_max / 2, 2ULL &lt;&lt; SPA_MAXBLOCKSHIFT);</span>
<span class="lineNum">    7367 </span>                :            : #endif
<span class="lineNum">    7368 </span>                :            : 
<span class="lineNum">    7369 </span>                :<span class="lineCov">       1234 :         arc_c = arc_c_max;</span>
<span class="lineNum">    7370 </span>                :<span class="lineCov">       1234 :         arc_p = (arc_c &gt;&gt; 1);</span>
<span class="lineNum">    7371 </span>                :<span class="lineCov">       1234 :         arc_size = 0;</span>
<span class="lineNum">    7372 </span>                :            : 
<span class="lineNum">    7373 </span>                :            :         /* Set min to 1/2 of arc_c_min */
<span class="lineNum">    7374 </span>                :<span class="lineCov">       1234 :         arc_meta_min = 1ULL &lt;&lt; SPA_MAXBLOCKSHIFT;</span>
<span class="lineNum">    7375 </span>                :            :         /* Initialize maximum observed usage to zero */
<span class="lineNum">    7376 </span>                :<span class="lineCov">       1234 :         arc_meta_max = 0;</span>
<span class="lineNum">    7377 </span>                :            :         /*
<span class="lineNum">    7378 </span>                :            :          * Set arc_meta_limit to a percent of arc_c_max with a floor of
<span class="lineNum">    7379 </span>                :            :          * arc_meta_min, and a ceiling of arc_c_max.
<span class="lineNum">    7380 </span>                :            :          */
<span class="lineNum">    7381 </span>                :<span class="lineCov">       1234 :         percent = MIN(zfs_arc_meta_limit_percent, 100);</span>
<span class="lineNum">    7382 </span>                :<span class="lineCov">       1234 :         arc_meta_limit = MAX(arc_meta_min, (percent * arc_c_max) / 100);</span>
<span class="lineNum">    7383 </span>                :<span class="lineCov">       1234 :         percent = MIN(zfs_arc_dnode_limit_percent, 100);</span>
<span class="lineNum">    7384 </span>                :<span class="lineCov">       1234 :         arc_dnode_limit = (percent * arc_meta_limit) / 100;</span>
<span class="lineNum">    7385 </span>                :            : 
<span class="lineNum">    7386 </span>                :            :         /* Apply user specified tunings */
<span class="lineNum">    7387 </span>                :<span class="lineCov">       1234 :         arc_tuning_update();</span>
<span class="lineNum">    7388 </span>                :            : 
<span class="lineNum">    7389 </span>                :            :         /* if kmem_flags are set, lets try to use less memory */
<span class="lineNum">    7390 </span>                :            :         if (kmem_debugging())
<span class="lineNum">    7391 </span>                :            :                 arc_c = arc_c / 2;
<span class="lineNum">    7392 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1234 times"> + </span>]:<span class="lineCov">       1234 :         if (arc_c &lt; arc_c_min)</span>
<span class="lineNum">    7393 </span>                :<span class="lineNoCov">          0 :                 arc_c = arc_c_min;</span>
<span class="lineNum">    7394 </span>                :            : 
<span class="lineNum">    7395 </span>                :<span class="lineCov">       1234 :         arc_state_init();</span>
<span class="lineNum">    7396 </span>                :<span class="lineCov">       1234 :         buf_init();</span>
<span class="lineNum">    7397 </span>                :            : 
<span class="lineNum">    7398 </span>                :<span class="lineCov">       1234 :         list_create(&amp;arc_prune_list, sizeof (arc_prune_t),</span>
<span class="lineNum">    7399 </span>                :            :             offsetof(arc_prune_t, p_node));
<span class="lineNum">    7400 </span>                :<span class="lineCov">       1234 :         mutex_init(&amp;arc_prune_mtx, NULL, MUTEX_DEFAULT, NULL);</span>
<span class="lineNum">    7401 </span>                :            : 
<span class="lineNum">    7402 </span>                :<span class="lineCov">       1234 :         arc_prune_taskq = taskq_create(&quot;arc_prune&quot;, max_ncpus, defclsyspri,</span>
<span class="lineNum">    7403 </span>                :            :             max_ncpus, INT_MAX, TASKQ_PREPOPULATE | TASKQ_DYNAMIC);
<span class="lineNum">    7404 </span>                :            : 
<span class="lineNum">    7405 </span>                :<span class="lineCov">       1234 :         arc_reclaim_thread_exit = B_FALSE;</span>
<span class="lineNum">    7406 </span>                :            : 
<span class="lineNum">    7407 </span>                :<span class="lineCov">       1234 :         arc_ksp = kstat_create(&quot;zfs&quot;, 0, &quot;arcstats&quot;, &quot;misc&quot;, KSTAT_TYPE_NAMED,</span>
<span class="lineNum">    7408 </span>                :            :             sizeof (arc_stats) / sizeof (kstat_named_t), KSTAT_FLAG_VIRTUAL);
<span class="lineNum">    7409 </span>                :            : 
<span class="lineNum">    7410 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1234 times"> + </span>]:<span class="lineCov">       1234 :         if (arc_ksp != NULL) {</span>
<span class="lineNum">    7411 </span>                :<span class="lineNoCov">          0 :                 arc_ksp-&gt;ks_data = &amp;arc_stats;</span>
<span class="lineNum">    7412 </span>                :<span class="lineNoCov">          0 :                 arc_ksp-&gt;ks_update = arc_kstat_update;</span>
<span class="lineNum">    7413 </span>                :<span class="lineNoCov">          0 :                 kstat_install(arc_ksp);</span>
<span class="lineNum">    7414 </span>                :            :         }
<span class="lineNum">    7415 </span>                :            : 
<span class="lineNum">    7416 </span>                :<span class="lineCov">       1234 :         (void) thread_create(NULL, 0, arc_reclaim_thread, NULL, 0, &amp;p0,</span>
<span class="lineNum">    7417 </span>                :            :             TS_RUN, defclsyspri);
<span class="lineNum">    7418 </span>                :            : 
<span class="lineNum">    7419 </span>                :<span class="lineCov">       1234 :         arc_dead = B_FALSE;</span>
<span class="lineNum">    7420 </span>                :<span class="lineCov">       1234 :         arc_warm = B_FALSE;</span>
<span class="lineNum">    7421 </span>                :            : 
<span class="lineNum">    7422 </span>                :            :         /*
<span class="lineNum">    7423 </span>                :            :          * Calculate maximum amount of dirty data per pool.
<span class="lineNum">    7424 </span>                :            :          *
<span class="lineNum">    7425 </span>                :            :          * If it has been set by a module parameter, take that.
<span class="lineNum">    7426 </span>                :            :          * Otherwise, use a percentage of physical memory defined by
<span class="lineNum">    7427 </span>                :            :          * zfs_dirty_data_max_percent (default 10%) with a cap at
<span class="lineNum">    7428 </span>                :            :          * zfs_dirty_data_max_max (default 4G or 25% of physical memory).
<span class="lineNum">    7429 </span>                :            :          */
<span class="lineNum">    7430 </span>        [<span class="branchCov" title="Branch 0 was taken 1042 times"> + </span><span class="branchCov" title="Branch 1 was taken 192 times"> + </span>]:<span class="lineCov">       1234 :         if (zfs_dirty_data_max_max == 0)</span>
<span class="lineNum">    7431 </span>        [<span class="branchCov" title="Branch 0 was taken 1042 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1042 :                 zfs_dirty_data_max_max = MIN(4ULL * 1024 * 1024 * 1024,</span>
<span class="lineNum">    7432 </span>                :            :                     allmem * zfs_dirty_data_max_max_percent / 100);
<span class="lineNum">    7433 </span>                :            : 
<span class="lineNum">    7434 </span>        [<span class="branchCov" title="Branch 0 was taken 1042 times"> + </span><span class="branchCov" title="Branch 1 was taken 192 times"> + </span>]:<span class="lineCov">       1234 :         if (zfs_dirty_data_max == 0) {</span>
<span class="lineNum">    7435 </span>                :<span class="lineCov">       1042 :                 zfs_dirty_data_max = allmem *</span>
<span class="lineNum">    7436 </span>                :<span class="lineCov">       1042 :                     zfs_dirty_data_max_percent / 100;</span>
<span class="lineNum">    7437 </span>                :<span class="lineCov">       1042 :                 zfs_dirty_data_max = MIN(zfs_dirty_data_max,</span>
<span class="lineNum">    7438 </span>                :            :                     zfs_dirty_data_max_max);
<span class="lineNum">    7439 </span>                :            :         }
<span class="lineNum">    7440 </span>                :<span class="lineCov">       1234 : }</span>
<a name="7441"><span class="lineNum">    7441 </span>                :            : </a>
<span class="lineNum">    7442 </span>                :            : void
<span class="lineNum">    7443 </span>                :<span class="lineCov">        785 : arc_fini(void)</span>
<span class="lineNum">    7444 </span>                :            : {
<span class="lineNum">    7445 </span>                :            :         arc_prune_t *p;
<span class="lineNum">    7446 </span>                :            : 
<span class="lineNum">    7447 </span>                :            : #ifdef _KERNEL
<span class="lineNum">    7448 </span>                :            :         spl_unregister_shrinker(&amp;arc_shrinker);
<span class="lineNum">    7449 </span>                :            : #endif /* _KERNEL */
<span class="lineNum">    7450 </span>                :            : 
<span class="lineNum">    7451 </span>                :<span class="lineCov">        785 :         mutex_enter(&amp;arc_reclaim_lock);</span>
<span class="lineNum">    7452 </span>                :<span class="lineCov">        785 :         arc_reclaim_thread_exit = B_TRUE;</span>
<span class="lineNum">    7453 </span>                :            :         /*
<span class="lineNum">    7454 </span>                :            :          * The reclaim thread will set arc_reclaim_thread_exit back to
<span class="lineNum">    7455 </span>                :            :          * B_FALSE when it is finished exiting; we're waiting for that.
<span class="lineNum">    7456 </span>                :            :          */
<span class="lineNum">    7457 </span>        [<span class="branchCov" title="Branch 0 was taken 785 times"> + </span><span class="branchCov" title="Branch 1 was taken 785 times"> + </span>]:<span class="lineCov">       1570 :         while (arc_reclaim_thread_exit) {</span>
<span class="lineNum">    7458 </span>                :<span class="lineCov">        785 :                 cv_signal(&amp;arc_reclaim_thread_cv);</span>
<span class="lineNum">    7459 </span>                :<span class="lineCov">        785 :                 cv_wait(&amp;arc_reclaim_thread_cv, &amp;arc_reclaim_lock);</span>
<span class="lineNum">    7460 </span>                :            :         }
<span class="lineNum">    7461 </span>                :<span class="lineCov">        785 :         mutex_exit(&amp;arc_reclaim_lock);</span>
<span class="lineNum">    7462 </span>                :            : 
<span class="lineNum">    7463 </span>                :            :         /* Use B_TRUE to ensure *all* buffers are evicted */
<span class="lineNum">    7464 </span>                :<span class="lineCov">        785 :         arc_flush(NULL, B_TRUE);</span>
<span class="lineNum">    7465 </span>                :            : 
<span class="lineNum">    7466 </span>                :<span class="lineCov">        785 :         arc_dead = B_TRUE;</span>
<span class="lineNum">    7467 </span>                :            : 
<span class="lineNum">    7468 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 785 times"> + </span>]:<span class="lineCov">        785 :         if (arc_ksp != NULL) {</span>
<span class="lineNum">    7469 </span>                :<span class="lineNoCov">          0 :                 kstat_delete(arc_ksp);</span>
<span class="lineNum">    7470 </span>                :<span class="lineNoCov">          0 :                 arc_ksp = NULL;</span>
<span class="lineNum">    7471 </span>                :            :         }
<span class="lineNum">    7472 </span>                :            : 
<span class="lineNum">    7473 </span>                :<span class="lineCov">        785 :         taskq_wait(arc_prune_taskq);</span>
<span class="lineNum">    7474 </span>                :<span class="lineCov">        785 :         taskq_destroy(arc_prune_taskq);</span>
<span class="lineNum">    7475 </span>                :            : 
<span class="lineNum">    7476 </span>                :<span class="lineCov">        785 :         mutex_enter(&amp;arc_prune_mtx);</span>
<span class="lineNum">    7477 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 785 times"> + </span>]:<span class="lineCov">        785 :         while ((p = list_head(&amp;arc_prune_list)) != NULL) {</span>
<span class="lineNum">    7478 </span>                :<span class="lineNoCov">          0 :                 list_remove(&amp;arc_prune_list, p);</span>
<span class="lineNum">    7479 </span>                :<span class="lineNoCov">          0 :                 refcount_remove(&amp;p-&gt;p_refcnt, &amp;arc_prune_list);</span>
<span class="lineNum">    7480 </span>                :<span class="lineNoCov">          0 :                 refcount_destroy(&amp;p-&gt;p_refcnt);</span>
<span class="lineNum">    7481 </span>                :<span class="lineNoCov">          0 :                 kmem_free(p, sizeof (*p));</span>
<span class="lineNum">    7482 </span>                :            :         }
<span class="lineNum">    7483 </span>                :<span class="lineCov">        785 :         mutex_exit(&amp;arc_prune_mtx);</span>
<span class="lineNum">    7484 </span>                :            : 
<span class="lineNum">    7485 </span>                :<span class="lineCov">        785 :         list_destroy(&amp;arc_prune_list);</span>
<span class="lineNum">    7486 </span>                :<span class="lineCov">        785 :         mutex_destroy(&amp;arc_prune_mtx);</span>
<span class="lineNum">    7487 </span>                :<span class="lineCov">        785 :         mutex_destroy(&amp;arc_reclaim_lock);</span>
<span class="lineNum">    7488 </span>                :<span class="lineCov">        785 :         cv_destroy(&amp;arc_reclaim_thread_cv);</span>
<span class="lineNum">    7489 </span>                :<span class="lineCov">        785 :         cv_destroy(&amp;arc_reclaim_waiters_cv);</span>
<span class="lineNum">    7490 </span>                :            : 
<span class="lineNum">    7491 </span>                :<span class="lineCov">        785 :         arc_state_fini();</span>
<span class="lineNum">    7492 </span>                :<span class="lineCov">        785 :         buf_fini();</span>
<span class="lineNum">    7493 </span>                :            : 
<span class="lineNum">    7494 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 785 times"> + </span>]:<span class="lineCov">        785 :         ASSERT0(arc_loaned_bytes);</span>
<span class="lineNum">    7495 </span>                :<span class="lineCov">        785 : }</span>
<span class="lineNum">    7496 </span>                :            : 
<span class="lineNum">    7497 </span>                :            : /*
<span class="lineNum">    7498 </span>                :            :  * Level 2 ARC
<span class="lineNum">    7499 </span>                :            :  *
<span class="lineNum">    7500 </span>                :            :  * The level 2 ARC (L2ARC) is a cache layer in-between main memory and disk.
<span class="lineNum">    7501 </span>                :            :  * It uses dedicated storage devices to hold cached data, which are populated
<span class="lineNum">    7502 </span>                :            :  * using large infrequent writes.  The main role of this cache is to boost
<span class="lineNum">    7503 </span>                :            :  * the performance of random read workloads.  The intended L2ARC devices
<span class="lineNum">    7504 </span>                :            :  * include short-stroked disks, solid state disks, and other media with
<span class="lineNum">    7505 </span>                :            :  * substantially faster read latency than disk.
<span class="lineNum">    7506 </span>                :            :  *
<span class="lineNum">    7507 </span>                :            :  *                 +-----------------------+
<span class="lineNum">    7508 </span>                :            :  *                 |         ARC           |
<span class="lineNum">    7509 </span>                :            :  *                 +-----------------------+
<span class="lineNum">    7510 </span>                :            :  *                    |         ^     ^
<span class="lineNum">    7511 </span>                :            :  *                    |         |     |
<span class="lineNum">    7512 </span>                :            :  *      l2arc_feed_thread()    arc_read()
<span class="lineNum">    7513 </span>                :            :  *                    |         |     |
<span class="lineNum">    7514 </span>                :            :  *                    |  l2arc read   |
<span class="lineNum">    7515 </span>                :            :  *                    V         |     |
<span class="lineNum">    7516 </span>                :            :  *               +---------------+    |
<span class="lineNum">    7517 </span>                :            :  *               |     L2ARC     |    |
<span class="lineNum">    7518 </span>                :            :  *               +---------------+    |
<span class="lineNum">    7519 </span>                :            :  *                   |    ^           |
<span class="lineNum">    7520 </span>                :            :  *          l2arc_write() |           |
<span class="lineNum">    7521 </span>                :            :  *                   |    |           |
<span class="lineNum">    7522 </span>                :            :  *                   V    |           |
<span class="lineNum">    7523 </span>                :            :  *                 +-------+      +-------+
<span class="lineNum">    7524 </span>                :            :  *                 | vdev  |      | vdev  |
<span class="lineNum">    7525 </span>                :            :  *                 | cache |      | cache |
<span class="lineNum">    7526 </span>                :            :  *                 +-------+      +-------+
<span class="lineNum">    7527 </span>                :            :  *                 +=========+     .-----.
<span class="lineNum">    7528 </span>                :            :  *                 :  L2ARC  :    |-_____-|
<span class="lineNum">    7529 </span>                :            :  *                 : devices :    | Disks |
<span class="lineNum">    7530 </span>                :            :  *                 +=========+    `-_____-'
<span class="lineNum">    7531 </span>                :            :  *
<span class="lineNum">    7532 </span>                :            :  * Read requests are satisfied from the following sources, in order:
<span class="lineNum">    7533 </span>                :            :  *
<span class="lineNum">    7534 </span>                :            :  *      1) ARC
<span class="lineNum">    7535 </span>                :            :  *      2) vdev cache of L2ARC devices
<span class="lineNum">    7536 </span>                :            :  *      3) L2ARC devices
<span class="lineNum">    7537 </span>                :            :  *      4) vdev cache of disks
<span class="lineNum">    7538 </span>                :            :  *      5) disks
<span class="lineNum">    7539 </span>                :            :  *
<span class="lineNum">    7540 </span>                :            :  * Some L2ARC device types exhibit extremely slow write performance.
<span class="lineNum">    7541 </span>                :            :  * To accommodate for this there are some significant differences between
<span class="lineNum">    7542 </span>                :            :  * the L2ARC and traditional cache design:
<span class="lineNum">    7543 </span>                :            :  *
<span class="lineNum">    7544 </span>                :            :  * 1. There is no eviction path from the ARC to the L2ARC.  Evictions from
<span class="lineNum">    7545 </span>                :            :  * the ARC behave as usual, freeing buffers and placing headers on ghost
<span class="lineNum">    7546 </span>                :            :  * lists.  The ARC does not send buffers to the L2ARC during eviction as
<span class="lineNum">    7547 </span>                :            :  * this would add inflated write latencies for all ARC memory pressure.
<span class="lineNum">    7548 </span>                :            :  *
<span class="lineNum">    7549 </span>                :            :  * 2. The L2ARC attempts to cache data from the ARC before it is evicted.
<span class="lineNum">    7550 </span>                :            :  * It does this by periodically scanning buffers from the eviction-end of
<span class="lineNum">    7551 </span>                :            :  * the MFU and MRU ARC lists, copying them to the L2ARC devices if they are
<span class="lineNum">    7552 </span>                :            :  * not already there. It scans until a headroom of buffers is satisfied,
<span class="lineNum">    7553 </span>                :            :  * which itself is a buffer for ARC eviction. If a compressible buffer is
<span class="lineNum">    7554 </span>                :            :  * found during scanning and selected for writing to an L2ARC device, we
<span class="lineNum">    7555 </span>                :            :  * temporarily boost scanning headroom during the next scan cycle to make
<span class="lineNum">    7556 </span>                :            :  * sure we adapt to compression effects (which might significantly reduce
<span class="lineNum">    7557 </span>                :            :  * the data volume we write to L2ARC). The thread that does this is
<span class="lineNum">    7558 </span>                :            :  * l2arc_feed_thread(), illustrated below; example sizes are included to
<span class="lineNum">    7559 </span>                :            :  * provide a better sense of ratio than this diagram:
<span class="lineNum">    7560 </span>                :            :  *
<span class="lineNum">    7561 </span>                :            :  *             head --&gt;                        tail
<span class="lineNum">    7562 </span>                :            :  *              +---------------------+----------+
<span class="lineNum">    7563 </span>                :            :  *      ARC_mfu |:::::#:::::::::::::::|o#o###o###|--&gt;.   # already on L2ARC
<span class="lineNum">    7564 </span>                :            :  *              +---------------------+----------+   |   o L2ARC eligible
<span class="lineNum">    7565 </span>                :            :  *      ARC_mru |:#:::::::::::::::::::|#o#ooo####|--&gt;|   : ARC buffer
<span class="lineNum">    7566 </span>                :            :  *              +---------------------+----------+   |
<span class="lineNum">    7567 </span>                :            :  *                   15.9 Gbytes      ^ 32 Mbytes    |
<span class="lineNum">    7568 </span>                :            :  *                                 headroom          |
<span class="lineNum">    7569 </span>                :            :  *                                            l2arc_feed_thread()
<span class="lineNum">    7570 </span>                :            :  *                                                   |
<span class="lineNum">    7571 </span>                :            :  *                       l2arc write hand &lt;--[oooo]--'
<span class="lineNum">    7572 </span>                :            :  *                               |           8 Mbyte
<span class="lineNum">    7573 </span>                :            :  *                               |          write max
<span class="lineNum">    7574 </span>                :            :  *                               V
<span class="lineNum">    7575 </span>                :            :  *                +==============================+
<span class="lineNum">    7576 </span>                :            :  *      L2ARC dev |####|#|###|###|    |####| ... |
<span class="lineNum">    7577 </span>                :            :  *                +==============================+
<span class="lineNum">    7578 </span>                :            :  *                           32 Gbytes
<span class="lineNum">    7579 </span>                :            :  *
<span class="lineNum">    7580 </span>                :            :  * 3. If an ARC buffer is copied to the L2ARC but then hit instead of
<span class="lineNum">    7581 </span>                :            :  * evicted, then the L2ARC has cached a buffer much sooner than it probably
<span class="lineNum">    7582 </span>                :            :  * needed to, potentially wasting L2ARC device bandwidth and storage.  It is
<span class="lineNum">    7583 </span>                :            :  * safe to say that this is an uncommon case, since buffers at the end of
<span class="lineNum">    7584 </span>                :            :  * the ARC lists have moved there due to inactivity.
<span class="lineNum">    7585 </span>                :            :  *
<span class="lineNum">    7586 </span>                :            :  * 4. If the ARC evicts faster than the L2ARC can maintain a headroom,
<span class="lineNum">    7587 </span>                :            :  * then the L2ARC simply misses copying some buffers.  This serves as a
<span class="lineNum">    7588 </span>                :            :  * pressure valve to prevent heavy read workloads from both stalling the ARC
<span class="lineNum">    7589 </span>                :            :  * with waits and clogging the L2ARC with writes.  This also helps prevent
<span class="lineNum">    7590 </span>                :            :  * the potential for the L2ARC to churn if it attempts to cache content too
<span class="lineNum">    7591 </span>                :            :  * quickly, such as during backups of the entire pool.
<span class="lineNum">    7592 </span>                :            :  *
<span class="lineNum">    7593 </span>                :            :  * 5. After system boot and before the ARC has filled main memory, there are
<span class="lineNum">    7594 </span>                :            :  * no evictions from the ARC and so the tails of the ARC_mfu and ARC_mru
<span class="lineNum">    7595 </span>                :            :  * lists can remain mostly static.  Instead of searching from tail of these
<span class="lineNum">    7596 </span>                :            :  * lists as pictured, the l2arc_feed_thread() will search from the list heads
<span class="lineNum">    7597 </span>                :            :  * for eligible buffers, greatly increasing its chance of finding them.
<span class="lineNum">    7598 </span>                :            :  *
<span class="lineNum">    7599 </span>                :            :  * The L2ARC device write speed is also boosted during this time so that
<span class="lineNum">    7600 </span>                :            :  * the L2ARC warms up faster.  Since there have been no ARC evictions yet,
<span class="lineNum">    7601 </span>                :            :  * there are no L2ARC reads, and no fear of degrading read performance
<span class="lineNum">    7602 </span>                :            :  * through increased writes.
<span class="lineNum">    7603 </span>                :            :  *
<span class="lineNum">    7604 </span>                :            :  * 6. Writes to the L2ARC devices are grouped and sent in-sequence, so that
<span class="lineNum">    7605 </span>                :            :  * the vdev queue can aggregate them into larger and fewer writes.  Each
<span class="lineNum">    7606 </span>                :            :  * device is written to in a rotor fashion, sweeping writes through
<span class="lineNum">    7607 </span>                :            :  * available space then repeating.
<span class="lineNum">    7608 </span>                :            :  *
<span class="lineNum">    7609 </span>                :            :  * 7. The L2ARC does not store dirty content.  It never needs to flush
<span class="lineNum">    7610 </span>                :            :  * write buffers back to disk based storage.
<span class="lineNum">    7611 </span>                :            :  *
<span class="lineNum">    7612 </span>                :            :  * 8. If an ARC buffer is written (and dirtied) which also exists in the
<span class="lineNum">    7613 </span>                :            :  * L2ARC, the now stale L2ARC buffer is immediately dropped.
<span class="lineNum">    7614 </span>                :            :  *
<span class="lineNum">    7615 </span>                :            :  * The performance of the L2ARC can be tweaked by a number of tunables, which
<span class="lineNum">    7616 </span>                :            :  * may be necessary for different workloads:
<span class="lineNum">    7617 </span>                :            :  *
<span class="lineNum">    7618 </span>                :            :  *      l2arc_write_max         max write bytes per interval
<span class="lineNum">    7619 </span>                :            :  *      l2arc_write_boost       extra write bytes during device warmup
<span class="lineNum">    7620 </span>                :            :  *      l2arc_noprefetch        skip caching prefetched buffers
<span class="lineNum">    7621 </span>                :            :  *      l2arc_headroom          number of max device writes to precache
<span class="lineNum">    7622 </span>                :            :  *      l2arc_headroom_boost    when we find compressed buffers during ARC
<span class="lineNum">    7623 </span>                :            :  *                              scanning, we multiply headroom by this
<span class="lineNum">    7624 </span>                :            :  *                              percentage factor for the next scan cycle,
<span class="lineNum">    7625 </span>                :            :  *                              since more compressed buffers are likely to
<span class="lineNum">    7626 </span>                :            :  *                              be present
<span class="lineNum">    7627 </span>                :            :  *      l2arc_feed_secs         seconds between L2ARC writing
<span class="lineNum">    7628 </span>                :            :  *
<span class="lineNum">    7629 </span>                :            :  * Tunables may be removed or added as future performance improvements are
<span class="lineNum">    7630 </span>                :            :  * integrated, and also may become zpool properties.
<span class="lineNum">    7631 </span>                :            :  *
<span class="lineNum">    7632 </span>                :            :  * There are three key functions that control how the L2ARC warms up:
<span class="lineNum">    7633 </span>                :            :  *
<span class="lineNum">    7634 </span>                :            :  *      l2arc_write_eligible()  check if a buffer is eligible to cache
<span class="lineNum">    7635 </span>                :            :  *      l2arc_write_size()      calculate how much to write
<span class="lineNum">    7636 </span>                :            :  *      l2arc_write_interval()  calculate sleep delay between writes
<span class="lineNum">    7637 </span>                :            :  *
<span class="lineNum">    7638 </span>                :            :  * These three functions determine what to write, how much, and how quickly
<span class="lineNum">    7639 </span>                :            :  * to send writes.
<span class="lineNum">    7640 </span>                :            :  */
<a name="7641"><span class="lineNum">    7641 </span>                :            : </a>
<span class="lineNum">    7642 </span>                :            : static boolean_t
<span class="lineNum">    7643 </span>                :<span class="lineCov">     286725 : l2arc_write_eligible(uint64_t spa_guid, arc_buf_hdr_t *hdr)</span>
<span class="lineNum">    7644 </span>                :            : {
<span class="lineNum">    7645 </span>                :            :         /*
<span class="lineNum">    7646 </span>                :            :          * A buffer is *not* eligible for the L2ARC if it:
<span class="lineNum">    7647 </span>                :            :          * 1. belongs to a different spa.
<span class="lineNum">    7648 </span>                :            :          * 2. is already cached on the L2ARC.
<span class="lineNum">    7649 </span>                :            :          * 3. has an I/O in progress (it may be an incomplete read).
<span class="lineNum">    7650 </span>                :            :          * 4. is flagged not eligible (zfs property).
<span class="lineNum">    7651 </span>                :            :          */
<span class="lineNum">    7652 </span>        [<span class="branchCov" title="Branch 0 was taken 286669 times"> + </span><span class="branchCov" title="Branch 1 was taken 56 times"> + </span>]:<span class="lineCov">     286725 :         if (hdr-&gt;b_spa != spa_guid || HDR_HAS_L2HDR(hdr) ||</span>
<span class="lineNum">    7653 </span>        [<span class="branchCov" title="Branch 0 was taken 87598 times"> + </span><span class="branchCov" title="Branch 1 was taken 199071 times"> + </span>]:<span class="lineCov">     286669 :             HDR_IO_IN_PROGRESS(hdr) || !HDR_L2CACHE(hdr))</span>
<span class="lineNum">    7654 </span>                :            :                 return (B_FALSE);
<span class="lineNum">    7655 </span>                :            : 
<span class="lineNum">    7656 </span>                :<span class="lineCov">      87598 :         return (B_TRUE);</span>
<span class="lineNum">    7657 </span>                :            : }
<a name="7658"><span class="lineNum">    7658 </span>                :            : </a>
<span class="lineNum">    7659 </span>                :            : static uint64_t
<span class="lineNum">    7660 </span>                :<span class="lineCov">        390 : l2arc_write_size(void)</span>
<span class="lineNum">    7661 </span>                :            : {
<span class="lineNum">    7662 </span>                :            :         uint64_t size;
<span class="lineNum">    7663 </span>                :            : 
<span class="lineNum">    7664 </span>                :            :         /*
<span class="lineNum">    7665 </span>                :            :          * Make sure our globals have meaningful values in case the user
<span class="lineNum">    7666 </span>                :            :          * altered them.
<span class="lineNum">    7667 </span>                :            :          */
<span class="lineNum">    7668 </span>                :<span class="lineCov">        390 :         size = l2arc_write_max;</span>
<span class="lineNum">    7669 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 390 times"> + </span>]:<span class="lineCov">        390 :         if (size == 0) {</span>
<span class="lineNum">    7670 </span>                :<span class="lineNoCov">          0 :                 cmn_err(CE_NOTE, &quot;Bad value for l2arc_write_max, value must &quot;</span>
<span class="lineNum">    7671 </span>                :            :                     &quot;be greater than zero, resetting it to the default (%d)&quot;,
<span class="lineNum">    7672 </span>                :            :                     L2ARC_WRITE_SIZE);
<span class="lineNum">    7673 </span>                :<span class="lineNoCov">          0 :                 size = l2arc_write_max = L2ARC_WRITE_SIZE;</span>
<span class="lineNum">    7674 </span>                :            :         }
<span class="lineNum">    7675 </span>                :            : 
<span class="lineNum">    7676 </span>        [<span class="branchCov" title="Branch 0 was taken 123 times"> + </span><span class="branchCov" title="Branch 1 was taken 267 times"> + </span>]:<span class="lineCov">        390 :         if (arc_warm == B_FALSE)</span>
<span class="lineNum">    7677 </span>                :<span class="lineCov">        123 :                 size += l2arc_write_boost;</span>
<span class="lineNum">    7678 </span>                :            : 
<span class="lineNum">    7679 </span>                :<span class="lineCov">        390 :         return (size);</span>
<span class="lineNum">    7680 </span>                :            : 
<span class="lineNum">    7681 </span>                :            : }
<a name="7682"><span class="lineNum">    7682 </span>                :            : </a>
<span class="lineNum">    7683 </span>                :            : static clock_t
<span class="lineNum">    7684 </span>                :<span class="lineCov">        390 : l2arc_write_interval(clock_t began, uint64_t wanted, uint64_t wrote)</span>
<span class="lineNum">    7685 </span>                :            : {
<span class="lineNum">    7686 </span>                :            :         clock_t interval, next, now;
<span class="lineNum">    7687 </span>                :            : 
<span class="lineNum">    7688 </span>                :            :         /*
<span class="lineNum">    7689 </span>                :            :          * If the ARC lists are busy, increase our write rate; if the
<span class="lineNum">    7690 </span>                :            :          * lists are stale, idle back.  This is achieved by checking
<span class="lineNum">    7691 </span>                :            :          * how much we previously wrote - if it was more than half of
<span class="lineNum">    7692 </span>                :            :          * what we wanted, schedule the next write much sooner.
<span class="lineNum">    7693 </span>                :            :          */
<span class="lineNum">    7694 </span>[<span class="branchCov" title="Branch 0 was taken 390 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 390 times"> + </span>]:<span class="lineCov">        390 :         if (l2arc_feed_again &amp;&amp; wrote &gt; (wanted / 2))</span>
<span class="lineNum">    7695 </span>                :<span class="lineNoCov">          0 :                 interval = (hz * l2arc_feed_min_ms) / 1000;</span>
<span class="lineNum">    7696 </span>                :            :         else
<span class="lineNum">    7697 </span>                :<span class="lineCov">        390 :                 interval = hz * l2arc_feed_secs;</span>
<span class="lineNum">    7698 </span>                :            : 
<span class="lineNum">    7699 </span>                :<span class="lineCov">        390 :         now = ddi_get_lbolt();</span>
<span class="lineNum">    7700 </span>                :<span class="lineCov">        390 :         next = MAX(now, MIN(now + interval, began + interval));</span>
<span class="lineNum">    7701 </span>                :            : 
<span class="lineNum">    7702 </span>                :<span class="lineCov">        390 :         return (next);</span>
<span class="lineNum">    7703 </span>                :            : }
<span class="lineNum">    7704 </span>                :            : 
<span class="lineNum">    7705 </span>                :            : /*
<span class="lineNum">    7706 </span>                :            :  * Cycle through L2ARC devices.  This is how L2ARC load balances.
<span class="lineNum">    7707 </span>                :            :  * If a device is returned, this also returns holding the spa config lock.
<a name="7708"><span class="lineNum">    7708 </span>                :            :  */</a>
<span class="lineNum">    7709 </span>                :            : static l2arc_dev_t *
<span class="lineNum">    7710 </span>                :<span class="lineCov">        419 : l2arc_dev_get_next(void)</span>
<span class="lineNum">    7711 </span>                :            : {
<span class="lineNum">    7712 </span>                :<span class="lineCov">        419 :         l2arc_dev_t *first, *next = NULL;</span>
<span class="lineNum">    7713 </span>                :            : 
<span class="lineNum">    7714 </span>                :            :         /*
<span class="lineNum">    7715 </span>                :            :          * Lock out the removal of spas (spa_namespace_lock), then removal
<span class="lineNum">    7716 </span>                :            :          * of cache devices (l2arc_dev_mtx).  Once a device has been selected,
<span class="lineNum">    7717 </span>                :            :          * both locks will be dropped and a spa config lock held instead.
<span class="lineNum">    7718 </span>                :            :          */
<span class="lineNum">    7719 </span>                :<span class="lineCov">        419 :         mutex_enter(&amp;spa_namespace_lock);</span>
<span class="lineNum">    7720 </span>                :<span class="lineCov">        419 :         mutex_enter(&amp;l2arc_dev_mtx);</span>
<span class="lineNum">    7721 </span>                :            : 
<span class="lineNum">    7722 </span>                :            :         /* if there are no vdevs, there is nothing to do */
<span class="lineNum">    7723 </span>        [<span class="branchCov" title="Branch 0 was taken 414 times"> + </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span>]:<span class="lineCov">        419 :         if (l2arc_ndev == 0)</span>
<span class="lineNum">    7724 </span>                :            :                 goto out;
<span class="lineNum">    7725 </span>                :            : 
<span class="lineNum">    7726 </span>                :<span class="lineCov">        414 :         first = NULL;</span>
<span class="lineNum">    7727 </span>                :<span class="lineCov">        414 :         next = l2arc_dev_last;</span>
<span class="lineNum">    7728 </span>                :            :         do {
<span class="lineNum">    7729 </span>                :            :                 /* loop around the list looking for a non-faulted vdev */
<span class="lineNum">    7730 </span>        [<span class="branchCov" title="Branch 0 was taken 38 times"> + </span><span class="branchCov" title="Branch 1 was taken 400 times"> + </span>]:<span class="lineCov">        438 :                 if (next == NULL) {</span>
<span class="lineNum">    7731 </span>                :<span class="lineCov">         38 :                         next = list_head(l2arc_dev_list);</span>
<span class="lineNum">    7732 </span>                :            :                 } else {
<span class="lineNum">    7733 </span>                :<span class="lineCov">        400 :                         next = list_next(l2arc_dev_list, next);</span>
<span class="lineNum">    7734 </span>        [<span class="branchCov" title="Branch 0 was taken 362 times"> + </span><span class="branchCov" title="Branch 1 was taken 38 times"> + </span>]:<span class="lineCov">        400 :                         if (next == NULL)</span>
<span class="lineNum">    7735 </span>                :<span class="lineCov">        362 :                                 next = list_head(l2arc_dev_list);</span>
<span class="lineNum">    7736 </span>                :            :                 }
<span class="lineNum">    7737 </span>                :            : 
<span class="lineNum">    7738 </span>                :            :                 /* if we have come back to the start, bail out */
<span class="lineNum">    7739 </span>        [<span class="branchCov" title="Branch 0 was taken 24 times"> + </span><span class="branchCov" title="Branch 1 was taken 414 times"> + </span>]:<span class="lineCov">        438 :                 if (first == NULL)</span>
<span class="lineNum">    7740 </span>                :            :                         first = next;
<span class="lineNum">    7741 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 24 times"> + </span>]:<span class="lineCov">         24 :                 else if (next == first)</span>
<span class="lineNum">    7742 </span>                :            :                         break;
<span class="lineNum">    7743 </span>                :            : 
<span class="lineNum">    7744 </span>        [<span class="branchCov" title="Branch 1 was taken 24 times"> + </span><span class="branchCov" title="Branch 2 was taken 390 times"> + </span>]:<span class="lineCov">        414 :         } while (vdev_is_dead(next-&gt;l2ad_vdev));</span>
<span class="lineNum">    7745 </span>                :            : 
<span class="lineNum">    7746 </span>                :            :         /* if we were unable to find any usable vdevs, return NULL */
<span class="lineNum">    7747 </span>        [<span class="branchCov" title="Branch 1 was taken 24 times"> + </span><span class="branchCov" title="Branch 2 was taken 390 times"> + </span>]:<span class="lineCov">        414 :         if (vdev_is_dead(next-&gt;l2ad_vdev))</span>
<span class="lineNum">    7748 </span>                :<span class="lineCov">         24 :                 next = NULL;</span>
<span class="lineNum">    7749 </span>                :            : 
<span class="lineNum">    7750 </span>                :<span class="lineCov">        414 :         l2arc_dev_last = next;</span>
<span class="lineNum">    7751 </span>                :            : 
<span class="lineNum">    7752 </span>                :            : out:
<span class="lineNum">    7753 </span>                :<span class="lineCov">        419 :         mutex_exit(&amp;l2arc_dev_mtx);</span>
<span class="lineNum">    7754 </span>                :            : 
<span class="lineNum">    7755 </span>                :            :         /*
<span class="lineNum">    7756 </span>                :            :          * Grab the config lock to prevent the 'next' device from being
<span class="lineNum">    7757 </span>                :            :          * removed while we are writing to it.
<span class="lineNum">    7758 </span>                :            :          */
<span class="lineNum">    7759 </span>        [<span class="branchCov" title="Branch 0 was taken 390 times"> + </span><span class="branchCov" title="Branch 1 was taken 29 times"> + </span>]:<span class="lineCov">        419 :         if (next != NULL)</span>
<span class="lineNum">    7760 </span>                :<span class="lineCov">        390 :                 spa_config_enter(next-&gt;l2ad_spa, SCL_L2ARC, next, RW_READER);</span>
<span class="lineNum">    7761 </span>                :<span class="lineCov">        419 :         mutex_exit(&amp;spa_namespace_lock);</span>
<span class="lineNum">    7762 </span>                :            : 
<span class="lineNum">    7763 </span>                :<span class="lineCov">        419 :         return (next);</span>
<span class="lineNum">    7764 </span>                :            : }
<span class="lineNum">    7765 </span>                :            : 
<span class="lineNum">    7766 </span>                :            : /*
<span class="lineNum">    7767 </span>                :            :  * Free buffers that were tagged for destruction.
<a name="7768"><span class="lineNum">    7768 </span>                :            :  */</a>
<span class="lineNum">    7769 </span>                :            : static void
<span class="lineNum">    7770 </span>                :<span class="lineCov">       1079 : l2arc_do_free_on_write(void)</span>
<span class="lineNum">    7771 </span>                :            : {
<span class="lineNum">    7772 </span>                :            :         list_t *buflist;
<span class="lineNum">    7773 </span>                :            :         l2arc_data_free_t *df, *df_prev;
<span class="lineNum">    7774 </span>                :            : 
<span class="lineNum">    7775 </span>                :<span class="lineCov">       1079 :         mutex_enter(&amp;l2arc_free_on_write_mtx);</span>
<span class="lineNum">    7776 </span>                :<span class="lineCov">       1079 :         buflist = l2arc_free_on_write;</span>
<span class="lineNum">    7777 </span>                :            : 
<span class="lineNum">    7778 </span>        [<span class="branchCov" title="Branch 2 was taken 986 times"> + </span><span class="branchCov" title="Branch 3 was taken 1079 times"> + </span>]:<span class="lineCov">       2065 :         for (df = list_tail(buflist); df; df = df_prev) {</span>
<span class="lineNum">    7779 </span>                :<span class="lineCov">        986 :                 df_prev = list_prev(buflist, df);</span>
<span class="lineNum">    7780 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 986 times"> + </span>]:<span class="lineCov">        986 :                 ASSERT3P(df-&gt;l2df_abd, !=, NULL);</span>
<span class="lineNum">    7781 </span>                :<span class="lineCov">        986 :                 abd_free(df-&gt;l2df_abd);</span>
<span class="lineNum">    7782 </span>                :<span class="lineCov">        986 :                 list_remove(buflist, df);</span>
<span class="lineNum">    7783 </span>                :<span class="lineCov">        986 :                 kmem_free(df, sizeof (l2arc_data_free_t));</span>
<span class="lineNum">    7784 </span>                :            :         }
<span class="lineNum">    7785 </span>                :            : 
<span class="lineNum">    7786 </span>                :<span class="lineCov">       1079 :         mutex_exit(&amp;l2arc_free_on_write_mtx);</span>
<span class="lineNum">    7787 </span>                :<span class="lineCov">       1079 : }</span>
<span class="lineNum">    7788 </span>                :            : 
<span class="lineNum">    7789 </span>                :            : /*
<span class="lineNum">    7790 </span>                :            :  * A write to a cache device has completed.  Update all headers to allow
<span class="lineNum">    7791 </span>                :            :  * reads from these buffers to begin.
<a name="7792"><span class="lineNum">    7792 </span>                :            :  */</a>
<span class="lineNum">    7793 </span>                :            : static void
<span class="lineNum">    7794 </span>                :<span class="lineCov">        294 : l2arc_write_done(zio_t *zio)</span>
<span class="lineNum">    7795 </span>                :            : {
<span class="lineNum">    7796 </span>                :            :         l2arc_write_callback_t *cb;
<span class="lineNum">    7797 </span>                :            :         l2arc_dev_t *dev;
<span class="lineNum">    7798 </span>                :            :         list_t *buflist;
<span class="lineNum">    7799 </span>                :            :         arc_buf_hdr_t *head, *hdr, *hdr_prev;
<span class="lineNum">    7800 </span>                :            :         kmutex_t *hash_lock;
<span class="lineNum">    7801 </span>                :<span class="lineCov">        294 :         int64_t bytes_dropped = 0;</span>
<span class="lineNum">    7802 </span>                :            : 
<span class="lineNum">    7803 </span>                :<span class="lineCov">        294 :         cb = zio-&gt;io_private;</span>
<span class="lineNum">    7804 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 294 times"> + </span>]:<span class="lineCov">        294 :         ASSERT3P(cb, !=, NULL);</span>
<span class="lineNum">    7805 </span>                :<span class="lineCov">        294 :         dev = cb-&gt;l2wcb_dev;</span>
<span class="lineNum">    7806 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 294 times"> + </span>]:<span class="lineCov">        294 :         ASSERT3P(dev, !=, NULL);</span>
<span class="lineNum">    7807 </span>                :<span class="lineCov">        294 :         head = cb-&gt;l2wcb_head;</span>
<span class="lineNum">    7808 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 294 times"> + </span>]:<span class="lineCov">        294 :         ASSERT3P(head, !=, NULL);</span>
<span class="lineNum">    7809 </span>                :<span class="lineCov">        294 :         buflist = &amp;dev-&gt;l2ad_buflist;</span>
<span class="lineNum">    7810 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 294 times"> + </span>]:<span class="lineCov">        294 :         ASSERT3P(buflist, !=, NULL);</span>
<span class="lineNum">    7811 </span>                :            :         DTRACE_PROBE2(l2arc__iodone, zio_t *, zio,
<span class="lineNum">    7812 </span>                :            :             l2arc_write_callback_t *, cb);
<span class="lineNum">    7813 </span>                :            : 
<span class="lineNum">    7814 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 294 times"> + </span>]:<span class="lineCov">        294 :         if (zio-&gt;io_error != 0)</span>
<span class="lineNum">    7815 </span>                :<span class="lineCov">        294 :                 ARCSTAT_BUMP(arcstat_l2_writes_error);</span>
<span class="lineNum">    7816 </span>                :            : 
<span class="lineNum">    7817 </span>                :            :         /*
<span class="lineNum">    7818 </span>                :            :          * All writes completed, or an error was hit.
<span class="lineNum">    7819 </span>                :            :          */
<span class="lineNum">    7820 </span>                :            : top:
<span class="lineNum">    7821 </span>                :<span class="lineCov">        295 :         mutex_enter(&amp;dev-&gt;l2ad_mtx);</span>
<span class="lineNum">    7822 </span>        [<span class="branchCov" title="Branch 2 was taken 2947 times"> + </span><span class="branchCov" title="Branch 3 was taken 294 times"> + </span>]:<span class="lineCov">       3241 :         for (hdr = list_prev(buflist, head); hdr; hdr = hdr_prev) {</span>
<span class="lineNum">    7823 </span>                :<span class="lineCov">       2947 :                 hdr_prev = list_prev(buflist, hdr);</span>
<span class="lineNum">    7824 </span>                :            : 
<span class="lineNum">    7825 </span>                :<span class="lineCov">       2947 :                 hash_lock = HDR_LOCK(hdr);</span>
<span class="lineNum">    7826 </span>                :            : 
<span class="lineNum">    7827 </span>                :            :                 /*
<span class="lineNum">    7828 </span>                :            :                  * We cannot use mutex_enter or else we can deadlock
<span class="lineNum">    7829 </span>                :            :                  * with l2arc_write_buffers (due to swapping the order
<span class="lineNum">    7830 </span>                :            :                  * the hash lock and l2ad_mtx are taken).
<span class="lineNum">    7831 </span>                :            :                  */
<span class="lineNum">    7832 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 2946 times"> + </span>]:<span class="lineCov">       2947 :                 if (!mutex_tryenter(hash_lock)) {</span>
<span class="lineNum">    7833 </span>                :            :                         /*
<span class="lineNum">    7834 </span>                :            :                          * Missed the hash lock. We must retry so we
<span class="lineNum">    7835 </span>                :            :                          * don't leave the ARC_FLAG_L2_WRITING bit set.
<span class="lineNum">    7836 </span>                :            :                          */
<span class="lineNum">    7837 </span>                :<span class="lineCov">          1 :                         ARCSTAT_BUMP(arcstat_l2_writes_lock_retry);</span>
<span class="lineNum">    7838 </span>                :            : 
<span class="lineNum">    7839 </span>                :            :                         /*
<span class="lineNum">    7840 </span>                :            :                          * We don't want to rescan the headers we've
<span class="lineNum">    7841 </span>                :            :                          * already marked as having been written out, so
<span class="lineNum">    7842 </span>                :            :                          * we reinsert the head node so we can pick up
<span class="lineNum">    7843 </span>                :            :                          * where we left off.
<span class="lineNum">    7844 </span>                :            :                          */
<span class="lineNum">    7845 </span>                :<span class="lineCov">          1 :                         list_remove(buflist, head);</span>
<span class="lineNum">    7846 </span>                :<span class="lineCov">          1 :                         list_insert_after(buflist, hdr, head);</span>
<span class="lineNum">    7847 </span>                :            : 
<span class="lineNum">    7848 </span>                :<span class="lineCov">          1 :                         mutex_exit(&amp;dev-&gt;l2ad_mtx);</span>
<span class="lineNum">    7849 </span>                :            : 
<span class="lineNum">    7850 </span>                :            :                         /*
<span class="lineNum">    7851 </span>                :            :                          * We wait for the hash lock to become available
<span class="lineNum">    7852 </span>                :            :                          * to try and prevent busy waiting, and increase
<span class="lineNum">    7853 </span>                :            :                          * the chance we'll be able to acquire the lock
<span class="lineNum">    7854 </span>                :            :                          * the next time around.
<span class="lineNum">    7855 </span>                :            :                          */
<span class="lineNum">    7856 </span>                :<span class="lineCov">          1 :                         mutex_enter(hash_lock);</span>
<span class="lineNum">    7857 </span>                :<span class="lineCov">          1 :                         mutex_exit(hash_lock);</span>
<span class="lineNum">    7858 </span>                :<span class="lineCov">          1 :                         goto top;</span>
<span class="lineNum">    7859 </span>                :            :                 }
<span class="lineNum">    7860 </span>                :            : 
<span class="lineNum">    7861 </span>                :            :                 /*
<span class="lineNum">    7862 </span>                :            :                  * We could not have been moved into the arc_l2c_only
<span class="lineNum">    7863 </span>                :            :                  * state while in-flight due to our ARC_FLAG_L2_WRITING
<span class="lineNum">    7864 </span>                :            :                  * bit being set. Let's just ensure that's being enforced.
<span class="lineNum">    7865 </span>                :            :                  */
<span class="lineNum">    7866 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2946 times"> + </span>]:<span class="lineCov">       2946 :                 ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    7867 </span>                :            : 
<span class="lineNum">    7868 </span>                :            :                 /*
<span class="lineNum">    7869 </span>                :            :                  * Skipped - drop L2ARC entry and mark the header as no
<span class="lineNum">    7870 </span>                :            :                  * longer L2 eligibile.
<span class="lineNum">    7871 </span>                :            :                  */
<span class="lineNum">    7872 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2946 times"> + </span>]:<span class="lineCov">       2946 :                 if (zio-&gt;io_error != 0) {</span>
<span class="lineNum">    7873 </span>                :            :                         /*
<span class="lineNum">    7874 </span>                :            :                          * Error - drop L2ARC entry.
<span class="lineNum">    7875 </span>                :            :                          */
<span class="lineNum">    7876 </span>                :<span class="lineNoCov">          0 :                         list_remove(buflist, hdr);</span>
<span class="lineNum">    7877 </span>                :<span class="lineNoCov">          0 :                         arc_hdr_clear_flags(hdr, ARC_FLAG_HAS_L2HDR);</span>
<span class="lineNum">    7878 </span>                :            : 
<span class="lineNum">    7879 </span>                :<span class="lineNoCov">          0 :                         ARCSTAT_INCR(arcstat_l2_psize, -arc_hdr_size(hdr));</span>
<span class="lineNum">    7880 </span>                :<span class="lineNoCov">          0 :                         ARCSTAT_INCR(arcstat_l2_lsize, -HDR_GET_LSIZE(hdr));</span>
<span class="lineNum">    7881 </span>                :            : 
<span class="lineNum">    7882 </span>                :<span class="lineNoCov">          0 :                         bytes_dropped += arc_hdr_size(hdr);</span>
<span class="lineNum">    7883 </span>                :<span class="lineNoCov">          0 :                         (void) refcount_remove_many(&amp;dev-&gt;l2ad_alloc,</span>
<span class="lineNum">    7884 </span>                :            :                             arc_hdr_size(hdr), hdr);
<span class="lineNum">    7885 </span>                :            :                 }
<span class="lineNum">    7886 </span>                :            : 
<span class="lineNum">    7887 </span>                :            :                 /*
<span class="lineNum">    7888 </span>                :            :                  * Allow ARC to begin reads and ghost list evictions to
<span class="lineNum">    7889 </span>                :            :                  * this L2ARC entry.
<span class="lineNum">    7890 </span>                :            :                  */
<span class="lineNum">    7891 </span>                :<span class="lineCov">       2946 :                 arc_hdr_clear_flags(hdr, ARC_FLAG_L2_WRITING);</span>
<span class="lineNum">    7892 </span>                :            : 
<span class="lineNum">    7893 </span>                :<span class="lineCov">       2946 :                 mutex_exit(hash_lock);</span>
<span class="lineNum">    7894 </span>                :            :         }
<span class="lineNum">    7895 </span>                :            : 
<span class="lineNum">    7896 </span>                :<span class="lineCov">        294 :         atomic_inc_64(&amp;l2arc_writes_done);</span>
<span class="lineNum">    7897 </span>                :<span class="lineCov">        294 :         list_remove(buflist, head);</span>
<span class="lineNum">    7898 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 294 times"> + </span>]:<span class="lineCov">        294 :         ASSERT(!HDR_HAS_L1HDR(head));</span>
<span class="lineNum">    7899 </span>                :<span class="lineCov">        294 :         kmem_cache_free(hdr_l2only_cache, head);</span>
<span class="lineNum">    7900 </span>                :<span class="lineCov">        294 :         mutex_exit(&amp;dev-&gt;l2ad_mtx);</span>
<span class="lineNum">    7901 </span>                :            : 
<span class="lineNum">    7902 </span>                :<span class="lineCov">        294 :         vdev_space_update(dev-&gt;l2ad_vdev, -bytes_dropped, 0, 0);</span>
<span class="lineNum">    7903 </span>                :            : 
<span class="lineNum">    7904 </span>                :<span class="lineCov">        294 :         l2arc_do_free_on_write();</span>
<span class="lineNum">    7905 </span>                :            : 
<span class="lineNum">    7906 </span>                :<span class="lineCov">        294 :         kmem_free(cb, sizeof (l2arc_write_callback_t));</span>
<span class="lineNum">    7907 </span>                :<span class="lineCov">        294 : }</span>
<a name="7908"><span class="lineNum">    7908 </span>                :            : </a>
<span class="lineNum">    7909 </span>                :            : static int
<span class="lineNum">    7910 </span>                :<span class="lineNoCov">          0 : l2arc_untransform(zio_t *zio, l2arc_read_callback_t *cb)</span>
<span class="lineNum">    7911 </span>                :            : {
<span class="lineNum">    7912 </span>                :            :         int ret;
<span class="lineNum">    7913 </span>                :<span class="lineNoCov">          0 :         spa_t *spa = zio-&gt;io_spa;</span>
<span class="lineNum">    7914 </span>                :<span class="lineNoCov">          0 :         arc_buf_hdr_t *hdr = cb-&gt;l2rcb_hdr;</span>
<span class="lineNum">    7915 </span>                :<span class="lineNoCov">          0 :         blkptr_t *bp = zio-&gt;io_bp;</span>
<span class="lineNum">    7916 </span>                :<span class="lineNoCov">          0 :         dsl_crypto_key_t *dck = NULL;</span>
<span class="lineNum">    7917 </span>                :            :         uint8_t salt[ZIO_DATA_SALT_LEN];
<span class="lineNum">    7918 </span>                :            :         uint8_t iv[ZIO_DATA_IV_LEN];
<span class="lineNum">    7919 </span>                :            :         uint8_t mac[ZIO_DATA_MAC_LEN];
<span class="lineNum">    7920 </span>                :<span class="lineNoCov">          0 :         boolean_t no_crypt = B_FALSE;</span>
<span class="lineNum">    7921 </span>                :            : 
<span class="lineNum">    7922 </span>                :            :         /*
<span class="lineNum">    7923 </span>                :            :          * ZIL data is never be written to the L2ARC, so we don't need
<span class="lineNum">    7924 </span>                :            :          * special handling for its unique MAC storage.
<span class="lineNum">    7925 </span>                :            :          */
<span class="lineNum">    7926 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3U(BP_GET_TYPE(bp), !=, DMU_OT_INTENT_LOG);</span>
<span class="lineNum">    7927 </span>        [<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(MUTEX_HELD(HDR_LOCK(hdr)));</span>
<span class="lineNum">    7928 </span>                :            : 
<span class="lineNum">    7929 </span>                :            :         /* If the data was encrypted, decrypt it now */
<span class="lineNum">    7930 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (HDR_ENCRYPTED(hdr)) {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    7931 </span>                :<span class="lineNoCov">          0 :                 abd_t *eabd = arc_get_data_abd(hdr,</span>
<span class="lineNum">    7932 </span>                :            :                     arc_hdr_size(hdr), hdr);
<span class="lineNum">    7933 </span>                :            : 
<span class="lineNum">    7934 </span>                :<span class="lineNoCov">          0 :                 zio_crypt_decode_params_bp(bp, salt, iv);</span>
<span class="lineNum">    7935 </span>                :<span class="lineNoCov">          0 :                 zio_crypt_decode_mac_bp(bp, mac);</span>
<span class="lineNum">    7936 </span>                :            : 
<span class="lineNum">    7937 </span>                :<span class="lineNoCov">          0 :                 ret = spa_keystore_lookup_key(spa,</span>
<span class="lineNum">    7938 </span>                :            :                     cb-&gt;l2rcb_zb.zb_objset, FTAG, &amp;dck);
<span class="lineNum">    7939 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (ret != 0) {</span>
<span class="lineNum">    7940 </span>                :<span class="lineNoCov">          0 :                         arc_free_data_abd(hdr, eabd, arc_hdr_size(hdr), hdr);</span>
<span class="lineNum">    7941 </span>                :            :                         goto error;
<span class="lineNum">    7942 </span>                :            :                 }
<span class="lineNum">    7943 </span>                :            : 
<span class="lineNum">    7944 </span>                :<span class="lineNoCov">          0 :                 ret = zio_do_crypt_abd(B_FALSE, &amp;dck-&gt;dck_key,</span>
<span class="lineNum">    7945 </span>                :<span class="lineNoCov">          0 :                     salt, BP_GET_TYPE(bp), iv, mac, HDR_GET_PSIZE(hdr),</span>
<span class="lineNum">    7946 </span>                :<span class="lineNoCov">          0 :                     BP_SHOULD_BYTESWAP(bp), eabd, hdr-&gt;b_l1hdr.b_pabd,</span>
<span class="lineNum">    7947 </span>                :            :                     &amp;no_crypt);
<span class="lineNum">    7948 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (ret != 0) {</span>
<span class="lineNum">    7949 </span>                :<span class="lineNoCov">          0 :                         arc_free_data_abd(hdr, eabd, arc_hdr_size(hdr), hdr);</span>
<span class="lineNum">    7950 </span>                :<span class="lineNoCov">          0 :                         spa_keystore_dsl_key_rele(spa, dck, FTAG);</span>
<span class="lineNum">    7951 </span>                :            :                         goto error;
<span class="lineNum">    7952 </span>                :            :                 }
<span class="lineNum">    7953 </span>                :            : 
<span class="lineNum">    7954 </span>                :<span class="lineNoCov">          0 :                 spa_keystore_dsl_key_rele(spa, dck, FTAG);</span>
<span class="lineNum">    7955 </span>                :            : 
<span class="lineNum">    7956 </span>                :            :                 /*
<span class="lineNum">    7957 </span>                :            :                  * If we actually performed decryption, replace b_pabd
<span class="lineNum">    7958 </span>                :            :                  * with the decrypted data. Otherwise we can just throw
<span class="lineNum">    7959 </span>                :            :                  * our decryption buffer away.
<span class="lineNum">    7960 </span>                :            :                  */
<span class="lineNum">    7961 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (!no_crypt) {</span>
<span class="lineNum">    7962 </span>                :<span class="lineNoCov">          0 :                         arc_free_data_abd(hdr, hdr-&gt;b_l1hdr.b_pabd,</span>
<span class="lineNum">    7963 </span>                :            :                             arc_hdr_size(hdr), hdr);
<span class="lineNum">    7964 </span>                :<span class="lineNoCov">          0 :                         hdr-&gt;b_l1hdr.b_pabd = eabd;</span>
<span class="lineNum">    7965 </span>                :<span class="lineNoCov">          0 :                         zio-&gt;io_abd = eabd;</span>
<span class="lineNum">    7966 </span>                :            :                 } else {
<span class="lineNum">    7967 </span>                :<span class="lineNoCov">          0 :                         arc_free_data_abd(hdr, eabd, arc_hdr_size(hdr), hdr);</span>
<span class="lineNum">    7968 </span>                :            :                 }
<span class="lineNum">    7969 </span>                :            :         }
<span class="lineNum">    7970 </span>                :            : 
<span class="lineNum">    7971 </span>                :            :         /*
<span class="lineNum">    7972 </span>                :            :          * If the L2ARC block was compressed, but ARC compression
<span class="lineNum">    7973 </span>                :            :          * is disabled we decompress the data into a new buffer and
<span class="lineNum">    7974 </span>                :            :          * replace the existing data.
<span class="lineNum">    7975 </span>                :            :          */
<span class="lineNum">    7976 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (HDR_GET_COMPRESS(hdr) != ZIO_COMPRESS_OFF &amp;&amp;</span>
<span class="lineNum">    7977 </span>                :<span class="lineNoCov">          0 :             !HDR_COMPRESSION_ENABLED(hdr)) {</span>
<span class="lineNum">    7978 </span>                :<span class="lineNoCov">          0 :                 abd_t *cabd = arc_get_data_abd(hdr, arc_hdr_size(hdr), hdr);</span>
<span class="lineNum">    7979 </span>                :<span class="lineNoCov">          0 :                 void *tmp = abd_borrow_buf(cabd, arc_hdr_size(hdr));</span>
<span class="lineNum">    7980 </span>                :            : 
<span class="lineNum">    7981 </span>                :<span class="lineNoCov">          0 :                 ret = zio_decompress_data(HDR_GET_COMPRESS(hdr),</span>
<span class="lineNum">    7982 </span>                :<span class="lineNoCov">          0 :                     hdr-&gt;b_l1hdr.b_pabd, tmp, HDR_GET_PSIZE(hdr),</span>
<span class="lineNum">    7983 </span>                :<span class="lineNoCov">          0 :                     HDR_GET_LSIZE(hdr));</span>
<span class="lineNum">    7984 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (ret != 0) {</span>
<span class="lineNum">    7985 </span>                :<span class="lineNoCov">          0 :                         abd_return_buf_copy(cabd, tmp, arc_hdr_size(hdr));</span>
<span class="lineNum">    7986 </span>                :<span class="lineNoCov">          0 :                         arc_free_data_abd(hdr, cabd, arc_hdr_size(hdr), hdr);</span>
<span class="lineNum">    7987 </span>                :            :                         goto error;
<span class="lineNum">    7988 </span>                :            :                 }
<span class="lineNum">    7989 </span>                :            : 
<span class="lineNum">    7990 </span>                :<span class="lineNoCov">          0 :                 abd_return_buf_copy(cabd, tmp, arc_hdr_size(hdr));</span>
<span class="lineNum">    7991 </span>                :<span class="lineNoCov">          0 :                 arc_free_data_abd(hdr, hdr-&gt;b_l1hdr.b_pabd,</span>
<span class="lineNum">    7992 </span>                :            :                     arc_hdr_size(hdr), hdr);
<span class="lineNum">    7993 </span>                :<span class="lineNoCov">          0 :                 hdr-&gt;b_l1hdr.b_pabd = cabd;</span>
<span class="lineNum">    7994 </span>                :<span class="lineNoCov">          0 :                 zio-&gt;io_abd = cabd;</span>
<span class="lineNum">    7995 </span>                :<span class="lineNoCov">          0 :                 zio-&gt;io_size = HDR_GET_LSIZE(hdr);</span>
<span class="lineNum">    7996 </span>                :            :         }
<span class="lineNum">    7997 </span>                :            : 
<span class="lineNum">    7998 </span>                :            :         return (0);
<span class="lineNum">    7999 </span>                :            : 
<span class="lineNum">    8000 </span>                :            : error:
<span class="lineNum">    8001 </span>                :            :         return (ret);
<span class="lineNum">    8002 </span>                :            : }
<span class="lineNum">    8003 </span>                :            : 
<span class="lineNum">    8004 </span>                :            : 
<span class="lineNum">    8005 </span>                :            : /*
<span class="lineNum">    8006 </span>                :            :  * A read to a cache device completed.  Validate buffer contents before
<span class="lineNum">    8007 </span>                :            :  * handing over to the regular ARC routines.
<a name="8008"><span class="lineNum">    8008 </span>                :            :  */</a>
<span class="lineNum">    8009 </span>                :            : static void
<span class="lineNum">    8010 </span>                :<span class="lineNoCov">          0 : l2arc_read_done(zio_t *zio)</span>
<span class="lineNum">    8011 </span>                :            : {
<span class="lineNum">    8012 </span>                :<span class="lineNoCov">          0 :         int tfm_error = 0;</span>
<span class="lineNum">    8013 </span>                :            :         l2arc_read_callback_t *cb;
<span class="lineNum">    8014 </span>                :            :         arc_buf_hdr_t *hdr;
<span class="lineNum">    8015 </span>                :            :         kmutex_t *hash_lock;
<span class="lineNum">    8016 </span>                :            :         boolean_t valid_cksum, using_rdata;
<span class="lineNum">    8017 </span>                :            : 
<span class="lineNum">    8018 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3P(zio-&gt;io_vd, !=, NULL);</span>
<span class="lineNum">    8019 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(zio-&gt;io_flags &amp; ZIO_FLAG_DONT_PROPAGATE);</span>
<span class="lineNum">    8020 </span>                :            : 
<span class="lineNum">    8021 </span>                :<span class="lineNoCov">          0 :         spa_config_exit(zio-&gt;io_spa, SCL_L2ARC, zio-&gt;io_vd);</span>
<span class="lineNum">    8022 </span>                :            : 
<span class="lineNum">    8023 </span>                :<span class="lineNoCov">          0 :         cb = zio-&gt;io_private;</span>
<span class="lineNum">    8024 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3P(cb, !=, NULL);</span>
<span class="lineNum">    8025 </span>                :<span class="lineNoCov">          0 :         hdr = cb-&gt;l2rcb_hdr;</span>
<span class="lineNum">    8026 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3P(hdr, !=, NULL);</span>
<span class="lineNum">    8027 </span>                :            : 
<span class="lineNum">    8028 </span>                :<span class="lineNoCov">          0 :         hash_lock = HDR_LOCK(hdr);</span>
<span class="lineNum">    8029 </span>                :<span class="lineNoCov">          0 :         mutex_enter(hash_lock);</span>
<span class="lineNum">    8030 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3P(hash_lock, ==, HDR_LOCK(hdr));</span>
<span class="lineNum">    8031 </span>                :            : 
<span class="lineNum">    8032 </span>                :            :         /*
<span class="lineNum">    8033 </span>                :            :          * If the data was read into a temporary buffer,
<span class="lineNum">    8034 </span>                :            :          * move it and free the buffer.
<span class="lineNum">    8035 </span>                :            :          */
<span class="lineNum">    8036 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (cb-&gt;l2rcb_abd != NULL) {</span>
<span class="lineNum">    8037 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3U(arc_hdr_size(hdr), &lt;, zio-&gt;io_size);</span>
<span class="lineNum">    8038 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (zio-&gt;io_error == 0) {</span>
<span class="lineNum">    8039 </span>                :<span class="lineNoCov">          0 :                         abd_copy(hdr-&gt;b_l1hdr.b_pabd, cb-&gt;l2rcb_abd,</span>
<span class="lineNum">    8040 </span>                :            :                             arc_hdr_size(hdr));
<span class="lineNum">    8041 </span>                :            :                 }
<span class="lineNum">    8042 </span>                :            : 
<span class="lineNum">    8043 </span>                :            :                 /*
<span class="lineNum">    8044 </span>                :            :                  * The following must be done regardless of whether
<span class="lineNum">    8045 </span>                :            :                  * there was an error:
<span class="lineNum">    8046 </span>                :            :                  * - free the temporary buffer
<span class="lineNum">    8047 </span>                :            :                  * - point zio to the real ARC buffer
<span class="lineNum">    8048 </span>                :            :                  * - set zio size accordingly
<span class="lineNum">    8049 </span>                :            :                  * These are required because zio is either re-used for
<span class="lineNum">    8050 </span>                :            :                  * an I/O of the block in the case of the error
<span class="lineNum">    8051 </span>                :            :                  * or the zio is passed to arc_read_done() and it
<span class="lineNum">    8052 </span>                :            :                  * needs real data.
<span class="lineNum">    8053 </span>                :            :                  */
<span class="lineNum">    8054 </span>                :<span class="lineNoCov">          0 :                 abd_free(cb-&gt;l2rcb_abd);</span>
<span class="lineNum">    8055 </span>                :<span class="lineNoCov">          0 :                 zio-&gt;io_size = zio-&gt;io_orig_size = arc_hdr_size(hdr);</span>
<span class="lineNum">    8056 </span>                :<span class="lineNoCov">          0 :                 zio-&gt;io_abd = zio-&gt;io_orig_abd = hdr-&gt;b_l1hdr.b_pabd;</span>
<span class="lineNum">    8057 </span>                :            :         }
<span class="lineNum">    8058 </span>                :            : 
<span class="lineNum">    8059 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT3P(zio-&gt;io_abd, !=, NULL);</span>
<span class="lineNum">    8060 </span>                :            : 
<span class="lineNum">    8061 </span>                :            :         /*
<span class="lineNum">    8062 </span>                :            :          * Check this survived the L2ARC journey.
<span class="lineNum">    8063 </span>                :            :          */
<span class="lineNum">    8064 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(zio-&gt;io_abd == hdr-&gt;b_l1hdr.b_pabd ||</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">    8065 </span>                :            :             (HDR_HAS_RABD(hdr) &amp;&amp; zio-&gt;io_abd == hdr-&gt;b_crypt_hdr.b_rabd));
<span class="lineNum">    8066 </span>                :<span class="lineNoCov">          0 :         zio-&gt;io_bp_copy = cb-&gt;l2rcb_bp;   /* XXX fix in L2ARC 2.0 */</span>
<span class="lineNum">    8067 </span>                :<span class="lineNoCov">          0 :         zio-&gt;io_bp = &amp;zio-&gt;io_bp_copy;        /* XXX fix in L2ARC 2.0 */</span>
<span class="lineNum">    8068 </span>                :            : 
<span class="lineNum">    8069 </span>                :<span class="lineNoCov">          0 :         valid_cksum = arc_cksum_is_equal(hdr, zio);</span>
<span class="lineNum">    8070 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         using_rdata = (HDR_HAS_RABD(hdr) &amp;&amp;</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    8071 </span>                :<span class="lineNoCov">          0 :             zio-&gt;io_abd == hdr-&gt;b_crypt_hdr.b_rabd);</span>
<span class="lineNum">    8072 </span>                :            : 
<span class="lineNum">    8073 </span>                :            :         /*
<span class="lineNum">    8074 </span>                :            :          * b_rabd will always match the data as it exists on disk if it is
<span class="lineNum">    8075 </span>                :            :          * being used. Therefore if we are reading into b_rabd we do not
<span class="lineNum">    8076 </span>                :            :          * attempt to untransform the data.
<span class="lineNum">    8077 </span>                :            :          */
<span class="lineNum">    8078 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (valid_cksum &amp;&amp; !using_rdata)</span>
<span class="lineNum">    8079 </span>                :<span class="lineNoCov">          0 :                 tfm_error = l2arc_untransform(zio, cb);</span>
<span class="lineNum">    8080 </span>                :            : 
<span class="lineNum">    8081 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (valid_cksum &amp;&amp; tfm_error == 0 &amp;&amp; zio-&gt;io_error == 0 &amp;&amp;</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    8082 </span>                :<span class="lineNoCov">          0 :             !HDR_L2_EVICTED(hdr)) {</span>
<span class="lineNum">    8083 </span>                :<span class="lineNoCov">          0 :                 mutex_exit(hash_lock);</span>
<span class="lineNum">    8084 </span>                :<span class="lineNoCov">          0 :                 zio-&gt;io_private = hdr;</span>
<span class="lineNum">    8085 </span>                :<span class="lineNoCov">          0 :                 arc_read_done(zio);</span>
<span class="lineNum">    8086 </span>                :            :         } else {
<span class="lineNum">    8087 </span>                :<span class="lineNoCov">          0 :                 mutex_exit(hash_lock);</span>
<span class="lineNum">    8088 </span>                :            :                 /*
<span class="lineNum">    8089 </span>                :            :                  * Buffer didn't survive caching.  Increment stats and
<span class="lineNum">    8090 </span>                :            :                  * reissue to the original storage device.
<span class="lineNum">    8091 </span>                :            :                  */
<span class="lineNum">    8092 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (zio-&gt;io_error != 0) {</span>
<span class="lineNum">    8093 </span>                :<span class="lineNoCov">          0 :                         ARCSTAT_BUMP(arcstat_l2_io_error);</span>
<span class="lineNum">    8094 </span>                :            :                 } else {
<span class="lineNum">    8095 </span>                :<span class="lineNoCov">          0 :                         zio-&gt;io_error = SET_ERROR(EIO);</span>
<span class="lineNum">    8096 </span>                :            :                 }
<span class="lineNum">    8097 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (!valid_cksum || tfm_error != 0)</span>
<span class="lineNum">    8098 </span>                :<span class="lineNoCov">          0 :                         ARCSTAT_BUMP(arcstat_l2_cksum_bad);</span>
<span class="lineNum">    8099 </span>                :            : 
<span class="lineNum">    8100 </span>                :            :                 /*
<span class="lineNum">    8101 </span>                :            :                  * If there's no waiter, issue an async i/o to the primary
<span class="lineNum">    8102 </span>                :            :                  * storage now.  If there *is* a waiter, the caller must
<span class="lineNum">    8103 </span>                :            :                  * issue the i/o in a context where it's OK to block.
<span class="lineNum">    8104 </span>                :            :                  */
<span class="lineNum">    8105 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (zio-&gt;io_waiter == NULL) {</span>
<span class="lineNum">    8106 </span>                :<span class="lineNoCov">          0 :                         zio_t *pio = zio_unique_parent(zio);</span>
<span class="lineNum">    8107 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         void *abd = (using_rdata) ?</span>
<span class="lineNum">    8108 </span>                :            :                             hdr-&gt;b_crypt_hdr.b_rabd : hdr-&gt;b_l1hdr.b_pabd;
<span class="lineNum">    8109 </span>                :            : 
<span class="lineNum">    8110 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         ASSERT(!pio || pio-&gt;io_child_type == ZIO_CHILD_LOGICAL);</span>
<span class="lineNum">    8111 </span>                :            : 
<span class="lineNum">    8112 </span>                :<span class="lineNoCov">          0 :                         zio_nowait(zio_read(pio, zio-&gt;io_spa, zio-&gt;io_bp,</span>
<span class="lineNum">    8113 </span>                :            :                             abd, zio-&gt;io_size, arc_read_done,
<span class="lineNum">    8114 </span>                :<span class="lineNoCov">          0 :                             hdr, zio-&gt;io_priority, cb-&gt;l2rcb_flags,</span>
<span class="lineNum">    8115 </span>                :<span class="lineNoCov">          0 :                             &amp;cb-&gt;l2rcb_zb));</span>
<span class="lineNum">    8116 </span>                :            :                 }
<span class="lineNum">    8117 </span>                :            :         }
<span class="lineNum">    8118 </span>                :            : 
<span class="lineNum">    8119 </span>                :<span class="lineNoCov">          0 :         kmem_free(cb, sizeof (l2arc_read_callback_t));</span>
<span class="lineNum">    8120 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">    8121 </span>                :            : 
<span class="lineNum">    8122 </span>                :            : /*
<span class="lineNum">    8123 </span>                :            :  * This is the list priority from which the L2ARC will search for pages to
<span class="lineNum">    8124 </span>                :            :  * cache.  This is used within loops (0..3) to cycle through lists in the
<span class="lineNum">    8125 </span>                :            :  * desired order.  This order can have a significant effect on cache
<span class="lineNum">    8126 </span>                :            :  * performance.
<span class="lineNum">    8127 </span>                :            :  *
<span class="lineNum">    8128 </span>                :            :  * Currently the metadata lists are hit first, MFU then MRU, followed by
<span class="lineNum">    8129 </span>                :            :  * the data lists.  This function returns a locked list, and also returns
<span class="lineNum">    8130 </span>                :            :  * the lock pointer.
<a name="8131"><span class="lineNum">    8131 </span>                :            :  */</a>
<span class="lineNum">    8132 </span>                :            : static multilist_sublist_t *
<span class="lineNum">    8133 </span>                :<span class="lineCov">       1560 : l2arc_sublist_lock(int list_num)</span>
<span class="lineNum">    8134 </span>                :            : {
<span class="lineNum">    8135 </span>                :<span class="lineCov">       1560 :         multilist_t *ml = NULL;</span>
<span class="lineNum">    8136 </span>                :            :         unsigned int idx;
<span class="lineNum">    8137 </span>                :            : 
<span class="lineNum">    8138 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1560 times"> + </span>]:<span class="lineCov">       1560 :         ASSERT(list_num &gt;= 0 &amp;&amp; list_num &lt; L2ARC_FEED_TYPES);</span>
<span class="lineNum">    8139 </span>                :            : 
<span class="lineNum">    8140 </span>  [<span class="branchCov" title="Branch 0 was taken 390 times"> + </span><span class="branchCov" title="Branch 1 was taken 390 times"> + </span><span class="branchCov" title="Branch 2 was taken 390 times"> + </span><span class="branchCov" title="Branch 3 was taken 390 times"> + </span> :<span class="lineCov">       1560 :         switch (list_num) {</span>
<span class="lineNum">         </span>            <span class="branchNoCov" title="Branch 4 was not taken"> - </span>]
<span class="lineNum">    8141 </span>                :            :         case 0:
<span class="lineNum">    8142 </span>                :<span class="lineCov">        390 :                 ml = arc_mfu-&gt;arcs_list[ARC_BUFC_METADATA];</span>
<span class="lineNum">    8143 </span>                :<span class="lineCov">        390 :                 break;</span>
<span class="lineNum">    8144 </span>                :            :         case 1:
<span class="lineNum">    8145 </span>                :<span class="lineCov">        390 :                 ml = arc_mru-&gt;arcs_list[ARC_BUFC_METADATA];</span>
<span class="lineNum">    8146 </span>                :<span class="lineCov">        390 :                 break;</span>
<span class="lineNum">    8147 </span>                :            :         case 2:
<span class="lineNum">    8148 </span>                :<span class="lineCov">        390 :                 ml = arc_mfu-&gt;arcs_list[ARC_BUFC_DATA];</span>
<span class="lineNum">    8149 </span>                :<span class="lineCov">        390 :                 break;</span>
<span class="lineNum">    8150 </span>                :            :         case 3:
<span class="lineNum">    8151 </span>                :<span class="lineCov">        390 :                 ml = arc_mru-&gt;arcs_list[ARC_BUFC_DATA];</span>
<span class="lineNum">    8152 </span>                :<span class="lineCov">        390 :                 break;</span>
<span class="lineNum">    8153 </span>                :            :         default:
<span class="lineNum">    8154 </span>                :            :                 return (NULL);
<span class="lineNum">    8155 </span>                :            :         }
<span class="lineNum">    8156 </span>                :            : 
<span class="lineNum">    8157 </span>                :            :         /*
<span class="lineNum">    8158 </span>                :            :          * Return a randomly-selected sublist. This is acceptable
<span class="lineNum">    8159 </span>                :            :          * because the caller feeds only a little bit of data for each
<span class="lineNum">    8160 </span>                :            :          * call (8MB). Subsequent calls will result in different
<span class="lineNum">    8161 </span>                :            :          * sublists being selected.
<span class="lineNum">    8162 </span>                :            :          */
<span class="lineNum">    8163 </span>                :<span class="lineCov">       1560 :         idx = multilist_get_random_index(ml);</span>
<span class="lineNum">    8164 </span>                :<span class="lineCov">       1560 :         return (multilist_sublist_lock(ml, idx));</span>
<span class="lineNum">    8165 </span>                :            : }
<span class="lineNum">    8166 </span>                :            : 
<span class="lineNum">    8167 </span>                :            : /*
<span class="lineNum">    8168 </span>                :            :  * Evict buffers from the device write hand to the distance specified in
<span class="lineNum">    8169 </span>                :            :  * bytes.  This distance may span populated buffers, it may span nothing.
<span class="lineNum">    8170 </span>                :            :  * This is clearing a region on the L2ARC device ready for writing.
<span class="lineNum">    8171 </span>                :            :  * If the 'all' boolean is set, every buffer is evicted.
<a name="8172"><span class="lineNum">    8172 </span>                :            :  */</a>
<span class="lineNum">    8173 </span>                :            : static void
<span class="lineNum">    8174 </span>                :<span class="lineCov">        535 : l2arc_evict(l2arc_dev_t *dev, uint64_t distance, boolean_t all)</span>
<span class="lineNum">    8175 </span>                :            : {
<span class="lineNum">    8176 </span>                :            :         list_t *buflist;
<span class="lineNum">    8177 </span>                :            :         arc_buf_hdr_t *hdr, *hdr_prev;
<span class="lineNum">    8178 </span>                :            :         kmutex_t *hash_lock;
<span class="lineNum">    8179 </span>                :            :         uint64_t taddr;
<span class="lineNum">    8180 </span>                :            : 
<span class="lineNum">    8181 </span>                :<span class="lineCov">        535 :         buflist = &amp;dev-&gt;l2ad_buflist;</span>
<span class="lineNum">    8182 </span>                :            : 
<span class="lineNum">    8183 </span>[<span class="branchCov" title="Branch 0 was taken 390 times"> + </span><span class="branchCov" title="Branch 1 was taken 145 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 390 times"> + </span>]:<span class="lineCov">        535 :         if (!all &amp;&amp; dev-&gt;l2ad_first) {</span>
<span class="lineNum">    8184 </span>                :            :                 /*
<span class="lineNum">    8185 </span>                :            :                  * This is the first sweep through the device.  There is
<span class="lineNum">    8186 </span>                :            :                  * nothing to evict.
<span class="lineNum">    8187 </span>                :            :                  */
<span class="lineNum">    8188 </span>                :            :                 return;
<span class="lineNum">    8189 </span>                :            :         }
<span class="lineNum">    8190 </span>                :            : 
<span class="lineNum">    8191 </span>        [<span class="branchCov" title="Branch 0 was taken 145 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        145 :         if (dev-&gt;l2ad_hand &gt;= (dev-&gt;l2ad_end - (2 * distance))) {</span>
<span class="lineNum">    8192 </span>                :            :                 /*
<span class="lineNum">    8193 </span>                :            :                  * When nearing the end of the device, evict to the end
<span class="lineNum">    8194 </span>                :            :                  * before the device write hand jumps to the start.
<span class="lineNum">    8195 </span>                :            :                  */
<span class="lineNum">    8196 </span>                :            :                 taddr = dev-&gt;l2ad_end;
<span class="lineNum">    8197 </span>                :            :         } else {
<span class="lineNum">    8198 </span>                :<span class="lineCov">        145 :                 taddr = dev-&gt;l2ad_hand + distance;</span>
<span class="lineNum">    8199 </span>                :            :         }
<span class="lineNum">    8200 </span>                :            :         DTRACE_PROBE4(l2arc__evict, l2arc_dev_t *, dev, list_t *, buflist,
<span class="lineNum">    8201 </span>                :            :             uint64_t, taddr, boolean_t, all);
<span class="lineNum">    8202 </span>                :            : 
<span class="lineNum">    8203 </span>                :            : top:
<span class="lineNum">    8204 </span>                :<span class="lineCov">        145 :         mutex_enter(&amp;dev-&gt;l2ad_mtx);</span>
<span class="lineNum">    8205 </span>        [<span class="branchCov" title="Branch 2 was taken 2760 times"> + </span><span class="branchCov" title="Branch 3 was taken 145 times"> + </span>]:<span class="lineCov">       2905 :         for (hdr = list_tail(buflist); hdr; hdr = hdr_prev) {</span>
<span class="lineNum">    8206 </span>                :<span class="lineCov">       2760 :                 hdr_prev = list_prev(buflist, hdr);</span>
<span class="lineNum">    8207 </span>                :            : 
<span class="lineNum">    8208 </span>                :<span class="lineCov">       2760 :                 hash_lock = HDR_LOCK(hdr);</span>
<span class="lineNum">    8209 </span>                :            : 
<span class="lineNum">    8210 </span>                :            :                 /*
<span class="lineNum">    8211 </span>                :            :                  * We cannot use mutex_enter or else we can deadlock
<span class="lineNum">    8212 </span>                :            :                  * with l2arc_write_buffers (due to swapping the order
<span class="lineNum">    8213 </span>                :            :                  * the hash lock and l2ad_mtx are taken).
<span class="lineNum">    8214 </span>                :            :                  */
<span class="lineNum">    8215 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2760 times"> + </span>]:<span class="lineCov">       2760 :                 if (!mutex_tryenter(hash_lock)) {</span>
<span class="lineNum">    8216 </span>                :            :                         /*
<span class="lineNum">    8217 </span>                :            :                          * Missed the hash lock.  Retry.
<span class="lineNum">    8218 </span>                :            :                          */
<span class="lineNum">    8219 </span>                :<span class="lineNoCov">          0 :                         ARCSTAT_BUMP(arcstat_l2_evict_lock_retry);</span>
<span class="lineNum">    8220 </span>                :<span class="lineNoCov">          0 :                         mutex_exit(&amp;dev-&gt;l2ad_mtx);</span>
<span class="lineNum">    8221 </span>                :<span class="lineNoCov">          0 :                         mutex_enter(hash_lock);</span>
<span class="lineNum">    8222 </span>                :<span class="lineNoCov">          0 :                         mutex_exit(hash_lock);</span>
<span class="lineNum">    8223 </span>                :<span class="lineNoCov">          0 :                         goto top;</span>
<span class="lineNum">    8224 </span>                :            :                 }
<span class="lineNum">    8225 </span>                :            : 
<span class="lineNum">    8226 </span>                :            :                 /*
<span class="lineNum">    8227 </span>                :            :                  * A header can't be on this list if it doesn't have L2 header.
<span class="lineNum">    8228 </span>                :            :                  */
<span class="lineNum">    8229 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2760 times"> + </span>]:<span class="lineCov">       2760 :                 ASSERT(HDR_HAS_L2HDR(hdr));</span>
<span class="lineNum">    8230 </span>                :            : 
<span class="lineNum">    8231 </span>                :            :                 /* Ensure this header has finished being written. */
<span class="lineNum">    8232 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2760 times"> + </span>]:<span class="lineCov">       2760 :                 ASSERT(!HDR_L2_WRITING(hdr));</span>
<span class="lineNum">    8233 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2760 times"> + </span>]:<span class="lineCov">       2760 :                 ASSERT(!HDR_L2_WRITE_HEAD(hdr));</span>
<span class="lineNum">    8234 </span>                :            : 
<span class="lineNum">    8235 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2760 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       2760 :                 if (!all &amp;&amp; (hdr-&gt;b_l2hdr.b_daddr &gt;= taddr ||</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    8236 </span>                :<span class="lineNoCov">          0 :                     hdr-&gt;b_l2hdr.b_daddr &lt; dev-&gt;l2ad_hand)) {</span>
<span class="lineNum">    8237 </span>                :            :                         /*
<span class="lineNum">    8238 </span>                :            :                          * We've evicted to the target address,
<span class="lineNum">    8239 </span>                :            :                          * or the end of the device.
<span class="lineNum">    8240 </span>                :            :                          */
<span class="lineNum">    8241 </span>                :<span class="lineNoCov">          0 :                         mutex_exit(hash_lock);</span>
<span class="lineNum">    8242 </span>                :<span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    8243 </span>                :            :                 }
<span class="lineNum">    8244 </span>                :            : 
<span class="lineNum">    8245 </span>        [<span class="branchCov" title="Branch 0 was taken 2744 times"> + </span><span class="branchCov" title="Branch 1 was taken 16 times"> + </span>]:<span class="lineCov">       2760 :                 if (!HDR_HAS_L1HDR(hdr)) {</span>
<span class="lineNum">    8246 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2744 times"> + </span>]:<span class="lineCov">       2744 :                         ASSERT(!HDR_L2_READING(hdr));</span>
<span class="lineNum">    8247 </span>                :            :                         /*
<span class="lineNum">    8248 </span>                :            :                          * This doesn't exist in the ARC.  Destroy.
<span class="lineNum">    8249 </span>                :            :                          * arc_hdr_destroy() will call list_remove()
<span class="lineNum">    8250 </span>                :            :                          * and decrement arcstat_l2_lsize.
<span class="lineNum">    8251 </span>                :            :                          */
<span class="lineNum">    8252 </span>                :<span class="lineCov">       2744 :                         arc_change_state(arc_anon, hdr, hash_lock);</span>
<span class="lineNum">    8253 </span>                :<span class="lineCov">       2744 :                         arc_hdr_destroy(hdr);</span>
<span class="lineNum">    8254 </span>                :            :                 } else {
<span class="lineNum">    8255 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 16 times"> + </span>]:<span class="lineCov">         16 :                         ASSERT(hdr-&gt;b_l1hdr.b_state != arc_l2c_only);</span>
<span class="lineNum">    8256 </span>                :<span class="lineCov">         16 :                         ARCSTAT_BUMP(arcstat_l2_evict_l1cached);</span>
<span class="lineNum">    8257 </span>                :            :                         /*
<span class="lineNum">    8258 </span>                :            :                          * Invalidate issued or about to be issued
<span class="lineNum">    8259 </span>                :            :                          * reads, since we may be about to write
<span class="lineNum">    8260 </span>                :            :                          * over this location.
<span class="lineNum">    8261 </span>                :            :                          */
<span class="lineNum">    8262 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 16 times"> + </span>]:<span class="lineCov">         16 :                         if (HDR_L2_READING(hdr)) {</span>
<span class="lineNum">    8263 </span>                :<span class="lineNoCov">          0 :                                 ARCSTAT_BUMP(arcstat_l2_evict_reading);</span>
<span class="lineNum">    8264 </span>                :<span class="lineNoCov">          0 :                                 arc_hdr_set_flags(hdr, ARC_FLAG_L2_EVICTED);</span>
<span class="lineNum">    8265 </span>                :            :                         }
<span class="lineNum">    8266 </span>                :            : 
<span class="lineNum">    8267 </span>                :<span class="lineCov">         16 :                         arc_hdr_l2hdr_destroy(hdr);</span>
<span class="lineNum">    8268 </span>                :            :                 }
<span class="lineNum">    8269 </span>                :<span class="lineCov">       2760 :                 mutex_exit(hash_lock);</span>
<span class="lineNum">    8270 </span>                :            :         }
<span class="lineNum">    8271 </span>                :<span class="lineCov">        145 :         mutex_exit(&amp;dev-&gt;l2ad_mtx);</span>
<span class="lineNum">    8272 </span>                :            : }
<span class="lineNum">    8273 </span>                :            : 
<span class="lineNum">    8274 </span>                :            : /*
<span class="lineNum">    8275 </span>                :            :  * Handle any abd transforms that might be required for writing to the L2ARC.
<span class="lineNum">    8276 </span>                :            :  * If successful, this function will always return an abd with the data
<span class="lineNum">    8277 </span>                :            :  * transformed as it is on disk in a new abd of asize bytes.
<a name="8278"><span class="lineNum">    8278 </span>                :            :  */</a>
<span class="lineNum">    8279 </span>                :            : static int
<span class="lineNum">    8280 </span>                :<span class="lineCov">        985 : l2arc_apply_transforms(spa_t *spa, arc_buf_hdr_t *hdr, uint64_t asize,</span>
<span class="lineNum">    8281 </span>                :            :     abd_t **abd_out)
<span class="lineNum">    8282 </span>                :            : {
<span class="lineNum">    8283 </span>                :            :         int ret;
<span class="lineNum">    8284 </span>                :<span class="lineCov">        985 :         void *tmp = NULL;</span>
<span class="lineNum">    8285 </span>                :<span class="lineCov">        985 :         abd_t *cabd = NULL, *eabd = NULL, *to_write = hdr-&gt;b_l1hdr.b_pabd;</span>
<span class="lineNum">    8286 </span>                :<span class="lineCov">        985 :         enum zio_compress compress = HDR_GET_COMPRESS(hdr);</span>
<span class="lineNum">    8287 </span>                :<span class="lineCov">        985 :         uint64_t psize = HDR_GET_PSIZE(hdr);</span>
<span class="lineNum">    8288 </span>                :<span class="lineCov">        985 :         uint64_t size = arc_hdr_size(hdr);</span>
<span class="lineNum">    8289 </span>                :<span class="lineCov">        985 :         boolean_t ismd = HDR_ISTYPE_METADATA(hdr);</span>
<span class="lineNum">    8290 </span>                :<span class="lineCov">        985 :         boolean_t bswap = (hdr-&gt;b_l1hdr.b_byteswap != DMU_BSWAP_NUMFUNCS);</span>
<span class="lineNum">    8291 </span>                :<span class="lineCov">        985 :         dsl_crypto_key_t *dck = NULL;</span>
<span class="lineNum">    8292 </span>                :<span class="lineCov">        985 :         uint8_t mac[ZIO_DATA_MAC_LEN] = { 0 };</span>
<span class="lineNum">    8293 </span>                :            :         boolean_t no_crypt;
<span class="lineNum">    8294 </span>                :            : 
<span class="lineNum">    8295 </span>[<span class="branchCov" title="Branch 1 was taken 842 times"> + </span><span class="branchCov" title="Branch 2 was taken 143 times"> + </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 842 times"> + </span>]:<span class="lineCov">        985 :         ASSERT((HDR_GET_COMPRESS(hdr) != ZIO_COMPRESS_OFF &amp;&amp;</span>
<span class="lineNum">         </span>[<span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 143 times"> + </span>][<span class="branchNoExec" title="Branch 7 was not executed"> # </span><span class="branchNoExec" title="Branch 8 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 9 was not executed"> # </span><span class="branchNoExec" title="Branch 10 was not executed"> # </span>][<span class="branchNoExec" title="Branch 11 was not executed"> # </span><span class="branchNoExec" title="Branch 12 was not executed"> # </span>]
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 13 was taken 143 times"> + </span><span class="branchNoCov" title="Branch 14 was not taken"> - </span>][<span class="branchNoCov" title="Branch 15 was not taken"> - </span><span class="branchCov" title="Branch 16 was taken 143 times"> + </span>]
<span class="lineNum">    8296 </span>                :            :             !HDR_COMPRESSION_ENABLED(hdr)) ||
<span class="lineNum">    8297 </span>                :            :             HDR_ENCRYPTED(hdr) || HDR_SHARED_DATA(hdr) || psize != asize);
<span class="lineNum">    8298 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 985 times"> + </span>]:<span class="lineCov">        985 :         ASSERT3U(psize, &lt;=, asize);</span>
<span class="lineNum">    8299 </span>                :            : 
<span class="lineNum">    8300 </span>                :            :         /*
<span class="lineNum">    8301 </span>                :            :          * If this data simply needs its own buffer, we simply allocate it
<span class="lineNum">    8302 </span>                :            :          * and copy the data. This may be done to elimiate a depedency on a
<span class="lineNum">    8303 </span>                :            :          * shared buffer or to reallocate the buffer to match asize.
<span class="lineNum">    8304 </span>                :            :          */
<span class="lineNum">    8305 </span>[<span class="branchCov" title="Branch 0 was taken 842 times"> + </span><span class="branchCov" title="Branch 1 was taken 143 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 842 times"> + </span>]:<span class="lineCov">        985 :         if ((compress == ZIO_COMPRESS_OFF || HDR_COMPRESSION_ENABLED(hdr)) &amp;&amp;</span>
<span class="lineNum">         </span>[<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken 143 times"> + </span>][<span class="branchNoExec" title="Branch 6 was not executed"> # </span><span class="branchNoExec" title="Branch 7 was not executed"> # </span>]
<span class="lineNum">    8306 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             !HDR_ENCRYPTED(hdr)) {</span>
<span class="lineNum">    8307 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 143 times"> + </span>]:<span class="lineCov">        143 :                 ASSERT3U(size, ==, psize);</span>
<span class="lineNum">    8308 </span>                :<span class="lineCov">        143 :                 to_write = abd_alloc_for_io(asize, ismd);</span>
<span class="lineNum">    8309 </span>                :<span class="lineCov">        143 :                 abd_copy(to_write, hdr-&gt;b_l1hdr.b_pabd, size);</span>
<span class="lineNum">    8310 </span>        [<span class="branchCov" title="Branch 0 was taken 143 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        143 :                 if (size != asize)</span>
<span class="lineNum">    8311 </span>                :<span class="lineCov">        143 :                         abd_zero_off(to_write, size, asize - size);</span>
<span class="lineNum">    8312 </span>                :            :                 goto out;
<span class="lineNum">    8313 </span>                :            :         }
<span class="lineNum">    8314 </span>                :            : 
<span class="lineNum">    8315 </span>[<span class="branchCov" title="Branch 0 was taken 842 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 842 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">        842 :         if (compress != ZIO_COMPRESS_OFF &amp;&amp; !HDR_COMPRESSION_ENABLED(hdr)) {</span>
<span class="lineNum">    8316 </span>                :<span class="lineCov">        842 :                 cabd = abd_alloc_for_io(asize, ismd);</span>
<span class="lineNum">    8317 </span>                :<span class="lineCov">        842 :                 tmp = abd_borrow_buf(cabd, asize);</span>
<span class="lineNum">    8318 </span>                :            : 
<span class="lineNum">    8319 </span>                :<span class="lineCov">        842 :                 psize = zio_compress_data(compress, to_write, tmp, size);</span>
<span class="lineNum">    8320 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 842 times"> + </span>]:<span class="lineCov">        842 :                 ASSERT3U(psize, &lt;=, HDR_GET_PSIZE(hdr));</span>
<span class="lineNum">    8321 </span>        [<span class="branchCov" title="Branch 0 was taken 842 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        842 :                 if (psize &lt; asize)</span>
<span class="lineNum">    8322 </span>                :<span class="lineCov">        842 :                         bzero((char *)tmp + psize, asize - psize);</span>
<span class="lineNum">    8323 </span>                :<span class="lineCov">        842 :                 psize = HDR_GET_PSIZE(hdr);</span>
<span class="lineNum">    8324 </span>                :<span class="lineCov">        842 :                 abd_return_buf_copy(cabd, tmp, asize);</span>
<span class="lineNum">    8325 </span>                :<span class="lineCov">        842 :                 to_write = cabd;</span>
<span class="lineNum">    8326 </span>                :            :         }
<span class="lineNum">    8327 </span>                :            : 
<span class="lineNum">    8328 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 842 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">        842 :         if (HDR_ENCRYPTED(hdr)) {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    8329 </span>                :<span class="lineNoCov">          0 :                 eabd = abd_alloc_for_io(asize, ismd);</span>
<span class="lineNum">    8330 </span>                :            : 
<span class="lineNum">    8331 </span>                :            :                 /*
<span class="lineNum">    8332 </span>                :            :                  * If the dataset was disowned before the buffer
<span class="lineNum">    8333 </span>                :            :                  * made it to this point, the key to re-encrypt
<span class="lineNum">    8334 </span>                :            :                  * it won't be available. In this case we simply
<span class="lineNum">    8335 </span>                :            :                  * won't write the buffer to the L2ARC.
<span class="lineNum">    8336 </span>                :            :                  */
<span class="lineNum">    8337 </span>                :<span class="lineNoCov">          0 :                 ret = spa_keystore_lookup_key(spa, hdr-&gt;b_crypt_hdr.b_dsobj,</span>
<span class="lineNum">    8338 </span>                :            :                     FTAG, &amp;dck);
<span class="lineNum">    8339 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (ret != 0)</span>
<span class="lineNum">    8340 </span>                :            :                         goto error;
<span class="lineNum">    8341 </span>                :            : 
<span class="lineNum">    8342 </span>                :<span class="lineNoCov">          0 :                 ret = zio_do_crypt_abd(B_TRUE, &amp;dck-&gt;dck_key,</span>
<span class="lineNum">    8343 </span>                :<span class="lineNoCov">          0 :                     hdr-&gt;b_crypt_hdr.b_salt, hdr-&gt;b_crypt_hdr.b_ot,</span>
<span class="lineNum">    8344 </span>                :<span class="lineNoCov">          0 :                     hdr-&gt;b_crypt_hdr.b_iv, mac, psize, bswap, to_write,</span>
<span class="lineNum">    8345 </span>                :            :                     eabd, &amp;no_crypt);
<span class="lineNum">    8346 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (ret != 0)</span>
<span class="lineNum">    8347 </span>                :            :                         goto error;
<span class="lineNum">    8348 </span>                :            : 
<span class="lineNum">    8349 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (no_crypt) {</span>
<span class="lineNum">    8350 </span>                :<span class="lineNoCov">          0 :                         spa_keystore_dsl_key_rele(spa, dck, FTAG);</span>
<span class="lineNum">    8351 </span>                :<span class="lineNoCov">          0 :                         abd_free(eabd);</span>
<span class="lineNum">    8352 </span>                :<span class="lineNoCov">          0 :                         goto out;</span>
<span class="lineNum">    8353 </span>                :            :                 }
<span class="lineNum">    8354 </span>                :            : 
<span class="lineNum">    8355 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (psize != asize)</span>
<span class="lineNum">    8356 </span>                :<span class="lineNoCov">          0 :                         abd_zero_off(eabd, psize, asize - psize);</span>
<span class="lineNum">    8357 </span>                :            : 
<span class="lineNum">    8358 </span>                :            :                 /* assert that the MAC we got here matches the one we saved */
<span class="lineNum">    8359 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT0(bcmp(mac, hdr-&gt;b_crypt_hdr.b_mac, ZIO_DATA_MAC_LEN));</span>
<span class="lineNum">    8360 </span>                :<span class="lineNoCov">          0 :                 spa_keystore_dsl_key_rele(spa, dck, FTAG);</span>
<span class="lineNum">    8361 </span>                :            : 
<span class="lineNum">    8362 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (to_write == cabd)</span>
<span class="lineNum">    8363 </span>                :<span class="lineNoCov">          0 :                         abd_free(cabd);</span>
<span class="lineNum">    8364 </span>                :            : 
<span class="lineNum">    8365 </span>                :            :                 to_write = eabd;
<span class="lineNum">    8366 </span>                :            :         }
<span class="lineNum">    8367 </span>                :            : 
<span class="lineNum">    8368 </span>                :            : out:
<span class="lineNum">    8369 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 985 times"> + </span>]:<span class="lineCov">        985 :         ASSERT3P(to_write, !=, hdr-&gt;b_l1hdr.b_pabd);</span>
<span class="lineNum">    8370 </span>                :<span class="lineCov">        985 :         *abd_out = to_write;</span>
<span class="lineNum">    8371 </span>                :<span class="lineCov">        985 :         return (0);</span>
<span class="lineNum">    8372 </span>                :            : 
<span class="lineNum">    8373 </span>                :            : error:
<span class="lineNum">    8374 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (dck != NULL)</span>
<span class="lineNum">    8375 </span>                :<span class="lineNoCov">          0 :                 spa_keystore_dsl_key_rele(spa, dck, FTAG);</span>
<span class="lineNum">    8376 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (cabd != NULL)</span>
<span class="lineNum">    8377 </span>                :<span class="lineNoCov">          0 :                 abd_free(cabd);</span>
<span class="lineNum">    8378 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (eabd != NULL)</span>
<span class="lineNum">    8379 </span>                :<span class="lineNoCov">          0 :                 abd_free(eabd);</span>
<span class="lineNum">    8380 </span>                :            : 
<span class="lineNum">    8381 </span>                :<span class="lineNoCov">          0 :         *abd_out = NULL;</span>
<span class="lineNum">    8382 </span>                :<span class="lineNoCov">          0 :         return (ret);</span>
<span class="lineNum">    8383 </span>                :            : }
<span class="lineNum">    8384 </span>                :            : 
<span class="lineNum">    8385 </span>                :            : /*
<span class="lineNum">    8386 </span>                :            :  * Find and write ARC buffers to the L2ARC device.
<span class="lineNum">    8387 </span>                :            :  *
<span class="lineNum">    8388 </span>                :            :  * An ARC_FLAG_L2_WRITING flag is set so that the L2ARC buffers are not valid
<span class="lineNum">    8389 </span>                :            :  * for reading until they have completed writing.
<span class="lineNum">    8390 </span>                :            :  * The headroom_boost is an in-out parameter used to maintain headroom boost
<span class="lineNum">    8391 </span>                :            :  * state between calls to this function.
<span class="lineNum">    8392 </span>                :            :  *
<span class="lineNum">    8393 </span>                :            :  * Returns the number of bytes actually written (which may be smaller than
<span class="lineNum">    8394 </span>                :            :  * the delta by which the device hand has changed due to alignment).
<a name="8395"><span class="lineNum">    8395 </span>                :            :  */</a>
<span class="lineNum">    8396 </span>                :            : static uint64_t
<span class="lineNum">    8397 </span>                :<span class="lineCov">        390 : l2arc_write_buffers(spa_t *spa, l2arc_dev_t *dev, uint64_t target_sz)</span>
<span class="lineNum">    8398 </span>                :            : {
<span class="lineNum">    8399 </span>                :            :         arc_buf_hdr_t *hdr, *hdr_prev, *head;
<span class="lineNum">    8400 </span>                :            :         uint64_t write_asize, write_psize, write_lsize, headroom;
<span class="lineNum">    8401 </span>                :            :         boolean_t full;
<span class="lineNum">    8402 </span>                :            :         l2arc_write_callback_t *cb;
<span class="lineNum">    8403 </span>                :            :         zio_t *pio, *wzio;
<span class="lineNum">    8404 </span>                :<span class="lineCov">        390 :         uint64_t guid = spa_load_guid(spa);</span>
<span class="lineNum">    8405 </span>                :            :         int try;
<span class="lineNum">    8406 </span>                :            : 
<span class="lineNum">    8407 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 390 times"> + </span>]:<span class="lineCov">        390 :         ASSERT3P(dev-&gt;l2ad_vdev, !=, NULL);</span>
<span class="lineNum">    8408 </span>                :            : 
<span class="lineNum">    8409 </span>                :<span class="lineCov">        390 :         pio = NULL;</span>
<span class="lineNum">    8410 </span>                :<span class="lineCov">        390 :         write_lsize = write_asize = write_psize = 0;</span>
<span class="lineNum">    8411 </span>                :<span class="lineCov">        390 :         full = B_FALSE;</span>
<span class="lineNum">    8412 </span>                :<span class="lineCov">        390 :         head = kmem_cache_alloc(hdr_l2only_cache, KM_PUSHPAGE);</span>
<span class="lineNum">    8413 </span>                :<span class="lineCov">        390 :         arc_hdr_set_flags(head, ARC_FLAG_L2_WRITE_HEAD | ARC_FLAG_HAS_L2HDR);</span>
<span class="lineNum">    8414 </span>                :            : 
<span class="lineNum">    8415 </span>                :            :         /*
<span class="lineNum">    8416 </span>                :            :          * Copy buffers for L2ARC writing.
<span class="lineNum">    8417 </span>                :            :          */
<span class="lineNum">    8418 </span>        [<span class="branchCov" title="Branch 1 was taken 1560 times"> + </span><span class="branchCov" title="Branch 2 was taken 390 times"> + </span>]:<span class="lineCov">       1950 :         for (try = 0; try &lt; L2ARC_FEED_TYPES; try++) {</span>
<span class="lineNum">    8419 </span>                :<span class="lineCov">       1560 :                 multilist_sublist_t *mls = l2arc_sublist_lock(try);</span>
<span class="lineNum">    8420 </span>                :<span class="lineCov">       1560 :                 uint64_t passed_sz = 0;</span>
<span class="lineNum">    8421 </span>                :            : 
<span class="lineNum">    8422 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1560 times"> + </span>]:<span class="lineCov">       1560 :                 VERIFY3P(mls, !=, NULL);</span>
<span class="lineNum">    8423 </span>                :            : 
<span class="lineNum">    8424 </span>                :            :                 /*
<span class="lineNum">    8425 </span>                :            :                  * L2ARC fast warmup.
<span class="lineNum">    8426 </span>                :            :                  *
<span class="lineNum">    8427 </span>                :            :                  * Until the ARC is warm and starts to evict, read from the
<span class="lineNum">    8428 </span>                :            :                  * head of the ARC lists rather than the tail.
<span class="lineNum">    8429 </span>                :            :                  */
<span class="lineNum">    8430 </span>        [<span class="branchCov" title="Branch 0 was taken 492 times"> + </span><span class="branchCov" title="Branch 1 was taken 1068 times"> + </span>]:<span class="lineCov">       1560 :                 if (arc_warm == B_FALSE)</span>
<span class="lineNum">    8431 </span>                :<span class="lineCov">        492 :                         hdr = multilist_sublist_head(mls);</span>
<span class="lineNum">    8432 </span>                :            :                 else
<span class="lineNum">    8433 </span>                :<span class="lineCov">       1068 :                         hdr = multilist_sublist_tail(mls);</span>
<span class="lineNum">    8434 </span>                :            : 
<span class="lineNum">    8435 </span>                :<span class="lineCov">       1560 :                 headroom = target_sz * l2arc_headroom;</span>
<span class="lineNum">    8436 </span>        [<span class="branchCov" title="Branch 0 was taken 908 times"> + </span><span class="branchCov" title="Branch 1 was taken 652 times"> + </span>]:<span class="lineCov">       1560 :                 if (zfs_compressed_arc_enabled)</span>
<span class="lineNum">    8437 </span>                :<span class="lineCov">       1560 :                         headroom = (headroom * l2arc_headroom_boost) / 100;</span>
<span class="lineNum">    8438 </span>                :            : 
<span class="lineNum">    8439 </span>        [<span class="branchCov" title="Branch 0 was taken 16325 times"> + </span><span class="branchCov" title="Branch 1 was taken 1560 times"> + </span>]:<span class="lineCov">      17885 :                 for (; hdr; hdr = hdr_prev) {</span>
<span class="lineNum">    8440 </span>                :            :                         kmutex_t *hash_lock;
<span class="lineNum">    8441 </span>                :<span class="lineCov">      16325 :                         abd_t *to_write = NULL;</span>
<span class="lineNum">    8442 </span>                :            : 
<span class="lineNum">    8443 </span>        [<span class="branchCov" title="Branch 0 was taken 2092 times"> + </span><span class="branchCov" title="Branch 1 was taken 14233 times"> + </span>]:<span class="lineCov">      16325 :                         if (arc_warm == B_FALSE)</span>
<span class="lineNum">    8444 </span>                :<span class="lineCov">       2092 :                                 hdr_prev = multilist_sublist_next(mls, hdr);</span>
<span class="lineNum">    8445 </span>                :            :                         else
<span class="lineNum">    8446 </span>                :<span class="lineCov">      14233 :                                 hdr_prev = multilist_sublist_prev(mls, hdr);</span>
<span class="lineNum">    8447 </span>                :            : 
<span class="lineNum">    8448 </span>                :<span class="lineCov">      16325 :                         hash_lock = HDR_LOCK(hdr);</span>
<span class="lineNum">    8449 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 16323 times"> + </span>]:<span class="lineCov">      16325 :                         if (!mutex_tryenter(hash_lock)) {</span>
<span class="lineNum">    8450 </span>                :            :                                 /*
<span class="lineNum">    8451 </span>                :            :                                  * Skip this buffer rather than waiting.
<span class="lineNum">    8452 </span>                :            :                                  */
<span class="lineNum">    8453 </span>                :<span class="lineCov">      13378 :                                 continue;</span>
<span class="lineNum">    8454 </span>                :            :                         }
<span class="lineNum">    8455 </span>                :            : 
<span class="lineNum">    8456 </span>                :<span class="lineCov">      16323 :                         passed_sz += HDR_GET_LSIZE(hdr);</span>
<span class="lineNum">    8457 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 16323 times"> + </span>]:<span class="lineCov">      16323 :                         if (passed_sz &gt; headroom) {</span>
<span class="lineNum">    8458 </span>                :            :                                 /*
<span class="lineNum">    8459 </span>                :            :                                  * Searched too far.
<span class="lineNum">    8460 </span>                :            :                                  */
<span class="lineNum">    8461 </span>                :<span class="lineNoCov">          0 :                                 mutex_exit(hash_lock);</span>
<span class="lineNum">    8462 </span>                :<span class="lineCov">      16325 :                                 break;</span>
<span class="lineNum">    8463 </span>                :            :                         }
<span class="lineNum">    8464 </span>                :            : 
<span class="lineNum">    8465 </span>        [<span class="branchCov" title="Branch 1 was taken 13376 times"> + </span><span class="branchCov" title="Branch 2 was taken 2947 times"> + </span>]:<span class="lineCov">      16323 :                         if (!l2arc_write_eligible(guid, hdr)) {</span>
<span class="lineNum">    8466 </span>                :<span class="lineCov">      13376 :                                 mutex_exit(hash_lock);</span>
<span class="lineNum">    8467 </span>                :<span class="lineCov">      13376 :                                 continue;</span>
<span class="lineNum">    8468 </span>                :            :                         }
<span class="lineNum">    8469 </span>                :            : 
<span class="lineNum">    8470 </span>                :            :                         /*
<span class="lineNum">    8471 </span>                :            :                          * We rely on the L1 portion of the header below, so
<span class="lineNum">    8472 </span>                :            :                          * it's invalid for this header to have been evicted out
<span class="lineNum">    8473 </span>                :            :                          * of the ghost cache, prior to being written out. The
<span class="lineNum">    8474 </span>                :            :                          * ARC_FLAG_L2_WRITING bit ensures this won't happen.
<span class="lineNum">    8475 </span>                :            :                          */
<span class="lineNum">    8476 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2947 times"> + </span>]:<span class="lineCov">       2947 :                         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    8477 </span>                :            : 
<span class="lineNum">    8478 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2947 times"> + </span>]:<span class="lineCov">       2947 :                         ASSERT3U(HDR_GET_PSIZE(hdr), &gt;, 0);</span>
<span class="lineNum">    8479 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2947 times"> + </span>]:<span class="lineCov">       2947 :                         ASSERT3U(arc_hdr_size(hdr), &gt;, 0);</span>
<span class="lineNum">    8480 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2947 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       2947 :                         ASSERT(hdr-&gt;b_l1hdr.b_pabd != NULL ||</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    8481 </span>                :            :                             HDR_HAS_RABD(hdr));
<span class="lineNum">    8482 </span>                :<span class="lineCov">       2947 :                         uint64_t psize = HDR_GET_PSIZE(hdr);</span>
<span class="lineNum">    8483 </span>                :<span class="lineCov">       2947 :                         uint64_t asize = vdev_psize_to_asize(dev-&gt;l2ad_vdev,</span>
<span class="lineNum">    8484 </span>                :            :                             psize);
<span class="lineNum">    8485 </span>                :            : 
<span class="lineNum">    8486 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2947 times"> + </span>]:<span class="lineCov">       2947 :                         if ((write_asize + asize) &gt; target_sz) {</span>
<span class="lineNum">    8487 </span>                :<span class="lineNoCov">          0 :                                 full = B_TRUE;</span>
<span class="lineNum">    8488 </span>                :<span class="lineNoCov">          0 :                                 mutex_exit(hash_lock);</span>
<span class="lineNum">    8489 </span>                :<span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    8490 </span>                :            :                         }
<span class="lineNum">    8491 </span>                :            : 
<span class="lineNum">    8492 </span>                :            :                         /*
<span class="lineNum">    8493 </span>                :            :                          * We rely on the L1 portion of the header below, so
<span class="lineNum">    8494 </span>                :            :                          * it's invalid for this header to have been evicted out
<span class="lineNum">    8495 </span>                :            :                          * of the ghost cache, prior to being written out. The
<span class="lineNum">    8496 </span>                :            :                          * ARC_FLAG_L2_WRITING bit ensures this won't happen.
<span class="lineNum">    8497 </span>                :            :                          */
<span class="lineNum">    8498 </span>                :<span class="lineCov">       2947 :                         arc_hdr_set_flags(hdr, ARC_FLAG_L2_WRITING);</span>
<span class="lineNum">    8499 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2947 times"> + </span>]:<span class="lineCov">       2947 :                         ASSERT(HDR_HAS_L1HDR(hdr));</span>
<span class="lineNum">    8500 </span>                :            : 
<span class="lineNum">    8501 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2947 times"> + </span>]:<span class="lineCov">       2947 :                         ASSERT3U(HDR_GET_PSIZE(hdr), &gt;, 0);</span>
<span class="lineNum">    8502 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2947 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       2947 :                         ASSERT(hdr-&gt;b_l1hdr.b_pabd != NULL ||</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    8503 </span>                :            :                             HDR_HAS_RABD(hdr));
<span class="lineNum">    8504 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2947 times"> + </span>]:<span class="lineCov">       2947 :                         ASSERT3U(arc_hdr_size(hdr), &gt;, 0);</span>
<span class="lineNum">    8505 </span>                :            : 
<span class="lineNum">    8506 </span>                :            :                         /*
<span class="lineNum">    8507 </span>                :            :                          * If this header has b_rabd, we can use this since it
<span class="lineNum">    8508 </span>                :            :                          * must always match the data exactly as it exists on
<span class="lineNum">    8509 </span>                :            :                          * disk. Otherwise, the L2ARC can  normally use the
<span class="lineNum">    8510 </span>                :            :                          * hdr's data, but if we're sharing data between the
<span class="lineNum">    8511 </span>                :            :                          * hdr and one of its bufs, L2ARC needs its own copy of
<span class="lineNum">    8512 </span>                :            :                          * the data so that the ZIO below can't race with the
<span class="lineNum">    8513 </span>                :            :                          * buf consumer. To ensure that this copy will be
<span class="lineNum">    8514 </span>                :            :                          * available for the lifetime of the ZIO and be cleaned
<span class="lineNum">    8515 </span>                :            :                          * up afterwards, we add it to the l2arc_free_on_write
<span class="lineNum">    8516 </span>                :            :                          * queue. If we need to apply any transforms to the
<span class="lineNum">    8517 </span>                :            :                          * data (compression, encryption) we will also need the
<span class="lineNum">    8518 </span>                :            :                          * extra buffer.
<span class="lineNum">    8519 </span>                :            :                          */
<span class="lineNum">    8520 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2947 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       2947 :                         if (HDR_HAS_RABD(hdr) &amp;&amp; psize == asize) {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    8521 </span>                :<span class="lineNoCov">          0 :                                 to_write = hdr-&gt;b_crypt_hdr.b_rabd;</span>
<span class="lineNum">    8522 </span>  [<span class="branchCov" title="Branch 0 was taken 1142 times"> + </span><span class="branchCov" title="Branch 1 was taken 1805 times"> + </span><span class="branchCov" title="Branch 2 was taken 300 times"> + </span><span class="branchCov" title="Branch 3 was taken 842 times"> + </span>]:<span class="lineCov">       4089 :                         } else if ((HDR_COMPRESSION_ENABLED(hdr) ||</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    8523 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2105 times"> + </span>]:<span class="lineCov">       3247 :                             HDR_GET_COMPRESS(hdr) == ZIO_COMPRESS_OFF) &amp;&amp;</span>
<span class="lineNum">    8524 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">       2105 :                             !HDR_ENCRYPTED(hdr) &amp;&amp; !HDR_SHARED_DATA(hdr) &amp;&amp;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 2105 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>][<span class="branchCov" title="Branch 6 was taken 1962 times"> + </span><span class="branchCov" title="Branch 7 was taken 143 times"> + </span>]
<span class="lineNum">    8525 </span>                :            :                             psize == asize) {
<span class="lineNum">    8526 </span>                :<span class="lineCov">       1962 :                                 to_write = hdr-&gt;b_l1hdr.b_pabd;</span>
<span class="lineNum">    8527 </span>                :            :                         } else {
<span class="lineNum">    8528 </span>                :            :                                 int ret;
<span class="lineNum">    8529 </span>                :<span class="lineCov">        985 :                                 arc_buf_contents_t type = arc_buf_type(hdr);</span>
<span class="lineNum">    8530 </span>                :            : 
<span class="lineNum">    8531 </span>                :<span class="lineCov">        985 :                                 ret = l2arc_apply_transforms(spa, hdr, asize,</span>
<span class="lineNum">    8532 </span>                :            :                                     &amp;to_write);
<span class="lineNum">    8533 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 985 times"> + </span>]:<span class="lineCov">        985 :                                 if (ret != 0) {</span>
<span class="lineNum">    8534 </span>                :<span class="lineNoCov">          0 :                                         arc_hdr_clear_flags(hdr,</span>
<span class="lineNum">    8535 </span>                :            :                                             ARC_FLAG_L2_WRITING);
<span class="lineNum">    8536 </span>                :<span class="lineNoCov">          0 :                                         mutex_exit(hash_lock);</span>
<span class="lineNum">    8537 </span>                :<span class="lineNoCov">          0 :                                         continue;</span>
<span class="lineNum">    8538 </span>                :            :                                 }
<span class="lineNum">    8539 </span>                :            : 
<span class="lineNum">    8540 </span>                :<span class="lineCov">        985 :                                 l2arc_free_abd_on_write(to_write, asize, type);</span>
<span class="lineNum">    8541 </span>                :            :                         }
<span class="lineNum">    8542 </span>                :            : 
<span class="lineNum">    8543 </span>        [<span class="branchCov" title="Branch 0 was taken 294 times"> + </span><span class="branchCov" title="Branch 1 was taken 2653 times"> + </span>]:<span class="lineCov">       2947 :                         if (pio == NULL) {</span>
<span class="lineNum">    8544 </span>                :            :                                 /*
<span class="lineNum">    8545 </span>                :            :                                  * Insert a dummy header on the buflist so
<span class="lineNum">    8546 </span>                :            :                                  * l2arc_write_done() can find where the
<span class="lineNum">    8547 </span>                :            :                                  * write buffers begin without searching.
<span class="lineNum">    8548 </span>                :            :                                  */
<span class="lineNum">    8549 </span>                :<span class="lineCov">        294 :                                 mutex_enter(&amp;dev-&gt;l2ad_mtx);</span>
<span class="lineNum">    8550 </span>                :<span class="lineCov">        294 :                                 list_insert_head(&amp;dev-&gt;l2ad_buflist, head);</span>
<span class="lineNum">    8551 </span>                :<span class="lineCov">        294 :                                 mutex_exit(&amp;dev-&gt;l2ad_mtx);</span>
<span class="lineNum">    8552 </span>                :            : 
<span class="lineNum">    8553 </span>                :<span class="lineCov">        294 :                                 cb = kmem_alloc(</span>
<span class="lineNum">    8554 </span>                :            :                                     sizeof (l2arc_write_callback_t), KM_SLEEP);
<span class="lineNum">    8555 </span>                :<span class="lineCov">        294 :                                 cb-&gt;l2wcb_dev = dev;</span>
<span class="lineNum">    8556 </span>                :<span class="lineCov">        294 :                                 cb-&gt;l2wcb_head = head;</span>
<span class="lineNum">    8557 </span>                :<span class="lineCov">        294 :                                 pio = zio_root(spa, l2arc_write_done, cb,</span>
<span class="lineNum">    8558 </span>                :            :                                     ZIO_FLAG_CANFAIL);
<span class="lineNum">    8559 </span>                :            :                         }
<span class="lineNum">    8560 </span>                :            : 
<span class="lineNum">    8561 </span>                :<span class="lineCov">       2947 :                         hdr-&gt;b_l2hdr.b_dev = dev;</span>
<span class="lineNum">    8562 </span>                :<span class="lineCov">       2947 :                         hdr-&gt;b_l2hdr.b_hits = 0;</span>
<span class="lineNum">    8563 </span>                :            : 
<span class="lineNum">    8564 </span>                :<span class="lineCov">       2947 :                         hdr-&gt;b_l2hdr.b_daddr = dev-&gt;l2ad_hand;</span>
<span class="lineNum">    8565 </span>                :<span class="lineCov">       2947 :                         arc_hdr_set_flags(hdr, ARC_FLAG_HAS_L2HDR);</span>
<span class="lineNum">    8566 </span>                :            : 
<span class="lineNum">    8567 </span>                :<span class="lineCov">       2947 :                         mutex_enter(&amp;dev-&gt;l2ad_mtx);</span>
<span class="lineNum">    8568 </span>                :<span class="lineCov">       2947 :                         list_insert_head(&amp;dev-&gt;l2ad_buflist, hdr);</span>
<span class="lineNum">    8569 </span>                :<span class="lineCov">       2947 :                         mutex_exit(&amp;dev-&gt;l2ad_mtx);</span>
<span class="lineNum">    8570 </span>                :            : 
<span class="lineNum">    8571 </span>                :<span class="lineCov">       2947 :                         (void) refcount_add_many(&amp;dev-&gt;l2ad_alloc,</span>
<span class="lineNum">    8572 </span>                :            :                             arc_hdr_size(hdr), hdr);
<span class="lineNum">    8573 </span>                :            : 
<span class="lineNum">    8574 </span>                :<span class="lineCov">       2947 :                         wzio = zio_write_phys(pio, dev-&gt;l2ad_vdev,</span>
<span class="lineNum">    8575 </span>                :            :                             hdr-&gt;b_l2hdr.b_daddr, asize, to_write,
<span class="lineNum">    8576 </span>                :            :                             ZIO_CHECKSUM_OFF, NULL, hdr,
<span class="lineNum">    8577 </span>                :            :                             ZIO_PRIORITY_ASYNC_WRITE,
<span class="lineNum">    8578 </span>                :            :                             ZIO_FLAG_CANFAIL, B_FALSE);
<span class="lineNum">    8579 </span>                :            : 
<span class="lineNum">    8580 </span>                :<span class="lineCov">       2947 :                         write_lsize += HDR_GET_LSIZE(hdr);</span>
<span class="lineNum">    8581 </span>                :            :                         DTRACE_PROBE2(l2arc__write, vdev_t *, dev-&gt;l2ad_vdev,
<span class="lineNum">    8582 </span>                :            :                             zio_t *, wzio);
<span class="lineNum">    8583 </span>                :            : 
<span class="lineNum">    8584 </span>                :<span class="lineCov">       2947 :                         write_psize += psize;</span>
<span class="lineNum">    8585 </span>                :<span class="lineCov">       2947 :                         write_asize += asize;</span>
<span class="lineNum">    8586 </span>                :<span class="lineCov">       2947 :                         dev-&gt;l2ad_hand += asize;</span>
<span class="lineNum">    8587 </span>                :            : 
<span class="lineNum">    8588 </span>                :<span class="lineCov">       2947 :                         mutex_exit(hash_lock);</span>
<span class="lineNum">    8589 </span>                :            : 
<span class="lineNum">    8590 </span>                :<span class="lineCov">       2947 :                         (void) zio_nowait(wzio);</span>
<span class="lineNum">    8591 </span>                :            :                 }
<span class="lineNum">    8592 </span>                :            : 
<span class="lineNum">    8593 </span>                :<span class="lineCov">       1560 :                 multilist_sublist_unlock(mls);</span>
<span class="lineNum">    8594 </span>                :            : 
<span class="lineNum">    8595 </span>        [<span class="branchCov" title="Branch 0 was taken 1560 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1560 :                 if (full == B_TRUE)</span>
<span class="lineNum">    8596 </span>                :            :                         break;
<span class="lineNum">    8597 </span>                :            :         }
<span class="lineNum">    8598 </span>                :            : 
<span class="lineNum">    8599 </span>                :            :         /* No buffers selected for writing? */
<span class="lineNum">    8600 </span>        [<span class="branchCov" title="Branch 0 was taken 96 times"> + </span><span class="branchCov" title="Branch 1 was taken 294 times"> + </span>]:<span class="lineCov">        390 :         if (pio == NULL) {</span>
<span class="lineNum">    8601 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 96 times"> + </span>]:<span class="lineCov">         96 :                 ASSERT0(write_lsize);</span>
<span class="lineNum">    8602 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 96 times"> + </span>]:<span class="lineCov">         96 :                 ASSERT(!HDR_HAS_L1HDR(head));</span>
<span class="lineNum">    8603 </span>                :<span class="lineCov">         96 :                 kmem_cache_free(hdr_l2only_cache, head);</span>
<span class="lineNum">    8604 </span>                :<span class="lineCov">         96 :                 return (0);</span>
<span class="lineNum">    8605 </span>                :            :         }
<span class="lineNum">    8606 </span>                :            : 
<span class="lineNum">    8607 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 294 times"> + </span>]:<span class="lineCov">        294 :         ASSERT3U(write_asize, &lt;=, target_sz);</span>
<span class="lineNum">    8608 </span>                :<span class="lineCov">        294 :         ARCSTAT_BUMP(arcstat_l2_writes_sent);</span>
<span class="lineNum">    8609 </span>                :<span class="lineCov">        294 :         ARCSTAT_INCR(arcstat_l2_write_bytes, write_psize);</span>
<span class="lineNum">    8610 </span>                :<span class="lineCov">        294 :         ARCSTAT_INCR(arcstat_l2_lsize, write_lsize);</span>
<span class="lineNum">    8611 </span>                :<span class="lineCov">        294 :         ARCSTAT_INCR(arcstat_l2_psize, write_psize);</span>
<span class="lineNum">    8612 </span>                :<span class="lineCov">        294 :         vdev_space_update(dev-&gt;l2ad_vdev, write_psize, 0, 0);</span>
<span class="lineNum">    8613 </span>                :            : 
<span class="lineNum">    8614 </span>                :            :         /*
<span class="lineNum">    8615 </span>                :            :          * Bump device hand to the device start if it is approaching the end.
<span class="lineNum">    8616 </span>                :            :          * l2arc_evict() will already have evicted ahead for this case.
<span class="lineNum">    8617 </span>                :            :          */
<span class="lineNum">    8618 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 294 times"> + </span>]:<span class="lineCov">        294 :         if (dev-&gt;l2ad_hand &gt;= (dev-&gt;l2ad_end - target_sz)) {</span>
<span class="lineNum">    8619 </span>                :<span class="lineNoCov">          0 :                 dev-&gt;l2ad_hand = dev-&gt;l2ad_start;</span>
<span class="lineNum">    8620 </span>                :<span class="lineNoCov">          0 :                 dev-&gt;l2ad_first = B_FALSE;</span>
<span class="lineNum">    8621 </span>                :            :         }
<span class="lineNum">    8622 </span>                :            : 
<span class="lineNum">    8623 </span>                :<span class="lineCov">        294 :         dev-&gt;l2ad_writing = B_TRUE;</span>
<span class="lineNum">    8624 </span>                :<span class="lineCov">        294 :         (void) zio_wait(pio);</span>
<span class="lineNum">    8625 </span>                :<span class="lineCov">        294 :         dev-&gt;l2ad_writing = B_FALSE;</span>
<span class="lineNum">    8626 </span>                :            : 
<span class="lineNum">    8627 </span>                :<span class="lineCov">        294 :         return (write_asize);</span>
<span class="lineNum">    8628 </span>                :            : }
<span class="lineNum">    8629 </span>                :            : 
<span class="lineNum">    8630 </span>                :            : /*
<span class="lineNum">    8631 </span>                :            :  * This thread feeds the L2ARC at regular intervals.  This is the beating
<span class="lineNum">    8632 </span>                :            :  * heart of the L2ARC.
<a name="8633"><span class="lineNum">    8633 </span>                :            :  */</a>
<span class="lineNum">    8634 </span>                :            : static void
<span class="lineNum">    8635 </span>                :<span class="lineCov">        207 : l2arc_feed_thread(void *unused)</span>
<span class="lineNum">    8636 </span>                :            : {
<span class="lineNum">    8637 </span>                :            :         callb_cpr_t cpr;
<span class="lineNum">    8638 </span>                :            :         l2arc_dev_t *dev;
<span class="lineNum">    8639 </span>                :            :         spa_t *spa;
<span class="lineNum">    8640 </span>                :            :         uint64_t size, wrote;
<span class="lineNum">    8641 </span>                :<span class="lineCov">        207 :         clock_t begin, next = ddi_get_lbolt();</span>
<span class="lineNum">    8642 </span>                :            :         fstrans_cookie_t cookie;
<span class="lineNum">    8643 </span>                :            : 
<span class="lineNum">    8644 </span>                :<span class="lineCov">        207 :         CALLB_CPR_INIT(&amp;cpr, &amp;l2arc_feed_thr_lock, callb_generic_cpr, FTAG);</span>
<span class="lineNum">    8645 </span>                :            : 
<span class="lineNum">    8646 </span>                :<span class="lineCov">        207 :         mutex_enter(&amp;l2arc_feed_thr_lock);</span>
<span class="lineNum">    8647 </span>                :            : 
<span class="lineNum">    8648 </span>                :<span class="lineCov">        207 :         cookie = spl_fstrans_mark();</span>
<span class="lineNum">    8649 </span>        [<span class="branchCov" title="Branch 0 was taken 2200 times"> + </span><span class="branchCov" title="Branch 1 was taken 206 times"> + </span>]:<span class="lineCov">       2406 :         while (l2arc_thread_exit == 0) {</span>
<span class="lineNum">    8650 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 2200 times"> + </span>]:<span class="lineCov">       2200 :                 CALLB_CPR_SAFE_BEGIN(&amp;cpr);</span>
<span class="lineNum">    8651 </span>                :<span class="lineCov">       2200 :                 (void) cv_timedwait_sig(&amp;l2arc_feed_thr_cv,</span>
<span class="lineNum">    8652 </span>                :            :                     &amp;l2arc_feed_thr_lock, next);
<span class="lineNum">    8653 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 2199 times"> + </span>]:<span class="lineCov">       2199 :                 CALLB_CPR_SAFE_END(&amp;cpr, &amp;l2arc_feed_thr_lock);</span>
<span class="lineNum">    8654 </span>                :<span class="lineCov">       2199 :                 next = ddi_get_lbolt() + hz;</span>
<span class="lineNum">    8655 </span>                :            : 
<span class="lineNum">    8656 </span>                :            :                 /*
<span class="lineNum">    8657 </span>                :            :                  * Quick check for L2ARC devices.
<span class="lineNum">    8658 </span>                :            :                  */
<span class="lineNum">    8659 </span>                :<span class="lineCov">       2199 :                 mutex_enter(&amp;l2arc_dev_mtx);</span>
<span class="lineNum">    8660 </span>        [<span class="branchCov" title="Branch 0 was taken 1780 times"> + </span><span class="branchCov" title="Branch 1 was taken 419 times"> + </span>]:<span class="lineCov">       2199 :                 if (l2arc_ndev == 0) {</span>
<span class="lineNum">    8661 </span>                :<span class="lineCov">       1780 :                         mutex_exit(&amp;l2arc_dev_mtx);</span>
<span class="lineNum">    8662 </span>                :<span class="lineCov">       1780 :                         continue;</span>
<span class="lineNum">    8663 </span>                :            :                 }
<span class="lineNum">    8664 </span>                :<span class="lineCov">        419 :                 mutex_exit(&amp;l2arc_dev_mtx);</span>
<span class="lineNum">    8665 </span>                :<span class="lineCov">        419 :                 begin = ddi_get_lbolt();</span>
<span class="lineNum">    8666 </span>                :            : 
<span class="lineNum">    8667 </span>                :            :                 /*
<span class="lineNum">    8668 </span>                :            :                  * This selects the next l2arc device to write to, and in
<span class="lineNum">    8669 </span>                :            :                  * doing so the next spa to feed from: dev-&gt;l2ad_spa.   This
<span class="lineNum">    8670 </span>                :            :                  * will return NULL if there are now no l2arc devices or if
<span class="lineNum">    8671 </span>                :            :                  * they are all faulted.
<span class="lineNum">    8672 </span>                :            :                  *
<span class="lineNum">    8673 </span>                :            :                  * If a device is returned, its spa's config lock is also
<span class="lineNum">    8674 </span>                :            :                  * held to prevent device removal.  l2arc_dev_get_next()
<span class="lineNum">    8675 </span>                :            :                  * will grab and release l2arc_dev_mtx.
<span class="lineNum">    8676 </span>                :            :                  */
<span class="lineNum">    8677 </span>        [<span class="branchCov" title="Branch 1 was taken 29 times"> + </span><span class="branchCov" title="Branch 2 was taken 390 times"> + </span>]:<span class="lineCov">        419 :                 if ((dev = l2arc_dev_get_next()) == NULL)</span>
<span class="lineNum">    8678 </span>                :<span class="lineCov">         29 :                         continue;</span>
<span class="lineNum">    8679 </span>                :            : 
<span class="lineNum">    8680 </span>                :<span class="lineCov">        390 :                 spa = dev-&gt;l2ad_spa;</span>
<span class="lineNum">    8681 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 390 times"> + </span>]:<span class="lineCov">        390 :                 ASSERT3P(spa, !=, NULL);</span>
<span class="lineNum">    8682 </span>                :            : 
<span class="lineNum">    8683 </span>                :            :                 /*
<span class="lineNum">    8684 </span>                :            :                  * If the pool is read-only then force the feed thread to
<span class="lineNum">    8685 </span>                :            :                  * sleep a little longer.
<span class="lineNum">    8686 </span>                :            :                  */
<span class="lineNum">    8687 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 390 times"> + </span>]:<span class="lineCov">        390 :                 if (!spa_writeable(spa)) {</span>
<span class="lineNum">    8688 </span>                :<span class="lineNoCov">          0 :                         next = ddi_get_lbolt() + 5 * l2arc_feed_secs * hz;</span>
<span class="lineNum">    8689 </span>                :<span class="lineNoCov">          0 :                         spa_config_exit(spa, SCL_L2ARC, dev);</span>
<span class="lineNum">    8690 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    8691 </span>                :            :                 }
<span class="lineNum">    8692 </span>                :            : 
<span class="lineNum">    8693 </span>                :            :                 /*
<span class="lineNum">    8694 </span>                :            :                  * Avoid contributing to memory pressure.
<span class="lineNum">    8695 </span>                :            :                  */
<span class="lineNum">    8696 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 390 times"> + </span>]:<span class="lineCov">        390 :                 if (arc_reclaim_needed()) {</span>
<span class="lineNum">    8697 </span>                :<span class="lineNoCov">          0 :                         ARCSTAT_BUMP(arcstat_l2_abort_lowmem);</span>
<span class="lineNum">    8698 </span>                :<span class="lineNoCov">          0 :                         spa_config_exit(spa, SCL_L2ARC, dev);</span>
<span class="lineNum">    8699 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">    8700 </span>                :            :                 }
<span class="lineNum">    8701 </span>                :            : 
<span class="lineNum">    8702 </span>                :<span class="lineCov">        390 :                 ARCSTAT_BUMP(arcstat_l2_feeds);</span>
<span class="lineNum">    8703 </span>                :            : 
<span class="lineNum">    8704 </span>                :<span class="lineCov">        390 :                 size = l2arc_write_size();</span>
<span class="lineNum">    8705 </span>                :            : 
<span class="lineNum">    8706 </span>                :            :                 /*
<span class="lineNum">    8707 </span>                :            :                  * Evict L2ARC buffers that will be overwritten.
<span class="lineNum">    8708 </span>                :            :                  */
<span class="lineNum">    8709 </span>                :<span class="lineCov">        390 :                 l2arc_evict(dev, size, B_FALSE);</span>
<span class="lineNum">    8710 </span>                :            : 
<span class="lineNum">    8711 </span>                :            :                 /*
<span class="lineNum">    8712 </span>                :            :                  * Write ARC buffers.
<span class="lineNum">    8713 </span>                :            :                  */
<span class="lineNum">    8714 </span>                :<span class="lineCov">        390 :                 wrote = l2arc_write_buffers(spa, dev, size);</span>
<span class="lineNum">    8715 </span>                :            : 
<span class="lineNum">    8716 </span>                :            :                 /*
<span class="lineNum">    8717 </span>                :            :                  * Calculate interval between writes.
<span class="lineNum">    8718 </span>                :            :                  */
<span class="lineNum">    8719 </span>                :<span class="lineCov">        390 :                 next = l2arc_write_interval(begin, size, wrote);</span>
<span class="lineNum">    8720 </span>                :<span class="lineCov">       2199 :                 spa_config_exit(spa, SCL_L2ARC, dev);</span>
<span class="lineNum">    8721 </span>                :            :         }
<span class="lineNum">    8722 </span>                :<span class="lineCov">        206 :         spl_fstrans_unmark(cookie);</span>
<span class="lineNum">    8723 </span>                :            : 
<span class="lineNum">    8724 </span>                :<span class="lineCov">        206 :         l2arc_thread_exit = 0;</span>
<span class="lineNum">    8725 </span>                :<span class="lineCov">        206 :         cv_broadcast(&amp;l2arc_feed_thr_cv);</span>
<span class="lineNum">    8726 </span>        [<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 206 times"> + </span>]:<span class="lineCov">        206 :         CALLB_CPR_EXIT(&amp;cpr);               /* drops l2arc_feed_thr_lock */</span>
<span class="lineNum">    8727 </span>                :<span class="lineCov">        206 :         thread_exit();</span>
<span class="lineNum">    8728 </span>                :            : }
<a name="8729"><span class="lineNum">    8729 </span>                :            : </a>
<span class="lineNum">    8730 </span>                :            : boolean_t
<span class="lineNum">    8731 </span>                :<span class="lineCov">        302 : l2arc_vdev_present(vdev_t *vd)</span>
<span class="lineNum">    8732 </span>                :            : {
<span class="lineNum">    8733 </span>                :            :         l2arc_dev_t *dev;
<span class="lineNum">    8734 </span>                :            : 
<span class="lineNum">    8735 </span>                :<span class="lineCov">        302 :         mutex_enter(&amp;l2arc_dev_mtx);</span>
<span class="lineNum">    8736 </span>        [<span class="branchCov" title="Branch 1 was taken 216 times"> + </span><span class="branchCov" title="Branch 2 was taken 152 times"> + </span>]:<span class="lineCov">        368 :         for (dev = list_head(l2arc_dev_list); dev != NULL;</span>
<span class="lineNum">    8737 </span>                :<span class="lineCov">         66 :             dev = list_next(l2arc_dev_list, dev)) {</span>
<span class="lineNum">    8738 </span>        [<span class="branchCov" title="Branch 0 was taken 66 times"> + </span><span class="branchCov" title="Branch 1 was taken 150 times"> + </span>]:<span class="lineCov">        216 :                 if (dev-&gt;l2ad_vdev == vd)</span>
<span class="lineNum">    8739 </span>                :            :                         break;
<span class="lineNum">    8740 </span>                :            :         }
<span class="lineNum">    8741 </span>                :<span class="lineCov">        302 :         mutex_exit(&amp;l2arc_dev_mtx);</span>
<span class="lineNum">    8742 </span>                :            : 
<span class="lineNum">    8743 </span>                :<span class="lineCov">        302 :         return (dev != NULL);</span>
<span class="lineNum">    8744 </span>                :            : }
<span class="lineNum">    8745 </span>                :            : 
<span class="lineNum">    8746 </span>                :            : /*
<span class="lineNum">    8747 </span>                :            :  * Add a vdev for use by the L2ARC.  By this point the spa has already
<span class="lineNum">    8748 </span>                :            :  * validated the vdev and opened it.
<a name="8749"><span class="lineNum">    8749 </span>                :            :  */</a>
<span class="lineNum">    8750 </span>                :            : void
<span class="lineNum">    8751 </span>                :<span class="lineCov">        146 : l2arc_add_vdev(spa_t *spa, vdev_t *vd)</span>
<span class="lineNum">    8752 </span>                :            : {
<span class="lineNum">    8753 </span>                :            :         l2arc_dev_t *adddev;
<span class="lineNum">    8754 </span>                :            : 
<span class="lineNum">    8755 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 146 times"> + </span>]:<span class="lineCov">        146 :         ASSERT(!l2arc_vdev_present(vd));</span>
<span class="lineNum">    8756 </span>                :            : 
<span class="lineNum">    8757 </span>                :            :         /*
<span class="lineNum">    8758 </span>                :            :          * Create a new l2arc device entry.
<span class="lineNum">    8759 </span>                :            :          */
<span class="lineNum">    8760 </span>                :<span class="lineCov">        146 :         adddev = kmem_zalloc(sizeof (l2arc_dev_t), KM_SLEEP);</span>
<span class="lineNum">    8761 </span>                :<span class="lineCov">        146 :         adddev-&gt;l2ad_spa = spa;</span>
<span class="lineNum">    8762 </span>                :<span class="lineCov">        146 :         adddev-&gt;l2ad_vdev = vd;</span>
<span class="lineNum">    8763 </span>                :<span class="lineCov">        146 :         adddev-&gt;l2ad_start = VDEV_LABEL_START_SIZE;</span>
<span class="lineNum">    8764 </span>                :<span class="lineCov">        146 :         adddev-&gt;l2ad_end = VDEV_LABEL_START_SIZE + vdev_get_min_asize(vd);</span>
<span class="lineNum">    8765 </span>                :<span class="lineCov">        146 :         adddev-&gt;l2ad_hand = adddev-&gt;l2ad_start;</span>
<span class="lineNum">    8766 </span>                :<span class="lineCov">        146 :         adddev-&gt;l2ad_first = B_TRUE;</span>
<span class="lineNum">    8767 </span>                :<span class="lineCov">        146 :         adddev-&gt;l2ad_writing = B_FALSE;</span>
<span class="lineNum">    8768 </span>                :<span class="lineCov">        146 :         list_link_init(&amp;adddev-&gt;l2ad_node);</span>
<span class="lineNum">    8769 </span>                :            : 
<span class="lineNum">    8770 </span>                :<span class="lineCov">        146 :         mutex_init(&amp;adddev-&gt;l2ad_mtx, NULL, MUTEX_DEFAULT, NULL);</span>
<span class="lineNum">    8771 </span>                :            :         /*
<span class="lineNum">    8772 </span>                :            :          * This is a list of all ARC buffers that are still valid on the
<span class="lineNum">    8773 </span>                :            :          * device.
<span class="lineNum">    8774 </span>                :            :          */
<span class="lineNum">    8775 </span>                :<span class="lineCov">        146 :         list_create(&amp;adddev-&gt;l2ad_buflist, sizeof (arc_buf_hdr_t),</span>
<span class="lineNum">    8776 </span>                :            :             offsetof(arc_buf_hdr_t, b_l2hdr.b_l2node));
<span class="lineNum">    8777 </span>                :            : 
<span class="lineNum">    8778 </span>                :<span class="lineCov">        146 :         vdev_space_update(vd, 0, 0, adddev-&gt;l2ad_end - adddev-&gt;l2ad_hand);</span>
<span class="lineNum">    8779 </span>                :<span class="lineCov">        146 :         refcount_create(&amp;adddev-&gt;l2ad_alloc);</span>
<span class="lineNum">    8780 </span>                :            : 
<span class="lineNum">    8781 </span>                :            :         /*
<span class="lineNum">    8782 </span>                :            :          * Add device to global list
<span class="lineNum">    8783 </span>                :            :          */
<span class="lineNum">    8784 </span>                :<span class="lineCov">        146 :         mutex_enter(&amp;l2arc_dev_mtx);</span>
<span class="lineNum">    8785 </span>                :<span class="lineCov">        146 :         list_insert_head(l2arc_dev_list, adddev);</span>
<span class="lineNum">    8786 </span>                :<span class="lineCov">        146 :         atomic_inc_64(&amp;l2arc_ndev);</span>
<span class="lineNum">    8787 </span>                :<span class="lineCov">        146 :         mutex_exit(&amp;l2arc_dev_mtx);</span>
<span class="lineNum">    8788 </span>                :<span class="lineCov">        146 : }</span>
<span class="lineNum">    8789 </span>                :            : 
<span class="lineNum">    8790 </span>                :            : /*
<span class="lineNum">    8791 </span>                :            :  * Remove a vdev from the L2ARC.
<a name="8792"><span class="lineNum">    8792 </span>                :            :  */</a>
<span class="lineNum">    8793 </span>                :            : void
<span class="lineNum">    8794 </span>                :<span class="lineCov">        145 : l2arc_remove_vdev(vdev_t *vd)</span>
<span class="lineNum">    8795 </span>                :            : {
<span class="lineNum">    8796 </span>                :<span class="lineCov">        145 :         l2arc_dev_t *dev, *nextdev, *remdev = NULL;</span>
<span class="lineNum">    8797 </span>                :            : 
<span class="lineNum">    8798 </span>                :            :         /*
<span class="lineNum">    8799 </span>                :            :          * Find the device by vdev
<span class="lineNum">    8800 </span>                :            :          */
<span class="lineNum">    8801 </span>                :<span class="lineCov">        145 :         mutex_enter(&amp;l2arc_dev_mtx);</span>
<span class="lineNum">    8802 </span>        [<span class="branchCov" title="Branch 1 was taken 178 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        178 :         for (dev = list_head(l2arc_dev_list); dev; dev = nextdev) {</span>
<span class="lineNum">    8803 </span>                :<span class="lineCov">        178 :                 nextdev = list_next(l2arc_dev_list, dev);</span>
<span class="lineNum">    8804 </span>        [<span class="branchCov" title="Branch 0 was taken 33 times"> + </span><span class="branchCov" title="Branch 1 was taken 145 times"> + </span>]:<span class="lineCov">        178 :                 if (vd == dev-&gt;l2ad_vdev) {</span>
<span class="lineNum">    8805 </span>                :            :                         remdev = dev;
<span class="lineNum">    8806 </span>                :            :                         break;
<span class="lineNum">    8807 </span>                :            :                 }
<span class="lineNum">    8808 </span>                :            :         }
<span class="lineNum">    8809 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 145 times"> + </span>]:<span class="lineCov">        145 :         ASSERT3P(remdev, !=, NULL);</span>
<span class="lineNum">    8810 </span>                :            : 
<span class="lineNum">    8811 </span>                :            :         /*
<span class="lineNum">    8812 </span>                :            :          * Remove device from global list
<span class="lineNum">    8813 </span>                :            :          */
<span class="lineNum">    8814 </span>                :<span class="lineCov">        145 :         list_remove(l2arc_dev_list, remdev);</span>
<span class="lineNum">    8815 </span>                :<span class="lineCov">        145 :         l2arc_dev_last = NULL;          /* may have been invalidated */</span>
<span class="lineNum">    8816 </span>                :<span class="lineCov">        145 :         atomic_dec_64(&amp;l2arc_ndev);</span>
<span class="lineNum">    8817 </span>                :<span class="lineCov">        145 :         mutex_exit(&amp;l2arc_dev_mtx);</span>
<span class="lineNum">    8818 </span>                :            : 
<span class="lineNum">    8819 </span>                :            :         /*
<span class="lineNum">    8820 </span>                :            :          * Clear all buflists and ARC references.  L2ARC device flush.
<span class="lineNum">    8821 </span>                :            :          */
<span class="lineNum">    8822 </span>                :<span class="lineCov">        145 :         l2arc_evict(remdev, 0, B_TRUE);</span>
<span class="lineNum">    8823 </span>                :<span class="lineCov">        145 :         list_destroy(&amp;remdev-&gt;l2ad_buflist);</span>
<span class="lineNum">    8824 </span>                :<span class="lineCov">        145 :         mutex_destroy(&amp;remdev-&gt;l2ad_mtx);</span>
<span class="lineNum">    8825 </span>                :<span class="lineCov">        145 :         refcount_destroy(&amp;remdev-&gt;l2ad_alloc);</span>
<span class="lineNum">    8826 </span>                :<span class="lineCov">        145 :         kmem_free(remdev, sizeof (l2arc_dev_t));</span>
<span class="lineNum">    8827 </span>                :<span class="lineCov">        145 : }</span>
<a name="8828"><span class="lineNum">    8828 </span>                :            : </a>
<span class="lineNum">    8829 </span>                :            : void
<span class="lineNum">    8830 </span>                :<span class="lineCov">       1234 : l2arc_init(void)</span>
<span class="lineNum">    8831 </span>                :            : {
<span class="lineNum">    8832 </span>                :<span class="lineCov">       1234 :         l2arc_thread_exit = 0;</span>
<span class="lineNum">    8833 </span>                :<span class="lineCov">       1234 :         l2arc_ndev = 0;</span>
<span class="lineNum">    8834 </span>                :<span class="lineCov">       1234 :         l2arc_writes_sent = 0;</span>
<span class="lineNum">    8835 </span>                :<span class="lineCov">       1234 :         l2arc_writes_done = 0;</span>
<span class="lineNum">    8836 </span>                :            : 
<span class="lineNum">    8837 </span>                :<span class="lineCov">       1234 :         mutex_init(&amp;l2arc_feed_thr_lock, NULL, MUTEX_DEFAULT, NULL);</span>
<span class="lineNum">    8838 </span>                :<span class="lineCov">       1234 :         cv_init(&amp;l2arc_feed_thr_cv, NULL, CV_DEFAULT, NULL);</span>
<span class="lineNum">    8839 </span>                :<span class="lineCov">       1234 :         mutex_init(&amp;l2arc_dev_mtx, NULL, MUTEX_DEFAULT, NULL);</span>
<span class="lineNum">    8840 </span>                :<span class="lineCov">       1234 :         mutex_init(&amp;l2arc_free_on_write_mtx, NULL, MUTEX_DEFAULT, NULL);</span>
<span class="lineNum">    8841 </span>                :            : 
<span class="lineNum">    8842 </span>                :<span class="lineCov">       1234 :         l2arc_dev_list = &amp;L2ARC_dev_list;</span>
<span class="lineNum">    8843 </span>                :<span class="lineCov">       1234 :         l2arc_free_on_write = &amp;L2ARC_free_on_write;</span>
<span class="lineNum">    8844 </span>                :<span class="lineCov">       1234 :         list_create(l2arc_dev_list, sizeof (l2arc_dev_t),</span>
<span class="lineNum">    8845 </span>                :            :             offsetof(l2arc_dev_t, l2ad_node));
<span class="lineNum">    8846 </span>                :<span class="lineCov">       1234 :         list_create(l2arc_free_on_write, sizeof (l2arc_data_free_t),</span>
<span class="lineNum">    8847 </span>                :            :             offsetof(l2arc_data_free_t, l2df_list_node));
<span class="lineNum">    8848 </span>                :<span class="lineCov">       1234 : }</span>
<a name="8849"><span class="lineNum">    8849 </span>                :            : </a>
<span class="lineNum">    8850 </span>                :            : void
<span class="lineNum">    8851 </span>                :<span class="lineCov">        785 : l2arc_fini(void)</span>
<span class="lineNum">    8852 </span>                :            : {
<span class="lineNum">    8853 </span>                :            :         /*
<span class="lineNum">    8854 </span>                :            :          * This is called from dmu_fini(), which is called from spa_fini();
<span class="lineNum">    8855 </span>                :            :          * Because of this, we can assume that all l2arc devices have
<span class="lineNum">    8856 </span>                :            :          * already been removed when the pools themselves were removed.
<span class="lineNum">    8857 </span>                :            :          */
<span class="lineNum">    8858 </span>                :            : 
<span class="lineNum">    8859 </span>                :<span class="lineCov">        785 :         l2arc_do_free_on_write();</span>
<span class="lineNum">    8860 </span>                :            : 
<span class="lineNum">    8861 </span>                :<span class="lineCov">        785 :         mutex_destroy(&amp;l2arc_feed_thr_lock);</span>
<span class="lineNum">    8862 </span>                :<span class="lineCov">        785 :         cv_destroy(&amp;l2arc_feed_thr_cv);</span>
<span class="lineNum">    8863 </span>                :<span class="lineCov">        785 :         mutex_destroy(&amp;l2arc_dev_mtx);</span>
<span class="lineNum">    8864 </span>                :<span class="lineCov">        785 :         mutex_destroy(&amp;l2arc_free_on_write_mtx);</span>
<span class="lineNum">    8865 </span>                :            : 
<span class="lineNum">    8866 </span>                :<span class="lineCov">        785 :         list_destroy(l2arc_dev_list);</span>
<span class="lineNum">    8867 </span>                :<span class="lineCov">        785 :         list_destroy(l2arc_free_on_write);</span>
<span class="lineNum">    8868 </span>                :<span class="lineCov">        785 : }</span>
<a name="8869"><span class="lineNum">    8869 </span>                :            : </a>
<span class="lineNum">    8870 </span>                :            : void
<span class="lineNum">    8871 </span>                :<span class="lineCov">       1234 : l2arc_start(void)</span>
<span class="lineNum">    8872 </span>                :            : {
<span class="lineNum">    8873 </span>        [<span class="branchCov" title="Branch 0 was taken 207 times"> + </span><span class="branchCov" title="Branch 1 was taken 1027 times"> + </span>]:<span class="lineCov">       1234 :         if (!(spa_mode_global &amp; FWRITE))</span>
<span class="lineNum">    8874 </span>                :            :                 return;
<span class="lineNum">    8875 </span>                :            : 
<span class="lineNum">    8876 </span>                :<span class="lineCov">        207 :         (void) thread_create(NULL, 0, l2arc_feed_thread, NULL, 0, &amp;p0,</span>
<span class="lineNum">    8877 </span>                :            :             TS_RUN, defclsyspri);
<span class="lineNum">    8878 </span>                :            : }
<a name="8879"><span class="lineNum">    8879 </span>                :            : </a>
<span class="lineNum">    8880 </span>                :            : void
<span class="lineNum">    8881 </span>                :<span class="lineCov">        785 : l2arc_stop(void)</span>
<span class="lineNum">    8882 </span>                :            : {
<span class="lineNum">    8883 </span>        [<span class="branchCov" title="Branch 0 was taken 206 times"> + </span><span class="branchCov" title="Branch 1 was taken 579 times"> + </span>]:<span class="lineCov">        785 :         if (!(spa_mode_global &amp; FWRITE))</span>
<span class="lineNum">    8884 </span>                :            :                 return;
<span class="lineNum">    8885 </span>                :            : 
<span class="lineNum">    8886 </span>                :<span class="lineCov">        206 :         mutex_enter(&amp;l2arc_feed_thr_lock);</span>
<span class="lineNum">    8887 </span>                :<span class="lineCov">        206 :         cv_signal(&amp;l2arc_feed_thr_cv);      /* kick thread out of startup */</span>
<span class="lineNum">    8888 </span>                :<span class="lineCov">        206 :         l2arc_thread_exit = 1;</span>
<span class="lineNum">    8889 </span>        [<span class="branchCov" title="Branch 0 was taken 206 times"> + </span><span class="branchCov" title="Branch 1 was taken 206 times"> + </span>]:<span class="lineCov">        412 :         while (l2arc_thread_exit != 0)</span>
<span class="lineNum">    8890 </span>                :<span class="lineCov">        206 :                 cv_wait(&amp;l2arc_feed_thr_cv, &amp;l2arc_feed_thr_lock);</span>
<span class="lineNum">    8891 </span>                :<span class="lineCov">        206 :         mutex_exit(&amp;l2arc_feed_thr_lock);</span>
<span class="lineNum">    8892 </span>                :            : }
<span class="lineNum">    8893 </span>                :            : 
<span class="lineNum">    8894 </span>                :            : #if defined(_KERNEL) &amp;&amp; defined(HAVE_SPL)
<span class="lineNum">    8895 </span>                :            : EXPORT_SYMBOL(arc_buf_size);
<span class="lineNum">    8896 </span>                :            : EXPORT_SYMBOL(arc_write);
<span class="lineNum">    8897 </span>                :            : EXPORT_SYMBOL(arc_read);
<span class="lineNum">    8898 </span>                :            : EXPORT_SYMBOL(arc_buf_info);
<span class="lineNum">    8899 </span>                :            : EXPORT_SYMBOL(arc_getbuf_func);
<span class="lineNum">    8900 </span>                :            : EXPORT_SYMBOL(arc_add_prune_callback);
<span class="lineNum">    8901 </span>                :            : EXPORT_SYMBOL(arc_remove_prune_callback);
<span class="lineNum">    8902 </span>                :            : 
<span class="lineNum">    8903 </span>                :            : /* BEGIN CSTYLED */
<span class="lineNum">    8904 </span>                :            : module_param(zfs_arc_min, ulong, 0644);
<span class="lineNum">    8905 </span>                :            : MODULE_PARM_DESC(zfs_arc_min, &quot;Min arc size&quot;);
<span class="lineNum">    8906 </span>                :            : 
<span class="lineNum">    8907 </span>                :            : module_param(zfs_arc_max, ulong, 0644);
<span class="lineNum">    8908 </span>                :            : MODULE_PARM_DESC(zfs_arc_max, &quot;Max arc size&quot;);
<span class="lineNum">    8909 </span>                :            : 
<span class="lineNum">    8910 </span>                :            : module_param(zfs_arc_meta_limit, ulong, 0644);
<span class="lineNum">    8911 </span>                :            : MODULE_PARM_DESC(zfs_arc_meta_limit, &quot;Meta limit for arc size&quot;);
<span class="lineNum">    8912 </span>                :            : 
<span class="lineNum">    8913 </span>                :            : module_param(zfs_arc_meta_limit_percent, ulong, 0644);
<span class="lineNum">    8914 </span>                :            : MODULE_PARM_DESC(zfs_arc_meta_limit_percent,
<span class="lineNum">    8915 </span>                :            :         &quot;Percent of arc size for arc meta limit&quot;);
<span class="lineNum">    8916 </span>                :            : 
<span class="lineNum">    8917 </span>                :            : module_param(zfs_arc_meta_min, ulong, 0644);
<span class="lineNum">    8918 </span>                :            : MODULE_PARM_DESC(zfs_arc_meta_min, &quot;Min arc metadata&quot;);
<span class="lineNum">    8919 </span>                :            : 
<span class="lineNum">    8920 </span>                :            : module_param(zfs_arc_meta_prune, int, 0644);
<span class="lineNum">    8921 </span>                :            : MODULE_PARM_DESC(zfs_arc_meta_prune, &quot;Meta objects to scan for prune&quot;);
<span class="lineNum">    8922 </span>                :            : 
<span class="lineNum">    8923 </span>                :            : module_param(zfs_arc_meta_adjust_restarts, int, 0644);
<span class="lineNum">    8924 </span>                :            : MODULE_PARM_DESC(zfs_arc_meta_adjust_restarts,
<span class="lineNum">    8925 </span>                :            :         &quot;Limit number of restarts in arc_adjust_meta&quot;);
<span class="lineNum">    8926 </span>                :            : 
<span class="lineNum">    8927 </span>                :            : module_param(zfs_arc_meta_strategy, int, 0644);
<span class="lineNum">    8928 </span>                :            : MODULE_PARM_DESC(zfs_arc_meta_strategy, &quot;Meta reclaim strategy&quot;);
<span class="lineNum">    8929 </span>                :            : 
<span class="lineNum">    8930 </span>                :            : module_param(zfs_arc_grow_retry, int, 0644);
<span class="lineNum">    8931 </span>                :            : MODULE_PARM_DESC(zfs_arc_grow_retry, &quot;Seconds before growing arc size&quot;);
<span class="lineNum">    8932 </span>                :            : 
<span class="lineNum">    8933 </span>                :            : module_param(zfs_arc_p_aggressive_disable, int, 0644);
<span class="lineNum">    8934 </span>                :            : MODULE_PARM_DESC(zfs_arc_p_aggressive_disable, &quot;disable aggressive arc_p grow&quot;);
<span class="lineNum">    8935 </span>                :            : 
<span class="lineNum">    8936 </span>                :            : module_param(zfs_arc_p_dampener_disable, int, 0644);
<span class="lineNum">    8937 </span>                :            : MODULE_PARM_DESC(zfs_arc_p_dampener_disable, &quot;disable arc_p adapt dampener&quot;);
<span class="lineNum">    8938 </span>                :            : 
<span class="lineNum">    8939 </span>                :            : module_param(zfs_arc_shrink_shift, int, 0644);
<span class="lineNum">    8940 </span>                :            : MODULE_PARM_DESC(zfs_arc_shrink_shift, &quot;log2(fraction of arc to reclaim)&quot;);
<span class="lineNum">    8941 </span>                :            : 
<span class="lineNum">    8942 </span>                :            : module_param(zfs_arc_pc_percent, uint, 0644);
<span class="lineNum">    8943 </span>                :            : MODULE_PARM_DESC(zfs_arc_pc_percent,
<span class="lineNum">    8944 </span>                :            :         &quot;Percent of pagecache to reclaim arc to&quot;);
<span class="lineNum">    8945 </span>                :            : 
<span class="lineNum">    8946 </span>                :            : module_param(zfs_arc_p_min_shift, int, 0644);
<span class="lineNum">    8947 </span>                :            : MODULE_PARM_DESC(zfs_arc_p_min_shift, &quot;arc_c shift to calc min/max arc_p&quot;);
<span class="lineNum">    8948 </span>                :            : 
<span class="lineNum">    8949 </span>                :            : module_param(zfs_arc_average_blocksize, int, 0444);
<span class="lineNum">    8950 </span>                :            : MODULE_PARM_DESC(zfs_arc_average_blocksize, &quot;Target average block size&quot;);
<span class="lineNum">    8951 </span>                :            : 
<span class="lineNum">    8952 </span>                :            : module_param(zfs_compressed_arc_enabled, int, 0644);
<span class="lineNum">    8953 </span>                :            : MODULE_PARM_DESC(zfs_compressed_arc_enabled, &quot;Disable compressed arc buffers&quot;);
<span class="lineNum">    8954 </span>                :            : 
<span class="lineNum">    8955 </span>                :            : module_param(zfs_arc_min_prefetch_lifespan, int, 0644);
<span class="lineNum">    8956 </span>                :            : MODULE_PARM_DESC(zfs_arc_min_prefetch_lifespan, &quot;Min life of prefetch block&quot;);
<span class="lineNum">    8957 </span>                :            : 
<span class="lineNum">    8958 </span>                :            : module_param(l2arc_write_max, ulong, 0644);
<span class="lineNum">    8959 </span>                :            : MODULE_PARM_DESC(l2arc_write_max, &quot;Max write bytes per interval&quot;);
<span class="lineNum">    8960 </span>                :            : 
<span class="lineNum">    8961 </span>                :            : module_param(l2arc_write_boost, ulong, 0644);
<span class="lineNum">    8962 </span>                :            : MODULE_PARM_DESC(l2arc_write_boost, &quot;Extra write bytes during device warmup&quot;);
<span class="lineNum">    8963 </span>                :            : 
<span class="lineNum">    8964 </span>                :            : module_param(l2arc_headroom, ulong, 0644);
<span class="lineNum">    8965 </span>                :            : MODULE_PARM_DESC(l2arc_headroom, &quot;Number of max device writes to precache&quot;);
<span class="lineNum">    8966 </span>                :            : 
<span class="lineNum">    8967 </span>                :            : module_param(l2arc_headroom_boost, ulong, 0644);
<span class="lineNum">    8968 </span>                :            : MODULE_PARM_DESC(l2arc_headroom_boost, &quot;Compressed l2arc_headroom multiplier&quot;);
<span class="lineNum">    8969 </span>                :            : 
<span class="lineNum">    8970 </span>                :            : module_param(l2arc_feed_secs, ulong, 0644);
<span class="lineNum">    8971 </span>                :            : MODULE_PARM_DESC(l2arc_feed_secs, &quot;Seconds between L2ARC writing&quot;);
<span class="lineNum">    8972 </span>                :            : 
<span class="lineNum">    8973 </span>                :            : module_param(l2arc_feed_min_ms, ulong, 0644);
<span class="lineNum">    8974 </span>                :            : MODULE_PARM_DESC(l2arc_feed_min_ms, &quot;Min feed interval in milliseconds&quot;);
<span class="lineNum">    8975 </span>                :            : 
<span class="lineNum">    8976 </span>                :            : module_param(l2arc_noprefetch, int, 0644);
<span class="lineNum">    8977 </span>                :            : MODULE_PARM_DESC(l2arc_noprefetch, &quot;Skip caching prefetched buffers&quot;);
<span class="lineNum">    8978 </span>                :            : 
<span class="lineNum">    8979 </span>                :            : module_param(l2arc_feed_again, int, 0644);
<span class="lineNum">    8980 </span>                :            : MODULE_PARM_DESC(l2arc_feed_again, &quot;Turbo L2ARC warmup&quot;);
<span class="lineNum">    8981 </span>                :            : 
<span class="lineNum">    8982 </span>                :            : module_param(l2arc_norw, int, 0644);
<span class="lineNum">    8983 </span>                :            : MODULE_PARM_DESC(l2arc_norw, &quot;No reads during writes&quot;);
<span class="lineNum">    8984 </span>                :            : 
<span class="lineNum">    8985 </span>                :            : module_param(zfs_arc_lotsfree_percent, int, 0644);
<span class="lineNum">    8986 </span>                :            : MODULE_PARM_DESC(zfs_arc_lotsfree_percent,
<span class="lineNum">    8987 </span>                :            :         &quot;System free memory I/O throttle in bytes&quot;);
<span class="lineNum">    8988 </span>                :            : 
<span class="lineNum">    8989 </span>                :            : module_param(zfs_arc_sys_free, ulong, 0644);
<span class="lineNum">    8990 </span>                :            : MODULE_PARM_DESC(zfs_arc_sys_free, &quot;System free memory target size in bytes&quot;);
<span class="lineNum">    8991 </span>                :            : 
<span class="lineNum">    8992 </span>                :            : module_param(zfs_arc_dnode_limit, ulong, 0644);
<span class="lineNum">    8993 </span>                :            : MODULE_PARM_DESC(zfs_arc_dnode_limit, &quot;Minimum bytes of dnodes in arc&quot;);
<span class="lineNum">    8994 </span>                :            : 
<span class="lineNum">    8995 </span>                :            : module_param(zfs_arc_dnode_limit_percent, ulong, 0644);
<span class="lineNum">    8996 </span>                :            : MODULE_PARM_DESC(zfs_arc_dnode_limit_percent,
<span class="lineNum">    8997 </span>                :            :         &quot;Percent of ARC meta buffers for dnodes&quot;);
<span class="lineNum">    8998 </span>                :            : 
<span class="lineNum">    8999 </span>                :            : module_param(zfs_arc_dnode_reduce_percent, ulong, 0644);
<span class="lineNum">    9000 </span>                :            : MODULE_PARM_DESC(zfs_arc_dnode_reduce_percent,
<span class="lineNum">    9001 </span>                :            :         &quot;Percentage of excess dnodes to try to unpin&quot;);
<span class="lineNum">    9002 </span>                :            : /* END CSTYLED */
<span class="lineNum">    9003 </span>                :            : #endif
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
