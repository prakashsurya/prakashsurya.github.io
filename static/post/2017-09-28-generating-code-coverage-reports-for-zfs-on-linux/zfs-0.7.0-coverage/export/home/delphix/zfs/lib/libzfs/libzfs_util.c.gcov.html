<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - zfs-0.7.0 Code Coverage - /export/home/delphix/zfs/lib/libzfs/libzfs_util.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../../index.html">top level</a> - <a href="index.html">export/home/delphix/zfs/lib/libzfs</a> - libzfs_util.c<span style="font-size: 80%;"> (source / <a href="libzfs_util.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">zfs-0.7.0 Code Coverage</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">556</td>
            <td class="headerCovTableEntry">822</td>
            <td class="headerCovTableEntryLo">67.6 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-09-28 14:23:58</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">53</td>
            <td class="headerCovTableEntry">63</td>
            <td class="headerCovTableEntryMed">84.1 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
            | Branches:
            <span class="coverLegendCov">+</span> taken
            <span class="coverLegendNoCov">-</span> not taken
            <span class="coverLegendNoCov">#</span> not executed
</td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">330</td>
            <td class="headerCovTableEntry">566</td>
            <td class="headerCovTableEntryLo">58.3 %</td>
          </tr>
          <tr><td><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : /*</a>
<span class="lineNum">       2 </span>                :            :  * CDDL HEADER START
<span class="lineNum">       3 </span>                :            :  *
<span class="lineNum">       4 </span>                :            :  * The contents of this file are subject to the terms of the
<span class="lineNum">       5 </span>                :            :  * Common Development and Distribution License (the &quot;License&quot;).
<span class="lineNum">       6 </span>                :            :  * You may not use this file except in compliance with the License.
<span class="lineNum">       7 </span>                :            :  *
<span class="lineNum">       8 </span>                :            :  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
<span class="lineNum">       9 </span>                :            :  * or http://www.opensolaris.org/os/licensing.
<span class="lineNum">      10 </span>                :            :  * See the License for the specific language governing permissions
<span class="lineNum">      11 </span>                :            :  * and limitations under the License.
<span class="lineNum">      12 </span>                :            :  *
<span class="lineNum">      13 </span>                :            :  * When distributing Covered Code, include this CDDL HEADER in each
<span class="lineNum">      14 </span>                :            :  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.
<span class="lineNum">      15 </span>                :            :  * If applicable, add the following below this CDDL HEADER, with the
<span class="lineNum">      16 </span>                :            :  * fields enclosed by brackets &quot;[]&quot; replaced with your own identifying
<span class="lineNum">      17 </span>                :            :  * information: Portions Copyright [yyyy] [name of copyright owner]
<span class="lineNum">      18 </span>                :            :  *
<span class="lineNum">      19 </span>                :            :  * CDDL HEADER END
<span class="lineNum">      20 </span>                :            :  */
<span class="lineNum">      21 </span>                :            : 
<span class="lineNum">      22 </span>                :            : /*
<span class="lineNum">      23 </span>                :            :  * Copyright (c) 2005, 2010, Oracle and/or its affiliates. All rights reserved.
<span class="lineNum">      24 </span>                :            :  * Copyright (c) 2013, Joyent, Inc. All rights reserved.
<span class="lineNum">      25 </span>                :            :  * Copyright (c) 2011, 2014 by Delphix. All rights reserved.
<span class="lineNum">      26 </span>                :            :  * Copyright 2016 Igor Kozhukhov &lt;ikozhukhov@gmail.com&gt;
<span class="lineNum">      27 </span>                :            :  * Copyright (c) 2017 Datto Inc.
<span class="lineNum">      28 </span>                :            :  */
<span class="lineNum">      29 </span>                :            : 
<span class="lineNum">      30 </span>                :            : /*
<span class="lineNum">      31 </span>                :            :  * Internal utility routines for the ZFS library.
<span class="lineNum">      32 </span>                :            :  */
<span class="lineNum">      33 </span>                :            : 
<span class="lineNum">      34 </span>                :            : #include &lt;errno.h&gt;
<span class="lineNum">      35 </span>                :            : #include &lt;fcntl.h&gt;
<span class="lineNum">      36 </span>                :            : #include &lt;libintl.h&gt;
<span class="lineNum">      37 </span>                :            : #include &lt;stdarg.h&gt;
<span class="lineNum">      38 </span>                :            : #include &lt;stdio.h&gt;
<span class="lineNum">      39 </span>                :            : #include &lt;stdlib.h&gt;
<span class="lineNum">      40 </span>                :            : #include &lt;strings.h&gt;
<span class="lineNum">      41 </span>                :            : #include &lt;unistd.h&gt;
<span class="lineNum">      42 </span>                :            : #include &lt;ctype.h&gt;
<span class="lineNum">      43 </span>                :            : #include &lt;math.h&gt;
<span class="lineNum">      44 </span>                :            : #include &lt;sys/stat.h&gt;
<span class="lineNum">      45 </span>                :            : #include &lt;sys/mnttab.h&gt;
<span class="lineNum">      46 </span>                :            : #include &lt;sys/mntent.h&gt;
<span class="lineNum">      47 </span>                :            : #include &lt;sys/types.h&gt;
<span class="lineNum">      48 </span>                :            : #include &lt;sys/wait.h&gt;
<span class="lineNum">      49 </span>                :            : 
<span class="lineNum">      50 </span>                :            : #include &lt;libzfs.h&gt;
<span class="lineNum">      51 </span>                :            : #include &lt;libzfs_core.h&gt;
<span class="lineNum">      52 </span>                :            : 
<span class="lineNum">      53 </span>                :            : #include &quot;libzfs_impl.h&quot;
<span class="lineNum">      54 </span>                :            : #include &quot;zfs_prop.h&quot;
<span class="lineNum">      55 </span>                :            : #include &quot;zfeature_common.h&quot;
<span class="lineNum">      56 </span>                :            : #include &lt;zfs_fletcher.h&gt;
<a name="57"><span class="lineNum">      57 </span>                :            : </a>
<span class="lineNum">      58 </span>                :            : int
<span class="lineNum">      59 </span>                :<span class="lineCov">       3587 : libzfs_errno(libzfs_handle_t *hdl)</span>
<span class="lineNum">      60 </span>                :            : {
<span class="lineNum">      61 </span>                :<span class="lineCov">       3587 :         return (hdl-&gt;libzfs_error);</span>
<span class="lineNum">      62 </span>                :            : }
<a name="63"><span class="lineNum">      63 </span>                :            : </a>
<span class="lineNum">      64 </span>                :            : const char *
<span class="lineNum">      65 </span>                :<span class="lineCov">        280 : libzfs_error_init(int error)</span>
<span class="lineNum">      66 </span>                :            : {
<span class="lineNum">      67 </span>  [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 277 times"> + </span> :<span class="lineCov">        280 :         switch (error) {</span>
<span class="lineNum">         </span>            <span class="branchNoCov" title="Branch 4 was not taken"> - </span>]
<span class="lineNum">      68 </span>                :            :         case ENXIO:
<span class="lineNum">      69 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;The ZFS modules are not &quot;</span>
<span class="lineNum">      70 </span>                :            :                     &quot;loaded.\nTry running '/sbin/modprobe zfs' as root &quot;
<span class="lineNum">      71 </span>                :            :                     &quot;to load them.\n&quot;));
<span class="lineNum">      72 </span>                :            :         case ENOENT:
<span class="lineNum">      73 </span>                :<span class="lineCov">          3 :                 return (dgettext(TEXT_DOMAIN, &quot;/dev/zfs and /proc/self/mounts &quot;</span>
<span class="lineNum">      74 </span>                :            :                     &quot;are required.\nTry running 'udevadm trigger' and 'mount &quot;
<span class="lineNum">      75 </span>                :            :                     &quot;-t proc proc /proc' as root.\n&quot;));
<span class="lineNum">      76 </span>                :            :         case ENOEXEC:
<span class="lineNum">      77 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;The ZFS modules cannot be &quot;</span>
<span class="lineNum">      78 </span>                :            :                     &quot;auto-loaded.\nTry running '/sbin/modprobe zfs' as &quot;
<span class="lineNum">      79 </span>                :            :                     &quot;root to manually load them.\n&quot;));
<span class="lineNum">      80 </span>                :            :         case EACCES:
<span class="lineNum">      81 </span>                :<span class="lineCov">        277 :                 return (dgettext(TEXT_DOMAIN, &quot;Permission denied the &quot;</span>
<span class="lineNum">      82 </span>                :            :                     &quot;ZFS utilities must be run as root.\n&quot;));
<span class="lineNum">      83 </span>                :            :         default:
<span class="lineNum">      84 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;Failed to initialize the &quot;</span>
<span class="lineNum">      85 </span>                :            :                     &quot;libzfs library.\n&quot;));
<span class="lineNum">      86 </span>                :            :         }
<span class="lineNum">      87 </span>                :            : }
<a name="88"><span class="lineNum">      88 </span>                :            : </a>
<span class="lineNum">      89 </span>                :            : const char *
<span class="lineNum">      90 </span>                :<span class="lineNoCov">          0 : libzfs_error_action(libzfs_handle_t *hdl)</span>
<span class="lineNum">      91 </span>                :            : {
<span class="lineNum">      92 </span>                :<span class="lineNoCov">          0 :         return (hdl-&gt;libzfs_action);</span>
<span class="lineNum">      93 </span>                :            : }
<a name="94"><span class="lineNum">      94 </span>                :            : </a>
<span class="lineNum">      95 </span>                :            : const char *
<span class="lineNum">      96 </span>                :<span class="lineCov">       7798 : libzfs_error_description(libzfs_handle_t *hdl)</span>
<span class="lineNum">      97 </span>                :            : {
<span class="lineNum">      98 </span>        [<span class="branchCov" title="Branch 0 was taken 7662 times"> + </span><span class="branchCov" title="Branch 1 was taken 136 times"> + </span>]:<span class="lineCov">       7798 :         if (hdl-&gt;libzfs_desc[0] != '\0')</span>
<span class="lineNum">      99 </span>                :<span class="lineCov">       7662 :                 return (hdl-&gt;libzfs_desc);</span>
<span class="lineNum">     100 </span>                :            : 
<span class="lineNum">     101 </span>  [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 10 times"> + </span> :<span class="lineCov">        136 :         switch (hdl-&gt;libzfs_error) {</span>
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 28 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 9 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span><span class="branchNoCov" title="Branch 11 was not taken"> - </span><span class="branchNoCov" title="Branch 12 was not taken"> - </span><span class="branchNoCov" title="Branch 13 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 14 was not taken"> - </span><span class="branchNoCov" title="Branch 15 was not taken"> - </span><span class="branchNoCov" title="Branch 16 was not taken"> - </span><span class="branchCov" title="Branch 17 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 18 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 19 was taken 11 times"> + </span><span class="branchCov" title="Branch 20 was taken 1 time"> + </span><span class="branchCov" title="Branch 21 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 22 was not taken"> - </span><span class="branchNoCov" title="Branch 23 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 24 was not taken"> - </span><span class="branchNoCov" title="Branch 25 was not taken"> - </span><span class="branchNoCov" title="Branch 26 was not taken"> - </span><span class="branchNoCov" title="Branch 27 was not taken"> - </span><span class="branchCov" title="Branch 28 was taken 27 times"> + </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 29 was not taken"> - </span><span class="branchNoCov" title="Branch 30 was not taken"> - </span><span class="branchNoCov" title="Branch 31 was not taken"> - </span><span class="branchNoCov" title="Branch 32 was not taken"> - </span><span class="branchNoCov" title="Branch 33 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 34 was taken 10 times"> + </span><span class="branchNoCov" title="Branch 35 was not taken"> - </span><span class="branchCov" title="Branch 36 was taken 2 times"> + </span><span class="branchCov" title="Branch 37 was taken 3 times"> + </span><span class="branchCov" title="Branch 38 was taken 1 time"> + </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 39 was not taken"> - </span><span class="branchNoCov" title="Branch 40 was not taken"> - </span><span class="branchNoCov" title="Branch 41 was not taken"> - </span><span class="branchNoCov" title="Branch 42 was not taken"> - </span><span class="branchCov" title="Branch 43 was taken 1 time"> + </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 44 was not taken"> - </span><span class="branchCov" title="Branch 45 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 46 was not taken"> - </span><span class="branchNoCov" title="Branch 47 was not taken"> - </span><span class="branchNoCov" title="Branch 48 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 49 was not taken"> - </span><span class="branchNoCov" title="Branch 50 was not taken"> - </span><span class="branchNoCov" title="Branch 51 was not taken"> - </span><span class="branchNoCov" title="Branch 52 was not taken"> - </span><span class="branchNoCov" title="Branch 53 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchCov" title="Branch 54 was taken 8 times"> + </span><span class="branchNoCov" title="Branch 55 was not taken"> - </span><span class="branchNoCov" title="Branch 56 was not taken"> - </span><span class="branchNoCov" title="Branch 57 was not taken"> - </span><span class="branchNoCov" title="Branch 58 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 59 was not taken"> - </span><span class="branchNoCov" title="Branch 60 was not taken"> - </span><span class="branchNoCov" title="Branch 61 was not taken"> - </span><span class="branchNoCov" title="Branch 62 was not taken"> - </span><span class="branchNoCov" title="Branch 63 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 64 was not taken"> - </span><span class="branchCov" title="Branch 65 was taken 1 time"> + </span><span class="branchCov" title="Branch 66 was taken 1 time"> + </span><span class="branchCov" title="Branch 67 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 68 was not taken"> - </span> 
<span class="lineNum">         </span><span class="branchNoCov" title="Branch 69 was not taken"> - </span><span class="branchCov" title="Branch 70 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 71 was not taken"> - </span><span class="branchCov" title="Branch 72 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 73 was not taken"> - </span> 
<span class="lineNum">         </span>            <span class="branchNoCov" title="Branch 74 was not taken"> - </span>]
<span class="lineNum">     102 </span>                :            :         case EZFS_NOMEM:
<span class="lineNum">     103 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;out of memory&quot;));</span>
<span class="lineNum">     104 </span>                :            :         case EZFS_BADPROP:
<span class="lineNum">     105 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;invalid property value&quot;));</span>
<span class="lineNum">     106 </span>                :            :         case EZFS_PROPREADONLY:
<span class="lineNum">     107 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;read-only property&quot;));</span>
<span class="lineNum">     108 </span>                :            :         case EZFS_PROPTYPE:
<span class="lineNum">     109 </span>                :<span class="lineCov">         10 :                 return (dgettext(TEXT_DOMAIN, &quot;property doesn't apply to &quot;</span>
<span class="lineNum">     110 </span>                :            :                     &quot;datasets of this type&quot;));
<span class="lineNum">     111 </span>                :            :         case EZFS_PROPNONINHERIT:
<span class="lineNum">     112 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;property cannot be inherited&quot;));</span>
<span class="lineNum">     113 </span>                :            :         case EZFS_PROPSPACE:
<span class="lineNum">     114 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;invalid quota or reservation&quot;));</span>
<span class="lineNum">     115 </span>                :            :         case EZFS_BADTYPE:
<span class="lineNum">     116 </span>                :<span class="lineCov">         28 :                 return (dgettext(TEXT_DOMAIN, &quot;operation not applicable to &quot;</span>
<span class="lineNum">     117 </span>                :            :                     &quot;datasets of this type&quot;));
<span class="lineNum">     118 </span>                :            :         case EZFS_BUSY:
<span class="lineNum">     119 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;pool or dataset is busy&quot;));</span>
<span class="lineNum">     120 </span>                :            :         case EZFS_EXISTS:
<span class="lineNum">     121 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;pool or dataset exists&quot;));</span>
<span class="lineNum">     122 </span>                :            :         case EZFS_NOENT:
<span class="lineNum">     123 </span>                :<span class="lineCov">          9 :                 return (dgettext(TEXT_DOMAIN, &quot;no such pool or dataset&quot;));</span>
<span class="lineNum">     124 </span>                :            :         case EZFS_BADSTREAM:
<span class="lineNum">     125 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;invalid backup stream&quot;));</span>
<span class="lineNum">     126 </span>                :            :         case EZFS_DSREADONLY:
<span class="lineNum">     127 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;dataset is read-only&quot;));</span>
<span class="lineNum">     128 </span>                :            :         case EZFS_VOLTOOBIG:
<span class="lineNum">     129 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;volume size exceeds limit for &quot;</span>
<span class="lineNum">     130 </span>                :            :                     &quot;this system&quot;));
<span class="lineNum">     131 </span>                :            :         case EZFS_INVALIDNAME:
<span class="lineNum">     132 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;invalid name&quot;));</span>
<span class="lineNum">     133 </span>                :            :         case EZFS_BADRESTORE:
<span class="lineNum">     134 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;unable to restore to &quot;</span>
<span class="lineNum">     135 </span>                :            :                     &quot;destination&quot;));
<span class="lineNum">     136 </span>                :            :         case EZFS_BADBACKUP:
<span class="lineNum">     137 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;backup failed&quot;));</span>
<span class="lineNum">     138 </span>                :            :         case EZFS_BADTARGET:
<span class="lineNum">     139 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;invalid target vdev&quot;));</span>
<span class="lineNum">     140 </span>                :            :         case EZFS_NODEVICE:
<span class="lineNum">     141 </span>                :<span class="lineCov">          2 :                 return (dgettext(TEXT_DOMAIN, &quot;no such device in pool&quot;));</span>
<span class="lineNum">     142 </span>                :            :         case EZFS_BADDEV:
<span class="lineNum">     143 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;invalid device&quot;));</span>
<span class="lineNum">     144 </span>                :            :         case EZFS_NOREPLICAS:
<span class="lineNum">     145 </span>                :<span class="lineCov">         11 :                 return (dgettext(TEXT_DOMAIN, &quot;no valid replicas&quot;));</span>
<span class="lineNum">     146 </span>                :            :         case EZFS_RESILVERING:
<span class="lineNum">     147 </span>                :<span class="lineCov">          1 :                 return (dgettext(TEXT_DOMAIN, &quot;currently resilvering&quot;));</span>
<span class="lineNum">     148 </span>                :            :         case EZFS_BADVERSION:
<span class="lineNum">     149 </span>                :<span class="lineCov">         12 :                 return (dgettext(TEXT_DOMAIN, &quot;unsupported version or &quot;</span>
<span class="lineNum">     150 </span>                :            :                     &quot;feature&quot;));
<span class="lineNum">     151 </span>                :            :         case EZFS_POOLUNAVAIL:
<span class="lineNum">     152 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;pool is unavailable&quot;));</span>
<span class="lineNum">     153 </span>                :            :         case EZFS_DEVOVERFLOW:
<span class="lineNum">     154 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;too many devices in one vdev&quot;));</span>
<span class="lineNum">     155 </span>                :            :         case EZFS_BADPATH:
<span class="lineNum">     156 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;must be an absolute path&quot;));</span>
<span class="lineNum">     157 </span>                :            :         case EZFS_CROSSTARGET:
<span class="lineNum">     158 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;operation crosses datasets or &quot;</span>
<span class="lineNum">     159 </span>                :            :                     &quot;pools&quot;));
<span class="lineNum">     160 </span>                :            :         case EZFS_ZONED:
<span class="lineNum">     161 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;dataset in use by local zone&quot;));</span>
<span class="lineNum">     162 </span>                :            :         case EZFS_MOUNTFAILED:
<span class="lineNum">     163 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;mount failed&quot;));</span>
<span class="lineNum">     164 </span>                :            :         case EZFS_UMOUNTFAILED:
<span class="lineNum">     165 </span>                :<span class="lineCov">         27 :                 return (dgettext(TEXT_DOMAIN, &quot;umount failed&quot;));</span>
<span class="lineNum">     166 </span>                :            :         case EZFS_UNSHARENFSFAILED:
<span class="lineNum">     167 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;unshare(1M) failed&quot;));</span>
<span class="lineNum">     168 </span>                :            :         case EZFS_SHARENFSFAILED:
<span class="lineNum">     169 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;share(1M) failed&quot;));</span>
<span class="lineNum">     170 </span>                :            :         case EZFS_UNSHARESMBFAILED:
<span class="lineNum">     171 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;smb remove share failed&quot;));</span>
<span class="lineNum">     172 </span>                :            :         case EZFS_SHARESMBFAILED:
<span class="lineNum">     173 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;smb add share failed&quot;));</span>
<span class="lineNum">     174 </span>                :            :         case EZFS_PERM:
<span class="lineNum">     175 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;permission denied&quot;));</span>
<span class="lineNum">     176 </span>                :            :         case EZFS_NOSPC:
<span class="lineNum">     177 </span>                :<span class="lineCov">         10 :                 return (dgettext(TEXT_DOMAIN, &quot;out of space&quot;));</span>
<span class="lineNum">     178 </span>                :            :         case EZFS_FAULT:
<span class="lineNum">     179 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;bad address&quot;));</span>
<span class="lineNum">     180 </span>                :            :         case EZFS_IO:
<span class="lineNum">     181 </span>                :<span class="lineCov">          2 :                 return (dgettext(TEXT_DOMAIN, &quot;I/O error&quot;));</span>
<span class="lineNum">     182 </span>                :            :         case EZFS_INTR:
<span class="lineNum">     183 </span>                :<span class="lineCov">          3 :                 return (dgettext(TEXT_DOMAIN, &quot;signal received&quot;));</span>
<span class="lineNum">     184 </span>                :            :         case EZFS_ISSPARE:
<span class="lineNum">     185 </span>                :<span class="lineCov">          1 :                 return (dgettext(TEXT_DOMAIN, &quot;device is reserved as a hot &quot;</span>
<span class="lineNum">     186 </span>                :            :                     &quot;spare&quot;));
<span class="lineNum">     187 </span>                :            :         case EZFS_INVALCONFIG:
<span class="lineNum">     188 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;invalid vdev configuration&quot;));</span>
<span class="lineNum">     189 </span>                :            :         case EZFS_RECURSIVE:
<span class="lineNum">     190 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;recursive dataset dependency&quot;));</span>
<span class="lineNum">     191 </span>                :            :         case EZFS_NOHISTORY:
<span class="lineNum">     192 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;no history available&quot;));</span>
<span class="lineNum">     193 </span>                :            :         case EZFS_POOLPROPS:
<span class="lineNum">     194 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;failed to retrieve &quot;</span>
<span class="lineNum">     195 </span>                :            :                     &quot;pool properties&quot;));
<span class="lineNum">     196 </span>                :            :         case EZFS_POOL_NOTSUP:
<span class="lineNum">     197 </span>                :<span class="lineCov">          1 :                 return (dgettext(TEXT_DOMAIN, &quot;operation not supported &quot;</span>
<span class="lineNum">     198 </span>                :            :                     &quot;on this type of pool&quot;));
<span class="lineNum">     199 </span>                :            :         case EZFS_POOL_INVALARG:
<span class="lineNum">     200 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;invalid argument for &quot;</span>
<span class="lineNum">     201 </span>                :            :                     &quot;this pool operation&quot;));
<span class="lineNum">     202 </span>                :            :         case EZFS_NAMETOOLONG:
<span class="lineNum">     203 </span>                :<span class="lineCov">          3 :                 return (dgettext(TEXT_DOMAIN, &quot;dataset name is too long&quot;));</span>
<span class="lineNum">     204 </span>                :            :         case EZFS_OPENFAILED:
<span class="lineNum">     205 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;open failed&quot;));</span>
<span class="lineNum">     206 </span>                :            :         case EZFS_NOCAP:
<span class="lineNum">     207 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">     208 </span>                :            :                     &quot;disk capacity information could not be retrieved&quot;));
<span class="lineNum">     209 </span>                :            :         case EZFS_LABELFAILED:
<span class="lineNum">     210 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;write of label failed&quot;));</span>
<span class="lineNum">     211 </span>                :            :         case EZFS_BADWHO:
<span class="lineNum">     212 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;invalid user/group&quot;));</span>
<span class="lineNum">     213 </span>                :            :         case EZFS_BADPERM:
<span class="lineNum">     214 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;invalid permission&quot;));</span>
<span class="lineNum">     215 </span>                :            :         case EZFS_BADPERMSET:
<span class="lineNum">     216 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;invalid permission set name&quot;));</span>
<span class="lineNum">     217 </span>                :            :         case EZFS_NODELEGATION:
<span class="lineNum">     218 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;delegated administration is &quot;</span>
<span class="lineNum">     219 </span>                :            :                     &quot;disabled on pool&quot;));
<span class="lineNum">     220 </span>                :            :         case EZFS_BADCACHE:
<span class="lineNum">     221 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;invalid or missing cache file&quot;));</span>
<span class="lineNum">     222 </span>                :            :         case EZFS_ISL2CACHE:
<span class="lineNum">     223 </span>                :<span class="lineCov">          8 :                 return (dgettext(TEXT_DOMAIN, &quot;device is in use as a cache&quot;));</span>
<span class="lineNum">     224 </span>                :            :         case EZFS_VDEVNOTSUP:
<span class="lineNum">     225 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;vdev specification is not &quot;</span>
<span class="lineNum">     226 </span>                :            :                     &quot;supported&quot;));
<span class="lineNum">     227 </span>                :            :         case EZFS_NOTSUP:
<span class="lineNum">     228 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;operation not supported &quot;</span>
<span class="lineNum">     229 </span>                :            :                     &quot;on this dataset&quot;));
<span class="lineNum">     230 </span>                :            :         case EZFS_ACTIVE_SPARE:
<span class="lineNum">     231 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;pool has active shared spare &quot;</span>
<span class="lineNum">     232 </span>                :            :                     &quot;device&quot;));
<span class="lineNum">     233 </span>                :            :         case EZFS_UNPLAYED_LOGS:
<span class="lineNum">     234 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;log device has unplayed intent &quot;</span>
<span class="lineNum">     235 </span>                :            :                     &quot;logs&quot;));
<span class="lineNum">     236 </span>                :            :         case EZFS_REFTAG_RELE:
<span class="lineNum">     237 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;no such tag on this dataset&quot;));</span>
<span class="lineNum">     238 </span>                :            :         case EZFS_REFTAG_HOLD:
<span class="lineNum">     239 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;tag already exists on this &quot;</span>
<span class="lineNum">     240 </span>                :            :                     &quot;dataset&quot;));
<span class="lineNum">     241 </span>                :            :         case EZFS_TAGTOOLONG:
<span class="lineNum">     242 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;tag too long&quot;));</span>
<span class="lineNum">     243 </span>                :            :         case EZFS_PIPEFAILED:
<span class="lineNum">     244 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;pipe create failed&quot;));</span>
<span class="lineNum">     245 </span>                :            :         case EZFS_THREADCREATEFAILED:
<span class="lineNum">     246 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;thread create failed&quot;));</span>
<span class="lineNum">     247 </span>                :            :         case EZFS_POSTSPLIT_ONLINE:
<span class="lineNum">     248 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;disk was split from this pool &quot;</span>
<span class="lineNum">     249 </span>                :            :                     &quot;into a new one&quot;));
<span class="lineNum">     250 </span>                :            :         case EZFS_SCRUB_PAUSED:
<span class="lineNum">     251 </span>                :<span class="lineCov">          1 :                 return (dgettext(TEXT_DOMAIN, &quot;scrub is paused; &quot;</span>
<span class="lineNum">     252 </span>                :            :                     &quot;use 'zpool scrub' to resume&quot;));
<span class="lineNum">     253 </span>                :            :         case EZFS_SCRUBBING:
<span class="lineNum">     254 </span>                :<span class="lineCov">          1 :                 return (dgettext(TEXT_DOMAIN, &quot;currently scrubbing; &quot;</span>
<span class="lineNum">     255 </span>                :            :                     &quot;use 'zpool scrub -s' to cancel current scrub&quot;));
<span class="lineNum">     256 </span>                :            :         case EZFS_NO_SCRUB:
<span class="lineNum">     257 </span>                :<span class="lineCov">          1 :                 return (dgettext(TEXT_DOMAIN, &quot;there is no active scrub&quot;));</span>
<span class="lineNum">     258 </span>                :            :         case EZFS_DIFF:
<span class="lineNum">     259 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;unable to generate diffs&quot;));</span>
<span class="lineNum">     260 </span>                :            :         case EZFS_DIFFDATA:
<span class="lineNum">     261 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;invalid diff data&quot;));</span>
<span class="lineNum">     262 </span>                :            :         case EZFS_POOLREADONLY:
<span class="lineNum">     263 </span>                :<span class="lineCov">          4 :                 return (dgettext(TEXT_DOMAIN, &quot;pool is read-only&quot;));</span>
<span class="lineNum">     264 </span>                :            :         case EZFS_ACTIVE_POOL:
<span class="lineNum">     265 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;pool is imported on a &quot;</span>
<span class="lineNum">     266 </span>                :            :                     &quot;different host&quot;));
<span class="lineNum">     267 </span>                :            :         case EZFS_CRYPTOFAILED:
<span class="lineNum">     268 </span>                :<span class="lineCov">          1 :                 return (dgettext(TEXT_DOMAIN, &quot;encryption failure&quot;));</span>
<span class="lineNum">     269 </span>                :            :         case EZFS_UNKNOWN:
<span class="lineNum">     270 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;unknown error&quot;));</span>
<span class="lineNum">     271 </span>                :            :         default:
<span class="lineNum">     272 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 assert(hdl-&gt;libzfs_error == 0);</span>
<span class="lineNum">     273 </span>                :<span class="lineNoCov">          0 :                 return (dgettext(TEXT_DOMAIN, &quot;no error&quot;));</span>
<span class="lineNum">     274 </span>                :            :         }
<span class="lineNum">     275 </span>                :            : }
<span class="lineNum">     276 </span>                :            : 
<a name="277"><span class="lineNum">     277 </span>                :            : /*PRINTFLIKE2*/</a>
<span class="lineNum">     278 </span>                :            : void
<span class="lineNum">     279 </span>                :<span class="lineCov">       7689 : zfs_error_aux(libzfs_handle_t *hdl, const char *fmt, ...)</span>
<span class="lineNum">     280 </span>                :            : {
<span class="lineNum">     281 </span>                :            :         va_list ap;
<span class="lineNum">     282 </span>                :            : 
<span class="lineNum">     283 </span>                :<span class="lineCov">       7689 :         va_start(ap, fmt);</span>
<span class="lineNum">     284 </span>                :            : 
<span class="lineNum">     285 </span>                :<span class="lineCov">      15378 :         (void) vsnprintf(hdl-&gt;libzfs_desc, sizeof (hdl-&gt;libzfs_desc),</span>
<span class="lineNum">     286 </span>                :            :             fmt, ap);
<span class="lineNum">     287 </span>                :<span class="lineCov">       7689 :         hdl-&gt;libzfs_desc_active = 1;</span>
<span class="lineNum">     288 </span>                :            : 
<span class="lineNum">     289 </span>                :<span class="lineCov">       7689 :         va_end(ap);</span>
<span class="lineNum">     290 </span>                :<span class="lineCov">       7689 : }</span>
<a name="291"><span class="lineNum">     291 </span>                :            : </a>
<span class="lineNum">     292 </span>                :            : static void
<span class="lineNum">     293 </span>                :<span class="lineCov">       7723 : zfs_verror(libzfs_handle_t *hdl, int error, const char *fmt, va_list ap)</span>
<span class="lineNum">     294 </span>                :            : {
<span class="lineNum">     295 </span>                :<span class="lineCov">      15446 :         (void) vsnprintf(hdl-&gt;libzfs_action, sizeof (hdl-&gt;libzfs_action),</span>
<span class="lineNum">     296 </span>                :            :             fmt, ap);
<span class="lineNum">     297 </span>                :<span class="lineCov">       7723 :         hdl-&gt;libzfs_error = error;</span>
<span class="lineNum">     298 </span>                :            : 
<span class="lineNum">     299 </span>        [<span class="branchCov" title="Branch 0 was taken 7585 times"> + </span><span class="branchCov" title="Branch 1 was taken 138 times"> + </span>]:<span class="lineCov">       7723 :         if (hdl-&gt;libzfs_desc_active)</span>
<span class="lineNum">     300 </span>                :<span class="lineCov">       7585 :                 hdl-&gt;libzfs_desc_active = 0;</span>
<span class="lineNum">     301 </span>                :            :         else
<span class="lineNum">     302 </span>                :<span class="lineCov">        138 :                 hdl-&gt;libzfs_desc[0] = '\0';</span>
<span class="lineNum">     303 </span>                :            : 
<span class="lineNum">     304 </span>        [<span class="branchCov" title="Branch 0 was taken 7721 times"> + </span><span class="branchCov" title="Branch 1 was taken 2 times"> + </span>]:<span class="lineCov">       7723 :         if (hdl-&gt;libzfs_printerr) {</span>
<span class="lineNum">     305 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7721 times"> + </span>]:<span class="lineCov">       7721 :                 if (error == EZFS_UNKNOWN) {</span>
<span class="lineNum">     306 </span>                :<span class="lineNoCov">          0 :                         (void) fprintf(stderr, dgettext(TEXT_DOMAIN, &quot;internal &quot;</span>
<span class="lineNum">     307 </span>                :            :                             &quot;error: %s\n&quot;), libzfs_error_description(hdl));
<span class="lineNum">     308 </span>                :<span class="lineNoCov">          0 :                         abort();</span>
<span class="lineNum">     309 </span>                :            :                 }
<span class="lineNum">     310 </span>                :            : 
<span class="lineNum">     311 </span>                :<span class="lineCov">       7721 :                 (void) fprintf(stderr, &quot;%s: %s\n&quot;, hdl-&gt;libzfs_action,</span>
<span class="lineNum">     312 </span>                :            :                     libzfs_error_description(hdl));
<span class="lineNum">     313 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 7721 times"> + </span>]:<span class="lineCov">       7721 :                 if (error == EZFS_NOMEM)</span>
<span class="lineNum">     314 </span>                :<span class="lineNoCov">          0 :                         exit(1);</span>
<span class="lineNum">     315 </span>                :            :         }
<span class="lineNum">     316 </span>                :<span class="lineCov">       7723 : }</span>
<a name="317"><span class="lineNum">     317 </span>                :            : </a>
<span class="lineNum">     318 </span>                :            : int
<span class="lineNum">     319 </span>                :<span class="lineCov">       4943 : zfs_error(libzfs_handle_t *hdl, int error, const char *msg)</span>
<span class="lineNum">     320 </span>                :            : {
<span class="lineNum">     321 </span>                :<span class="lineCov">       4943 :         return (zfs_error_fmt(hdl, error, &quot;%s&quot;, msg));</span>
<span class="lineNum">     322 </span>                :            : }
<span class="lineNum">     323 </span>                :            : 
<a name="324"><span class="lineNum">     324 </span>                :            : /*PRINTFLIKE3*/</a>
<span class="lineNum">     325 </span>                :            : int
<span class="lineNum">     326 </span>                :<span class="lineCov">       6163 : zfs_error_fmt(libzfs_handle_t *hdl, int error, const char *fmt, ...)</span>
<span class="lineNum">     327 </span>                :            : {
<span class="lineNum">     328 </span>                :            :         va_list ap;
<span class="lineNum">     329 </span>                :            : 
<span class="lineNum">     330 </span>                :<span class="lineCov">       6163 :         va_start(ap, fmt);</span>
<span class="lineNum">     331 </span>                :            : 
<span class="lineNum">     332 </span>                :<span class="lineCov">       6163 :         zfs_verror(hdl, error, fmt, ap);</span>
<span class="lineNum">     333 </span>                :            : 
<span class="lineNum">     334 </span>                :<span class="lineCov">       6163 :         va_end(ap);</span>
<span class="lineNum">     335 </span>                :            : 
<span class="lineNum">     336 </span>                :<span class="lineCov">       6163 :         return (-1);</span>
<span class="lineNum">     337 </span>                :            : }
<a name="338"><span class="lineNum">     338 </span>                :            : </a>
<span class="lineNum">     339 </span>                :            : static int
<span class="lineNum">     340 </span>                :<span class="lineCov">       1560 : zfs_common_error(libzfs_handle_t *hdl, int error, const char *fmt,</span>
<span class="lineNum">     341 </span>                :            :     va_list ap)
<span class="lineNum">     342 </span>                :            : {
<span class="lineNum">     343 </span>  [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">       1560 :         switch (error) {</span>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 5 times"> + </span><span class="branchCov" title="Branch 5 was taken 1555 times"> + </span>]
<span class="lineNum">     344 </span>                :            :         case EPERM:
<span class="lineNum">     345 </span>                :            :         case EACCES:
<span class="lineNum">     346 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_PERM, fmt, ap);</span>
<span class="lineNum">     347 </span>                :<span class="lineNoCov">          0 :                 return (-1);</span>
<span class="lineNum">     348 </span>                :            : 
<span class="lineNum">     349 </span>                :            :         case ECANCELED:
<span class="lineNum">     350 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_NODELEGATION, fmt, ap);</span>
<span class="lineNum">     351 </span>                :<span class="lineNoCov">          0 :                 return (-1);</span>
<span class="lineNum">     352 </span>                :            : 
<span class="lineNum">     353 </span>                :            :         case EIO:
<span class="lineNum">     354 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_IO, fmt, ap);</span>
<span class="lineNum">     355 </span>                :<span class="lineNoCov">          0 :                 return (-1);</span>
<span class="lineNum">     356 </span>                :            : 
<span class="lineNum">     357 </span>                :            :         case EFAULT:
<span class="lineNum">     358 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_FAULT, fmt, ap);</span>
<span class="lineNum">     359 </span>                :<span class="lineNoCov">          0 :                 return (-1);</span>
<span class="lineNum">     360 </span>                :            : 
<span class="lineNum">     361 </span>                :            :         case EINTR:
<span class="lineNum">     362 </span>                :<span class="lineCov">          5 :                 zfs_verror(hdl, EZFS_INTR, fmt, ap);</span>
<span class="lineNum">     363 </span>                :<span class="lineCov">          5 :                 return (-1);</span>
<span class="lineNum">     364 </span>                :            :         }
<span class="lineNum">     365 </span>                :            : 
<span class="lineNum">     366 </span>                :            :         return (0);
<span class="lineNum">     367 </span>                :            : }
<a name="368"><span class="lineNum">     368 </span>                :            : </a>
<span class="lineNum">     369 </span>                :            : int
<span class="lineNum">     370 </span>                :<span class="lineCov">       1526 : zfs_standard_error(libzfs_handle_t *hdl, int error, const char *msg)</span>
<span class="lineNum">     371 </span>                :            : {
<span class="lineNum">     372 </span>                :<span class="lineCov">       1526 :         return (zfs_standard_error_fmt(hdl, error, &quot;%s&quot;, msg));</span>
<span class="lineNum">     373 </span>                :            : }
<span class="lineNum">     374 </span>                :            : 
<a name="375"><span class="lineNum">     375 </span>                :            : /*PRINTFLIKE3*/</a>
<span class="lineNum">     376 </span>                :            : int
<span class="lineNum">     377 </span>                :<span class="lineCov">       1526 : zfs_standard_error_fmt(libzfs_handle_t *hdl, int error, const char *fmt, ...)</span>
<span class="lineNum">     378 </span>                :            : {
<span class="lineNum">     379 </span>                :            :         va_list ap;
<span class="lineNum">     380 </span>                :            : 
<span class="lineNum">     381 </span>                :<span class="lineCov">       1526 :         va_start(ap, fmt);</span>
<span class="lineNum">     382 </span>                :            : 
<span class="lineNum">     383 </span>        [<span class="branchCov" title="Branch 1 was taken 3 times"> + </span><span class="branchCov" title="Branch 2 was taken 1523 times"> + </span>]:<span class="lineCov">       1526 :         if (zfs_common_error(hdl, error, fmt, ap) != 0) {</span>
<span class="lineNum">     384 </span>                :<span class="lineCov">          3 :                 va_end(ap);</span>
<span class="lineNum">     385 </span>                :<span class="lineCov">          3 :                 return (-1);</span>
<span class="lineNum">     386 </span>                :            :         }
<span class="lineNum">     387 </span>                :            : 
<span class="lineNum">     388 </span>  [<span class="branchCov" title="Branch 0 was taken 2 times"> + </span><span class="branchCov" title="Branch 1 was taken 1486 times"> + </span><span class="branchCov" title="Branch 2 was taken 10 times"> + </span><span class="branchCov" title="Branch 3 was taken 5 times"> + </span> :<span class="lineCov">       1523 :         switch (error) {</span>
<span class="lineNum">         </span><span class="branchCov" title="Branch 4 was taken 17 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 3 times"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">         </span>         <span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchNoCov" title="Branch 10 was not taken"> - </span>]
<span class="lineNum">     389 </span>                :            :         case ENXIO:
<span class="lineNum">     390 </span>                :            :         case ENODEV:
<span class="lineNum">     391 </span>                :            :         case EPIPE:
<span class="lineNum">     392 </span>                :<span class="lineCov">          2 :                 zfs_verror(hdl, EZFS_IO, fmt, ap);</span>
<span class="lineNum">     393 </span>                :<span class="lineCov">          2 :                 break;</span>
<span class="lineNum">     394 </span>                :            : 
<span class="lineNum">     395 </span>                :            :         case ENOENT:
<span class="lineNum">     396 </span>                :<span class="lineCov">       1486 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">     397 </span>                :            :                     &quot;dataset does not exist&quot;));
<span class="lineNum">     398 </span>                :<span class="lineCov">       1486 :                 zfs_verror(hdl, EZFS_NOENT, fmt, ap);</span>
<span class="lineNum">     399 </span>                :<span class="lineCov">       1486 :                 break;</span>
<span class="lineNum">     400 </span>                :            : 
<span class="lineNum">     401 </span>                :            :         case ENOSPC:
<span class="lineNum">     402 </span>                :            :         case EDQUOT:
<span class="lineNum">     403 </span>                :<span class="lineCov">         10 :                 zfs_verror(hdl, EZFS_NOSPC, fmt, ap);</span>
<span class="lineNum">     404 </span>                :<span class="lineCov">         10 :                 break;</span>
<span class="lineNum">     405 </span>                :            : 
<span class="lineNum">     406 </span>                :            :         case EEXIST:
<span class="lineNum">     407 </span>                :<span class="lineCov">          5 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">     408 </span>                :            :                     &quot;dataset already exists&quot;));
<span class="lineNum">     409 </span>                :<span class="lineCov">          5 :                 zfs_verror(hdl, EZFS_EXISTS, fmt, ap);</span>
<span class="lineNum">     410 </span>                :<span class="lineCov">          5 :                 break;</span>
<span class="lineNum">     411 </span>                :            : 
<span class="lineNum">     412 </span>                :            :         case EBUSY:
<span class="lineNum">     413 </span>                :<span class="lineCov">         17 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">     414 </span>                :            :                     &quot;dataset is busy&quot;));
<span class="lineNum">     415 </span>                :<span class="lineCov">         17 :                 zfs_verror(hdl, EZFS_BUSY, fmt, ap);</span>
<span class="lineNum">     416 </span>                :<span class="lineCov">         17 :                 break;</span>
<span class="lineNum">     417 </span>                :            :         case EROFS:
<span class="lineNum">     418 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_POOLREADONLY, fmt, ap);</span>
<span class="lineNum">     419 </span>                :<span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     420 </span>                :            :         case ENAMETOOLONG:
<span class="lineNum">     421 </span>                :<span class="lineCov">          3 :                 zfs_verror(hdl, EZFS_NAMETOOLONG, fmt, ap);</span>
<span class="lineNum">     422 </span>                :<span class="lineCov">          3 :                 break;</span>
<span class="lineNum">     423 </span>                :            :         case ENOTSUP:
<span class="lineNum">     424 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_BADVERSION, fmt, ap);</span>
<span class="lineNum">     425 </span>                :<span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     426 </span>                :            :         case EAGAIN:
<span class="lineNum">     427 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">     428 </span>                :            :                     &quot;pool I/O is currently suspended&quot;));
<span class="lineNum">     429 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_POOLUNAVAIL, fmt, ap);</span>
<span class="lineNum">     430 </span>                :<span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     431 </span>                :            :         case EREMOTEIO:
<span class="lineNum">     432 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_ACTIVE_POOL, fmt, ap);</span>
<span class="lineNum">     433 </span>                :<span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     434 </span>                :            :         default:
<span class="lineNum">     435 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, strerror(error));</span>
<span class="lineNum">     436 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_UNKNOWN, fmt, ap);</span>
<span class="lineNum">     437 </span>                :<span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     438 </span>                :            :         }
<span class="lineNum">     439 </span>                :            : 
<span class="lineNum">     440 </span>                :<span class="lineCov">       1523 :         va_end(ap);</span>
<span class="lineNum">     441 </span>                :<span class="lineCov">       1523 :         return (-1);</span>
<span class="lineNum">     442 </span>                :            : }
<a name="443"><span class="lineNum">     443 </span>                :            : </a>
<span class="lineNum">     444 </span>                :            : int
<span class="lineNum">     445 </span>                :<span class="lineCov">         32 : zpool_standard_error(libzfs_handle_t *hdl, int error, const char *msg)</span>
<span class="lineNum">     446 </span>                :            : {
<span class="lineNum">     447 </span>                :<span class="lineCov">         32 :         return (zpool_standard_error_fmt(hdl, error, &quot;%s&quot;, msg));</span>
<span class="lineNum">     448 </span>                :            : }
<span class="lineNum">     449 </span>                :            : 
<a name="450"><span class="lineNum">     450 </span>                :            : /*PRINTFLIKE3*/</a>
<span class="lineNum">     451 </span>                :            : int
<span class="lineNum">     452 </span>                :<span class="lineCov">         34 : zpool_standard_error_fmt(libzfs_handle_t *hdl, int error, const char *fmt, ...)</span>
<span class="lineNum">     453 </span>                :            : {
<span class="lineNum">     454 </span>                :            :         va_list ap;
<span class="lineNum">     455 </span>                :            : 
<span class="lineNum">     456 </span>                :<span class="lineCov">         34 :         va_start(ap, fmt);</span>
<span class="lineNum">     457 </span>                :            : 
<span class="lineNum">     458 </span>        [<span class="branchCov" title="Branch 1 was taken 2 times"> + </span><span class="branchCov" title="Branch 2 was taken 32 times"> + </span>]:<span class="lineCov">         34 :         if (zfs_common_error(hdl, error, fmt, ap) != 0) {</span>
<span class="lineNum">     459 </span>                :<span class="lineCov">          2 :                 va_end(ap);</span>
<span class="lineNum">     460 </span>                :<span class="lineCov">          2 :                 return (-1);</span>
<span class="lineNum">     461 </span>                :            :         }
<span class="lineNum">     462 </span>                :            : 
<span class="lineNum">     463 </span>  [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 5 times"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">         32 :         switch (error) {</span>
<span class="lineNum">         </span><span class="branchCov" title="Branch 4 was taken 20 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 1 time"> + </span><span class="branchNoCov" title="Branch 7 was not taken"> - </span><span class="branchNoCov" title="Branch 8 was not taken"> - </span> 
<span class="lineNum">         </span>   <span class="branchNoCov" title="Branch 9 was not taken"> - </span><span class="branchCov" title="Branch 10 was taken 4 times"> + </span><span class="branchNoCov" title="Branch 11 was not taken"> - </span><span class="branchNoCov" title="Branch 12 was not taken"> - </span> 
<span class="lineNum">         </span>            <span class="branchNoCov" title="Branch 13 was not taken"> - </span>]
<span class="lineNum">     464 </span>                :            :         case ENODEV:
<span class="lineNum">     465 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_NODEVICE, fmt, ap);</span>
<span class="lineNum">     466 </span>                :<span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     467 </span>                :            : 
<span class="lineNum">     468 </span>                :            :         case ENOENT:
<span class="lineNum">     469 </span>                :<span class="lineCov">          5 :                 zfs_error_aux(hdl,</span>
<span class="lineNum">     470 </span>                :<span class="lineCov">          5 :                     dgettext(TEXT_DOMAIN, &quot;no such pool or dataset&quot;));</span>
<span class="lineNum">     471 </span>                :<span class="lineCov">          5 :                 zfs_verror(hdl, EZFS_NOENT, fmt, ap);</span>
<span class="lineNum">     472 </span>                :<span class="lineCov">          5 :                 break;</span>
<span class="lineNum">     473 </span>                :            : 
<span class="lineNum">     474 </span>                :            :         case EEXIST:
<span class="lineNum">     475 </span>                :<span class="lineCov">          2 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">     476 </span>                :            :                     &quot;pool already exists&quot;));
<span class="lineNum">     477 </span>                :<span class="lineCov">          2 :                 zfs_verror(hdl, EZFS_EXISTS, fmt, ap);</span>
<span class="lineNum">     478 </span>                :<span class="lineCov">          2 :                 break;</span>
<span class="lineNum">     479 </span>                :            : 
<span class="lineNum">     480 </span>                :            :         case EBUSY:
<span class="lineNum">     481 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN, &quot;pool is busy&quot;));</span>
<span class="lineNum">     482 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_BUSY, fmt, ap);</span>
<span class="lineNum">     483 </span>                :<span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     484 </span>                :            : 
<span class="lineNum">     485 </span>                :            :         case ENXIO:
<span class="lineNum">     486 </span>                :<span class="lineCov">         20 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">     487 </span>                :            :                     &quot;one or more devices is currently unavailable&quot;));
<span class="lineNum">     488 </span>                :<span class="lineCov">         20 :                 zfs_verror(hdl, EZFS_BADDEV, fmt, ap);</span>
<span class="lineNum">     489 </span>                :<span class="lineCov">         20 :                 break;</span>
<span class="lineNum">     490 </span>                :            : 
<span class="lineNum">     491 </span>                :            :         case ENAMETOOLONG:
<span class="lineNum">     492 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_DEVOVERFLOW, fmt, ap);</span>
<span class="lineNum">     493 </span>                :<span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     494 </span>                :            : 
<span class="lineNum">     495 </span>                :            :         case ENOTSUP:
<span class="lineNum">     496 </span>                :<span class="lineCov">          1 :                 zfs_verror(hdl, EZFS_POOL_NOTSUP, fmt, ap);</span>
<span class="lineNum">     497 </span>                :<span class="lineCov">          1 :                 break;</span>
<span class="lineNum">     498 </span>                :            : 
<span class="lineNum">     499 </span>                :            :         case EINVAL:
<span class="lineNum">     500 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_POOL_INVALARG, fmt, ap);</span>
<span class="lineNum">     501 </span>                :<span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     502 </span>                :            : 
<span class="lineNum">     503 </span>                :            :         case ENOSPC:
<span class="lineNum">     504 </span>                :            :         case EDQUOT:
<span class="lineNum">     505 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_NOSPC, fmt, ap);</span>
<span class="lineNum">     506 </span>                :<span class="lineNoCov">          0 :                 return (-1);</span>
<span class="lineNum">     507 </span>                :            : 
<span class="lineNum">     508 </span>                :            :         case EAGAIN:
<span class="lineNum">     509 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">     510 </span>                :            :                     &quot;pool I/O is currently suspended&quot;));
<span class="lineNum">     511 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_POOLUNAVAIL, fmt, ap);</span>
<span class="lineNum">     512 </span>                :<span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     513 </span>                :            : 
<span class="lineNum">     514 </span>                :            :         case EROFS:
<span class="lineNum">     515 </span>                :<span class="lineCov">          4 :                 zfs_verror(hdl, EZFS_POOLREADONLY, fmt, ap);</span>
<span class="lineNum">     516 </span>                :<span class="lineCov">          4 :                 break;</span>
<span class="lineNum">     517 </span>                :            :         case EDOM:
<span class="lineNum">     518 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">     519 </span>                :            :                     &quot;block size out of range or does not match&quot;));
<span class="lineNum">     520 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_BADPROP, fmt, ap);</span>
<span class="lineNum">     521 </span>                :<span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     522 </span>                :            :         case EREMOTEIO:
<span class="lineNum">     523 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_ACTIVE_POOL, fmt, ap);</span>
<span class="lineNum">     524 </span>                :<span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     525 </span>                :            : 
<span class="lineNum">     526 </span>                :            :         default:
<span class="lineNum">     527 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, strerror(error));</span>
<span class="lineNum">     528 </span>                :<span class="lineNoCov">          0 :                 zfs_verror(hdl, EZFS_UNKNOWN, fmt, ap);</span>
<span class="lineNum">     529 </span>                :            :         }
<span class="lineNum">     530 </span>                :            : 
<span class="lineNum">     531 </span>                :<span class="lineCov">         32 :         va_end(ap);</span>
<span class="lineNum">     532 </span>                :<span class="lineCov">         32 :         return (-1);</span>
<span class="lineNum">     533 </span>                :            : }
<span class="lineNum">     534 </span>                :            : 
<span class="lineNum">     535 </span>                :            : /*
<span class="lineNum">     536 </span>                :            :  * Display an out of memory error message and abort the current program.
<a name="537"><span class="lineNum">     537 </span>                :            :  */</a>
<span class="lineNum">     538 </span>                :            : int
<span class="lineNum">     539 </span>                :<span class="lineNoCov">          0 : no_memory(libzfs_handle_t *hdl)</span>
<span class="lineNum">     540 </span>                :            : {
<span class="lineNum">     541 </span>                :<span class="lineNoCov">          0 :         return (zfs_error(hdl, EZFS_NOMEM, &quot;internal error&quot;));</span>
<span class="lineNum">     542 </span>                :            : }
<span class="lineNum">     543 </span>                :            : 
<span class="lineNum">     544 </span>                :            : /*
<span class="lineNum">     545 </span>                :            :  * A safe form of malloc() which will die if the allocation fails.
<a name="546"><span class="lineNum">     546 </span>                :            :  */</a>
<span class="lineNum">     547 </span>                :            : void *
<span class="lineNum">     548 </span>                :<span class="lineCov">     481656 : zfs_alloc(libzfs_handle_t *hdl, size_t size)</span>
<span class="lineNum">     549 </span>                :            : {
<span class="lineNum">     550 </span>                :            :         void *data;
<span class="lineNum">     551 </span>                :            : 
<span class="lineNum">     552 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 481656 times"> + </span>]:<span class="lineCov">     481656 :         if ((data = calloc(1, size)) == NULL)</span>
<span class="lineNum">     553 </span>                :<span class="lineNoCov">          0 :                 (void) no_memory(hdl);</span>
<span class="lineNum">     554 </span>                :            : 
<span class="lineNum">     555 </span>                :<span class="lineCov">     481656 :         return (data);</span>
<span class="lineNum">     556 </span>                :            : }
<span class="lineNum">     557 </span>                :            : 
<span class="lineNum">     558 </span>                :            : /*
<span class="lineNum">     559 </span>                :            :  * A safe form of asprintf() which will die if the allocation fails.
<span class="lineNum">     560 </span>                :            :  */
<a name="561"><span class="lineNum">     561 </span>                :            : /*PRINTFLIKE2*/</a>
<span class="lineNum">     562 </span>                :            : char *
<span class="lineNum">     563 </span>                :<span class="lineCov">        252 : zfs_asprintf(libzfs_handle_t *hdl, const char *fmt, ...)</span>
<span class="lineNum">     564 </span>                :            : {
<span class="lineNum">     565 </span>                :            :         va_list ap;
<span class="lineNum">     566 </span>                :            :         char *ret;
<span class="lineNum">     567 </span>                :            :         int err;
<span class="lineNum">     568 </span>                :            : 
<span class="lineNum">     569 </span>                :<span class="lineCov">        252 :         va_start(ap, fmt);</span>
<span class="lineNum">     570 </span>                :            : 
<span class="lineNum">     571 </span>                :<span class="lineCov">        252 :         err = vasprintf(&amp;ret, fmt, ap);</span>
<span class="lineNum">     572 </span>                :            : 
<span class="lineNum">     573 </span>                :<span class="lineCov">        252 :         va_end(ap);</span>
<span class="lineNum">     574 </span>                :            : 
<span class="lineNum">     575 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 252 times"> + </span>]:<span class="lineCov">        252 :         if (err &lt; 0)</span>
<span class="lineNum">     576 </span>                :<span class="lineNoCov">          0 :                 (void) no_memory(hdl);</span>
<span class="lineNum">     577 </span>                :            : 
<span class="lineNum">     578 </span>                :<span class="lineCov">        252 :         return (ret);</span>
<span class="lineNum">     579 </span>                :            : }
<span class="lineNum">     580 </span>                :            : 
<span class="lineNum">     581 </span>                :            : /*
<span class="lineNum">     582 </span>                :            :  * A safe form of realloc(), which also zeroes newly allocated space.
<a name="583"><span class="lineNum">     583 </span>                :            :  */</a>
<span class="lineNum">     584 </span>                :            : void *
<span class="lineNum">     585 </span>                :<span class="lineCov">        330 : zfs_realloc(libzfs_handle_t *hdl, void *ptr, size_t oldsize, size_t newsize)</span>
<span class="lineNum">     586 </span>                :            : {
<span class="lineNum">     587 </span>                :            :         void *ret;
<span class="lineNum">     588 </span>                :            : 
<span class="lineNum">     589 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 330 times"> + </span>]:<span class="lineCov">        330 :         if ((ret = realloc(ptr, newsize)) == NULL) {</span>
<span class="lineNum">     590 </span>                :<span class="lineNoCov">          0 :                 (void) no_memory(hdl);</span>
<span class="lineNum">     591 </span>                :<span class="lineNoCov">          0 :                 return (NULL);</span>
<span class="lineNum">     592 </span>                :            :         }
<span class="lineNum">     593 </span>                :            : 
<span class="lineNum">     594 </span>                :<span class="lineCov">        660 :         bzero((char *)ret + oldsize, (newsize - oldsize));</span>
<span class="lineNum">     595 </span>                :<span class="lineCov">        330 :         return (ret);</span>
<span class="lineNum">     596 </span>                :            : }
<span class="lineNum">     597 </span>                :            : 
<span class="lineNum">     598 </span>                :            : /*
<span class="lineNum">     599 </span>                :            :  * A safe form of strdup() which will die if the allocation fails.
<a name="600"><span class="lineNum">     600 </span>                :            :  */</a>
<span class="lineNum">     601 </span>                :            : char *
<span class="lineNum">     602 </span>                :<span class="lineCov">     133725 : zfs_strdup(libzfs_handle_t *hdl, const char *str)</span>
<span class="lineNum">     603 </span>                :            : {
<span class="lineNum">     604 </span>                :            :         char *ret;
<span class="lineNum">     605 </span>                :            : 
<span class="lineNum">     606 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 133725 times"> + </span>]:<span class="lineCov">     133725 :         if ((ret = strdup(str)) == NULL)</span>
<span class="lineNum">     607 </span>                :<span class="lineNoCov">          0 :                 (void) no_memory(hdl);</span>
<span class="lineNum">     608 </span>                :            : 
<span class="lineNum">     609 </span>                :<span class="lineCov">     133725 :         return (ret);</span>
<span class="lineNum">     610 </span>                :            : }
<span class="lineNum">     611 </span>                :            : 
<span class="lineNum">     612 </span>                :            : /*
<span class="lineNum">     613 </span>                :            :  * Convert a number to an appropriately human-readable output.
<a name="614"><span class="lineNum">     614 </span>                :            :  */</a>
<span class="lineNum">     615 </span>                :            : void
<span class="lineNum">     616 </span>                :<span class="lineCov">      60038 : zfs_nicenum_format(uint64_t num, char *buf, size_t buflen,</span>
<span class="lineNum">     617 </span>                :            :     enum zfs_nicenum_format format)
<span class="lineNum">     618 </span>                :            : {
<span class="lineNum">     619 </span>                :<span class="lineCov">      60038 :         uint64_t n = num;</span>
<span class="lineNum">     620 </span>                :<span class="lineCov">      60038 :         int index = 0;</span>
<span class="lineNum">     621 </span>                :            :         const char *u;
<span class="lineNum">     622 </span>                :<span class="lineCov">      60038 :         const char *units[3][7] = {</span>
<span class="lineNum">     623 </span>                :            :             [ZFS_NICENUM_1024] = {&quot;&quot;, &quot;K&quot;, &quot;M&quot;, &quot;G&quot;, &quot;T&quot;, &quot;P&quot;, &quot;E&quot;},
<span class="lineNum">     624 </span>                :            :             [ZFS_NICENUM_BYTES] = {&quot;B&quot;, &quot;K&quot;, &quot;M&quot;, &quot;G&quot;, &quot;T&quot;, &quot;P&quot;, &quot;E&quot;},
<span class="lineNum">     625 </span>                :            :             [ZFS_NICENUM_TIME] = {&quot;ns&quot;, &quot;us&quot;, &quot;ms&quot;, &quot;s&quot;, &quot;?&quot;, &quot;?&quot;, &quot;?&quot;}
<span class="lineNum">     626 </span>                :            :         };
<span class="lineNum">     627 </span>                :            : 
<span class="lineNum">     628 </span>                :<span class="lineCov">      60038 :         const int units_len[] = {[ZFS_NICENUM_1024] = 6,</span>
<span class="lineNum">     629 </span>                :            :             [ZFS_NICENUM_BYTES] = 6,
<span class="lineNum">     630 </span>                :            :             [ZFS_NICENUM_TIME] = 4};
<span class="lineNum">     631 </span>                :            : 
<span class="lineNum">     632 </span>                :<span class="lineCov">      60038 :         const int k_unit[] = {  [ZFS_NICENUM_1024] = 1024,</span>
<span class="lineNum">     633 </span>                :            :             [ZFS_NICENUM_BYTES] = 1024,
<span class="lineNum">     634 </span>                :            :             [ZFS_NICENUM_TIME] = 1000};
<span class="lineNum">     635 </span>                :            : 
<span class="lineNum">     636 </span>                :            :         double val;
<span class="lineNum">     637 </span>                :            : 
<span class="lineNum">     638 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 60038 times"> + </span>]:<span class="lineCov">      60038 :         if (format == ZFS_NICENUM_RAW) {</span>
<span class="lineNum">     639 </span>                :            :                 snprintf(buf, buflen, &quot;%llu&quot;, (u_longlong_t)num);
<span class="lineNum">     640 </span>                :<span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     641 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 60038 times"> + </span>]:<span class="lineCov">      60038 :         } else if (format == ZFS_NICENUM_RAWTIME &amp;&amp; num &gt; 0) {</span>
<span class="lineNum">     642 </span>                :            :                 snprintf(buf, buflen, &quot;%llu&quot;, (u_longlong_t)num);
<span class="lineNum">     643 </span>                :            :                 return;
<span class="lineNum">     644 </span>        [<span class="branchCov" title="Branch 0 was taken 60038 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      60038 :         } else if (format == ZFS_NICENUM_RAWTIME &amp;&amp; num == 0) {</span>
<span class="lineNum">     645 </span>                :            :                 snprintf(buf, buflen, &quot;%s&quot;, &quot;-&quot;);
<span class="lineNum">     646 </span>                :            :                 return;
<span class="lineNum">     647 </span>                :            :         }
<span class="lineNum">     648 </span>                :            : 
<span class="lineNum">     649 </span>[<span class="branchCov" title="Branch 0 was taken 29662 times"> + </span><span class="branchCov" title="Branch 1 was taken 60038 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 29662 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">      89700 :         while (n &gt;= k_unit[format] &amp;&amp; index &lt; units_len[format]) {</span>
<span class="lineNum">     650 </span>                :<span class="lineCov">      29662 :                 n /= k_unit[format];</span>
<span class="lineNum">     651 </span>                :<span class="lineCov">      29662 :                 index++;</span>
<span class="lineNum">     652 </span>                :            :         }
<span class="lineNum">     653 </span>                :            : 
<span class="lineNum">     654 </span>                :<span class="lineCov">      60038 :         u = units[format][index];</span>
<span class="lineNum">     655 </span>                :            : 
<span class="lineNum">     656 </span>                :            :         /* Don't print zero latencies since they're invalid */
<span class="lineNum">     657 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 60038 times"> + </span>]:<span class="lineCov">      60038 :         if ((format == ZFS_NICENUM_TIME) &amp;&amp; (num == 0)) {</span>
<span class="lineNum">     658 </span>                :            :                 (void) snprintf(buf, buflen, &quot;-&quot;);
<span class="lineNum">     659 </span>[<span class="branchCov" title="Branch 0 was taken 19625 times"> + </span><span class="branchCov" title="Branch 1 was taken 40413 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 12136 times"> + </span><span class="branchCov" title="Branch 3 was taken 7489 times"> + </span>]:<span class="lineCov">      60038 :         } else if ((index == 0) || ((num %</span>
<span class="lineNum">     660 </span>                :<span class="lineCov">      19625 :             (uint64_t)powl(k_unit[format], index)) == 0)) {</span>
<span class="lineNum">     661 </span>                :            :                 /*
<span class="lineNum">     662 </span>                :            :                  * If this is an even multiple of the base, always display
<span class="lineNum">     663 </span>                :            :                  * without any decimal precision.
<span class="lineNum">     664 </span>                :            :                  */
<span class="lineNum">     665 </span>                :            :                 (void) snprintf(buf, buflen, &quot;%llu%s&quot;, (u_longlong_t)n, u);
<span class="lineNum">     666 </span>                :            : 
<span class="lineNum">     667 </span>                :            :         } else {
<span class="lineNum">     668 </span>                :            :                 /*
<span class="lineNum">     669 </span>                :            :                  * We want to choose a precision that reflects the best choice
<span class="lineNum">     670 </span>                :            :                  * for fitting in 5 characters.  This can get rather tricky when
<span class="lineNum">     671 </span>                :            :                  * we have numbers that are very close to an order of magnitude.
<span class="lineNum">     672 </span>                :            :                  * For example, when displaying 10239 (which is really 9.999K),
<span class="lineNum">     673 </span>                :            :                  * we want only a single place of precision for 10.0K.  We could
<span class="lineNum">     674 </span>                :            :                  * develop some complex heuristics for this, but it's much
<span class="lineNum">     675 </span>                :            :                  * easier just to try each combination in turn.
<span class="lineNum">     676 </span>                :            :                  */
<span class="lineNum">     677 </span>                :            :                 int i;
<span class="lineNum">     678 </span>        [<span class="branchCov" title="Branch 0 was taken 25599 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      85637 :                 for (i = 2; i &gt;= 0; i--) {</span>
<span class="lineNum">     679 </span>                :<span class="lineCov">      51198 :                         val = (double)num /</span>
<span class="lineNum">     680 </span>                :<span class="lineCov">      25599 :                             (uint64_t)powl(k_unit[format], index);</span>
<span class="lineNum">     681 </span>                :            : 
<span class="lineNum">     682 </span>                :            :                         /*
<span class="lineNum">     683 </span>                :            :                          * Don't print floating point values for time.  Note,
<span class="lineNum">     684 </span>                :            :                          * we use floor() instead of round() here, since
<span class="lineNum">     685 </span>                :            :                          * round can result in undesirable results.  For
<span class="lineNum">     686 </span>                :            :                          * example, if &quot;num&quot; is in the range of
<span class="lineNum">     687 </span>                :            :                          * 999500-999999, it will print out &quot;1000us&quot;.  This
<span class="lineNum">     688 </span>                :            :                          * doesn't happen if we use floor().
<span class="lineNum">     689 </span>                :            :                          */
<span class="lineNum">     690 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 25599 times"> + </span>]:<span class="lineCov">      25599 :                         if (format == ZFS_NICENUM_TIME) {</span>
<span class="lineNum">     691 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (snprintf(buf, buflen, &quot;%d%s&quot;,</span>
<span class="lineNum">     692 </span>                :<span class="lineNoCov">          0 :                                     (unsigned int) floor(val), u) &lt;= 5)</span>
<span class="lineNum">     693 </span>                :            :                                         break;
<span class="lineNum">     694 </span>                :            : 
<span class="lineNum">     695 </span>                :            :                         } else {
<span class="lineNum">     696 </span>        [<span class="branchCov" title="Branch 0 was taken 13463 times"> + </span><span class="branchCov" title="Branch 1 was taken 12136 times"> + </span>]:<span class="lineCov">      25599 :                                 if (snprintf(buf, buflen, &quot;%.*f%s&quot;, i,</span>
<span class="lineNum">     697 </span>                :            :                                     val, u) &lt;= 5)
<span class="lineNum">     698 </span>                :            :                                         break;
<span class="lineNum">     699 </span>                :            :                         }
<span class="lineNum">     700 </span>                :            :                 }
<span class="lineNum">     701 </span>                :            :         }
<span class="lineNum">     702 </span>                :            : }
<span class="lineNum">     703 </span>                :            : 
<span class="lineNum">     704 </span>                :            : /*
<span class="lineNum">     705 </span>                :            :  * Convert a number to an appropriately human-readable output.
<a name="706"><span class="lineNum">     706 </span>                :            :  */</a>
<span class="lineNum">     707 </span>                :            : void
<span class="lineNum">     708 </span>                :<span class="lineCov">      20817 : zfs_nicenum(uint64_t num, char *buf, size_t buflen)</span>
<span class="lineNum">     709 </span>                :            : {
<span class="lineNum">     710 </span>                :<span class="lineCov">      20817 :         zfs_nicenum_format(num, buf, buflen, ZFS_NICENUM_1024);</span>
<span class="lineNum">     711 </span>                :<span class="lineCov">      20817 : }</span>
<span class="lineNum">     712 </span>                :            : 
<span class="lineNum">     713 </span>                :            : /*
<span class="lineNum">     714 </span>                :            :  * Convert a time to an appropriately human-readable output.
<span class="lineNum">     715 </span>                :            :  * @num:        Time in nanoseconds
<a name="716"><span class="lineNum">     716 </span>                :            :  */</a>
<span class="lineNum">     717 </span>                :            : void
<span class="lineNum">     718 </span>                :<span class="lineNoCov">          0 : zfs_nicetime(uint64_t num, char *buf, size_t buflen)</span>
<span class="lineNum">     719 </span>                :            : {
<span class="lineNum">     720 </span>                :<span class="lineNoCov">          0 :         zfs_nicenum_format(num, buf, buflen, ZFS_NICENUM_TIME);</span>
<span class="lineNum">     721 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     722 </span>                :            : 
<span class="lineNum">     723 </span>                :            : /*
<span class="lineNum">     724 </span>                :            :  * Print out a raw number with correct column spacing
<a name="725"><span class="lineNum">     725 </span>                :            :  */</a>
<span class="lineNum">     726 </span>                :            : void
<span class="lineNum">     727 </span>                :<span class="lineNoCov">          0 : zfs_niceraw(uint64_t num, char *buf, size_t buflen)</span>
<span class="lineNum">     728 </span>                :            : {
<span class="lineNum">     729 </span>                :<span class="lineNoCov">          0 :         zfs_nicenum_format(num, buf, buflen, ZFS_NICENUM_RAW);</span>
<span class="lineNum">     730 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     731 </span>                :            : 
<span class="lineNum">     732 </span>                :            : /*
<span class="lineNum">     733 </span>                :            :  * Convert a number of bytes to an appropriately human-readable output.
<a name="734"><span class="lineNum">     734 </span>                :            :  */</a>
<span class="lineNum">     735 </span>                :            : void
<span class="lineNum">     736 </span>                :<span class="lineCov">      10209 : zfs_nicebytes(uint64_t num, char *buf, size_t buflen)</span>
<span class="lineNum">     737 </span>                :            : {
<span class="lineNum">     738 </span>                :<span class="lineCov">      10209 :         zfs_nicenum_format(num, buf, buflen, ZFS_NICENUM_BYTES);</span>
<span class="lineNum">     739 </span>                :<span class="lineCov">      10209 : }</span>
<a name="740"><span class="lineNum">     740 </span>                :            : </a>
<span class="lineNum">     741 </span>                :            : void
<span class="lineNum">     742 </span>                :<span class="lineCov">      57577 : libzfs_print_on_error(libzfs_handle_t *hdl, boolean_t printerr)</span>
<span class="lineNum">     743 </span>                :            : {
<span class="lineNum">     744 </span>                :<span class="lineCov">      57577 :         hdl-&gt;libzfs_printerr = printerr;</span>
<span class="lineNum">     745 </span>                :<span class="lineCov">      57577 : }</span>
<a name="746"><span class="lineNum">     746 </span>                :            : </a>
<span class="lineNum">     747 </span>                :            : static int
<span class="lineNum">     748 </span>                :<span class="lineCov">     117516 : libzfs_module_loaded(const char *module)</span>
<span class="lineNum">     749 </span>                :            : {
<span class="lineNum">     750 </span>                :<span class="lineCov">     117516 :         const char path_prefix[] = &quot;/sys/module/&quot;;</span>
<span class="lineNum">     751 </span>                :            :         char path[256];
<span class="lineNum">     752 </span>                :            : 
<span class="lineNum">     753 </span>                :<span class="lineCov">     117516 :         memcpy(path, path_prefix, sizeof (path_prefix) - 1);</span>
<span class="lineNum">     754 </span>                :<span class="lineCov">     235032 :         strcpy(path + sizeof (path_prefix) - 1, module);</span>
<span class="lineNum">     755 </span>                :            : 
<span class="lineNum">     756 </span>                :<span class="lineCov">     117516 :         return (access(path, F_OK) == 0);</span>
<span class="lineNum">     757 </span>                :            : }
<span class="lineNum">     758 </span>                :            : 
<span class="lineNum">     759 </span>                :            : 
<span class="lineNum">     760 </span>                :            : /*
<span class="lineNum">     761 </span>                :            :  * Read lines from an open file descriptor and store them in an array of
<span class="lineNum">     762 </span>                :            :  * strings until EOF.  lines[] will be allocated and populated with all the
<span class="lineNum">     763 </span>                :            :  * lines read.  All newlines are replaced with NULL terminators for
<span class="lineNum">     764 </span>                :            :  * convenience.  lines[] must be freed after use with libzfs_free_str_array().
<span class="lineNum">     765 </span>                :            :  *
<span class="lineNum">     766 </span>                :            :  * Returns the number of lines read.
<a name="767"><span class="lineNum">     767 </span>                :            :  */</a>
<span class="lineNum">     768 </span>                :            : static int
<span class="lineNum">     769 </span>                :<span class="lineNoCov">          0 : libzfs_read_stdout_from_fd(int fd, char **lines[])</span>
<span class="lineNum">     770 </span>                :            : {
<span class="lineNum">     771 </span>                :            : 
<span class="lineNum">     772 </span>                :            :         FILE *fp;
<span class="lineNum">     773 </span>                :<span class="lineNoCov">          0 :         int lines_cnt = 0;</span>
<span class="lineNum">     774 </span>                :<span class="lineNoCov">          0 :         size_t len = 0;</span>
<span class="lineNum">     775 </span>                :<span class="lineNoCov">          0 :         char *line = NULL;</span>
<span class="lineNum">     776 </span>                :<span class="lineNoCov">          0 :         char **tmp_lines = NULL, **tmp;</span>
<span class="lineNum">     777 </span>                :<span class="lineNoCov">          0 :         char *nl = NULL;</span>
<span class="lineNum">     778 </span>                :            :         int rc;
<span class="lineNum">     779 </span>                :            : 
<span class="lineNum">     780 </span>                :<span class="lineNoCov">          0 :         fp = fdopen(fd, &quot;r&quot;);</span>
<span class="lineNum">     781 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (fp == NULL)</span>
<span class="lineNum">     782 </span>                :            :                 return (0);
<span class="lineNum">     783 </span>                :            :         while (1) {
<span class="lineNum">     784 </span>                :<span class="lineNoCov">          0 :                 rc = getline(&amp;line, &amp;len, fp);</span>
<span class="lineNum">     785 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (rc == -1)</span>
<span class="lineNum">     786 </span>                :            :                         break;
<span class="lineNum">     787 </span>                :            : 
<span class="lineNum">     788 </span>                :<span class="lineNoCov">          0 :                 tmp = realloc(tmp_lines, sizeof (*tmp_lines) * (lines_cnt + 1));</span>
<span class="lineNum">     789 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (tmp == NULL) {</span>
<span class="lineNum">     790 </span>                :            :                         /* Return the lines we were able to process */
<span class="lineNum">     791 </span>                :            :                         break;
<span class="lineNum">     792 </span>                :            :                 }
<span class="lineNum">     793 </span>                :<span class="lineNoCov">          0 :                 tmp_lines = tmp;</span>
<span class="lineNum">     794 </span>                :            : 
<span class="lineNum">     795 </span>                :            :                 /* Terminate newlines */
<span class="lineNum">     796 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if ((nl = strchr(line, '\n')) != NULL)</span>
<span class="lineNum">     797 </span>                :<span class="lineNoCov">          0 :                         *nl = '\0';</span>
<span class="lineNum">     798 </span>                :<span class="lineNoCov">          0 :                 tmp_lines[lines_cnt] = line;</span>
<span class="lineNum">     799 </span>                :<span class="lineNoCov">          0 :                 lines_cnt++;</span>
<span class="lineNum">     800 </span>                :<span class="lineNoCov">          0 :                 line = NULL;</span>
<span class="lineNum">     801 </span>                :            :         }
<span class="lineNum">     802 </span>                :<span class="lineNoCov">          0 :         fclose(fp);</span>
<span class="lineNum">     803 </span>                :<span class="lineNoCov">          0 :         *lines = tmp_lines;</span>
<span class="lineNum">     804 </span>                :<span class="lineNoCov">          0 :         return (lines_cnt);</span>
<span class="lineNum">     805 </span>                :            : }
<a name="806"><span class="lineNum">     806 </span>                :            : </a>
<span class="lineNum">     807 </span>                :            : static int
<span class="lineNum">     808 </span>                :<span class="lineCov">      20561 : libzfs_run_process_impl(const char *path, char *argv[], char *env[], int flags,</span>
<span class="lineNum">     809 </span>                :            :     char **lines[], int *lines_cnt)
<span class="lineNum">     810 </span>                :            : {
<span class="lineNum">     811 </span>                :            :         pid_t pid;
<span class="lineNum">     812 </span>                :            :         int error, devnull_fd;
<span class="lineNum">     813 </span>                :            :         int link[2];
<span class="lineNum">     814 </span>                :            : 
<span class="lineNum">     815 </span>                :            :         /*
<span class="lineNum">     816 </span>                :            :          * Setup a pipe between our child and parent process if we're
<span class="lineNum">     817 </span>                :            :          * reading stdout.
<span class="lineNum">     818 </span>                :            :          */
<span class="lineNum">     819 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 10286 times"> + </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineCov">      10286 :         if ((lines != NULL) &amp;&amp; pipe(link) == -1)</span>
<span class="lineNum">     820 </span>                :            :                 return (-ESTRPIPE);
<span class="lineNum">     821 </span>                :            : 
<span class="lineNum">     822 </span>                :<span class="lineCov">      20561 :         pid = vfork();</span>
<span class="lineNum">     823 </span>        [<span class="branchCov" title="Branch 0 was taken 10286 times"> + </span><span class="branchCov" title="Branch 1 was taken 10275 times"> + </span>]:<span class="lineCov">      20561 :         if (pid == 0) {</span>
<span class="lineNum">     824 </span>                :            :                 /* Child process */
<span class="lineNum">     825 </span>                :<span class="lineCov">      10286 :                 devnull_fd = open(&quot;/dev/null&quot;, O_WRONLY);</span>
<span class="lineNum">     826 </span>                :            : 
<span class="lineNum">     827 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 10286 times"> + </span>]:<span class="lineCov">      10286 :                 if (devnull_fd &lt; 0)</span>
<span class="lineNum">     828 </span>                :<span class="lineNoCov">          0 :                         _exit(-1);</span>
<span class="lineNum">     829 </span>                :            : 
<span class="lineNum">     830 </span>[<span class="branchCov" title="Branch 0 was taken 459 times"> + </span><span class="branchCov" title="Branch 1 was taken 9827 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 459 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">      10286 :                 if (!(flags &amp; STDOUT_VERBOSE) &amp;&amp; (lines == NULL))</span>
<span class="lineNum">     831 </span>                :<span class="lineCov">        459 :                         (void) dup2(devnull_fd, STDOUT_FILENO);</span>
<span class="lineNum">     832 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 9827 times"> + </span>]:<span class="lineCov">       9827 :                 else if (lines != NULL) {</span>
<span class="lineNum">     833 </span>                :            :                         /* Save the output to lines[] */
<span class="lineNum">     834 </span>                :<span class="lineNoCov">          0 :                         dup2(link[1], STDOUT_FILENO);</span>
<span class="lineNum">     835 </span>                :<span class="lineNoCov">          0 :                         close(link[0]);</span>
<span class="lineNum">     836 </span>                :<span class="lineNoCov">          0 :                         close(link[1]);</span>
<span class="lineNum">     837 </span>                :            :                 }
<span class="lineNum">     838 </span>                :            : 
<span class="lineNum">     839 </span>        [<span class="branchCov" title="Branch 0 was taken 459 times"> + </span><span class="branchCov" title="Branch 1 was taken 9827 times"> + </span>]:<span class="lineCov">      10286 :                 if (!(flags &amp; STDERR_VERBOSE))</span>
<span class="lineNum">     840 </span>                :<span class="lineCov">        459 :                         (void) dup2(devnull_fd, STDERR_FILENO);</span>
<span class="lineNum">     841 </span>                :            : 
<span class="lineNum">     842 </span>                :<span class="lineCov">      10286 :                 close(devnull_fd);</span>
<span class="lineNum">     843 </span>                :            : 
<span class="lineNum">     844 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (flags &amp; NO_DEFAULT_PATH) {</span>
<span class="lineNum">     845 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (env == NULL)</span>
<span class="lineNum">     846 </span>                :<span class="lineNoCov">          0 :                                 execv(path, argv);</span>
<span class="lineNum">     847 </span>                :            :                         else
<span class="lineNum">     848 </span>                :<span class="lineNoCov">          0 :                                 execve(path, argv, env);</span>
<span class="lineNum">     849 </span>                :            :                 } else {
<span class="lineNum">     850 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (env == NULL)</span>
<span class="lineNum">     851 </span>                :<span class="lineNoCov">          0 :                                 execvp(path, argv);</span>
<span class="lineNum">     852 </span>                :            :                         else
<span class="lineNum">     853 </span>                :<span class="lineNoCov">          0 :                                 execvpe(path, argv, env);</span>
<span class="lineNum">     854 </span>                :            :                 }
<span class="lineNum">     855 </span>                :            : 
<span class="lineNum">     856 </span>                :<span class="lineNoCov">          0 :                 _exit(-1);</span>
<span class="lineNum">     857 </span>        [<span class="branchCov" title="Branch 0 was taken 10275 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      10275 :         } else if (pid &gt; 0) {</span>
<span class="lineNum">     858 </span>                :            :                 /* Parent process */
<span class="lineNum">     859 </span>                :            :                 int status;
<span class="lineNum">     860 </span>                :            : 
<span class="lineNum">     861 </span>  [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 10275 times"> + </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineCov">      10275 :                 while ((error = waitpid(pid, &amp;status, 0)) == -1 &amp;&amp;</span>
<span class="lineNum">     862 </span>                :<span class="lineNoCov">          0 :                     errno == EINTR) { }</span>
<span class="lineNum">     863 </span>[<span class="branchCov" title="Branch 0 was taken 10275 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 10275 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">      10275 :                 if (error &lt; 0 || !WIFEXITED(status))</span>
<span class="lineNum">     864 </span>                :            :                         return (-1);
<span class="lineNum">     865 </span>                :            : 
<span class="lineNum">     866 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 10275 times"> + </span>]:<span class="lineCov">      10275 :                 if (lines != NULL) {</span>
<span class="lineNum">     867 </span>                :<span class="lineNoCov">          0 :                         close(link[1]);</span>
<span class="lineNum">     868 </span>                :<span class="lineNoCov">          0 :                         *lines_cnt = libzfs_read_stdout_from_fd(link[0], lines);</span>
<span class="lineNum">     869 </span>                :            :                 }
<span class="lineNum">     870 </span>                :<span class="lineCov">      10275 :                 return (WEXITSTATUS(status));</span>
<span class="lineNum">     871 </span>                :            :         }
<span class="lineNum">     872 </span>                :            : 
<span class="lineNum">     873 </span>                :            :         return (-1);
<span class="lineNum">     874 </span>                :            : }
<a name="875"><span class="lineNum">     875 </span>                :            : </a>
<span class="lineNum">     876 </span>                :            : int
<span class="lineNum">     877 </span>                :<span class="lineCov">      10286 : libzfs_run_process(const char *path, char *argv[], int flags)</span>
<span class="lineNum">     878 </span>                :            : {
<span class="lineNum">     879 </span>                :<span class="lineCov">      10286 :         return (libzfs_run_process_impl(path, argv, NULL, flags, NULL, NULL));</span>
<span class="lineNum">     880 </span>                :            : }
<span class="lineNum">     881 </span>                :            : 
<span class="lineNum">     882 </span>                :            : /*
<span class="lineNum">     883 </span>                :            :  * Run a command and store its stdout lines in an array of strings (lines[]).
<span class="lineNum">     884 </span>                :            :  * lines[] is allocated and populated for you, and the number of lines is set in
<span class="lineNum">     885 </span>                :            :  * lines_cnt.  lines[] must be freed after use with libzfs_free_str_array().
<span class="lineNum">     886 </span>                :            :  * All newlines (\n) in lines[] are terminated for convenience.
<a name="887"><span class="lineNum">     887 </span>                :            :  */</a>
<span class="lineNum">     888 </span>                :            : int
<span class="lineNum">     889 </span>                :<span class="lineNoCov">          0 : libzfs_run_process_get_stdout(const char *path, char *argv[], char *env[],</span>
<span class="lineNum">     890 </span>                :            :     char **lines[], int *lines_cnt)
<span class="lineNum">     891 </span>                :            : {
<span class="lineNum">     892 </span>                :<span class="lineNoCov">          0 :         return (libzfs_run_process_impl(path, argv, env, 0, lines, lines_cnt));</span>
<span class="lineNum">     893 </span>                :            : }
<span class="lineNum">     894 </span>                :            : 
<span class="lineNum">     895 </span>                :            : /*
<span class="lineNum">     896 </span>                :            :  * Same as libzfs_run_process_get_stdout(), but run without $PATH set.  This
<span class="lineNum">     897 </span>                :            :  * means that *path needs to be the full path to the executable.
<a name="898"><span class="lineNum">     898 </span>                :            :  */</a>
<span class="lineNum">     899 </span>                :            : int
<span class="lineNum">     900 </span>                :<span class="lineNoCov">          0 : libzfs_run_process_get_stdout_nopath(const char *path, char *argv[],</span>
<span class="lineNum">     901 </span>                :            :     char *env[], char **lines[], int *lines_cnt)
<span class="lineNum">     902 </span>                :            : {
<span class="lineNum">     903 </span>                :<span class="lineNoCov">          0 :         return (libzfs_run_process_impl(path, argv, env, NO_DEFAULT_PATH,</span>
<span class="lineNum">     904 </span>                :            :             lines, lines_cnt));
<span class="lineNum">     905 </span>                :            : }
<span class="lineNum">     906 </span>                :            : 
<span class="lineNum">     907 </span>                :            : /*
<span class="lineNum">     908 </span>                :            :  * Free an array of strings.  Free both the strings contained in the array and
<span class="lineNum">     909 </span>                :            :  * the array itself.
<a name="910"><span class="lineNum">     910 </span>                :            :  */</a>
<span class="lineNum">     911 </span>                :            : void
<span class="lineNum">     912 </span>                :<span class="lineNoCov">          0 : libzfs_free_str_array(char **strs, int count)</span>
<span class="lineNum">     913 </span>                :            : {
<span class="lineNum">     914 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         while (--count &gt;= 0)</span>
<span class="lineNum">     915 </span>                :<span class="lineNoCov">          0 :                 free(strs[count]);</span>
<span class="lineNum">     916 </span>                :            : 
<span class="lineNum">     917 </span>                :<span class="lineNoCov">          0 :         free(strs);</span>
<span class="lineNum">     918 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     919 </span>                :            : 
<span class="lineNum">     920 </span>                :            : /*
<span class="lineNum">     921 </span>                :            :  * Returns 1 if environment variable is set to &quot;YES&quot;, &quot;yes&quot;, &quot;ON&quot;, &quot;on&quot;, or
<span class="lineNum">     922 </span>                :            :  * a non-zero number.
<span class="lineNum">     923 </span>                :            :  *
<span class="lineNum">     924 </span>                :            :  * Returns 0 otherwise.
<a name="925"><span class="lineNum">     925 </span>                :            :  */</a>
<span class="lineNum">     926 </span>                :            : int
<span class="lineNum">     927 </span>                :<span class="lineNoCov">          0 : libzfs_envvar_is_set(char *envvar)</span>
<span class="lineNum">     928 </span>                :            : {
<span class="lineNum">     929 </span>                :<span class="lineNoCov">          0 :         char *env = getenv(envvar);</span>
<span class="lineNum">     930 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (env &amp;&amp; (strtoul(env, NULL, 0) &gt; 0 ||</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 5 was not executed"> # </span><span class="branchNoExec" title="Branch 6 was not executed"> # </span>]
<span class="lineNum">     931 </span>[<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :             (!strncasecmp(env, &quot;YES&quot;, 3) &amp;&amp; strnlen(env, 4) == 3) ||</span>
<span class="lineNum">     932 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :             (!strncasecmp(env, &quot;ON&quot;, 2) &amp;&amp; strnlen(env, 3) == 2)))</span>
<span class="lineNum">     933 </span>                :            :                 return (1);
<span class="lineNum">     934 </span>                :            : 
<span class="lineNum">     935 </span>                :            :         return (0);
<span class="lineNum">     936 </span>                :            : }
<span class="lineNum">     937 </span>                :            : 
<span class="lineNum">     938 </span>                :            : /*
<span class="lineNum">     939 </span>                :            :  * Verify the required ZFS_DEV device is available and optionally attempt
<span class="lineNum">     940 </span>                :            :  * to load the ZFS modules.  Under normal circumstances the modules
<span class="lineNum">     941 </span>                :            :  * should already have been loaded by some external mechanism.
<span class="lineNum">     942 </span>                :            :  *
<span class="lineNum">     943 </span>                :            :  * Environment variables:
<span class="lineNum">     944 </span>                :            :  * - ZFS_MODULE_LOADING=&quot;YES|yes|ON|on&quot; - Attempt to load modules.
<span class="lineNum">     945 </span>                :            :  * - ZFS_MODULE_TIMEOUT=&quot;&lt;seconds&gt;&quot;     - Seconds to wait for ZFS_DEV
<a name="946"><span class="lineNum">     946 </span>                :            :  */</a>
<span class="lineNum">     947 </span>                :            : static int
<span class="lineNum">     948 </span>                :<span class="lineCov">      58758 : libzfs_load_module(const char *module)</span>
<span class="lineNum">     949 </span>                :            : {
<span class="lineNum">     950 </span>                :<span class="lineCov">      58758 :         char *argv[4] = {&quot;/sbin/modprobe&quot;, &quot;-q&quot;, (char *)module, (char *)0};</span>
<span class="lineNum">     951 </span>                :            :         char *load_str, *timeout_str;
<span class="lineNum">     952 </span>                :<span class="lineCov">      58758 :         long timeout = 10; /* seconds */</span>
<span class="lineNum">     953 </span>                :<span class="lineCov">      58758 :         long busy_timeout = 10; /* milliseconds */</span>
<span class="lineNum">     954 </span>                :<span class="lineCov">      58758 :         int load = 0, fd;</span>
<span class="lineNum">     955 </span>                :            :         hrtime_t start;
<span class="lineNum">     956 </span>                :            : 
<span class="lineNum">     957 </span>                :            :         /* Optionally request module loading */
<span class="lineNum">     958 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 58758 times"> + </span>]:<span class="lineCov">      58758 :         if (!libzfs_module_loaded(module)) {</span>
<span class="lineNum">     959 </span>                :<span class="lineNoCov">          0 :                 load_str = getenv(&quot;ZFS_MODULE_LOADING&quot;);</span>
<span class="lineNum">     960 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (load_str) {</span>
<span class="lineNum">     961 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (!strncasecmp(load_str, &quot;YES&quot;, strlen(&quot;YES&quot;)) ||</span>
<span class="lineNum">     962 </span>                :<span class="lineNoCov">          0 :                             !strncasecmp(load_str, &quot;ON&quot;, strlen(&quot;ON&quot;)))</span>
<span class="lineNum">     963 </span>                :            :                                 load = 1;
<span class="lineNum">     964 </span>                :            :                         else
<span class="lineNum">     965 </span>                :<span class="lineNoCov">          0 :                                 load = 0;</span>
<span class="lineNum">     966 </span>                :            :                 }
<span class="lineNum">     967 </span>                :            : 
<span class="lineNum">     968 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (load &amp;&amp; libzfs_run_process(&quot;/sbin/modprobe&quot;, argv, 0))</span>
<span class="lineNum">     969 </span>                :            :                         return (ENOEXEC);
<span class="lineNum">     970 </span>                :            :         }
<span class="lineNum">     971 </span>                :            : 
<span class="lineNum">     972 </span>                :            :         /* Module loading is synchronous it must be available */
<span class="lineNum">     973 </span>        [<span class="branchCov" title="Branch 1 was taken 58758 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      58758 :         if (!libzfs_module_loaded(module))</span>
<span class="lineNum">     974 </span>                :            :                 return (ENXIO);
<span class="lineNum">     975 </span>                :            : 
<span class="lineNum">     976 </span>                :            :         /*
<span class="lineNum">     977 </span>                :            :          * Device creation by udev is asynchronous and waiting may be
<span class="lineNum">     978 </span>                :            :          * required.  Busy wait for 10ms and then fall back to polling every
<span class="lineNum">     979 </span>                :            :          * 10ms for the allowed timeout (default 10s, max 10m).  This is
<span class="lineNum">     980 </span>                :            :          * done to optimize for the common case where the device is
<span class="lineNum">     981 </span>                :            :          * immediately available and to avoid penalizing the possible
<span class="lineNum">     982 </span>                :            :          * case where udev is slow or unable to create the device.
<span class="lineNum">     983 </span>                :            :          */
<span class="lineNum">     984 </span>                :<span class="lineCov">      58758 :         timeout_str = getenv(&quot;ZFS_MODULE_TIMEOUT&quot;);</span>
<span class="lineNum">     985 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 58758 times"> + </span>]:<span class="lineCov">      58758 :         if (timeout_str) {</span>
<span class="lineNum">     986 </span>                :<span class="lineNoCov">          0 :                 timeout = strtol(timeout_str, NULL, 0);</span>
<span class="lineNum">     987 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 timeout = MAX(MIN(timeout, (10 * 60)), 0); /* 0 &lt;= N &lt;= 600 */</span>
<span class="lineNum">     988 </span>                :            :         }
<span class="lineNum">     989 </span>                :            : 
<span class="lineNum">     990 </span>                :<span class="lineCov">      58758 :         start = gethrtime();</span>
<span class="lineNum">     991 </span>                :            :         do {
<span class="lineNum">     992 </span>                :<span class="lineCov">      62775 :                 fd = open(ZFS_DEV, O_RDWR);</span>
<span class="lineNum">     993 </span>        [<span class="branchCov" title="Branch 0 was taken 58478 times"> + </span><span class="branchCov" title="Branch 1 was taken 4297 times"> + </span>]:<span class="lineCov">      62775 :                 if (fd &gt;= 0) {</span>
<span class="lineNum">     994 </span>                :<span class="lineCov">      58478 :                         (void) close(fd);</span>
<span class="lineNum">     995 </span>                :<span class="lineCov">      58478 :                         return (0);</span>
<span class="lineNum">     996 </span>        [<span class="branchCov" title="Branch 1 was taken 4020 times"> + </span><span class="branchCov" title="Branch 2 was taken 277 times"> + </span>]:<span class="lineCov">       4297 :                 } else if (errno != ENOENT) {</span>
<span class="lineNum">     997 </span>                :            :                         return (errno);
<span class="lineNum">     998 </span>        [<span class="branchCov" title="Branch 1 was taken 1097 times"> + </span><span class="branchCov" title="Branch 2 was taken 2923 times"> + </span>]:<span class="lineCov">       4020 :                 } else if (NSEC2MSEC(gethrtime() - start) &lt; busy_timeout) {</span>
<span class="lineNum">     999 </span>                :<span class="lineCov">       1097 :                         sched_yield();</span>
<span class="lineNum">    1000 </span>                :            :                 } else {
<span class="lineNum">    1001 </span>                :<span class="lineCov">       2923 :                         usleep(10 * MILLISEC);</span>
<span class="lineNum">    1002 </span>                :            :                 }
<span class="lineNum">    1003 </span>        [<span class="branchCov" title="Branch 1 was taken 4017 times"> + </span><span class="branchCov" title="Branch 2 was taken 3 times"> + </span>]:<span class="lineCov">       4020 :         } while (NSEC2MSEC(gethrtime() - start) &lt; (timeout * MILLISEC));</span>
<span class="lineNum">    1004 </span>                :            : 
<span class="lineNum">    1005 </span>                :            :         return (ENOENT);
<span class="lineNum">    1006 </span>                :            : }
<a name="1007"><span class="lineNum">    1007 </span>                :            : </a>
<span class="lineNum">    1008 </span>                :            : libzfs_handle_t *
<span class="lineNum">    1009 </span>                :<span class="lineCov">      58758 : libzfs_init(void)</span>
<span class="lineNum">    1010 </span>                :            : {
<span class="lineNum">    1011 </span>                :            :         libzfs_handle_t *hdl;
<span class="lineNum">    1012 </span>                :            :         int error;
<span class="lineNum">    1013 </span>                :            : 
<span class="lineNum">    1014 </span>                :<span class="lineCov">      58758 :         error = libzfs_load_module(ZFS_DRIVER);</span>
<span class="lineNum">    1015 </span>        [<span class="branchCov" title="Branch 0 was taken 280 times"> + </span><span class="branchCov" title="Branch 1 was taken 58478 times"> + </span>]:<span class="lineCov">      58758 :         if (error) {</span>
<span class="lineNum">    1016 </span>                :<span class="lineCov">        280 :                 errno = error;</span>
<span class="lineNum">    1017 </span>                :<span class="lineCov">        280 :                 return (NULL);</span>
<span class="lineNum">    1018 </span>                :            :         }
<span class="lineNum">    1019 </span>                :            : 
<span class="lineNum">    1020 </span>        [<span class="branchCov" title="Branch 0 was taken 58478 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      58478 :         if ((hdl = calloc(1, sizeof (libzfs_handle_t))) == NULL) {</span>
<span class="lineNum">    1021 </span>                :            :                 return (NULL);
<span class="lineNum">    1022 </span>                :            :         }
<span class="lineNum">    1023 </span>                :            : 
<span class="lineNum">    1024 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 58478 times"> + </span>]:<span class="lineCov">      58478 :         if ((hdl-&gt;libzfs_fd = open(ZFS_DEV, O_RDWR)) &lt; 0) {</span>
<span class="lineNum">    1025 </span>                :<span class="lineNoCov">          0 :                 free(hdl);</span>
<span class="lineNum">    1026 </span>                :<span class="lineNoCov">          0 :                 return (NULL);</span>
<span class="lineNum">    1027 </span>                :            :         }
<span class="lineNum">    1028 </span>                :            : 
<span class="lineNum">    1029 </span>                :            : #ifdef HAVE_SETMNTENT
<span class="lineNum">    1030 </span>                :            :         if ((hdl-&gt;libzfs_mnttab = setmntent(MNTTAB, &quot;r&quot;)) == NULL) {
<span class="lineNum">    1031 </span>                :            : #else
<span class="lineNum">    1032 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 58478 times"> + </span>]:<span class="lineCov">      58478 :         if ((hdl-&gt;libzfs_mnttab = fopen(MNTTAB, &quot;r&quot;)) == NULL) {</span>
<span class="lineNum">    1033 </span>                :            : #endif
<span class="lineNum">    1034 </span>                :<span class="lineNoCov">          0 :                 (void) close(hdl-&gt;libzfs_fd);</span>
<span class="lineNum">    1035 </span>                :<span class="lineNoCov">          0 :                 free(hdl);</span>
<span class="lineNum">    1036 </span>                :<span class="lineNoCov">          0 :                 return (NULL);</span>
<span class="lineNum">    1037 </span>                :            :         }
<span class="lineNum">    1038 </span>                :            : 
<span class="lineNum">    1039 </span>                :<span class="lineCov">      58478 :         hdl-&gt;libzfs_sharetab = fopen(ZFS_SHARETAB, &quot;r&quot;);</span>
<span class="lineNum">    1040 </span>                :            : 
<span class="lineNum">    1041 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 58478 times"> + </span>]:<span class="lineCov">      58478 :         if (libzfs_core_init() != 0) {</span>
<span class="lineNum">    1042 </span>                :<span class="lineNoCov">          0 :                 (void) close(hdl-&gt;libzfs_fd);</span>
<span class="lineNum">    1043 </span>                :<span class="lineNoCov">          0 :                 (void) fclose(hdl-&gt;libzfs_mnttab);</span>
<span class="lineNum">    1044 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (hdl-&gt;libzfs_sharetab)</span>
<span class="lineNum">    1045 </span>                :<span class="lineNoCov">          0 :                         (void) fclose(hdl-&gt;libzfs_sharetab);</span>
<span class="lineNum">    1046 </span>                :<span class="lineNoCov">          0 :                 free(hdl);</span>
<span class="lineNum">    1047 </span>                :<span class="lineNoCov">          0 :                 return (NULL);</span>
<span class="lineNum">    1048 </span>                :            :         }
<span class="lineNum">    1049 </span>                :            : 
<span class="lineNum">    1050 </span>                :<span class="lineCov">      58478 :         zfs_prop_init();</span>
<span class="lineNum">    1051 </span>                :<span class="lineCov">      58478 :         zpool_prop_init();</span>
<span class="lineNum">    1052 </span>                :<span class="lineCov">      58478 :         zpool_feature_init();</span>
<span class="lineNum">    1053 </span>                :<span class="lineCov">      58478 :         libzfs_mnttab_init(hdl);</span>
<span class="lineNum">    1054 </span>                :<span class="lineCov">      58478 :         fletcher_4_init();</span>
<span class="lineNum">    1055 </span>                :            : 
<span class="lineNum">    1056 </span>                :<span class="lineCov">      58478 :         return (hdl);</span>
<span class="lineNum">    1057 </span>                :            : }
<a name="1058"><span class="lineNum">    1058 </span>                :            : </a>
<span class="lineNum">    1059 </span>                :            : void
<span class="lineNum">    1060 </span>                :<span class="lineCov">      54560 : libzfs_fini(libzfs_handle_t *hdl)</span>
<span class="lineNum">    1061 </span>                :            : {
<span class="lineNum">    1062 </span>                :<span class="lineCov">      54560 :         (void) close(hdl-&gt;libzfs_fd);</span>
<span class="lineNum">    1063 </span>        [<span class="branchCov" title="Branch 0 was taken 54560 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      54560 :         if (hdl-&gt;libzfs_mnttab)</span>
<span class="lineNum">    1064 </span>                :            : #ifdef HAVE_SETMNTENT
<span class="lineNum">    1065 </span>                :            :                 (void) endmntent(hdl-&gt;libzfs_mnttab);
<span class="lineNum">    1066 </span>                :            : #else
<span class="lineNum">    1067 </span>                :<span class="lineCov">      54560 :                 (void) fclose(hdl-&gt;libzfs_mnttab);</span>
<span class="lineNum">    1068 </span>                :            : #endif
<span class="lineNum">    1069 </span>        [<span class="branchCov" title="Branch 0 was taken 52306 times"> + </span><span class="branchCov" title="Branch 1 was taken 2254 times"> + </span>]:<span class="lineCov">      54560 :         if (hdl-&gt;libzfs_sharetab)</span>
<span class="lineNum">    1070 </span>                :<span class="lineCov">      52306 :                 (void) fclose(hdl-&gt;libzfs_sharetab);</span>
<span class="lineNum">    1071 </span>                :<span class="lineCov">      54560 :         zfs_uninit_libshare(hdl);</span>
<span class="lineNum">    1072 </span>                :<span class="lineCov">      54560 :         zpool_free_handles(hdl);</span>
<span class="lineNum">    1073 </span>                :<span class="lineCov">      54560 :         namespace_clear(hdl);</span>
<span class="lineNum">    1074 </span>                :<span class="lineCov">      54560 :         libzfs_mnttab_fini(hdl);</span>
<span class="lineNum">    1075 </span>                :<span class="lineCov">      54560 :         libzfs_core_fini();</span>
<span class="lineNum">    1076 </span>                :<span class="lineCov">      54560 :         fletcher_4_fini();</span>
<span class="lineNum">    1077 </span>                :<span class="lineCov">      54560 :         free(hdl);</span>
<span class="lineNum">    1078 </span>                :<span class="lineCov">      54560 : }</span>
<a name="1079"><span class="lineNum">    1079 </span>                :            : </a>
<span class="lineNum">    1080 </span>                :            : libzfs_handle_t *
<span class="lineNum">    1081 </span>                :<span class="lineCov">       1139 : zpool_get_handle(zpool_handle_t *zhp)</span>
<span class="lineNum">    1082 </span>                :            : {
<span class="lineNum">    1083 </span>                :<span class="lineCov">       1139 :         return (zhp-&gt;zpool_hdl);</span>
<span class="lineNum">    1084 </span>                :            : }
<a name="1085"><span class="lineNum">    1085 </span>                :            : </a>
<span class="lineNum">    1086 </span>                :            : libzfs_handle_t *
<span class="lineNum">    1087 </span>                :<span class="lineCov">        495 : zfs_get_handle(zfs_handle_t *zhp)</span>
<span class="lineNum">    1088 </span>                :            : {
<span class="lineNum">    1089 </span>                :<span class="lineCov">        495 :         return (zhp-&gt;zfs_hdl);</span>
<span class="lineNum">    1090 </span>                :            : }
<a name="1091"><span class="lineNum">    1091 </span>                :            : </a>
<span class="lineNum">    1092 </span>                :            : zpool_handle_t *
<span class="lineNum">    1093 </span>                :<span class="lineCov">        274 : zfs_get_pool_handle(const zfs_handle_t *zhp)</span>
<span class="lineNum">    1094 </span>                :            : {
<span class="lineNum">    1095 </span>                :<span class="lineCov">        274 :         return (zhp-&gt;zpool_hdl);</span>
<span class="lineNum">    1096 </span>                :            : }
<span class="lineNum">    1097 </span>                :            : 
<span class="lineNum">    1098 </span>                :            : /*
<span class="lineNum">    1099 </span>                :            :  * Given a name, determine whether or not it's a valid path
<span class="lineNum">    1100 </span>                :            :  * (starts with '/' or &quot;./&quot;).  If so, walk the mnttab trying
<span class="lineNum">    1101 </span>                :            :  * to match the device number.  If not, treat the path as an
<span class="lineNum">    1102 </span>                :            :  * fs/vol/snap/bkmark name.
<a name="1103"><span class="lineNum">    1103 </span>                :            :  */</a>
<span class="lineNum">    1104 </span>                :            : zfs_handle_t *
<span class="lineNum">    1105 </span>                :<span class="lineCov">      23298 : zfs_path_to_zhandle(libzfs_handle_t *hdl, char *path, zfs_type_t argtype)</span>
<span class="lineNum">    1106 </span>                :            : {
<span class="lineNum">    1107 </span>                :            :         struct stat64 statbuf;
<span class="lineNum">    1108 </span>                :            :         struct extmnttab entry;
<span class="lineNum">    1109 </span>                :            :         int ret;
<span class="lineNum">    1110 </span>                :            : 
<span class="lineNum">    1111 </span>[<span class="branchCov" title="Branch 0 was taken 23282 times"> + </span><span class="branchCov" title="Branch 1 was taken 16 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 23282 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">      23298 :         if (path[0] != '/' &amp;&amp; strncmp(path, &quot;./&quot;, strlen(&quot;./&quot;)) != 0) {</span>
<span class="lineNum">    1112 </span>                :            :                 /*
<span class="lineNum">    1113 </span>                :            :                  * It's not a valid path, assume it's a name of type 'argtype'.
<span class="lineNum">    1114 </span>                :            :                  */
<span class="lineNum">    1115 </span>                :<span class="lineCov">      23282 :                 return (zfs_open(hdl, path, argtype));</span>
<span class="lineNum">    1116 </span>                :            :         }
<span class="lineNum">    1117 </span>                :            : 
<span class="lineNum">    1118 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchCov" title="Branch 2 was taken 9 times"> + </span>]:<span class="lineCov">         16 :         if (stat64(path, &amp;statbuf) != 0) {</span>
<span class="lineNum">    1119 </span>                :<span class="lineCov">          7 :                 (void) fprintf(stderr, &quot;%s: %s\n&quot;, path, strerror(errno));</span>
<span class="lineNum">    1120 </span>                :<span class="lineCov">          7 :                 return (NULL);</span>
<span class="lineNum">    1121 </span>                :            :         }
<span class="lineNum">    1122 </span>                :            : 
<span class="lineNum">    1123 </span>                :            :         /* Reopen MNTTAB to prevent reading stale data from open file */
<span class="lineNum">    1124 </span>        [<span class="branchCov" title="Branch 1 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          9 :         if (freopen(MNTTAB, &quot;r&quot;, hdl-&gt;libzfs_mnttab) == NULL)</span>
<span class="lineNum">    1125 </span>                :            :                 return (NULL);
<span class="lineNum">    1126 </span>                :            : 
<span class="lineNum">    1127 </span>        [<span class="branchCov" title="Branch 1 was taken 306 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">        306 :         while ((ret = getextmntent(hdl-&gt;libzfs_mnttab, &amp;entry, 0)) == 0) {</span>
<span class="lineNum">    1128 </span>        [<span class="branchCov" title="Branch 1 was taken 297 times"> + </span><span class="branchCov" title="Branch 2 was taken 9 times"> + </span>]:<span class="lineCov">        315 :                 if (makedevice(entry.mnt_major, entry.mnt_minor) ==</span>
<span class="lineNum">    1129 </span>                :<span class="lineCov">        306 :                     statbuf.st_dev) {</span>
<span class="lineNum">    1130 </span>                :            :                         break;
<span class="lineNum">    1131 </span>                :            :                 }
<span class="lineNum">    1132 </span>                :            :         }
<span class="lineNum">    1133 </span>        [<span class="branchCov" title="Branch 0 was taken 9 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          9 :         if (ret != 0) {</span>
<span class="lineNum">    1134 </span>                :            :                 return (NULL);
<span class="lineNum">    1135 </span>                :            :         }
<span class="lineNum">    1136 </span>                :            : 
<span class="lineNum">    1137 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 8 times"> + </span>]:<span class="lineCov">          9 :         if (strcmp(entry.mnt_fstype, MNTTYPE_ZFS) != 0) {</span>
<span class="lineNum">    1138 </span>                :<span class="lineCov">          1 :                 (void) fprintf(stderr, gettext(&quot;'%s': not a ZFS filesystem\n&quot;),</span>
<span class="lineNum">    1139 </span>                :            :                     path);
<span class="lineNum">    1140 </span>                :<span class="lineCov">          1 :                 return (NULL);</span>
<span class="lineNum">    1141 </span>                :            :         }
<span class="lineNum">    1142 </span>                :            : 
<span class="lineNum">    1143 </span>                :<span class="lineCov">          8 :         return (zfs_open(hdl, entry.mnt_special, ZFS_TYPE_FILESYSTEM));</span>
<span class="lineNum">    1144 </span>                :            : }
<span class="lineNum">    1145 </span>                :            : 
<span class="lineNum">    1146 </span>                :            : /*
<span class="lineNum">    1147 </span>                :            :  * Append partition suffix to an otherwise fully qualified device path.
<span class="lineNum">    1148 </span>                :            :  * This is used to generate the name the full path as its stored in
<span class="lineNum">    1149 </span>                :            :  * ZPOOL_CONFIG_PATH for whole disk devices.  On success the new length
<span class="lineNum">    1150 </span>                :            :  * of 'path' will be returned on error a negative value is returned.
<a name="1151"><span class="lineNum">    1151 </span>                :            :  */</a>
<span class="lineNum">    1152 </span>                :            : int
<span class="lineNum">    1153 </span>                :<span class="lineNoCov">          0 : zfs_append_partition(char *path, size_t max_len)</span>
<span class="lineNum">    1154 </span>                :            : {
<span class="lineNum">    1155 </span>                :<span class="lineNoCov">          0 :         int len = strlen(path);</span>
<span class="lineNum">    1156 </span>                :            : 
<span class="lineNum">    1157 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ((strncmp(path, UDISK_ROOT, strlen(UDISK_ROOT)) == 0) ||</span>
<span class="lineNum">    1158 </span>                :<span class="lineNoCov">          0 :             (strncmp(path, ZVOL_ROOT, strlen(ZVOL_ROOT)) == 0)) {</span>
<span class="lineNum">    1159 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (len + 6 &gt;= max_len)</span>
<span class="lineNum">    1160 </span>                :            :                         return (-1);
<span class="lineNum">    1161 </span>                :            : 
<span class="lineNum">    1162 </span>                :<span class="lineNoCov">          0 :                 (void) strcat(path, &quot;-part1&quot;);</span>
<span class="lineNum">    1163 </span>                :<span class="lineNoCov">          0 :                 len += 6;</span>
<span class="lineNum">    1164 </span>                :            :         } else {
<span class="lineNum">    1165 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (len + 2 &gt;= max_len)</span>
<span class="lineNum">    1166 </span>                :            :                         return (-1);
<span class="lineNum">    1167 </span>                :            : 
<span class="lineNum">    1168 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (isdigit(path[len-1])) {</span>
<span class="lineNum">    1169 </span>                :<span class="lineNoCov">          0 :                         (void) strcat(path, &quot;p1&quot;);</span>
<span class="lineNum">    1170 </span>                :<span class="lineNoCov">          0 :                         len += 2;</span>
<span class="lineNum">    1171 </span>                :            :                 } else {
<span class="lineNum">    1172 </span>                :<span class="lineNoCov">          0 :                         (void) strcat(path, &quot;1&quot;);</span>
<span class="lineNum">    1173 </span>                :<span class="lineNoCov">          0 :                         len += 1;</span>
<span class="lineNum">    1174 </span>                :            :                 }
<span class="lineNum">    1175 </span>                :            :         }
<span class="lineNum">    1176 </span>                :            : 
<span class="lineNum">    1177 </span>                :            :         return (len);
<span class="lineNum">    1178 </span>                :            : }
<span class="lineNum">    1179 </span>                :            : 
<span class="lineNum">    1180 </span>                :            : /*
<span class="lineNum">    1181 </span>                :            :  * Given a shorthand device name check if a file by that name exists in any
<span class="lineNum">    1182 </span>                :            :  * of the 'zpool_default_import_path' or ZPOOL_IMPORT_PATH directories.  If
<span class="lineNum">    1183 </span>                :            :  * one is found, store its fully qualified path in the 'path' buffer passed
<span class="lineNum">    1184 </span>                :            :  * by the caller and return 0, otherwise return an error.
<a name="1185"><span class="lineNum">    1185 </span>                :            :  */</a>
<span class="lineNum">    1186 </span>                :            : int
<span class="lineNum">    1187 </span>                :<span class="lineCov">       1249 : zfs_resolve_shortname(const char *name, char *path, size_t len)</span>
<span class="lineNum">    1188 </span>                :            : {
<span class="lineNum">    1189 </span>                :<span class="lineCov">       1249 :         int i, error = -1;</span>
<span class="lineNum">    1190 </span>                :            :         char *dir, *env, *envdup;
<span class="lineNum">    1191 </span>                :            : 
<span class="lineNum">    1192 </span>                :<span class="lineCov">       1249 :         env = getenv(&quot;ZPOOL_IMPORT_PATH&quot;);</span>
<span class="lineNum">    1193 </span>                :<span class="lineCov">       1249 :         errno = ENOENT;</span>
<span class="lineNum">    1194 </span>                :            : 
<span class="lineNum">    1195 </span>        [<span class="branchCov" title="Branch 0 was taken 1249 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       1249 :         if (env) {</span>
<span class="lineNum">    1196 </span>                :<span class="lineNoCov">          0 :                 envdup = strdup(env);</span>
<span class="lineNum">    1197 </span>                :<span class="lineNoCov">          0 :                 dir = strtok(envdup, &quot;:&quot;);</span>
<span class="lineNum">    1198 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 while (dir &amp;&amp; error) {</span>
<span class="lineNum">    1199 </span>                :<span class="lineNoCov">          0 :                         (void) snprintf(path, len, &quot;%s/%s&quot;, dir, name);</span>
<span class="lineNum">    1200 </span>                :<span class="lineNoCov">          0 :                         error = access(path, F_OK);</span>
<span class="lineNum">    1201 </span>                :<span class="lineNoCov">          0 :                         dir = strtok(NULL, &quot;:&quot;);</span>
<span class="lineNum">    1202 </span>                :            :                 }
<span class="lineNum">    1203 </span>                :<span class="lineNoCov">          0 :                 free(envdup);</span>
<span class="lineNum">    1204 </span>                :            :         } else {
<span class="lineNum">    1205 </span>        [<span class="branchCov" title="Branch 0 was taken 11241 times"> + </span><span class="branchCov" title="Branch 1 was taken 1249 times"> + </span>]:<span class="lineCov">      12490 :                 for (i = 0; i &lt; DEFAULT_IMPORT_PATH_SIZE &amp;&amp; error &lt; 0; i++) {</span>
<span class="lineNum">    1206 </span>                :<span class="lineCov">      22482 :                         (void) snprintf(path, len, &quot;%s/%s&quot;,</span>
<span class="lineNum">    1207 </span>                :            :                             zpool_default_import_path[i], name);
<span class="lineNum">    1208 </span>                :<span class="lineCov">      11241 :                         error = access(path, F_OK);</span>
<span class="lineNum">    1209 </span>                :            :                 }
<span class="lineNum">    1210 </span>                :            :         }
<span class="lineNum">    1211 </span>                :            : 
<span class="lineNum">    1212 </span>        [<span class="branchCov" title="Branch 0 was taken 1231 times"> + </span><span class="branchCov" title="Branch 1 was taken 18 times"> + </span>]:<span class="lineCov">       1249 :         return (error ? ENOENT : 0);</span>
<span class="lineNum">    1213 </span>                :            : }
<span class="lineNum">    1214 </span>                :            : 
<span class="lineNum">    1215 </span>                :            : /*
<span class="lineNum">    1216 </span>                :            :  * Given a shorthand device name look for a match against 'cmp_name'.  This
<span class="lineNum">    1217 </span>                :            :  * is done by checking all prefix expansions using either the default
<span class="lineNum">    1218 </span>                :            :  * 'zpool_default_import_paths' or the ZPOOL_IMPORT_PATH environment
<span class="lineNum">    1219 </span>                :            :  * variable.  Proper partition suffixes will be appended if this is a
<span class="lineNum">    1220 </span>                :            :  * whole disk.  When a match is found 0 is returned otherwise ENOENT.
<a name="1221"><span class="lineNum">    1221 </span>                :            :  */</a>
<span class="lineNum">    1222 </span>                :            : static int
<span class="lineNum">    1223 </span>                :<span class="lineCov">        534 : zfs_strcmp_shortname(char *name, char *cmp_name, int wholedisk)</span>
<span class="lineNum">    1224 </span>                :            : {
<span class="lineNum">    1225 </span>                :<span class="lineCov">        534 :         int path_len, cmp_len, i = 0, error = ENOENT;</span>
<span class="lineNum">    1226 </span>                :<span class="lineCov">        534 :         char *dir, *env, *envdup = NULL;</span>
<span class="lineNum">    1227 </span>                :            :         char path_name[MAXPATHLEN];
<span class="lineNum">    1228 </span>                :            : 
<span class="lineNum">    1229 </span>                :<span class="lineCov">        534 :         cmp_len = strlen(cmp_name);</span>
<span class="lineNum">    1230 </span>                :<span class="lineCov">        534 :         env = getenv(&quot;ZPOOL_IMPORT_PATH&quot;);</span>
<span class="lineNum">    1231 </span>                :            : 
<span class="lineNum">    1232 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 534 times"> + </span>]:<span class="lineCov">        534 :         if (env) {</span>
<span class="lineNum">    1233 </span>                :<span class="lineNoCov">          0 :                 envdup = strdup(env);</span>
<span class="lineNum">    1234 </span>                :<span class="lineCov">        534 :                 dir = strtok(envdup, &quot;:&quot;);</span>
<span class="lineNum">    1235 </span>                :            :         } else {
<span class="lineNum">    1236 </span>                :<span class="lineCov">        534 :                 dir =  zpool_default_import_path[i];</span>
<span class="lineNum">    1237 </span>                :            :         }
<span class="lineNum">    1238 </span>                :            : 
<span class="lineNum">    1239 </span>        [<span class="branchCov" title="Branch 0 was taken 4806 times"> + </span><span class="branchCov" title="Branch 1 was taken 295 times"> + </span>]:<span class="lineCov">       5101 :         while (dir) {</span>
<span class="lineNum">    1240 </span>                :            :                 /* Trim trailing directory slashes from ZPOOL_IMPORT_PATH */
<span class="lineNum">    1241 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4806 times"> + </span>]:<span class="lineCov">       4806 :                 while (dir[strlen(dir)-1] == '/')</span>
<span class="lineNum">    1242 </span>                :<span class="lineNoCov">          0 :                         dir[strlen(dir)-1] = '\0';</span>
<span class="lineNum">    1243 </span>                :            : 
<span class="lineNum">    1244 </span>                :<span class="lineCov">       4806 :                 path_len = snprintf(path_name, MAXPATHLEN, &quot;%s/%s&quot;, dir, name);</span>
<span class="lineNum">    1245 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4806 times"> + </span>]:<span class="lineCov">       4806 :                 if (wholedisk)</span>
<span class="lineNum">    1246 </span>                :<span class="lineNoCov">          0 :                         path_len = zfs_append_partition(path_name, MAXPATHLEN);</span>
<span class="lineNum">    1247 </span>                :            : 
<span class="lineNum">    1248 </span>[<span class="branchCov" title="Branch 0 was taken 437 times"> + </span><span class="branchCov" title="Branch 1 was taken 4369 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 198 times"> + </span><span class="branchCov" title="Branch 3 was taken 239 times"> + </span>]:<span class="lineCov">       4806 :                 if ((path_len == cmp_len) &amp;&amp; strcmp(path_name, cmp_name) == 0) {</span>
<span class="lineNum">    1249 </span>                :            :                         error = 0;
<span class="lineNum">    1250 </span>                :            :                         break;
<span class="lineNum">    1251 </span>                :            :                 }
<span class="lineNum">    1252 </span>                :            : 
<span class="lineNum">    1253 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4567 times"> + </span>]:<span class="lineCov">       4567 :                 if (env) {</span>
<span class="lineNum">    1254 </span>                :<span class="lineNoCov">          0 :                         dir = strtok(NULL, &quot;:&quot;);</span>
<span class="lineNum">    1255 </span>        [<span class="branchCov" title="Branch 0 was taken 4272 times"> + </span><span class="branchCov" title="Branch 1 was taken 295 times"> + </span>]:<span class="lineCov">       4567 :                 } else if (++i &lt; DEFAULT_IMPORT_PATH_SIZE) {</span>
<span class="lineNum">    1256 </span>                :<span class="lineCov">       4567 :                         dir = zpool_default_import_path[i];</span>
<span class="lineNum">    1257 </span>                :            :                 } else {
<span class="lineNum">    1258 </span>                :            :                         dir = NULL;
<span class="lineNum">    1259 </span>                :            :                 }
<span class="lineNum">    1260 </span>                :            :         }
<span class="lineNum">    1261 </span>                :            : 
<span class="lineNum">    1262 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 534 times"> + </span>]:<span class="lineCov">        534 :         if (env)</span>
<span class="lineNum">    1263 </span>                :<span class="lineNoCov">          0 :                 free(envdup);</span>
<span class="lineNum">    1264 </span>                :            : 
<span class="lineNum">    1265 </span>                :<span class="lineCov">        534 :         return (error);</span>
<span class="lineNum">    1266 </span>                :            : }
<span class="lineNum">    1267 </span>                :            : 
<span class="lineNum">    1268 </span>                :            : /*
<span class="lineNum">    1269 </span>                :            :  * Given either a shorthand or fully qualified path name look for a match
<span class="lineNum">    1270 </span>                :            :  * against 'cmp'.  The passed name will be expanded as needed for comparison
<span class="lineNum">    1271 </span>                :            :  * purposes and redundant slashes stripped to ensure an accurate match.
<a name="1272"><span class="lineNum">    1272 </span>                :            :  */</a>
<span class="lineNum">    1273 </span>                :            : int
<span class="lineNum">    1274 </span>                :<span class="lineCov">       1188 : zfs_strcmp_pathname(char *name, char *cmp, int wholedisk)</span>
<span class="lineNum">    1275 </span>                :            : {
<span class="lineNum">    1276 </span>                :            :         int path_len, cmp_len;
<span class="lineNum">    1277 </span>                :            :         char path_name[MAXPATHLEN];
<span class="lineNum">    1278 </span>                :            :         char cmp_name[MAXPATHLEN];
<span class="lineNum">    1279 </span>                :            :         char *dir, *dup;
<span class="lineNum">    1280 </span>                :            : 
<span class="lineNum">    1281 </span>                :            :         /* Strip redundant slashes if one exists due to ZPOOL_IMPORT_PATH */
<span class="lineNum">    1282 </span>                :<span class="lineCov">       1188 :         memset(cmp_name, 0, MAXPATHLEN);</span>
<span class="lineNum">    1283 </span>                :<span class="lineCov">       1188 :         dup = strdup(cmp);</span>
<span class="lineNum">    1284 </span>                :<span class="lineCov">       1188 :         dir = strtok(dup, &quot;/&quot;);</span>
<span class="lineNum">    1285 </span>        [<span class="branchCov" title="Branch 0 was taken 3661 times"> + </span><span class="branchCov" title="Branch 1 was taken 1188 times"> + </span>]:<span class="lineCov">       4849 :         while (dir) {</span>
<span class="lineNum">    1286 </span>                :<span class="lineCov">       3661 :                 strlcat(cmp_name, &quot;/&quot;, sizeof (cmp_name));</span>
<span class="lineNum">    1287 </span>                :<span class="lineCov">       3661 :                 strlcat(cmp_name, dir, sizeof (cmp_name));</span>
<span class="lineNum">    1288 </span>                :<span class="lineCov">       3661 :                 dir = strtok(NULL, &quot;/&quot;);</span>
<span class="lineNum">    1289 </span>                :            :         }
<span class="lineNum">    1290 </span>                :<span class="lineCov">       1188 :         free(dup);</span>
<span class="lineNum">    1291 </span>                :            : 
<span class="lineNum">    1292 </span>        [<span class="branchCov" title="Branch 0 was taken 534 times"> + </span><span class="branchCov" title="Branch 1 was taken 654 times"> + </span>]:<span class="lineCov">       1188 :         if (name[0] != '/')</span>
<span class="lineNum">    1293 </span>                :<span class="lineCov">        534 :                 return (zfs_strcmp_shortname(name, cmp_name, wholedisk));</span>
<span class="lineNum">    1294 </span>                :            : 
<span class="lineNum">    1295 </span>                :<span class="lineCov">        654 :         (void) strlcpy(path_name, name, MAXPATHLEN);</span>
<span class="lineNum">    1296 </span>                :<span class="lineCov">        654 :         path_len = strlen(path_name);</span>
<span class="lineNum">    1297 </span>                :<span class="lineCov">        654 :         cmp_len = strlen(cmp_name);</span>
<span class="lineNum">    1298 </span>                :            : 
<span class="lineNum">    1299 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 654 times"> + </span>]:<span class="lineCov">        654 :         if (wholedisk) {</span>
<span class="lineNum">    1300 </span>                :<span class="lineNoCov">          0 :                 path_len = zfs_append_partition(path_name, MAXPATHLEN);</span>
<span class="lineNum">    1301 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (path_len == -1)</span>
<span class="lineNum">    1302 </span>                :            :                         return (ENOMEM);
<span class="lineNum">    1303 </span>                :            :         }
<span class="lineNum">    1304 </span>                :            : 
<span class="lineNum">    1305 </span>[<span class="branchCov" title="Branch 0 was taken 619 times"> + </span><span class="branchCov" title="Branch 1 was taken 35 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 356 times"> + </span><span class="branchCov" title="Branch 3 was taken 263 times"> + </span>]:<span class="lineCov">        654 :         if ((path_len != cmp_len) || strcmp(path_name, cmp_name))</span>
<span class="lineNum">    1306 </span>                :            :                 return (ENOENT);
<span class="lineNum">    1307 </span>                :            : 
<span class="lineNum">    1308 </span>                :<span class="lineCov">        356 :         return (0);</span>
<span class="lineNum">    1309 </span>                :            : }
<span class="lineNum">    1310 </span>                :            : 
<span class="lineNum">    1311 </span>                :            : /*
<span class="lineNum">    1312 </span>                :            :  * Given a full path to a device determine if that device appears in the
<span class="lineNum">    1313 </span>                :            :  * import search path.  If it does return the first match and store the
<span class="lineNum">    1314 </span>                :            :  * index in the passed 'order' variable, otherwise return an error.
<a name="1315"><span class="lineNum">    1315 </span>                :            :  */</a>
<span class="lineNum">    1316 </span>                :            : int
<span class="lineNum">    1317 </span>                :<span class="lineCov">        441 : zfs_path_order(char *name, int *order)</span>
<span class="lineNum">    1318 </span>                :            : {
<span class="lineNum">    1319 </span>                :<span class="lineCov">        441 :         int i = 0, error = ENOENT;</span>
<span class="lineNum">    1320 </span>                :            :         char *dir, *env, *envdup;
<span class="lineNum">    1321 </span>                :            : 
<span class="lineNum">    1322 </span>                :<span class="lineCov">        441 :         env = getenv(&quot;ZPOOL_IMPORT_PATH&quot;);</span>
<span class="lineNum">    1323 </span>        [<span class="branchCov" title="Branch 0 was taken 441 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        441 :         if (env) {</span>
<span class="lineNum">    1324 </span>                :<span class="lineNoCov">          0 :                 envdup = strdup(env);</span>
<span class="lineNum">    1325 </span>                :<span class="lineNoCov">          0 :                 dir = strtok(envdup, &quot;:&quot;);</span>
<span class="lineNum">    1326 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 while (dir) {</span>
<span class="lineNum">    1327 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (strncmp(name, dir, strlen(dir)) == 0) {</span>
<span class="lineNum">    1328 </span>                :<span class="lineNoCov">          0 :                                 *order = i;</span>
<span class="lineNum">    1329 </span>                :<span class="lineNoCov">          0 :                                 error = 0;</span>
<span class="lineNum">    1330 </span>                :<span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    1331 </span>                :            :                         }
<span class="lineNum">    1332 </span>                :<span class="lineNoCov">          0 :                         dir = strtok(NULL, &quot;:&quot;);</span>
<span class="lineNum">    1333 </span>                :<span class="lineNoCov">          0 :                         i++;</span>
<span class="lineNum">    1334 </span>                :            :                 }
<span class="lineNum">    1335 </span>                :<span class="lineNoCov">          0 :                 free(envdup);</span>
<span class="lineNum">    1336 </span>                :            :         } else {
<span class="lineNum">    1337 </span>        [<span class="branchCov" title="Branch 0 was taken 3969 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       3969 :                 for (i = 0; i &lt; DEFAULT_IMPORT_PATH_SIZE; i++) {</span>
<span class="lineNum">    1338 </span>        [<span class="branchCov" title="Branch 0 was taken 441 times"> + </span><span class="branchCov" title="Branch 1 was taken 3528 times"> + </span>]:<span class="lineCov">       3969 :                         if (strncmp(name, zpool_default_import_path[i],</span>
<span class="lineNum">    1339 </span>                :<span class="lineCov">       3969 :                             strlen(zpool_default_import_path[i])) == 0) {</span>
<span class="lineNum">    1340 </span>                :<span class="lineCov">        441 :                                 *order = i;</span>
<span class="lineNum">    1341 </span>                :<span class="lineCov">        441 :                                 error = 0;</span>
<span class="lineNum">    1342 </span>                :<span class="lineCov">        441 :                                 break;</span>
<span class="lineNum">    1343 </span>                :            :                         }
<span class="lineNum">    1344 </span>                :            :                 }
<span class="lineNum">    1345 </span>                :            :         }
<span class="lineNum">    1346 </span>                :            : 
<span class="lineNum">    1347 </span>                :<span class="lineCov">        441 :         return (error);</span>
<span class="lineNum">    1348 </span>                :            : }
<span class="lineNum">    1349 </span>                :            : 
<span class="lineNum">    1350 </span>                :            : /*
<span class="lineNum">    1351 </span>                :            :  * Initialize the zc_nvlist_dst member to prepare for receiving an nvlist from
<span class="lineNum">    1352 </span>                :            :  * an ioctl().
<a name="1353"><span class="lineNum">    1353 </span>                :            :  */</a>
<span class="lineNum">    1354 </span>                :            : int
<span class="lineNum">    1355 </span>                :<span class="lineCov">     170413 : zcmd_alloc_dst_nvlist(libzfs_handle_t *hdl, zfs_cmd_t *zc, size_t len)</span>
<span class="lineNum">    1356 </span>                :            : {
<span class="lineNum">    1357 </span>        [<span class="branchCov" title="Branch 0 was taken 111326 times"> + </span><span class="branchCov" title="Branch 1 was taken 59087 times"> + </span>]:<span class="lineCov">     170413 :         if (len == 0)</span>
<span class="lineNum">    1358 </span>                :<span class="lineCov">     111326 :                 len = 16 * 1024;</span>
<span class="lineNum">    1359 </span>                :<span class="lineCov">     170413 :         zc-&gt;zc_nvlist_dst_size = len;</span>
<span class="lineNum">    1360 </span>                :<span class="lineCov">     170413 :         zc-&gt;zc_nvlist_dst =</span>
<span class="lineNum">    1361 </span>                :<span class="lineCov">     170413 :             (uint64_t)(uintptr_t)zfs_alloc(hdl, zc-&gt;zc_nvlist_dst_size);</span>
<span class="lineNum">    1362 </span>        [<span class="branchCov" title="Branch 0 was taken 170413 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     170413 :         if (zc-&gt;zc_nvlist_dst == 0)</span>
<span class="lineNum">    1363 </span>                :            :                 return (-1);
<span class="lineNum">    1364 </span>                :            : 
<span class="lineNum">    1365 </span>                :<span class="lineCov">     170413 :         return (0);</span>
<span class="lineNum">    1366 </span>                :            : }
<span class="lineNum">    1367 </span>                :            : 
<span class="lineNum">    1368 </span>                :            : /*
<span class="lineNum">    1369 </span>                :            :  * Called when an ioctl() which returns an nvlist fails with ENOMEM.  This will
<span class="lineNum">    1370 </span>                :            :  * expand the nvlist to the size specified in 'zc_nvlist_dst_size', which was
<span class="lineNum">    1371 </span>                :            :  * filled in by the kernel to indicate the actual required size.
<a name="1372"><span class="lineNum">    1372 </span>                :            :  */</a>
<span class="lineNum">    1373 </span>                :            : int
<span class="lineNum">    1374 </span>                :<span class="lineCov">       2810 : zcmd_expand_dst_nvlist(libzfs_handle_t *hdl, zfs_cmd_t *zc)</span>
<span class="lineNum">    1375 </span>                :            : {
<span class="lineNum">    1376 </span>                :<span class="lineCov">       2810 :         free((void *)(uintptr_t)zc-&gt;zc_nvlist_dst);</span>
<span class="lineNum">    1377 </span>                :<span class="lineCov">       2810 :         zc-&gt;zc_nvlist_dst =</span>
<span class="lineNum">    1378 </span>                :<span class="lineCov">       2810 :             (uint64_t)(uintptr_t)zfs_alloc(hdl, zc-&gt;zc_nvlist_dst_size);</span>
<span class="lineNum">    1379 </span>        [<span class="branchCov" title="Branch 0 was taken 2810 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">       2810 :         if (zc-&gt;zc_nvlist_dst == 0)</span>
<span class="lineNum">    1380 </span>                :            :                 return (-1);
<span class="lineNum">    1381 </span>                :            : 
<span class="lineNum">    1382 </span>                :<span class="lineCov">       2810 :         return (0);</span>
<span class="lineNum">    1383 </span>                :            : }
<span class="lineNum">    1384 </span>                :            : 
<span class="lineNum">    1385 </span>                :            : /*
<span class="lineNum">    1386 </span>                :            :  * Called to free the src and dst nvlists stored in the command structure.
<a name="1387"><span class="lineNum">    1387 </span>                :            :  */</a>
<span class="lineNum">    1388 </span>                :            : void
<span class="lineNum">    1389 </span>                :<span class="lineCov">     221920 : zcmd_free_nvlists(zfs_cmd_t *zc)</span>
<span class="lineNum">    1390 </span>                :            : {
<span class="lineNum">    1391 </span>                :<span class="lineCov">     221920 :         free((void *)(uintptr_t)zc-&gt;zc_nvlist_conf);</span>
<span class="lineNum">    1392 </span>                :<span class="lineCov">     221920 :         free((void *)(uintptr_t)zc-&gt;zc_nvlist_src);</span>
<span class="lineNum">    1393 </span>                :<span class="lineCov">     221920 :         free((void *)(uintptr_t)zc-&gt;zc_nvlist_dst);</span>
<span class="lineNum">    1394 </span>                :<span class="lineCov">     221920 :         zc-&gt;zc_nvlist_conf = 0;</span>
<span class="lineNum">    1395 </span>                :<span class="lineCov">     221920 :         zc-&gt;zc_nvlist_src = 0;</span>
<span class="lineNum">    1396 </span>                :<span class="lineCov">     221920 :         zc-&gt;zc_nvlist_dst = 0;</span>
<span class="lineNum">    1397 </span>                :<span class="lineCov">     221920 : }</span>
<a name="1398"><span class="lineNum">    1398 </span>                :            : </a>
<span class="lineNum">    1399 </span>                :            : static int
<span class="lineNum">    1400 </span>                :<span class="lineCov">      55252 : zcmd_write_nvlist_com(libzfs_handle_t *hdl, uint64_t *outnv, uint64_t *outlen,</span>
<span class="lineNum">    1401 </span>                :            :     nvlist_t *nvl)
<span class="lineNum">    1402 </span>                :            : {
<span class="lineNum">    1403 </span>                :            :         char *packed;
<span class="lineNum">    1404 </span>                :            :         size_t len;
<span class="lineNum">    1405 </span>                :            : 
<span class="lineNum">    1406 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 55252 times"> + </span>]:<span class="lineCov">      55252 :         verify(nvlist_size(nvl, &amp;len, NV_ENCODE_NATIVE) == 0);</span>
<span class="lineNum">    1407 </span>                :            : 
<span class="lineNum">    1408 </span>        [<span class="branchCov" title="Branch 1 was taken 55252 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      55252 :         if ((packed = zfs_alloc(hdl, len)) == NULL)</span>
<span class="lineNum">    1409 </span>                :            :                 return (-1);
<span class="lineNum">    1410 </span>                :            : 
<span class="lineNum">    1411 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 55252 times"> + </span>]:<span class="lineCov">      55252 :         verify(nvlist_pack(nvl, &amp;packed, &amp;len, NV_ENCODE_NATIVE, 0) == 0);</span>
<span class="lineNum">    1412 </span>                :            : 
<span class="lineNum">    1413 </span>                :<span class="lineCov">      55252 :         *outnv = (uint64_t)(uintptr_t)packed;</span>
<span class="lineNum">    1414 </span>                :<span class="lineCov">      55252 :         *outlen = len;</span>
<span class="lineNum">    1415 </span>                :            : 
<span class="lineNum">    1416 </span>                :<span class="lineCov">      55252 :         return (0);</span>
<span class="lineNum">    1417 </span>                :            : }
<a name="1418"><span class="lineNum">    1418 </span>                :            : </a>
<span class="lineNum">    1419 </span>                :            : int
<span class="lineNum">    1420 </span>                :<span class="lineCov">       3304 : zcmd_write_conf_nvlist(libzfs_handle_t *hdl, zfs_cmd_t *zc, nvlist_t *nvl)</span>
<span class="lineNum">    1421 </span>                :            : {
<span class="lineNum">    1422 </span>                :<span class="lineCov">       3304 :         return (zcmd_write_nvlist_com(hdl, &amp;zc-&gt;zc_nvlist_conf,</span>
<span class="lineNum">    1423 </span>                :            :             &amp;zc-&gt;zc_nvlist_conf_size, nvl));
<span class="lineNum">    1424 </span>                :            : }
<a name="1425"><span class="lineNum">    1425 </span>                :            : </a>
<span class="lineNum">    1426 </span>                :            : int
<span class="lineNum">    1427 </span>                :<span class="lineCov">      51948 : zcmd_write_src_nvlist(libzfs_handle_t *hdl, zfs_cmd_t *zc, nvlist_t *nvl)</span>
<span class="lineNum">    1428 </span>                :            : {
<span class="lineNum">    1429 </span>                :<span class="lineCov">      51948 :         return (zcmd_write_nvlist_com(hdl, &amp;zc-&gt;zc_nvlist_src,</span>
<span class="lineNum">    1430 </span>                :            :             &amp;zc-&gt;zc_nvlist_src_size, nvl));
<span class="lineNum">    1431 </span>                :            : }
<span class="lineNum">    1432 </span>                :            : 
<span class="lineNum">    1433 </span>                :            : /*
<span class="lineNum">    1434 </span>                :            :  * Unpacks an nvlist from the ZFS ioctl command structure.
<a name="1435"><span class="lineNum">    1435 </span>                :            :  */</a>
<span class="lineNum">    1436 </span>                :            : int
<span class="lineNum">    1437 </span>                :<span class="lineCov">     158630 : zcmd_read_dst_nvlist(libzfs_handle_t *hdl, zfs_cmd_t *zc, nvlist_t **nvlp)</span>
<span class="lineNum">    1438 </span>                :            : {
<span class="lineNum">    1439 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 158630 times"> + </span>]:<span class="lineCov">     158630 :         if (nvlist_unpack((void *)(uintptr_t)zc-&gt;zc_nvlist_dst,</span>
<span class="lineNum">    1440 </span>                :            :             zc-&gt;zc_nvlist_dst_size, nvlp, 0) != 0)
<span class="lineNum">    1441 </span>                :<span class="lineNoCov">          0 :                 return (no_memory(hdl));</span>
<span class="lineNum">    1442 </span>                :            : 
<span class="lineNum">    1443 </span>                :            :         return (0);
<span class="lineNum">    1444 </span>                :            : }
<a name="1445"><span class="lineNum">    1445 </span>                :            : </a>
<span class="lineNum">    1446 </span>                :            : int
<span class="lineNum">    1447 </span>                :<span class="lineCov">      18446 : zfs_ioctl(libzfs_handle_t *hdl, int request, zfs_cmd_t *zc)</span>
<span class="lineNum">    1448 </span>                :            : {
<span class="lineNum">    1449 </span>                :<span class="lineCov">      18446 :         return (ioctl(hdl-&gt;libzfs_fd, request, zc));</span>
<span class="lineNum">    1450 </span>                :            : }
<span class="lineNum">    1451 </span>                :            : 
<span class="lineNum">    1452 </span>                :            : /*
<span class="lineNum">    1453 </span>                :            :  * ================================================================
<span class="lineNum">    1454 </span>                :            :  * API shared by zfs and zpool property management
<span class="lineNum">    1455 </span>                :            :  * ================================================================
<span class="lineNum">    1456 </span>                :            :  */
<a name="1457"><span class="lineNum">    1457 </span>                :            : </a>
<span class="lineNum">    1458 </span>                :            : static void
<span class="lineNum">    1459 </span>                :<span class="lineCov">      21865 : zprop_print_headers(zprop_get_cbdata_t *cbp, zfs_type_t type)</span>
<span class="lineNum">    1460 </span>                :            : {
<span class="lineNum">    1461 </span>                :<span class="lineCov">      21865 :         zprop_list_t *pl = cbp-&gt;cb_proplist;</span>
<span class="lineNum">    1462 </span>                :            :         int i;
<span class="lineNum">    1463 </span>                :            :         char *title;
<span class="lineNum">    1464 </span>                :            :         size_t len;
<span class="lineNum">    1465 </span>                :            : 
<span class="lineNum">    1466 </span>                :<span class="lineCov">      21865 :         cbp-&gt;cb_first = B_FALSE;</span>
<span class="lineNum">    1467 </span>        [<span class="branchCov" title="Branch 0 was taken 5069 times"> + </span><span class="branchCov" title="Branch 1 was taken 16796 times"> + </span>]:<span class="lineCov">      21865 :         if (cbp-&gt;cb_scripted)</span>
<span class="lineNum">    1468 </span>                :            :                 return;
<span class="lineNum">    1469 </span>                :            : 
<span class="lineNum">    1470 </span>                :            :         /*
<span class="lineNum">    1471 </span>                :            :          * Start with the length of the column headers.
<span class="lineNum">    1472 </span>                :            :          */
<span class="lineNum">    1473 </span>                :<span class="lineCov">       5069 :         cbp-&gt;cb_colwidths[GET_COL_NAME] = strlen(dgettext(TEXT_DOMAIN, &quot;NAME&quot;));</span>
<span class="lineNum">    1474 </span>                :<span class="lineCov">       5069 :         cbp-&gt;cb_colwidths[GET_COL_PROPERTY] = strlen(dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1475 </span>                :            :             &quot;PROPERTY&quot;));
<span class="lineNum">    1476 </span>                :<span class="lineCov">       5069 :         cbp-&gt;cb_colwidths[GET_COL_VALUE] = strlen(dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1477 </span>                :            :             &quot;VALUE&quot;));
<span class="lineNum">    1478 </span>                :<span class="lineCov">       5069 :         cbp-&gt;cb_colwidths[GET_COL_RECVD] = strlen(dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1479 </span>                :            :             &quot;RECEIVED&quot;));
<span class="lineNum">    1480 </span>                :<span class="lineCov">       5069 :         cbp-&gt;cb_colwidths[GET_COL_SOURCE] = strlen(dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1481 </span>                :            :             &quot;SOURCE&quot;));
<span class="lineNum">    1482 </span>                :            : 
<span class="lineNum">    1483 </span>                :            :         /* first property is always NAME */
<span class="lineNum">    1484 </span>[<span class="branchCov" title="Branch 0 was taken 4072 times"> + </span><span class="branchCov" title="Branch 1 was taken 997 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 5069 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       5069 :         assert(cbp-&gt;cb_proplist-&gt;pl_prop ==</span>
<span class="lineNum">    1485 </span>                :            :             ((type == ZFS_TYPE_POOL) ?  ZPOOL_PROP_NAME : ZFS_PROP_NAME));
<span class="lineNum">    1486 </span>                :            : 
<span class="lineNum">    1487 </span>                :            :         /*
<span class="lineNum">    1488 </span>                :            :          * Go through and calculate the widths for each column.  For the
<span class="lineNum">    1489 </span>                :            :          * 'source' column, we kludge it up by taking the worst-case scenario of
<span class="lineNum">    1490 </span>                :            :          * inheriting from the longest name.  This is acceptable because in the
<span class="lineNum">    1491 </span>                :            :          * majority of cases 'SOURCE' is the last column displayed, and we don't
<span class="lineNum">    1492 </span>                :            :          * use the width anyway.  Note that the 'VALUE' column can be oversized,
<span class="lineNum">    1493 </span>                :            :          * if the name of the property is much longer than any values we find.
<span class="lineNum">    1494 </span>                :            :          */
<span class="lineNum">    1495 </span>        [<span class="branchCov" title="Branch 0 was taken 35568 times"> + </span><span class="branchCov" title="Branch 1 was taken 5069 times"> + </span>]:<span class="lineCov">      40637 :         for (pl = cbp-&gt;cb_proplist; pl != NULL; pl = pl-&gt;pl_next) {</span>
<span class="lineNum">    1496 </span>                :            :                 /*
<span class="lineNum">    1497 </span>                :            :                  * 'PROPERTY' column
<span class="lineNum">    1498 </span>                :            :                  */
<span class="lineNum">    1499 </span>        [<span class="branchCov" title="Branch 0 was taken 32262 times"> + </span><span class="branchCov" title="Branch 1 was taken 3306 times"> + </span>]:<span class="lineCov">      35568 :                 if (pl-&gt;pl_prop != ZPROP_INVAL) {</span>
<span class="lineNum">    1500 </span>                :<span class="lineCov">      32262 :                         const char *propname = (type == ZFS_TYPE_POOL) ?</span>
<span class="lineNum">    1501 </span>        [<span class="branchCov" title="Branch 0 was taken 2312 times"> + </span><span class="branchCov" title="Branch 1 was taken 29950 times"> + </span>]:<span class="lineCov">      32262 :                             zpool_prop_to_name(pl-&gt;pl_prop) :</span>
<span class="lineNum">    1502 </span>                :            :                             zfs_prop_to_name(pl-&gt;pl_prop);
<span class="lineNum">    1503 </span>                :            : 
<span class="lineNum">    1504 </span>                :<span class="lineCov">      32262 :                         len = strlen(propname);</span>
<span class="lineNum">    1505 </span>        [<span class="branchCov" title="Branch 0 was taken 2873 times"> + </span><span class="branchCov" title="Branch 1 was taken 29389 times"> + </span>]:<span class="lineCov">      32262 :                         if (len &gt; cbp-&gt;cb_colwidths[GET_COL_PROPERTY])</span>
<span class="lineNum">    1506 </span>                :<span class="lineCov">       2873 :                                 cbp-&gt;cb_colwidths[GET_COL_PROPERTY] = len;</span>
<span class="lineNum">    1507 </span>                :            :                 } else {
<span class="lineNum">    1508 </span>                :<span class="lineCov">       3306 :                         len = strlen(pl-&gt;pl_user_prop);</span>
<span class="lineNum">    1509 </span>        [<span class="branchCov" title="Branch 0 was taken 963 times"> + </span><span class="branchCov" title="Branch 1 was taken 2343 times"> + </span>]:<span class="lineCov">       3306 :                         if (len &gt; cbp-&gt;cb_colwidths[GET_COL_PROPERTY])</span>
<span class="lineNum">    1510 </span>                :<span class="lineCov">        963 :                                 cbp-&gt;cb_colwidths[GET_COL_PROPERTY] = len;</span>
<span class="lineNum">    1511 </span>                :            :                 }
<span class="lineNum">    1512 </span>                :            : 
<span class="lineNum">    1513 </span>                :            :                 /*
<span class="lineNum">    1514 </span>                :            :                  * 'VALUE' column.  The first property is always the 'name'
<span class="lineNum">    1515 </span>                :            :                  * property that was tacked on either by /sbin/zfs's
<span class="lineNum">    1516 </span>                :            :                  * zfs_do_get() or when calling zprop_expand_list(), so we
<span class="lineNum">    1517 </span>                :            :                  * ignore its width.  If the user specified the name property
<span class="lineNum">    1518 </span>                :            :                  * to display, then it will be later in the list in any case.
<span class="lineNum">    1519 </span>                :            :                  */
<span class="lineNum">    1520 </span>[<span class="branchCov" title="Branch 0 was taken 30499 times"> + </span><span class="branchCov" title="Branch 1 was taken 5069 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 6956 times"> + </span><span class="branchCov" title="Branch 3 was taken 23543 times"> + </span>]:<span class="lineCov">      35568 :                 if (pl != cbp-&gt;cb_proplist &amp;&amp;</span>
<span class="lineNum">    1521 </span>                :<span class="lineCov">      30499 :                     pl-&gt;pl_width &gt; cbp-&gt;cb_colwidths[GET_COL_VALUE])</span>
<span class="lineNum">    1522 </span>                :<span class="lineCov">       6956 :                         cbp-&gt;cb_colwidths[GET_COL_VALUE] = pl-&gt;pl_width;</span>
<span class="lineNum">    1523 </span>                :            : 
<span class="lineNum">    1524 </span>                :            :                 /* 'RECEIVED' column. */
<span class="lineNum">    1525 </span>[<span class="branchCov" title="Branch 0 was taken 30499 times"> + </span><span class="branchCov" title="Branch 1 was taken 5069 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 30499 times"> + </span>]:<span class="lineCov">      35568 :                 if (pl != cbp-&gt;cb_proplist &amp;&amp;</span>
<span class="lineNum">    1526 </span>                :<span class="lineCov">      30499 :                     pl-&gt;pl_recvd_width &gt; cbp-&gt;cb_colwidths[GET_COL_RECVD])</span>
<span class="lineNum">    1527 </span>                :<span class="lineNoCov">          0 :                         cbp-&gt;cb_colwidths[GET_COL_RECVD] = pl-&gt;pl_recvd_width;</span>
<span class="lineNum">    1528 </span>                :            : 
<span class="lineNum">    1529 </span>                :            :                 /*
<span class="lineNum">    1530 </span>                :            :                  * 'NAME' and 'SOURCE' columns
<span class="lineNum">    1531 </span>                :            :                  */
<span class="lineNum">    1532 </span>        [<span class="branchCov" title="Branch 0 was taken 7124 times"> + </span><span class="branchCov" title="Branch 1 was taken 28444 times"> + </span>]:<span class="lineCov">      35568 :                 if (pl-&gt;pl_prop == (type == ZFS_TYPE_POOL ? ZPOOL_PROP_NAME :</span>
<span class="lineNum">    1533 </span>        [<span class="branchCov" title="Branch 0 was taken 5012 times"> + </span><span class="branchCov" title="Branch 1 was taken 2112 times"> + </span>]:<span class="lineCov">       7124 :                     ZFS_PROP_NAME) &amp;&amp;</span>
<span class="lineNum">    1534 </span>                :<span class="lineCov">       7124 :                     pl-&gt;pl_width &gt; cbp-&gt;cb_colwidths[GET_COL_NAME]) {</span>
<span class="lineNum">    1535 </span>                :<span class="lineCov">       5012 :                         cbp-&gt;cb_colwidths[GET_COL_NAME] = pl-&gt;pl_width;</span>
<span class="lineNum">    1536 </span>                :<span class="lineCov">       5012 :                         cbp-&gt;cb_colwidths[GET_COL_SOURCE] = pl-&gt;pl_width +</span>
<span class="lineNum">    1537 </span>                :<span class="lineCov">       5012 :                             strlen(dgettext(TEXT_DOMAIN, &quot;inherited from&quot;));</span>
<span class="lineNum">    1538 </span>                :            :                 }
<span class="lineNum">    1539 </span>                :            :         }
<span class="lineNum">    1540 </span>                :            : 
<span class="lineNum">    1541 </span>                :            :         /*
<span class="lineNum">    1542 </span>                :            :          * Now go through and print the headers.
<span class="lineNum">    1543 </span>                :            :          */
<span class="lineNum">    1544 </span>        [<span class="branchCov" title="Branch 0 was taken 25345 times"> + </span><span class="branchCov" title="Branch 1 was taken 5069 times"> + </span>]:<span class="lineCov">      30414 :         for (i = 0; i &lt; ZFS_GET_NCOLS; i++) {</span>
<span class="lineNum">    1545 </span>  [<span class="branchCov" title="Branch 0 was taken 5069 times"> + </span><span class="branchCov" title="Branch 1 was taken 4757 times"> + </span><span class="branchCov" title="Branch 2 was taken 4757 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span> :<span class="lineCov">      25345 :                 switch (cbp-&gt;cb_columns[i]) {</span>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 4757 times"> + </span><span class="branchCov" title="Branch 5 was taken 6005 times"> + </span>]
<span class="lineNum">    1546 </span>                :            :                 case GET_COL_NAME:
<span class="lineNum">    1547 </span>                :<span class="lineCov">       5069 :                         title = dgettext(TEXT_DOMAIN, &quot;NAME&quot;);</span>
<span class="lineNum">    1548 </span>                :<span class="lineCov">       5069 :                         break;</span>
<span class="lineNum">    1549 </span>                :            :                 case GET_COL_PROPERTY:
<span class="lineNum">    1550 </span>                :<span class="lineCov">       4757 :                         title = dgettext(TEXT_DOMAIN, &quot;PROPERTY&quot;);</span>
<span class="lineNum">    1551 </span>                :<span class="lineCov">       4757 :                         break;</span>
<span class="lineNum">    1552 </span>                :            :                 case GET_COL_VALUE:
<span class="lineNum">    1553 </span>                :<span class="lineCov">       4757 :                         title = dgettext(TEXT_DOMAIN, &quot;VALUE&quot;);</span>
<span class="lineNum">    1554 </span>                :<span class="lineCov">       4757 :                         break;</span>
<span class="lineNum">    1555 </span>                :            :                 case GET_COL_RECVD:
<span class="lineNum">    1556 </span>                :<span class="lineNoCov">          0 :                         title = dgettext(TEXT_DOMAIN, &quot;RECEIVED&quot;);</span>
<span class="lineNum">    1557 </span>                :<span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1558 </span>                :            :                 case GET_COL_SOURCE:
<span class="lineNum">    1559 </span>                :<span class="lineCov">       4757 :                         title = dgettext(TEXT_DOMAIN, &quot;SOURCE&quot;);</span>
<span class="lineNum">    1560 </span>                :<span class="lineCov">       4757 :                         break;</span>
<span class="lineNum">    1561 </span>                :            :                 default:
<span class="lineNum">    1562 </span>                :            :                         title = NULL;
<span class="lineNum">    1563 </span>                :            :                 }
<span class="lineNum">    1564 </span>                :            : 
<span class="lineNum">    1565 </span>        [<span class="branchCov" title="Branch 0 was taken 19340 times"> + </span><span class="branchCov" title="Branch 1 was taken 6005 times"> + </span>]:<span class="lineCov">      25345 :                 if (title != NULL) {</span>
<span class="lineNum">    1566 </span>[<span class="branchCov" title="Branch 0 was taken 19340 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 5069 times"> + </span><span class="branchCov" title="Branch 3 was taken 14271 times"> + </span>]:<span class="lineCov">      19340 :                         if (i == (ZFS_GET_NCOLS - 1) ||</span>
<span class="lineNum">    1567 </span>                :<span class="lineCov">      19340 :                             cbp-&gt;cb_columns[i + 1] == GET_COL_NONE)</span>
<span class="lineNum">    1568 </span>                :            :                                 (void) printf(&quot;%s&quot;, title);
<span class="lineNum">    1569 </span>                :            :                         else
<span class="lineNum">    1570 </span>                :<span class="lineCov">      14271 :                                 (void) printf(&quot;%-*s  &quot;,</span>
<span class="lineNum">    1571 </span>                :<span class="lineCov">      14271 :                                     cbp-&gt;cb_colwidths[cbp-&gt;cb_columns[i]],</span>
<span class="lineNum">    1572 </span>                :            :                                     title);
<span class="lineNum">    1573 </span>                :            :                 }
<span class="lineNum">    1574 </span>                :            :         }
<span class="lineNum">    1575 </span>                :            :         (void) printf(&quot;\n&quot;);
<span class="lineNum">    1576 </span>                :            : }
<span class="lineNum">    1577 </span>                :            : 
<span class="lineNum">    1578 </span>                :            : /*
<span class="lineNum">    1579 </span>                :            :  * Display a single line of output, according to the settings in the callback
<span class="lineNum">    1580 </span>                :            :  * structure.
<a name="1581"><span class="lineNum">    1581 </span>                :            :  */</a>
<span class="lineNum">    1582 </span>                :            : void
<span class="lineNum">    1583 </span>                :<span class="lineCov">     102814 : zprop_print_one_property(const char *name, zprop_get_cbdata_t *cbp,</span>
<span class="lineNum">    1584 </span>                :            :     const char *propname, const char *value, zprop_source_t sourcetype,
<span class="lineNum">    1585 </span>                :            :     const char *source, const char *recvd_value)
<span class="lineNum">    1586 </span>                :            : {
<span class="lineNum">    1587 </span>                :            :         int i;
<span class="lineNum">    1588 </span>                :<span class="lineCov">     102814 :         const char *str = NULL;</span>
<span class="lineNum">    1589 </span>                :            :         char buf[128];
<span class="lineNum">    1590 </span>                :            : 
<span class="lineNum">    1591 </span>                :            :         /*
<span class="lineNum">    1592 </span>                :            :          * Ignore those source types that the user has chosen to ignore.
<span class="lineNum">    1593 </span>                :            :          */
<span class="lineNum">    1594 </span>        [<span class="branchCov" title="Branch 0 was taken 102814 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     102814 :         if ((sourcetype &amp; cbp-&gt;cb_sources) == 0)</span>
<span class="lineNum">    1595 </span>                :<span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1596 </span>                :            : 
<span class="lineNum">    1597 </span>        [<span class="branchCov" title="Branch 0 was taken 21865 times"> + </span><span class="branchCov" title="Branch 1 was taken 80949 times"> + </span>]:<span class="lineCov">     102814 :         if (cbp-&gt;cb_first)</span>
<span class="lineNum">    1598 </span>                :<span class="lineCov">     102814 :                 zprop_print_headers(cbp, cbp-&gt;cb_type);</span>
<span class="lineNum">    1599 </span>                :            : 
<span class="lineNum">    1600 </span>        [<span class="branchCov" title="Branch 0 was taken 514070 times"> + </span><span class="branchCov" title="Branch 1 was taken 102814 times"> + </span>]:<span class="lineCov">     616884 :         for (i = 0; i &lt; ZFS_GET_NCOLS; i++) {</span>
<span class="lineNum">    1601 </span>  [<span class="branchCov" title="Branch 0 was taken 77891 times"> + </span><span class="branchCov" title="Branch 1 was taken 72107 times"> + </span><span class="branchCov" title="Branch 2 was taken 61721 times"> + </span><span class="branchCov" title="Branch 3 was taken 4 times"> + </span> :<span class="lineCov">     514070 :                 switch (cbp-&gt;cb_columns[i]) {</span>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken 232924 times"> + </span><span class="branchCov" title="Branch 5 was taken 69423 times"> + </span>]
<span class="lineNum">    1602 </span>                :            :                 case GET_COL_NAME:
<span class="lineNum">    1603 </span>                :            :                         str = name;
<span class="lineNum">    1604 </span>                :            :                         break;
<span class="lineNum">    1605 </span>                :            : 
<span class="lineNum">    1606 </span>                :            :                 case GET_COL_PROPERTY:
<span class="lineNum">    1607 </span>                :<span class="lineCov">      77891 :                         str = propname;</span>
<span class="lineNum">    1608 </span>                :<span class="lineCov">      77891 :                         break;</span>
<span class="lineNum">    1609 </span>                :            : 
<span class="lineNum">    1610 </span>                :            :                 case GET_COL_VALUE:
<span class="lineNum">    1611 </span>                :<span class="lineCov">      72107 :                         str = value;</span>
<span class="lineNum">    1612 </span>                :<span class="lineCov">      72107 :                         break;</span>
<span class="lineNum">    1613 </span>                :            : 
<span class="lineNum">    1614 </span>                :            :                 case GET_COL_SOURCE:
<span class="lineNum">    1615 </span>  [<span class="branchCov" title="Branch 0 was taken 14595 times"> + </span><span class="branchCov" title="Branch 1 was taken 5317 times"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span><span class="branchCov" title="Branch 3 was taken 222 times"> + </span> :<span class="lineCov">      61721 :                         switch (sourcetype) {</span>
<span class="lineNum">         </span>      <span class="branchCov" title="Branch 4 was taken 170 times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span><span class="branchCov" title="Branch 6 was taken 41415 times"> + </span>]
<span class="lineNum">    1616 </span>                :            :                         case ZPROP_SRC_NONE:
<span class="lineNum">    1617 </span>                :            :                                 str = &quot;-&quot;;
<span class="lineNum">    1618 </span>                :            :                                 break;
<span class="lineNum">    1619 </span>                :            : 
<span class="lineNum">    1620 </span>                :            :                         case ZPROP_SRC_DEFAULT:
<span class="lineNum">    1621 </span>                :<span class="lineCov">      14595 :                                 str = &quot;default&quot;;</span>
<span class="lineNum">    1622 </span>                :<span class="lineCov">      14595 :                                 break;</span>
<span class="lineNum">    1623 </span>                :            : 
<span class="lineNum">    1624 </span>                :            :                         case ZPROP_SRC_LOCAL:
<span class="lineNum">    1625 </span>                :<span class="lineCov">       5317 :                                 str = &quot;local&quot;;</span>
<span class="lineNum">    1626 </span>                :<span class="lineCov">       5317 :                                 break;</span>
<span class="lineNum">    1627 </span>                :            : 
<span class="lineNum">    1628 </span>                :            :                         case ZPROP_SRC_TEMPORARY:
<span class="lineNum">    1629 </span>                :<span class="lineCov">          2 :                                 str = &quot;temporary&quot;;</span>
<span class="lineNum">    1630 </span>                :<span class="lineCov">          2 :                                 break;</span>
<span class="lineNum">    1631 </span>                :            : 
<span class="lineNum">    1632 </span>                :            :                         case ZPROP_SRC_INHERITED:
<span class="lineNum">    1633 </span>                :<span class="lineCov">        222 :                                 (void) snprintf(buf, sizeof (buf),</span>
<span class="lineNum">    1634 </span>                :            :                                     &quot;inherited from %s&quot;, source);
<span class="lineNum">    1635 </span>                :<span class="lineCov">        222 :                                 str = buf;</span>
<span class="lineNum">    1636 </span>                :<span class="lineCov">        222 :                                 break;</span>
<span class="lineNum">    1637 </span>                :            :                         case ZPROP_SRC_RECEIVED:
<span class="lineNum">    1638 </span>                :<span class="lineCov">        170 :                                 str = &quot;received&quot;;</span>
<span class="lineNum">    1639 </span>                :<span class="lineCov">        170 :                                 break;</span>
<span class="lineNum">    1640 </span>                :            : 
<span class="lineNum">    1641 </span>                :            :                         default:
<span class="lineNum">    1642 </span>                :<span class="lineNoCov">          0 :                                 str = NULL;</span>
<span class="lineNum">    1643 </span>                :<span class="lineNoCov">          0 :                                 assert(!&quot;unhandled zprop_source_t&quot;);</span>
<span class="lineNum">    1644 </span>                :            :                         }
<span class="lineNum">    1645 </span>                :            :                         break;
<span class="lineNum">    1646 </span>                :            : 
<span class="lineNum">    1647 </span>                :            :                 case GET_COL_RECVD:
<span class="lineNum">    1648 </span>        [<span class="branchCov" title="Branch 0 was taken 1 time"> + </span><span class="branchCov" title="Branch 1 was taken 3 times"> + </span>]:<span class="lineCov">          4 :                         str = (recvd_value == NULL ? &quot;-&quot; : recvd_value);</span>
<span class="lineNum">    1649 </span>                :            :                         break;
<span class="lineNum">    1650 </span>                :            : 
<span class="lineNum">    1651 </span>                :            :                 default:
<span class="lineNum">    1652 </span>                :<span class="lineCov">     232924 :                         continue;</span>
<span class="lineNum">    1653 </span>                :            :                 }
<span class="lineNum">    1654 </span>                :            : 
<span class="lineNum">    1655 </span>[<span class="branchCov" title="Branch 0 was taken 281146 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken 102814 times"> + </span><span class="branchCov" title="Branch 3 was taken 178332 times"> + </span>]:<span class="lineCov">     281146 :                 if (i == (ZFS_GET_NCOLS - 1) ||</span>
<span class="lineNum">    1656 </span>                :<span class="lineCov">     281146 :                     cbp-&gt;cb_columns[i + 1] == GET_COL_NONE)</span>
<span class="lineNum">    1657 </span>                :            :                         (void) printf(&quot;%s&quot;, str);
<span class="lineNum">    1658 </span>        [<span class="branchCov" title="Branch 0 was taken 63174 times"> + </span><span class="branchCov" title="Branch 1 was taken 115158 times"> + </span>]:<span class="lineCov">     178332 :                 else if (cbp-&gt;cb_scripted)</span>
<span class="lineNum">    1659 </span>                :            :                         (void) printf(&quot;%s\t&quot;, str);
<span class="lineNum">    1660 </span>                :            :                 else
<span class="lineNum">    1661 </span>                :<span class="lineCov">     115158 :                         (void) printf(&quot;%-*s  &quot;,</span>
<span class="lineNum">    1662 </span>                :<span class="lineCov">     115158 :                             cbp-&gt;cb_colwidths[cbp-&gt;cb_columns[i]],</span>
<span class="lineNum">    1663 </span>                :            :                             str);
<span class="lineNum">    1664 </span>                :            :         }
<span class="lineNum">    1665 </span>                :            : 
<span class="lineNum">    1666 </span>                :<span class="lineCov">     102814 :         (void) printf(&quot;\n&quot;);</span>
<span class="lineNum">    1667 </span>                :            : }
<span class="lineNum">    1668 </span>                :            : 
<span class="lineNum">    1669 </span>                :            : /*
<span class="lineNum">    1670 </span>                :            :  * Given a numeric suffix, convert the value into a number of bits that the
<span class="lineNum">    1671 </span>                :            :  * resulting value must be shifted.
<a name="1672"><span class="lineNum">    1672 </span>                :            :  */</a>
<span class="lineNum">    1673 </span>                :            : static int
<span class="lineNum">    1674 </span>                :<span class="lineCov">       2662 : str2shift(libzfs_handle_t *hdl, const char *buf)</span>
<span class="lineNum">    1675 </span>                :            : {
<span class="lineNum">    1676 </span>                :<span class="lineCov">       2662 :         const char *ends = &quot;BKMGTPEZ&quot;;</span>
<span class="lineNum">    1677 </span>                :            :         int i;
<span class="lineNum">    1678 </span>                :            : 
<span class="lineNum">    1679 </span>        [<span class="branchCov" title="Branch 0 was taken 927 times"> + </span><span class="branchCov" title="Branch 1 was taken 1735 times"> + </span>]:<span class="lineCov">       2662 :         if (buf[0] == '\0')</span>
<span class="lineNum">    1680 </span>                :            :                 return (0);
<span class="lineNum">    1681 </span>        [<span class="branchCov" title="Branch 0 was taken 2906 times"> + </span><span class="branchCov" title="Branch 1 was taken 98 times"> + </span>]:<span class="lineCov">       3004 :         for (i = 0; i &lt; strlen(ends); i++) {</span>
<span class="lineNum">    1682 </span>        [<span class="branchCov" title="Branch 1 was taken 2077 times"> + </span><span class="branchCov" title="Branch 2 was taken 829 times"> + </span>]:<span class="lineCov">       2906 :                 if (toupper(buf[0]) == ends[i])</span>
<span class="lineNum">    1683 </span>                :            :                         break;
<span class="lineNum">    1684 </span>                :            :         }
<span class="lineNum">    1685 </span>        [<span class="branchCov" title="Branch 0 was taken 98 times"> + </span><span class="branchCov" title="Branch 1 was taken 829 times"> + </span>]:<span class="lineCov">        927 :         if (i == strlen(ends)) {</span>
<span class="lineNum">    1686 </span>        [<span class="branchCov" title="Branch 0 was taken 98 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         98 :                 if (hdl)</span>
<span class="lineNum">    1687 </span>                :<span class="lineCov">         98 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1688 </span>                :            :                             &quot;invalid numeric suffix '%s'&quot;), buf);
<span class="lineNum">    1689 </span>                :            :                 return (-1);
<span class="lineNum">    1690 </span>                :            :         }
<span class="lineNum">    1691 </span>                :            : 
<span class="lineNum">    1692 </span>                :            :         /*
<span class="lineNum">    1693 </span>                :            :          * Allow 'G' = 'GB' = 'GiB', case-insensitively.
<span class="lineNum">    1694 </span>                :            :          * However, 'BB' and 'BiB' are disallowed.
<span class="lineNum">    1695 </span>                :            :          */
<span class="lineNum">    1696 </span>  [<span class="branchCov" title="Branch 0 was taken 287 times"> + </span><span class="branchCov" title="Branch 1 was taken 542 times"> + </span><span class="branchCov" title="Branch 2 was taken 63 times"> + </span><span class="branchCov" title="Branch 3 was taken 224 times"> + </span>]:<span class="lineCov">       1116 :         if (buf[1] == '\0' ||</span>
<span class="lineNum">    1697 </span>        [<span class="branchCov" title="Branch 1 was taken 41 times"> + </span><span class="branchCov" title="Branch 2 was taken 22 times"> + </span>]:<span class="lineCov">        350 :             (toupper(buf[0]) != 'B' &amp;&amp;</span>
<span class="lineNum">    1698 </span>[<span class="branchCov" title="Branch 0 was taken 4 times"> + </span><span class="branchCov" title="Branch 1 was taken 37 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 26 times"> + </span>]:<span class="lineCov">         63 :             ((toupper(buf[1]) == 'B' &amp;&amp; buf[2] == '\0') ||</span>
<span class="lineNum">    1699 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :             (toupper(buf[1]) == 'I' &amp;&amp; toupper(buf[2]) == 'B' &amp;&amp;</span>
<span class="lineNum">    1700 </span>                :<span class="lineNoCov">          0 :             buf[3] == '\0'))))</span>
<span class="lineNum">    1701 </span>                :<span class="lineCov">        579 :                 return (10 * i);</span>
<span class="lineNum">    1702 </span>                :            : 
<span class="lineNum">    1703 </span>        [<span class="branchCov" title="Branch 0 was taken 250 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        250 :         if (hdl)</span>
<span class="lineNum">    1704 </span>                :<span class="lineCov">        250 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1705 </span>                :            :                     &quot;invalid numeric suffix '%s'&quot;), buf);
<span class="lineNum">    1706 </span>                :            :         return (-1);
<span class="lineNum">    1707 </span>                :            : }
<span class="lineNum">    1708 </span>                :            : 
<span class="lineNum">    1709 </span>                :            : /*
<span class="lineNum">    1710 </span>                :            :  * Convert a string of the form '100G' into a real number.  Used when setting
<span class="lineNum">    1711 </span>                :            :  * properties or creating a volume.  'buf' is used to place an extended error
<span class="lineNum">    1712 </span>                :            :  * message for the caller to use.
<a name="1713"><span class="lineNum">    1713 </span>                :            :  */</a>
<span class="lineNum">    1714 </span>                :            : int
<span class="lineNum">    1715 </span>                :<span class="lineCov">       3130 : zfs_nicestrtonum(libzfs_handle_t *hdl, const char *value, uint64_t *num)</span>
<span class="lineNum">    1716 </span>                :            : {
<span class="lineNum">    1717 </span>                :            :         char *end;
<span class="lineNum">    1718 </span>                :            :         int shift;
<span class="lineNum">    1719 </span>                :            : 
<span class="lineNum">    1720 </span>                :<span class="lineCov">       3130 :         *num = 0;</span>
<span class="lineNum">    1721 </span>                :            : 
<span class="lineNum">    1722 </span>                :            :         /* Check to see if this looks like a number.  */
<span class="lineNum">    1723 </span>        [<span class="branchCov" title="Branch 0 was taken 468 times"> + </span><span class="branchCov" title="Branch 1 was taken 2662 times"> + </span>]:<span class="lineCov">       3130 :         if ((value[0] &lt; '0' || value[0] &gt; '9') &amp;&amp; value[0] != '.') {</span>
<span class="lineNum">    1724 </span>        [<span class="branchCov" title="Branch 0 was taken 452 times"> + </span><span class="branchCov" title="Branch 1 was taken 16 times"> + </span>]:<span class="lineCov">        468 :                 if (hdl)</span>
<span class="lineNum">    1725 </span>                :<span class="lineCov">        452 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1726 </span>                :            :                             &quot;bad numeric value '%s'&quot;), value);
<span class="lineNum">    1727 </span>                :            :                 return (-1);
<span class="lineNum">    1728 </span>                :            :         }
<span class="lineNum">    1729 </span>                :            : 
<span class="lineNum">    1730 </span>                :            :         /* Rely on strtoull() to process the numeric portion.  */
<span class="lineNum">    1731 </span>                :<span class="lineCov">       2662 :         errno = 0;</span>
<span class="lineNum">    1732 </span>                :<span class="lineCov">       2662 :         *num = strtoull(value, &amp;end, 10);</span>
<span class="lineNum">    1733 </span>                :            : 
<span class="lineNum">    1734 </span>                :            :         /*
<span class="lineNum">    1735 </span>                :            :          * Check for ERANGE, which indicates that the value is too large to fit
<span class="lineNum">    1736 </span>                :            :          * in a 64-bit value.
<span class="lineNum">    1737 </span>                :            :          */
<span class="lineNum">    1738 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 2662 times"> + </span>]:<span class="lineCov">       2662 :         if (errno == ERANGE) {</span>
<span class="lineNum">    1739 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (hdl)</span>
<span class="lineNum">    1740 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1741 </span>                :            :                             &quot;numeric value is too large&quot;));
<span class="lineNum">    1742 </span>                :            :                 return (-1);
<span class="lineNum">    1743 </span>                :            :         }
<span class="lineNum">    1744 </span>                :            : 
<span class="lineNum">    1745 </span>                :            :         /*
<span class="lineNum">    1746 </span>                :            :          * If we have a decimal value, then do the computation with floating
<span class="lineNum">    1747 </span>                :            :          * point arithmetic.  Otherwise, use standard arithmetic.
<span class="lineNum">    1748 </span>                :            :          */
<span class="lineNum">    1749 </span>        [<span class="branchCov" title="Branch 0 was taken 77 times"> + </span><span class="branchCov" title="Branch 1 was taken 2585 times"> + </span>]:<span class="lineCov">       2662 :         if (*end == '.') {</span>
<span class="lineNum">    1750 </span>                :<span class="lineCov">         77 :                 double fval = strtod(value, &amp;end);</span>
<span class="lineNum">    1751 </span>                :            : 
<span class="lineNum">    1752 </span>        [<span class="branchCov" title="Branch 1 was taken 1 time"> + </span><span class="branchCov" title="Branch 2 was taken 76 times"> + </span>]:<span class="lineCov">         77 :                 if ((shift = str2shift(hdl, end)) == -1)</span>
<span class="lineNum">    1753 </span>                :            :                         return (-1);
<span class="lineNum">    1754 </span>                :            : 
<span class="lineNum">    1755 </span>                :<span class="lineCov">          1 :                 fval *= pow(2, shift);</span>
<span class="lineNum">    1756 </span>                :            : 
<span class="lineNum">    1757 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 1 time"> + </span>]:<span class="lineCov">          1 :                 if (fval &gt; UINT64_MAX) {</span>
<span class="lineNum">    1758 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (hdl)</span>
<span class="lineNum">    1759 </span>                :<span class="lineNoCov">          0 :                                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1760 </span>                :            :                                     &quot;numeric value is too large&quot;));
<span class="lineNum">    1761 </span>                :            :                         return (-1);
<span class="lineNum">    1762 </span>                :            :                 }
<span class="lineNum">    1763 </span>                :            : 
<span class="lineNum">    1764 </span>                :<span class="lineCov">          1 :                 *num = (uint64_t)fval;</span>
<span class="lineNum">    1765 </span>                :            :         } else {
<span class="lineNum">    1766 </span>        [<span class="branchCov" title="Branch 1 was taken 2313 times"> + </span><span class="branchCov" title="Branch 2 was taken 272 times"> + </span>]:<span class="lineCov">       2585 :                 if ((shift = str2shift(hdl, end)) == -1)</span>
<span class="lineNum">    1767 </span>                :            :                         return (-1);
<span class="lineNum">    1768 </span>                :            : 
<span class="lineNum">    1769 </span>                :            :                 /* Check for overflow */
<span class="lineNum">    1770 </span>[<span class="branchCov" title="Branch 0 was taken 2301 times"> + </span><span class="branchCov" title="Branch 1 was taken 12 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 2301 times"> + </span>]:<span class="lineCov">       2313 :                 if (shift &gt;= 64 || (*num &lt;&lt; shift) &gt;&gt; shift != *num) {</span>
<span class="lineNum">    1771 </span>        [<span class="branchCov" title="Branch 0 was taken 12 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">         12 :                         if (hdl)</span>
<span class="lineNum">    1772 </span>                :<span class="lineCov">         12 :                                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1773 </span>                :            :                                     &quot;numeric value is too large&quot;));
<span class="lineNum">    1774 </span>                :            :                         return (-1);
<span class="lineNum">    1775 </span>                :            :                 }
<span class="lineNum">    1776 </span>                :            : 
<span class="lineNum">    1777 </span>                :<span class="lineCov">       2301 :                 *num &lt;&lt;= shift;</span>
<span class="lineNum">    1778 </span>                :            :         }
<span class="lineNum">    1779 </span>                :            : 
<span class="lineNum">    1780 </span>                :            :         return (0);
<span class="lineNum">    1781 </span>                :            : }
<span class="lineNum">    1782 </span>                :            : 
<span class="lineNum">    1783 </span>                :            : /*
<span class="lineNum">    1784 </span>                :            :  * Given a propname=value nvpair to set, parse any numeric properties
<span class="lineNum">    1785 </span>                :            :  * (index, boolean, etc) if they are specified as strings and add the
<span class="lineNum">    1786 </span>                :            :  * resulting nvpair to the returned nvlist.
<span class="lineNum">    1787 </span>                :            :  *
<span class="lineNum">    1788 </span>                :            :  * At the DSL layer, all properties are either 64-bit numbers or strings.
<span class="lineNum">    1789 </span>                :            :  * We want the user to be able to ignore this fact and specify properties
<span class="lineNum">    1790 </span>                :            :  * as native values (numbers, for example) or as strings (to simplify
<span class="lineNum">    1791 </span>                :            :  * command line utilities).  This also handles converting index types
<span class="lineNum">    1792 </span>                :            :  * (compression, checksum, etc) from strings to their on-disk index.
<a name="1793"><span class="lineNum">    1793 </span>                :            :  */</a>
<span class="lineNum">    1794 </span>                :            : int
<span class="lineNum">    1795 </span>                :<span class="lineCov">       8197 : zprop_parse_value(libzfs_handle_t *hdl, nvpair_t *elem, int prop,</span>
<span class="lineNum">    1796 </span>                :            :     zfs_type_t type, nvlist_t *ret, char **svalp, uint64_t *ivalp,
<span class="lineNum">    1797 </span>                :            :     const char *errbuf)
<span class="lineNum">    1798 </span>                :            : {
<span class="lineNum">    1799 </span>                :<span class="lineCov">       8197 :         data_type_t datatype = nvpair_type(elem);</span>
<span class="lineNum">    1800 </span>                :            :         zprop_type_t proptype;
<span class="lineNum">    1801 </span>                :            :         const char *propname;
<span class="lineNum">    1802 </span>                :            :         char *value;
<span class="lineNum">    1803 </span>                :<span class="lineCov">       8197 :         boolean_t isnone = B_FALSE;</span>
<span class="lineNum">    1804 </span>                :<span class="lineCov">       8197 :         int err = 0;</span>
<span class="lineNum">    1805 </span>                :            : 
<span class="lineNum">    1806 </span>        [<span class="branchCov" title="Branch 0 was taken 525 times"> + </span><span class="branchCov" title="Branch 1 was taken 7672 times"> + </span>]:<span class="lineCov">       8197 :         if (type == ZFS_TYPE_POOL) {</span>
<span class="lineNum">    1807 </span>                :<span class="lineCov">        525 :                 proptype = zpool_prop_get_type(prop);</span>
<span class="lineNum">    1808 </span>                :<span class="lineCov">        525 :                 propname = zpool_prop_to_name(prop);</span>
<span class="lineNum">    1809 </span>                :            :         } else {
<span class="lineNum">    1810 </span>                :<span class="lineCov">       7672 :                 proptype = zfs_prop_get_type(prop);</span>
<span class="lineNum">    1811 </span>                :<span class="lineCov">       7672 :                 propname = zfs_prop_to_name(prop);</span>
<span class="lineNum">    1812 </span>                :            :         }
<span class="lineNum">    1813 </span>                :            : 
<span class="lineNum">    1814 </span>                :            :         /*
<span class="lineNum">    1815 </span>                :            :          * Convert any properties to the internal DSL value types.
<span class="lineNum">    1816 </span>                :            :          */
<span class="lineNum">    1817 </span>                :<span class="lineCov">       8197 :         *svalp = NULL;</span>
<span class="lineNum">    1818 </span>                :<span class="lineCov">       8197 :         *ivalp = 0;</span>
<span class="lineNum">    1819 </span>                :            : 
<span class="lineNum">    1820 </span>  [<span class="branchCov" title="Branch 0 was taken 946 times"> + </span><span class="branchCov" title="Branch 1 was taken 2944 times"> + </span><span class="branchCov" title="Branch 2 was taken 4307 times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">       8197 :         switch (proptype) {</span>
<span class="lineNum">    1821 </span>                :            :         case PROP_TYPE_STRING:
<span class="lineNum">    1822 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 946 times"> + </span>]:<span class="lineCov">        946 :                 if (datatype != DATA_TYPE_STRING) {</span>
<span class="lineNum">    1823 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1824 </span>                :            :                             &quot;'%s' must be a string&quot;), nvpair_name(elem));
<span class="lineNum">    1825 </span>                :<span class="lineNoCov">          0 :                         goto error;</span>
<span class="lineNum">    1826 </span>                :            :                 }
<span class="lineNum">    1827 </span>                :<span class="lineCov">        946 :                 err = nvpair_value_string(elem, svalp);</span>
<span class="lineNum">    1828 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 946 times"> + </span>]:<span class="lineCov">        946 :                 if (err != 0) {</span>
<span class="lineNum">    1829 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1830 </span>                :            :                             &quot;'%s' is invalid&quot;), nvpair_name(elem));
<span class="lineNum">    1831 </span>                :<span class="lineNoCov">          0 :                         goto error;</span>
<span class="lineNum">    1832 </span>                :            :                 }
<span class="lineNum">    1833 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 946 times"> + </span>]:<span class="lineCov">        946 :                 if (strlen(*svalp) &gt;= ZFS_MAXPROPLEN) {</span>
<span class="lineNum">    1834 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1835 </span>                :            :                             &quot;'%s' is too long&quot;), nvpair_name(elem));
<span class="lineNum">    1836 </span>                :<span class="lineNoCov">          0 :                         goto error;</span>
<span class="lineNum">    1837 </span>                :            :                 }
<span class="lineNum">    1838 </span>                :            :                 break;
<span class="lineNum">    1839 </span>                :            : 
<span class="lineNum">    1840 </span>                :            :         case PROP_TYPE_NUMBER:
<span class="lineNum">    1841 </span>        [<span class="branchCov" title="Branch 0 was taken 1998 times"> + </span><span class="branchCov" title="Branch 1 was taken 946 times"> + </span>]:<span class="lineCov">       2944 :                 if (datatype == DATA_TYPE_STRING) {</span>
<span class="lineNum">    1842 </span>                :<span class="lineCov">       1998 :                         (void) nvpair_value_string(elem, &amp;value);</span>
<span class="lineNum">    1843 </span>        [<span class="branchCov" title="Branch 0 was taken 1928 times"> + </span><span class="branchCov" title="Branch 1 was taken 70 times"> + </span>]:<span class="lineCov">       1998 :                         if (strcmp(value, &quot;none&quot;) == 0) {</span>
<span class="lineNum">    1844 </span>                :            :                                 isnone = B_TRUE;
<span class="lineNum">    1845 </span>        [<span class="branchCov" title="Branch 1 was taken 1193 times"> + </span><span class="branchCov" title="Branch 2 was taken 735 times"> + </span>]:<span class="lineCov">       1928 :                         } else if (zfs_nicestrtonum(hdl, value, ivalp)</span>
<span class="lineNum">    1846 </span>                :            :                             != 0) {
<span class="lineNum">    1847 </span>                :            :                                 goto error;
<span class="lineNum">    1848 </span>                :            :                         }
<span class="lineNum">    1849 </span>        [<span class="branchCov" title="Branch 0 was taken 946 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">        946 :                 } else if (datatype == DATA_TYPE_UINT64) {</span>
<span class="lineNum">    1850 </span>                :<span class="lineCov">        946 :                         (void) nvpair_value_uint64(elem, ivalp);</span>
<span class="lineNum">    1851 </span>                :            :                 } else {
<span class="lineNum">    1852 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1853 </span>                :            :                             &quot;'%s' must be a number&quot;), nvpair_name(elem));
<span class="lineNum">    1854 </span>                :<span class="lineNoCov">          0 :                         goto error;</span>
<span class="lineNum">    1855 </span>                :            :                 }
<span class="lineNum">    1856 </span>                :            : 
<span class="lineNum">    1857 </span>                :            :                 /*
<span class="lineNum">    1858 </span>                :            :                  * Quota special: force 'none' and don't allow 0.
<span class="lineNum">    1859 </span>                :            :                  */
<span class="lineNum">    1860 </span>[<span class="branchCov" title="Branch 0 was taken 1857 times"> + </span><span class="branchCov" title="Branch 1 was taken 352 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 95 times"> + </span><span class="branchCov" title="Branch 3 was taken 1762 times"> + </span>]:<span class="lineCov">       2209 :                 if ((type &amp; ZFS_TYPE_DATASET) &amp;&amp; *ivalp == 0 &amp;&amp; !isnone &amp;&amp;</span>
<span class="lineNum">         </span>[<span class="branchCov" title="Branch 4 was taken 25 times"> + </span><span class="branchCov" title="Branch 5 was taken 70 times"> + </span>][<span class="branchCov" title="Branch 6 was taken 4 times"> + </span><span class="branchCov" title="Branch 7 was taken 21 times"> + </span>]
<span class="lineNum">    1861 </span>                :<span class="lineCov">         25 :                     (prop == ZFS_PROP_QUOTA || prop == ZFS_PROP_REFQUOTA)) {</span>
<span class="lineNum">    1862 </span>                :<span class="lineCov">          4 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1863 </span>                :            :                             &quot;use 'none' to disable quota/refquota&quot;));
<span class="lineNum">    1864 </span>                :<span class="lineCov">          4 :                         goto error;</span>
<span class="lineNum">    1865 </span>                :            :                 }
<span class="lineNum">    1866 </span>                :            : 
<span class="lineNum">    1867 </span>                :            :                 /*
<span class="lineNum">    1868 </span>                :            :                  * Special handling for &quot;*_limit=none&quot;. In this case it's not
<span class="lineNum">    1869 </span>                :            :                  * 0 but UINT64_MAX.
<span class="lineNum">    1870 </span>                :            :                  */
<span class="lineNum">    1871 </span>[<span class="branchCov" title="Branch 0 was taken 1853 times"> + </span><span class="branchCov" title="Branch 1 was taken 352 times"> + </span>][<span class="branchCov" title="Branch 2 was taken 70 times"> + </span><span class="branchCov" title="Branch 3 was taken 1783 times"> + </span>]:<span class="lineCov">       2205 :                 if ((type &amp; ZFS_TYPE_DATASET) &amp;&amp; isnone &amp;&amp;</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken 4 times"> + </span><span class="branchCov" title="Branch 5 was taken 66 times"> + </span>]
<span class="lineNum">    1872 </span>                :<span class="lineCov">         70 :                     (prop == ZFS_PROP_FILESYSTEM_LIMIT ||</span>
<span class="lineNum">    1873 </span>                :            :                     prop == ZFS_PROP_SNAPSHOT_LIMIT)) {
<span class="lineNum">    1874 </span>                :<span class="lineCov">          4 :                         *ivalp = UINT64_MAX;</span>
<span class="lineNum">    1875 </span>                :            :                 }
<span class="lineNum">    1876 </span>                :            :                 break;
<span class="lineNum">    1877 </span>                :            : 
<span class="lineNum">    1878 </span>                :            :         case PROP_TYPE_INDEX:
<span class="lineNum">    1879 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4307 times"> + </span>]:<span class="lineCov">       4307 :                 if (datatype != DATA_TYPE_STRING) {</span>
<span class="lineNum">    1880 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1881 </span>                :            :                             &quot;'%s' must be a string&quot;), nvpair_name(elem));
<span class="lineNum">    1882 </span>                :<span class="lineNoCov">          0 :                         goto error;</span>
<span class="lineNum">    1883 </span>                :            :                 }
<span class="lineNum">    1884 </span>                :            : 
<span class="lineNum">    1885 </span>                :<span class="lineCov">       4307 :                 (void) nvpair_value_string(elem, &amp;value);</span>
<span class="lineNum">    1886 </span>                :            : 
<span class="lineNum">    1887 </span>        [<span class="branchCov" title="Branch 1 was taken 815 times"> + </span><span class="branchCov" title="Branch 2 was taken 3492 times"> + </span>]:<span class="lineCov">       4307 :                 if (zprop_string_to_index(prop, value, ivalp, type) != 0) {</span>
<span class="lineNum">    1888 </span>                :<span class="lineCov">        815 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1889 </span>                :            :                             &quot;'%s' must be one of '%s'&quot;), propname,
<span class="lineNum">    1890 </span>                :            :                             zprop_values(prop, type));
<span class="lineNum">    1891 </span>                :<span class="lineCov">        815 :                         goto error;</span>
<span class="lineNum">    1892 </span>                :            :                 }
<span class="lineNum">    1893 </span>                :            :                 break;
<span class="lineNum">    1894 </span>                :            : 
<span class="lineNum">    1895 </span>                :            :         default:
<span class="lineNum">    1896 </span>                :<span class="lineNoCov">          0 :                 abort();</span>
<span class="lineNum">    1897 </span>                :            :         }
<span class="lineNum">    1898 </span>                :            : 
<span class="lineNum">    1899 </span>                :            :         /*
<span class="lineNum">    1900 </span>                :            :          * Add the result to our return set of properties.
<span class="lineNum">    1901 </span>                :            :          */
<span class="lineNum">    1902 </span>        [<span class="branchCov" title="Branch 0 was taken 946 times"> + </span><span class="branchCov" title="Branch 1 was taken 5697 times"> + </span>]:<span class="lineCov">       6643 :         if (*svalp != NULL) {</span>
<span class="lineNum">    1903 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 946 times"> + </span>]:<span class="lineCov">        946 :                 if (nvlist_add_string(ret, propname, *svalp) != 0) {</span>
<span class="lineNum">    1904 </span>                :<span class="lineNoCov">          0 :                         (void) no_memory(hdl);</span>
<span class="lineNum">    1905 </span>                :<span class="lineNoCov">          0 :                         return (-1);</span>
<span class="lineNum">    1906 </span>                :            :                 }
<span class="lineNum">    1907 </span>                :            :         } else {
<span class="lineNum">    1908 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 5697 times"> + </span>]:<span class="lineCov">       5697 :                 if (nvlist_add_uint64(ret, propname, *ivalp) != 0) {</span>
<span class="lineNum">    1909 </span>                :<span class="lineNoCov">          0 :                         (void) no_memory(hdl);</span>
<span class="lineNum">    1910 </span>                :<span class="lineNoCov">          0 :                         return (-1);</span>
<span class="lineNum">    1911 </span>                :            :                 }
<span class="lineNum">    1912 </span>                :            :         }
<span class="lineNum">    1913 </span>                :            : 
<span class="lineNum">    1914 </span>                :            :         return (0);
<span class="lineNum">    1915 </span>                :            : error:
<span class="lineNum">    1916 </span>                :<span class="lineCov">       1554 :         (void) zfs_error(hdl, EZFS_BADPROP, errbuf);</span>
<span class="lineNum">    1917 </span>                :<span class="lineCov">       1554 :         return (-1);</span>
<span class="lineNum">    1918 </span>                :            : }
<a name="1919"><span class="lineNum">    1919 </span>                :            : </a>
<span class="lineNum">    1920 </span>                :            : static int
<span class="lineNum">    1921 </span>                :<span class="lineCov">      71582 : addlist(libzfs_handle_t *hdl, char *propname, zprop_list_t **listp,</span>
<span class="lineNum">    1922 </span>                :            :     zfs_type_t type)
<span class="lineNum">    1923 </span>                :            : {
<span class="lineNum">    1924 </span>                :            :         int prop;
<span class="lineNum">    1925 </span>                :            :         zprop_list_t *entry;
<span class="lineNum">    1926 </span>                :            : 
<span class="lineNum">    1927 </span>                :<span class="lineCov">      71582 :         prop = zprop_name_to_prop(propname, type);</span>
<span class="lineNum">    1928 </span>                :            : 
<span class="lineNum">    1929 </span>[<span class="branchCov" title="Branch 0 was taken 65956 times"> + </span><span class="branchCov" title="Branch 1 was taken 5626 times"> + </span>][<span class="branchNoCov" title="Branch 3 was not taken"> - </span><span class="branchCov" title="Branch 4 was taken 65956 times"> + </span>]:<span class="lineCov">      71582 :         if (prop != ZPROP_INVAL &amp;&amp; !zprop_valid_for_type(prop, type, B_FALSE))</span>
<span class="lineNum">    1930 </span>                :<span class="lineNoCov">          0 :                 prop = ZPROP_INVAL;</span>
<span class="lineNum">    1931 </span>                :            : 
<span class="lineNum">    1932 </span>                :            :         /*
<span class="lineNum">    1933 </span>                :            :          * When no property table entry can be found, return failure if
<span class="lineNum">    1934 </span>                :            :          * this is a pool property or if this isn't a user-defined
<span class="lineNum">    1935 </span>                :            :          * dataset property,
<span class="lineNum">    1936 </span>                :            :          */
<span class="lineNum">    1937 </span>        [<span class="branchCov" title="Branch 0 was taken 5626 times"> + </span><span class="branchCov" title="Branch 1 was taken 65956 times"> + </span>]:<span class="lineCov">      71667 :         if (prop == ZPROP_INVAL &amp;&amp; ((type == ZFS_TYPE_POOL &amp;&amp;</span>
<span class="lineNum">         </span>  [<span class="branchCov" title="Branch 2 was taken 85 times"> + </span><span class="branchCov" title="Branch 3 was taken 5541 times"> + </span><span class="branchCov" title="Branch 4 was taken 9 times"> + </span><span class="branchCov" title="Branch 5 was taken 76 times"> + </span>]
<span class="lineNum">    1938 </span>        [<span class="branchCov" title="Branch 1 was taken 7 times"> + </span><span class="branchCov" title="Branch 2 was taken 2 times"> + </span>]:<span class="lineCov">         94 :             !zpool_prop_feature(propname) &amp;&amp;</span>
<span class="lineNum">    1939 </span>        [<span class="branchCov" title="Branch 1 was taken 5541 times"> + </span><span class="branchCov" title="Branch 2 was taken 83 times"> + </span>]:<span class="lineCov">       5633 :             !zpool_prop_unsupported(propname)) ||</span>
<span class="lineNum">    1940 </span>  [<span class="branchCov" title="Branch 1 was taken 5307 times"> + </span><span class="branchCov" title="Branch 2 was taken 234 times"> + </span><span class="branchCov" title="Branch 3 was taken 592 times"> + </span><span class="branchCov" title="Branch 4 was taken 4715 times"> + </span>]:<span class="lineCov">      10848 :             (type == ZFS_TYPE_DATASET &amp;&amp; !zfs_prop_user(propname) &amp;&amp;</span>
<span class="lineNum">    1941 </span>        [<span class="branchCov" title="Branch 2 was taken 571 times"> + </span><span class="branchCov" title="Branch 3 was taken 21 times"> + </span>]:<span class="lineCov">       5899 :             !zfs_prop_userquota(propname) &amp;&amp; !zfs_prop_written(propname)))) {</span>
<span class="lineNum">    1942 </span>                :<span class="lineCov">        573 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1943 </span>                :            :                     &quot;invalid property '%s'&quot;), propname);
<span class="lineNum">    1944 </span>                :<span class="lineCov">        573 :                 return (zfs_error(hdl, EZFS_BADPROP,</span>
<span class="lineNum">    1945 </span>                :<span class="lineCov">        573 :                     dgettext(TEXT_DOMAIN, &quot;bad property list&quot;)));</span>
<span class="lineNum">    1946 </span>                :            :         }
<span class="lineNum">    1947 </span>                :            : 
<span class="lineNum">    1948 </span>        [<span class="branchCov" title="Branch 1 was taken 71009 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">      71009 :         if ((entry = zfs_alloc(hdl, sizeof (zprop_list_t))) == NULL)</span>
<span class="lineNum">    1949 </span>                :            :                 return (-1);
<span class="lineNum">    1950 </span>                :            : 
<span class="lineNum">    1951 </span>                :<span class="lineCov">      71009 :         entry-&gt;pl_prop = prop;</span>
<span class="lineNum">    1952 </span>        [<span class="branchCov" title="Branch 0 was taken 5053 times"> + </span><span class="branchCov" title="Branch 1 was taken 65956 times"> + </span>]:<span class="lineCov">      71009 :         if (prop == ZPROP_INVAL) {</span>
<span class="lineNum">    1953 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken 5053 times"> + </span>]:<span class="lineCov">       5053 :                 if ((entry-&gt;pl_user_prop = zfs_strdup(hdl, propname)) ==</span>
<span class="lineNum">    1954 </span>                :            :                     NULL) {
<span class="lineNum">    1955 </span>                :<span class="lineNoCov">          0 :                         free(entry);</span>
<span class="lineNum">    1956 </span>                :<span class="lineNoCov">          0 :                         return (-1);</span>
<span class="lineNum">    1957 </span>                :            :                 }
<span class="lineNum">    1958 </span>                :<span class="lineCov">       5053 :                 entry-&gt;pl_width = strlen(propname);</span>
<span class="lineNum">    1959 </span>                :            :         } else {
<span class="lineNum">    1960 </span>                :<span class="lineCov">      65956 :                 entry-&gt;pl_width = zprop_width(prop, &amp;entry-&gt;pl_fixed,</span>
<span class="lineNum">    1961 </span>                :            :                     type);
<span class="lineNum">    1962 </span>                :            :         }
<span class="lineNum">    1963 </span>                :            : 
<span class="lineNum">    1964 </span>                :<span class="lineCov">      71009 :         *listp = entry;</span>
<span class="lineNum">    1965 </span>                :            : 
<span class="lineNum">    1966 </span>                :<span class="lineCov">      71009 :         return (0);</span>
<span class="lineNum">    1967 </span>                :            : }
<span class="lineNum">    1968 </span>                :            : 
<span class="lineNum">    1969 </span>                :            : /*
<span class="lineNum">    1970 </span>                :            :  * Given a comma-separated list of properties, construct a property list
<span class="lineNum">    1971 </span>                :            :  * containing both user-defined and native properties.  This function will
<span class="lineNum">    1972 </span>                :            :  * return a NULL list if 'all' is specified, which can later be expanded
<span class="lineNum">    1973 </span>                :            :  * by zprop_expand_list().
<a name="1974"><span class="lineNum">    1974 </span>                :            :  */</a>
<span class="lineNum">    1975 </span>                :            : int
<span class="lineNum">    1976 </span>                :<span class="lineCov">      28573 : zprop_get_list(libzfs_handle_t *hdl, char *props, zprop_list_t **listp,</span>
<span class="lineNum">    1977 </span>                :            :     zfs_type_t type)
<span class="lineNum">    1978 </span>                :            : {
<span class="lineNum">    1979 </span>                :<span class="lineCov">      28573 :         *listp = NULL;</span>
<span class="lineNum">    1980 </span>                :            : 
<span class="lineNum">    1981 </span>                :            :         /*
<span class="lineNum">    1982 </span>                :            :          * If 'all' is specified, return a NULL list.
<span class="lineNum">    1983 </span>                :            :          */
<span class="lineNum">    1984 </span>        [<span class="branchCov" title="Branch 0 was taken 28488 times"> + </span><span class="branchCov" title="Branch 1 was taken 85 times"> + </span>]:<span class="lineCov">      28573 :         if (strcmp(props, &quot;all&quot;) == 0)</span>
<span class="lineNum">    1985 </span>                :            :                 return (0);
<span class="lineNum">    1986 </span>                :            : 
<span class="lineNum">    1987 </span>                :            :         /*
<span class="lineNum">    1988 </span>                :            :          * If no props were specified, return an error.
<span class="lineNum">    1989 </span>                :            :          */
<span class="lineNum">    1990 </span>        [<span class="branchCov" title="Branch 0 was taken 28488 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">      28488 :         if (props[0] == '\0') {</span>
<span class="lineNum">    1991 </span>                :<span class="lineNoCov">          0 :                 zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1992 </span>                :            :                     &quot;no properties specified&quot;));
<span class="lineNum">    1993 </span>                :<span class="lineNoCov">          0 :                 return (zfs_error(hdl, EZFS_BADPROP, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    1994 </span>                :            :                     &quot;bad property list&quot;)));
<span class="lineNum">    1995 </span>                :            :         }
<span class="lineNum">    1996 </span>                :            : 
<span class="lineNum">    1997 </span>                :            :         /*
<span class="lineNum">    1998 </span>                :            :          * It would be nice to use getsubopt() here, but the inclusion of column
<span class="lineNum">    1999 </span>                :            :          * aliases makes this more effort than it's worth.
<span class="lineNum">    2000 </span>                :            :          */
<span class="lineNum">    2001 </span>        [<span class="branchCov" title="Branch 0 was taken 71582 times"> + </span><span class="branchCov" title="Branch 1 was taken 27915 times"> + </span>]:<span class="lineCov">      99497 :         while (*props != '\0') {</span>
<span class="lineNum">    2002 </span>                :            :                 size_t len;
<span class="lineNum">    2003 </span>                :            :                 char *p;
<span class="lineNum">    2004 </span>                :            :                 char c;
<span class="lineNum">    2005 </span>                :            : 
<span class="lineNum">    2006 </span>        [<span class="branchCov" title="Branch 0 was taken 28018 times"> + </span><span class="branchCov" title="Branch 1 was taken 43564 times"> + </span>]:<span class="lineCov">      71582 :                 if ((p = strchr(props, ',')) == NULL) {</span>
<span class="lineNum">    2007 </span>                :<span class="lineCov">      28018 :                         len = strlen(props);</span>
<span class="lineNum">    2008 </span>                :<span class="lineCov">      28018 :                         p = props + len;</span>
<span class="lineNum">    2009 </span>                :            :                 } else {
<span class="lineNum">    2010 </span>                :<span class="lineCov">      43564 :                         len = p - props;</span>
<span class="lineNum">    2011 </span>                :            :                 }
<span class="lineNum">    2012 </span>                :            : 
<span class="lineNum">    2013 </span>                :            :                 /*
<span class="lineNum">    2014 </span>                :            :                  * Check for empty options.
<span class="lineNum">    2015 </span>                :            :                  */
<span class="lineNum">    2016 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 71582 times"> + </span>]:<span class="lineCov">      71582 :                 if (len == 0) {</span>
<span class="lineNum">    2017 </span>                :<span class="lineNoCov">          0 :                         zfs_error_aux(hdl, dgettext(TEXT_DOMAIN,</span>
<span class="lineNum">    2018 </span>                :            :                             &quot;empty property name&quot;));
<span class="lineNum">    2019 </span>                :<span class="lineNoCov">          0 :                         return (zfs_error(hdl, EZFS_BADPROP,</span>
<span class="lineNum">    2020 </span>                :<span class="lineNoCov">          0 :                             dgettext(TEXT_DOMAIN, &quot;bad property list&quot;)));</span>
<span class="lineNum">    2021 </span>                :            :                 }
<span class="lineNum">    2022 </span>                :            : 
<span class="lineNum">    2023 </span>                :            :                 /*
<span class="lineNum">    2024 </span>                :            :                  * Check all regular property names.
<span class="lineNum">    2025 </span>                :            :                  */
<span class="lineNum">    2026 </span>                :<span class="lineCov">      71582 :                 c = props[len];</span>
<span class="lineNum">    2027 </span>                :<span class="lineCov">      71582 :                 props[len] = '\0';</span>
<span class="lineNum">    2028 </span>                :            : 
<span class="lineNum">    2029 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 71582 times"> + </span>]:<span class="lineCov">      71582 :                 if (strcmp(props, &quot;space&quot;) == 0) {</span>
<span class="lineNum">    2030 </span>                :            :                         static char *spaceprops[] = {
<span class="lineNum">    2031 </span>                :            :                                 &quot;name&quot;, &quot;avail&quot;, &quot;used&quot;, &quot;usedbysnapshots&quot;,
<span class="lineNum">    2032 </span>                :            :                                 &quot;usedbydataset&quot;, &quot;usedbyrefreservation&quot;,
<span class="lineNum">    2033 </span>                :            :                                 &quot;usedbychildren&quot;, NULL
<span class="lineNum">    2034 </span>                :            :                         };
<span class="lineNum">    2035 </span>                :            :                         int i;
<span class="lineNum">    2036 </span>                :            : 
<span class="lineNum">    2037 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         for (i = 0; spaceprops[i]; i++) {</span>
<span class="lineNum">    2038 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (addlist(hdl, spaceprops[i], listp, type))</span>
<span class="lineNum">    2039 </span>                :            :                                         return (-1);
<span class="lineNum">    2040 </span>                :<span class="lineNoCov">          0 :                                 listp = &amp;(*listp)-&gt;pl_next;</span>
<span class="lineNum">    2041 </span>                :            :                         }
<span class="lineNum">    2042 </span>                :            :                 } else {
<span class="lineNum">    2043 </span>        [<span class="branchCov" title="Branch 1 was taken 71009 times"> + </span><span class="branchCov" title="Branch 2 was taken 573 times"> + </span>]:<span class="lineCov">      71582 :                         if (addlist(hdl, props, listp, type))</span>
<span class="lineNum">    2044 </span>                :            :                                 return (-1);
<span class="lineNum">    2045 </span>                :<span class="lineCov">      71009 :                         listp = &amp;(*listp)-&gt;pl_next;</span>
<span class="lineNum">    2046 </span>                :            :                 }
<span class="lineNum">    2047 </span>                :            : 
<span class="lineNum">    2048 </span>                :<span class="lineCov">      71009 :                 props = p;</span>
<span class="lineNum">    2049 </span>        [<span class="branchCov" title="Branch 0 was taken 43094 times"> + </span><span class="branchCov" title="Branch 1 was taken 27915 times"> + </span>]:<span class="lineCov">      71009 :                 if (c == ',')</span>
<span class="lineNum">    2050 </span>                :<span class="lineCov">      71009 :                         props++;</span>
<span class="lineNum">    2051 </span>                :            :         }
<span class="lineNum">    2052 </span>                :            : 
<span class="lineNum">    2053 </span>                :            :         return (0);
<span class="lineNum">    2054 </span>                :            : }
<a name="2055"><span class="lineNum">    2055 </span>                :            : </a>
<span class="lineNum">    2056 </span>                :            : void
<span class="lineNum">    2057 </span>                :<span class="lineCov">      28000 : zprop_free_list(zprop_list_t *pl)</span>
<span class="lineNum">    2058 </span>                :            : {
<span class="lineNum">    2059 </span>                :            :         zprop_list_t *next;
<span class="lineNum">    2060 </span>                :            : 
<span class="lineNum">    2061 </span>        [<span class="branchCov" title="Branch 0 was taken 76518 times"> + </span><span class="branchCov" title="Branch 1 was taken 28000 times"> + </span>]:<span class="lineCov">     104518 :         while (pl != NULL) {</span>
<span class="lineNum">    2062 </span>                :<span class="lineCov">      76518 :                 next = pl-&gt;pl_next;</span>
<span class="lineNum">    2063 </span>                :<span class="lineCov">      76518 :                 free(pl-&gt;pl_user_prop);</span>
<span class="lineNum">    2064 </span>                :<span class="lineCov">      76518 :                 free(pl);</span>
<span class="lineNum">    2065 </span>                :<span class="lineCov">      76518 :                 pl = next;</span>
<span class="lineNum">    2066 </span>                :            :         }
<span class="lineNum">    2067 </span>                :<span class="lineCov">      28000 : }</span>
<span class="lineNum">    2068 </span>                :            : 
<span class="lineNum">    2069 </span>                :            : typedef struct expand_data {
<span class="lineNum">    2070 </span>                :            :         zprop_list_t    **last;
<span class="lineNum">    2071 </span>                :            :         libzfs_handle_t *hdl;
<span class="lineNum">    2072 </span>                :            :         zfs_type_t type;
<span class="lineNum">    2073 </span>                :            : } expand_data_t;
<a name="2074"><span class="lineNum">    2074 </span>                :            : </a>
<span class="lineNum">    2075 </span>                :            : int
<span class="lineNum">    2076 </span>                :<span class="lineCov">       5108 : zprop_expand_list_cb(int prop, void *cb)</span>
<span class="lineNum">    2077 </span>                :            : {
<span class="lineNum">    2078 </span>                :            :         zprop_list_t *entry;
<span class="lineNum">    2079 </span>                :<span class="lineCov">       5108 :         expand_data_t *edp = cb;</span>
<span class="lineNum">    2080 </span>                :            : 
<span class="lineNum">    2081 </span>        [<span class="branchCov" title="Branch 1 was taken 5108 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">       5108 :         if ((entry = zfs_alloc(edp-&gt;hdl, sizeof (zprop_list_t))) == NULL)</span>
<span class="lineNum">    2082 </span>                :            :                 return (ZPROP_INVAL);
<span class="lineNum">    2083 </span>                :            : 
<span class="lineNum">    2084 </span>                :<span class="lineCov">       5108 :         entry-&gt;pl_prop = prop;</span>
<span class="lineNum">    2085 </span>                :<span class="lineCov">       5108 :         entry-&gt;pl_width = zprop_width(prop, &amp;entry-&gt;pl_fixed, edp-&gt;type);</span>
<span class="lineNum">    2086 </span>                :<span class="lineCov">       5108 :         entry-&gt;pl_all = B_TRUE;</span>
<span class="lineNum">    2087 </span>                :            : 
<span class="lineNum">    2088 </span>                :<span class="lineCov">       5108 :         *(edp-&gt;last) = entry;</span>
<span class="lineNum">    2089 </span>                :<span class="lineCov">       5108 :         edp-&gt;last = &amp;entry-&gt;pl_next;</span>
<span class="lineNum">    2090 </span>                :            : 
<span class="lineNum">    2091 </span>                :<span class="lineCov">       5108 :         return (ZPROP_CONT);</span>
<span class="lineNum">    2092 </span>                :            : }
<a name="2093"><span class="lineNum">    2093 </span>                :            : </a>
<span class="lineNum">    2094 </span>                :            : int
<span class="lineNum">    2095 </span>                :<span class="lineCov">      31152 : zprop_expand_list(libzfs_handle_t *hdl, zprop_list_t **plp, zfs_type_t type)</span>
<span class="lineNum">    2096 </span>                :            : {
<span class="lineNum">    2097 </span>                :            :         zprop_list_t *entry;
<span class="lineNum">    2098 </span>                :            :         zprop_list_t **last;
<span class="lineNum">    2099 </span>                :            :         expand_data_t exp;
<span class="lineNum">    2100 </span>                :            : 
<span class="lineNum">    2101 </span>        [<span class="branchCov" title="Branch 0 was taken 75 times"> + </span><span class="branchCov" title="Branch 1 was taken 31077 times"> + </span>]:<span class="lineCov">      31152 :         if (*plp == NULL) {</span>
<span class="lineNum">    2102 </span>                :            :                 /*
<span class="lineNum">    2103 </span>                :            :                  * If this is the very first time we've been called for an 'all'
<span class="lineNum">    2104 </span>                :            :                  * specification, expand the list to include all native
<span class="lineNum">    2105 </span>                :            :                  * properties.
<span class="lineNum">    2106 </span>                :            :                  */
<span class="lineNum">    2107 </span>                :<span class="lineCov">         75 :                 last = plp;</span>
<span class="lineNum">    2108 </span>                :            : 
<span class="lineNum">    2109 </span>                :<span class="lineCov">         75 :                 exp.last = last;</span>
<span class="lineNum">    2110 </span>                :<span class="lineCov">         75 :                 exp.hdl = hdl;</span>
<span class="lineNum">    2111 </span>                :<span class="lineCov">         75 :                 exp.type = type;</span>
<span class="lineNum">    2112 </span>                :            : 
<span class="lineNum">    2113 </span>        [<span class="branchCov" title="Branch 1 was taken 75 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         75 :                 if (zprop_iter_common(zprop_expand_list_cb, &amp;exp, B_FALSE,</span>
<span class="lineNum">    2114 </span>                :            :                     B_FALSE, type) == ZPROP_INVAL)
<span class="lineNum">    2115 </span>                :            :                         return (-1);
<span class="lineNum">    2116 </span>                :            : 
<span class="lineNum">    2117 </span>                :            :                 /*
<span class="lineNum">    2118 </span>                :            :                  * Add 'name' to the beginning of the list, which is handled
<span class="lineNum">    2119 </span>                :            :                  * specially.
<span class="lineNum">    2120 </span>                :            :                  */
<span class="lineNum">    2121 </span>        [<span class="branchCov" title="Branch 1 was taken 75 times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">         75 :                 if ((entry = zfs_alloc(hdl, sizeof (zprop_list_t))) == NULL)</span>
<span class="lineNum">    2122 </span>                :            :                         return (-1);
<span class="lineNum">    2123 </span>                :            : 
<span class="lineNum">    2124 </span>        [<span class="branchCov" title="Branch 0 was taken 61 times"> + </span><span class="branchCov" title="Branch 1 was taken 14 times"> + </span>]:<span class="lineCov">         75 :                 entry-&gt;pl_prop = (type == ZFS_TYPE_POOL) ?  ZPOOL_PROP_NAME :</span>
<span class="lineNum">    2125 </span>                :            :                     ZFS_PROP_NAME;
<span class="lineNum">    2126 </span>                :<span class="lineCov">         75 :                 entry-&gt;pl_width = zprop_width(entry-&gt;pl_prop,</span>
<span class="lineNum">    2127 </span>                :            :                     &amp;entry-&gt;pl_fixed, type);
<span class="lineNum">    2128 </span>                :<span class="lineCov">         75 :                 entry-&gt;pl_all = B_TRUE;</span>
<span class="lineNum">    2129 </span>                :<span class="lineCov">         75 :                 entry-&gt;pl_next = *plp;</span>
<span class="lineNum">    2130 </span>                :<span class="lineCov">         75 :                 *plp = entry;</span>
<span class="lineNum">    2131 </span>                :            :         }
<span class="lineNum">    2132 </span>                :            :         return (0);
<span class="lineNum">    2133 </span>                :            : }
<a name="2134"><span class="lineNum">    2134 </span>                :            : </a>
<span class="lineNum">    2135 </span>                :            : int
<span class="lineNum">    2136 </span>                :<span class="lineCov">       2581 : zprop_iter(zprop_func func, void *cb, boolean_t show_all, boolean_t ordered,</span>
<span class="lineNum">    2137 </span>                :            :     zfs_type_t type)
<span class="lineNum">    2138 </span>                :            : {
<span class="lineNum">    2139 </span>                :<span class="lineCov">       2581 :         return (zprop_iter_common(func, cb, show_all, ordered, type));</span>
<span class="lineNum">    2140 </span>                :            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
