<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - zfs-0.7.0 Code Coverage - /export/home/delphix/zfs/module/zfs/zio_inject.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../../index.html">top level</a> - <a href="index.html">export/home/delphix/zfs/module/zfs</a> - zio_inject.c<span style="font-size: 80%;"> (source / <a href="zio_inject.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">zfs-0.7.0 Code Coverage</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">22</td>
            <td class="headerCovTableEntry">258</td>
            <td class="headerCovTableEntryLo">8.5 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-09-28 14:23:58</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">4</td>
            <td class="headerCovTableEntry">17</td>
            <td class="headerCovTableEntryLo">23.5 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
            | Branches:
            <span class="coverLegendCov">+</span> taken
            <span class="coverLegendNoCov">-</span> not taken
            <span class="coverLegendNoCov">#</span> not executed
</td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">6</td>
            <td class="headerCovTableEntry">220</td>
            <td class="headerCovTableEntryLo">2.7 %</td>
          </tr>
          <tr><td><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : /*</a>
<span class="lineNum">       2 </span>                :            :  * CDDL HEADER START
<span class="lineNum">       3 </span>                :            :  *
<span class="lineNum">       4 </span>                :            :  * The contents of this file are subject to the terms of the
<span class="lineNum">       5 </span>                :            :  * Common Development and Distribution License (the &quot;License&quot;).
<span class="lineNum">       6 </span>                :            :  * You may not use this file except in compliance with the License.
<span class="lineNum">       7 </span>                :            :  *
<span class="lineNum">       8 </span>                :            :  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
<span class="lineNum">       9 </span>                :            :  * or http://www.opensolaris.org/os/licensing.
<span class="lineNum">      10 </span>                :            :  * See the License for the specific language governing permissions
<span class="lineNum">      11 </span>                :            :  * and limitations under the License.
<span class="lineNum">      12 </span>                :            :  *
<span class="lineNum">      13 </span>                :            :  * When distributing Covered Code, include this CDDL HEADER in each
<span class="lineNum">      14 </span>                :            :  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.
<span class="lineNum">      15 </span>                :            :  * If applicable, add the following below this CDDL HEADER, with the
<span class="lineNum">      16 </span>                :            :  * fields enclosed by brackets &quot;[]&quot; replaced with your own identifying
<span class="lineNum">      17 </span>                :            :  * information: Portions Copyright [yyyy] [name of copyright owner]
<span class="lineNum">      18 </span>                :            :  *
<span class="lineNum">      19 </span>                :            :  * CDDL HEADER END
<span class="lineNum">      20 </span>                :            :  */
<span class="lineNum">      21 </span>                :            : /*
<span class="lineNum">      22 </span>                :            :  * Copyright (c) 2005, 2010, Oracle and/or its affiliates. All rights reserved.
<span class="lineNum">      23 </span>                :            :  * Copyright (c) 2012, 2015 by Delphix. All rights reserved.
<span class="lineNum">      24 </span>                :            :  * Copyright (c) 2017, Intel Corporation.
<span class="lineNum">      25 </span>                :            :  */
<span class="lineNum">      26 </span>                :            : 
<span class="lineNum">      27 </span>                :            : /*
<span class="lineNum">      28 </span>                :            :  * ZFS fault injection
<span class="lineNum">      29 </span>                :            :  *
<span class="lineNum">      30 </span>                :            :  * To handle fault injection, we keep track of a series of zinject_record_t
<span class="lineNum">      31 </span>                :            :  * structures which describe which logical block(s) should be injected with a
<span class="lineNum">      32 </span>                :            :  * fault.  These are kept in a global list.  Each record corresponds to a given
<span class="lineNum">      33 </span>                :            :  * spa_t and maintains a special hold on the spa_t so that it cannot be deleted
<span class="lineNum">      34 </span>                :            :  * or exported while the injection record exists.
<span class="lineNum">      35 </span>                :            :  *
<span class="lineNum">      36 </span>                :            :  * Device level injection is done using the 'zi_guid' field.  If this is set, it
<span class="lineNum">      37 </span>                :            :  * means that the error is destined for a particular device, not a piece of
<span class="lineNum">      38 </span>                :            :  * data.
<span class="lineNum">      39 </span>                :            :  *
<span class="lineNum">      40 </span>                :            :  * This is a rather poor data structure and algorithm, but we don't expect more
<span class="lineNum">      41 </span>                :            :  * than a few faults at any one time, so it should be sufficient for our needs.
<span class="lineNum">      42 </span>                :            :  */
<span class="lineNum">      43 </span>                :            : 
<span class="lineNum">      44 </span>                :            : #include &lt;sys/arc.h&gt;
<span class="lineNum">      45 </span>                :            : #include &lt;sys/zio.h&gt;
<span class="lineNum">      46 </span>                :            : #include &lt;sys/zfs_ioctl.h&gt;
<span class="lineNum">      47 </span>                :            : #include &lt;sys/vdev_impl.h&gt;
<span class="lineNum">      48 </span>                :            : #include &lt;sys/dmu_objset.h&gt;
<span class="lineNum">      49 </span>                :            : #include &lt;sys/fs/zfs.h&gt;
<span class="lineNum">      50 </span>                :            : 
<span class="lineNum">      51 </span>                :            : uint32_t zio_injection_enabled = 0;
<span class="lineNum">      52 </span>                :            : 
<span class="lineNum">      53 </span>                :            : /*
<span class="lineNum">      54 </span>                :            :  * Data describing each zinject handler registered on the system, and
<span class="lineNum">      55 </span>                :            :  * contains the list node linking the handler in the global zinject
<span class="lineNum">      56 </span>                :            :  * handler list.
<span class="lineNum">      57 </span>                :            :  */
<span class="lineNum">      58 </span>                :            : typedef struct inject_handler {
<span class="lineNum">      59 </span>                :            :         int                     zi_id;
<span class="lineNum">      60 </span>                :            :         spa_t                   *zi_spa;
<span class="lineNum">      61 </span>                :            :         zinject_record_t        zi_record;
<span class="lineNum">      62 </span>                :            :         uint64_t                *zi_lanes;
<span class="lineNum">      63 </span>                :            :         int                     zi_next_lane;
<span class="lineNum">      64 </span>                :            :         list_node_t             zi_link;
<span class="lineNum">      65 </span>                :            : } inject_handler_t;
<span class="lineNum">      66 </span>                :            : 
<span class="lineNum">      67 </span>                :            : /*
<span class="lineNum">      68 </span>                :            :  * List of all zinject handlers registered on the system, protected by
<span class="lineNum">      69 </span>                :            :  * the inject_lock defined below.
<span class="lineNum">      70 </span>                :            :  */
<span class="lineNum">      71 </span>                :            : static list_t inject_handlers;
<span class="lineNum">      72 </span>                :            : 
<span class="lineNum">      73 </span>                :            : /*
<span class="lineNum">      74 </span>                :            :  * This protects insertion into, and traversal of, the inject handler
<span class="lineNum">      75 </span>                :            :  * list defined above; as well as the inject_delay_count. Any time a
<span class="lineNum">      76 </span>                :            :  * handler is inserted or removed from the list, this lock should be
<span class="lineNum">      77 </span>                :            :  * taken as a RW_WRITER; and any time traversal is done over the list
<span class="lineNum">      78 </span>                :            :  * (without modification to it) this lock should be taken as a RW_READER.
<span class="lineNum">      79 </span>                :            :  */
<span class="lineNum">      80 </span>                :            : static krwlock_t inject_lock;
<span class="lineNum">      81 </span>                :            : 
<span class="lineNum">      82 </span>                :            : /*
<span class="lineNum">      83 </span>                :            :  * This holds the number of zinject delay handlers that have been
<span class="lineNum">      84 </span>                :            :  * registered on the system. It is protected by the inject_lock defined
<span class="lineNum">      85 </span>                :            :  * above. Thus modifications to this count must be a RW_WRITER of the
<span class="lineNum">      86 </span>                :            :  * inject_lock, and reads of this count must be (at least) a RW_READER
<span class="lineNum">      87 </span>                :            :  * of the lock.
<span class="lineNum">      88 </span>                :            :  */
<span class="lineNum">      89 </span>                :            : static int inject_delay_count = 0;
<span class="lineNum">      90 </span>                :            : 
<span class="lineNum">      91 </span>                :            : /*
<span class="lineNum">      92 </span>                :            :  * This lock is used only in zio_handle_io_delay(), refer to the comment
<span class="lineNum">      93 </span>                :            :  * in that function for more details.
<span class="lineNum">      94 </span>                :            :  */
<span class="lineNum">      95 </span>                :            : static kmutex_t inject_delay_mtx;
<span class="lineNum">      96 </span>                :            : 
<span class="lineNum">      97 </span>                :            : /*
<span class="lineNum">      98 </span>                :            :  * Used to assign unique identifying numbers to each new zinject handler.
<span class="lineNum">      99 </span>                :            :  */
<span class="lineNum">     100 </span>                :            : static int inject_next_id = 1;
<span class="lineNum">     101 </span>                :            : 
<span class="lineNum">     102 </span>                :            : /*
<span class="lineNum">     103 </span>                :            :  * Test if the requested frequency was triggered
<a name="104"><span class="lineNum">     104 </span>                :            :  */</a>
<span class="lineNum">     105 </span>                :            : static boolean_t
<span class="lineNum">     106 </span>                :<span class="lineNoCov">          0 : freq_triggered(uint32_t frequency)</span>
<span class="lineNum">     107 </span>                :            : {
<span class="lineNum">     108 </span>                :            :         /*
<span class="lineNum">     109 </span>                :            :          * zero implies always (100%)
<span class="lineNum">     110 </span>                :            :          */
<span class="lineNum">     111 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (frequency == 0)</span>
<span class="lineNum">     112 </span>                :            :                 return (B_TRUE);
<span class="lineNum">     113 </span>                :            : 
<span class="lineNum">     114 </span>                :            :         /*
<span class="lineNum">     115 </span>                :            :          * Note: we still handle legacy (unscaled) frequecy values
<span class="lineNum">     116 </span>                :            :          */
<span class="lineNum">     117 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         uint32_t maximum = (frequency &lt;= 100) ? 100 : ZI_PERCENTAGE_MAX;</span>
<span class="lineNum">     118 </span>                :            : 
<span class="lineNum">     119 </span>                :<span class="lineNoCov">          0 :         return (spa_get_random(maximum) &lt; frequency);</span>
<span class="lineNum">     120 </span>                :            : }
<span class="lineNum">     121 </span>                :            : 
<span class="lineNum">     122 </span>                :            : /*
<span class="lineNum">     123 </span>                :            :  * Returns true if the given record matches the I/O in progress.
<a name="124"><span class="lineNum">     124 </span>                :            :  */</a>
<span class="lineNum">     125 </span>                :            : static boolean_t
<span class="lineNum">     126 </span>                :<span class="lineNoCov">          0 : zio_match_handler(zbookmark_phys_t *zb, uint64_t type,</span>
<span class="lineNum">     127 </span>                :            :     zinject_record_t *record, int error)
<span class="lineNum">     128 </span>                :            : {
<span class="lineNum">     129 </span>                :            :         /*
<span class="lineNum">     130 </span>                :            :          * Check for a match against the MOS, which is based on type
<span class="lineNum">     131 </span>                :            :          */
<span class="lineNum">     132 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (zb-&gt;zb_objset == DMU_META_OBJSET &amp;&amp;</span>
<span class="lineNum">     133 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             record-&gt;zi_objset == DMU_META_OBJSET &amp;&amp;</span>
<span class="lineNum">     134 </span>                :<span class="lineNoCov">          0 :             record-&gt;zi_object == DMU_META_DNODE_OBJECT) {</span>
<span class="lineNum">     135 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (record-&gt;zi_type == DMU_OT_NONE ||</span>
<span class="lineNum">     136 </span>                :            :                     type == record-&gt;zi_type)
<span class="lineNum">     137 </span>                :<span class="lineNoCov">          0 :                         return (freq_triggered(record-&gt;zi_freq));</span>
<span class="lineNum">     138 </span>                :            :                 else
<span class="lineNum">     139 </span>                :            :                         return (B_FALSE);
<span class="lineNum">     140 </span>                :            :         }
<span class="lineNum">     141 </span>                :            : 
<span class="lineNum">     142 </span>                :            :         /*
<span class="lineNum">     143 </span>                :            :          * Check for an exact match.
<span class="lineNum">     144 </span>                :            :          */
<span class="lineNum">     145 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (zb-&gt;zb_objset == record-&gt;zi_objset &amp;&amp;</span>
<span class="lineNum">     146 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             zb-&gt;zb_object == record-&gt;zi_object &amp;&amp;</span>
<span class="lineNum">     147 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             zb-&gt;zb_level == record-&gt;zi_level &amp;&amp;</span>
<span class="lineNum">     148 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             zb-&gt;zb_blkid &gt;= record-&gt;zi_start &amp;&amp;</span>
<span class="lineNum">     149 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :             zb-&gt;zb_blkid &lt;= record-&gt;zi_end &amp;&amp;</span>
<span class="lineNum">     150 </span>                :<span class="lineNoCov">          0 :             error == record-&gt;zi_error)</span>
<span class="lineNum">     151 </span>                :<span class="lineNoCov">          0 :                 return (freq_triggered(record-&gt;zi_freq));</span>
<span class="lineNum">     152 </span>                :            : 
<span class="lineNum">     153 </span>                :            :         return (B_FALSE);
<span class="lineNum">     154 </span>                :            : }
<span class="lineNum">     155 </span>                :            : 
<span class="lineNum">     156 </span>                :            : /*
<span class="lineNum">     157 </span>                :            :  * Panic the system when a config change happens in the function
<span class="lineNum">     158 </span>                :            :  * specified by tag.
<a name="159"><span class="lineNum">     159 </span>                :            :  */</a>
<span class="lineNum">     160 </span>                :            : void
<span class="lineNum">     161 </span>                :<span class="lineNoCov">          0 : zio_handle_panic_injection(spa_t *spa, char *tag, uint64_t type)</span>
<span class="lineNum">     162 </span>                :            : {
<span class="lineNum">     163 </span>                :            :         inject_handler_t *handler;
<span class="lineNum">     164 </span>                :            : 
<span class="lineNum">     165 </span>                :<span class="lineNoCov">          0 :         rw_enter(&amp;inject_lock, RW_READER);</span>
<span class="lineNum">     166 </span>                :            : 
<span class="lineNum">     167 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (handler = list_head(&amp;inject_handlers); handler != NULL;</span>
<span class="lineNum">     168 </span>                :<span class="lineNoCov">          0 :             handler = list_next(&amp;inject_handlers, handler)) {</span>
<span class="lineNum">     169 </span>                :            : 
<span class="lineNum">     170 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (spa != handler-&gt;zi_spa)</span>
<span class="lineNum">     171 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     172 </span>                :            : 
<span class="lineNum">     173 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (handler-&gt;zi_record.zi_type == type &amp;&amp;</span>
<span class="lineNum">     174 </span>                :<span class="lineNoCov">          0 :                     strcmp(tag, handler-&gt;zi_record.zi_func) == 0)</span>
<span class="lineNum">     175 </span>                :<span class="lineNoCov">          0 :                         panic(&quot;Panic requested in function %s\n&quot;, tag);</span>
<span class="lineNum">     176 </span>                :            :         }
<span class="lineNum">     177 </span>                :            : 
<span class="lineNum">     178 </span>                :<span class="lineNoCov">          0 :         rw_exit(&amp;inject_lock);</span>
<span class="lineNum">     179 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     180 </span>                :            : 
<span class="lineNum">     181 </span>                :            : /*
<span class="lineNum">     182 </span>                :            :  * Determine if the I/O in question should return failure.  Returns the errno
<span class="lineNum">     183 </span>                :            :  * to be returned to the caller.
<a name="184"><span class="lineNum">     184 </span>                :            :  */</a>
<span class="lineNum">     185 </span>                :            : int
<span class="lineNum">     186 </span>                :<span class="lineNoCov">          0 : zio_handle_fault_injection(zio_t *zio, int error)</span>
<span class="lineNum">     187 </span>                :            : {
<span class="lineNum">     188 </span>                :<span class="lineNoCov">          0 :         int ret = 0;</span>
<span class="lineNum">     189 </span>                :            :         inject_handler_t *handler;
<span class="lineNum">     190 </span>                :            : 
<span class="lineNum">     191 </span>                :            :         /*
<span class="lineNum">     192 </span>                :            :          * Ignore I/O not associated with any logical data.
<span class="lineNum">     193 </span>                :            :          */
<span class="lineNum">     194 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (zio-&gt;io_logical == NULL)</span>
<span class="lineNum">     195 </span>                :            :                 return (0);
<span class="lineNum">     196 </span>                :            : 
<span class="lineNum">     197 </span>                :            :         /*
<span class="lineNum">     198 </span>                :            :          * Currently, we only support fault injection on reads.
<span class="lineNum">     199 </span>                :            :          */
<span class="lineNum">     200 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (zio-&gt;io_type != ZIO_TYPE_READ)</span>
<span class="lineNum">     201 </span>                :            :                 return (0);
<span class="lineNum">     202 </span>                :            : 
<span class="lineNum">     203 </span>                :<span class="lineNoCov">          0 :         rw_enter(&amp;inject_lock, RW_READER);</span>
<span class="lineNum">     204 </span>                :            : 
<span class="lineNum">     205 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (handler = list_head(&amp;inject_handlers); handler != NULL;</span>
<span class="lineNum">     206 </span>                :<span class="lineNoCov">          0 :             handler = list_next(&amp;inject_handlers, handler)) {</span>
<span class="lineNum">     207 </span>                :            : 
<span class="lineNum">     208 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (zio-&gt;io_spa != handler-&gt;zi_spa ||</span>
<span class="lineNum">     209 </span>                :<span class="lineNoCov">          0 :                     handler-&gt;zi_record.zi_cmd != ZINJECT_DATA_FAULT)</span>
<span class="lineNum">     210 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     211 </span>                :            : 
<span class="lineNum">     212 </span>                :            :                 /* If this handler matches, return EIO */
<span class="lineNum">     213 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (zio_match_handler(&amp;zio-&gt;io_logical-&gt;io_bookmark,</span>
<span class="lineNum">     214 </span>                :<span class="lineNoCov">          0 :                     zio-&gt;io_bp ? BP_GET_TYPE(zio-&gt;io_bp) : DMU_OT_NONE,</span>
<span class="lineNum">     215 </span>                :            :                     &amp;handler-&gt;zi_record, error)) {
<span class="lineNum">     216 </span>                :            :                         ret = error;
<span class="lineNum">     217 </span>                :            :                         break;
<span class="lineNum">     218 </span>                :            :                 }
<span class="lineNum">     219 </span>                :            :         }
<span class="lineNum">     220 </span>                :            : 
<span class="lineNum">     221 </span>                :<span class="lineNoCov">          0 :         rw_exit(&amp;inject_lock);</span>
<span class="lineNum">     222 </span>                :            : 
<span class="lineNum">     223 </span>                :<span class="lineNoCov">          0 :         return (ret);</span>
<span class="lineNum">     224 </span>                :            : }
<span class="lineNum">     225 </span>                :            : 
<span class="lineNum">     226 </span>                :            : /*
<span class="lineNum">     227 </span>                :            :  * Determine if the zio is part of a label update and has an injection
<span class="lineNum">     228 </span>                :            :  * handler associated with that portion of the label. Currently, we
<span class="lineNum">     229 </span>                :            :  * allow error injection in either the nvlist or the uberblock region of
<span class="lineNum">     230 </span>                :            :  * of the vdev label.
<a name="231"><span class="lineNum">     231 </span>                :            :  */</a>
<span class="lineNum">     232 </span>                :            : int
<span class="lineNum">     233 </span>                :<span class="lineNoCov">          0 : zio_handle_label_injection(zio_t *zio, int error)</span>
<span class="lineNum">     234 </span>                :            : {
<span class="lineNum">     235 </span>                :            :         inject_handler_t *handler;
<span class="lineNum">     236 </span>                :<span class="lineNoCov">          0 :         vdev_t *vd = zio-&gt;io_vd;</span>
<span class="lineNum">     237 </span>                :<span class="lineNoCov">          0 :         uint64_t offset = zio-&gt;io_offset;</span>
<span class="lineNum">     238 </span>                :            :         int label;
<span class="lineNum">     239 </span>                :<span class="lineNoCov">          0 :         int ret = 0;</span>
<span class="lineNum">     240 </span>                :            : 
<span class="lineNum">     241 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (offset &gt;= VDEV_LABEL_START_SIZE &amp;&amp;</span>
<span class="lineNum">     242 </span>                :<span class="lineNoCov">          0 :             offset &lt; vd-&gt;vdev_psize - VDEV_LABEL_END_SIZE)</span>
<span class="lineNum">     243 </span>                :            :                 return (0);
<span class="lineNum">     244 </span>                :            : 
<span class="lineNum">     245 </span>                :<span class="lineNoCov">          0 :         rw_enter(&amp;inject_lock, RW_READER);</span>
<span class="lineNum">     246 </span>                :            : 
<span class="lineNum">     247 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (handler = list_head(&amp;inject_handlers); handler != NULL;</span>
<span class="lineNum">     248 </span>                :<span class="lineNoCov">          0 :             handler = list_next(&amp;inject_handlers, handler)) {</span>
<span class="lineNum">     249 </span>                :<span class="lineNoCov">          0 :                 uint64_t start = handler-&gt;zi_record.zi_start;</span>
<span class="lineNum">     250 </span>                :<span class="lineNoCov">          0 :                 uint64_t end = handler-&gt;zi_record.zi_end;</span>
<span class="lineNum">     251 </span>                :            : 
<span class="lineNum">     252 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (handler-&gt;zi_record.zi_cmd != ZINJECT_LABEL_FAULT)</span>
<span class="lineNum">     253 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     254 </span>                :            : 
<span class="lineNum">     255 </span>                :            :                 /*
<span class="lineNum">     256 </span>                :            :                  * The injection region is the relative offsets within a
<span class="lineNum">     257 </span>                :            :                  * vdev label. We must determine the label which is being
<span class="lineNum">     258 </span>                :            :                  * updated and adjust our region accordingly.
<span class="lineNum">     259 </span>                :            :                  */
<span class="lineNum">     260 </span>                :<span class="lineNoCov">          0 :                 label = vdev_label_number(vd-&gt;vdev_psize, offset);</span>
<span class="lineNum">     261 </span>                :<span class="lineNoCov">          0 :                 start = vdev_label_offset(vd-&gt;vdev_psize, label, start);</span>
<span class="lineNum">     262 </span>                :<span class="lineNoCov">          0 :                 end = vdev_label_offset(vd-&gt;vdev_psize, label, end);</span>
<span class="lineNum">     263 </span>                :            : 
<span class="lineNum">     264 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (zio-&gt;io_vd-&gt;vdev_guid == handler-&gt;zi_record.zi_guid &amp;&amp;</span>
<span class="lineNum">     265 </span>                :<span class="lineNoCov">          0 :                     (offset &gt;= start &amp;&amp; offset &lt;= end)) {</span>
<span class="lineNum">     266 </span>                :            :                         ret = error;
<span class="lineNum">     267 </span>                :            :                         break;
<span class="lineNum">     268 </span>                :            :                 }
<span class="lineNum">     269 </span>                :            :         }
<span class="lineNum">     270 </span>                :<span class="lineNoCov">          0 :         rw_exit(&amp;inject_lock);</span>
<span class="lineNum">     271 </span>                :<span class="lineNoCov">          0 :         return (ret);</span>
<span class="lineNum">     272 </span>                :            : }
<span class="lineNum">     273 </span>                :            : 
<a name="274"><span class="lineNum">     274 </span>                :            : /*ARGSUSED*/</a>
<span class="lineNum">     275 </span>                :            : static int
<span class="lineNum">     276 </span>                :<span class="lineNoCov">          0 : zio_inject_bitflip_cb(void *data, size_t len, void *private)</span>
<span class="lineNum">     277 </span>                :            : {
<span class="lineNum">     278 </span>                :<span class="lineNoCov">          0 :         ASSERTV(zio_t *zio = private);</span>
<span class="lineNum">     279 </span>                :<span class="lineNoCov">          0 :         uint8_t *buffer = data;</span>
<span class="lineNum">     280 </span>                :<span class="lineNoCov">          0 :         uint_t byte = spa_get_random(len);</span>
<span class="lineNum">     281 </span>                :            : 
<span class="lineNum">     282 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         ASSERT(zio-&gt;io_type == ZIO_TYPE_READ);</span>
<span class="lineNum">     283 </span>                :            : 
<span class="lineNum">     284 </span>                :            :         /* flip a single random bit in an abd data buffer */
<span class="lineNum">     285 </span>                :<span class="lineNoCov">          0 :         buffer[byte] ^= 1 &lt;&lt; spa_get_random(8);</span>
<span class="lineNum">     286 </span>                :            : 
<span class="lineNum">     287 </span>                :<span class="lineNoCov">          0 :         return (1);     /* stop after first flip */</span>
<span class="lineNum">     288 </span>                :            : }
<a name="289"><span class="lineNum">     289 </span>                :            : </a>
<span class="lineNum">     290 </span>                :            : static int
<span class="lineNum">     291 </span>                :<span class="lineNoCov">          0 : zio_handle_device_injection_impl(vdev_t *vd, zio_t *zio, int err1, int err2)</span>
<span class="lineNum">     292 </span>                :            : {
<span class="lineNum">     293 </span>                :            :         inject_handler_t *handler;
<span class="lineNum">     294 </span>                :<span class="lineNoCov">          0 :         int ret = 0;</span>
<span class="lineNum">     295 </span>                :            : 
<span class="lineNum">     296 </span>                :            :         /*
<span class="lineNum">     297 </span>                :            :          * We skip over faults in the labels unless it's during
<span class="lineNum">     298 </span>                :            :          * device open (i.e. zio == NULL).
<span class="lineNum">     299 </span>                :            :          */
<span class="lineNum">     300 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (zio != NULL) {</span>
<span class="lineNum">     301 </span>                :<span class="lineNoCov">          0 :                 uint64_t offset = zio-&gt;io_offset;</span>
<span class="lineNum">     302 </span>                :            : 
<span class="lineNum">     303 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (offset &lt; VDEV_LABEL_START_SIZE ||</span>
<span class="lineNum">     304 </span>                :<span class="lineNoCov">          0 :                     offset &gt;= vd-&gt;vdev_psize - VDEV_LABEL_END_SIZE)</span>
<span class="lineNum">     305 </span>                :            :                         return (0);
<span class="lineNum">     306 </span>                :            :         }
<span class="lineNum">     307 </span>                :            : 
<span class="lineNum">     308 </span>                :<span class="lineNoCov">          0 :         rw_enter(&amp;inject_lock, RW_READER);</span>
<span class="lineNum">     309 </span>                :            : 
<span class="lineNum">     310 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (handler = list_head(&amp;inject_handlers); handler != NULL;</span>
<span class="lineNum">     311 </span>                :<span class="lineNoCov">          0 :             handler = list_next(&amp;inject_handlers, handler)) {</span>
<span class="lineNum">     312 </span>                :            : 
<span class="lineNum">     313 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (handler-&gt;zi_record.zi_cmd != ZINJECT_DEVICE_FAULT)</span>
<span class="lineNum">     314 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     315 </span>                :            : 
<span class="lineNum">     316 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (vd-&gt;vdev_guid == handler-&gt;zi_record.zi_guid) {</span>
<span class="lineNum">     317 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (handler-&gt;zi_record.zi_failfast &amp;&amp;</span>
<span class="lineNum">     318 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                             (zio == NULL || (zio-&gt;io_flags &amp;</span>
<span class="lineNum">     319 </span>                :            :                             (ZIO_FLAG_IO_RETRY | ZIO_FLAG_TRYHARD)))) {
<span class="lineNum">     320 </span>                :<span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     321 </span>                :            :                         }
<span class="lineNum">     322 </span>                :            : 
<span class="lineNum">     323 </span>                :            :                         /* Handle type specific I/O failures */
<span class="lineNum">     324 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (zio != NULL &amp;&amp;</span>
<span class="lineNum">     325 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                             handler-&gt;zi_record.zi_iotype != ZIO_TYPES &amp;&amp;</span>
<span class="lineNum">     326 </span>                :<span class="lineNoCov">          0 :                             handler-&gt;zi_record.zi_iotype != zio-&gt;io_type)</span>
<span class="lineNum">     327 </span>                :<span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     328 </span>                :            : 
<span class="lineNum">     329 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (handler-&gt;zi_record.zi_error == err1 ||</span>
<span class="lineNum">     330 </span>                :<span class="lineNoCov">          0 :                             handler-&gt;zi_record.zi_error == err2) {</span>
<span class="lineNum">     331 </span>                :            :                                 /*
<span class="lineNum">     332 </span>                :            :                                  * limit error injection if requested
<span class="lineNum">     333 </span>                :            :                                  */
<span class="lineNum">     334 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (!freq_triggered(handler-&gt;zi_record.zi_freq))</span>
<span class="lineNum">     335 </span>                :<span class="lineNoCov">          0 :                                         continue;</span>
<span class="lineNum">     336 </span>                :            : 
<span class="lineNum">     337 </span>                :            :                                 /*
<span class="lineNum">     338 </span>                :            :                                  * For a failed open, pretend like the device
<span class="lineNum">     339 </span>                :            :                                  * has gone away.
<span class="lineNum">     340 </span>                :            :                                  */
<span class="lineNum">     341 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (err1 == ENXIO)</span>
<span class="lineNum">     342 </span>                :<span class="lineNoCov">          0 :                                         vd-&gt;vdev_stat.vs_aux =</span>
<span class="lineNum">     343 </span>                :            :                                             VDEV_AUX_OPEN_FAILED;
<span class="lineNum">     344 </span>                :            : 
<span class="lineNum">     345 </span>                :            :                                 /*
<span class="lineNum">     346 </span>                :            :                                  * Treat these errors as if they had been
<span class="lineNum">     347 </span>                :            :                                  * retried so that all the appropriate stats
<span class="lineNum">     348 </span>                :            :                                  * and FMA events are generated.
<span class="lineNum">     349 </span>                :            :                                  */
<span class="lineNum">     350 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (!handler-&gt;zi_record.zi_failfast &amp;&amp;</span>
<span class="lineNum">     351 </span>                :            :                                     zio != NULL)
<span class="lineNum">     352 </span>                :<span class="lineNoCov">          0 :                                         zio-&gt;io_flags |= ZIO_FLAG_IO_RETRY;</span>
<span class="lineNum">     353 </span>                :            : 
<span class="lineNum">     354 </span>                :            :                                 /*
<span class="lineNum">     355 </span>                :            :                                  * EILSEQ means flip a bit after a read
<span class="lineNum">     356 </span>                :            :                                  */
<span class="lineNum">     357 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                 if (handler-&gt;zi_record.zi_error == EILSEQ) {</span>
<span class="lineNum">     358 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                                         if (zio == NULL)</span>
<span class="lineNum">     359 </span>                :            :                                                 break;
<span class="lineNum">     360 </span>                :            : 
<span class="lineNum">     361 </span>                :            :                                         /* locate buffer data and flip a bit */
<span class="lineNum">     362 </span>                :<span class="lineNoCov">          0 :                                         (void) abd_iterate_func(zio-&gt;io_abd, 0,</span>
<span class="lineNum">     363 </span>                :            :                                             zio-&gt;io_size, zio_inject_bitflip_cb,
<span class="lineNum">     364 </span>                :            :                                             zio);
<span class="lineNum">     365 </span>                :<span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">     366 </span>                :            :                                 }
<span class="lineNum">     367 </span>                :            : 
<span class="lineNum">     368 </span>                :<span class="lineNoCov">          0 :                                 ret = handler-&gt;zi_record.zi_error;</span>
<span class="lineNum">     369 </span>                :<span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     370 </span>                :            :                         }
<span class="lineNum">     371 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (handler-&gt;zi_record.zi_error == ENXIO) {</span>
<span class="lineNum">     372 </span>                :<span class="lineNoCov">          0 :                                 ret = SET_ERROR(EIO);</span>
<span class="lineNum">     373 </span>                :<span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     374 </span>                :            :                         }
<span class="lineNum">     375 </span>                :            :                 }
<span class="lineNum">     376 </span>                :            :         }
<span class="lineNum">     377 </span>                :            : 
<span class="lineNum">     378 </span>                :<span class="lineNoCov">          0 :         rw_exit(&amp;inject_lock);</span>
<span class="lineNum">     379 </span>                :            : 
<span class="lineNum">     380 </span>                :<span class="lineNoCov">          0 :         return (ret);</span>
<span class="lineNum">     381 </span>                :            : }
<a name="382"><span class="lineNum">     382 </span>                :            : </a>
<span class="lineNum">     383 </span>                :            : int
<span class="lineNum">     384 </span>                :<span class="lineNoCov">          0 : zio_handle_device_injection(vdev_t *vd, zio_t *zio, int error)</span>
<span class="lineNum">     385 </span>                :            : {
<span class="lineNum">     386 </span>                :<span class="lineNoCov">          0 :         return (zio_handle_device_injection_impl(vd, zio, error, INT_MAX));</span>
<span class="lineNum">     387 </span>                :            : }
<a name="388"><span class="lineNum">     388 </span>                :            : </a>
<span class="lineNum">     389 </span>                :            : int
<span class="lineNum">     390 </span>                :<span class="lineNoCov">          0 : zio_handle_device_injections(vdev_t *vd, zio_t *zio, int err1, int err2)</span>
<span class="lineNum">     391 </span>                :            : {
<span class="lineNum">     392 </span>                :<span class="lineNoCov">          0 :         return (zio_handle_device_injection_impl(vd, zio, err1, err2));</span>
<span class="lineNum">     393 </span>                :            : }
<span class="lineNum">     394 </span>                :            : 
<span class="lineNum">     395 </span>                :            : /*
<span class="lineNum">     396 </span>                :            :  * Simulate hardware that ignores cache flushes.  For requested number
<span class="lineNum">     397 </span>                :            :  * of seconds nix the actual writing to disk.
<a name="398"><span class="lineNum">     398 </span>                :            :  */</a>
<span class="lineNum">     399 </span>                :            : void
<span class="lineNum">     400 </span>                :<span class="lineNoCov">          0 : zio_handle_ignored_writes(zio_t *zio)</span>
<span class="lineNum">     401 </span>                :            : {
<span class="lineNum">     402 </span>                :            :         inject_handler_t *handler;
<span class="lineNum">     403 </span>                :            : 
<span class="lineNum">     404 </span>                :<span class="lineNoCov">          0 :         rw_enter(&amp;inject_lock, RW_READER);</span>
<span class="lineNum">     405 </span>                :            : 
<span class="lineNum">     406 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (handler = list_head(&amp;inject_handlers); handler != NULL;</span>
<span class="lineNum">     407 </span>                :<span class="lineNoCov">          0 :             handler = list_next(&amp;inject_handlers, handler)) {</span>
<span class="lineNum">     408 </span>                :            : 
<span class="lineNum">     409 </span>                :            :                 /* Ignore errors not destined for this pool */
<span class="lineNum">     410 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (zio-&gt;io_spa != handler-&gt;zi_spa ||</span>
<span class="lineNum">     411 </span>                :<span class="lineNoCov">          0 :                     handler-&gt;zi_record.zi_cmd != ZINJECT_IGNORED_WRITES)</span>
<span class="lineNum">     412 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     413 </span>                :            : 
<span class="lineNum">     414 </span>                :            :                 /*
<span class="lineNum">     415 </span>                :            :                  * Positive duration implies # of seconds, negative
<span class="lineNum">     416 </span>                :            :                  * a number of txgs
<span class="lineNum">     417 </span>                :            :                  */
<span class="lineNum">     418 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (handler-&gt;zi_record.zi_timer == 0) {</span>
<span class="lineNum">     419 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         if (handler-&gt;zi_record.zi_duration &gt; 0)</span>
<span class="lineNum">     420 </span>                :<span class="lineNoCov">          0 :                                 handler-&gt;zi_record.zi_timer = ddi_get_lbolt64();</span>
<span class="lineNum">     421 </span>                :            :                         else
<span class="lineNum">     422 </span>                :<span class="lineNoCov">          0 :                                 handler-&gt;zi_record.zi_timer = zio-&gt;io_txg;</span>
<span class="lineNum">     423 </span>                :            :                 }
<span class="lineNum">     424 </span>                :            : 
<span class="lineNum">     425 </span>                :            :                 /* Have a &quot;problem&quot; writing 60% of the time */
<span class="lineNum">     426 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (spa_get_random(100) &lt; 60)</span>
<span class="lineNum">     427 </span>                :<span class="lineNoCov">          0 :                         zio-&gt;io_pipeline &amp;= ~ZIO_VDEV_IO_STAGES;</span>
<span class="lineNum">     428 </span>                :            :                 break;
<span class="lineNum">     429 </span>                :            :         }
<span class="lineNum">     430 </span>                :            : 
<span class="lineNum">     431 </span>                :<span class="lineNoCov">          0 :         rw_exit(&amp;inject_lock);</span>
<span class="lineNum">     432 </span>                :<span class="lineNoCov">          0 : }</span>
<a name="433"><span class="lineNum">     433 </span>                :            : </a>
<span class="lineNum">     434 </span>                :            : void
<span class="lineNum">     435 </span>                :<span class="lineCov">      23751 : spa_handle_ignored_writes(spa_t *spa)</span>
<span class="lineNum">     436 </span>                :            : {
<span class="lineNum">     437 </span>                :            :         inject_handler_t *handler;
<span class="lineNum">     438 </span>                :            : 
<span class="lineNum">     439 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 23751 times"> + </span>]:<span class="lineCov">      23751 :         if (zio_injection_enabled == 0)</span>
<span class="lineNum">     440 </span>                :            :                 return;
<span class="lineNum">     441 </span>                :            : 
<span class="lineNum">     442 </span>                :<span class="lineNoCov">          0 :         rw_enter(&amp;inject_lock, RW_READER);</span>
<span class="lineNum">     443 </span>                :            : 
<span class="lineNum">     444 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (handler = list_head(&amp;inject_handlers); handler != NULL;</span>
<span class="lineNum">     445 </span>                :<span class="lineNoCov">          0 :             handler = list_next(&amp;inject_handlers, handler)) {</span>
<span class="lineNum">     446 </span>                :            : 
<span class="lineNum">     447 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (spa != handler-&gt;zi_spa ||</span>
<span class="lineNum">     448 </span>                :<span class="lineNoCov">          0 :                     handler-&gt;zi_record.zi_cmd != ZINJECT_IGNORED_WRITES)</span>
<span class="lineNum">     449 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     450 </span>                :            : 
<span class="lineNum">     451 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (handler-&gt;zi_record.zi_duration &gt; 0) {</span>
<span class="lineNum">     452 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         VERIFY(handler-&gt;zi_record.zi_timer == 0 ||</span>
<span class="lineNum">     453 </span>                :            :                             ddi_time_after64(
<span class="lineNum">     454 </span>                :            :                             (int64_t)handler-&gt;zi_record.zi_timer +
<span class="lineNum">     455 </span>                :            :                             handler-&gt;zi_record.zi_duration * hz,
<span class="lineNum">     456 </span>                :            :                             ddi_get_lbolt64()));
<span class="lineNum">     457 </span>                :            :                 } else {
<span class="lineNum">     458 </span>                :            :                         /* duration is negative so the subtraction here adds */
<span class="lineNum">     459 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         VERIFY(handler-&gt;zi_record.zi_timer == 0 ||</span>
<span class="lineNum">     460 </span>                :            :                             handler-&gt;zi_record.zi_timer -
<span class="lineNum">     461 </span>                :            :                             handler-&gt;zi_record.zi_duration &gt;=
<span class="lineNum">     462 </span>                :            :                             spa_syncing_txg(spa));
<span class="lineNum">     463 </span>                :            :                 }
<span class="lineNum">     464 </span>                :            :         }
<span class="lineNum">     465 </span>                :            : 
<span class="lineNum">     466 </span>                :<span class="lineNoCov">          0 :         rw_exit(&amp;inject_lock);</span>
<span class="lineNum">     467 </span>                :            : }
<a name="468"><span class="lineNum">     468 </span>                :            : </a>
<span class="lineNum">     469 </span>                :            : hrtime_t
<span class="lineNum">     470 </span>                :<span class="lineCov">    4104758 : zio_handle_io_delay(zio_t *zio)</span>
<span class="lineNum">     471 </span>                :            : {
<span class="lineNum">     472 </span>                :<span class="lineCov">    4104758 :         vdev_t *vd = zio-&gt;io_vd;</span>
<span class="lineNum">     473 </span>                :<span class="lineCov">    4104758 :         inject_handler_t *min_handler = NULL;</span>
<span class="lineNum">     474 </span>                :<span class="lineCov">    4104758 :         hrtime_t min_target = 0;</span>
<span class="lineNum">     475 </span>                :            :         inject_handler_t *handler;
<span class="lineNum">     476 </span>                :            :         hrtime_t idle;
<span class="lineNum">     477 </span>                :            :         hrtime_t busy;
<span class="lineNum">     478 </span>                :            :         hrtime_t target;
<span class="lineNum">     479 </span>                :            : 
<span class="lineNum">     480 </span>                :<span class="lineCov">    4104758 :         rw_enter(&amp;inject_lock, RW_READER);</span>
<span class="lineNum">     481 </span>                :            : 
<span class="lineNum">     482 </span>                :            :         /*
<span class="lineNum">     483 </span>                :            :          * inject_delay_count is a subset of zio_injection_enabled that
<span class="lineNum">     484 </span>                :            :          * is only incremented for delay handlers. These checks are
<span class="lineNum">     485 </span>                :            :          * mainly added to remind the reader why we're not explicitly
<span class="lineNum">     486 </span>                :            :          * checking zio_injection_enabled like the other functions.
<span class="lineNum">     487 </span>                :            :          */
<span class="lineNum">     488 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 4105562 times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">    4105562 :         IMPLY(inject_delay_count &gt; 0, zio_injection_enabled &gt; 0);</span>
<span class="lineNum">     489 </span>[<span class="branchCov" title="Branch 0 was taken 4105528 times"> + </span><span class="branchCov" title="Branch 1 was taken 34 times"> + </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken 4105528 times"> + </span>]:<span class="lineCov">    4105562 :         IMPLY(zio_injection_enabled == 0, inject_delay_count == 0);</span>
<span class="lineNum">     490 </span>                :            : 
<span class="lineNum">     491 </span>                :            :         /*
<span class="lineNum">     492 </span>                :            :          * If there aren't any inject delay handlers registered, then we
<span class="lineNum">     493 </span>                :            :          * can short circuit and simply return 0 here. A value of zero
<span class="lineNum">     494 </span>                :            :          * informs zio_delay_interrupt() that this request should not be
<span class="lineNum">     495 </span>                :            :          * delayed. This short circuit keeps us from acquiring the
<span class="lineNum">     496 </span>                :            :          * inject_delay_mutex unnecessarily.
<span class="lineNum">     497 </span>                :            :          */
<span class="lineNum">     498 </span>        [<span class="branchCov" title="Branch 0 was taken 4105562 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">    4105562 :         if (inject_delay_count == 0) {</span>
<span class="lineNum">     499 </span>                :<span class="lineCov">    4105562 :                 rw_exit(&amp;inject_lock);</span>
<span class="lineNum">     500 </span>                :<span class="lineCov">    4105608 :                 return (0);</span>
<span class="lineNum">     501 </span>                :            :         }
<span class="lineNum">     502 </span>                :            : 
<span class="lineNum">     503 </span>                :            :         /*
<span class="lineNum">     504 </span>                :            :          * Each inject handler has a number of &quot;lanes&quot; associated with
<span class="lineNum">     505 </span>                :            :          * it. Each lane is able to handle requests independently of one
<span class="lineNum">     506 </span>                :            :          * another, and at a latency defined by the inject handler
<span class="lineNum">     507 </span>                :            :          * record's zi_timer field. Thus if a handler in configured with
<span class="lineNum">     508 </span>                :            :          * a single lane with a 10ms latency, it will delay requests
<span class="lineNum">     509 </span>                :            :          * such that only a single request is completed every 10ms. So,
<span class="lineNum">     510 </span>                :            :          * if more than one request is attempted per each 10ms interval,
<span class="lineNum">     511 </span>                :            :          * the average latency of the requests will be greater than
<span class="lineNum">     512 </span>                :            :          * 10ms; but if only a single request is submitted each 10ms
<span class="lineNum">     513 </span>                :            :          * interval the average latency will be 10ms.
<span class="lineNum">     514 </span>                :            :          *
<span class="lineNum">     515 </span>                :            :          * We need to acquire this mutex to prevent multiple concurrent
<span class="lineNum">     516 </span>                :            :          * threads being assigned to the same lane of a given inject
<span class="lineNum">     517 </span>                :            :          * handler. The mutex allows us to perform the following two
<span class="lineNum">     518 </span>                :            :          * operations atomically:
<span class="lineNum">     519 </span>                :            :          *
<span class="lineNum">     520 </span>                :            :          *      1. determine the minimum handler and minimum target
<span class="lineNum">     521 </span>                :            :          *         value of all the possible handlers
<span class="lineNum">     522 </span>                :            :          *      2. update that minimum handler's lane array
<span class="lineNum">     523 </span>                :            :          *
<span class="lineNum">     524 </span>                :            :          * Without atomicity, two (or more) threads could pick the same
<span class="lineNum">     525 </span>                :            :          * lane in step (1), and then conflict with each other in step
<span class="lineNum">     526 </span>                :            :          * (2). This could allow a single lane handler to process
<span class="lineNum">     527 </span>                :            :          * multiple requests simultaneously, which shouldn't be possible.
<span class="lineNum">     528 </span>                :            :          */
<span class="lineNum">     529 </span>                :<span class="lineNoCov">          0 :         mutex_enter(&amp;inject_delay_mtx);</span>
<span class="lineNum">     530 </span>                :            : 
<span class="lineNum">     531 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (handler = list_head(&amp;inject_handlers);</span>
<span class="lineNum">     532 </span>                :<span class="lineNoCov">          0 :             handler != NULL; handler = list_next(&amp;inject_handlers, handler)) {</span>
<span class="lineNum">     533 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (handler-&gt;zi_record.zi_cmd != ZINJECT_DELAY_IO)</span>
<span class="lineNum">     534 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     535 </span>                :            : 
<span class="lineNum">     536 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (!freq_triggered(handler-&gt;zi_record.zi_freq))</span>
<span class="lineNum">     537 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     538 </span>                :            : 
<span class="lineNum">     539 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (vd-&gt;vdev_guid != handler-&gt;zi_record.zi_guid)</span>
<span class="lineNum">     540 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     541 </span>                :            : 
<span class="lineNum">     542 </span>                :            :                 /*
<span class="lineNum">     543 </span>                :            :                  * Defensive; should never happen as the array allocation
<span class="lineNum">     544 </span>                :            :                  * occurs prior to inserting this handler on the list.
<span class="lineNum">     545 </span>                :            :                  */
<span class="lineNum">     546 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3P(handler-&gt;zi_lanes, !=, NULL);</span>
<span class="lineNum">     547 </span>                :            : 
<span class="lineNum">     548 </span>                :            :                 /*
<span class="lineNum">     549 </span>                :            :                  * This should never happen, the zinject command should
<span class="lineNum">     550 </span>                :            :                  * prevent a user from setting an IO delay with zero lanes.
<span class="lineNum">     551 </span>                :            :                  */
<span class="lineNum">     552 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3U(handler-&gt;zi_record.zi_nlanes, !=, 0);</span>
<span class="lineNum">     553 </span>                :            : 
<span class="lineNum">     554 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3U(handler-&gt;zi_record.zi_nlanes, &gt;,</span>
<span class="lineNum">     555 </span>                :            :                     handler-&gt;zi_next_lane);
<span class="lineNum">     556 </span>                :            : 
<span class="lineNum">     557 </span>                :            :                 /*
<span class="lineNum">     558 </span>                :            :                  * We want to issue this IO to the lane that will become
<span class="lineNum">     559 </span>                :            :                  * idle the soonest, so we compare the soonest this
<span class="lineNum">     560 </span>                :            :                  * specific handler can complete the IO with all other
<span class="lineNum">     561 </span>                :            :                  * handlers, to find the lowest value of all possible
<span class="lineNum">     562 </span>                :            :                  * lanes. We then use this lane to submit the request.
<span class="lineNum">     563 </span>                :            :                  *
<span class="lineNum">     564 </span>                :            :                  * Since each handler has a constant value for its
<span class="lineNum">     565 </span>                :            :                  * delay, we can just use the &quot;next&quot; lane for that
<span class="lineNum">     566 </span>                :            :                  * handler; as it will always be the lane with the
<span class="lineNum">     567 </span>                :            :                  * lowest value for that particular handler (i.e. the
<span class="lineNum">     568 </span>                :            :                  * lane that will become idle the soonest). This saves a
<span class="lineNum">     569 </span>                :            :                  * scan of each handler's lanes array.
<span class="lineNum">     570 </span>                :            :                  *
<span class="lineNum">     571 </span>                :            :                  * There's two cases to consider when determining when
<span class="lineNum">     572 </span>                :            :                  * this specific IO request should complete. If this
<span class="lineNum">     573 </span>                :            :                  * lane is idle, we want to &quot;submit&quot; the request now so
<span class="lineNum">     574 </span>                :            :                  * it will complete after zi_timer milliseconds. Thus,
<span class="lineNum">     575 </span>                :            :                  * we set the target to now + zi_timer.
<span class="lineNum">     576 </span>                :            :                  *
<span class="lineNum">     577 </span>                :            :                  * If the lane is busy, we want this request to complete
<span class="lineNum">     578 </span>                :            :                  * zi_timer milliseconds after the lane becomes idle.
<span class="lineNum">     579 </span>                :            :                  * Since the 'zi_lanes' array holds the time at which
<span class="lineNum">     580 </span>                :            :                  * each lane will become idle, we use that value to
<span class="lineNum">     581 </span>                :            :                  * determine when this request should complete.
<span class="lineNum">     582 </span>                :            :                  */
<span class="lineNum">     583 </span>                :<span class="lineNoCov">          0 :                 idle = handler-&gt;zi_record.zi_timer + gethrtime();</span>
<span class="lineNum">     584 </span>                :<span class="lineNoCov">          0 :                 busy = handler-&gt;zi_record.zi_timer +</span>
<span class="lineNum">     585 </span>                :<span class="lineNoCov">          0 :                     handler-&gt;zi_lanes[handler-&gt;zi_next_lane];</span>
<span class="lineNum">     586 </span>                :<span class="lineNoCov">          0 :                 target = MAX(idle, busy);</span>
<span class="lineNum">     587 </span>                :            : 
<span class="lineNum">     588 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (min_handler == NULL) {</span>
<span class="lineNum">     589 </span>                :<span class="lineNoCov">          0 :                         min_handler = handler;</span>
<span class="lineNum">     590 </span>                :<span class="lineNoCov">          0 :                         min_target = target;</span>
<span class="lineNum">     591 </span>                :<span class="lineNoCov">          0 :                         continue;</span>
<span class="lineNum">     592 </span>                :            :                 }
<span class="lineNum">     593 </span>                :            : 
<span class="lineNum">     594 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3P(min_handler, !=, NULL);</span>
<span class="lineNum">     595 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3U(min_target, !=, 0);</span>
<span class="lineNum">     596 </span>                :            : 
<span class="lineNum">     597 </span>                :            :                 /*
<span class="lineNum">     598 </span>                :            :                  * We don't yet increment the &quot;next lane&quot; variable since
<span class="lineNum">     599 </span>                :            :                  * we still might find a lower value lane in another
<span class="lineNum">     600 </span>                :            :                  * handler during any remaining iterations. Once we're
<span class="lineNum">     601 </span>                :            :                  * sure we've selected the absolute minimum, we'll claim
<span class="lineNum">     602 </span>                :            :                  * the lane and increment the handler's &quot;next lane&quot;
<span class="lineNum">     603 </span>                :            :                  * field below.
<span class="lineNum">     604 </span>                :            :                  */
<span class="lineNum">     605 </span>                :            : 
<span class="lineNum">     606 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (target &lt; min_target) {</span>
<span class="lineNum">     607 </span>                :<span class="lineNoCov">          0 :                         min_handler = handler;</span>
<span class="lineNum">     608 </span>                :<span class="lineNoCov">          0 :                         min_target = target;</span>
<span class="lineNum">     609 </span>                :            :                 }
<span class="lineNum">     610 </span>                :            :         }
<span class="lineNum">     611 </span>                :            : 
<span class="lineNum">     612 </span>                :            :         /*
<span class="lineNum">     613 </span>                :            :          * 'min_handler' will be NULL if no IO delays are registered for
<span class="lineNum">     614 </span>                :            :          * this vdev, otherwise it will point to the handler containing
<span class="lineNum">     615 </span>                :            :          * the lane that will become idle the soonest.
<span class="lineNum">     616 </span>                :            :          */
<span class="lineNum">     617 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (min_handler != NULL) {</span>
<span class="lineNum">     618 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3U(min_target, !=, 0);</span>
<span class="lineNum">     619 </span>                :<span class="lineNoCov">          0 :                 min_handler-&gt;zi_lanes[min_handler-&gt;zi_next_lane] = min_target;</span>
<span class="lineNum">     620 </span>                :            : 
<span class="lineNum">     621 </span>                :            :                 /*
<span class="lineNum">     622 </span>                :            :                  * If we've used all possible lanes for this handler,
<span class="lineNum">     623 </span>                :            :                  * loop back and start using the first lane again;
<span class="lineNum">     624 </span>                :            :                  * otherwise, just increment the lane index.
<span class="lineNum">     625 </span>                :            :                  */
<span class="lineNum">     626 </span>                :<span class="lineNoCov">          0 :                 min_handler-&gt;zi_next_lane = (min_handler-&gt;zi_next_lane + 1) %</span>
<span class="lineNum">     627 </span>                :<span class="lineNoCov">          0 :                     min_handler-&gt;zi_record.zi_nlanes;</span>
<span class="lineNum">     628 </span>                :            :         }
<span class="lineNum">     629 </span>                :            : 
<span class="lineNum">     630 </span>                :<span class="lineNoCov">          0 :         mutex_exit(&amp;inject_delay_mtx);</span>
<span class="lineNum">     631 </span>                :<span class="lineNoCov">          0 :         rw_exit(&amp;inject_lock);</span>
<span class="lineNum">     632 </span>                :            : 
<span class="lineNum">     633 </span>                :<span class="lineNoCov">          0 :         return (min_target);</span>
<span class="lineNum">     634 </span>                :            : }
<span class="lineNum">     635 </span>                :            : 
<span class="lineNum">     636 </span>                :            : /*
<span class="lineNum">     637 </span>                :            :  * Create a new handler for the given record.  We add it to the list, adding
<span class="lineNum">     638 </span>                :            :  * a reference to the spa_t in the process.  We increment zio_injection_enabled,
<span class="lineNum">     639 </span>                :            :  * which is the switch to trigger all fault injection.
<a name="640"><span class="lineNum">     640 </span>                :            :  */</a>
<span class="lineNum">     641 </span>                :            : int
<span class="lineNum">     642 </span>                :<span class="lineNoCov">          0 : zio_inject_fault(char *name, int flags, int *id, zinject_record_t *record)</span>
<span class="lineNum">     643 </span>                :            : {
<span class="lineNum">     644 </span>                :            :         inject_handler_t *handler;
<span class="lineNum">     645 </span>                :            :         int error;
<span class="lineNum">     646 </span>                :            :         spa_t *spa;
<span class="lineNum">     647 </span>                :            : 
<span class="lineNum">     648 </span>                :            :         /*
<span class="lineNum">     649 </span>                :            :          * If this is pool-wide metadata, make sure we unload the corresponding
<span class="lineNum">     650 </span>                :            :          * spa_t, so that the next attempt to load it will trigger the fault.
<span class="lineNum">     651 </span>                :            :          * We call spa_reset() to unload the pool appropriately.
<span class="lineNum">     652 </span>                :            :          */
<span class="lineNum">     653 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (flags &amp; ZINJECT_UNLOAD_SPA)</span>
<span class="lineNum">     654 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if ((error = spa_reset(name)) != 0)</span>
<span class="lineNum">     655 </span>                :            :                         return (error);
<span class="lineNum">     656 </span>                :            : 
<span class="lineNum">     657 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (record-&gt;zi_cmd == ZINJECT_DELAY_IO) {</span>
<span class="lineNum">     658 </span>                :            :                 /*
<span class="lineNum">     659 </span>                :            :                  * A value of zero for the number of lanes or for the
<span class="lineNum">     660 </span>                :            :                  * delay time doesn't make sense.
<span class="lineNum">     661 </span>                :            :                  */
<span class="lineNum">     662 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (record-&gt;zi_timer == 0 || record-&gt;zi_nlanes == 0)</span>
<span class="lineNum">     663 </span>                :<span class="lineNoCov">          0 :                         return (SET_ERROR(EINVAL));</span>
<span class="lineNum">     664 </span>                :            : 
<span class="lineNum">     665 </span>                :            :                 /*
<span class="lineNum">     666 </span>                :            :                  * The number of lanes is directly mapped to the size of
<span class="lineNum">     667 </span>                :            :                  * an array used by the handler. Thus, to ensure the
<span class="lineNum">     668 </span>                :            :                  * user doesn't trigger an allocation that's &quot;too large&quot;
<span class="lineNum">     669 </span>                :            :                  * we cap the number of lanes here.
<span class="lineNum">     670 </span>                :            :                  */
<span class="lineNum">     671 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (record-&gt;zi_nlanes &gt;= UINT16_MAX)</span>
<span class="lineNum">     672 </span>                :<span class="lineNoCov">          0 :                         return (SET_ERROR(EINVAL));</span>
<span class="lineNum">     673 </span>                :            :         }
<span class="lineNum">     674 </span>                :            : 
<span class="lineNum">     675 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (!(flags &amp; ZINJECT_NULL)) {</span>
<span class="lineNum">     676 </span>                :            :                 /*
<span class="lineNum">     677 </span>                :            :                  * spa_inject_ref() will add an injection reference, which will
<span class="lineNum">     678 </span>                :            :                  * prevent the pool from being removed from the namespace while
<span class="lineNum">     679 </span>                :            :                  * still allowing it to be unloaded.
<span class="lineNum">     680 </span>                :            :                  */
<span class="lineNum">     681 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if ((spa = spa_inject_addref(name)) == NULL)</span>
<span class="lineNum">     682 </span>                :<span class="lineNoCov">          0 :                         return (SET_ERROR(ENOENT));</span>
<span class="lineNum">     683 </span>                :            : 
<span class="lineNum">     684 </span>                :<span class="lineNoCov">          0 :                 handler = kmem_alloc(sizeof (inject_handler_t), KM_SLEEP);</span>
<span class="lineNum">     685 </span>                :            : 
<span class="lineNum">     686 </span>                :<span class="lineNoCov">          0 :                 handler-&gt;zi_spa = spa;</span>
<span class="lineNum">     687 </span>                :<span class="lineNoCov">          0 :                 handler-&gt;zi_record = *record;</span>
<span class="lineNum">     688 </span>                :            : 
<span class="lineNum">     689 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (handler-&gt;zi_record.zi_cmd == ZINJECT_DELAY_IO) {</span>
<span class="lineNum">     690 </span>                :<span class="lineNoCov">          0 :                         handler-&gt;zi_lanes = kmem_zalloc(</span>
<span class="lineNum">     691 </span>                :            :                             sizeof (*handler-&gt;zi_lanes) *
<span class="lineNum">     692 </span>                :            :                             handler-&gt;zi_record.zi_nlanes, KM_SLEEP);
<span class="lineNum">     693 </span>                :<span class="lineNoCov">          0 :                         handler-&gt;zi_next_lane = 0;</span>
<span class="lineNum">     694 </span>                :            :                 } else {
<span class="lineNum">     695 </span>                :<span class="lineNoCov">          0 :                         handler-&gt;zi_lanes = NULL;</span>
<span class="lineNum">     696 </span>                :<span class="lineNoCov">          0 :                         handler-&gt;zi_next_lane = 0;</span>
<span class="lineNum">     697 </span>                :            :                 }
<span class="lineNum">     698 </span>                :            : 
<span class="lineNum">     699 </span>                :<span class="lineNoCov">          0 :                 rw_enter(&amp;inject_lock, RW_WRITER);</span>
<span class="lineNum">     700 </span>                :            : 
<span class="lineNum">     701 </span>                :            :                 /*
<span class="lineNum">     702 </span>                :            :                  * We can't move this increment into the conditional
<span class="lineNum">     703 </span>                :            :                  * above because we need to hold the RW_WRITER lock of
<span class="lineNum">     704 </span>                :            :                  * inject_lock, and we don't want to hold that while
<span class="lineNum">     705 </span>                :            :                  * allocating the handler's zi_lanes array.
<span class="lineNum">     706 </span>                :            :                  */
<span class="lineNum">     707 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (handler-&gt;zi_record.zi_cmd == ZINJECT_DELAY_IO) {</span>
<span class="lineNum">     708 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         ASSERT3S(inject_delay_count, &gt;=, 0);</span>
<span class="lineNum">     709 </span>                :<span class="lineNoCov">          0 :                         inject_delay_count++;</span>
<span class="lineNum">     710 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                         ASSERT3S(inject_delay_count, &gt;, 0);</span>
<span class="lineNum">     711 </span>                :            :                 }
<span class="lineNum">     712 </span>                :            : 
<span class="lineNum">     713 </span>                :<span class="lineNoCov">          0 :                 *id = handler-&gt;zi_id = inject_next_id++;</span>
<span class="lineNum">     714 </span>                :<span class="lineNoCov">          0 :                 list_insert_tail(&amp;inject_handlers, handler);</span>
<span class="lineNum">     715 </span>                :<span class="lineNoCov">          0 :                 atomic_inc_32(&amp;zio_injection_enabled);</span>
<span class="lineNum">     716 </span>                :            : 
<span class="lineNum">     717 </span>                :<span class="lineNoCov">          0 :                 rw_exit(&amp;inject_lock);</span>
<span class="lineNum">     718 </span>                :            :         }
<span class="lineNum">     719 </span>                :            : 
<span class="lineNum">     720 </span>                :            :         /*
<span class="lineNum">     721 </span>                :            :          * Flush the ARC, so that any attempts to read this data will end up
<span class="lineNum">     722 </span>                :            :          * going to the ZIO layer.  Note that this is a little overkill, but
<span class="lineNum">     723 </span>                :            :          * we don't have the necessary ARC interfaces to do anything else, and
<span class="lineNum">     724 </span>                :            :          * fault injection isn't a performance critical path.
<span class="lineNum">     725 </span>                :            :          */
<span class="lineNum">     726 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (flags &amp; ZINJECT_FLUSH_ARC)</span>
<span class="lineNum">     727 </span>                :            :                 /*
<span class="lineNum">     728 </span>                :            :                  * We must use FALSE to ensure arc_flush returns, since
<span class="lineNum">     729 </span>                :            :                  * we're not preventing concurrent ARC insertions.
<span class="lineNum">     730 </span>                :            :                  */
<span class="lineNum">     731 </span>                :<span class="lineNoCov">          0 :                 arc_flush(NULL, FALSE);</span>
<span class="lineNum">     732 </span>                :            : 
<span class="lineNum">     733 </span>                :            :         return (0);
<span class="lineNum">     734 </span>                :            : }
<span class="lineNum">     735 </span>                :            : 
<span class="lineNum">     736 </span>                :            : /*
<span class="lineNum">     737 </span>                :            :  * Returns the next record with an ID greater than that supplied to the
<span class="lineNum">     738 </span>                :            :  * function.  Used to iterate over all handlers in the system.
<a name="739"><span class="lineNum">     739 </span>                :            :  */</a>
<span class="lineNum">     740 </span>                :            : int
<span class="lineNum">     741 </span>                :<span class="lineNoCov">          0 : zio_inject_list_next(int *id, char *name, size_t buflen,</span>
<span class="lineNum">     742 </span>                :            :     zinject_record_t *record)
<span class="lineNum">     743 </span>                :            : {
<span class="lineNum">     744 </span>                :            :         inject_handler_t *handler;
<span class="lineNum">     745 </span>                :            :         int ret;
<span class="lineNum">     746 </span>                :            : 
<span class="lineNum">     747 </span>                :<span class="lineNoCov">          0 :         mutex_enter(&amp;spa_namespace_lock);</span>
<span class="lineNum">     748 </span>                :<span class="lineNoCov">          0 :         rw_enter(&amp;inject_lock, RW_READER);</span>
<span class="lineNum">     749 </span>                :            : 
<span class="lineNum">     750 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (handler = list_head(&amp;inject_handlers); handler != NULL;</span>
<span class="lineNum">     751 </span>                :<span class="lineNoCov">          0 :             handler = list_next(&amp;inject_handlers, handler))</span>
<span class="lineNum">     752 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (handler-&gt;zi_id &gt; *id)</span>
<span class="lineNum">     753 </span>                :            :                         break;
<span class="lineNum">     754 </span>                :            : 
<span class="lineNum">     755 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (handler) {</span>
<span class="lineNum">     756 </span>                :<span class="lineNoCov">          0 :                 *record = handler-&gt;zi_record;</span>
<span class="lineNum">     757 </span>                :<span class="lineNoCov">          0 :                 *id = handler-&gt;zi_id;</span>
<span class="lineNum">     758 </span>                :<span class="lineNoCov">          0 :                 (void) strncpy(name, spa_name(handler-&gt;zi_spa), buflen);</span>
<span class="lineNum">     759 </span>                :<span class="lineNoCov">          0 :                 ret = 0;</span>
<span class="lineNum">     760 </span>                :            :         } else {
<span class="lineNum">     761 </span>                :<span class="lineNoCov">          0 :                 ret = SET_ERROR(ENOENT);</span>
<span class="lineNum">     762 </span>                :            :         }
<span class="lineNum">     763 </span>                :            : 
<span class="lineNum">     764 </span>                :<span class="lineNoCov">          0 :         rw_exit(&amp;inject_lock);</span>
<span class="lineNum">     765 </span>                :<span class="lineNoCov">          0 :         mutex_exit(&amp;spa_namespace_lock);</span>
<span class="lineNum">     766 </span>                :            : 
<span class="lineNum">     767 </span>                :<span class="lineNoCov">          0 :         return (ret);</span>
<span class="lineNum">     768 </span>                :            : }
<span class="lineNum">     769 </span>                :            : 
<span class="lineNum">     770 </span>                :            : /*
<span class="lineNum">     771 </span>                :            :  * Clear the fault handler with the given identifier, or return ENOENT if none
<span class="lineNum">     772 </span>                :            :  * exists.
<a name="773"><span class="lineNum">     773 </span>                :            :  */</a>
<span class="lineNum">     774 </span>                :            : int
<span class="lineNum">     775 </span>                :<span class="lineNoCov">          0 : zio_clear_fault(int id)</span>
<span class="lineNum">     776 </span>                :            : {
<span class="lineNum">     777 </span>                :            :         inject_handler_t *handler;
<span class="lineNum">     778 </span>                :            : 
<span class="lineNum">     779 </span>                :<span class="lineNoCov">          0 :         rw_enter(&amp;inject_lock, RW_WRITER);</span>
<span class="lineNum">     780 </span>                :            : 
<span class="lineNum">     781 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for (handler = list_head(&amp;inject_handlers); handler != NULL;</span>
<span class="lineNum">     782 </span>                :<span class="lineNoCov">          0 :             handler = list_next(&amp;inject_handlers, handler))</span>
<span class="lineNum">     783 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 if (handler-&gt;zi_id == id)</span>
<span class="lineNum">     784 </span>                :            :                         break;
<span class="lineNum">     785 </span>                :            : 
<span class="lineNum">     786 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (handler == NULL) {</span>
<span class="lineNum">     787 </span>                :<span class="lineNoCov">          0 :                 rw_exit(&amp;inject_lock);</span>
<span class="lineNum">     788 </span>                :<span class="lineNoCov">          0 :                 return (SET_ERROR(ENOENT));</span>
<span class="lineNum">     789 </span>                :            :         }
<span class="lineNum">     790 </span>                :            : 
<span class="lineNum">     791 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (handler-&gt;zi_record.zi_cmd == ZINJECT_DELAY_IO) {</span>
<span class="lineNum">     792 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3S(inject_delay_count, &gt;, 0);</span>
<span class="lineNum">     793 </span>                :<span class="lineNoCov">          0 :                 inject_delay_count--;</span>
<span class="lineNum">     794 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3S(inject_delay_count, &gt;=, 0);</span>
<span class="lineNum">     795 </span>                :            :         }
<span class="lineNum">     796 </span>                :            : 
<span class="lineNum">     797 </span>                :<span class="lineNoCov">          0 :         list_remove(&amp;inject_handlers, handler);</span>
<span class="lineNum">     798 </span>                :<span class="lineNoCov">          0 :         rw_exit(&amp;inject_lock);</span>
<span class="lineNum">     799 </span>                :            : 
<span class="lineNum">     800 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (handler-&gt;zi_record.zi_cmd == ZINJECT_DELAY_IO) {</span>
<span class="lineNum">     801 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3P(handler-&gt;zi_lanes, !=, NULL);</span>
<span class="lineNum">     802 </span>                :<span class="lineNoCov">          0 :                 kmem_free(handler-&gt;zi_lanes, sizeof (*handler-&gt;zi_lanes) *</span>
<span class="lineNum">     803 </span>                :            :                     handler-&gt;zi_record.zi_nlanes);
<span class="lineNum">     804 </span>                :            :         } else {
<span class="lineNum">     805 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :                 ASSERT3P(handler-&gt;zi_lanes, ==, NULL);</span>
<span class="lineNum">     806 </span>                :            :         }
<span class="lineNum">     807 </span>                :            : 
<span class="lineNum">     808 </span>                :<span class="lineNoCov">          0 :         spa_inject_delref(handler-&gt;zi_spa);</span>
<span class="lineNum">     809 </span>                :<span class="lineNoCov">          0 :         kmem_free(handler, sizeof (inject_handler_t));</span>
<span class="lineNum">     810 </span>                :<span class="lineNoCov">          0 :         atomic_dec_32(&amp;zio_injection_enabled);</span>
<span class="lineNum">     811 </span>                :            : 
<span class="lineNum">     812 </span>                :<span class="lineNoCov">          0 :         return (0);</span>
<span class="lineNum">     813 </span>                :            : }
<a name="814"><span class="lineNum">     814 </span>                :            : </a>
<span class="lineNum">     815 </span>                :            : void
<span class="lineNum">     816 </span>                :<span class="lineCov">       1234 : zio_inject_init(void)</span>
<span class="lineNum">     817 </span>                :            : {
<span class="lineNum">     818 </span>                :<span class="lineCov">       1234 :         rw_init(&amp;inject_lock, NULL, RW_DEFAULT, NULL);</span>
<span class="lineNum">     819 </span>                :<span class="lineCov">       1234 :         mutex_init(&amp;inject_delay_mtx, NULL, MUTEX_DEFAULT, NULL);</span>
<span class="lineNum">     820 </span>                :<span class="lineCov">       1234 :         list_create(&amp;inject_handlers, sizeof (inject_handler_t),</span>
<span class="lineNum">     821 </span>                :            :             offsetof(inject_handler_t, zi_link));
<span class="lineNum">     822 </span>                :<span class="lineCov">       1234 : }</span>
<a name="823"><span class="lineNum">     823 </span>                :            : </a>
<span class="lineNum">     824 </span>                :            : void
<span class="lineNum">     825 </span>                :<span class="lineCov">        785 : zio_inject_fini(void)</span>
<span class="lineNum">     826 </span>                :            : {
<span class="lineNum">     827 </span>                :<span class="lineCov">        785 :         list_destroy(&amp;inject_handlers);</span>
<span class="lineNum">     828 </span>                :<span class="lineCov">        785 :         mutex_destroy(&amp;inject_delay_mtx);</span>
<span class="lineNum">     829 </span>                :<span class="lineCov">        785 :         rw_destroy(&amp;inject_lock);</span>
<span class="lineNum">     830 </span>                :<span class="lineCov">        785 : }</span>
<span class="lineNum">     831 </span>                :            : 
<span class="lineNum">     832 </span>                :            : #if defined(_KERNEL) &amp;&amp; defined(HAVE_SPL)
<span class="lineNum">     833 </span>                :            : EXPORT_SYMBOL(zio_injection_enabled);
<span class="lineNum">     834 </span>                :            : EXPORT_SYMBOL(zio_inject_fault);
<span class="lineNum">     835 </span>                :            : EXPORT_SYMBOL(zio_inject_list_next);
<span class="lineNum">     836 </span>                :            : EXPORT_SYMBOL(zio_clear_fault);
<span class="lineNum">     837 </span>                :            : EXPORT_SYMBOL(zio_handle_fault_injection);
<span class="lineNum">     838 </span>                :            : EXPORT_SYMBOL(zio_handle_device_injection);
<span class="lineNum">     839 </span>                :            : EXPORT_SYMBOL(zio_handle_label_injection);
<span class="lineNum">     840 </span>                :            : #endif
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
