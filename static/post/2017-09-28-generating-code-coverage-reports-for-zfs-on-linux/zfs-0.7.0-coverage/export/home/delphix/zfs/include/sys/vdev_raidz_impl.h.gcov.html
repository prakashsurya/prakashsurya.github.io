<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - zfs-0.7.0 Code Coverage - /export/home/delphix/zfs/include/sys/vdev_raidz_impl.h</title>
  <link rel="stylesheet" type="text/css" href="../../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../../index.html">top level</a> - <a href="index.html">export/home/delphix/zfs/include/sys</a> - vdev_raidz_impl.h<span style="font-size: 80%;"> (source / <a href="vdev_raidz_impl.h.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">zfs-0.7.0 Code Coverage</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">22</td>
            <td class="headerCovTableEntry">22</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-09-28 14:23:58</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">6</td>
            <td class="headerCovTableEntry">6</td>
            <td class="headerCovTableEntryHi">100.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
            | Branches:
            <span class="coverLegendCov">+</span> taken
            <span class="coverLegendNoCov">-</span> not taken
            <span class="coverLegendNoCov">#</span> not executed
</td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">8</td>
            <td class="headerCovTableEntry">12</td>
            <td class="headerCovTableEntryLo">66.7 %</td>
          </tr>
          <tr><td><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : /*</a>
<span class="lineNum">       2 </span>                :            :  * CDDL HEADER START
<span class="lineNum">       3 </span>                :            :  *
<span class="lineNum">       4 </span>                :            :  * The contents of this file are subject to the terms of the
<span class="lineNum">       5 </span>                :            :  * Common Development and Distribution License (the &quot;License&quot;).
<span class="lineNum">       6 </span>                :            :  * You may not use this file except in compliance with the License.
<span class="lineNum">       7 </span>                :            :  *
<span class="lineNum">       8 </span>                :            :  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE
<span class="lineNum">       9 </span>                :            :  * or http://www.opensolaris.org/os/licensing.
<span class="lineNum">      10 </span>                :            :  * See the License for the specific language governing permissions
<span class="lineNum">      11 </span>                :            :  * and limitations under the License.
<span class="lineNum">      12 </span>                :            :  *
<span class="lineNum">      13 </span>                :            :  * When distributing Covered Code, include this CDDL HEADER in each
<span class="lineNum">      14 </span>                :            :  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.
<span class="lineNum">      15 </span>                :            :  * If applicable, add the following below this CDDL HEADER, with the
<span class="lineNum">      16 </span>                :            :  * fields enclosed by brackets &quot;[]&quot; replaced with your own identifying
<span class="lineNum">      17 </span>                :            :  * information: Portions Copyright [yyyy] [name of copyright owner]
<span class="lineNum">      18 </span>                :            :  *
<span class="lineNum">      19 </span>                :            :  * CDDL HEADER END
<span class="lineNum">      20 </span>                :            :  */
<span class="lineNum">      21 </span>                :            : /*
<span class="lineNum">      22 </span>                :            :  * Copyright (C) 2016 Gvozden Nešković. All rights reserved.
<span class="lineNum">      23 </span>                :            :  */
<span class="lineNum">      24 </span>                :            : 
<span class="lineNum">      25 </span>                :            : #ifndef _VDEV_RAIDZ_H
<span class="lineNum">      26 </span>                :            : #define _VDEV_RAIDZ_H
<span class="lineNum">      27 </span>                :            : 
<span class="lineNum">      28 </span>                :            : #include &lt;sys/types.h&gt;
<span class="lineNum">      29 </span>                :            : #include &lt;sys/debug.h&gt;
<span class="lineNum">      30 </span>                :            : #include &lt;sys/kstat.h&gt;
<span class="lineNum">      31 </span>                :            : #include &lt;sys/abd.h&gt;
<span class="lineNum">      32 </span>                :            : 
<span class="lineNum">      33 </span>                :            : #ifdef  __cplusplus
<span class="lineNum">      34 </span>                :            : extern &quot;C&quot; {
<span class="lineNum">      35 </span>                :            : #endif
<span class="lineNum">      36 </span>                :            : 
<span class="lineNum">      37 </span>                :            : #define CODE_P          (0U)
<span class="lineNum">      38 </span>                :            : #define CODE_Q          (1U)
<span class="lineNum">      39 </span>                :            : #define CODE_R          (2U)
<span class="lineNum">      40 </span>                :            : 
<span class="lineNum">      41 </span>                :            : #define PARITY_P        (1U)
<span class="lineNum">      42 </span>                :            : #define PARITY_PQ       (2U)
<span class="lineNum">      43 </span>                :            : #define PARITY_PQR      (3U)
<span class="lineNum">      44 </span>                :            : 
<span class="lineNum">      45 </span>                :            : #define TARGET_X        (0U)
<span class="lineNum">      46 </span>                :            : #define TARGET_Y        (1U)
<span class="lineNum">      47 </span>                :            : #define TARGET_Z        (2U)
<span class="lineNum">      48 </span>                :            : 
<span class="lineNum">      49 </span>                :            : /*
<span class="lineNum">      50 </span>                :            :  * Parity generation methods indexes
<span class="lineNum">      51 </span>                :            :  */
<span class="lineNum">      52 </span>                :            : enum raidz_math_gen_op {
<span class="lineNum">      53 </span>                :            :         RAIDZ_GEN_P = 0,
<span class="lineNum">      54 </span>                :            :         RAIDZ_GEN_PQ,
<span class="lineNum">      55 </span>                :            :         RAIDZ_GEN_PQR,
<span class="lineNum">      56 </span>                :            :         RAIDZ_GEN_NUM = 3
<span class="lineNum">      57 </span>                :            : };
<span class="lineNum">      58 </span>                :            : /*
<span class="lineNum">      59 </span>                :            :  * Data reconstruction methods indexes
<span class="lineNum">      60 </span>                :            :  */
<span class="lineNum">      61 </span>                :            : enum raidz_rec_op {
<span class="lineNum">      62 </span>                :            :         RAIDZ_REC_P = 0,
<span class="lineNum">      63 </span>                :            :         RAIDZ_REC_Q,
<span class="lineNum">      64 </span>                :            :         RAIDZ_REC_R,
<span class="lineNum">      65 </span>                :            :         RAIDZ_REC_PQ,
<span class="lineNum">      66 </span>                :            :         RAIDZ_REC_PR,
<span class="lineNum">      67 </span>                :            :         RAIDZ_REC_QR,
<span class="lineNum">      68 </span>                :            :         RAIDZ_REC_PQR,
<span class="lineNum">      69 </span>                :            :         RAIDZ_REC_NUM = 7
<span class="lineNum">      70 </span>                :            : };
<span class="lineNum">      71 </span>                :            : 
<span class="lineNum">      72 </span>                :            : extern const char *raidz_gen_name[RAIDZ_GEN_NUM];
<span class="lineNum">      73 </span>                :            : extern const char *raidz_rec_name[RAIDZ_REC_NUM];
<span class="lineNum">      74 </span>                :            : 
<span class="lineNum">      75 </span>                :            : /*
<span class="lineNum">      76 </span>                :            :  * Methods used to define raidz implementation
<span class="lineNum">      77 </span>                :            :  *
<span class="lineNum">      78 </span>                :            :  * @raidz_gen_f Parity generation function
<span class="lineNum">      79 </span>                :            :  *     @par1    pointer to raidz_map
<span class="lineNum">      80 </span>                :            :  * @raidz_rec_f Data reconstruction function
<span class="lineNum">      81 </span>                :            :  *     @par1    pointer to raidz_map
<span class="lineNum">      82 </span>                :            :  *     @par2    array of reconstruction targets
<span class="lineNum">      83 </span>                :            :  * @will_work_f Function returns TRUE if impl. is supported on the system
<span class="lineNum">      84 </span>                :            :  * @init_impl_f Function is called once on init
<span class="lineNum">      85 </span>                :            :  * @fini_impl_f Function is called once on fini
<span class="lineNum">      86 </span>                :            :  */
<span class="lineNum">      87 </span>                :            : typedef void            (*raidz_gen_f)(void *);
<span class="lineNum">      88 </span>                :            : typedef int             (*raidz_rec_f)(void *, const int *);
<span class="lineNum">      89 </span>                :            : typedef boolean_t       (*will_work_f)(void);
<span class="lineNum">      90 </span>                :            : typedef void            (*init_impl_f)(void);
<span class="lineNum">      91 </span>                :            : typedef void            (*fini_impl_f)(void);
<span class="lineNum">      92 </span>                :            : 
<span class="lineNum">      93 </span>                :            : #define RAIDZ_IMPL_NAME_MAX     (16)
<span class="lineNum">      94 </span>                :            : 
<span class="lineNum">      95 </span>                :            : typedef struct raidz_impl_ops {
<span class="lineNum">      96 </span>                :            :         init_impl_f init;
<span class="lineNum">      97 </span>                :            :         fini_impl_f fini;
<span class="lineNum">      98 </span>                :            :         raidz_gen_f gen[RAIDZ_GEN_NUM]; /* Parity generate functions */
<span class="lineNum">      99 </span>                :            :         raidz_rec_f rec[RAIDZ_REC_NUM]; /* Data reconstruction functions */
<span class="lineNum">     100 </span>                :            :         will_work_f is_supported;       /* Support check function */
<span class="lineNum">     101 </span>                :            :         char name[RAIDZ_IMPL_NAME_MAX]; /* Name of the implementation */
<span class="lineNum">     102 </span>                :            : } raidz_impl_ops_t;
<span class="lineNum">     103 </span>                :            : 
<span class="lineNum">     104 </span>                :            : typedef struct raidz_col {
<span class="lineNum">     105 </span>                :            :         size_t rc_devidx;               /* child device index for I/O */
<span class="lineNum">     106 </span>                :            :         size_t rc_offset;               /* device offset */
<span class="lineNum">     107 </span>                :            :         size_t rc_size;                 /* I/O size */
<span class="lineNum">     108 </span>                :            :         abd_t *rc_abd;                  /* I/O data */
<span class="lineNum">     109 </span>                :            :         void *rc_gdata;                 /* used to store the &quot;good&quot; version */
<span class="lineNum">     110 </span>                :            :         int rc_error;                   /* I/O error for this device */
<span class="lineNum">     111 </span>                :            :         unsigned int rc_tried;          /* Did we attempt this I/O column? */
<span class="lineNum">     112 </span>                :            :         unsigned int rc_skipped;        /* Did we skip this I/O column? */
<span class="lineNum">     113 </span>                :            : } raidz_col_t;
<span class="lineNum">     114 </span>                :            : 
<span class="lineNum">     115 </span>                :            : typedef struct raidz_map {
<span class="lineNum">     116 </span>                :            :         size_t rm_cols;                 /* Regular column count */
<span class="lineNum">     117 </span>                :            :         size_t rm_scols;                /* Count including skipped columns */
<span class="lineNum">     118 </span>                :            :         size_t rm_bigcols;              /* Number of oversized columns */
<span class="lineNum">     119 </span>                :            :         size_t rm_asize;                /* Actual total I/O size */
<span class="lineNum">     120 </span>                :            :         size_t rm_missingdata;          /* Count of missing data devices */
<span class="lineNum">     121 </span>                :            :         size_t rm_missingparity;        /* Count of missing parity devices */
<span class="lineNum">     122 </span>                :            :         size_t rm_firstdatacol;         /* First data column/parity count */
<span class="lineNum">     123 </span>                :            :         size_t rm_nskip;                /* Skipped sectors for padding */
<span class="lineNum">     124 </span>                :            :         size_t rm_skipstart;            /* Column index of padding start */
<span class="lineNum">     125 </span>                :            :         abd_t *rm_abd_copy;             /* rm_asize-buffer of copied data */
<span class="lineNum">     126 </span>                :            :         size_t rm_reports;              /* # of referencing checksum reports */
<span class="lineNum">     127 </span>                :            :         unsigned int rm_freed;          /* map no longer has referencing ZIO */
<span class="lineNum">     128 </span>                :            :         unsigned int rm_ecksuminjected; /* checksum error was injected */
<span class="lineNum">     129 </span>                :            :         raidz_impl_ops_t *rm_ops;       /* RAIDZ math operations */
<span class="lineNum">     130 </span>                :            :         raidz_col_t rm_col[1];          /* Flexible array of I/O columns */
<span class="lineNum">     131 </span>                :            : } raidz_map_t;
<span class="lineNum">     132 </span>                :            : 
<span class="lineNum">     133 </span>                :            : #define RAIDZ_ORIGINAL_IMPL     (INT_MAX)
<span class="lineNum">     134 </span>                :            : 
<span class="lineNum">     135 </span>                :            : extern const raidz_impl_ops_t vdev_raidz_scalar_impl;
<span class="lineNum">     136 </span>                :            : #if defined(__x86_64) &amp;&amp; defined(HAVE_SSE2)     /* only x86_64 for now */
<span class="lineNum">     137 </span>                :            : extern const raidz_impl_ops_t vdev_raidz_sse2_impl;
<span class="lineNum">     138 </span>                :            : #endif
<span class="lineNum">     139 </span>                :            : #if defined(__x86_64) &amp;&amp; defined(HAVE_SSSE3)    /* only x86_64 for now */
<span class="lineNum">     140 </span>                :            : extern const raidz_impl_ops_t vdev_raidz_ssse3_impl;
<span class="lineNum">     141 </span>                :            : #endif
<span class="lineNum">     142 </span>                :            : #if defined(__x86_64) &amp;&amp; defined(HAVE_AVX2)     /* only x86_64 for now */
<span class="lineNum">     143 </span>                :            : extern const raidz_impl_ops_t vdev_raidz_avx2_impl;
<span class="lineNum">     144 </span>                :            : #endif
<span class="lineNum">     145 </span>                :            : #if defined(__x86_64) &amp;&amp; defined(HAVE_AVX512F)  /* only x86_64 for now */
<span class="lineNum">     146 </span>                :            : extern const raidz_impl_ops_t vdev_raidz_avx512f_impl;
<span class="lineNum">     147 </span>                :            : #endif
<span class="lineNum">     148 </span>                :            : #if defined(__x86_64) &amp;&amp; defined(HAVE_AVX512BW) /* only x86_64 for now */
<span class="lineNum">     149 </span>                :            : extern const raidz_impl_ops_t vdev_raidz_avx512bw_impl;
<span class="lineNum">     150 </span>                :            : #endif
<span class="lineNum">     151 </span>                :            : #if defined(__aarch64__)
<span class="lineNum">     152 </span>                :            : extern const raidz_impl_ops_t vdev_raidz_aarch64_neon_impl;
<span class="lineNum">     153 </span>                :            : extern const raidz_impl_ops_t vdev_raidz_aarch64_neonx2_impl;
<span class="lineNum">     154 </span>                :            : #endif
<span class="lineNum">     155 </span>                :            : 
<span class="lineNum">     156 </span>                :            : /*
<span class="lineNum">     157 </span>                :            :  * Commonly used raidz_map helpers
<span class="lineNum">     158 </span>                :            :  *
<span class="lineNum">     159 </span>                :            :  * raidz_parity         Returns parity of the RAIDZ block
<span class="lineNum">     160 </span>                :            :  * raidz_ncols          Returns number of columns the block spans
<span class="lineNum">     161 </span>                :            :  * raidz_nbigcols       Returns number of big columns columns
<span class="lineNum">     162 </span>                :            :  * raidz_col_p          Returns pointer to a column
<span class="lineNum">     163 </span>                :            :  * raidz_col_size       Returns size of a column
<span class="lineNum">     164 </span>                :            :  * raidz_big_size       Returns size of big columns
<span class="lineNum">     165 </span>                :            :  * raidz_short_size     Returns size of short columns
<span class="lineNum">     166 </span>                :            :  */
<span class="lineNum">     167 </span>                :            : #define raidz_parity(rm)        ((rm)-&gt;rm_firstdatacol)
<span class="lineNum">     168 </span>                :            : #define raidz_ncols(rm)         ((rm)-&gt;rm_cols)
<span class="lineNum">     169 </span>                :            : #define raidz_nbigcols(rm)      ((rm)-&gt;rm_bigcols)
<span class="lineNum">     170 </span>                :            : #define raidz_col_p(rm, c)      ((rm)-&gt;rm_col + (c))
<span class="lineNum">     171 </span>                :            : #define raidz_col_size(rm, c)   ((rm)-&gt;rm_col[c].rc_size)
<span class="lineNum">     172 </span>                :            : #define raidz_big_size(rm)      (raidz_col_size(rm, CODE_P))
<span class="lineNum">     173 </span>                :            : #define raidz_short_size(rm)    (raidz_col_size(rm, raidz_ncols(rm)-1))
<span class="lineNum">     174 </span>                :            : 
<span class="lineNum">     175 </span>                :            : /*
<span class="lineNum">     176 </span>                :            :  * Macro defines an RAIDZ parity generation method
<span class="lineNum">     177 </span>                :            :  *
<span class="lineNum">     178 </span>                :            :  * @code        parity the function produce
<span class="lineNum">     179 </span>                :            :  * @impl        name of the implementation
<span class="lineNum">     180 </span>                :            :  */
<span class="lineNum">     181 </span>                :            : #define _RAIDZ_GEN_WRAP(code, impl)                                     \
<span class="lineNum">     182 </span>                :            : static void                                                             \
<span class="lineNum">     183 </span>                :            : impl ## _gen_ ## code(void *rmp)                                        \
<span class="lineNum">     184 </span>                :            : {                                                                       \
<span class="lineNum">     185 </span>                :            :         raidz_map_t *rm = (raidz_map_t *)rmp;                           \
<span class="lineNum">     186 </span>                :            :         raidz_generate_## code ## _impl(rm);                            \
<span class="lineNum">     187 </span>                :            : }
<span class="lineNum">     188 </span>                :            : 
<span class="lineNum">     189 </span>                :            : /*
<span class="lineNum">     190 </span>                :            :  * Macro defines an RAIDZ data reconstruction method
<span class="lineNum">     191 </span>                :            :  *
<span class="lineNum">     192 </span>                :            :  * @code        parity the function produce
<span class="lineNum">     193 </span>                :            :  * @impl        name of the implementation
<span class="lineNum">     194 </span>                :            :  */
<span class="lineNum">     195 </span>                :            : #define _RAIDZ_REC_WRAP(code, impl)                                     \
<span class="lineNum">     196 </span>                :            : static int                                                              \
<span class="lineNum">     197 </span>                :            : impl ## _rec_ ## code(void *rmp, const int *tgtidx)                     \
<span class="lineNum">     198 </span>                :            : {                                                                       \
<span class="lineNum">     199 </span>                :            :         raidz_map_t *rm = (raidz_map_t *)rmp;                           \
<span class="lineNum">     200 </span>                :            :         return (raidz_reconstruct_## code ## _impl(rm, tgtidx));        \
<span class="lineNum">     201 </span>                :            : }
<span class="lineNum">     202 </span>                :            : 
<span class="lineNum">     203 </span>                :            : /*
<span class="lineNum">     204 </span>                :            :  * Define all gen methods for an implementation
<span class="lineNum">     205 </span>                :            :  *
<span class="lineNum">     206 </span>                :            :  * @impl        name of the implementation
<span class="lineNum">     207 </span>                :            :  */
<span class="lineNum">     208 </span>                :            : #define DEFINE_GEN_METHODS(impl)                                        \
<span class="lineNum">     209 </span>                :            :         _RAIDZ_GEN_WRAP(p, impl);                                       \
<span class="lineNum">     210 </span>                :            :         _RAIDZ_GEN_WRAP(pq, impl);                                      \
<span class="lineNum">     211 </span>                :            :         _RAIDZ_GEN_WRAP(pqr, impl)
<span class="lineNum">     212 </span>                :            : 
<span class="lineNum">     213 </span>                :            : /*
<span class="lineNum">     214 </span>                :            :  * Define all rec functions for an implementation
<span class="lineNum">     215 </span>                :            :  *
<span class="lineNum">     216 </span>                :            :  * @impl        name of the implementation
<span class="lineNum">     217 </span>                :            :  */
<span class="lineNum">     218 </span>                :            : #define DEFINE_REC_METHODS(impl)                                        \
<span class="lineNum">     219 </span>                :            :         _RAIDZ_REC_WRAP(p, impl);                                       \
<span class="lineNum">     220 </span>                :            :         _RAIDZ_REC_WRAP(q, impl);                                       \
<span class="lineNum">     221 </span>                :            :         _RAIDZ_REC_WRAP(r, impl);                                       \
<span class="lineNum">     222 </span>                :            :         _RAIDZ_REC_WRAP(pq, impl);                                      \
<span class="lineNum">     223 </span>                :            :         _RAIDZ_REC_WRAP(pr, impl);                                      \
<span class="lineNum">     224 </span>                :            :         _RAIDZ_REC_WRAP(qr, impl);                                      \
<span class="lineNum">     225 </span>                :            :         _RAIDZ_REC_WRAP(pqr, impl)
<span class="lineNum">     226 </span>                :            : 
<span class="lineNum">     227 </span>                :            : #define RAIDZ_GEN_METHODS(impl)                                         \
<span class="lineNum">     228 </span>                :            : {                                                                       \
<span class="lineNum">     229 </span>                :            :         [RAIDZ_GEN_P] = &amp; impl ## _gen_p,                           \
<span class="lineNum">     230 </span>                :            :         [RAIDZ_GEN_PQ] = &amp; impl ## _gen_pq,                         \
<span class="lineNum">     231 </span>                :            :         [RAIDZ_GEN_PQR] = &amp; impl ## _gen_pqr                                \
<span class="lineNum">     232 </span>                :            : }
<span class="lineNum">     233 </span>                :            : 
<span class="lineNum">     234 </span>                :            : #define RAIDZ_REC_METHODS(impl)                                         \
<span class="lineNum">     235 </span>                :            : {                                                                       \
<span class="lineNum">     236 </span>                :            :         [RAIDZ_REC_P] = &amp; impl ## _rec_p,                           \
<span class="lineNum">     237 </span>                :            :         [RAIDZ_REC_Q] = &amp; impl ## _rec_q,                           \
<span class="lineNum">     238 </span>                :            :         [RAIDZ_REC_R] = &amp; impl ## _rec_r,                           \
<span class="lineNum">     239 </span>                :            :         [RAIDZ_REC_PQ] = &amp; impl ## _rec_pq,                         \
<span class="lineNum">     240 </span>                :            :         [RAIDZ_REC_PR] = &amp; impl ## _rec_pr,                         \
<span class="lineNum">     241 </span>                :            :         [RAIDZ_REC_QR] = &amp; impl ## _rec_qr,                         \
<span class="lineNum">     242 </span>                :            :         [RAIDZ_REC_PQR] = &amp; impl ## _rec_pqr                                \
<span class="lineNum">     243 </span>                :            : }
<span class="lineNum">     244 </span>                :            : 
<span class="lineNum">     245 </span>                :            : 
<span class="lineNum">     246 </span>                :            : typedef struct raidz_impl_kstat {
<span class="lineNum">     247 </span>                :            :         uint64_t gen[RAIDZ_GEN_NUM];    /* gen method speed B/s */
<span class="lineNum">     248 </span>                :            :         uint64_t rec[RAIDZ_REC_NUM];    /* rec method speed B/s */
<span class="lineNum">     249 </span>                :            : } raidz_impl_kstat_t;
<span class="lineNum">     250 </span>                :            : 
<span class="lineNum">     251 </span>                :            : /*
<span class="lineNum">     252 </span>                :            :  * Enumerate various multiplication constants
<span class="lineNum">     253 </span>                :            :  * used in reconstruction methods
<span class="lineNum">     254 </span>                :            :  */
<span class="lineNum">     255 </span>                :            : typedef enum raidz_mul_info {
<span class="lineNum">     256 </span>                :            :         /* Reconstruct Q */
<span class="lineNum">     257 </span>                :            :         MUL_Q_X         = 0,
<span class="lineNum">     258 </span>                :            :         /* Reconstruct R */
<span class="lineNum">     259 </span>                :            :         MUL_R_X         = 0,
<span class="lineNum">     260 </span>                :            :         /* Reconstruct PQ */
<span class="lineNum">     261 </span>                :            :         MUL_PQ_X        = 0,
<span class="lineNum">     262 </span>                :            :         MUL_PQ_Y        = 1,
<span class="lineNum">     263 </span>                :            :         /* Reconstruct PR */
<span class="lineNum">     264 </span>                :            :         MUL_PR_X        = 0,
<span class="lineNum">     265 </span>                :            :         MUL_PR_Y        = 1,
<span class="lineNum">     266 </span>                :            :         /* Reconstruct QR */
<span class="lineNum">     267 </span>                :            :         MUL_QR_XQ       = 0,
<span class="lineNum">     268 </span>                :            :         MUL_QR_X        = 1,
<span class="lineNum">     269 </span>                :            :         MUL_QR_YQ       = 2,
<span class="lineNum">     270 </span>                :            :         MUL_QR_Y        = 3,
<span class="lineNum">     271 </span>                :            :         /* Reconstruct PQR */
<span class="lineNum">     272 </span>                :            :         MUL_PQR_XP      = 0,
<span class="lineNum">     273 </span>                :            :         MUL_PQR_XQ      = 1,
<span class="lineNum">     274 </span>                :            :         MUL_PQR_XR      = 2,
<span class="lineNum">     275 </span>                :            :         MUL_PQR_YU      = 3,
<span class="lineNum">     276 </span>                :            :         MUL_PQR_YP      = 4,
<span class="lineNum">     277 </span>                :            :         MUL_PQR_YQ      = 5,
<span class="lineNum">     278 </span>                :            : 
<span class="lineNum">     279 </span>                :            :         MUL_CNT         = 6
<span class="lineNum">     280 </span>                :            : } raidz_mul_info_t;
<span class="lineNum">     281 </span>                :            : 
<span class="lineNum">     282 </span>                :            : /*
<span class="lineNum">     283 </span>                :            :  * Powers of 2 in the Galois field.
<span class="lineNum">     284 </span>                :            :  */
<span class="lineNum">     285 </span>                :            : extern const uint8_t vdev_raidz_pow2[256] __attribute__((aligned(256)));
<span class="lineNum">     286 </span>                :            : /* Logs of 2 in the Galois field defined above. */
<span class="lineNum">     287 </span>                :            : extern const uint8_t vdev_raidz_log2[256] __attribute__((aligned(256)));
<span class="lineNum">     288 </span>                :            : 
<span class="lineNum">     289 </span>                :            : /*
<span class="lineNum">     290 </span>                :            :  * Multiply a given number by 2 raised to the given power.
<a name="291"><span class="lineNum">     291 </span>                :            :  */</a>
<span class="lineNum">     292 </span>                :            : static inline uint8_t
<span class="lineNum">     293 </span>                :<span class="lineCov">  157769861 : vdev_raidz_exp2(const uint8_t a, const unsigned exp)</span>
<span class="lineNum">     294 </span>                :            : {
<span class="lineNum">     295 </span>        [<span class="branchCov" title="Branch 0 was taken 123153156 times"> + </span><span class="branchCov" title="Branch 1 was taken 34616705 times"> + </span>]:<span class="lineCov">  157769861 :         if (a == 0)</span>
<span class="lineNum">     296 </span>                :            :                 return (0);
<span class="lineNum">     297 </span>                :            : 
<span class="lineNum">     298 </span>                :<span class="lineCov">  123153156 :         return (vdev_raidz_pow2[(exp + (unsigned)vdev_raidz_log2[a]) % 255]);</span>
<span class="lineNum">     299 </span>                :            : }
<span class="lineNum">     300 </span>                :            : 
<span class="lineNum">     301 </span>                :            : /*
<span class="lineNum">     302 </span>                :            :  * Galois Field operations.
<span class="lineNum">     303 </span>                :            :  *
<span class="lineNum">     304 </span>                :            :  * gf_exp2      - computes 2 raised to the given power
<span class="lineNum">     305 </span>                :            :  * gf_exp2      - computes 4 raised to the given power
<span class="lineNum">     306 </span>                :            :  * gf_mul       - multiplication
<span class="lineNum">     307 </span>                :            :  * gf_div       - division
<span class="lineNum">     308 </span>                :            :  * gf_inv       - multiplicative inverse
<span class="lineNum">     309 </span>                :            :  */
<span class="lineNum">     310 </span>                :            : typedef unsigned gf_t;
<span class="lineNum">     311 </span>                :            : typedef unsigned gf_log_t;
<a name="312"><span class="lineNum">     312 </span>                :            : </a>
<span class="lineNum">     313 </span>                :            : static inline gf_t
<span class="lineNum">     314 </span>                :<span class="lineCov">   81287821 : gf_mul(const gf_t a, const gf_t b)</span>
<span class="lineNum">     315 </span>                :            : {
<span class="lineNum">     316 </span>                :            :         gf_log_t logsum;
<span class="lineNum">     317 </span>                :            : 
<span class="lineNum">     318 </span>        [<span class="branchCov" title="Branch 0 was taken 80657247 times"> + </span><span class="branchCov" title="Branch 1 was taken 630574 times"> + </span>]:<span class="lineCov">   81287821 :         if (a == 0 || b == 0)</span>
<span class="lineNum">     319 </span>                :            :                 return (0);
<span class="lineNum">     320 </span>                :            : 
<span class="lineNum">     321 </span>                :<span class="lineCov">   80657247 :         logsum = (gf_log_t)vdev_raidz_log2[a] + (gf_log_t)vdev_raidz_log2[b];</span>
<span class="lineNum">     322 </span>                :            : 
<span class="lineNum">     323 </span>                :<span class="lineCov">   80657247 :         return ((gf_t)vdev_raidz_pow2[logsum % 255]);</span>
<span class="lineNum">     324 </span>                :            : }
<a name="325"><span class="lineNum">     325 </span>                :            : </a>
<span class="lineNum">     326 </span>                :            : static inline gf_t
<span class="lineNum">     327 </span>                :<span class="lineCov">     223159 : gf_div(const gf_t  a, const gf_t b)</span>
<span class="lineNum">     328 </span>                :            : {
<span class="lineNum">     329 </span>                :            :         gf_log_t logsum;
<span class="lineNum">     330 </span>                :            : 
<span class="lineNum">     331 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 223159 times"> + </span>]:<span class="lineCov">     223159 :         ASSERT3U(b, &gt;, 0);</span>
<span class="lineNum">     332 </span>        [<span class="branchCov" title="Branch 0 was taken 223162 times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">     223159 :         if (a == 0)</span>
<span class="lineNum">     333 </span>                :            :                 return (0);
<span class="lineNum">     334 </span>                :            : 
<span class="lineNum">     335 </span>                :<span class="lineCov">     446324 :         logsum = (gf_log_t)255 + (gf_log_t)vdev_raidz_log2[a] -</span>
<span class="lineNum">     336 </span>                :<span class="lineCov">     223162 :             (gf_log_t)vdev_raidz_log2[b];</span>
<span class="lineNum">     337 </span>                :            : 
<span class="lineNum">     338 </span>                :<span class="lineCov">     223162 :         return ((gf_t)vdev_raidz_pow2[logsum % 255]);</span>
<span class="lineNum">     339 </span>                :            : }
<a name="340"><span class="lineNum">     340 </span>                :            : </a>
<span class="lineNum">     341 </span>                :            : static inline gf_t
<span class="lineNum">     342 </span>                :<span class="lineCov">      45302 : gf_inv(const gf_t a)</span>
<span class="lineNum">     343 </span>                :            : {
<span class="lineNum">     344 </span>                :            :         gf_log_t logsum;
<span class="lineNum">     345 </span>                :            : 
<span class="lineNum">     346 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 45302 times"> + </span>]:<span class="lineCov">      45302 :         ASSERT3U(a, &gt;, 0);</span>
<span class="lineNum">     347 </span>                :            : 
<span class="lineNum">     348 </span>                :<span class="lineCov">      45302 :         logsum = (gf_log_t)255 - (gf_log_t)vdev_raidz_log2[a];</span>
<span class="lineNum">     349 </span>                :            : 
<span class="lineNum">     350 </span>                :<span class="lineCov">      45302 :         return ((gf_t)vdev_raidz_pow2[logsum]);</span>
<span class="lineNum">     351 </span>                :            : }
<a name="352"><span class="lineNum">     352 </span>                :            : </a>
<span class="lineNum">     353 </span>                :            : static inline gf_t
<span class="lineNum">     354 </span>                :<span class="lineCov">     210789 : gf_exp2(gf_log_t exp)</span>
<span class="lineNum">     355 </span>                :            : {
<span class="lineNum">     356 </span>                :<span class="lineCov">     210789 :         return (vdev_raidz_pow2[exp % 255]);</span>
<span class="lineNum">     357 </span>                :            : }
<a name="358"><span class="lineNum">     358 </span>                :            : </a>
<span class="lineNum">     359 </span>                :            : static inline gf_t
<span class="lineNum">     360 </span>                :<span class="lineCov">     167728 : gf_exp4(gf_log_t exp)</span>
<span class="lineNum">     361 </span>                :            : {
<span class="lineNum">     362 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken 167728 times"> + </span>]:<span class="lineCov">     167728 :         ASSERT3U(exp, &lt;=, 255);</span>
<span class="lineNum">     363 </span>                :<span class="lineCov">     167728 :         return ((gf_t)vdev_raidz_pow2[(2 * exp) % 255]);</span>
<span class="lineNum">     364 </span>                :            : }
<span class="lineNum">     365 </span>                :            : 
<span class="lineNum">     366 </span>                :            : #ifdef  __cplusplus
<span class="lineNum">     367 </span>                :            : }
<span class="lineNum">     368 </span>                :            : #endif
<span class="lineNum">     369 </span>                :            : 
<span class="lineNum">     370 </span>                :            : #endif /* _VDEV_RAIDZ_H */
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
